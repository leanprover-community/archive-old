[
    {
        "content": "<p>I've just hit what looks like a very scary issue when trying to port <code>Algebra.Order.Hom.Monoid</code> in <a href=\"https://github.com/leanprover-community/mathlib4/pull/944\">mathlib4#944</a>. If you look at the <code>instance [OrderMonoidWithZeroHomClass F α β] : CoeTC F (α →*₀o β)</code> in that PR, you'll see that when proving <code>map_one</code>, (1) the type class system is struggling to get the <code>OneHomClass</code> instance it needs, and (2) when it is supplied manually, we run into the issue that <code>@FunLike.coe F α (fun a ↦ β) MulHomClass.toFunLike f 1</code> is apparently not defeq with <code>@FunLike.coe F α (fun a ↦ β) OneHomClass.toFunLike f 1</code>. This looks eerily reminiscent of issues that we had in mathlib3 when not using <code>old_structure_cmd</code> to define these objects. Does anyone have any insights about how to fix this?</p>",
        "id": 315019986,
        "sender_full_name": "Frédéric Dupuis",
        "timestamp": 1670643555
    },
    {
        "content": "<p>I think we don't want CoeTC here, but I'm not sure if changing it will fix the problem.</p>",
        "id": 315030595,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1670653769
    },
    {
        "content": "<p>I find it very hard to believe those are not defeq. Is this just another synthesized/unified clash again? How did you test if they were defeq?</p>",
        "id": 315046002,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1670664350
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code>      <span class=\"n\">map_one'</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n        <span class=\"n\">letI</span> <span class=\"o\">:</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:=</span> <span class=\"n\">MonoidWithZeroHomClass.toMonoidHomClass</span>\n        <span class=\"n\">exact</span> <span class=\"n\">map_one</span> <span class=\"n\">f</span>\n</code></pre></div>\n<p>You had <code>haveI</code> instead of <code>letI</code>, so the data was being forgotten.</p>",
        "id": 315069815,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670675234
    },
    {
        "content": "<p>That resolves the second issue, but the first one is still confusing to me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">attribute</span> <span class=\"o\">[</span><span class=\"kd\">instance</span><span class=\"o\">]</span> <span class=\"n\">MonoidWithZeroHomClass.toMonoidHomClass</span> <span class=\"c1\">-- presumably it's an instance,</span>\n<span class=\"c1\">-- even though this is not possible to easily check in Lean 4</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">[</span><span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">CoeTC</span> <span class=\"n\">F</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"bp\">→*₀</span><span class=\"n\">o</span> <span class=\"n\">β</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n  <span class=\"o\">⟨</span><span class=\"k\">fun</span> <span class=\"n\">f</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"c1\">-- comment out the next line and the proof breaks</span>\n    <span class=\"c1\">-- `:= inferInstance` also fails here (deterministic timeout)</span>\n    <span class=\"n\">letI</span> <span class=\"o\">:</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:=</span> <span class=\"n\">MonoidWithZeroHomClass.toMonoidHomClass</span><span class=\"bp\">;</span>\n    <span class=\"o\">{</span> <span class=\"n\">toFun</span> <span class=\"o\">:=</span> <span class=\"n\">f</span><span class=\"o\">,</span>\n      <span class=\"n\">map_one'</span> <span class=\"o\">:=</span> <span class=\"n\">map_one</span> <span class=\"n\">f</span>\n      <span class=\"n\">map_zero'</span> <span class=\"o\">:=</span> <span class=\"n\">map_zero</span> <span class=\"n\">f</span><span class=\"o\">,</span>\n      <span class=\"n\">map_mul'</span> <span class=\"o\">:=</span> <span class=\"n\">map_mul</span> <span class=\"n\">f</span>\n      <span class=\"n\">monotone'</span> <span class=\"o\">:=</span> <span class=\"n\">OrderMonoidWithZeroHomClass.Monotone</span> <span class=\"n\">f</span> <span class=\"o\">}⟩</span>\n</code></pre></div>",
        "id": 315071049,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670675820
    },
    {
        "content": "<p>The fact that it's a deterministic timeout rather than just an \"i give up\" makes me wonder if typeclass inference is getting into some kind of loop. Can someone remind me how to look at instance traces in Lean 4? I don't think I've done this before. I tried <code>set_option trace.Meta.synthInstance true</code> but all I got was</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta.synthInstance</span><span class=\"o\">]</span> <span class=\"bp\">💥</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"bp\">▶</span>\n</code></pre></div>\n<p>which is certainly funny, but also not helpful enough</p>",
        "id": 315071515,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670676031
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/91JdtQQz8Kpt5brY3nCiT8qX/trace.png\">trace.png</a> <br>\nThe various options I've found all have defeq docstrings :-(</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/91JdtQQz8Kpt5brY3nCiT8qX/trace.png\" title=\"trace.png\"><img src=\"/user_uploads/3121/91JdtQQz8Kpt5brY3nCiT8qX/trace.png\"></a></div>",
        "id": 315072421,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670676449
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span> <span class=\"n\">trace.Meta.synthInstance.tryResolve</span> <span class=\"n\">true</span>\n</code></pre></div>\n<p>generates so much output that it crashes VS Code :-(</p>",
        "id": 315073212,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670676772
    },
    {
        "content": "<p>(in the same file in the same PR):</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"c1\">-- this is in the file already</span>\n<span class=\"c1\">-- See note [lower instance priority]</span>\n<span class=\"kd\">instance</span> <span class=\"o\">(</span><span class=\"n\">priority</span> <span class=\"o\">:=</span> <span class=\"mi\">100</span><span class=\"o\">)</span> <span class=\"n\">OrderMonoidWithZeroHomClass.toOrderMonoidHomClass</span>\n    <span class=\"o\">[</span><span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">OrderMonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:=</span>\n  <span class=\"o\">{</span> <span class=\"o\">‹</span><span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">›</span> <span class=\"k\">with</span> <span class=\"o\">}</span>\n\n<span class=\"c1\">-- this is where the experiment starts</span>\n<span class=\"kd\">variable</span> <span class=\"o\">[</span><span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span> <span class=\"n\">OrderMonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"c1\">-- fails</span>\n</code></pre></div>\n<p>Am I doing something wrong? It doesn't work if you change the priority to 100000000000000 either.</p>",
        "id": 315073890,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670677100
    },
    {
        "content": "<p>OK so here is a not particularly MWE of the borkage:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib.Algebra.Hom.Group</span>\n\n<span class=\"kd\">variable</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"c1\">-- works</span>\n</code></pre></div>\n<p>This file works as it stands on master. On branch <code>dupuisf/algebra/order/hom/monoid</code> (which has a half-finished <code>Algebra.Order.Hom.Monoid</code>) if you replace lines 177ff of <code>Algebra.Order.Hom.Monoid</code> with</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"c1\">-- See note [lower instance priority]</span>\n<span class=\"kd\">instance</span> <span class=\"o\">(</span><span class=\"n\">priority</span> <span class=\"o\">:=</span> <span class=\"mi\">100</span><span class=\"o\">)</span> <span class=\"n\">OrderMonoidWithZeroHomClass.toOrderMonoidHomClass</span>\n    <span class=\"o\">[</span><span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">OrderMonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:=</span>\n  <span class=\"o\">{</span> <span class=\"o\">‹</span><span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">›</span> <span class=\"k\">with</span> <span class=\"o\">}</span>\n<span class=\"bp\">#</span><span class=\"n\">align</span>\n  <span class=\"n\">order_monoid_with_zero_hom_class.to_order_monoid_hom_class</span> <span class=\"n\">OrderMonoidWithZeroHomClass.toOrderMonoidHomClass</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">MonoidWithZero</span>\n\n<span class=\"kd\">variable</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"c1\">-- now fails</span>\n\n<span class=\"k\">#exit</span>\n</code></pre></div>\n<p>then it doesn't work any more. Instead, the <code>#synth</code> fails with a timeout. So this instance <code>OrderMonoidWithZeroHomClass.toOrderMonoidHomClass</code> seems to me to be introducing a loop. I am eager to learn how to diagnose this further, but cannot figure out how to look at the traces myself. This failure is very strange to me because the failing <code>#synth</code> has nothing to do with the <code>Order</code> heirarchy.</p>",
        "id": 315076172,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670678063
    },
    {
        "content": "<p>Here's a version which demonstrates the issue on mathlib4 master:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib.Algebra.Hom.Group</span>\n<span class=\"kn\">import</span> <span class=\"n\">Mathlib.Order.Hom.Basic</span>\n\n<span class=\"kd\">variable</span> <span class=\"o\">{</span><span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">}</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">OrderMonoidHomClass</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"bp\">&lt;|</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">β</span><span class=\"o\">]</span>\n  <span class=\"o\">[</span><span class=\"n\">MulOneClass</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulOneClass</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"kd\">extends</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"n\">where</span>\n  <span class=\"n\">Monotone</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">F</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Monotone</span> <span class=\"n\">f</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"bp\">&lt;|</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">β</span><span class=\"o\">]</span>\n  <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"kd\">extends</span> <span class=\"n\">MonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"n\">where</span>\n  <span class=\"n\">Monotone</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">F</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Monotone</span> <span class=\"n\">f</span>\n\n<span class=\"c1\">-- deleting this instance makes the below #synth work</span>\n<span class=\"kd\">instance</span> <span class=\"o\">(</span><span class=\"n\">priority</span> <span class=\"o\">:=</span> <span class=\"mi\">100</span><span class=\"o\">)</span> <span class=\"n\">OrderMonoidWithZeroHomClass.toOrderMonoidHomClass</span>\n    <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">β</span><span class=\"o\">]</span>\n    <span class=\"o\">[</span><span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">OrderMonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:=</span>\n  <span class=\"o\">{</span> <span class=\"o\">‹</span><span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">›</span> <span class=\"k\">with</span> <span class=\"o\">}</span>\n\n<span class=\"kd\">variable</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"c1\">-- fails</span>\n</code></pre></div>\n<p>Removing mathlib is harder: I <a href=\"https://gist.github.com/kbuzzard/c8474b7164caa54f6da9bdccda6efc4b\">tried here</a> but couldn't reproduce as yet, <code>#synth</code> succeeds. If I could figure out how to see the traces I'd know which instances are missing in my mathlib-free failed MWE attempt. I think I'm going to have to leave this now; any help with figuring out how to see which instances Lean is getting confused by is welcome! Let me stress again that something very weird is going on here -- this MWE adds two new order-releated classes and an instance relating them; this then makes a type class inference search whch has nothing to do with orders fail.</p>",
        "id": 315083362,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670681139
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/FunLike.20issues/near/315071515\">said</a>:</p>\n<blockquote>\n<p>The fact that it's a deterministic timeout rather than just an \"i give up\" makes me wonder if typeclass inference is getting into some kind of loop. Can someone remind me how to look at instance traces in Lean 4? I don't think I've done this before. I tried <code>set_option trace.Meta.synthInstance true</code> but all I got was</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta.synthInstance</span><span class=\"o\">]</span> <span class=\"bp\">💥</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"bp\">▶</span>\n</code></pre></div>\n<p>which is certainly funny, but also not helpful enough</p>\n</blockquote>\n<p>That line is a link</p>",
        "id": 315089435,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670683702
    },
    {
        "content": "<p>oh cool! Indeed, it's a link which crashes VS Code. Edit: <code>set_option synthInstance.maxHeartbeats 400</code> saves me. Thanks a lot!</p>",
        "id": 315089950,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670683932
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">OrderDual.instPreorderOrderDual</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n          <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n            <span class=\"o\">(</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n              <span class=\"o\">(</span><span class=\"n\">i_4</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1458</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n                <span class=\"o\">(</span><span class=\"n\">i_5</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1674</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"n\">i_4</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n                  <span class=\"o\">(</span><span class=\"n\">i_6</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1926</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"n\">i_4</span> <span class=\"n\">i_5</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n                    <span class=\"o\">(</span><span class=\"n\">i_7</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.2214</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"n\">i_4</span> <span class=\"n\">i_5</span> <span class=\"n\">i_6</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n                      <span class=\"o\">(</span><span class=\"n\">i_8</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.2538</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"n\">i_4</span> <span class=\"n\">i_5</span> <span class=\"n\">i_6</span> <span class=\"n\">i_7</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n                        <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.2753</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"n\">i_4</span> <span class=\"n\">i_5</span> <span class=\"n\">i_6</span> <span class=\"n\">i_7</span> <span class=\"n\">i_8</span><span class=\"o\">)</span><span class=\"bp\">ᵒᵈ</span>\n</code></pre></div>\n<p>Is this bad?</p>",
        "id": 315090376,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670684122
    },
    {
        "content": "<p>An auto-implicit issue?</p>",
        "id": 315090541,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1670684167
    },
    {
        "content": "<p>definitely not.</p>",
        "id": 315090558,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670684179
    },
    {
        "content": "<p>searching for a preorder on a metavar means we applied a dangerous instance. Goals should not be metavars or it will enumerate all preorders</p>",
        "id": 315090726,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670684262
    },
    {
        "content": "<p>you should look for who introduced that</p>",
        "id": 315090859,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670684328
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta.synthInstance</span><span class=\"o\">]</span> <span class=\"bp\">💥</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"bp\">▼</span>\n  <span class=\"o\">[]</span> <span class=\"n\">new</span> <span class=\"n\">goal</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">_tc.0</span> <span class=\"n\">_tc.1</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">OrderMonoidHomClass.toMonoidHomClass</span> <span class=\"n\">to</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"bp\">?</span><span class=\"n\">m.848</span> <span class=\"bp\">?</span><span class=\"n\">m.849</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">OrderMonoidWithZeroHomClass.toOrderMonoidHomClass</span> <span class=\"n\">to</span> <span class=\"n\">OrderMonoidHomClass</span> <span class=\"n\">F</span> <span class=\"bp\">?</span><span class=\"n\">m.869</span> <span class=\"bp\">?</span><span class=\"n\">m.870</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithTop.preorder</span> <span class=\"n\">to</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithTop</span> <span class=\"bp\">?</span><span class=\"n\">m.911</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">OrderHom.instPreorderOrderHom</span> <span class=\"n\">to</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.914</span> <span class=\"bp\">→</span><span class=\"n\">o</span> <span class=\"bp\">?</span><span class=\"n\">m.915</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithTop.preorder</span> <span class=\"n\">to</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithTop</span> <span class=\"bp\">?</span><span class=\"n\">m.930</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">OrderHom.instPreorderOrderHom</span> <span class=\"n\">to</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.934</span> <span class=\"bp\">→</span><span class=\"n\">o</span> <span class=\"bp\">?</span><span class=\"n\">m.935</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">Prod.instPreorderProd</span> <span class=\"n\">to</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.939</span> <span class=\"bp\">×</span> <span class=\"bp\">?</span><span class=\"n\">m.940</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">OrderDual.instPreorderOrderDual</span> <span class=\"n\">to</span> <span class=\"n\">Preorder</span> <span class=\"bp\">?</span><span class=\"n\">m.944</span><span class=\"bp\">ᵒᵈ</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">Subtype.instPreorderSubtype</span> <span class=\"n\">to</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">Subtype</span> <span class=\"bp\">?</span><span class=\"n\">m.949</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithBot.preorder</span> <span class=\"n\">to</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithBot</span> <span class=\"bp\">?</span><span class=\"n\">m.951</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">instPreorderForAll</span> <span class=\"n\">to</span> <span class=\"n\">Preorder</span> <span class=\"o\">((</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"bp\">?</span><span class=\"n\">m.955</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithTop.preorder</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithTop</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.972</span> <span class=\"n\">i</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">OrderHom.instPreorderOrderHom</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.981</span> <span class=\"n\">i</span> <span class=\"bp\">→</span><span class=\"n\">o</span> <span class=\"bp\">?</span><span class=\"n\">m.982</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">Prod.instPreorderProd</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.991</span> <span class=\"n\">i</span> <span class=\"bp\">×</span> <span class=\"bp\">?</span><span class=\"n\">m.992</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">OrderDual.instPreorderOrderDual</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1001</span> <span class=\"n\">i</span><span class=\"o\">)</span><span class=\"bp\">ᵒᵈ</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">Subtype.instPreorderSubtype</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">Subtype</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1011</span> <span class=\"n\">i</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithBot.preorder</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithBot</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1018</span> <span class=\"n\">i</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">instPreorderForAll</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">((</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"bp\">?</span><span class=\"n\">m.1027</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithTop.preorder</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithTop</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1050</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">OrderHom.instPreorderOrderHom</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1064</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"bp\">→</span><span class=\"n\">o</span> <span class=\"bp\">?</span><span class=\"n\">m.1065</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">Prod.instPreorderProd</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1079</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"bp\">×</span> <span class=\"bp\">?</span><span class=\"n\">m.1080</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">OrderDual.instPreorderOrderDual</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1094</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span><span class=\"bp\">ᵒᵈ</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">Subtype.instPreorderSubtype</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">Subtype</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1109</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithBot.preorder</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithBot</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1121</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">instPreorderForAll</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">((</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"bp\">?</span><span class=\"n\">m.1135</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithTop.preorder</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithTop</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1164</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">OrderHom.instPreorderOrderHom</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1183</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"bp\">→</span><span class=\"n\">o</span> <span class=\"bp\">?</span><span class=\"n\">m.1184</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">Prod.instPreorderProd</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1203</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"bp\">×</span> <span class=\"bp\">?</span><span class=\"n\">m.1204</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">OrderDual.instPreorderOrderDual</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1223</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span><span class=\"bp\">ᵒᵈ</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">Subtype.instPreorderSubtype</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">Subtype</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1243</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithBot.preorder</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithBot</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1260</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">instPreorderForAll</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">((</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"bp\">?</span><span class=\"n\">m.1279</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithTop.preorder</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n          <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithTop</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1314</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">OrderHom.instPreorderOrderHom</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n          <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1338</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"bp\">→</span><span class=\"n\">o</span> <span class=\"bp\">?</span><span class=\"n\">m.1339</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">Prod.instPreorderProd</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n          <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1363</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"bp\">×</span> <span class=\"bp\">?</span><span class=\"n\">m.1364</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"n\">OrderDual.instPreorderOrderDual</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1388</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">)</span><span class=\"bp\">ᵒᵈ</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">Subtype.instPreorderSubtype</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n          <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">Subtype</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1413</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithBot.preorder</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n          <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithBot</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1435</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">instPreorderForAll</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n          <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n            <span class=\"o\">(</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">((</span><span class=\"n\">i_4</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1458</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"bp\">?</span><span class=\"n\">m.1459</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"n\">i_4</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithTop.preorder</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n          <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n            <span class=\"o\">(</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">i_4</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1458</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithTop</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1500</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"n\">i_4</span><span class=\"o\">))</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">OrderHom.instPreorderOrderHom</span> <span class=\"n\">to</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.954</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n        <span class=\"o\">(</span><span class=\"n\">i_1</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1026</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n          <span class=\"o\">(</span><span class=\"n\">i_2</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1134</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n            <span class=\"o\">(</span><span class=\"n\">i_3</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1278</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span><span class=\"o\">)</span> <span class=\"bp\">→</span>\n              <span class=\"o\">(</span><span class=\"n\">i_4</span> <span class=\"o\">:</span> <span class=\"bp\">?</span><span class=\"n\">m.1458</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m.1529</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"n\">i_4</span> <span class=\"bp\">→</span><span class=\"n\">o</span> <span class=\"bp\">?</span><span class=\"n\">m.1530</span> <span class=\"n\">i</span> <span class=\"n\">i_1</span> <span class=\"n\">i_2</span> <span class=\"n\">i_3</span> <span class=\"n\">i_4</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n</code></pre></div>\n<p>At what point did it go wrong? I've never seen one of these outputs before.</p>",
        "id": 315091068,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670684415
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code>  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">OrderMonoidWithZeroHomClass.toOrderMonoidHomClass</span> <span class=\"n\">to</span> <span class=\"n\">OrderMonoidHomClass</span> <span class=\"n\">F</span> <span class=\"bp\">?</span><span class=\"n\">m.869</span> <span class=\"bp\">?</span><span class=\"n\">m.870</span> <span class=\"bp\">▶</span>\n  <span class=\"o\">[]</span> <span class=\"bp\">✅</span> <span class=\"n\">apply</span> <span class=\"bp\">@</span><span class=\"n\">WithTop.preorder</span> <span class=\"n\">to</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">WithTop</span> <span class=\"bp\">?</span><span class=\"n\">m.911</span><span class=\"o\">)</span> <span class=\"bp\">▶</span>\n</code></pre></div>",
        "id": 315091199,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670684464
    },
    {
        "content": "<p>second line is definitely bad, first line is ok iff the two metavariables are out params</p>",
        "id": 315091297,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670684508
    },
    {
        "content": "<p>so <code>OrderMonoidWithZeroHomClass.toOrderMonoidHomClass</code> looks like the suspect</p>",
        "id": 315091386,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670684523
    },
    {
        "content": "<p>And what's wrong with this instance, which has lived in mathlib3 for a while now?</p>",
        "id": 315091491,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670684570
    },
    {
        "content": "<p>what's the signature?</p>",
        "id": 315091513,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670684584
    },
    {
        "content": "<p>See the MWE above.</p>",
        "id": 315091533,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670684595
    },
    {
        "content": "<p>(<a href=\"https://leanprover-community.github.io/mathlib_docs/find/order_monoid_with_zero_hom_class.to_order_monoid_hom_class\">docs#order_monoid_with_zero_hom_class.to_order_monoid_hom_class</a>)</p>",
        "id": 315091678,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1670684661
    },
    {
        "content": "<p>is  it true that the last two params in <code>MonoidHomClass</code> are outparams?</p>",
        "id": 315091735,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670684691
    },
    {
        "content": "<p>You may need to mark <code>[Preorder α] [Preorder β] [MulZeroOneClass α] [MulZeroOneClass β]</code> as outparams. I thought this was fixed so that they were automatically marked as outparams? cc: <span class=\"user-mention\" data-user-id=\"110043\">@Gabriel Ebner</span></p>",
        "id": 315092136,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670684849
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"sd\">/-- `MonoidHomClass F M N` states that `F` is a type of `Monoid`-preserving homomorphisms.</span>\n<span class=\"sd\">You should also extend this typeclass when you extend `MonoidHom`. -/</span>\n<span class=\"kd\">@[to_additive]</span>\n<span class=\"kd\">class</span> <span class=\"n\">MonoidHomClass</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">M</span> <span class=\"n\">N</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">))</span> <span class=\"o\">[</span><span class=\"n\">MulOneClass</span> <span class=\"n\">M</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulOneClass</span> <span class=\"n\">N</span><span class=\"o\">]</span>\n  <span class=\"kd\">extends</span> <span class=\"n\">MulHomClass</span> <span class=\"n\">F</span> <span class=\"n\">M</span> <span class=\"n\">N</span><span class=\"o\">,</span> <span class=\"n\">OneHomClass</span> <span class=\"n\">F</span> <span class=\"n\">M</span> <span class=\"n\">N</span>\n<span class=\"bp\">#</span><span class=\"n\">align</span> <span class=\"n\">monoid_hom_class</span> <span class=\"n\">MonoidHomClass</span>\n</code></pre></div>",
        "id": 315092398,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670684969
    },
    {
        "content": "<p>That seems like it might be worth posting as an issue</p>",
        "id": 315092498,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670685006
    },
    {
        "content": "<p>that is, it is surprising to me that <code>OrderMonoidWithZeroHomClass.toOrderMonoidHomClass</code> is being applied in this situation</p>",
        "id": 315092679,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670685101
    },
    {
        "content": "<p>what happens if you mark alpha and beta as outparams in the instance?</p>",
        "id": 315092852,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670685175
    },
    {
        "content": "<p>these links are super-cool BTW</p>",
        "id": 315092967,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670685240
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/FunLike.20issues/near/315092852\">said</a>:</p>\n<blockquote>\n<p>what happens if you mark alpha and beta as outparams in the instance?</p>\n</blockquote>\n<p>Doesn't fix it :-(</p>",
        "id": 315093160,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670685352
    },
    {
        "content": "<p>Can you make an MWE just for this instance to be applied in a TC search? It shouldn't depend on anything other than the types of the classes and instances used</p>",
        "id": 315093598,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670685565
    },
    {
        "content": "<p>It's this instance which causes the chaos:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span> <span class=\"o\">{</span><span class=\"n\">ι</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"n\">ι</span> <span class=\"bp\">→</span> <span class=\"kt\">Type</span> <span class=\"n\">v</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"bp\">∀</span> <span class=\"n\">i</span><span class=\"o\">,</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"n\">i</span><span class=\"o\">)]</span> <span class=\"o\">:</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">∀</span> <span class=\"n\">i</span><span class=\"o\">,</span> <span class=\"n\">α</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"n\">where</span>\n  <span class=\"n\">__</span> <span class=\"o\">:=</span> <span class=\"n\">inferInstanceAs</span> <span class=\"o\">(</span><span class=\"n\">LE</span> <span class=\"o\">(</span><span class=\"bp\">∀</span> <span class=\"n\">i</span><span class=\"o\">,</span> <span class=\"n\">α</span> <span class=\"n\">i</span><span class=\"o\">))</span>\n  <span class=\"n\">le_refl</span> <span class=\"o\">:=</span> <span class=\"k\">fun</span> <span class=\"n\">a</span> <span class=\"n\">i</span> <span class=\"bp\">↦</span> <span class=\"n\">le_refl</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">i</span><span class=\"o\">)</span>\n  <span class=\"n\">le_trans</span> <span class=\"o\">:=</span> <span class=\"k\">fun</span> <span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"n\">c</span> <span class=\"n\">h₁</span> <span class=\"n\">h₂</span> <span class=\"n\">i</span> <span class=\"bp\">↦</span> <span class=\"n\">le_trans</span> <span class=\"o\">(</span><span class=\"n\">h₁</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h₂</span> <span class=\"n\">i</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 315094636,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670686059
    },
    {
        "content": "<p>Mathlib-free MWE on the way</p>",
        "id": 315094663,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670686076
    },
    {
        "content": "<p>(unless someone tells me that something should be an outparam in the above instance)</p>",
        "id": 315094756,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670686110
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> is this OK as a MWE?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"n\">where</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">Zero.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"n\">where</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">One</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"n\">where</span>\n\n<span class=\"c1\">-- this instance (in mathlib) is just here in this example to ensure that</span>\n<span class=\"c1\">-- typeclass search for `Preorder ?m_1` causes chaos;</span>\n<span class=\"kd\">instance</span> <span class=\"o\">{</span><span class=\"n\">ι</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"n\">ι</span> <span class=\"bp\">→</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"bp\">∀</span> <span class=\"n\">i</span><span class=\"o\">,</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"n\">i</span><span class=\"o\">)]</span> <span class=\"o\">:</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">∀</span> <span class=\"n\">i</span><span class=\"o\">,</span> <span class=\"n\">α</span> <span class=\"n\">i</span><span class=\"o\">)</span> <span class=\"n\">where</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">MulZeroClass</span> <span class=\"o\">(</span><span class=\"n\">M₀</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"kd\">extends</span> <span class=\"n\">Mul</span> <span class=\"n\">M₀</span><span class=\"o\">,</span> <span class=\"n\">Zero</span> <span class=\"n\">M₀</span> <span class=\"n\">where</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">MulOneClass</span> <span class=\"o\">(</span><span class=\"n\">M</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"kd\">extends</span> <span class=\"n\">One</span> <span class=\"n\">M</span><span class=\"o\">,</span> <span class=\"n\">Mul</span> <span class=\"n\">M</span> <span class=\"n\">where</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">MulZeroOneClass</span> <span class=\"o\">(</span><span class=\"n\">M₀</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"kd\">extends</span> <span class=\"n\">MulOneClass</span> <span class=\"n\">M₀</span><span class=\"o\">,</span> <span class=\"n\">MulZeroClass</span> <span class=\"n\">M₀</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">FunLike</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Sort</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"o\">(</span><span class=\"kt\">Sort</span> <span class=\"n\">_</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">β</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"bp\">&lt;|</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Sort</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"n\">where</span>\n  <span class=\"n\">coe</span> <span class=\"o\">:</span> <span class=\"n\">F</span> <span class=\"bp\">→</span> <span class=\"bp\">∀</span> <span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">β</span> <span class=\"n\">a</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">(</span><span class=\"n\">priority</span> <span class=\"o\">:=</span> <span class=\"mi\">100</span><span class=\"o\">)</span> <span class=\"o\">{</span><span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">FunLike</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">CoeFun</span> <span class=\"n\">F</span> <span class=\"k\">fun</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">∀</span> <span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">β</span> <span class=\"n\">a</span> <span class=\"n\">where</span>\n  <span class=\"n\">coe</span> <span class=\"o\">:=</span> <span class=\"n\">FunLike.coe</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">MulHomClass</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">M</span> <span class=\"n\">N</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">))</span> <span class=\"o\">[</span><span class=\"n\">Mul</span> <span class=\"n\">M</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">Mul</span> <span class=\"n\">N</span><span class=\"o\">]</span>\n  <span class=\"kd\">extends</span> <span class=\"n\">FunLike</span> <span class=\"n\">F</span> <span class=\"n\">M</span> <span class=\"k\">fun</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">N</span> <span class=\"n\">where</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">OneHomClass</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">M</span> <span class=\"n\">N</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">))</span> <span class=\"o\">[</span><span class=\"n\">One</span> <span class=\"n\">M</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">One</span> <span class=\"n\">N</span><span class=\"o\">]</span>\n  <span class=\"kd\">extends</span> <span class=\"n\">FunLike</span> <span class=\"n\">F</span> <span class=\"n\">M</span> <span class=\"k\">fun</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">N</span> <span class=\"n\">where</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">ZeroHomClass</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">M</span> <span class=\"n\">N</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">))</span> <span class=\"o\">[</span><span class=\"n\">Zero</span> <span class=\"n\">M</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">Zero</span> <span class=\"n\">N</span><span class=\"o\">]</span>\n  <span class=\"kd\">extends</span> <span class=\"n\">FunLike</span> <span class=\"n\">F</span> <span class=\"n\">M</span> <span class=\"k\">fun</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">N</span> <span class=\"n\">where</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">MonoidHomClass</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">M</span> <span class=\"n\">N</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">))</span> <span class=\"o\">[</span><span class=\"n\">MulOneClass</span> <span class=\"n\">M</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulOneClass</span> <span class=\"n\">N</span><span class=\"o\">]</span>\n  <span class=\"kd\">extends</span> <span class=\"n\">MulHomClass</span> <span class=\"n\">F</span> <span class=\"n\">M</span> <span class=\"n\">N</span><span class=\"o\">,</span> <span class=\"n\">OneHomClass</span> <span class=\"n\">F</span> <span class=\"n\">M</span> <span class=\"n\">N</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">MonoidWithZeroHomClass</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">M</span> <span class=\"n\">N</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">))</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">M</span><span class=\"o\">]</span>\n  <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">N</span><span class=\"o\">]</span> <span class=\"kd\">extends</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">M</span> <span class=\"n\">N</span><span class=\"o\">,</span> <span class=\"n\">ZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">M</span> <span class=\"n\">N</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">OrderMonoidHomClass</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"bp\">&lt;|</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">β</span><span class=\"o\">]</span>\n  <span class=\"o\">[</span><span class=\"n\">MulOneClass</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulOneClass</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"kd\">extends</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"n\">where</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"o\">(</span><span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:</span> <span class=\"n\">outParam</span> <span class=\"bp\">&lt;|</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">β</span><span class=\"o\">]</span>\n  <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"kd\">extends</span> <span class=\"n\">MonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"n\">where</span>\n\n<span class=\"c1\">-- removing this instance makes the #synth below succeed</span>\n<span class=\"kd\">instance</span> <span class=\"o\">(</span><span class=\"n\">priority</span> <span class=\"o\">:=</span> <span class=\"mi\">1000</span><span class=\"o\">)</span> <span class=\"n\">OrderMonoidWithZeroHomClass.toOrderMonoidHomClass</span>\n    <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">β</span><span class=\"o\">]</span>\n    <span class=\"o\">[</span><span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">OrderMonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"o\">:=</span>\n  <span class=\"o\">{</span> <span class=\"o\">‹</span><span class=\"n\">OrderMonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">›</span> <span class=\"k\">with</span> <span class=\"o\">}</span>\n\n<span class=\"kd\">set_option</span> <span class=\"n\">synthInstance.maxHeartbeats</span> <span class=\"mi\">400</span> <span class=\"c1\">-- make trace manageable</span>\n<span class=\"kd\">set_option</span> <span class=\"n\">trace.Meta.synthInstance</span> <span class=\"n\">true</span>\n<span class=\"kd\">variable</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"n\">F</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">_</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MulZeroOneClass</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">MonoidWithZeroHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">]</span> <span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span> <span class=\"n\">MonoidHomClass</span> <span class=\"n\">F</span> <span class=\"n\">α</span> <span class=\"n\">β</span> <span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 315098339,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670687976
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/issues/1940\">https://github.com/leanprover/lean4/issues/1940</a></p>",
        "id": 315100601,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670689108
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> Thanks a lot for distilling this down to an MWE!</p>",
        "id": 315100891,
        "sender_full_name": "Frédéric Dupuis",
        "timestamp": 1670689264
    },
    {
        "content": "<p>I quite like this kind of detective work. It teaches me more about the system. I've learnt several new things just from this conversation.</p>",
        "id": 315101003,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670689328
    },
    {
        "content": "<blockquote>\n<p>You may need to mark [Preorder α] [Preorder β] [MulZeroOneClass α] [MulZeroOneClass β] as outparams. I thought this was fixed so that they were automatically marked as outparams?</p>\n</blockquote>\n<p>You're mixing things up, this has only incidentally to do with outparams.  The issue is that TC search shouldn't create a subgoal for the <code>[Preorder α]</code> argument (because that will almost certainly be the very very bad subgoal <code>Preorder ?m</code>).</p>\n<p>For automatically created instances, like the parent projection, we now mark these arguments as implicit instead of instance-implicit.  (This was the quick fix to <a href=\"https://github.com/leanprover/lean4/pull/1901\">lean4#1901</a>)  We might need to do (something like) this also for manually declared instances if writing <code>{_ : Preorder α}</code> proves too cumbersome.</p>",
        "id": 315123211,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1670703192
    },
    {
        "content": "<p>Thanks a lot Gabriel! I've learnt a ton today.</p>",
        "id": 315128028,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670706907
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"311453\">@Frédéric Dupuis</span> I've pushed Gabriel's fix to your branch.</p>",
        "id": 315128756,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670707504
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110043\">@Gabriel Ebner</span> I was thinking about that, but it seemed not to be the right solution in a lot of instances like this because we <em>do</em> want to use instance search once we know what alpha and beta are, because we won't be able to find those arguments by unification esp. if it's a stronger class than is expected by whatever is producing the outparam values (e.g if the instance only applies when the preorder on alpha is actually a linear order)</p>",
        "id": 315128989,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670707698
    },
    {
        "content": "<p>That is wishful thinking and not at all what the square brackets mean today.</p>",
        "id": 315134932,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1670712569
    },
    {
        "content": "<p>Marking those arguments as instance implicit right now won't magically make TC search do the right thing.  It will just time out.</p>",
        "id": 315134994,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1670712603
    },
    {
        "content": "<p>If you mark then as implicit it should work with the current set up.  The LinearOrder instance should be synthesized during unification as a nested TC problem.</p>",
        "id": 315135187,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1670712755
    },
    {
        "content": "<p>Well, it works for now and I know what to look for later; we'll see if any problems show up later and if so we can revisit.</p>",
        "id": 315135567,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670713027
    },
    {
        "content": "<p>I kind of agree that this is an inadequate solution.  We shouldn't need to tweak the braces everywhere (because it's awkward and inconsistent with other definitions).  TC search should probably also fill in the LinearOrder as a separate subgoal, but that's a much larger refactoring.</p>",
        "id": 315135606,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1670713062
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110043\">Gabriel Ebner</span> <a href=\"#narrow/stream/287929-mathlib4/topic/FunLike.20issues/near/315134932\">said</a>:</p>\n<blockquote>\n<p>That is wishful thinking and not at all what the square brackets mean today.</p>\n</blockquote>\n<p>I understand that, but {} brackets are also not the right solution, which is why I recommended to make an issue for it. It's possible that we can delay fixing the problem by using {} brackets instead, but this will fail if you actually need to use instance search on these arguments, which seems like a fairly common situation for typeclass instances.</p>",
        "id": 315136149,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670713424
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110043\">Gabriel Ebner</span> <a href=\"#narrow/stream/287929-mathlib4/topic/FunLike.20issues/near/315135187\">said</a>:</p>\n<blockquote>\n<p>If you mark then as implicit it should work with the current set up.  The LinearOrder instance should be synthesized during unification as a nested TC problem.</p>\n</blockquote>\n<p>If you use implicits, why would it be solved as a nested TC problem at all? It would just be an implicit arg that can't be inferred.</p>",
        "id": 315136273,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670713491
    },
    {
        "content": "<p>\"Nested\" TC problem means a TC problem that is created during unification. E.g. you unify <code>inferInstanceAs (Add Nat) =?= @AddMonoid.toAdd Nat ?m</code>, then Lean will try to synthesize an <code>AddMonoid Nat</code> (the type of <code>?m</code>) instance to unstuck the unification.</p>",
        "id": 315138994,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1670715609
    },
    {
        "content": "<p>(This solves the same issue as the unification hints in canonical structures, btw.)</p>",
        "id": 315139167,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1670715792
    },
    {
        "content": "<p>Is <a href=\"https://github.com/leanprover-community/mathlib4/pull/892#discussion_r1044162345\">this</a> failure to synthesise a <code>Preorder</code> instance an example of the issue in this thread?</p>",
        "id": 315147877,
        "sender_full_name": "Winston Yin",
        "timestamp": 1670723015
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/927\">mathlib4#927</a> also has problems synthesising <code>LE</code> instance, preventing any progress on the file. Happy to start a new thread if this isn't the same problem</p>",
        "id": 315149368,
        "sender_full_name": "Winston Yin",
        "timestamp": 1670724269
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"416472\">Winston Yin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/FunLike.20issues/near/315147877\">said</a>:</p>\n<blockquote>\n<p>Is <a href=\"https://github.com/leanprover-community/mathlib4/pull/892#discussion_r1044162345\">this</a> failure to synthesise a <code>Preorder</code> instance an example of the issue in this thread?</p>\n</blockquote>\n<p>I don't think it is. Hovering over the <code>↑</code> in <code>failed to synthesize instance Preorder ↑s</code> indicates that it's <code>type_of_Set</code>, so it seems to me that the issue is that the instance <code>Subtype.instPreorderSubtype</code> isn't firing because it's looking for <code>Preorder (Subtype p)</code>. If you add the missing instance, e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span> <span class=\"o\">[</span><span class=\"n\">Preorder</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">Set</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Preorder</span> <span class=\"o\">(</span><span class=\"bp\">↑</span><span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">Subtype.instPreorderSubtype</span> <span class=\"n\">s</span>\n</code></pre></div>\n<p>(although probably the construction should be filled in properly rather than relying on defeq abuse) then</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">theorem</span> <span class=\"n\">monotoneOn_iff_monotone</span> <span class=\"o\">:</span> <span class=\"n\">MonotoneOn</span> <span class=\"n\">f</span> <span class=\"n\">s</span> <span class=\"bp\">↔</span>\n  <span class=\"o\">(</span><span class=\"n\">Monotone</span> <span class=\"k\">fun</span> <span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">s</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">f</span> <span class=\"n\">a</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>works (the proof breaks, but that's another issue)</p>",
        "id": 315191533,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670757396
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"416472\">Winston Yin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/FunLike.20issues/near/315149368\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/927\">mathlib4#927</a> also has problems synthesising <code>LE</code> instance, preventing any progress on the file. Happy to start a new thread if this isn't the same problem</p>\n</blockquote>\n<p>Can you show me where the error is? I'm not even sure which file you're talking about in that PR. The first error in <code>Data.Nat.Order.Lemmas</code> is not related to LE.</p>",
        "id": 315191977,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1670757657
    },
    {
        "content": "<p>Coming late to this thread, but just in case not everyone has seen this: Gabriel recently gave #lint a power-up for detecting instances which will create bad typeclass searches (e.g. <code>Preorder ?α</code>). Your first step upon encountering a typeclass search blow-up should always be a #lint immediately before it, and then go solve any problems it finds before even beginning to think about the blow-up.</p>",
        "id": 315307441,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1670832006
    }
]