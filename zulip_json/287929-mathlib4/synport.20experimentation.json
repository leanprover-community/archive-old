[
    {
        "content": "<p>Using the synport/binport that <span class=\"user-mention\" data-user-id=\"230999\">@Daniel Selsam</span> posted, I did an experiment by taking the synported file of <code>measure_theory/measurable_space_def.lean</code>, and manually fixing all (most) things until the file compiled (I didn't go through correctly camelCasing names). It was quite some work, but there were a lot of minor things that could probably be done by an improved synport.<br>\nAfter I finished, I realized that this wasn't exactly the experimentation that Daniel asked for, but I'll post my findings here anyway. Hopefully they are helpful.<br>\nMany of these points are (probably known) issues with synport, but there are definitely also some things that are me just being unfamiliar with Lean 4 (and binport/synport).<br>\nFirst of all, I'd like to say that both binport and synport are very nice tools that already work very well!</p>\n<ul>\n<li>camel casing errors:<ul>\n<li>The field <code>MeasurableSet'</code> of <code>MeasurableSpace</code> was camel cased in the first occurrence, but not any time later in the file.</li>\n<li><code>countable</code> and <code>finite</code> were not capitalized</li>\n<li>Ideally lemmas like <code>measurable_set_empty</code> are automatically camelCased as <code>measurableSet_empty</code>.</li>\n<li>these got an incorrect capital letter when camel casing: (? : MeasurableSet _).Compl, Set.Union, Set.SInter, Set.SUnion, ... (presumably because these are Prop's after unfolding?)</li>\n</ul>\n</li>\n<li>Some notation was not working:<ul>\n<li><code>⋃</code> (probably because I'm importing binported files, not synported files? The <code>notation3</code> I saw to declare it also didn't work, presumably for the same reason?)</li>\n<li><code>∅</code> (missing instance?)</li>\n<li><code>ᶜ</code> (no localized notation)</li>\n</ul>\n</li>\n<li>Tactics that are not implemented:<ul>\n<li><code>simpa using</code></li>\n<li><code>rwa</code></li>\n<li><code>byCases</code></li>\n<li><code>;</code></li>\n<li><code>exacts</code></li>\n<li><code>rfl</code> for other reflexive relations</li>\n</ul>\n</li>\n<li>Notation that is not implemented<ul>\n<li><code>‹...›</code></li>\n<li><code>{ a : α | p }</code></li>\n<li><code>{x}</code></li>\n</ul>\n</li>\n<li>commands that are not implemented<ul>\n<li>open_locale/localized</li>\n</ul>\n</li>\n<li>some declarations (<code>MeasurableSet.bUnion_decode₂</code>) have more explicit arguments than the Lean 3 version (<code>⦃⦄</code> is translated to <code>()</code>?)</li>\n<li>parentheses:<ul>\n<li><code>∀ b ∈ s</code> is translated as <code>∀ b _ : b ∈ s</code> instead of <code>∀ b (_ : b ∈ s)</code></li>\n<li><code>assume t (ht : generate_measurable s t)</code> is translated as <code>fun t ht : generate_measurable s t</code></li>\n</ul>\n</li>\n<li>All <code>simp</code> calls I've tried gave me the error</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">deterministic</span><span class=\"o\">)</span> <span class=\"n\">timeout</span> <span class=\"n\">at</span> <span class=\"bp\">'</span><span class=\"n\">typeclass'</span><span class=\"o\">,</span> <span class=\"n\">maximum</span> <span class=\"n\">number</span> <span class=\"n\">of</span> <span class=\"n\">heartbeats</span> <span class=\"o\">(</span><span class=\"mi\">500</span><span class=\"o\">)</span> <span class=\"n\">has</span> <span class=\"n\">been</span> <span class=\"n\">reached</span> <span class=\"o\">(</span><span class=\"n\">use</span> <span class=\"bp\">'</span><span class=\"kd\">set_option</span> <span class=\"n\">synthInstance.maxHeartbeats</span> <span class=\"bp\">&lt;</span><span class=\"n\">num</span><span class=\"bp\">&gt;'</span> <span class=\"n\">to</span> <span class=\"n\">set</span> <span class=\"n\">the</span> <span class=\"n\">limit</span><span class=\"o\">)</span>\n</code></pre></div>\n<ul>\n<li>\n<p>spacing</p>\n<ul>\n<li>a lot of spaces after identifiers/commands are eaten</li>\n<li>if an argument to a tactic is missing, there is a superfluous space after translation:<br>\n<code>have p</code> -&gt; <code>have  p</code> or <code>simpa using</code> -&gt; <code>simpa  using</code>.</li>\n</ul>\n</li>\n<li>\n<p>λ should sometimes be replaced by @λ</p>\n</li>\n<li>the default value for <code>Lt</code> in <code>Preorder</code> seems to be missing</li>\n<li>The code</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">theorem</span> <span class=\"n\">subsingleton.MeasurableSet</span> <span class=\"o\">[</span><span class=\"n\">Subsingleton</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">{</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">Set</span> <span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">MeasurableSet</span> <span class=\"n\">s</span> <span class=\"o\">:=</span>\n<span class=\"n\">subsingleton.set_cases</span> <span class=\"n\">MeasurableSet.empty</span> <span class=\"n\">MeasurableSet.univ</span> <span class=\"n\">s</span>\n</code></pre></div>\n<p>gives the error</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">ambiguous</span><span class=\"o\">,</span> <span class=\"n\">possible</span> <span class=\"n\">interpretations</span>\n  <span class=\"n\">Subsingleton</span> <span class=\"n\">α</span>\n\n  <span class=\"n\">Subsingleton</span> <span class=\"o\">(</span><span class=\"n\">pure</span> <span class=\"n\">α</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I don't know how to specify that I don't want a \"pure\" inserted.</p>\n<ul>\n<li>In</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">theorem</span> <span class=\"n\">Set.finite.MeasurableSet</span> <span class=\"o\">{</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">Set</span> <span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">hs</span> <span class=\"o\">:</span> <span class=\"n\">Finite</span> <span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">MeasurableSet</span> <span class=\"n\">s</span> <span class=\"o\">:=</span>\n  <span class=\"n\">Finite.induction_on</span> <span class=\"n\">hs</span> <span class=\"n\">_root_.MeasurableSet.empty</span> <span class=\"bp\">λ</span> <span class=\"n\">ha</span> <span class=\"n\">hsf</span> <span class=\"n\">hsm</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">hsm.insert</span> <span class=\"n\">_</span>\n</code></pre></div>\n<p>the <code>_root_</code> is necessary, because otherwise <code>MeasurableSet</code> is interpreted as a recursive call of the function...</p>\n<ul>\n<li>Two Lean 4 questions:<ul>\n<li>Is there a <code>#print notation</code> equivalent? Something like <code>#print notation +</code>?</li>\n<li>What is the equivalent of <code>open_locale classical</code>?</li>\n</ul>\n</li>\n</ul>",
        "id": 250169817,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629491971
    },
    {
        "content": "<blockquote>\n<p>What is the equivalent of <code>open_locale classical</code>?</p>\n</blockquote>\n<p>It should be translated to <code>open_locale Classical</code></p>",
        "id": 250173586,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629494136
    },
    {
        "content": "<p>Note that synport is not (yet) elaborator-aware, so things like <code>\\lam</code> -&gt; <code>@\\lam</code> aren't easily addressable right now</p>",
        "id": 250174006,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629494368
    },
    {
        "content": "<p>but missing syntax and weird formatting can probably be addressed sooner (although I haven't thought about what to do about weird formatting in core yet)</p>",
        "id": 250174109,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629494419
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250169817\">said</a>:</p>\n<blockquote>\n<p>- Is there a <code>#print notation</code> equivalent? Something like <code>#print notation +</code>?</p>\n</blockquote>\n<p>No, but you can use go-to-definition on any use of <code>+</code> (and any other syntax as long as it's imported and not contributed by native code, like many builtins are without <code>import Lean</code>)</p>",
        "id": 250174426,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629494611
    },
    {
        "content": "<p>go to definition seems to take me to the definition of <code>app</code> a lot</p>",
        "id": 250174679,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629494765
    },
    {
        "content": "<p>Haha, that's the one syntax it shouldn't be able to go to since there is no atom to click on. But it's been a while since I've used it.</p>",
        "id": 250175067,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629495030
    },
    {
        "content": "<p>I often get go to definition hovers that cover the whole command and go to <code>def</code> or something. It's not just atoms</p>",
        "id": 250175130,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629495089
    },
    {
        "content": "<p>for example, hovering on <code>rcases</code> here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">rcases</span> <span class=\"n\">x</span>\n</code></pre></div>\n<p>highlights <code>rcases x</code> and takes me to <code>evalTacticSeq1Indented</code></p>",
        "id": 250175318,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629495219
    },
    {
        "content": "<p>It would be <em>really</em> nice to have a more reliable go-to-definition in Lean 4. In Lean 3 it's always very frustrating when it doesn't work or goes to the definition of the tactic that sits at the beginning of the line.</p>",
        "id": 250175524,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1629495361
    },
    {
        "content": "<p>In</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">exact</span> <span class=\"n\">x</span>\n</code></pre></div>\n<p>hovering over <code>exact</code> also highlights <code>exact x</code> but it takes me to <code>evalExact</code>, so maybe this has something to do with the elabs</p>",
        "id": 250175562,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629495366
    },
    {
        "content": "<p>(since <code>rcases</code> is not implemented in the first example, it just has a <code>syntax</code> declaration)</p>",
        "id": 250175590,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629495386
    },
    {
        "content": "<p>Yes, if syntax and elaborator are separate, go-to-definition goes to the elaborator and go-to-declaration to the syntax</p>",
        "id": 250175690,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629495451
    },
    {
        "content": "<p>\"no type definition found for 'rcases'\"</p>",
        "id": 250175800,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629495504
    },
    {
        "content": "<p>in <code>#check  `(by rcases p)</code>, hovering on <code>rcases</code> highlights the whole quotation and goes to <code>elab_stx_quot Parser.Term.quot</code></p>",
        "id": 250175883,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629495576
    },
    {
        "content": "<p>Oh yeah, quotations are not special-cased yet</p>",
        "id": 250175995,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629495637
    },
    {
        "content": "<p>what special case is needed? at the syntax level, the <code>rcases</code> parser is called just the same</p>",
        "id": 250176034,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629495671
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250175800\">said</a>:</p>\n<blockquote>\n<p>\"no type definition found for 'rcases'\"</p>\n</blockquote>\n<p>It's go-to-declaration, my bad</p>",
        "id": 250176076,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629495712
    },
    {
        "content": "<p>That one goes to <code>Parser.Tactic.tacticSeq1Indented</code></p>",
        "id": 250176170,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629495762
    },
    {
        "content": "<p>If it's not implemented yet, that's <em>kind of</em> correct, just not very helpful</p>",
        "id": 250176220,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629495807
    },
    {
        "content": "<p>the parser is implemented, but there is no elab (you get an error saying <code>tactic 'Lean.Parser.Tactic.rcases' has not been implemented</code>)</p>",
        "id": 250176321,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629495851
    },
    {
        "content": "<p>Yes, that's what I meant</p>",
        "id": 250176335,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629495862
    },
    {
        "content": "<p>what's the logic behind the kind-of correctness? Is it going up the tree to find something that was elabbed?</p>",
        "id": 250176415,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629495924
    },
    {
        "content": "<p>Yes. Many syntax kinds are merely a part of a notation, so we use the surrounding elaborator if any. In quotations, we should just go to the syntax at point instead. The <code>app</code> case might also stem from this.</p>",
        "id": 250176600,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629496038
    },
    {
        "content": "<p>It would be great to stop the search at category parser calls, which would fix the <code>tacticSeq1Indented</code> case, but we don't have that kind of information</p>",
        "id": 250176741,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629496131
    },
    {
        "content": "<p>hm, it should be possible to also handle the case where an elaborator is expected but missing, like <code>rcases</code>, and go to the syntax for that node instead of the elab if none is available</p>",
        "id": 250176776,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629496173
    },
    {
        "content": "<p>Oh right, we could record missing elaborators</p>",
        "id": 250176854,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629496211
    },
    {
        "content": "<p>and syntax-at-point is useful regardless - that should be an option anywhere (maybe under the go-to-declaration handler)</p>",
        "id": 250176885,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629496246
    },
    {
        "content": "<p>It is!</p>",
        "id": 250176912,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629496271
    },
    {
        "content": "<p>right now it looks like syntax-for-elaborator-at-parent-of-point</p>",
        "id": 250176929,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629496291
    },
    {
        "content": "<p>Ah yes, I think you are right. Yeah, I'd be happy to replace that one.</p>",
        "id": 250177009,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629496331
    },
    {
        "content": "<p>(I also need to set up a key combination for that, since it seems like VSCode doesn't bind anything to it)</p>",
        "id": 250177051,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629496370
    },
    {
        "content": "<p>Haven't even found it in Emacs at all yet, if it is actually exposed</p>",
        "id": 250177179,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629496446
    },
    {
        "content": "<p>In any case, do open issues for stuff like this!</p>",
        "id": 250177364,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629496612
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> I pushed a bunch of changes (some from yesterday) that I wish you had available for your test. Some of the issues you mention are already fixed:</p>\n<ul>\n<li>open_locale/localized</li>\n<li><code>ᶜ</code></li>\n<li><code>‹...›</code></li>\n<li>the default value for Lt in Preorder seems to be missing</li>\n</ul>",
        "id": 250177507,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629496727
    },
    {
        "content": "<p>For the unimplemented tactics and notation, we are depending on the community to step up and start filling them in. So far I've mostly been trying to avoid outright failures (these are marked by an <code>-- error</code> comment followed by some code that is obviously not correct lean 4 code) and missing things</p>",
        "id": 250177803,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629496912
    },
    {
        "content": "<blockquote>\n<p>some declarations (MeasurableSet.bUnion_decode₂) have more explicit arguments than the Lean 3 version (⦃⦄ is translated to ()?)</p>\n</blockquote>\n<p>Lean 4 got strict implicits recently, <del>they haven't been hooked up yet</del> fixed</p>",
        "id": 250177886,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629496954
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250173586\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>What is the equivalent of <code>open_locale classical</code>?</p>\n</blockquote>\n<p>It should be translated to <code>open_locale Classical</code></p>\n</blockquote>\n<p>Presumably after the community has implemented <code>open_locale</code>? Or did you also implement the command (not just the notation?). <br>\nI was mostly wondering how to do <code>attribute [instance] classical.dec</code> in Lean 4 (I haven't tried it, so maybe this code just works).</p>",
        "id": 250178544,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629497479
    },
    {
        "content": "<p>Do you know why <code>simp</code> gave me this type-class error? (this would happen on <code>simp</code> without arguments)</p>",
        "id": 250178573,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629497515
    },
    {
        "content": "<p>Nice that you've already implemented a couple of my missing points.</p>",
        "id": 250178695,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629497589
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250177803\">said</a>:</p>\n<blockquote>\n<p>For the unimplemented tactics and notation, we are depending on the community to step up and start filling them in. So far I've mostly been trying to avoid outright failures (these are marked by an <code>-- error</code> comment followed by some code that is obviously not correct lean 4 code) and missing things</p>\n</blockquote>\n<p>That makes sense. I'll work on porting some stuff to Lean 4 at some point! Is there anything that is useful to have first? Maybe <code>@[to_additive]</code> and <code>@[simps]</code> since they create new declarations themselves?</p>",
        "id": 250178989,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629497798
    },
    {
        "content": "<p>Yes, <code>open_locale</code> will need to be implemented. This is the biggest issue with getting error-free synported files right now - there is no hope of elaborating the files when none of the called tactics exist</p>",
        "id": 250178998,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629497806
    },
    {
        "content": "<p>Everything in the <code>Mathport/Prelude/Syntax.lean</code> file needs to be implemented at some point. I would personally focus on the easy tactics first and work my way to the bigger ones, since that will probably get more things working earlier</p>",
        "id": 250179163,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629497933
    },
    {
        "content": "<p>But things like <code>open_locale</code> and <code>notation3</code> are particularly important because they can declare new syntax, without which the file won't even parse</p>",
        "id": 250179304,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629498023
    },
    {
        "content": "<p><code>notation3</code> should work already, but there might be an issue with the camel case heuristics (which are more problematic in notation since those are elaborated lazily in lean 3)</p>",
        "id": 250179362,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629498093
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250178573\">said</a>:</p>\n<blockquote>\n<p>Do you know why <code>simp</code> gave me this type-class error? (this would happen on <code>simp</code> without arguments)</p>\n</blockquote>\n<p>My guess is that some translated <code>@[simp]</code> lemma is poison to lean 4 simp</p>",
        "id": 250179438,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629498140
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250178544\">said</a>:</p>\n<blockquote>\n<p>I was mostly wondering how to do <code>attribute [instance] classical.dec</code> in Lean 4 (I haven't tried it, so maybe this code just works).</p>\n</blockquote>\n<p>I believe the <code>@[instance]</code> attribute still exists in lean 4, so I think the same code works</p>",
        "id": 250179503,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629498226
    },
    {
        "content": "<p>btw localized has the snazzy new notation</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">localized</span> <span class=\"o\">[</span><span class=\"n\">Classical</span><span class=\"o\">]</span> <span class=\"kn\">attribute</span> <span class=\"o\">[</span><span class=\"kd\">instance</span><span class=\"o\">]</span> <span class=\"n\">Classical.dec</span>\n</code></pre></div>\n<p>no more string quotes needed! (Also be amazed at how we're correctly translating the contents of a string literal that is double-parsed by lean. No external lean 3 parser would be able to achieve this.)</p>",
        "id": 250179643,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629498346
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250169817\">said</a>:</p>\n<blockquote>\n<ul>\n<li>some declarations (<code>MeasurableSet.bUnion_decode₂</code>) have more explicit arguments than the Lean 3 version (<code>⦃⦄</code> is translated to <code>()</code>?)</li>\n</ul>\n</blockquote>\n<p>The <code>f</code> argument seems to be correctly translated to strict-implicit in Lean4, but strict-implicits were only added to lean4 a few weeks ago and haven't been stress-tested. Can you please be more specific about what behaved unexpectedly?</p>",
        "id": 250180966,
        "sender_full_name": "Daniel Selsam",
        "timestamp": 1629499554
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250169817\">said</a>:</p>\n<blockquote>\n<ul>\n<li>All <code>simp</code> calls I've tried gave me the error</li>\n</ul>\n<p><div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">deterministic</span><span class=\"o\">)</span> <span class=\"n\">timeout</span> <span class=\"n\">at</span> <span class=\"bp\">'</span><span class=\"n\">typeclass'</span><span class=\"o\">,</span> <span class=\"n\">maximum</span> <span class=\"n\">number</span> <span class=\"n\">of</span> <span class=\"n\">heartbeats</span> <span class=\"o\">(</span><span class=\"mi\">500</span><span class=\"o\">)</span> <span class=\"n\">has</span> <span class=\"n\">been</span> <span class=\"n\">reached</span> <span class=\"o\">(</span><span class=\"n\">use</span> <span class=\"bp\">'</span><span class=\"kd\">set_option</span> <span class=\"n\">synthInstance.maxHeartbeats</span> <span class=\"bp\">&lt;</span><span class=\"n\">num</span><span class=\"bp\">&gt;'</span> <span class=\"n\">to</span> <span class=\"n\">set</span> <span class=\"n\">the</span> <span class=\"n\">limit</span><span class=\"o\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>The current Lean4 default for <code>synthInstance.maxHeartbeats</code> makes sense for programming applications but is rather ambitious for Mathlib. I should have mentioned that for now I start every file with <code>set_option synthInstance.maxHeartbeats 5000</code>. You may also need to increase the <code>maxHeartbeats</code> flag as well (the default is 50,000 and 200,000 seems reasonable).</p>",
        "id": 250181240,
        "sender_full_name": "Daniel Selsam",
        "timestamp": 1629499784
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> Sorry, I didn't read the whole thread, but I want to remind you that we have scoped instances, notation, unification hints, and simp theorems in Lean 4. Scoped elements are activated when we open the namespace. Exaple:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"bp\">→</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span>\n  <span class=\"k\">if</span> <span class=\"n\">f</span> <span class=\"bp\">=</span> <span class=\"n\">g</span> <span class=\"k\">then</span> <span class=\"mi\">1</span> <span class=\"k\">else</span> <span class=\"mi\">2</span> <span class=\"c1\">-- Error</span>\n\n<span class=\"kn\">open</span> <span class=\"n\">Classical</span>\n\n<span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">boo</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"bp\">→</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span>\n  <span class=\"k\">if</span> <span class=\"n\">f</span> <span class=\"bp\">=</span> <span class=\"n\">g</span> <span class=\"k\">then</span> <span class=\"mi\">1</span> <span class=\"k\">else</span> <span class=\"mi\">2</span> <span class=\"c1\">-- Ok</span>\n</code></pre></div>",
        "id": 250181350,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629499883
    },
    {
        "content": "<p>You can find more examples in the lean4 <code>tests</code> folder directory. Here are some examples:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">scoped</span> <span class=\"n\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span> <span class=\"n\">term</span> <span class=\"n\">noWs</span> <span class=\"s2\">\"[\"</span> <span class=\"n\">term</span> <span class=\"s2\">\", \"</span> <span class=\"n\">term</span> <span class=\"s2\">\"]\"</span> <span class=\"o\">:</span> <span class=\"n\">term</span>\n\n<span class=\"kd\">@[scoped simp]</span> <span class=\"kd\">axiom</span> <span class=\"n\">ax1</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">g</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">x</span>\n\n<span class=\"n\">scoped</span> <span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">65</span> <span class=\"o\">(</span><span class=\"n\">priority</span> <span class=\"o\">:=</span> <span class=\"n\">default</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"s2\">\"+\"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">f</span>\n\n<span class=\"n\">scoped</span> <span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">ToString</span> <span class=\"n\">A</span> <span class=\"n\">where</span>\n  <span class=\"n\">toString</span> <span class=\"n\">a</span> <span class=\"o\">:=</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"A.mk {a.x} {a.y}\"</span>\n\n<span class=\"kd\">noncomputable</span> <span class=\"n\">scoped</span> <span class=\"kd\">instance</span> <span class=\"o\">(</span><span class=\"n\">priority</span> <span class=\"o\">:=</span> <span class=\"n\">low</span><span class=\"o\">)</span> <span class=\"n\">propDecidable</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Decidable</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n  <span class=\"n\">choice</span> <span class=\"bp\">&lt;|</span> <span class=\"k\">match</span> <span class=\"n\">em</span> <span class=\"n\">a</span> <span class=\"k\">with</span>\n    <span class=\"bp\">|</span> <span class=\"n\">Or.inl</span> <span class=\"n\">h</span> <span class=\"bp\">=&gt;</span> <span class=\"o\">⟨</span><span class=\"n\">isTrue</span> <span class=\"n\">h</span><span class=\"o\">⟩</span>\n    <span class=\"bp\">|</span> <span class=\"n\">Or.inr</span> <span class=\"n\">h</span> <span class=\"bp\">=&gt;</span> <span class=\"o\">⟨</span><span class=\"n\">isFalse</span> <span class=\"n\">h</span><span class=\"o\">⟩</span>\n\n<span class=\"n\">scoped</span> <span class=\"n\">macro_rules</span> <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bar</span><span class=\"bp\">!</span> <span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"mi\">10</span><span class=\"o\">)</span>\n\n<span class=\"n\">scoped</span> <span class=\"n\">unif_hint</span> <span class=\"o\">(</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">Magma</span><span class=\"o\">)</span> <span class=\"n\">where</span>\n  <span class=\"n\">s</span> <span class=\"bp\">=?=</span> <span class=\"n\">Nat.Magma</span> <span class=\"bp\">|-</span> <span class=\"n\">s.α</span> <span class=\"bp\">=?=</span> <span class=\"n\">Nat</span>\n</code></pre></div>",
        "id": 250181743,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629500265
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250179304\">said</a>:</p>\n<blockquote>\n<p>But things like <code>open_locale</code> and <code>notation3</code> are particularly important because they can declare new syntax, without which the file won't even parse</p>\n</blockquote>\n<p>Lean 4 has scoped attributes. Why do you need <code>open_locale</code>? Is there something missing in the new scoped attribute feature?</p>",
        "id": 250181844,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629500391
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250169817\">said</a>:</p>\n<blockquote>\n<ul>\n<li>The code</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">theorem</span> <span class=\"n\">subsingleton.MeasurableSet</span> <span class=\"o\">[</span><span class=\"n\">Subsingleton</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">{</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">Set</span> <span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">MeasurableSet</span> <span class=\"n\">s</span> <span class=\"o\">:=</span>\n<span class=\"n\">subsingleton.set_cases</span> <span class=\"n\">MeasurableSet.empty</span> <span class=\"n\">MeasurableSet.univ</span> <span class=\"n\">s</span>\n</code></pre></div>\n<p>gives the error</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">ambiguous</span><span class=\"o\">,</span> <span class=\"n\">possible</span> <span class=\"n\">interpretations</span>\n  <span class=\"n\">Subsingleton</span> <span class=\"n\">α</span>\n\n  <span class=\"n\">Subsingleton</span> <span class=\"o\">(</span><span class=\"n\">pure</span> <span class=\"n\">α</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I don't know how to specify that I don't want a \"pure\" inserted.</p>\n</blockquote>\n<p>Setting <code>pp.all true</code> provides more information:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">ambiguous</span><span class=\"o\">,</span> <span class=\"n\">possible</span> <span class=\"n\">interpretations</span>\n  <span class=\"n\">Subsingleton.</span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"n\">α</span>\n\n  <span class=\"bp\">@</span><span class=\"n\">Set.Subsingleton.</span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"bp\">?</span><span class=\"n\">u.15</span><span class=\"o\">)</span>\n    <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Pure.pure.</span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"n\">Set.</span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">}</span>\n      <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Applicative.toPure.</span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"n\">Set.</span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">}</span>\n        <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Monad.toApplicative.</span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"n\">Set.</span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"n\">Set.monad.</span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">u.15</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">}))</span>\n      <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"bp\">?</span><span class=\"n\">u.15</span><span class=\"o\">)</span> <span class=\"n\">α</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>It can be made to work by prefixing <code>_root_.Subsingleton</code> or by not opening the <code>Set</code> namespace. I don't have time to investigate right now but <code>Set</code> is a <code>Monad</code> and the <code>pure</code>-injection may be a little too strong here. We may not even want to align Mathlib's <code>monad</code> with Lean4's at all. Also, it is a shame that this isn't visible with default pp settings: the new smart pretty-printer is actually still very dumb regarding <code>open</code> namespaces, since I only tested it on roundtripping from the root namespace.</p>",
        "id": 250182820,
        "sender_full_name": "Daniel Selsam",
        "timestamp": 1629501210
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250169817\">said</a>:</p>\n<blockquote>\n<ul>\n<li>In</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">theorem</span> <span class=\"n\">Set.finite.MeasurableSet</span> <span class=\"o\">{</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">Set</span> <span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">hs</span> <span class=\"o\">:</span> <span class=\"n\">Finite</span> <span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">MeasurableSet</span> <span class=\"n\">s</span> <span class=\"o\">:=</span>\n  <span class=\"n\">Finite.induction_on</span> <span class=\"n\">hs</span> <span class=\"n\">_root_.MeasurableSet.empty</span> <span class=\"bp\">λ</span> <span class=\"n\">ha</span> <span class=\"n\">hsf</span> <span class=\"n\">hsm</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">hsm.insert</span> <span class=\"n\">_</span>\n</code></pre></div>\n<p>the <code>_root_</code> is necessary, because otherwise <code>MeasurableSet</code> is interpreted as a recursive call of the function...</p>\n</blockquote>\n<p>Minimized version:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">Foo.empty</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span> <span class=\"o\">:=</span> <span class=\"o\">()</span>\n<span class=\"kd\">def</span> <span class=\"n\">Bar.Foo</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span> <span class=\"o\">:=</span> <span class=\"n\">Foo.empty</span> <span class=\"c1\">-- error: invalid field 'empty', the environment does not contain 'Unit.empty'</span>\n</code></pre></div>\n<p>I agree this is surprising.</p>",
        "id": 250183551,
        "sender_full_name": "Daniel Selsam",
        "timestamp": 1629501882
    },
    {
        "content": "<p>The example above may look surprising to Lean 3 users, but it is consistent with the name resolution procedure we designed for Lean 4.<br>\nRecall that</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">Bar.Foo</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span> <span class=\"o\">:=</span> <span class=\"n\">Foo.empty</span>\n</code></pre></div>\n<p>is expanded to</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">namespace</span> <span class=\"n\">Bar</span>\n<span class=\"kd\">def</span> <span class=\"n\">Foo</span>  <span class=\"o\">:</span> <span class=\"n\">Unit</span> <span class=\"o\">:=</span> <span class=\"n\">Foo.empty</span>\n<span class=\"kd\">end</span> <span class=\"n\">Bar</span>\n</code></pre></div>\n<p>In Lean 4, you don't need to use equations to write recursive functions. As in Lean 3, local declarations have precedence over global ones. So, <code>Foo</code> is the body of the definition is referring to the <code>Foo</code> being defined.<br>\nThen, since <code>Foo</code> has type <code>Unit</code>, the dot-notation complains that there is no <code>Unit.empty</code>.</p>",
        "id": 250185107,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629503570
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112857\">Leonardo de Moura</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250181350\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> Sorry, I didn't read the whole thread, but I want to remind you that we have scoped instances, notation, unification hints, and simp theorems in Lean 4. Scoped elements are activated when we open the namespace. [...]</p>\n</blockquote>\n<p>Oh yes, I forgot to ask about this. I agree that with the scoped behavior I don't think we need the localized / open_locale commands anymore. From your example it is clear that both scoped notation and scoped instances work, which are the only uses in mathlib. <br>\n<span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> do you agree we can get rid of localized / open_locale?</p>",
        "id": 250196239,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629519864
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"230999\">@Daniel Selsam</span> thanks for your responses.</p>\n<ul>\n<li>About <code>Singleton</code>/<code>Set.Singleton</code>: Ah, that makes sense. I think having a coercion <code>α → Set α</code> is undesirable, so we should consider making <code>Set.Monad</code> a scoped instance.</li>\n</ul>",
        "id": 250196635,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629520568
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112857\">Leonardo de Moura</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250181844\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250179304\">said</a>:</p>\n<blockquote>\n<p>But things like <code>open_locale</code> and <code>notation3</code> are particularly important because they can declare new syntax, without which the file won't even parse</p>\n</blockquote>\n<p>Lean 4 has scoped attributes. Why do you need <code>open_locale</code>? Is there something missing in the new scoped attribute feature?</p>\n</blockquote>\n<p>My plan, at least, was to translate <code>open_locale</code> directly to a new <code>open_locale</code> command, at least at first, just to keep the translation simple and literal. Scoped attributes can probably replace <code>open_locale</code>, but the implementation is sufficiently syntactically different that it seems easier to do that in a separate refactor after the port. Perhaps there is a way to backport uses of <code>open_locale</code> in mathlib such that they can be more directly replaced by scoped notation.</p>",
        "id": 250197097,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629521466
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112857\">Leonardo de Moura</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250185107\">said</a>:</p>\n<blockquote>\n<p>The example above may look surprising to Lean 3 users, but it is consistent with the name resolution procedure we designed for Lean 4.</p>\n</blockquote>\n<p>One of the issues I have hit with this name resolution procedure is that you can't have a definition <code>def foo</code> that makes use of <code>def foo.aux</code>, because it always resolves to the local variable <code>foo</code>. In lean 3, namespaced names take precedence over dot notation, so most of the time this works fine; in equation compiler definitions you can hit this issue because <code>foo</code> is a local variable, but you can still use <code>@foo.aux</code> to refer to it:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">foo.aux</span> <span class=\"o\">:=</span> <span class=\"mi\">1</span>\n<span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">ℕ</span> <span class=\"bp\">→</span> <span class=\"n\">ℕ</span>\n<span class=\"bp\">|</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">foo.aux</span>\n</code></pre></div>\n<p>In lean 4 I don't know any workaround other than using <code>_root_</code> or some other namespace.</p>\n<p>I think namespaced names should take precedence over dot notation even on local variables (which is not the case in lean 3 or lean 4 ATM), since you can always force dot notation by using any of the other notations for it - <code>foo .aux</code>, <code>foo |&gt;.aux</code>, <code>(foo).aux</code>, while there is no such backup option for namespaced names (besides using a different name to refer to it).</p>",
        "id": 250197891,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629522743
    },
    {
        "content": "<p>To say more about the <code>open_locale</code> issue, in mathlib <code>open classical</code> and <code>open_locale classical</code> currently do different things, and in particular the second does not imply the first. Excessive use of <code>open</code> leads to frequent name clashes, and I tend to avoid them in most mathlib code I write. So we may need to refactor mathlib such that locales differ from namespaces, and are specifically tailored for the notations, like the old <code>eq.ops</code> namespace from lean 2.</p>",
        "id": 250198862,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629524146
    },
    {
        "content": "<blockquote>\n<p>I think namespaced names should take precedence over dot notation even on local variables (which is not the case in lean 3 or lean 4 ATM),</p>\n</blockquote>\n<p>I don't agree.<br>\nHere are different ways to write your <code>foo</code> example above in Lean4:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"bp\">→</span> <span class=\"n\">Nat</span>\n<span class=\"bp\">|</span> <span class=\"n\">n</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">_root_.foo.aux</span>\n\n<span class=\"kn\">open</span> <span class=\"n\">foo</span> <span class=\"k\">in</span>\n<span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"bp\">→</span> <span class=\"n\">Nat</span>\n<span class=\"bp\">|</span> <span class=\"n\">n</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">aux</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"bp\">→</span> <span class=\"n\">Nat</span>\n<span class=\"bp\">|</span> <span class=\"n\">n</span> <span class=\"bp\">=&gt;</span> <span class=\"kn\">open</span> <span class=\"n\">foo</span> <span class=\"k\">in</span> <span class=\"n\">aux</span>\n\n<span class=\"n\">macro</span> <span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"n\">noWs</span> <span class=\"s2\">\"#\"</span> <span class=\"n\">noWs</span> <span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">:</span> <span class=\"n\">term</span> <span class=\"bp\">=&gt;</span>\n  <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">open</span> <span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"k\">in</span> <span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"bp\">→</span> <span class=\"n\">Nat</span>\n  <span class=\"bp\">|</span> <span class=\"n\">n</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">foo</span><span class=\"bp\">#</span><span class=\"n\">aux</span>\n</code></pre></div>\n<p>Note that we can create many different variants of the last one using macros. This is just a simple one.</p>",
        "id": 250220025,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629555787
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250198862\">said</a>:</p>\n<blockquote>\n<p>To say more about the <code>open_locale</code> issue, in mathlib <code>open classical</code> and <code>open_locale classical</code> currently do different things, and in particular the second does not imply the first. Excessive use of <code>open</code> leads to frequent name clashes, and I tend to avoid them in most mathlib code I write. So we may need to refactor mathlib such that locales differ from namespaces, and are specifically tailored for the notations, like the old <code>eq.ops</code> namespace from lean 2.</p>\n</blockquote>\n<p>I added the command <code>open scoped</code> that will activate the scoped attributes, but will not \"open\" the names.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">open</span> <span class=\"n\">scoped</span> <span class=\"n\">Classical</span>\n\n<span class=\"k\">#check</span> <span class=\"bp\">@</span><span class=\"n\">epsilon</span> <span class=\"c1\">-- Error</span>\n\n<span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"bp\">→</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span>\n  <span class=\"k\">if</span> <span class=\"n\">f</span> <span class=\"bp\">=</span> <span class=\"n\">g</span> <span class=\"k\">then</span> <span class=\"mi\">1</span> <span class=\"k\">else</span> <span class=\"mi\">2</span> <span class=\"c1\">-- Ok</span>\n</code></pre></div>",
        "id": 250220113,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629555888
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250196635\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"230999\">Daniel Selsam</span> thanks for your responses.</p>\n<ul>\n<li>About <code>Singleton</code>/<code>Set.Singleton</code>: Ah, that makes sense. I think having a coercion <code>α → Set α</code> is undesirable, so we should consider making <code>Set.Monad</code> a scoped instance.</li>\n</ul>\n</blockquote>\n<p>I don't know what mathlib uses that instance for, but it would be great if the scoping could be backported.</p>",
        "id": 250224576,
        "sender_full_name": "Daniel Selsam",
        "timestamp": 1629561884
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112857\">Leonardo de Moura</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250220113\">said</a>:</p>\n<blockquote>\n<p>I added the command <code>open scoped</code> that will activate the scoped attributes, but will not \"open\" the names.</p>\n</blockquote>\n<p>Thanks. So now <code>open_locale foo</code> can be translated to <code>open scoped Foo</code>. For localized, we would want to translate <code>localized \"cmd\" in foo</code> to <code>scoped cmd</code>, but with the constraint that we must be in namespace <code>foo</code> when we do it. I think we should backport this, by introducing <code>localized \"cmd\"</code> without the <code>in foo</code> part, which uses the current namespace (a la <code>#where</code>) to determine what <code>foo</code> should be (and errors in the global namespace).</p>",
        "id": 250230791,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629570485
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"230999\">Daniel Selsam</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250224576\">said</a>:</p>\n<blockquote>\n<p>I don't know what mathlib uses that instance for, but it would be great if the scoping could be backported.</p>\n</blockquote>\n<p>I expect it is used very little. I'll take a look.</p>",
        "id": 250232184,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629572714
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112857\">Leonardo de Moura</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250220025\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>I think namespaced names should take precedence over dot notation even on local variables (which is not the case in lean 3 or lean 4 ATM),</p>\n</blockquote>\n<p>I don't agree.<br>\nHere are different ways to write your <code>foo</code> example above in Lean4:<br>\n[...]<br>\nNote that we can create many different variants of the last one using macros. This is just a simple one.</p>\n</blockquote>\n<p>These accidental self-references occur a lot in mathlib. The statement that object <code>foo</code> has property <code>bar</code> is usually called <code>bar.foo</code> (e.g. <a href=\"https://leanprover-community.github.io/mathlib_docs/find/continuous.max\">docs#continuous.max</a>), so that we can use the projection notation. Often in the proof <code>foo</code> is mentioned explicitly. So the more common example of a clash will look like this</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">Foo</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span> <span class=\"n\">True</span>\n<span class=\"kd\">def</span> <span class=\"n\">aux</span> <span class=\"o\">:=</span> <span class=\"mi\">1</span>\n<span class=\"kd\">def</span> <span class=\"n\">Foo.aux</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"n\">aux</span> <span class=\"o\">:=</span>\n<span class=\"k\">have</span> <span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">aux</span> <span class=\"bp\">=</span> <span class=\"mi\">1</span> <span class=\"o\">:=</span> <span class=\"n\">rfl</span>\n<span class=\"n\">trivial</span>\n</code></pre></div>\n<p>For example, these are all lemmas <em>in a single file</em> with accidental self-references: (at least on the current commit <code>897e4ed</code>)<br>\n<a href=\"https://leanprover-community.github.io/mathlib_docs/find/set.ord_connected.measurable_set/src\">src#set.ord_connected.measurable_set</a><br>\n<a href=\"https://leanprover-community.github.io/mathlib_docs/find/ae_measurable.max/src\">src#ae_measurable.max</a><br>\n<a href=\"https://leanprover-community.github.io/mathlib_docs/find/ae_measurable.min/src\">src#ae_measurable.min</a><br>\n<a href=\"https://leanprover-community.github.io/mathlib_docs/find/measurable.is_lub/src\">src#measurable.is_lub</a><br>\n<a href=\"https://leanprover-community.github.io/mathlib_docs/find/ae_measurable.is_lub/src\">src#ae_measurable.is_lub</a><br>\n<a href=\"https://leanprover-community.github.io/mathlib_docs/find/measurable.is_glb/src\">src#measurable.is_glb</a><br>\n<a href=\"https://leanprover-community.github.io/mathlib_docs/find/ae_measurable.is_glb/src\">src#ae_measurable.is_glb</a></p>\n<p>We could probably make a macro that <code>#foo</code> means <code>_root_.foo</code>, but I'm still worried that it will confuse users.</p>",
        "id": 250233173,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629574097
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> This is very unfortunate. We have discussed the name resolution in the past and decided that local declarations should take precedence. Note that we did not change that in Lean 4. It looks like a new problem, but it is due to two new features that were requested by users.</p>\n<p>1) <code>def Foo.f  ... := ...</code> expands to <code>namespace Foo def f ... := ... end Foo</code></p>\n<p>2) We don't need to use equations to write recursive declarations. </p>\n<p>To change the name resolution procedure now, we would have to carefully analyze all new issues (and counterintuitive behavior) the change would produce, and carefully spec how it is supposed to work. Even if we do all this work, I can see other users complaining that they have to write <code>foo .aux</code>, <code>foo |&gt;.aux</code>, or <code>(foo).aux</code> because local variables do not take precedence. </p>\n<p>Remarks:</p>\n<ul>\n<li>If we add a mechanism for stating that a declaration is not recursive (i.e., disabling feature 2 above), then the problem is gone.</li>\n<li>The <code>protected</code> keyword is another possible workaround. The local declaration will not be atomic.</li>\n</ul>",
        "id": 250236251,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629578850
    },
    {
        "content": "<blockquote>\n<p>Even if we do all this work, I can see other users complaining that they have to write foo .aux, foo |&gt;.aux, or (foo).aux because local variables do not take precedence. </p>\n</blockquote>\n<p>Note that <code>foo.aux</code> should still work to refer to field projection of <code>aux</code> on local variable <code>foo</code>, provided that <code>foo.aux</code> does not also resolve to something in the current namespace/opens. Since most local variables have lowercase names and most namespaces have uppercase names, I think that collisions of this sort should be rare, but when they do occur, a single character to disambiguate them seems like a small price to pay.</p>",
        "id": 250236469,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629579125
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> Consider the following example you linked</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">lemma</span> <span class=\"n\">ae_measurable.min</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">δ</span> <span class=\"bp\">→</span> <span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">μ</span> <span class=\"o\">:</span> <span class=\"n\">measure</span> <span class=\"n\">δ</span><span class=\"o\">}</span>\n  <span class=\"o\">(</span><span class=\"n\">hf</span> <span class=\"o\">:</span> <span class=\"n\">ae_measurable</span> <span class=\"n\">f</span> <span class=\"n\">μ</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hg</span> <span class=\"o\">:</span> <span class=\"n\">ae_measurable</span> <span class=\"n\">g</span> <span class=\"n\">μ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">ae_measurable</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">a</span><span class=\"o\">,</span> <span class=\"n\">min</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">a</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">g</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"n\">μ</span> <span class=\"o\">:=</span>\n<span class=\"o\">⟨</span><span class=\"bp\">λ</span> <span class=\"n\">a</span><span class=\"o\">,</span> <span class=\"n\">min</span> <span class=\"o\">(</span><span class=\"n\">hf.mk</span> <span class=\"n\">f</span> <span class=\"n\">a</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hg.mk</span> <span class=\"n\">g</span> <span class=\"n\">a</span><span class=\"o\">),</span> <span class=\"n\">hf.measurable_mk.min</span> <span class=\"n\">hg.measurable_mk</span><span class=\"o\">,</span>\n  <span class=\"n\">eventually_eq.comp₂</span> <span class=\"n\">hf.ae_eq_mk</span> <span class=\"n\">_</span> <span class=\"n\">hg.ae_eq_mk</span><span class=\"o\">⟩</span>\n</code></pre></div>\n<p>Unless we add the feature stating that <code>ae_measurable.min</code> is not recursive, the <code>min</code> inside will still refer to the lemma being defined.</p>",
        "id": 250236474,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629579133
    },
    {
        "content": "<p>Another issue caused by (1) is that it is impossible to have a mutual def between declarations named <code>foo</code> and <code>foo.aux</code></p>",
        "id": 250236596,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629579344
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> The example above shows that the change in the name resolution procedure will not even fix the problem.</p>",
        "id": 250236645,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629579382
    },
    {
        "content": "<p>because you can't put a namespace declaration in the middle of a mutual block</p>",
        "id": 250236646,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629579395
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250236596\">said</a>:</p>\n<blockquote>\n<p>Another issue caused by (1) is that it is impossible to have a mutual def between declarations named <code>foo</code> and <code>foo.aux</code></p>\n</blockquote>\n<p>Let's focus on the problems that affect Mathlib.</p>",
        "id": 250236674,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629579465
    },
    {
        "content": "<p>I think that (1) is a bit too aggressive for a lot of uses, but I would like to get more objective data on the relative benefits</p>",
        "id": 250236675,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629579471
    },
    {
        "content": "<p>in particular once you are in the def there is no way to \"cancel\" the namespace that you have been put into</p>",
        "id": 250236729,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629579514
    },
    {
        "content": "<p>and so you basically get problems similar to overuse of <code>open</code></p>",
        "id": 250236742,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629579541
    },
    {
        "content": "<p>Looking at <code>ae_measurable.min</code>, I think it would be fine to use <code>_root_.min</code> in that particular case. We already have plenty of other examples like it which use the equation compiler, and we just use <code>_root_</code> in that case</p>",
        "id": 250237133,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629579967
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>   This kind of discussion is very time-consuming. It takes time to find holes in the suggestions. I will try to summarize the thread</p>\n<ul>\n<li>The change in the name resolution procedure will not fix the problem. See <code>ae_measurable.min</code> example above. </li>\n<li>Feature (1) was supported by many users. If I remember correctly <span class=\"user-mention\" data-user-id=\"110032\">@Reid Barton</span> was the first one that suggested it. We had written a lot of Lean code, and can confirm it works really well.</li>\n</ul>",
        "id": 250237146,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629579983
    },
    {
        "content": "<blockquote>\n<p>Feature (1) was supported by many users. If I remember correctly @Reid Barton was the first one that suggested it. We had written a lot of Lean code, and can confirm it works really well.</p>\n</blockquote>\n<p>Hence the need to get examples together that show the advantages and disadvantages. Clearly both options have downsides, and I don't know what the relative magnitude of the downsides are, and the cost of the workarounds when you get the wrong thing by default and want the other one</p>",
        "id": 250237266,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629580199
    },
    {
        "content": "<p>What kind of code benefits the most from (1) and/or would be much more verbose without it? The simple desugaring suggests that it is possible to get the effect of (1) with a def-like macro (possibly even switching the names around so that <code>def</code> is the macro and <code>def'</code> is the core command)</p>",
        "id": 250237409,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629580405
    },
    {
        "content": "<p>it would be easy enough to have synport produce <code>def'</code> instead of <code>def</code> whenever the name of the def contains a dot</p>",
        "id": 250237470,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629580466
    },
    {
        "content": "<p>I agree that this is an unfortunate situation, and I don't know the best solution.<br>\nAn option to disable (2) would be ok (so that you have to write at least one equation <code>| ... =&gt; ...</code>to enable a recursive call), but it's not ideal. (I expect we will want to use this option in most mathlib files).</p>",
        "id": 250237557,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629580588
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250237557\">said</a>:</p>\n<blockquote>\n<p>I agree that this is an unfortunate situation, and I don't know the best solution.<br>\nAn option to disable (2) would be ok (so that you have to write at least one equation <code>| ... =&gt; ...</code>to enable a recursive call), but it's not ideal. (I expect we will want to use this option in most mathlib files).</p>\n</blockquote>\n<p>Yes, the <code>| ... =&gt; ...</code> style was criticized a lot in the past. We should not go back to it.<br>\nOne option is to still use the name <code>ae_measuable.min</code> for the local declaration even after we perform the macro expansion on <code>theorem ae_measurable.min</code>. But some users may protest that <code>def Foo.f  ... := ...</code> would not be equivalent to <code>namespace Foo def f ... := ... end Foo</code> anymore.</p>",
        "id": 250237791,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629580990
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250237470\">said</a>:</p>\n<blockquote>\n<p>it would be easy enough to have synport produce <code>def'</code> instead of <code>def</code> whenever the name of the def contains a dot</p>\n</blockquote>\n<p>This might work. We would also have <code>theorem'</code>, correct?</p>",
        "id": 250237939,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629581232
    },
    {
        "content": "<p>yes, and <code>instance'</code>, <code>example'</code> etc. This also seems a bit unfortunate but workable</p>",
        "id": 250237990,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629581298
    },
    {
        "content": "<p>To be clear, I'm not prescribing any particular option, and I hope we can find something that works the best for lean 4 users even if mathlib has to change. To my lean 3 colored perspective the fact that the name of a def only affects the name itself and not the body of the definition makes its own kind of sense, and I would present that point of view to anyone protesting about the lack of equivalence of <code>def Foo.f</code> and <code>namespace Foo def f</code>. But there seem to be no perfect options here.</p>",
        "id": 250238050,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629581409
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112857\">Leonardo de Moura</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250237791\">said</a>:</p>\n<blockquote>\n<p>One option is to still use the name <code>ae_measuable.min</code> for the local declaration even after we perform the macro expansion on <code>theorem ae_measurable.min</code>. </p>\n</blockquote>\n<p>I think this will solve 90+% of the cases in mathlib. <br>\nThere will be still a couple of problematic cases, like <a href=\"https://leanprover-community.github.io/mathlib_docs/find/con_gen/src\">src#con_gen</a>, <a href=\"https://leanprover-community.github.io/mathlib_docs/find/magma.free_semigroup/src\">src#magma.free_semigroup</a>, <a href=\"https://leanprover-community.github.io/mathlib_docs/find/localization/src\">src#localization</a>, but it's rare that a declaration <code>foo</code> uses a declaration <code>foo.bar</code> in it's definition/proof.<br>\nAnother potential problem is that we are in a namespace <code>foo</code> and define <code>bar</code>, while <code>_root_.bar</code> also exists (and is used in <code>foo.bar</code>), but usually we protect declarations <code>foo.bar</code> like this, so then there should be no name clash.</p>",
        "id": 250238324,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629581848
    },
    {
        "content": "<p>Is it possible for local declarations to have names with dots? AFAIR this is illegal in lean 3</p>",
        "id": 250238396,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629581956
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> <span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> What about a <code>nonrec</code> modifier for declarations? We already have <code>partial</code>. The macro <code>lemma</code> would expand to <code>nonrec theorem</code>. I think <strong>most</strong> of the examples that Floris linked are <code>lemma</code>s.<br>\nEDIT: missed</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">free_semigroup</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">has_mul</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span> <span class=\"o\">:=</span>\n<span class=\"n\">quot</span> <span class=\"bp\">$</span> <span class=\"n\">free_semigroup.r</span> <span class=\"n\">α</span>\n</code></pre></div>",
        "id": 250238453,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629582056
    },
    {
        "content": "<p>ooh, that's nice too</p>",
        "id": 250238459,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629582071
    },
    {
        "content": "<p>I would be happy with that.</p>",
        "id": 250238510,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629582147
    },
    {
        "content": "<p>well, not sure about using <code>lemma</code> for this, I think the mathematicians have their own opinions about when to apply this label that probably don't correlate with <code>nonrec</code></p>",
        "id": 250238512,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629582149
    },
    {
        "content": "<p>but using <code>nonrec lemma</code> directly should be fine</p>",
        "id": 250238515,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629582162
    },
    {
        "content": "<p><del>As I said, the declarations I linked in that message are <em>rare</em>. I just happened to make a list of declarations <code>foo</code> that used <code>foo.bar</code> in their definition, so I had some potential examples lying around. </del><br>\n<del>I would be ok with requiring these <code>def</code>s to be replaced by <code>nonrec def</code></del></p>\n<p>EDIT: Oh wait, with the new suggestion we do run into the problems that in <code>def foo.bar := </code> the declaration <code>bar</code> is a recursive call. That might be more frequent.</p>",
        "id": 250238580,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629582247
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112857\">Leonardo de Moura</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250185107\">said</a>:</p>\n<blockquote>\n<p>As in Lean 3, local declarations have precedence over global ones.</p>\n</blockquote>\n<p>I just wanted to mention that we already have a special case in name resolution for recursive references: in <code>x.f</code>, <code>f</code> may be a recursive reference if its (the current) namespace is the type of <code>x</code>. And that makes sense of course (apart from being very convenient) given that users think of recursive references as global references, not local ones - as if <code>f</code> was already part of the environment. Then would it not be consistent to extend the special case to the reverse case as well - to interpret <code>f.x</code> as the global reference <code>f.x</code>, if it exists, in favor of a projection of the recursive reference (which I don't think I have ever seen used anyway)? IOW, I believe it would be consistent and convenient to prefer global to local references <em>in the <code>auxDecl</code> special case</em>.</p>",
        "id": 250238791,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629582603
    },
    {
        "content": "<p>More generally we could have name resolution \"pretend\" that <code>Current.Namespace.f</code> is already in the environment, such that references such as <code>_root_.Current.Namespace.f</code> and <code>Namespace.f</code> work as well</p>",
        "id": 250239057,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629583053
    },
    {
        "content": "<p>(This would not resolve the <code>min</code> case, no)</p>",
        "id": 250239310,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1629583354
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> What about combining <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>  suggestion and having <code>norec</code> modifier (for examples like <code>min</code>). It should solve all cases, correct?</p>",
        "id": 250239807,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629584046
    },
    {
        "content": "<p>I think this will work</p>",
        "id": 250239840,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1629584102
    },
    {
        "content": "<p>Yes, that sounds good to me. I think we still want the <code>nonrec</code> modifier a lot, for cases like <code>ae_measurable.min</code>, so I think we want it to be the default in mathlib for <code>lemma</code> and/or <code>theorem</code>(but as long as we can do that in mathlib by macros, I'd be happy)</p>",
        "id": 250240260,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1629584664
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/synport.20experimentation/near/250196635\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"230999\">Daniel Selsam</span> thanks for your responses.</p>\n<ul>\n<li>About <code>Singleton</code>/<code>Set.Singleton</code>: Ah, that makes sense. I think having a coercion <code>α → Set α</code> is undesirable, so we should consider making <code>Set.Monad</code> a scoped instance.</li>\n</ul>\n</blockquote>\n<p>BTW with <a href=\"https://github.com/leanprover/lean4/pull/643\">https://github.com/leanprover/lean4/pull/643</a> your example gives the following error with default settings:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">ambiguous</span><span class=\"o\">,</span> <span class=\"n\">possible</span> <span class=\"n\">interpretations</span>\n  <span class=\"n\">_root_.Subsingleton</span> <span class=\"n\">α</span>\n\n  <span class=\"n\">Set.Subsingleton</span> <span class=\"o\">(</span><span class=\"n\">pure</span> <span class=\"n\">α</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 250243942,
        "sender_full_name": "Daniel Selsam",
        "timestamp": 1629590069
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> <span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> Pushed the changes. We can now write</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">foo.aux</span> <span class=\"o\">:=</span> <span class=\"mi\">1</span>\n<span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"bp\">→</span> <span class=\"n\">Nat</span>\n  <span class=\"bp\">|</span> <span class=\"n\">n</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">foo.aux</span>\n</code></pre></div>\n<p>and </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">Foo</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span> <span class=\"n\">True</span>\n<span class=\"kd\">def</span> <span class=\"n\">aux</span> <span class=\"o\">:=</span> <span class=\"mi\">1</span>\n<span class=\"n\">nonrec</span> <span class=\"kd\">def</span> <span class=\"n\">Foo.aux</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"n\">aux</span> <span class=\"o\">:=</span>\n  <span class=\"k\">have</span> <span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">aux</span> <span class=\"bp\">=</span> <span class=\"mi\">1</span> <span class=\"o\">:=</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 250244421,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1629590901
    },
    {
        "content": "<p>So does this mean that</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">nonrec</span> <span class=\"kd\">def</span> <span class=\"n\">Foo.aux</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"n\">aux</span> <span class=\"o\">:=</span>\n  <span class=\"k\">have</span> <span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">aux</span> <span class=\"bp\">=</span> <span class=\"mi\">1</span> <span class=\"o\">:=</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">trivial</span>\n</code></pre></div>\n<p>is the preferred spelling, and we should prefer not to write the following?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">Foo.aux</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"n\">aux</span> <span class=\"o\">:=</span>\n  <span class=\"k\">have</span> <span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">_root_.aux</span> <span class=\"bp\">=</span> <span class=\"mi\">1</span> <span class=\"o\">:=</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 323224590,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1674559346
    },
    {
        "content": "<p>I don't think we really need a \"preferred spelling\" here</p>",
        "id": 323225003,
        "sender_full_name": "Reid Barton",
        "timestamp": 1674559448
    }
]