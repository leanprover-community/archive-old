[
    {
        "content": "<p>I'm still desperately trying to get fully usable <a href=\"https://github.com/leanprover-community/mathlib/issues/5440\">#5440</a> before my course starts but <span class=\"user-mention\" data-user-id=\"121918\">@Edward Ayers</span>  doesn't have time for this (he started his real world job). The code in the PR works great for display but the \"copy to clipboard\" button still has the default rendering of expr. In the PR, the quantifier collapsing code is deeply intertwined with the complicated annotated expressions needed for widgets. I'd like to reproduce the collapsing effect in a function from <code>expr</code> to <code>tactic string</code>. But I don't know how to print expression that actually feature de Bruijn indices. I made a small start with</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">tactic</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">tactic</span>\n<span class=\"n\">setup_tactic_parser</span>\n<span class=\"kn\">open</span> <span class=\"n\">tactic</span>\n\n<span class=\"kd\">meta</span> <span class=\"kd\">def</span> <span class=\"n\">collapsed_pp</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">tactic</span> <span class=\"n\">string</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">expr.pi</span> <span class=\"n\">x</span> <span class=\"n\">xbi</span> <span class=\"n\">xy</span> <span class=\"o\">(</span><span class=\"n\">expr.pi</span> <span class=\"n\">p</span> <span class=\"n\">pbi</span> <span class=\"n\">py</span> <span class=\"n\">b</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"k\">do</span>\n    <span class=\"n\">pp_py</span> <span class=\"bp\">←</span> <span class=\"n\">tactic.pp</span> <span class=\"n\">py</span><span class=\"o\">,</span>\n    <span class=\"n\">body</span> <span class=\"bp\">←</span> <span class=\"n\">collapsed_pp</span> <span class=\"n\">b</span><span class=\"o\">,</span>\n    <span class=\"n\">pure</span> <span class=\"o\">(</span><span class=\"s2\">\"∀ \"</span> <span class=\"bp\">++</span> <span class=\"n\">to_string</span> <span class=\"n\">pp_py</span> <span class=\"bp\">++</span> <span class=\"s2\">\", \"</span> <span class=\"bp\">++</span> <span class=\"n\">body</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span> <span class=\"n\">e</span> <span class=\"o\">:=</span> <span class=\"k\">do</span> <span class=\"n\">pp_e</span> <span class=\"bp\">←</span> <span class=\"n\">pp</span> <span class=\"n\">e</span><span class=\"o\">,</span> <span class=\"n\">pure</span> <span class=\"n\">pp_e.to_string</span>\n\n<span class=\"kd\">@[interactive]</span>\n<span class=\"kd\">meta</span> <span class=\"kd\">def</span> <span class=\"n\">test</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">parse</span> <span class=\"n\">ident</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">unit</span> <span class=\"o\">:=</span>\n<span class=\"k\">do</span> <span class=\"n\">e</span> <span class=\"bp\">←</span> <span class=\"n\">get_local</span> <span class=\"n\">n</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">infer_type</span><span class=\"o\">,</span>\n   <span class=\"n\">s</span> <span class=\"bp\">←</span> <span class=\"n\">collapsed_pp</span> <span class=\"n\">e</span><span class=\"o\">,</span>\n   <span class=\"n\">trace</span> <span class=\"n\">s</span><span class=\"o\">,</span>\n   <span class=\"n\">skip</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">tactic</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"n\">n</span> <span class=\"bp\">&gt;</span> <span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"n\">true</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">true</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">test</span> <span class=\"n\">h</span><span class=\"o\">,</span>\n  <span class=\"gr\">sorry</span>\n<span class=\"kd\">end</span>\n</code></pre></div>\n<p>but the output is <code>∀ #0 &gt; 0, true</code>, which makes sense. How can I get my <code>∀ n &gt; 0, true</code> back by re-injecting the name <code>x</code>? Or should I do something else entirely? The global goal here is to go from <code>e : expr</code> to <code>string</code> which is a version of <code>pp e</code> where quantifiers are nicely collapsed as you can do on input.</p>",
        "id": 223822629,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1611506724
    },
    {
        "content": "<p>Hi Patrick I'm having a look now dw :)</p>",
        "id": 223837779,
        "sender_full_name": "Edward Ayers",
        "timestamp": 1611525493
    },
    {
        "content": "<p>Pushed to <a href=\"https://github.com/leanprover-community/mathlib/issues/5440\">#5440</a></p>",
        "id": 223839006,
        "sender_full_name": "Edward Ayers",
        "timestamp": 1611526611
    },
    {
        "content": "<p>There is a new method called <code>pretty_print_with_collapsed_quantifiers</code> that you can use</p>",
        "id": 223839022,
        "sender_full_name": "Edward Ayers",
        "timestamp": 1611526658
    }
]