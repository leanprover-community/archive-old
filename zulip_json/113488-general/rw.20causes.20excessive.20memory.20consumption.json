[
    {
        "content": "<p>Mathlib's <code>ring_theory.perfection</code> is slow. In fact I literally cannot compile it on one of my my machines -- if I am on master and I open <code>src/ring_theory/perfection.lean</code> and restart Lean then there is every chance I get <code>excessive memory consumption </code> errors. Can anyone else reproduce this? The reason we don't notice is that mathlib comes with its own olean files so we don't ever need to compile it (unless we're working on it). Even worse, if I am editing this file then the excessive memory consumption errors begin to show up more and more often, until eventually I get just into some situation where e.g. the orange bars never go away and I have to restart VS Code.</p>\n<p>I would like to know the reason for this excessive memory consumption, and I can't figure it out. I have however spent several hours on this today, and have made some progress: I've managed to isolate what I think must be the issue, and furthermore I've made it mathlib-free (this is what took most of the time; I have no idea whether it's useful but it was certainly interesting). The issue is that there are sometimes goals of the form <code>p f = q f</code> and mathlib has a lemma <code>foo</code> of the form <code>\\forall t, p t = q t</code> but <code>rw foo</code> takes a very long time to decide that <code>t = f</code> is a good idea. If you replace <code>rw foo</code> with <code>rw foo f</code> then this saves about 1.5 to 2 seconds of time on my machine for every rewrite, and can stop Lean going over the edge into the excessive memory consumption. The reason this is a problem is that a generic user would not know to do this, because <code>rw foo</code> should in theory just work fine.</p>\n<p>Someone who is a master of Lean traces might be able to work out what wrong turn <code>rw</code> is taking, and the fix might be as simple as making something <code>irreducible</code>; if we could isolate this problem then it would lead to perhaps some nice speedup in this part of the library. </p>\n<p>Here is an example using mathlib where we can see the problem. I am simply reproving some lemmas in <code>ring_theory.perfection</code>, using the rewrites with and without an explicit <code>f</code>. </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">ring_theory.perfection</span>\n\n<span class=\"kd\">universe</span> <span class=\"n\">u</span>\n\n<span class=\"kd\">set_option</span> <span class=\"n\">profiler</span> <span class=\"n\">true</span>\n<span class=\"c1\">-- elaboration of pth_root_frobenius_quick took 114ms</span>\n<span class=\"kd\">lemma</span> <span class=\"n\">pth_root_frobenius_quick</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">comm_semiring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span>\n  <span class=\"o\">[</span><span class=\"n\">char_p</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">perfection.pth_root</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span> <span class=\"o\">(</span><span class=\"n\">frobenius</span> <span class=\"n\">_</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">ring_hom.id</span> <span class=\"n\">_</span> <span class=\"o\">:=</span>\n<span class=\"n\">ring_hom.ext</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">f</span><span class=\"o\">,</span> <span class=\"n\">perfection.ext</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"kd\">begin</span>\n  <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">ring_hom.comp_apply</span><span class=\"o\">,</span> <span class=\"n\">ring_hom.id_apply</span><span class=\"o\">,</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">],</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_frobenius</span> <span class=\"n\">f</span> <span class=\"c1\">--</span>\n<span class=\"kd\">end</span>\n\n<span class=\"c1\">-- elaboration of pth_root_frobenius_slow took 2.92s</span>\n<span class=\"kd\">lemma</span> <span class=\"n\">pth_root_frobenius_slow</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">comm_semiring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span>\n  <span class=\"o\">[</span><span class=\"n\">char_p</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">perfection.pth_root</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span> <span class=\"o\">(</span><span class=\"n\">frobenius</span> <span class=\"n\">_</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">ring_hom.id</span> <span class=\"n\">_</span> <span class=\"o\">:=</span>\n<span class=\"n\">ring_hom.ext</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">f</span><span class=\"o\">,</span> <span class=\"n\">perfection.ext</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"kd\">begin</span>\n  <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">ring_hom.comp_apply</span><span class=\"o\">,</span> <span class=\"n\">ring_hom.id_apply</span><span class=\"o\">,</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">],</span>\n  <span class=\"c1\">-- ⊢ ⇑(perfection.coeff R p (n + 1)) (⇑(frobenius ↥(ring.perfection R p) p) x) = ⇑(perfection.coeff R p n) x</span>\n  <span class=\"c1\">-- the LHS of the goal literally matches the LHS of the lemma.</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_frobenius</span> <span class=\"c1\">-- no f, costs us 1.5 seconds</span>\n<span class=\"kd\">end</span>\n\n<span class=\"c1\">-- elaboration of frobenius_pth_root_quick took 455ms</span>\n<span class=\"kd\">lemma</span> <span class=\"n\">frobenius_pth_root_quick</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">comm_semiring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">char_p</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n  <span class=\"o\">(</span><span class=\"n\">frobenius</span> <span class=\"o\">(</span><span class=\"n\">ring.perfection</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span> <span class=\"o\">(</span><span class=\"n\">perfection.pth_root</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">ring_hom.id</span> <span class=\"o\">(</span><span class=\"n\">ring.perfection</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"n\">ring_hom.ext</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">f</span><span class=\"o\">,</span> <span class=\"n\">perfection.ext</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">rw</span> <span class=\"n\">ring_hom.comp_apply</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">ring_hom.id_apply</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">ring_hom.map_frobenius</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_pth_root</span> <span class=\"n\">f</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"bp\">←</span> <span class=\"n\">ring_hom.map_frobenius</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_frobenius</span> <span class=\"n\">f</span><span class=\"o\">,</span>\n<span class=\"kd\">end</span>\n\n<span class=\"c1\">-- elaboration of frobenius_pth_root_slow took 16.2s</span>\n<span class=\"kd\">lemma</span> <span class=\"n\">frobenius_pth_root_slow</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">comm_semiring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">char_p</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n  <span class=\"o\">(</span><span class=\"n\">frobenius</span> <span class=\"o\">(</span><span class=\"n\">ring.perfection</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span> <span class=\"o\">(</span><span class=\"n\">perfection.pth_root</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">ring_hom.id</span> <span class=\"o\">(</span><span class=\"n\">ring.perfection</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"n\">ring_hom.ext</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">f</span><span class=\"o\">,</span> <span class=\"n\">perfection.ext</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">rw</span> <span class=\"n\">ring_hom.comp_apply</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">ring_hom.id_apply</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">ring_hom.map_frobenius</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"bp\">←</span> <span class=\"n\">ring_hom.map_frobenius</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_frobenius</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n<span class=\"kd\">end</span>\n\n<span class=\"c1\">-- edit this comment a few times and you'll be in trouble</span>\n<span class=\"kd\">lemma</span> <span class=\"n\">I_can_break_lean</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">comm_semiring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">char_p</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n  <span class=\"o\">(</span><span class=\"n\">frobenius</span> <span class=\"o\">(</span><span class=\"n\">ring.perfection</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span> <span class=\"o\">(</span><span class=\"n\">perfection.pth_root</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">ring_hom.id</span> <span class=\"o\">(</span><span class=\"n\">ring.perfection</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"n\">ring_hom.ext</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">f</span><span class=\"o\">,</span> <span class=\"n\">perfection.ext</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">rw</span> <span class=\"n\">ring_hom.comp_apply</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">ring_hom.id_apply</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">ring_hom.map_frobenius</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"bp\">←</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"bp\">←</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"bp\">←</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"bp\">←</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"bp\">←</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"n\">rw</span> <span class=\"bp\">←</span> <span class=\"n\">perfection.coeff_pth_root</span><span class=\"o\">,</span> <span class=\"c1\">-- no f</span>\n  <span class=\"gr\">sorry</span>\n<span class=\"kd\">end</span>\n<span class=\"c\">/-</span><span class=\"cm\"></span>\n<span class=\"cm\">excessive memory consumption detected at 'replace' (potential solution: increase memory consumption threshold)</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>Here's an exercise: try and change the comments above the lemmas to the amount of time it takes to elaborate them on your machine. This will force Lean to compile and recompile the file, and eventually you will get an excessive memory consumption error, even if you were lucky enough to get the file to compile the first time around, as sometimes happens for me (especially if I restart VS Code -- then I am very likely to get it to compile the first time around). Just adding random comments to the file and then removing them will soon get you into trouble though, and then you get more and more excessive memory consumption errors and then you restart Lean and get more and restart Lean and get more and eventually have to restart VS Code again.</p>\n<p>I have no idea whether not having mathlib as a dependency makes it easier to debug this issues, but <a href=\"https://gist.github.com/kbuzzard/999fd7d54af7e37c91b1c13122daf941\">here</a> is a mathlib-free version, where I literally copied everything over, keeping the data but sorrying the lemmas. <del>If I open this in a fresh file and then I just add random <code>-- hi</code> comments then it's not long before I get <code>excessive memory consumption</code> errors.</del>(this is not true -- I had other mathlib files open including the bad one)</p>",
        "id": 238325048,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620746119
    },
    {
        "content": "<p>Should <code>ring.perfection</code> be irreducible? Its definition is</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"sd\">/-- The perfection of a ring `R` with characteristic `p`,</span>\n<span class=\"sd\">defined to be the projective limit of `R` using the Frobenius maps `R → R`</span>\n<span class=\"sd\">indexed by the natural numbers, implemented as `{ f : ℕ → R | ∀ n, f (n + 1) ^ p = f n }`. -/</span>\n<span class=\"kd\">def</span> <span class=\"n\">ring.perfection</span> <span class=\"o\">(</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u₁</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">comm_semiring</span> <span class=\"n\">R</span><span class=\"o\">]</span>\n  <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"n\">p.prime</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">char_p</span> <span class=\"n\">R</span> <span class=\"n\">p</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n  <span class=\"n\">subsemiring</span> <span class=\"o\">(</span><span class=\"n\">ℕ</span> <span class=\"bp\">→</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"o\">{</span> <span class=\"n\">zero_mem'</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"n\">zero_pow</span> <span class=\"bp\">$</span> <span class=\"n\">hp.1.pos</span><span class=\"o\">,</span>\n  <span class=\"n\">add_mem'</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">f</span> <span class=\"n\">g</span> <span class=\"n\">hf</span> <span class=\"n\">hg</span> <span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"o\">(</span><span class=\"n\">frobenius_add</span> <span class=\"n\">R</span> <span class=\"n\">p</span> <span class=\"n\">_</span> <span class=\"n\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">trans</span> <span class=\"bp\">$</span> <span class=\"n\">congr_arg2</span> <span class=\"n\">_</span> <span class=\"o\">(</span><span class=\"n\">hf</span> <span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hg</span> <span class=\"n\">n</span><span class=\"o\">),</span>\n  <span class=\"bp\">..</span> <span class=\"n\">monoid.perfection</span> <span class=\"n\">R</span> <span class=\"n\">p</span> <span class=\"o\">}</span>\n</code></pre></div>\n<p>so if the docstring is correct the precise representation one uses is an implementation detail, and one should probably hide it. Also, with this definition (as a subsemiring), you see everywhere <code>f: ↥(ring.perfection R p)</code>, with this weird arrow that is certainly making things complicated.</p>",
        "id": 238328832,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1620747344
    },
    {
        "content": "<p><code>subsemiring</code>s are important when you want to compare properties of the subring with the properties of the ambient ring. Here, I am not sure this really matters, right?</p>",
        "id": 238329685,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1620747553
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110064\">@Kenny Lau</span> why do you keep it as a subring?</p>",
        "id": 238331535,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620748143
    },
    {
        "content": "<p>Just as an experiment, I replaced the subsemiring by a type synonym (without making anything irreducible), just to remove the coe_to_sort. It's in <a href=\"https://github.com/leanprover-community/mathlib/tree/test_perfection\">branch#test_perfection</a>. <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> , could you check if it makes things better from your point of view, or if it doesn't change anything?</p>",
        "id": 238362408,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1620758656
    },
    {
        "content": "<p>I have made one further adjustment, and now everything seems to be instantaneous.</p>",
        "id": 238368554,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1620761261
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib/issues/7583\">#7583</a></p>",
        "id": 238377809,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1620765303
    },
    {
        "content": "<p>It would be really nice to be able to extract reusable and teachable wisdom from such adventures.</p>",
        "id": 238378588,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1620765584
    },
    {
        "content": "<p>This is why I made an effort to minimise -- I haven't looked yet but it sounds like Sebastien fixed the problem -- but there is some underlying rule here which I still haven't quite understood. Those rewrites look completely innocent.</p>",
        "id": 238379522,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620765992
    },
    {
        "content": "<p>The type was too complicated so Lean got lost (coercions are complicated -- that's why they're gone in Lean 4, by the way). So I removed all the coercions and went back to plain subtypes. Can you confirm it works for you?</p>",
        "id": 238380540,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1620766485
    },
    {
        "content": "<p>how are coercions being replaced in lean4?</p>",
        "id": 238381967,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1620767108
    },
    {
        "content": "<p>Does yury's has_coe_to_sort refactor make this less bad?</p>",
        "id": 238382342,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1620767256
    },
    {
        "content": "<p>Coercions to sort are gone in Lean 4? How do I promote a subring to a ring?</p>",
        "id": 238382549,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620767336
    },
    {
        "content": "<p>I guess this will be possible by manually invoking <code>subtype</code>?</p>",
        "id": 238388775,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1620770658
    },
    {
        "content": "<p>As in:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">variables</span> <span class=\"o\">(</span><span class=\"n\">X</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">ring</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">Y</span> <span class=\"o\">:</span> <span class=\"n\">subring</span> <span class=\"n\">X</span><span class=\"o\">)</span>\n\n<span class=\"k\">#check</span> <span class=\"n\">subtype</span> <span class=\"n\">Y.carrier</span> <span class=\"c1\">-- `Type u`</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">ring</span> <span class=\"o\">(</span><span class=\"n\">subtype</span> <span class=\"n\">Y.carrier</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">Y.to_ring</span>\n</code></pre></div>",
        "id": 238388790,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1620770668
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/113488-general/topic/rw.20causes.20excessive.20memory.20consumption/near/238382549\">said</a>:</p>\n<blockquote>\n<p>Coercions to sort are gone in Lean 4? How do I promote a subring to a ring?</p>\n</blockquote>\n<p>CoeSort is still around <a href=\"https://github.com/leanprover/lean4/blob/1e6dadfa5214b0fa2d6edb1494b7eb94accd4b15/src/Init/Coe.lean#L40-L41\">https://github.com/leanprover/lean4/blob/1e6dadfa5214b0fa2d6edb1494b7eb94accd4b15/src/Init/Coe.lean#L40-L41</a></p>",
        "id": 238389634,
        "sender_full_name": "Mac",
        "timestamp": 1620771134
    },
    {
        "content": "<p>Coercions in lean 4 work differently, they no longer stick <code>coe</code> functions in the term. But they are still inferred using typeclasses the same way as lean 3</p>",
        "id": 238396027,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620774834
    },
    {
        "content": "<p>Were it not for all the old_structure stuff one would be able to easily port my example to Lean 4 and see if the problem remained.</p>",
        "id": 238429716,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620802606
    },
    {
        "content": "<p>That shouldn't be insurmountable, I think you've still done the majority of the really hard work there</p>",
        "id": 238435795,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1620806310
    }
]