[
    {
        "content": "<p>Does anyone know why the elaborator fails on one of these two inductive types, but fails on the other?</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">def</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">incl</span> <span class=\"o\">{</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">hi</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"bp\">&lt;</span> <span class=\"n\">n</span><span class=\"o\">)]</span> <span class=\"o\">:</span> <span class=\"n\">fin</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"bp\">⟨</span><span class=\"n\">i</span><span class=\"o\">,</span> <span class=\"n\">hi</span><span class=\"bp\">⟩</span>\n<span class=\"n\">def</span> <span class=\"n\">my_predicate</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"n\">fin</span> <span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"o\">:=</span> <span class=\"n\">bool</span>\n\n<span class=\"kn\">inductive</span> <span class=\"n\">failing</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"c1\">-- failed to synthesize type class instance `fact (i &lt; n)`</span>\n<span class=\"bp\">|</span> <span class=\"n\">mk</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"bp\">&lt;</span> <span class=\"n\">n</span><span class=\"o\">)],</span> <span class=\"n\">my_predicate</span> <span class=\"n\">n</span> <span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">incl</span> <span class=\"bp\">→</span> <span class=\"n\">failing</span>\n\n<span class=\"kn\">inductive</span> <span class=\"n\">succeeding</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span> <span class=\"n\">mk</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"bp\">&lt;</span> <span class=\"n\">n</span><span class=\"o\">)],</span> <span class=\"n\">my_predicate</span> <span class=\"n\">n</span> <span class=\"o\">(</span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">incl</span> <span class=\"o\">:</span> <span class=\"n\">fin</span> <span class=\"bp\">_</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">succeeding</span>\n</code></pre></div>\n\n\n<p>(side note: the usual <code>by exactI</code> trick doesn't work for inductive types, because tactic mode doesn't know how to deal with the name of the inductive type.)</p>",
        "id": 204730006,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1595456889
    },
    {
        "content": "<p>Here is your explanation:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">failed</span> <span class=\"n\">to</span> <span class=\"n\">synthesize</span> <span class=\"n\">type</span> <span class=\"n\">class</span> <span class=\"kn\">instance</span> <span class=\"n\">for</span>\n<span class=\"n\">i</span> <span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">inst_1</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_lt</span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">nat</span> <span class=\"err\">?</span><span class=\"n\">m_1</span> <span class=\"n\">i</span> <span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"err\">⊢</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_lt</span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">nat</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">has_lt</span> <span class=\"n\">i</span> <span class=\"n\">n</span><span class=\"o\">)</span>\n</code></pre></div>\n\n\n<p>And here is the <code>by exact</code> trick that works:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kn\">inductive</span> <span class=\"n\">not_failing</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span> <span class=\"n\">mk</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"bp\">&lt;</span> <span class=\"n\">n</span><span class=\"o\">)],</span> <span class=\"o\">(</span><span class=\"k\">by</span> <span class=\"n\">exact</span> <span class=\"n\">my_predicate</span> <span class=\"n\">n</span> <span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">incl</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">failing</span>\n</code></pre></div>",
        "id": 204777124,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1595497077
    },
    {
        "content": "<p>Oh, that's interesting. Is this a side-effect of trying to solve type-class inference problems from right-to-left?</p>\n<p>Thanks for investigating! Knowing the problem will make it a lot easier to work around the problem.</p>",
        "id": 204814206,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1595518836
    },
    {
        "content": "<p>This is a bug in the elaborator in the case that the local instances are not frozen.  It thinks that an instance is ready to be synthesized if it does not contain metavariables.  And indeed, <code>fact (i &lt; n)</code> doesn't contain metavariables so it is synthesized and fails.</p>",
        "id": 204814880,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1595519210
    }
]