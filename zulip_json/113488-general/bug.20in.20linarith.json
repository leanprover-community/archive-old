[
    {
        "content": "<p>While writing tests for the port of <code>linarith</code> to Lean 4, I think I've encountered a bug in the implementation of Fourier-Motzkin elimination in Lean 3, but haven't yet identified what is wrong.</p>\n<p>Here's the evidence:</p>\n<p>If you add</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">mathlib3ex</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">comp</span> <span class=\"o\">:=</span>\n<span class=\"o\">[</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">2</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">4</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">5</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">6</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">4</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">7</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">8</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">9</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">8</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">10</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">11</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">6</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.lt</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.lt</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">11</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">10</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">9</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"o\">,</span> <span class=\"mi\">3</span><span class=\"o\">)]⟩</span>\n<span class=\"o\">]</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">mathlib4ex</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">comp</span> <span class=\"o\">:=</span>\n<span class=\"o\">[</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">5</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">6</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">7</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">9</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">8</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">9</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">4</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">9</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">8</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">4</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">10</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">9</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">6</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">4</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">10</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">9</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">11</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">11</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">9</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.lt</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.lt</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">4</span><span class=\"o\">,</span> <span class=\"mi\">3</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩</span>\n<span class=\"o\">]</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">fourier_motzkin.produce_certificate</span> <span class=\"n\">mathlib3ex</span> <span class=\"mi\">11</span> <span class=\"c1\">-- succeeds, i.e. found a contradiction</span>\n<span class=\"k\">#eval</span> <span class=\"n\">fourier_motzkin.produce_certificate</span> <span class=\"n\">mathlib4ex</span> <span class=\"mi\">11</span> <span class=\"c1\">-- fails, i.e. no contradiction found</span>\n</code></pre></div>\n<p>to the bottom of <code>src/tactic/linarith/elimination.lean</code> (this is in mathlib3), you'll see that we find a contradiction from the first set of inequalities, but not from the second.</p>\n<p>(This is available in the <a href=\"https://github.com/leanprover-community/mathlib/tree/linarith_bug\">branch#linarith_bug</a>.)</p>\n<p>However these sets of inequalities are the same, up to renaming variables (and then re-sorting the linear expressions so the terms are in descending order again), and hence should be equisatisfiable!</p>\n<p>In <code>pcomp.maybe_minimal</code> there is an implementation of <a href=\"https://en.wikipedia.org/wiki/Fourier%E2%80%93Motzkin_elimination#Imbert's_acceleration_theorems\">Imbert's first theorem</a>. If we remove this check we successfully find a contradiction in both cases, leading me to suspect that this check has been mis-implemented, but so far I don't see what could be wrong.</p>\n<p>(I encountered this problem in the mathlib4 implementation, which is meant to be identical except that for unimportant reasons the variable orders are different; a test was failing that succeeded in mathlib3, and I could minimise to this.)</p>\n<p>If anyone, e.g. <span class=\"user-mention\" data-user-id=\"110596\">@Rob Lewis</span> (who implemented <code>linarith</code> in the first place!) or <span class=\"user-mention\" data-user-id=\"110032\">@Reid Barton</span> (who I recall has an implementation of FM elsewhere) has any ideas about what's going on here, that would be very helpful.</p>",
        "id": 307452373,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667366552
    },
    {
        "content": "<p>Does that mean that the test in mathlib3 that was succeeding is actually incorrect?</p>",
        "id": 307453796,
        "sender_full_name": "Reid Barton",
        "timestamp": 1667367571
    },
    {
        "content": "<p>What is the contradiction that was found? Is it actually a contradiction?</p>",
        "id": 307454450,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667368083
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">#eval</span> <span class=\"k\">do</span>\n  <span class=\"n\">coeff</span> <span class=\"bp\">←</span> <span class=\"n\">fourier_motzkin.produce_certificate</span> <span class=\"n\">mathlib3ex</span> <span class=\"mi\">11</span><span class=\"o\">,</span>\n  <span class=\"n\">tactic.trace</span> <span class=\"n\">coeff.to_list</span>\n<span class=\"c1\">-- [(11, 1), (9, 1), (8, 1), (7, 1), (6, 1), (5, 1), (4, 1), (3, 1), (2, 1), (1, 1), (0, 1)]</span>\n</code></pre></div>",
        "id": 307454785,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667368299
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">mathlib3ex</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">comp</span> <span class=\"o\">:=</span>\n<span class=\"o\">[</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">2</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">4</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">5</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">6</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">4</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">7</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">8</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">9</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">8</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">10</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">11</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">6</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n<span class=\"o\">⟨</span><span class=\"n\">ineq.lt</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">11</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">10</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">9</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"o\">,</span> <span class=\"mi\">3</span><span class=\"o\">)]⟩</span>\n<span class=\"o\">]</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">tactic.trace</span> <span class=\"o\">(</span><span class=\"n\">mathlib3ex.foldl</span> <span class=\"n\">comp.add</span> <span class=\"o\">⟨</span><span class=\"n\">ineq.eq</span><span class=\"o\">,</span> <span class=\"o\">[]⟩)</span>\n<span class=\"c1\">-- []&lt;0</span>\n</code></pre></div>\n<p>The contradiction seems to be correct</p>",
        "id": 307455201,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667368646
    },
    {
        "content": "<p>Here's a minimization of the example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">mathlib4ex</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">comp</span> <span class=\"o\">:=</span>\n<span class=\"o\">[⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n <span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n <span class=\"o\">⟨</span><span class=\"n\">ineq.le</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)]⟩,</span>\n <span class=\"o\">⟨</span><span class=\"n\">ineq.lt</span><span class=\"o\">,</span> <span class=\"o\">[(</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">,</span> <span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">)]⟩]</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">fourier_motzkin.produce_certificate</span> <span class=\"o\">(</span><span class=\"n\">mathlib4ex.map</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"o\">⟨</span><span class=\"n\">x.1</span><span class=\"o\">,</span> <span class=\"n\">list.merge_sort</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">,</span> <span class=\"n\">a.1</span> <span class=\"bp\">&gt;</span> <span class=\"n\">b.1</span><span class=\"o\">)</span> <span class=\"n\">x.2</span><span class=\"o\">⟩))</span> <span class=\"mi\">3</span>\n</code></pre></div>\n<p>changing <code>3</code> to <code>0</code>, or rearranging any of the coefficients (preserving the sum) makes the failure go away</p>",
        "id": 307457377,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667370377
    },
    {
        "content": "<p>Okay, here's an explanation of what happens in the code. We start out with the initial equations E0, ..., E3:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">step</span> <span class=\"mi\">0</span><span class=\"o\">:</span>\n<span class=\"n\">E0</span><span class=\"o\">:</span> <span class=\"bp\">-</span><span class=\"n\">x2</span> <span class=\"bp\">&lt;=</span> <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">history</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">E0</span><span class=\"o\">},</span> <span class=\"n\">explicit</span> <span class=\"bp\">=</span> <span class=\"o\">{},</span> <span class=\"n\">implicit</span> <span class=\"bp\">=</span> <span class=\"o\">{}</span>\n<span class=\"n\">E1</span><span class=\"o\">:</span> <span class=\"n\">x2</span> <span class=\"bp\">-</span> <span class=\"n\">x0</span> <span class=\"bp\">&lt;=</span> <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">history</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">E1</span><span class=\"o\">},</span> <span class=\"n\">explicit</span> <span class=\"bp\">=</span> <span class=\"o\">{},</span> <span class=\"n\">implicit</span> <span class=\"bp\">=</span> <span class=\"o\">{}</span>\n<span class=\"n\">E2</span><span class=\"o\">:</span> <span class=\"bp\">-</span><span class=\"n\">x2</span> <span class=\"bp\">+</span> <span class=\"n\">x1</span> <span class=\"bp\">&lt;=</span> <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">history</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">E2</span><span class=\"o\">},</span> <span class=\"n\">explicit</span> <span class=\"bp\">=</span> <span class=\"o\">{},</span> <span class=\"n\">implicit</span> <span class=\"bp\">=</span> <span class=\"o\">{}</span>\n<span class=\"n\">E3</span><span class=\"o\">:</span> <span class=\"n\">x2</span> <span class=\"bp\">-</span> <span class=\"n\">x1</span> <span class=\"bp\">+</span> <span class=\"n\">x0</span> <span class=\"bp\">&lt;</span> <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">history</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">E3</span><span class=\"o\">},</span> <span class=\"n\">explicit</span> <span class=\"bp\">=</span> <span class=\"o\">{},</span> <span class=\"n\">implicit</span> <span class=\"bp\">=</span> <span class=\"o\">{}</span>\n</code></pre></div>\n<p>We eliminate <code>x2</code> by adding E0 + E1 and E2 + E3 (and also two others that won't matter):</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">step</span> <span class=\"mi\">1</span><span class=\"o\">:</span>\n<span class=\"n\">E01</span> <span class=\"bp\">=</span> <span class=\"n\">E0</span> <span class=\"bp\">+</span> <span class=\"n\">E1</span><span class=\"o\">:</span> <span class=\"bp\">-</span><span class=\"n\">x0</span> <span class=\"bp\">&lt;=</span> <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">history</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">E0</span><span class=\"o\">,</span> <span class=\"n\">E1</span><span class=\"o\">},</span> <span class=\"n\">explicit</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">x2</span><span class=\"o\">},</span> <span class=\"n\">implicit</span> <span class=\"bp\">=</span> <span class=\"o\">{}</span>\n<span class=\"n\">E23</span> <span class=\"bp\">=</span> <span class=\"n\">E2</span> <span class=\"bp\">+</span> <span class=\"n\">E3</span><span class=\"o\">:</span> <span class=\"n\">x0</span> <span class=\"bp\">&lt;</span> <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">history</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">E2</span><span class=\"o\">,</span> <span class=\"n\">E3</span><span class=\"o\">},</span> <span class=\"n\">explicit</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">x2</span><span class=\"o\">},</span> <span class=\"n\">implicit</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">x1</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>The <code>explicit</code> set indicates that <code>x2</code> was eliminated from each equation \"on purpose\", but <code>x1</code> was also eliminated from <code>E23</code> \"on accident\" and so it shows up in the <code>implicit</code> list for <code>E23</code>.</p>\n<p>We then eliminate <code>x1</code>, which does nothing (except for deleting the extra unnecessary equations) because the equations already don't have <code>x1</code> present.</p>\n<p>We then eliminate <code>x0</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">step</span> <span class=\"mi\">2</span><span class=\"o\">:</span>\n<span class=\"n\">E0123</span> <span class=\"bp\">=</span> <span class=\"n\">E01</span> <span class=\"bp\">+</span> <span class=\"n\">E23</span><span class=\"o\">:</span> <span class=\"mi\">0</span> <span class=\"bp\">&lt;</span> <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">history</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">E0</span><span class=\"o\">,</span> <span class=\"n\">E1</span><span class=\"o\">,</span> <span class=\"n\">E2</span><span class=\"o\">,</span> <span class=\"n\">E3</span><span class=\"o\">},</span> <span class=\"n\">explicit</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">x0</span><span class=\"o\">,</span> <span class=\"n\">x2</span><span class=\"o\">},</span> <span class=\"n\">implicit</span> <span class=\"bp\">=</span> <span class=\"o\">{}</span>\n</code></pre></div>\n<p><code>x0</code> has been added to the <code>explicit</code> list because this is a new equation constructed by elimination of <code>x0</code>. <code>x1</code> is <em>not</em> in the implicit list because neither <code>E01</code> nor <code>E23</code> contains an occurrence of <code>x1</code>. </p>\n<p>We apply the theorem now and conclude that since <code>|history| = 4 &gt; 3 = |explicit ∪ implicit| + 1</code>, the newly generated equation <code>E0123</code> is redundant, so we discard it and get a consistent state, leading to failure of the algorithm.</p>",
        "id": 307469005,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667376028
    },
    {
        "content": "<p>Here's a standalone test case:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"n\">c</span> <span class=\"n\">z</span> <span class=\"o\">:</span> <span class=\"n\">ℚ</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">_</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">≤</span> <span class=\"n\">z</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">E0</span> <span class=\"o\">:</span> <span class=\"n\">b</span> <span class=\"bp\">≤</span> <span class=\"n\">c</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">E1</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">≤</span> <span class=\"n\">a</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">E2</span> <span class=\"o\">:</span> <span class=\"mi\">0</span> <span class=\"bp\">≤</span> <span class=\"n\">c</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">b</span> <span class=\"bp\">≤</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"n\">c</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">linarith</span> <span class=\"c1\">-- fail</span>\n</code></pre></div>",
        "id": 307472925,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667377953
    },
    {
        "content": "<p>Thanks for the minimization! So... the conclusion we've reached here is that either</p>\n<ol>\n<li>our interpretation (i.e. as implemented in mathlib3) of the theorem must be incorrect, because it is incorrect to discard E01234, or</li>\n<li>our interpretation is correct and the theorem is false?</li>\n</ol>",
        "id": 307484788,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667382407
    },
    {
        "content": "<p>I think the implementation of the theorem is incorrect in the interpretation of <code>x1</code> as not being an implicitly eliminated variable of <code>E0123</code>. Wikipedia says that it should include all variables from equations in the history which are not in the explicit list, and <code>x1</code> is in <code>E2</code> which is in the history of <code>E0123</code>. I think the fix is to union the <code>vars</code> fields when you merge equations instead of recalculating it from the combined equation.</p>",
        "id": 307485447,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667382659
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib/pull/17307\">#17307</a></p>",
        "id": 307488191,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667383585
    },
    {
        "content": "<p>Actually, I better rewrite some doc-strings.</p>",
        "id": 307490080,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667384208
    },
    {
        "content": "<p>Okay, I've updated the doc-strings.</p>\n<p>However over on the mathlib4 side, while this fix does fix the failure I initially reported in this thread, it doesn't appear to fix the failure I originally identified (and semi-minimised to put in this thread). So perhaps let's not hurry to merge this fix until I have that sorted out too.</p>",
        "id": 307491916,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667384872
    },
    {
        "content": "<p>Thank you so much Scott and Mario for this work. There's one thing I'm confused about -- if the lean 3 implementation has a bug then why is the output of the lean 3 test not incorrect?</p>",
        "id": 307505600,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1667389998
    },
    {
        "content": "<p>What do you mean by \"incorrect\"? It doesn't output anything incorrect but rather thinks it can't solve cases that should be able to.</p>",
        "id": 307523338,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1667395967
    },
    {
        "content": "<p>I wonder how many proofs could be golfed now because of this bugfix...</p>",
        "id": 307528887,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1667397506
    },
    {
        "content": "<p>I'm still seeing problems in the mathlib4 implementation (i.e. cases where linarith fails, but should succeed), but where if I ask it to reject fewer constraints according to Imbert's theorem, it succeeds. This suggests I still have the implementation of Imbert's theorem incorrect. :-(</p>",
        "id": 307652690,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667447275
    },
    {
        "content": "<p>Does someone have access to <a href=\"https://doi.org/10.1016/B978-0-444-88771-9.50019-2\">https://doi.org/10.1016/B978-0-444-88771-9.50019-2</a>, and could send me a copy?</p>",
        "id": 307652739,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667447288
    },
    {
        "content": "<p>I think I'd prefer to read it at the source than try to parse too many masters theses trying to restate the result. :-)</p>",
        "id": 307652762,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667447318
    },
    {
        "content": "<p>Or if someone wants to compare the wikipedia description and the implementation, you can look either in <a href=\"https://github.com/leanprover-community/mathlib/pull/17307\">#17307</a>, or <a href=\"https://github.com/leanprover-community/mathlib4/pull/526\">mathlib4#526</a>. The mathlib4 PR has the advantage that it has a failing test, that succeeds if you change the <code>1 + </code> in <code>maybeMinimal</code> to <code>2 + </code>, so can be used to test alternative interpretations...</p>",
        "id": 307653007,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667447574
    },
    {
        "content": "<p>Okay, I think I have this sorted out.</p>\n<p>Sadly, the performance of Fourier-Motzkin elimination in larger examples is highly sensitive to the variable/equation ordering, and it's easy to have things either work fine or crash by adding and removing <code>.reverse</code>...</p>",
        "id": 307663367,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667456232
    },
    {
        "content": "<p>Okay, I've got this sorted out, and updated the PR.</p>",
        "id": 307666986,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667458939
    },
    {
        "content": "<p>The new interpretation of \"implicitly eliminated variable\" now results in all the tests (including the new one!) working in both mathlib3 and mathlib4, and follows the text of the original paper. (However, it doesn't seem to agree with a formula the original paper uses later, so I left a note for future readers... The original paper also has some confusing typos in a critical example... :-)</p>",
        "id": 307667098,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1667459027
    },
    {
        "content": "<p>Re the typos: clearly the solution to that is to formalise the paper.</p>",
        "id": 307667354,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1667459178
    },
    {
        "content": "<p>I was only able to access the author's later 1993 paper, but I found the description of the theorem and associated algorithm there very unclear and I'm not surprised that it might have been interpreted incorrectly.</p>",
        "id": 307667482,
        "sender_full_name": "Reid Barton",
        "timestamp": 1667459265
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/113488-general/topic/bug.20in.20linarith/near/307667354\">said</a>:</p>\n<blockquote>\n<p>Re the typos: clearly the solution to that is to formalise the paper.</p>\n</blockquote>\n<p>Well if we formalize every math paper that has typos in it, we'd be here forever <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 307683353,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1667466733
    },
    {
        "content": "<p>the ones without typos are also helpful</p>",
        "id": 307683474,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667466800
    },
    {
        "content": "<p>I don't know any papers without typos..</p>",
        "id": 307683526,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1667466833
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110032\">Reid Barton</span> <a href=\"#narrow/stream/113488-general/topic/bug.20in.20linarith/near/307667482\">said</a>:</p>\n<blockquote>\n<p>I was only able to access the author's later 1993 paper, but I found the description of the theorem and associated algorithm there very unclear and I'm not surprised that it might have been interpreted incorrectly.</p>\n</blockquote>\n<p>Maybe you could find a master's student to clarify it in their thesis</p>",
        "id": 307684197,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1667467128
    },
    {
        "content": "<p>The fixed version seems much more likely to timeout than the original; for instance on</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"o\">:</span> <span class=\"n\">ℤ</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"n\">h₁</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">&lt;</span> <span class=\"n\">b</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"n\">ha</span> <span class=\"o\">:</span> <span class=\"mi\">1</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">-</span> <span class=\"mi\">3</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">-</span> <span class=\"mi\">2</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"n\">hb</span> <span class=\"o\">:</span> <span class=\"n\">b</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">-</span> <span class=\"mi\">3</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">-</span> <span class=\"mi\">2</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n  <span class=\"o\">(</span><span class=\"mi\">1</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"n\">b</span> <span class=\"bp\">*</span> <span class=\"n\">b</span><span class=\"o\">)</span> <span class=\"bp\">-</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">=</span> <span class=\"mi\">17</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">nlinarith</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">h₁</span><span class=\"o\">,</span> <span class=\"n\">ha</span><span class=\"o\">,</span> <span class=\"n\">hb</span><span class=\"o\">],</span>\n<span class=\"kd\">end</span>\n</code></pre></div>\n<p>Perhaps it's a coincidence that <code>nlinarith</code> was able to solve this in the first place; but it also seems plausible that we're now stuck in an infinite loop somewhere.</p>",
        "id": 311269121,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1669032374
    },
    {
        "content": "<p>Yes, the bug was causing it to drop constraints, so it's no particular surprise if some big problems now timeout. The cost of correctness. :-)</p>",
        "id": 311730321,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1669160669
    }
]