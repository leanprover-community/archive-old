[
    {
        "content": "<p>Dear all,</p>\n<p>I am very pleased to announce that on WEDNESDAY 12th December, we will have on our pre-christmas compiler social as special guest Sebastian Ulrich who presents:</p>\n<p>\"Towards Lean 4: An Optimized Object Model for an Interactive Theorem Prover\"</p>\n<p>Lean 4, the next version of the Lean theorem prover, will move most of its frontend code from C++ to Lean itself. To ensure that the resulting code is reasonably efficient, Lean 4 will feature a new code generation backend together with a new object and memory management model. In this talk, I will discuss the general and ITP-specific constraints, such as performance, language interoperability, and startup time, that led us to this model and how we are planning to solve them with it.</p>\n<p>Sebastian Ullrich is a second-year PhD student at Gregor Snelting's programming paradigms group at the Karlsruhe Institute of Technology (KIT). He is working on the Lean theorem prover together with Leonardo de Moura (Microsoft Research). Sebastian's research interests are program verification, the design of interactive theorem proving frontends, and macro expansion.</p>\n<p><a href=\"https://www.meetup.com/llvm-compiler-and-code-generation-socials-zurich/events/256742083/\" target=\"_blank\" title=\"https://www.meetup.com/llvm-compiler-and-code-generation-socials-zurich/events/256742083/\">https://www.meetup.com/llvm-compiler-and-code-generation-socials-zurich/events/256742083/</a></p>",
        "id": 148708913,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1543409304
    },
    {
        "content": "<p>It would be awesome if this was recorded for us poor plebians who cannot fly to Europe :)</p>",
        "id": 148709251,
        "sender_full_name": "Andrew Ashworth",
        "timestamp": 1543409691
    },
    {
        "content": "<p>It will (and published if <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> agrees ;-))</p>",
        "id": 148709436,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1543409979
    },
    {
        "content": "<p>Sure thing :)</p>",
        "id": 148711866,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1543412702
    },
    {
        "content": "<p>This is happening this Wednesday! We already have 24 people signed up! Whoever is close by is very much invited.</p>",
        "id": 151234829,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1544386746
    },
    {
        "content": "<p>This is happening tonight.</p>",
        "id": 151506341,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1544596785
    },
    {
        "content": "<p>is there livestreaming?</p>",
        "id": 151511026,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1544604477
    },
    {
        "content": "<p>No.</p>",
        "id": 151512398,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1544606186
    },
    {
        "content": "<p>But there will be a recording.</p>",
        "id": 151512405,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1544606191
    },
    {
        "content": "<p>Any news on when/where the recording is released?</p>",
        "id": 151776778,
        "sender_full_name": "Edward Ayers",
        "timestamp": 1544795469
    },
    {
        "content": "<p>Beginning next week. Still need to recode it.</p>",
        "id": 151803997,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1544820546
    },
    {
        "content": "<p><a href=\"https://www.youtube.com/watch?v=Bv0CXyhbJ5s&amp;feature=youtu.be\" target=\"_blank\" title=\"https://www.youtube.com/watch?v=Bv0CXyhbJ5s&amp;feature=youtu.be\">https://www.youtube.com/watch?v=Bv0CXyhbJ5s&amp;feature=youtu.be</a></p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"Bv0CXyhbJ5s\" href=\"https://www.youtube.com/watch?v=Bv0CXyhbJ5s&amp;feature=youtu.be\" target=\"_blank\" title=\"https://www.youtube.com/watch?v=Bv0CXyhbJ5s&amp;feature=youtu.be\"><img src=\"https://i.ytimg.com/vi/Bv0CXyhbJ5s/default.jpg\"></a></div>",
        "id": 152136573,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1545165678
    },
    {
        "content": "<p>The upload is fresh so it takes another 30min for the HD version to become public.</p>",
        "id": 152136583,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1545165687
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> for this very interesting talk.</p>",
        "id": 152136699,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1545165771
    },
    {
        "content": "<p>I think I understood it very superficially, but it was still interesting and fun to watch.</p>",
        "id": 152141565,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1545170205
    },
    {
        "content": "<p>My 16 year old son explained parts of it to me. Apparently malloc is expensive</p>",
        "id": 152165409,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1545206142
    },
    {
        "content": "<p>nah I can do it for free in my computer</p>",
        "id": 152165417,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1545206161
    },
    {
        "content": "<p>I deduce from this that you're probably not paying the electricity bills</p>",
        "id": 152169287,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1545211164
    },
    {
        "content": "<p>At 44:28, someone in the audiences says \"But it can't be after 2019, because [indecipherable]\" --- does anyone know that that was?</p>",
        "id": 152219193,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1545259761
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> regarding the region <code>mmap</code>ing, I presume if you have ASLR on and thus the heap base is randomized, you would indeed get a very low probability of collision, but with systems that always place the heap at the same address (ASLR off in Linux, etc), you'd get a collision every time? Or you could randomize the addresses by manually <code>mmap</code>ing every new region in the first place, using a well-distributed hash function as a postfix for the region address :D But that would introduce severe memory fragmentation and would probably be a nightmare for cross-platform support.</p>",
        "id": 152221526,
        "sender_full_name": "Wojciech Nawrocki",
        "timestamp": 1545262414
    },
    {
        "content": "<blockquote>\n<p>At 44:28, someone in the audiences says \"But it can't be after 2019, because [indecipherable]\" --- does anyone know that that was?</p>\n</blockquote>\n<p>Because the time line at the beginning says Lean 4 appears in 201X. That's the same remark as always</p>",
        "id": 152224500,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1545266118
    },
    {
        "content": "<p>What do you mean by \"severe memory fragmentation\"?</p>",
        "id": 152239635,
        "sender_full_name": "Keeley Hoek",
        "timestamp": 1545291859
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110111\">@Keeley Hoek</span> if they want to have their regions uniformly distributed across the address space so that the probability of collision is low when directly loading them into memory, they will naturally be all over the place, as opposed to the usual behaviour of the heap which just expands by adding more pages into a contiguous region</p>",
        "id": 152261208,
        "sender_full_name": "Wojciech Nawrocki",
        "timestamp": 1545317687
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"128280\">@Wojciech Nawrocki</span> Ah, I hadn't thought of page table fragmentation before. Not sure if it could become an issue. Anyway, we've thought about collecting all object files of a package into a single big object file. Then you have less fragmentation, even fewer collisions, and more sharing of object graph parts as an added bonus.</p>",
        "id": 152263266,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1545319491
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> Emacs does something <em>kinda</em> similar, so if you're in need of a good horror story, <a href=\"https://lwn.net/Articles/707615/\" target=\"_blank\" title=\"https://lwn.net/Articles/707615/\">here's theirs</a> :D</p>",
        "id": 152265125,
        "sender_full_name": "Wojciech Nawrocki",
        "timestamp": 1545321009
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"128280\">@Wojciech Nawrocki</span> Nice. The \"portable dumper\" proposal indeed sounds quite similar.</p>",
        "id": 152266381,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1545322146
    },
    {
        "content": "<p>I see. Though, so long as the regions are quite a bit larger than 4Kib, shouldn't there be essentially no performance penalty?</p>",
        "id": 152308943,
        "sender_full_name": "Keeley Hoek",
        "timestamp": 1545368350
    },
    {
        "content": "<p>There is a risk of increased TLB misses, I guess.</p>",
        "id": 152319850,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1545386199
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> <a href=\"https://youtu.be/Bv0CXyhbJ5s?t=2307\" target=\"_blank\" title=\"https://youtu.be/Bv0CXyhbJ5s?t=2307\">38:27</a></p>\n<blockquote>\n<p>...and some flags like, does it have a metavariable in there, does it have a parameter. So this is just bookkeeping metadata that we use for optimizations. But the nice thing is that the lean type doesn't have to be this ugly. The lean type just says the const constructor just takes a name and a list of universes, and because all the other data is at the end of the object we can just hide it from lean. So if the compiler tries to access any of these fields it will still use the correct offset.</p>\n</blockquote>\n<p>I was metaphorically shouting \"don't do that\" at my monitor when I heard this. This is how you get irreplicable \"lean magic\" that the compiler does and you (the lean user) can't. I won't insist on changing the way you handle this particular case, but I would much rather you provide the means for users to do the same thing as you are doing in the compiler. In this case, if you wanted to actually write this in lean, the <code>expr</code> type would actually be the full ugly thing with all these fields, but there would be invariants built in (before or after the initial construction) asserting that these metadata fields are correct (i.e. actually track properties they claim to). You write some nice front end constructors like <code>expr.const</code> that automatically populate the metadata fields with the only values they are allowed to have, and a front end recursor that doesn't give you the metadata when you don't care. Then you hook the front end recursor into the equation compiler so that pattern matching is unaffected. (This last part can't currently be done in lean, but this is a nice use case.)</p>\n<p>Working in C++ means that you have the ability to \"cheat\" and hide things from lean. Avoid the temptation, and lean will be better.</p>",
        "id": 152377478,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1545458868
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> These optimizations are completely local to <code>expr.cpp</code>, there isn't a single line in the whole C++ codebase that \"cheats\" around it. You get exactly the same interface from Lean as you get from C++. The fields really are cheap enough to compute in the <code>expr</code> constructors, and for accessing them we should have primitives just like in Lean 3.</p>",
        "id": 152515840,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1545753152
    },
    {
        "content": "<p>I just want lean to get similar kinds of support for being able to define a complicated inner representation and shielding it from outside users as you can do in C++</p>",
        "id": 152517386,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1545756700
    },
    {
        "content": "<p>I'm not really opposed to this practice, besides the fact that this makes it necessary to make expr meta, but it's one place to try dogfooding. I'm sure you will have plenty of other examples in lean 4 that will require you to address this though</p>",
        "id": 152518603,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1545759253
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> and how does this work with second incompleteness?</p>",
        "id": 152538988,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1545804221
    },
    {
        "content": "<p>huh?</p>",
        "id": 152540405,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1545807415
    }
]