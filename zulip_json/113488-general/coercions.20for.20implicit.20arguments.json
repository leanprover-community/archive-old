[
    {
        "content": "<p>Is it possible for coercions to apply to implicit arguments?  I can't get an example like this to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">structure</span> <span class=\"n\">probability_space</span>\n  <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n  <span class=\"o\">(</span><span class=\"n\">α_is_measurable</span><span class=\"o\">:</span> <span class=\"n\">measurable_space</span> <span class=\"n\">α</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"o\">:</span> <span class=\"n\">probability_measure</span> <span class=\"n\">α</span><span class=\"o\">)</span>\n\n<span class=\"kd\">instance</span> <span class=\"n\">prob_space_coe_to_measure_space</span>\n  <span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n  <span class=\"o\">:</span> <span class=\"n\">has_coe</span> <span class=\"o\">(</span><span class=\"n\">probability_space</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">measure_space</span> <span class=\"n\">α</span><span class=\"o\">)</span>\n  <span class=\"o\">:=</span> <span class=\"o\">{</span><span class=\"n\">coe</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">P</span><span class=\"o\">:</span> <span class=\"n\">probability_space</span> <span class=\"n\">α</span><span class=\"o\">,</span>\n    <span class=\"bp\">@</span><span class=\"n\">measure_space.mk</span> <span class=\"n\">α</span> <span class=\"n\">P.α_is_measurable</span> <span class=\"n\">P.μ</span><span class=\"o\">}</span>\n\n<span class=\"kd\">instance</span> <span class=\"n\">prob_space_coe_to_measurable_space</span>\n  <span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n  <span class=\"o\">:</span> <span class=\"n\">has_coe</span> <span class=\"o\">(</span><span class=\"n\">probability_space</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">measurable_space</span> <span class=\"n\">α</span><span class=\"o\">)</span>\n  <span class=\"o\">:=</span> <span class=\"o\">{</span><span class=\"n\">coe</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">P</span><span class=\"o\">:</span> <span class=\"n\">probability_space</span> <span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">P.α_is_measurable</span><span class=\"o\">}</span>\n\n<span class=\"kd\">structure</span> <span class=\"n\">random_variable</span>\n  <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n  <span class=\"o\">[</span><span class=\"n\">α_is_prob_space</span><span class=\"o\">:</span> <span class=\"n\">probability_space</span> <span class=\"n\">α</span><span class=\"o\">]</span>\n  <span class=\"o\">[</span><span class=\"n\">β_is_measurable</span><span class=\"o\">:</span> <span class=\"n\">measurable_space</span> <span class=\"n\">β</span><span class=\"o\">]</span>\n  <span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">β</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n  <span class=\"o\">[</span><span class=\"n\">f_measurable</span><span class=\"o\">:</span> <span class=\"n\">measurable</span> <span class=\"n\">f</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I can get it to work by making the arguments explicit but it is much less readable: <code>@measurable α _ α_is_prob_space _ f</code> </p>\n<p>Lean fails to infer  α in <code>@measurable _ _ α_is_prob_space _ f</code> which was surprising since the constraint always comes from f.</p>",
        "id": 269942989,
        "sender_full_name": "Cotton Seed",
        "timestamp": 1643561582
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"468881\">@Cotton Seed</span>, nice to see you here :)</p>\n<p>Without addressing your question directly, the idiomatic way to express this situation is</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">variables</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">measurable_space</span> <span class=\"n\">α</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Do you want to say a bit about your use case to see whether your setup with structures is needed?</p>",
        "id": 269943579,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1643562195
    },
    {
        "content": "<p>Hey Heather, you too!  Let me update the example with more meaningful names.</p>",
        "id": 269944528,
        "sender_full_name": "Cotton Seed",
        "timestamp": 1643563289
    },
    {
        "content": "<p>I see your motivation.  It would still be conventional not to bundle the space with the variable.  See eg<br>\n<a href=\"https://leanprover-community.github.io/mathlib_docs/find/probability_theory.indep_fun\">docs#probability_theory.indep_fun</a></p>",
        "id": 269944691,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1643563466
    },
    {
        "content": "<p>or <a href=\"https://leanprover-community.github.io/mathlib_docs/find/measure_theory.condexp\">docs#measure_theory.condexp</a></p>",
        "id": 269944752,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1643563551
    },
    {
        "content": "<p>OK, I understand your suggestion.  This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">structure</span> <span class=\"n\">probability_space</span>\n  <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span>\n  <span class=\"o\">[</span><span class=\"n\">α_is_measurable</span><span class=\"o\">:</span> <span class=\"n\">measurable_space</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:=</span>\n  <span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"o\">:</span> <span class=\"n\">probability_measure</span> <span class=\"n\">α</span><span class=\"o\">)</span>\n\n<span class=\"kd\">instance</span> <span class=\"n\">prob_space_coe_to_measure_space</span>\n  <span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n  <span class=\"o\">[</span><span class=\"n\">α_is_measurable</span><span class=\"o\">:</span> <span class=\"n\">measurable_space</span> <span class=\"n\">α</span><span class=\"o\">]</span>\n  <span class=\"o\">:</span> <span class=\"n\">has_coe</span> <span class=\"o\">(</span><span class=\"n\">probability_space</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">measure_space</span> <span class=\"n\">α</span><span class=\"o\">)</span>\n  <span class=\"o\">:=</span> <span class=\"o\">{</span><span class=\"n\">coe</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">P</span><span class=\"o\">:</span> <span class=\"n\">probability_space</span> <span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">measure_space.mk</span> <span class=\"n\">P.μ</span><span class=\"o\">}</span>\n\n<span class=\"kd\">structure</span> <span class=\"n\">random_variable</span>\n  <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n  <span class=\"o\">[</span><span class=\"n\">α_is_measurable</span><span class=\"o\">:</span> <span class=\"n\">measurable_space</span> <span class=\"n\">α</span><span class=\"o\">]</span>\n  <span class=\"o\">[</span><span class=\"n\">α_is_prob_space</span><span class=\"o\">:</span> <span class=\"n\">probability_space</span> <span class=\"n\">α</span><span class=\"o\">]</span>\n  <span class=\"o\">[</span><span class=\"n\">β_is_measurable</span><span class=\"o\">:</span> <span class=\"n\">measurable_space</span> <span class=\"n\">β</span><span class=\"o\">]</span>\n  <span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">β</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n  <span class=\"o\">[</span><span class=\"n\">f_measurable</span><span class=\"o\">:</span> <span class=\"n\">measurable</span> <span class=\"n\">f</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>However, for complicated structures with many implicit dependencies, I was hoping to avoid listing all of them in every use of the structure.</p>",
        "id": 269944811,
        "sender_full_name": "Cotton Seed",
        "timestamp": 1643563594
    },
    {
        "content": "<p>I still seem to be having trouble with implicit arguments [...] inferred by type class resolution.  Here is another simple example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">structure</span> <span class=\"n\">S</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">dummy</span><span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"o\">)</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">S_fun</span> <span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">S</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">α</span><span class=\"o\">):</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span> <span class=\"n\">tt</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">S_id_bad1</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">s</span><span class=\"o\">:</span> <span class=\"n\">S</span> <span class=\"n\">α</span><span class=\"o\">]:</span> <span class=\"n\">S_fun</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"gr\">sorry</span>\n<span class=\"c\">/-</span><span class=\"cm\"></span>\n<span class=\"cm\">  15:5: failed to synthesize type class instance for</span>\n<span class=\"cm\">  α : Type ?,</span>\n<span class=\"cm\">  s : S α</span>\n<span class=\"cm\">  ⊢ S α</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">S_id_bad2</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">s</span><span class=\"o\">:</span> <span class=\"n\">S</span> <span class=\"n\">α</span><span class=\"o\">]:</span> <span class=\"bp\">@</span><span class=\"n\">S_fun</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"gr\">sorry</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">S_id_ok3</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">s</span><span class=\"o\">:</span> <span class=\"n\">S</span> <span class=\"n\">α</span><span class=\"o\">]:</span> <span class=\"bp\">@</span><span class=\"n\">S_fun</span> <span class=\"n\">_</span> <span class=\"n\">s</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Why is <code>s</code> not inferred inside the call to <code>S_fun</code> in the return type of <code>S_id_bad1</code>?  The error shows I have literally the correct term <code>s</code> available.</p>\n<p>I've read the relevant parts of the reference manual but I couldn't find an explanation.  I couldn't find a description of the \"type class resolution\" procedure used to infer [...] arguments.</p>",
        "id": 269950898,
        "sender_full_name": "Cotton Seed",
        "timestamp": 1643570700
    },
    {
        "content": "<p>The <code>S</code> in your code is a structure not a class, so <code>[S \\alpha]</code> won't make sense to the type class system</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span> <span class=\"n\">S</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">dummy</span><span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"o\">)</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">S_fun</span> <span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">S</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">α</span><span class=\"o\">):</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span> <span class=\"n\">tt</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">S_id_bad1</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">S</span> <span class=\"n\">α</span><span class=\"o\">]:</span> <span class=\"n\">S_fun</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"gr\">sorry</span> <span class=\"c1\">-- works fine</span>\n</code></pre></div>",
        "id": 269951041,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1643570858
    },
    {
        "content": "<p>It is normally not necessary to name your class instances by the way; it's quite rare to see <code>[s : S alpha]</code> in mathlib and much more common to see <code>[S alpha]</code>.</p>",
        "id": 269951354,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1643571197
    },
    {
        "content": "<p>A class is just a structure tagged with the <code>@[class]</code> attribute, but this is the attribute that the typeclass system (the square brackets system) is looking out for when it does its hole-filling-in.</p>",
        "id": 269951434,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1643571267
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"468881\">@Cotton Seed</span> This still feels a bit awkward to me, and more context would probably help.  You're perhaps trying to make the type of \"bundled measurable functions\"?  I think we'd usually have the <code>f</code> as a field rather than a parameter.  So something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">variables</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">measurable_space</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">{</span><span class=\"n\">β</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">measurable_space</span> <span class=\"n\">β</span><span class=\"o\">]</span>\n\n<span class=\"kd\">structure</span> <span class=\"n\">random_variable</span> <span class=\"o\">:=</span>\n<span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">β</span><span class=\"o\">)</span>\n<span class=\"o\">(</span><span class=\"n\">f_measurable</span> <span class=\"o\">:</span> <span class=\"n\">measurable</span> <span class=\"n\">f</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 269954224,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1643573756
    },
    {
        "content": "<p>You'll see I dropped every hypothesis, like <code>(μ: probability_measure α)</code> and <code>[probability_space α]</code>, which wasn't actually needed for the definition; this is conventional.</p>",
        "id": 269954336,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1643573813
    },
    {
        "content": "<p>Also:  you don't need to make this bundled definition in order to prove theorems about random variables.  We would usually only make the bundled definition in this way to put further structure on it (like, say <code>β</code> was a group and you wanted to consider the group of measurable functions to <code>β</code>).</p>",
        "id": 269954534,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1643573891
    },
    {
        "content": "<p>Thanks, <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>!  I get it now.  And thanks for the suggestions both of you, I have a lot to experiment with now.</p>",
        "id": 269962489,
        "sender_full_name": "Cotton Seed",
        "timestamp": 1643582660
    }
]