[
    {
        "content": "<p>In the middle of a complicated proof, I have come across a situation where a tactic of the form</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code>    <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">h0</span><span class=\"o\">,</span> <span class=\"n\">h1.symm</span><span class=\"o\">,</span> <span class=\"n\">h2</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>succeeds but </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code>   <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">h0</span><span class=\"o\">,</span> <span class=\"bp\">←</span><span class=\"n\">h1</span><span class=\"o\">,</span> <span class=\"n\">h2</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>fails. All the arguments are explicit equations between elements of a field. The expressions aren't very complicated; they involve <code>+</code>, <code>-</code>, and function application, and as far as I can tell there are no implicit arguments except for the field and <code>has_add</code> and friends.</p>\n<p>I am having a hard time producing a small counterexample. Absurdly, if I use <code>extract_goal</code> to extract a lemma with exactly the same (very large) context, both versions work.</p>\n<p>Using <code>symm</code> is fine as a workaround, but I am curious: has anyone seen something like this before?</p>",
        "id": 243258891,
        "sender_full_name": "Jeremy Avigad",
        "timestamp": 1624122289
    },
    {
        "content": "<p>The two are not exactly equivalent. <code>simp [← thm]</code> should be roughly equivalent to <code>simp [thm.symm, -thm]</code>, but using <code>thm.symm</code> means only one set of metavariables is created so it can only be applied at one substitution. Without more details about the example it's hard to say which of those things is making the difference</p>",
        "id": 243262537,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1624126978
    },
    {
        "content": "<p>Oh, another reason for a difference in the other direction is if <code>h1</code> is an instantiated metavariable then simp might not think it is an equality, but <code>h1.symm</code> is an equality</p>",
        "id": 243262606,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1624127048
    },
    {
        "content": "<p>Aha! The second one explains it. Here's a small example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">lemma</span> <span class=\"n\">this_works</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"n\">c</span> <span class=\"n\">d</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h0</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"n\">b</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h1</span> <span class=\"o\">:</span> <span class=\"n\">b</span> <span class=\"bp\">=</span> <span class=\"n\">c</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h2</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">=</span> <span class=\"n\">d</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"n\">d</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"k\">have</span> <span class=\"n\">h3</span> <span class=\"o\">:</span> <span class=\"n\">b</span> <span class=\"bp\">=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n  <span class=\"o\">{</span> <span class=\"n\">exact</span> <span class=\"n\">eq.trans</span> <span class=\"n\">h1</span> <span class=\"n\">h2</span> <span class=\"o\">},</span>\n  <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">h0</span><span class=\"o\">,</span> <span class=\"n\">h3.symm</span><span class=\"o\">],</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">lemma</span> <span class=\"n\">this_fails</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"n\">c</span> <span class=\"n\">d</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h0</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"n\">b</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h1</span> <span class=\"o\">:</span> <span class=\"n\">b</span> <span class=\"bp\">=</span> <span class=\"n\">c</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h2</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">=</span> <span class=\"n\">d</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"n\">d</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"k\">have</span> <span class=\"n\">h3</span> <span class=\"o\">:</span> <span class=\"n\">b</span> <span class=\"bp\">=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n  <span class=\"o\">{</span> <span class=\"n\">exact</span> <span class=\"n\">eq.trans</span> <span class=\"n\">h1</span> <span class=\"n\">h2</span> <span class=\"o\">},</span>\n  <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">h0</span><span class=\"o\">,</span> <span class=\"bp\">←</span><span class=\"n\">h3</span><span class=\"o\">],</span>\n<span class=\"kd\">end</span>\n</code></pre></div>\n<p>Many thanks for clearing that up. I was really curious as to what was going on. It's good to know that <code>simp</code> doesn't see the instantiations.</p>",
        "id": 243263188,
        "sender_full_name": "Jeremy Avigad",
        "timestamp": 1624127963
    }
]