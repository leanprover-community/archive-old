[
    {
        "content": "<p>Are there any pressing issues with the nix integration? I'm hoping to some day add type checking and dependent types to nix. I wonder if this is something that can be solved by enabling lean to generate nix derivations.</p>",
        "id": 253596575,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631804646
    },
    {
        "content": "<p>Pressing issues of what kind?<br>\nDependent types for Nix sounds like a substantial project :) . Note that there is already an ongoing project developing a gradually-typed language for use with Nix, which I think is a good approach: <a href=\"https://github.com/tweag/nickel\">https://github.com/tweag/nickel</a></p>",
        "id": 253599976,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1631805967
    },
    {
        "content": "<p>Something that could need collaborators or help. I have some nix experience and if there is anything that needs to be done wrt nix I may be able to help. <br>\nI've heard about Nickel and DHall, but I wonder if this is enough. Dependent types adds additional soundness options, but also a lot of complexity. The big problem with nix currently is that it is very hard to debug. I guess Nickel and Flakes solves some of this, but maybe not all.</p>",
        "id": 253617363,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631812800
    },
    {
        "content": "<p>And how does the nix build relate to Lake? Does it use Lake to build Lean?</p>",
        "id": 253629828,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631817661
    },
    {
        "content": "<p>The Nix setup is far older than Lake :) . It uses <code>lean</code> directly, nothing else. Mostly it is written to support my day-to-day workflows; for wider adoption Nix would first need a nicer installation experience (e.g. ship a statically built Nix executable with user-local store, elan-like) and any Windows support at all.</p>",
        "id": 253631004,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1631818128
    },
    {
        "content": "<p>Hm, why do you need a local store? Nix is deterministic so the store is like a hash-space kind of like IPFS (there is an integration underway). Windows support is unlikely unless someone really wants it. I like that nix is not yet-another-build-tool, but more a general framework for any deterministic build. Although it is somewhat opinionated I think this will be less relevant in the long run. I expect there to be made a sort of nix standard spec which allows all sorts of packaging tools to be binary compatible. So nix has the potential to be extremely general to the point that all software could be distributed decentralized with it.<br>\nThe Lake <code>PackageConfig</code> could be compiled into a nix .drv expression which nix could build using lean tools. Then it could recursively build all the remaining components as their own derivations. Mostly like the nix build is already. What is not so nice is to maintain large and complicated nix expressions.</p>",
        "id": 253639087,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631821300
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"433842\">@Anders Christiansen Sørby</span> While that probably would be useful for Unix users, Windows support is key for any general purpose language. Thus, Nix's lack of support for it means it cannot be the de-facto build system of Lean.</p>",
        "id": 253645929,
        "sender_full_name": "Mac",
        "timestamp": 1631824162
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/253639087\">said</a>:</p>\n<blockquote>\n<p>Hm, why do you need a local store?</p>\n</blockquote>\n<p>Because installing a package manager should not (and cannot, on e.g. university machines) require root.</p>\n<blockquote>\n<p>The Lake <code>PackageConfig</code> could be compiled into a nix .drv expression which nix could build using lean tools</p>\n</blockquote>\n<p>Yes, this would be an interesting project. It should be more or less directly mappable to a <code>buildLeanPackage</code> call as long as it doesn't use custom rules, which most likely few packages will. Haskell shows that Nix can be quite successful as a build system even without Windows support as long as it can consume standard package formats.</p>",
        "id": 253656304,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1631828942
    },
    {
        "content": "<p>This should be possible to fix though. Nix is completely isolated from the rest of the system and has all it's own dependencies. The store can be moved anywhere by changing NIX_STORE env var. Root is only needed for a multi-user install. University machines could have it pre-installed as well.<br>\nNix is more of a wrapper than a build system since it always relies on other build systems wrapped inside it's hermetic environment. I think there is no better system for multi system support.<br>\n So to have windows support only a few things needs to be fixed. Cygwin provides a unix like system to build on windows. There has been support for this previously, but it is hard to maintain with little interest. <a href=\"https://discourse.nixos.org/t/dropping-cygwin-support/3425\">https://discourse.nixos.org/t/dropping-cygwin-support/3425</a> Also WSL works fine for nix already which might explain why there is little intrest to work on the Cygwin version. <br>\nIs it really easier to maintain yet another language specific build system with tons of non-reproducible dependencies? It is strange to me that this hasn't been the norm before to have reproducible builds.</p>",
        "id": 253667198,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631835397
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"433842\">@Anders Christiansen Sørby</span> What do you mean by \"tons of non-reproducible dependencies\"? I would say the goal is for Lean builds to reproducible and have very few (and, in most cases, ideally none) external dependencies. So I would hope that most builds <em>are</em> reproducible.</p>",
        "id": 253670552,
        "sender_full_name": "Mac",
        "timestamp": 1631837829
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"433842\">@Anders Christiansen Sørby</span> Believe me, I have already thought very hard about all these questions :) . At Lean Together in January I mentioned that I would love to see Nix as Lean's package manager &amp; version manager &amp; build system &amp; cloud cache at some point in the future. But due to a lack of time on my side and the experimental nature of the used/desired Nix features (flakes are still very much unstable, content-adressed store would be crucial if we get the module system), I'm happy to see Lake provide a more focused solution. But I'm far from giving up on Nix yet. Ideally, installing a (perhaps Lean-flavored) user-local Nix should be no harder than installing elan. <a href=\"https://github.com/DavHau/nix-portable\">nix-portable</a> already comes close.</p>\n<blockquote>\n<p>The store can be moved anywhere by changing NIX_STORE env var.</p>\n</blockquote>\n<p>Which breaks remote caching (substitution). This can be avoided on Linux using user mount namespaces (see also nix-portable) and I believe I even have a solution for Windows (before even having a working Nix on Windows): any Windows user can map a network drive to a local directory, which is then scoped to the user. So we could map <code>N:</code> to <code>$HOME\\AppDataLocal\\Nix</code> or whatever and regain installation-independent paths (however, <code>realpath</code> seems to be able to see through the mapping, so it's a leaky abstraction). Ironically, macOS is the one platform I do not have a solution for here, not Windows.</p>\n<p>Potentially there is a simpler solution where any derivation output that does not even reference <code>/nix/store</code> can be substituted into any store path, but that would need quite some work both on the Nix side and on the individual derivations of interest I believe.</p>\n<blockquote>\n<p>University machines could have it pre-installed as well.</p>\n</blockquote>\n<p>That could be a big ask depending on the university!</p>\n<blockquote>\n<p>Cygwin provides a unix like system to build on windows. There has been support for this previously, but it is hard to maintain with little interest. </p>\n</blockquote>\n<p>Yes, this is the option I'm currently exploring when I find some spare time. In the short term, it sounds much more realistic than the work on a <a href=\"https://discourse.nixos.org/t/nix-on-windows/1113/63\">native Nix for Windows</a> with its on stdenv. However, there is some trouble with segfaults in Boost coroutines or something and I'm not completely convinced yet that the result will be fast enough for practical use, at least without some Windows-specific hacks to avoid some of Cygwin's overhead. If anyone else is interested in exploring that route, help would be very much welcome.</p>",
        "id": 253704695,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1631865429
    },
    {
        "content": "<p>TL;DR, there's three work items I have in mind here</p>\n<ul>\n<li>a Nix function that consumes leanpkg.toml/package.lean and translates it to a <code>buildLeanPackage</code> call</li>\n<li><a href=\"https://github.com/Kha/nale\">a pleasant Nix wrapper</a> that takes care of installation of Nix and uses the former function where appropriate</li>\n<li>whatever the shortest route to Windows support is</li>\n</ul>",
        "id": 253706948,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1631866797
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/253670552\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> What do you mean by \"tons of non-reproducible dependencies\"?</p>\n</blockquote>\n<p>What I mean is that they are not content addressed bottom up which means that a lot of input and breaking changes are not explicitly given as input. So IMO Nix reproducibility is mostly two things:</p>\n<ul>\n<li>A build environment which disallows undeterministic behavior like network access.</li>\n<li>Content addressed dependencies which ensure that you will always get the same binaries for the same build.<br>\nThis is even better in Flakes where strict &amp; pure mode is default.</li>\n</ul>",
        "id": 253719473,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631873567
    },
    {
        "content": "<p>Languages keep making new build systems, but we need something universal and portable. Python has a ton of build tools and it still is a complete mess. Also all of these tools fail to address the version of the compiler and tools which also has a big impact. Then you have stuff like npm and nvm for node or rvm for ruby. This could all be solved universially with nix.</p>",
        "id": 253720822,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631874306
    },
    {
        "content": "<p>If you have those two properties in any build system you are sort of already compatible with nix. <br>\nDisclaimer: I use NixOS for everything and love it.</p>",
        "id": 253722510,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631875284
    },
    {
        "content": "<p>There are some nice options to root permissions here: <a href=\"https://nixos.wiki/wiki/Nix_Installation_Guide\">https://nixos.wiki/wiki/Nix_Installation_Guide</a></p>",
        "id": 253727669,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631878240
    },
    {
        "content": "<p>Yes, that is basically what nix-portable does. But again, not an option on macOS.</p>",
        "id": 253727950,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1631878408
    },
    {
        "content": "<p>I thought nix had excellent macOS support? I've never used it, but shouldn't it be easy to use non-root nix there as well?</p>",
        "id": 253751279,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631889155
    },
    {
        "content": "<p>Haha no, macOS has been a trash fire ever since Apple started clamping down on write access to <code>/</code>. But what can you do without user namespaces or ptrace?</p>",
        "id": 253755178,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1631890578
    },
    {
        "content": "<p>I have a couple of friends who say they're quite successful using nix-darwin I believe? -- <a href=\"https://github.com/LnL7/nix-darwin\">https://github.com/LnL7/nix-darwin</a> (but I haven't myself gotten around to getting back to it, I have enough sustained worry from trying nix too early on in its development that I've still put it off)</p>",
        "id": 253779405,
        "sender_full_name": "Julian Berman",
        "timestamp": 1631900394
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/253720822\">said</a>:</p>\n<blockquote>\n<p>Languages keep making new build systems, but we need something universal and portable. ... Then you have stuff like npm and nvm for node or rvm for ruby.</p>\n</blockquote>\n<p>I suspect the reason why each language keeps inventing its own \"build system\" (while copying ideas from others) is that each language has very different notions of what its \"build system\" needs to do.  In fact, a lot of projects in interpreted languages don't even do any building. Thus, I would talk more generally about their \"management systems\", which can often be split into some major components:</p>\n<ul>\n<li><strong>A toolchain/version manager</strong>:  <code>nvm</code> for Node, <code>phpenv</code> for PHP, <code>rvm</code> for Ruby, <code>venv</code> for Python,  <code>rustup</code> for Rust, <code>stack</code> for Haskell, <code>elan</code> for Lean</li>\n<li><strong>A package manager</strong> :  <code>npm</code>/<code>yarn</code> for Node, <code>composer</code> for PHP,  <code>gem</code> for Ruby,  <code>pip</code>/<code>poetry</code> for Python, <code>cargo</code> for Rust,  <code>cabal</code>/<code>stack</code> for Haskell, <code>leanpkg</code>/<code>lake</code> for Lean, <code>apt</code> for Linux,  <code>brew</code> for MacOS, <code>winget</code>/<code>choco</code>/<code>scoop</code> for Windows, <code>pacman</code> for Arch Linux / Windows MSYS2</li>\n<li><strong>A script manager</strong>: <code>npm</code>/<code>yarn</code> for Node, <code>rake</code> for Ruby,  <code>stack</code> for Haskell, <code>lake</code> for Lean</li>\n<li><strong>A build system</strong>: <code>webpack</code>/<code>gulp</code> for Node/JavaScript, <code>rake</code> for Ruby, <code>setuptools</code> for Python,  <code>cargo</code> for Rust, <code>cabal</code>/<code>stack</code>for Haskell, <code>leanpkg</code>/<code>lake</code> for Lean, <code>cmake</code> for C/C++, <code>make</code>/<code>shake</code>/<code>bazel</code>/<code>nix</code> (hopefully <code>lake</code> eventually) for general builds </li>\n<li><strong>An interactive environment</strong>: <code>node</code> for Node, <code>irb</code> for Ruby, <code>ipython</code>/<code>jupyter</code> for Python, <code>ghci</code> for Haskell, VSCode/Emacs/etc. + the LSP server for Lean</li>\n</ul>\n<p>As you can see, some languages have some of these components and others do not (though newer or long lived languages tend to acquire many  of them). There is also substantial overlap in some cases an not in others. In many cases, there are good reasons for this.</p>\n<p>For example, languages like C and C++ tends to overlap with the system's package manager because they install and use binaries/libraries that are system-specific and may, in turn, be used by the system directly, but interpreted languages often do not because their packages are specific to their language toolchain instead of the ABI of the OS.  Purely compiled languages (e.g., Rust) also don't have scripting systems or interactive environments because there is no such concept. Conversely, having such things is a major boon to interpreted languages like Python and Lean. </p>\n<p>Furthermore, in Lean, there is a strong overlap between the said interactive environment and management system. It is entirely reasonable for the LSP server to potentially ask the system to fetch a remote resource, build a target, extract configuration options and vice versa. Thus the absence of a sandboxed environment (e.g., like bazel's) along nondeterminism in the system is perfectly reasonable in some cases. On the other hand, when simply building a native library or binary for Lean, such things may be desired (which is why such features are so popular in systems designed to do just that). The ability to support both these use cases is why having a Lean-specific system is useful. Such flexibility is also why most other languages  have system, because they have there own requirements on the system.</p>\n<p>On the other hand, if you simply want to inject Lean into a larger multi-layered project, a more general build system (like Nix) may be more desirable for the overarching project. Thus, that is why creating bridges between the two is still something we would like to do.</p>",
        "id": 253782441,
        "sender_full_name": "Mac",
        "timestamp": 1631901630
    },
    {
        "content": "<p>One other thing to consider is that, for Windows users and developers who prefer GUIs over CLIs, you will also want visual interface support for the system, which Nix may also lack.</p>",
        "id": 253783666,
        "sender_full_name": "Mac",
        "timestamp": 1631902096
    },
    {
        "content": "<p>This shouldn't be a problem with using nix. Non-determinism can always be solved by separating the build into pinned inputs and outputs from builds. All of these tools solve very similar problems. I think with all the overlaps it makes sense to have a unified tool. Nix makes essentially zero assumptions about the structure of an underlying build system.</p>",
        "id": 253809697,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631913827
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"433842\">@Anders Christiansen Sørby</span> Sure, any sufficiently general system can be adapted, with effort, to fit a given task. The question is simply whether there is the time and desire to do so.  If want to get Nix functioning as general purpose build system for Lean, feel free to try. </p>\n<p>Personally, when it comes to languages, I would much prefer that all the tools written for the language are, to the greatest possible extent, written in said language, which is why I proposed and built Lake. For these same reasons, nix would thus never be the build tool of choice for someone like me. However, I could certainly see adapting it's approach and the lessons it learned to build systems like Lake in languages like Lean.</p>",
        "id": 253817613,
        "sender_full_name": "Mac",
        "timestamp": 1631918810
    },
    {
        "content": "<p>Actually I agree. Tools for a language should be written in that language, and nix should be able to support that. The nix language is not very nice IMO, but it mostly is a script to generate content addressed .drv files. This can be done by any other language as well. The drv files are then executed by the nix-daemon. I think nix should evolve into a system where you can use your language of choice which implements the nix spec.</p>",
        "id": 253853378,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1631956047
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"433842\">@Anders Christiansen Sørby</span> also, for context, lake stems from the idea to have something like fake (F# make) for lean. The notion of having a core dependency resolving mechanism couple with easy-to-extend written in the same language helper tasks is meant to invite outside contributions.</p>\n<p>The lake community is fairly small and making it easier for the people interested in lean to contribute is an important goal if we want long-term survival of lake.</p>\n<p>When we were discussing whether or not writing a build system was a good idea at all, at least the following points were quite important:</p>\n<ul>\n<li>cross platform; whilst academia is maybe a bit more unix-oriented than the rest of the industry, you most likely still have well over 50% of users use windows. This one disqualifies nix almost entirely.</li>\n<li>few dependencies; we could have used fake for instance. But then we'd need .net core just to build and that felt wrong on quite a few levels. As it stands, lean comes with fairly minimal dependencies.</li>\n<li>extendable; this meant, it would ideally be written in lean or allow for extensions to be written using lean</li>\n<li>cloud build / caching; since in lean a lot of time goes into compilation, having support for efficient rebuilds becomes much more important. And in fact, with mathlib, you really want to cache builds and even avoid building at all on a fresh machine.</li>\n<li>installable without admin access: for universities we don't expect people to have admin access in general which e.g. makes WSL2 problematic.</li>\n</ul>\n<p>Nix would have ticked a few of the boxes, but not others.</p>\n<p>Finally, at least for the time being, we have relatively few packages that are big as opposed to a multitude of small packages like npm. So at least for now, build scripts vs. versioned packages are more important. This obviously may change in future and maybe at some point spitting out a .drv may be a fine option. But that is not something that will happen in a few months.</p>\n<p>In the mean time nix could possibly come up with a solid windows story and or a solid mac story. And then we could reconsider some of the choices we made so far.</p>\n<p>That said, nix is quite old getting close to 20 years and we still don't have a solid cross-platform story or content-addressable storage. Whilst I love nix and nixos, it is a complex beast (building a whole linux distro in a single build script is no small feat) and it doesn't have too much industry support. If some of the big tech companies took a big bet on nix and poured in resources, some of those many year old issues could be addressed much more quickly. As it stands, nix is unfortunately really good at the things it's doing with a community that's focused around nixos and cloud deployment, but not very strong on the cross-platform story. Part of it comes down to nix driving backend services where lack of reproducibility is much more painful than desktops. Another reason, I believe, is that cross-platform support is genuinely hard if you start with nothing and build the whole tool chain from scratch, so there's a lot of work.</p>\n<p>Personally, I wouldn't expect a great cross-platform story for years to come, unfortunately. And that's not a timeframe we would want to target with a build system for lean, if that makes sense.</p>",
        "id": 253933297,
        "sender_full_name": "Daniel Fabian",
        "timestamp": 1632045258
    },
    {
        "content": "<p>Are there any plans to have a tool similar to doc-gen from mathlib integrated with lake? Similar to how e.g. rustdoc is integrated with Cargo in the Rust eco system.</p>",
        "id": 253940300,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1632052849
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> the idea around the design is that any kind of tool like that would ideally be integrated using just a few lines of lean code to define a new <em>task</em>. You'd write a wrapper that wraps the doc-gen and then lake could drive it.</p>\n<p>I don't know if <span class=\"user-mention\" data-user-id=\"315577\">@Mac</span> has it on his radar at the moment, but that's exactly the kind of thing, I think the community could easily provide and upstream if not.</p>",
        "id": 253940778,
        "sender_full_name": "Daniel Fabian",
        "timestamp": 1632053387
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"235513\">@Daniel Fabian</span> What I'm advocating is really just satisfying two properties:</p>\n<ul>\n<li>Content addersed builds and dependencies.</li>\n<li>Deterministic builds.<br>\nSupporting this in Lake shouldn't be too difficult and it would make nix support trivial. Most of the complexity in nix comes from working around that other build systems doesn't support these properties.</li>\n</ul>",
        "id": 253944392,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1632057058
    },
    {
        "content": "<p>yeah, that makes sense. And I think we kind of plan doing it. <span class=\"user-mention\" data-user-id=\"315577\">@Mac</span> has been following the <code>Build systems à la carte</code> paper. The features we wanted IIRC would be equivalent to cloud shake from the paper.</p>",
        "id": 253944741,
        "sender_full_name": "Daniel Fabian",
        "timestamp": 1632057380
    },
    {
        "content": "<p>I think an important feature not typically covered by build systems is the \"workspace\" and \"hermiticity / reproducibility\" concept present in blaze, Bazel, Buck, Pants, Please, gn. Workspaces give you the ability to have multiple projects share the same build infrastructure and hermiticity/reproducibility enforces that you can't call arbitrary shell scripts, system installed binaries, link to system libraries, that have not been declared explicitly. Language specific package managers and build systems often throw up their hands in the air as soon system library dependencies or FFI are involved and packages then resort to brittle (shell) scripts. Pip, cabal, opam all have that issue.</p>",
        "id": 253948139,
        "sender_full_name": "Christian Pehle",
        "timestamp": 1632060965
    },
    {
        "content": "<p>hello, I'm a bit stuck on installing lean 4. I followed all the steps but when I checked to see if the eval command was working, it wasn't and I got this error message \"command 'lean4.displayGoal' not found.\" Is there a fix to this?</p>",
        "id": 253956964,
        "sender_full_name": "One An",
        "timestamp": 1632070117
    },
    {
        "content": "<p>oh wait should i have asked in the new members stream?</p>",
        "id": 253957015,
        "sender_full_name": "One An",
        "timestamp": 1632070188
    },
    {
        "content": "<p>Fittingly, the main author of Shake has recently posted three blog posts reflecting on Shake: <a href=\"https://neilmitchell.blogspot.com/\">https://neilmitchell.blogspot.com/</a> (start with the third one from the top)</p>",
        "id": 253965288,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1632078770
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"235513\">Daniel Fabian</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/253940778\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> the idea around the design is that any kind of tool like that would ideally be integrated using just a few lines of lean code to define a new <em>task</em>. You'd write a wrapper that wraps the doc-gen and then lake could drive it.</p>\n<p>I don't know if <span class=\"user-mention silent\" data-user-id=\"315577\">Mac</span> has it on his radar at the moment, but that's exactly the kind of thing, I think the community could easily provide and upstream if not.</p>\n</blockquote>\n<p>There are two different these would be conceptually done this in Lake. Either it could be implemented as a \"script\" (a concept aped from <code>npm</code>) where you can specify some arbitrary function of type <code>(args : List String) -&gt; IO Unit</code> indexed by a String key than can be executed by Lake via <code>lake run &lt;key&gt; -- [&lt;args&gt;...]</code>. Alternatively you could treat documentation generation as proper build and defined a custom build target for it (though support for running these separately from the package build has not yet been added to Lake).</p>",
        "id": 253977907,
        "sender_full_name": "Mac",
        "timestamp": 1632092411
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> I found the post of \"Forward Build Systems\" interesting, especially so, since I have a counter-intuition about it. Linking/Loading would be the first thing I would think of when talking about  compiling a C program to a binary. I guess my intuition is naturally backwards (i.e., I think of a result and how to get to it -- not first of a source and then how to reach a given destination).</p>\n<p>Though, now that I think about it, the forward/backward approach in build systems has strong parallels between the forward and backward proof styles (represented by tactic and term proofs respectively in Lean). I wonder if their would be some way to adapt how tactics and goals work to a forward build system. Actually, I wonder if one wrote a build target through a <code>by</code> if it would already result in a forward build system?</p>",
        "id": 253978315,
        "sender_full_name": "Mac",
        "timestamp": 1632092832
    },
    {
        "content": "<p>I<br>\n<span class=\"user-mention silent\" data-user-id=\"130511\">Christian Pehle</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/253948139\">said</a>:</p>\n<blockquote>\n<p>I think an important feature not typically covered by build systems is the \"workspace\" and \"hermiticity / reproducibility\" concept present in blaze, Bazel, Buck, Pants, Please, gn. Workspaces give you the ability to have multiple projects share the same build infrastructure and hermiticity/reproducibility enforces that you can't call arbitrary shell scripts, system installed binaries, link to system libraries, that have not been declared explicitly. Language specific package managers and build systems often throw up their hands in the air as soon system library dependencies or FFI are involved and packages then resort to brittle (shell) scripts. Pip, cabal, opam all have that issue.</p>\n</blockquote>\n<p>The concept of \"workspaces\" is on my todo list. For the \"hermiticity/reproducibility\", one of the great things about writing a build system in a functional language is that such things could potentially be resolved by providing a more restrict monad to perform builds in, which I hope Lake will eventually support more fully.</p>",
        "id": 253978521,
        "sender_full_name": "Mac",
        "timestamp": 1632093064
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/253944392\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"235513\">Daniel Fabian</span> What I'm advocating is really just satisfying two properties:</p>\n<ul>\n<li>Content addressed builds and dependencies.</li>\n<li>Deterministic builds.</li>\n</ul>\n<p>Supporting this in Lake shouldn't be too difficult and it would make nix support trivial. Most of the complexity in nix comes from working around that other build systems doesn't support these properties.</p>\n</blockquote>\n<p>As far as I am aware, Lake does support content addressed builds and dependencies. Once <a href=\"https://github.com/leanprover/lean4/pull/659\">#659</a> l lands in production Lean, a Lake basic build will be fully content addressed and deterministic (as the toolchain will be precisely determined by the commit hash of Lean). Only builds that rely on external resources (i.e., libraries/external binaries) will not be. Those however, could still be made content-addressable by converting such resources into targets as well.</p>",
        "id": 253978942,
        "sender_full_name": "Mac",
        "timestamp": 1632093391
    },
    {
        "content": "<p>The <code>zig cc</code> builds look nice, but are they content addressed on the hash of the compiler as well as all input variables and configuration?<br>\nI made a PR where I've added a nix flake to the lake repo btw <a href=\"https://github.com/leanprover/lake/pull/15\">https://github.com/leanprover/lake/pull/15</a> .<br>\nThis way lake can be loaded with <code>nix run github:leanprover/lean</code>.</p>",
        "id": 254609726,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1632433175
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> I'm wondering how to use the buildLeanPackage function for including FFI bindings to c-libraries (compiled/source/shared/static). How would I link arbitrary libraries to a Lean module? It seems for now you need to put a c src file in the same  directory and with the same name as the lean module to be able to compile it using the normal setup. Is it possible to link to an arbitrary c-library  with this setup or do I need to make modifications?</p>",
        "id": 256238613,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1633438120
    },
    {
        "content": "<p>If you compile the C code into a static archive independently from the Lean setup, you should be able to pass it to <code>buildLeanPackage'</code>s <code>linkFlags</code> parameter</p>",
        "id": 256243720,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1633440057
    },
    {
        "content": "<p>That was my plan. Are the linkFlags which are sent to leanc the same as gcc link flags?</p>",
        "id": 256312686,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1633465230
    },
    {
        "content": "<p>Yes, leanc is just a simple wrapper around ccache + clang!</p>",
        "id": 256312850,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1633465320
    },
    {
        "content": "<p><code>nix flake check</code> fails on master because <code>lean-packages</code> does not only contain derivations which is the flakes convention. I think it would be a good idea to follow these flake standards. This is unstable and standardized features though. Do you think it would be worthwhile to fix this setup so that <code>nix flake check</code> runs successfully?</p>",
        "id": 256753878,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1633705635
    },
    {
        "content": "<p>We have many nested derivations such <code>mods</code>, I don't see how to restructure that other than making the root a fake derivation. Nixpkgs has many of these as well, so I'm not sure how this restriction is supposed to work out in practice.</p>",
        "id": 256853003,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1633768843
    },
    {
        "content": "<p>Some exciting development on the \"wrap foreign package managers in Nix\" front btw<br>\n<a href=\"https://github.com/NixOS/rfcs/pull/92#issuecomment-939203270\">https://github.com/NixOS/rfcs/pull/92#issuecomment-939203270</a><br>\n<a href=\"https://github.com/DavHau/dream2nix\">https://github.com/DavHau/dream2nix</a></p>",
        "id": 256853127,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1633768963
    },
    {
        "content": "<p>The nix build <code>buildLeanPackage</code> is broken on the newest lean. I get this error</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">&gt;</span> <span class=\"n\">clang</span><span class=\"bp\">-</span><span class=\"mi\">13</span><span class=\"o\">:</span> <span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">no</span> <span class=\"n\">such</span> <span class=\"n\">file</span> <span class=\"n\">or</span> <span class=\"n\">directory</span><span class=\"o\">:</span> <span class=\"bp\">'/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">491141</span><span class=\"n\">g8sk8rhgs3vxf68nhwr2bg54xm</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">Blake3.c'</span>\n</code></pre></div>",
        "id": 259110472,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635260697
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">$</span> <span class=\"n\">nix</span> <span class=\"n\">flake</span> <span class=\"n\">update</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"n\">updating</span> <span class=\"n\">lock</span> <span class=\"n\">file</span> <span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">sebastian</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">blake3</span><span class=\"bp\">/</span><span class=\"n\">flake.lock'</span><span class=\"o\">:</span>\n<span class=\"bp\">•</span> <span class=\"n\">Updated</span> <span class=\"n\">input</span> <span class=\"bp\">'</span><span class=\"n\">lean'</span><span class=\"o\">:</span>\n    <span class=\"bp\">'</span><span class=\"n\">github</span><span class=\"o\">:</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">a741a3dfd422143a445127af67fa8c5f1f59a892'</span> <span class=\"o\">(</span><span class=\"mi\">2021</span><span class=\"bp\">-</span><span class=\"mi\">10</span><span class=\"bp\">-</span><span class=\"mi\">22</span><span class=\"o\">)</span>\n  <span class=\"bp\">→</span> <span class=\"bp\">'</span><span class=\"n\">github</span><span class=\"o\">:</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"n\">fc0cd0555d517b473aee7460dd150a9cabab797'</span> <span class=\"o\">(</span><span class=\"mi\">2021</span><span class=\"bp\">-</span><span class=\"mi\">10</span><span class=\"bp\">-</span><span class=\"mi\">26</span><span class=\"o\">)</span>\n<span class=\"bp\">$</span> <span class=\"n\">nix</span> <span class=\"n\">build</span> <span class=\"bp\">.#</span><span class=\"n\">tests</span>\n<span class=\"bp\">...</span>\n<span class=\"n\">lean</span><span class=\"o\">:</span> <span class=\"n\">symbol</span> <span class=\"n\">lookup</span> <span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">32</span><span class=\"n\">pxmag2l6rv73sky9pafp0yfadyfgyw</span><span class=\"bp\">-</span><span class=\"n\">Blake3.so</span><span class=\"bp\">/</span><span class=\"n\">Blake3.so</span><span class=\"o\">:</span> <span class=\"n\">undefined</span> <span class=\"n\">symbol</span><span class=\"o\">:</span> <span class=\"n\">blake3_version</span>\n</code></pre></div>",
        "id": 259124756,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635266402
    },
    {
        "content": "<p>It was my changes which caused it. I'd added a <code>-v</code> flag to <code>lean</code></p>",
        "id": 259224868,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635334317
    },
    {
        "content": "<p>Which library contains <code>lean_register_external_class</code> and where do I find it in nix?</p>",
        "id": 259523081,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635513823
    },
    {
        "content": "<p>According to nm it seems to be in <code>~/.elan/toolchains/leanprover--lean4---nightly-2021-10-22/lib/lean/libleanshared.so</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">λ</span> <span class=\"n\">nm</span> <span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">libleanshared.so</span> <span class=\"bp\">|</span> <span class=\"n\">grep</span> <span class=\"n\">lean_register_external_class</span>\n<span class=\"mi\">0000000002836750</span> <span class=\"n\">T</span> <span class=\"n\">lean_register_external_class</span>\n</code></pre></div>\n<p>on elan based installations, no idea about nix though</p>",
        "id": 259524817,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1635514615
    },
    {
        "content": "<p>There is a <code>leanshared</code> attribute</p>",
        "id": 259525271,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635514818
    },
    {
        "content": "<p>Ok, that fixed an issue, but I'm still getting:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">&gt;</span> <span class=\"n\">could</span> <span class=\"n\">not</span> <span class=\"n\">find</span> <span class=\"n\">native</span> <span class=\"n\">implementation</span> <span class=\"n\">of</span> <span class=\"n\">external</span> <span class=\"n\">declaration</span> <span class=\"bp\">'</span><span class=\"n\">Blake3.internalVersion'</span> <span class=\"o\">(</span><span class=\"n\">symbols</span> <span class=\"bp\">'</span><span class=\"n\">l_Blake3_internalVersion___boxed'</span> <span class=\"n\">or</span> <span class=\"bp\">'</span><span class=\"n\">l_Blake3_internalVersion'</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Where exactly does the Lean interpreter look for native symbols when building lean source?</p>",
        "id": 259531441,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635517363
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code>       <span class=\"n\">RTLD_DEFAULT</span>\n              <span class=\"n\">Find</span>  <span class=\"n\">the</span>  <span class=\"n\">first</span>  <span class=\"n\">occurrence</span>  <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">desired</span> <span class=\"n\">symbol</span> <span class=\"n\">using</span> <span class=\"n\">the</span> <span class=\"n\">default</span> <span class=\"n\">shared</span> <span class=\"n\">object</span> <span class=\"n\">search</span> <span class=\"n\">order.</span>\n              <span class=\"n\">The</span> <span class=\"n\">search</span> <span class=\"n\">will</span> <span class=\"kn\">include</span> <span class=\"n\">global</span> <span class=\"n\">symbols</span> <span class=\"k\">in</span> <span class=\"n\">the</span> <span class=\"n\">executable</span> <span class=\"n\">and</span> <span class=\"n\">its</span> <span class=\"n\">dependencies</span><span class=\"o\">,</span> <span class=\"n\">as</span> <span class=\"n\">well</span> <span class=\"n\">as</span> <span class=\"n\">symbols</span>\n              <span class=\"k\">in</span> <span class=\"n\">shared</span> <span class=\"n\">objects</span> <span class=\"n\">that</span> <span class=\"n\">were</span> <span class=\"n\">dynamically</span> <span class=\"n\">loaded</span> <span class=\"k\">with</span> <span class=\"n\">the</span> <span class=\"n\">RTLD_GLOBAL</span> <span class=\"n\">flag.</span>\n</code></pre></div>\n<p>This includes <code>lean</code> and its dependencies as well as any <code>LD_PRELOAD</code> libraries, but not <code>--plugin</code> libraries</p>",
        "id": 259532041,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635517626
    },
    {
        "content": "<p>That is strange because I have included all the dependencies in <code>LD_PRELOAD</code>.<br>\nI guess this code does the lookup?</p>\n<p>```c<br>\nvoid * lookup_symbol_in_cur_exe(char const * sym) {<br>\n#ifdef LEAN_WINDOWS<br>\n    HMODULE hmods[128];  // 128 modules should be enough for everyone<br>\n    DWORD bytes_needed;<br>\n    lean_always_assert(EnumProcessModules(GetCurrentProcess(), hmods, sizeof(hmods), &amp;bytes_needed));<br>\n    for (int i = 0; i &lt; bytes_needed / sizeof(HMODULE); i++) {<br>\n        void * addr = reinterpret_cast&lt;void *&gt;(GetProcAddress(hmods[i], sym));<br>\n        if (addr) {<br>\n            return addr;<br>\n        }<br>\n    }<br>\n    return nullptr;<br>\n#else<br>\n    return dlsym(RTLD_DEFAULT, sym);<br>\n#endif<br>\n}</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code>\n</code></pre></div>",
        "id": 259533586,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635518301
    },
    {
        "content": "<p>A link would be sufficient :) ...</p>",
        "id": 259533759,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635518387
    },
    {
        "content": "<p>I tried adding the lean generated <code>Blake3.so</code> to the <code>LD_PRELOAD</code> and I've now upgraded my linking error into a segfault. What am I doing wrong?</p>",
        "id": 259534995,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635518929
    },
    {
        "content": "<p>That <em>might</em> be progress...? Do you have a stack trace?</p>",
        "id": 259535693,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635519232
    },
    {
        "content": "<p>You might be interested in <a href=\"https://github.com/leanprover/lean4/pull/751\">https://github.com/leanprover/lean4/pull/751</a> btw</p>",
        "id": 259535754,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635519249
    },
    {
        "content": "<p>How do I produce a stack trace from this? </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">&gt;</span> <span class=\"n\">bash</span><span class=\"o\">:</span> <span class=\"n\">line</span> <span class=\"mi\">7</span><span class=\"o\">:</span>     <span class=\"mi\">7</span> <span class=\"n\">Segmentation</span> <span class=\"n\">fault</span>      <span class=\"o\">(</span><span class=\"n\">core</span> <span class=\"n\">dumped</span><span class=\"o\">)</span> <span class=\"n\">lean</span> <span class=\"bp\">-</span><span class=\"n\">o</span> <span class=\"bp\">$</span><span class=\"n\">out</span><span class=\"bp\">/$</span><span class=\"n\">oleanPath</span> <span class=\"bp\">-</span><span class=\"n\">c</span> <span class=\"bp\">$</span><span class=\"n\">c</span><span class=\"bp\">/$</span><span class=\"n\">cPath</span> <span class=\"bp\">$</span><span class=\"n\">leanPath</span> <span class=\"bp\">$</span><span class=\"n\">leanFlags</span> <span class=\"bp\">$</span><span class=\"n\">leanPluginFlags</span>\n</code></pre></div>",
        "id": 259537854,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635520104
    },
    {
        "content": "<p>Is there a way to run the compilation from inside gdb or something?</p>",
        "id": 259537914,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635520134
    },
    {
        "content": "<p>You should be able to run <code>gdb</code> + that command in <code>nix develop</code> as in <a href=\"https://leanprover.github.io/lean4/doc/make/nix.html#other-fun-stuff-to-do-with-nix\">https://leanprover.github.io/lean4/doc/make/nix.html#other-fun-stuff-to-do-with-nix</a>, thought you might need to drop the <code>-o/-c</code> output parameters</p>",
        "id": 259539346,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635520731
    },
    {
        "content": "<p>gdb debugging is not so easy. To use <code>LD_PRELOAD</code> I need to have all the dependencies of lean loaded in that path. This might be what is causing the issue. <code>libleanshared.so</code> is compiled with GLIBC_2.33 which is available on nixpkgs unstable.</p>",
        "id": 259726508,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635594553
    },
    {
        "content": "<p>Yeah, <code>LD_PRELOAD</code> is pretty evil all in all. You could try <a href=\"https://github.com/leanprover/lean4/issues/752\">leanprover/lean4#752</a> instead.</p>",
        "id": 259727632,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635596047
    },
    {
        "content": "<p>But that shouldn't cause a segfault</p>",
        "id": 259727653,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635596092
    },
    {
        "content": "<p>It is good for it's purpose which is to override arbitrary library functions, but it is bad for dealing with entire libraries with lots of dependencies.</p>",
        "id": 259870814,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635777175
    },
    {
        "content": "<p>I tried to use your <code>--load-dynlib</code> setup, but I still get a segfault. Maybe it has something to do with my C shim idk. Any tips on debugging?</p>",
        "id": 260018163,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635869218
    },
    {
        "content": "<p>Do you have a stack trace now?</p>",
        "id": 260062080,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635889549
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"mi\">0</span>  <span class=\"mi\">0x00007ffff53e8baa</span> <span class=\"k\">in</span> <span class=\"n\">raise</span> <span class=\"o\">()</span> <span class=\"k\">from</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">jfn3d7vyj7h0h6lmh510rz31db68l1i</span><span class=\"bp\">-</span><span class=\"n\">glibc</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">33</span><span class=\"bp\">-</span><span class=\"mi\">50</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libc.so.6</span>\n<span class=\"bp\">#</span><span class=\"mi\">1</span>  <span class=\"mi\">0x00007ffff53d3523</span> <span class=\"k\">in</span> <span class=\"n\">abort</span> <span class=\"o\">()</span> <span class=\"k\">from</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">jfn3d7vyj7h0h6lmh510rz31db68l1i</span><span class=\"bp\">-</span><span class=\"n\">glibc</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">33</span><span class=\"bp\">-</span><span class=\"mi\">50</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libc.so.6</span>\n<span class=\"bp\">#</span><span class=\"mi\">2</span>  <span class=\"mi\">0x00007ffff5cf13c9</span> <span class=\"k\">in</span> <span class=\"n\">__gnu_cxx</span><span class=\"o\">::</span><span class=\"n\">__verbose_terminate_handler</span><span class=\"o\">()</span> <span class=\"o\">[</span><span class=\"n\">clone</span> <span class=\"bp\">.</span><span class=\"n\">cold</span><span class=\"o\">]</span> <span class=\"o\">()</span> <span class=\"k\">from</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">di5rqi13gq56w4sai26qpin4i3ikwfhv</span><span class=\"bp\">-</span><span class=\"n\">leanshared</span><span class=\"bp\">/</span><span class=\"n\">libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">3</span>  <span class=\"mi\">0x00007ffff7b1ac26</span> <span class=\"k\">in</span> <span class=\"n\">__cxxabiv1</span><span class=\"o\">::</span><span class=\"n\">__terminate</span><span class=\"o\">(</span><span class=\"n\">void</span> <span class=\"o\">(</span><span class=\"bp\">*</span><span class=\"o\">)())</span> <span class=\"o\">()</span> <span class=\"k\">from</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">di5rqi13gq56w4sai26qpin4i3ikwfhv</span><span class=\"bp\">-</span><span class=\"n\">leanshared</span><span class=\"bp\">/</span><span class=\"n\">libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">4</span>  <span class=\"mi\">0x00007ffff7b1ac91</span> <span class=\"k\">in</span> <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">terminate</span><span class=\"o\">()</span> <span class=\"o\">()</span> <span class=\"k\">from</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">di5rqi13gq56w4sai26qpin4i3ikwfhv</span><span class=\"bp\">-</span><span class=\"n\">leanshared</span><span class=\"bp\">/</span><span class=\"n\">libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">5</span>  <span class=\"mi\">0x00007ffff7b1ade4</span> <span class=\"k\">in</span> <span class=\"n\">__cxa_throw</span> <span class=\"o\">()</span> <span class=\"k\">from</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">di5rqi13gq56w4sai26qpin4i3ikwfhv</span><span class=\"bp\">-</span><span class=\"n\">leanshared</span><span class=\"bp\">/</span><span class=\"n\">libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">6</span>  <span class=\"mi\">0x00007ffff79f343e</span> <span class=\"k\">in</span> <span class=\"n\">load_library</span><span class=\"o\">(</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">__cxx11</span><span class=\"o\">::</span><span class=\"n\">basic_string</span><span class=\"bp\">&lt;</span><span class=\"n\">char</span><span class=\"o\">,</span> <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">char_traits</span><span class=\"bp\">&lt;</span><span class=\"n\">char</span><span class=\"bp\">&gt;</span><span class=\"o\">,</span> <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">allocator</span><span class=\"bp\">&lt;</span><span class=\"n\">char</span><span class=\"bp\">&gt;</span> <span class=\"bp\">&gt;</span><span class=\"o\">)</span> <span class=\"o\">()</span> <span class=\"k\">from</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">di5rqi13gq56w4sai26qpin4i3ikwfhv</span><span class=\"bp\">-</span><span class=\"n\">leanshared</span><span class=\"bp\">/</span><span class=\"n\">libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">7</span>  <span class=\"mi\">0x00007ffff79f46e4</span> <span class=\"k\">in</span> <span class=\"n\">lean_main</span> <span class=\"o\">()</span> <span class=\"k\">from</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">di5rqi13gq56w4sai26qpin4i3ikwfhv</span><span class=\"bp\">-</span><span class=\"n\">leanshared</span><span class=\"bp\">/</span><span class=\"n\">libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">8</span>  <span class=\"mi\">0x00007ffff53d4780</span> <span class=\"k\">in</span> <span class=\"n\">__libc_start_main</span> <span class=\"o\">()</span> <span class=\"k\">from</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">jfn3d7vyj7h0h6lmh510rz31db68l1i</span><span class=\"bp\">-</span><span class=\"n\">glibc</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">33</span><span class=\"bp\">-</span><span class=\"mi\">50</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libc.so.6</span>\n<span class=\"bp\">#</span><span class=\"mi\">9</span>  <span class=\"mi\">0x000000000040106a</span> <span class=\"k\">in</span> <span class=\"n\">_start</span> <span class=\"o\">()</span> <span class=\"n\">at</span> <span class=\"bp\">../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">x86_64</span><span class=\"bp\">/</span><span class=\"n\">start.S</span><span class=\"o\">:</span><span class=\"mi\">120</span>\n</code></pre></div>\n<p>from gdb</p>",
        "id": 260117465,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635937452
    },
    {
        "content": "<p>Hmm, that looks like a regular abort from an uncaught exception to me, not a segfault</p>",
        "id": 260118053,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635937832
    },
    {
        "content": "<p>Maybe I didn't reproduce it properly <br>\nI used this command <code>--load-dynlib=/nix/store/4m6n7rzgnqal7cfcb1lq9vy9m9v4p5wq-libleanblake3.so src/Blake3.lean </code></p>",
        "id": 260118953,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635938374
    },
    {
        "content": "<p>Oh, my bad. I wrote the wrong path</p>",
        "id": 260119185,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635938486
    },
    {
        "content": "<p>From your master I get</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$ nix develop /nix/store/ih1ibncr3wi47rl47756wxk1kd7akj05-Tests.HashString.drv\n&gt; <span class=\"nv\">leanPath</span><span class=\"o\">=</span>Tests/HashString.lean gdb --args lean -o <span class=\"nv\">$out</span>/<span class=\"nv\">$oleanPath</span> -c <span class=\"nv\">$c</span>/<span class=\"nv\">$cPath</span> <span class=\"nv\">$leanPath</span> <span class=\"nv\">$leanFlags</span> <span class=\"nv\">$leanPluginFlags</span> <span class=\"nv\">$leanLoadDynlibFlags</span>\nGNU gdb <span class=\"o\">(</span>GDB<span class=\"o\">)</span> <span class=\"m\">10</span>.2\n...\nReading symbols from lean...\n<span class=\"o\">(</span>gdb<span class=\"o\">)</span> r\nStarting program: /nix/store/2wjddx5f2b3ivh19napvk408br1y8ggs-lean/bin/lean -o /home/sebastian/lean/lean/lean-blake3/outputs/out/Tests/HashString.olean -c /home/sebastian/lean/lean/lean-blake3/outputs/c/Tests/HashString.c Tests/HashString.lean --load-dynlib<span class=\"o\">=</span>/nix/store/ls84fmli14gfjhw7j6wb0d4bylkc269k-Blake3.so/Blake3.so --load-dynlib<span class=\"o\">=</span>/nix/store/dblpwlsrvyh9cp55kx9wkaq8wf73m0zl-libblake3.so/libblake3.so --load-dynlib<span class=\"o\">=</span>/nix/store/kysihyv6mdi58z2yrn7gia4cqp16l3ni-libleanblake3.so/libleanblake3.so --load-dynlib<span class=\"o\">=</span>/nix/store/nzki9k7ragvdjmg8x3zlncfnzdx56s6v-Lean.so/Lean.so --load-dynlib<span class=\"o\">=</span>/nix/store/di5rqi13gq56w4sai26qpin4i3ikwfhv-leanshared/libleanshared.so\n...\nProgram received signal SIGSEGV, Segmentation fault.\n0x00007ffff5dade10 <span class=\"k\">in</span> l_String_isEmpty <span class=\"o\">()</span> from /nix/store/di5rqi13gq56w4sai26qpin4i3ikwfhv-leanshared/libleanshared.so\n<span class=\"o\">(</span>gdb<span class=\"o\">)</span> bt\n<span class=\"c1\">#0  0x00007ffff5dade10 in l_String_isEmpty () from /nix/store/di5rqi13gq56w4sai26qpin4i3ikwfhv-leanshared/libleanshared.so</span>\n<span class=\"c1\">#1  0x00007ffff5da59e3 in l_instReprString___boxed () from /nix/store/di5rqi13gq56w4sai26qpin4i3ikwfhv-leanshared/libleanshared.so</span>\n<span class=\"c1\">#2  0x00007ffff7b001f6 in lean_apply_2 () from /nix/store/di5rqi13gq56w4sai26qpin4i3ikwfhv-leanshared/libleanshared.so</span>\n<span class=\"c1\">#3  0x00007ffff5e62f4c in l_Lean_instEval__1___rarg___boxed () from /nix/store/di5rqi13gq56w4sai26qpin4i3ikwfhv-leanshared/libleanshared.so</span>\n...\n<span class=\"c1\">#59 0x00007ffff64dd119 in lean_run_frontend () from /nix/store/di5rqi13gq56w4sai26qpin4i3ikwfhv-leanshared/libleanshared.so</span>\n<span class=\"c1\">#60 0x00007ffff79f54e9 in lean::run_new_frontend(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, lean::options const&amp;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, lean::name const&amp;) () from /nix/store/di5rqi13gq56w4sai26qpin4i3ikwfhv-leanshared/libleanshared.so</span>\n<span class=\"c1\">#61 0x00007ffff79f7700 in lean_main () from /nix/store/di5rqi13gq56w4sai26qpin4i3ikwfhv-leanshared/libleanshared.so</span>\n<span class=\"c1\">#62 0x00007ffff53d6780 in __libc_start_main () from /nix/store/2jfn3d7vyj7h0h6lmh510rz31db68l1i-glibc-2.33-50/lib/libc.so.6</span>\n<span class=\"c1\">#63 0x000000000040106a in _start () at ../sysdeps/x86_64/start.S:120</span>\n</code></pre></div>",
        "id": 260119807,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635938825
    },
    {
        "content": "<p>Looking at the shared libs, it is worrying that the seem to statically link against Lean:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">$</span> <span class=\"n\">ldd</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">ls84fmli14gfjhw7j6wb0d4bylkc269k</span><span class=\"bp\">-</span><span class=\"n\">Blake3.so</span><span class=\"bp\">/</span><span class=\"n\">Blake3.so</span>\n    <span class=\"n\">linux</span><span class=\"bp\">-</span><span class=\"n\">vdso.so.1</span> <span class=\"o\">(</span><span class=\"mi\">0x00007fff8553d000</span><span class=\"o\">)</span>\n    <span class=\"n\">libgmp.so.10</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fnd1kz8wzv3bj7nwm07yn828vwh0ayfp</span><span class=\"bp\">-</span><span class=\"n\">gmp</span><span class=\"bp\">-</span><span class=\"mi\">6</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libgmp.so.10</span> <span class=\"o\">(</span><span class=\"mi\">0x00007fe599b60000</span><span class=\"o\">)</span>\n    <span class=\"n\">libdl.so.2</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">jfn3d7vyj7h0h6lmh510rz31db68l1i</span><span class=\"bp\">-</span><span class=\"n\">glibc</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">33</span><span class=\"bp\">-</span><span class=\"mi\">50</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libdl.so.2</span> <span class=\"o\">(</span><span class=\"mi\">0x00007fe599b5b000</span><span class=\"o\">)</span>\n    <span class=\"n\">libpthread.so.0</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">jfn3d7vyj7h0h6lmh510rz31db68l1i</span><span class=\"bp\">-</span><span class=\"n\">glibc</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">33</span><span class=\"bp\">-</span><span class=\"mi\">50</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libpthread.so.0</span> <span class=\"o\">(</span><span class=\"mi\">0x00007fe599b3b000</span><span class=\"o\">)</span>\n    <span class=\"n\">libc.so.6</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">jfn3d7vyj7h0h6lmh510rz31db68l1i</span><span class=\"bp\">-</span><span class=\"n\">glibc</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">33</span><span class=\"bp\">-</span><span class=\"mi\">50</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libc.so.6</span> <span class=\"o\">(</span><span class=\"mi\">0x00007fe599976000</span><span class=\"o\">)</span>\n    <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">jfn3d7vyj7h0h6lmh510rz31db68l1i</span><span class=\"bp\">-</span><span class=\"n\">glibc</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">33</span><span class=\"bp\">-</span><span class=\"mi\">50</span><span class=\"bp\">/</span><span class=\"n\">lib64</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"bp\">-</span><span class=\"n\">linux</span><span class=\"bp\">-</span><span class=\"n\">x86</span><span class=\"bp\">-</span><span class=\"mi\">64</span><span class=\"bp\">.</span><span class=\"n\">so.2</span> <span class=\"o\">(</span><span class=\"mi\">0x00007fe599e2b000</span><span class=\"o\">)</span>\n<span class=\"bp\">$</span> <span class=\"n\">nm</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">ls84fmli14gfjhw7j6wb0d4bylkc269k</span><span class=\"bp\">-</span><span class=\"n\">Blake3.so</span><span class=\"bp\">/</span><span class=\"n\">Blake3.so</span> <span class=\"bp\">|</span> <span class=\"n\">grep</span> <span class=\"n\">l_String_isEmpty</span>  <span class=\"bp\">#</span> <span class=\"n\">not</span> <span class=\"n\">the</span> <span class=\"n\">culprit</span> <span class=\"n\">symbol</span><span class=\"o\">,</span> <span class=\"n\">just</span> <span class=\"n\">an</span> <span class=\"kd\">example</span>\n<span class=\"mi\">00000000001165</span><span class=\"n\">d0</span> <span class=\"n\">T</span> <span class=\"n\">l_String_isEmpty</span>\n<span class=\"mi\">00000000001165</span><span class=\"n\">e0</span> <span class=\"n\">T</span> <span class=\"n\">l_String_isEmpty___boxed</span>\n</code></pre></div>\n<p>Duplicate data symbols can lead to issues like this one. This might be an issue with the current <code>buildLeanPackage</code>.</p>",
        "id": 260120374,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635939158
    },
    {
        "content": "<p>Specifically, <code>sharedLib</code> should probably use a dynamic analogue to <code>allStaticLibDeps</code></p>",
        "id": 260120691,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635939362
    },
    {
        "content": "<p>I didn't know I could use <code>nix develop</code> like that. Really neat.<br>\nSo I should remove the static links from the <a href=\"http://Blake3.so\">Blake3.so</a> lib build?</p>",
        "id": 260121047,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635939581
    },
    {
        "content": "<p>Ah, I see you've already tried to link <a href=\"http://Blake3.so\">Blake3.so</a> against <a href=\"http://libleanshared.so\">libleanshared.so</a>. But it doesn't seem to be working.</p>",
        "id": 260121225,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635939720
    },
    {
        "content": "<p>What I find strange about this stack trace is that none of the calls are from any of the imported libraries. Might this be a problem from within the lean ir system itself?</p>",
        "id": 260123929,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635941363
    },
    {
        "content": "<p>It would be great if debugging segfaults was that straightforward. But the bad object is probably from a prior callchain in <a href=\"http://Blake3.so\">Blake3.so</a>.</p>",
        "id": 260124683,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635941733
    },
    {
        "content": "<p>It would be possible to check that with a debug build of Lean and the <code>rr</code> reverse debugger, but <a href=\"http://Blake3.so\">Blake3.so</a> not linking against <a href=\"http://libleanshared.so\">libleanshared.so</a> is definitely a/the problem.</p>",
        "id": 260124831,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635941807
    },
    {
        "content": "<p>I would guess it has something to do with the <code>blake3_version</code> call not returning a valid pointer to the version string.</p>",
        "id": 260128427,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635943678
    },
    {
        "content": "<p>Hm, I tried to replace the call with a string litteral, but no change so hypothesis invalidated i guess?</p>",
        "id": 260129218,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635944109
    },
    {
        "content": "<p>If I comment out the eval the build works fine. Is eval run by the IR interpreter?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">#eval</span> <span class=\"n\">Blake3.version</span>\n<span class=\"k\">#eval</span> <span class=\"o\">(</span><span class=\"n\">hash</span> <span class=\"s2\">\"hello\"</span><span class=\"bp\">.</span><span class=\"n\">toByteArray</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 260129737,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635944355
    },
    {
        "content": "<p>It is</p>",
        "id": 260129786,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635944377
    },
    {
        "content": "<p>So it might work nicer if these calls were from inside a main function?</p>",
        "id": 260130074,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635944453
    },
    {
        "content": "<p>Depending on how it's linked yes</p>",
        "id": 260130705,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635944748
    },
    {
        "content": "<p>Moving it inside main gives this</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">wd0xrfazq2imw3xlh96p0aqf4dp6bvh1</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">cc</span><span class=\"bp\">/</span><span class=\"n\">Blake3.o</span><span class=\"o\">:</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">`</span><span class=\"n\">l_Blake3_internalVersion___boxed'</span><span class=\"o\">:</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">pr0x2fydifarj2x6fb6xg1gl2mnxkdh</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">Blake3.c</span><span class=\"o\">:</span><span class=\"mi\">211</span><span class=\"o\">:</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_version'</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">wd0xrfazq2imw3xlh96p0aqf4dp6bvh1</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">cc</span><span class=\"bp\">/</span><span class=\"n\">Blake3.o</span><span class=\"o\">:</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">`</span><span class=\"n\">l_Blake3_initHasher___boxed'</span><span class=\"o\">:</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">pr0x2fydifarj2x6fb6xg1gl2mnxkdh</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">Blake3.c</span><span class=\"o\">:</span><span class=\"mi\">236</span><span class=\"o\">:</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_initialize'</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">wd0xrfazq2imw3xlh96p0aqf4dp6bvh1</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">cc</span><span class=\"bp\">/</span><span class=\"n\">Blake3.o</span><span class=\"o\">:</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">`</span><span class=\"n\">l_Blake3_hasherUpdate___boxed'</span><span class=\"o\">:</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">pr0x2fydifarj2x6fb6xg1gl2mnxkdh</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">Blake3.c</span><span class=\"o\">:</span><span class=\"mi\">246</span><span class=\"o\">:</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_hasher_update'</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">wd0xrfazq2imw3xlh96p0aqf4dp6bvh1</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">cc</span><span class=\"bp\">/</span><span class=\"n\">Blake3.o</span><span class=\"o\">:</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">`</span><span class=\"n\">l_Blake3_hasherFinalize___boxed'</span><span class=\"o\">:</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">pr0x2fydifarj2x6fb6xg1gl2mnxkdh</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">Blake3.c</span><span class=\"o\">:</span><span class=\"mi\">256</span><span class=\"o\">:</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_hasher_finalize'</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">wd0xrfazq2imw3xlh96p0aqf4dp6bvh1</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">cc</span><span class=\"bp\">/</span><span class=\"n\">Blake3.o</span><span class=\"o\">:</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">`</span><span class=\"n\">l_Blake3_hash'</span><span class=\"o\">:</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">pr0x2fydifarj2x6fb6xg1gl2mnxkdh</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">Blake3.c</span><span class=\"o\">:</span><span class=\"mi\">332</span><span class=\"o\">:</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_hasher_update'</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">pr0x2fydifarj2x6fb6xg1gl2mnxkdh</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">Blake3.c</span><span class=\"o\">:</span><span class=\"mi\">334</span><span class=\"o\">:</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_hasher_finalize'</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">wd0xrfazq2imw3xlh96p0aqf4dp6bvh1</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">cc</span><span class=\"bp\">/</span><span class=\"n\">Blake3.o</span><span class=\"o\">:</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">`</span><span class=\"n\">_init_l_Blake3_version___closed__1'</span><span class=\"o\">:</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">pr0x2fydifarj2x6fb6xg1gl2mnxkdh</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">Blake3.c</span><span class=\"o\">:</span><span class=\"mi\">220</span><span class=\"o\">:</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_version'</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">wd0xrfazq2imw3xlh96p0aqf4dp6bvh1</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">cc</span><span class=\"bp\">/</span><span class=\"n\">Blake3.o</span><span class=\"o\">:</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">`</span><span class=\"n\">_init_l_Blake3_hash___closed__1'</span><span class=\"o\">:</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">pr0x2fydifarj2x6fb6xg1gl2mnxkdh</span><span class=\"bp\">-</span><span class=\"n\">Blake3</span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">Blake3.c</span><span class=\"o\">:</span><span class=\"mi\">274</span><span class=\"o\">:</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_initialize'</span>\n</code></pre></div>",
        "id": 260130726,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635944759
    },
    {
        "content": "<p>I guess <code>--load-dynlib</code> is not enough for this case?</p>",
        "id": 260130829,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635944798
    },
    {
        "content": "<p>It's not, <code>--load-dynlib</code> does not affect compilation at all</p>",
        "id": 260130951,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635944854
    },
    {
        "content": "<p>Ok, I tried adding both as staticLibDeps and got this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">8</span><span class=\"n\">wr1184878xvqqs76kplgljidfi38m1z</span><span class=\"bp\">-</span><span class=\"n\">libleanblake3.a</span><span class=\"bp\">/</span><span class=\"n\">libleanblake3.a</span><span class=\"o\">(</span><span class=\"n\">blake3</span><span class=\"bp\">-</span><span class=\"n\">shim.o</span><span class=\"o\">):</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_initialize'</span><span class=\"o\">:</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"n\">blake3</span><span class=\"bp\">-</span><span class=\"n\">shim.c</span><span class=\"o\">:(</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"bp\">+</span><span class=\"mi\">0xd7</span><span class=\"o\">):</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">blake3_hasher_init'</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">8</span><span class=\"n\">wr1184878xvqqs76kplgljidfi38m1z</span><span class=\"bp\">-</span><span class=\"n\">libleanblake3.a</span><span class=\"bp\">/</span><span class=\"n\">libleanblake3.a</span><span class=\"o\">(</span><span class=\"n\">blake3</span><span class=\"bp\">-</span><span class=\"n\">shim.o</span><span class=\"o\">):</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_hasher_update'</span><span class=\"o\">:</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"n\">blake3</span><span class=\"bp\">-</span><span class=\"n\">shim.c</span><span class=\"o\">:(</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"bp\">+</span><span class=\"mi\">0x211</span><span class=\"o\">):</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">blake3_hasher_update'</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class=\"bp\">-</span><span class=\"n\">binutils</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">35</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">8</span><span class=\"n\">wr1184878xvqqs76kplgljidfi38m1z</span><span class=\"bp\">-</span><span class=\"n\">libleanblake3.a</span><span class=\"bp\">/</span><span class=\"n\">libleanblake3.a</span><span class=\"o\">(</span><span class=\"n\">blake3</span><span class=\"bp\">-</span><span class=\"n\">shim.o</span><span class=\"o\">):</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">`</span><span class=\"n\">lean_blake3_hasher_finalize'</span><span class=\"o\">:</span>\n<span class=\"n\">tests</span><span class=\"bp\">&gt;</span> <span class=\"n\">blake3</span><span class=\"bp\">-</span><span class=\"n\">shim.c</span><span class=\"o\">:(</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"bp\">+</span><span class=\"mi\">0x3ef</span><span class=\"o\">):</span> <span class=\"n\">undefined</span> <span class=\"n\">reference</span> <span class=\"n\">to</span> <span class=\"bp\">`</span><span class=\"n\">blake3_hasher_finalize'</span>\n</code></pre></div>",
        "id": 260131454,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635945104
    },
    {
        "content": "<p>I can't help you without more information, but clearly you're not linking against the library with these symbols</p>",
        "id": 260157977,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1635956117
    },
    {
        "content": "<p>Ok, I'll try some more.</p>",
        "id": 260159242,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1635956662
    },
    {
        "content": "<p>I got it working inside <code>main</code> with proper linking! Though not inside <code>#eval</code> yet.</p>",
        "id": 260411579,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1636122211
    },
    {
        "content": "<p>So I made my edits on the nix build into a PR <a href=\"https://github.com/leanprover/lean4/pull/763\">https://github.com/leanprover/lean4/pull/763</a><br>\nThis adds a way to automatically and recursively link against native shared libs</p>",
        "id": 260991424,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1636552401
    },
    {
        "content": "<p>I wanted to use lake in the beginning, but for me it was very much not plug and play compared to using nix. (I'm using NixOS). <br>\n<span class=\"user-mention\" data-user-id=\"315577\">@Mac</span>  No doubt lake &amp; lean is content addressed for some things like the git hashes.  But this is also dependent on the actual lean binary command and the libraries it was using at the time. So the output should ideally also be hashed. For now lake is more like Cargo or pip which are very sensitive to what kind of input and config given to the tool. Also nix disallows internet access during build which ensures that it is always an <code>input -&gt; output</code> build.  Not that lake isn't a good tool. If possible I would want to ba able to generate drv files from something lake like and push that to the nix build daemon.<br>\n<span class=\"user-mention\" data-user-id=\"110043\">@Gabriel Ebner</span> The nix build _can_ cache between systems and architectures. If not you need to split up the derivation steps or there is some irrelevant input that does not affect the output. Since everything is cached on hash in hash out I think only the last step needs to be done for each architecture (<code>olean -&gt; o</code>).</p>",
        "id": 261915676,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1637235455
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/261915676\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110043\">Gabriel Ebner</span> The nix build _can_ cache between systems and architectures. If not you need to split up the derivation steps or there is some irrelevant input that does not affect the output. Since everything is cached on hash in hash out I think only the last step needs to be done for each architecture (<code>olean -&gt; o</code>).</p>\n</blockquote>\n<p>Forgive my ignorance, but if I understand Nix right, if the olean was generated using build data from a linux x86 then you can't use it on a mac because the build inputs are different, even if the output would be (pinky promise) bit-identical if actually carried out.</p>\n<p>A separate issue is that the output is most likely <em>not</em> bit identical in lean 4, unlike lean 3 where the data to store is mostly platform agnostic (I don't think this was on purpose, but it turned out to be true and really useful). In lean 4 there are memory mapping tricks being done that make the olean files at least endian-dependent and probably also contain local file paths and things of that nature</p>",
        "id": 261916518,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637236097
    },
    {
        "content": "<p>Luckily all architectures that we care about are 64-bit and little-endian (amd64, aarch64, riscv).  As long as we keep all the OS-dependent stuff to C files, we should be fine.</p>",
        "id": 261916866,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1637236346
    },
    {
        "content": "<p>Except for wasm32, that is :)</p>",
        "id": 261916916,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1637236395
    },
    {
        "content": "<p>Even if we wanted to support obscure 32-bit architectures (like wasm), I think it would be easier to write a 64-bit-to-32-bit olean converter than to compile mathlib twice.</p>",
        "id": 261916930,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1637236404
    },
    {
        "content": "<p>maybe I need to dust off the olean parser after all...</p>",
        "id": 261917044,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637236471
    },
    {
        "content": "<p>Feel free to be inspired by <a href=\"https://github.com/gebner/oleanparser\">https://github.com/gebner/oleanparser</a></p>",
        "id": 261917094,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1637236512
    },
    {
        "content": "<p>I see you are two steps ahead of me. Would this work for parsing a non-native olean file?</p>",
        "id": 261917213,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637236601
    },
    {
        "content": "<p>Yes, it can parse 64-bit little-endian oleans on any platform.</p>",
        "id": 261917246,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1637236635
    },
    {
        "content": "<p>Depending on how important this use case will be, I think it would make sense to make Lean a native .olean cross compiler</p>",
        "id": 261917274,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1637236653
    },
    {
        "content": "<p>If we want to support multiple platforms, it would be great to have endianness and bitsize included in the header.</p>",
        "id": 261917289,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1637236664
    },
    {
        "content": "<p>it would be great if olean was, like, an actual format and not \"whatever lean happens to produce today\"</p>",
        "id": 261917375,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637236702
    },
    {
        "content": "<p>I would love to be able to target an external verifier on oleans directly</p>",
        "id": 261917439,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637236755
    },
    {
        "content": "<p>Since oleans are mmapd, they need to have the same object layout as lean.  This means that the format shouldn't be stable (we <em>want</em> to be able to change Lean's object layout if we need to).  But we could put in a version number and have documentation for the current format.</p>",
        "id": 261917571,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1637236811
    },
    {
        "content": "<p>(this goal is not mutually exclusive with having efficient mmap style import, there are plenty of binary formats with ABI compatibility in the linux space)</p>",
        "id": 261917649,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637236849
    },
    {
        "content": "<p>and like you say, a version number can be used to paper over abi breaks</p>",
        "id": 261917704,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637236884
    },
    {
        "content": "<p>Note that all data types used in environment extensions also become part of the olean ABI</p>",
        "id": 261917850,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1637236969
    },
    {
        "content": "<p>you can leave space for extensions</p>",
        "id": 261917864,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637236982
    },
    {
        "content": "<p>as long as <code>Expr</code> can be read, that's probably good enough for a verifier</p>",
        "id": 261917887,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637237006
    },
    {
        "content": "<p>I guess that extensions using extern are not self-describing? Is it possible to know the type layout of such things or do you just have to be prepared for anything?</p>",
        "id": 261918008,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637237096
    },
    {
        "content": "<p>You also want Name and Expr.Data and Environment, etc.  The Lean 4 oleans are really just serialized VM objects.</p>",
        "id": 261918012,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1637237101
    },
    {
        "content": "<p>Do externs have type tags that could at least in principle be used to look them up in a schema?</p>",
        "id": 261918087,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637237150
    },
    {
        "content": "<p>You can read the schema for the relevant part of the olean file here:<br>\n<a href=\"https://github.com/leanprover/lean4/blob/f01a124f187793cdf09788b0cc102eba156b1c60/src/Lean/Environment.lean#L500-L505\">https://github.com/leanprover/lean4/blob/f01a124f187793cdf09788b0cc102eba156b1c60/src/Lean/Environment.lean#L500-L505</a></p>",
        "id": 261918214,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1637237225
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"c\">/-</span><span class=\"cm\"> Content of a .olean file.</span>\n<span class=\"cm\">   We use `compact.cpp` to generate the image of this object in disk. -/</span>\n<span class=\"kd\">structure</span> <span class=\"n\">ModuleData</span> <span class=\"n\">where</span>\n  <span class=\"n\">imports</span>    <span class=\"o\">:</span> <span class=\"n\">Array</span> <span class=\"n\">Import</span>\n  <span class=\"kd\">constants</span>  <span class=\"o\">:</span> <span class=\"n\">Array</span> <span class=\"n\">ConstantInfo</span>\n  <span class=\"n\">entries</span>    <span class=\"o\">:</span> <span class=\"n\">Array</span> <span class=\"o\">(</span><span class=\"n\">Name</span> <span class=\"bp\">×</span> <span class=\"n\">Array</span> <span class=\"n\">EnvExtensionEntry</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 261918224,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1637237234
    },
    {
        "content": "<p>As you can see, there's names for the extensions ^^</p>",
        "id": 261918240,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1637237244
    },
    {
        "content": "<p>That sounds like enough to make it work, although a consistent naming scheme for the extensions has to be coordinated somehow</p>",
        "id": 261918437,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637237387
    },
    {
        "content": "<p>are closures or other code precompiled in oleans?</p>",
        "id": 261918580,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637237468
    },
    {
        "content": "<p>Closures cannot be serialized if you mean that</p>",
        "id": 261921041,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1637239021
    },
    {
        "content": "<p>As to the actual topic title...<br>\n<span class=\"user-mention silent\" data-user-id=\"110043\">Gabriel Ebner</span> <a href=\"#narrow/stream/270676-lean4/topic/lean.204.20hackers/near/261915972\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>one could simply tell Nix \"yeah, this derivation for macOS will definitely be realised into this store path produced by the Linux derivation, just trust me on that\"</p>\n</blockquote>\n<p>I don't think such an option would ever make it past Eelco.  He's already super unhappy about the cargo-vendor stuff (i.e., that we use a fixed-output derivation for the automatically generated vendor directory, instead of checksums for the individual upstream tarballs).  Intentional impurity seems even less likely to be accepted.</p>\n</blockquote>\n<p>If we were to seriously invest in Nix infrastructure and e.g. shipped a custom Nix wrapper, maintaining a (hopefully small and backwards-compatible) fork of Nix would be inevitable I think. But for this hack specifically... all we should need is access to the sqlite DB, it should be doable in a hacky script completely outside of Nix.</p>",
        "id": 261921289,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1637239180
    },
    {
        "content": "<p>I'm mostly thinking of small enhancements like <a href=\"https://github.com/NixOS/nix/pull/5324\">https://github.com/NixOS/nix/pull/5324</a> that might not be as important to upstream as to our use case</p>",
        "id": 261921472,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1637239284
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> If the build depends on system when it is not actually relevant I would call that a bug. For me nix is more of an ideal that has yet to mature properly. I only see benefits from hermetic and content addressed builds. The problem is that the current tooling does not really satisfy these properties. This could be made much more ergonomic and integrated than what nix currently supports, but what nix is already doing is really impressive.<br>\nI've started toying with translating hnix to a Nix.lean which could support interoperability.</p>",
        "id": 261927131,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1637242418
    },
    {
        "content": "<p>How should Nix know/verify that two different binaries for two different platforms using slightly different build scripts are semantically equivalent? You are asking for something that Nix cannot provide within its guarantees. Thus the \"trust me, Nix\" part of the hack.</p>",
        "id": 261927616,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1637242677
    },
    {
        "content": "<p>Well if the build scripts are really different then yes, but why should they be when they are supposed to produce the same output?</p>",
        "id": 261928162,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1637242933
    },
    {
        "content": "<p>I mean the scripts generating the Lean binary. Please see for yourself how many platform-specific branches we have in our CMake files.</p>",
        "id": 261928441,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1637243051
    },
    {
        "content": "<p>This may be really hard and a lot of work, but there should be a way to decompose all the steps of the build in a cachable and minimal inputs way.</p>",
        "id": 261928514,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1637243104
    },
    {
        "content": "<p>But that should only be relevant for the generate native code step. Building mathlib should only need to check the last step if that is even necessary.<br>\n If this is possible I'm going to try doing it.</p>",
        "id": 261928696,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1637243210
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/261915676\">said</a>:</p>\n<blockquote>\n<p>But this is also dependent on the actual lean binary command and the libraries it was using at the time. So the output should ideally also be hashed. For now lake is more like Cargo or pip which are very sensitive to what kind of input and config given to the tool. Also nix disallows internet access during build which ensures that it is always an <code>input -&gt; output</code> build.  Not that lake isn't a good tool. If possible I would want to ba able to generate drv files from something lake like and push that to the nix build daemon.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> has been working very hard on making Lean self-contained. Very soon the githash for Lean should be enough to uniquely determine the Lean binary and the libraries it was using at the time. Thus the whole chain of <code>lean + .lean -&gt; .olean / .c -&gt; .o -&gt; .a / .so / .exe</code> should be content addressed and hash. </p>\n<p>As to your second concern (internet access), I don't think a build system (especially one for Lean) should  be concerned with malicious use (after all, building a Lean file already allows for arbitrary code execution which could potentially cheat even Nix by mucking with its store if it so desired). I think Lake trusting that the build steps work as advertised (i.e., the traces produced do uniquely determine the input -&gt; output) is fine. In fact, a good bit of discussion here is about the problems with not being able to do this with Nix. If you want to prove that such an invariant is truly maintained, well, you can use Lean to do so! <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 261973168,
        "sender_full_name": "Mac",
        "timestamp": 1637261965
    },
    {
        "content": "<p>Hmm, that makes me wonder if Lake could eventually have 0 trust mode that requires proof of <code>input -&gt; output</code> content hash correspondence.</p>",
        "id": 261973426,
        "sender_full_name": "Mac",
        "timestamp": 1637262049
    },
    {
        "content": "<p>a formal statement of that claim is almost certainly false because of hash collision</p>",
        "id": 262002177,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1637275273
    },
    {
        "content": "<p>Proofs need to know the internal structure of functions and types to work so that will definitely fail with external programs like cc, but in theory if everything is written in lean you could design a proof that ensures that a given input will produce output land inside the hash collision equivalence class or something like that.</p>",
        "id": 262068442,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1637330015
    },
    {
        "content": "<p>No internet access is really nice to avoid abusive use like embedded crypto miners and so on which is increasingly becoming a problem. Nix builds are sandboxed which means they have no way of interacting with the outside world except what they have been given as input.<br>\nIf git hashes was enough then every git project ever could be called content addressed.<br>\nThe point is that having a truly plug and play dev environment is what nix tries  to and mostly succeed to  achieve. <br>\nThe compiler and all dependencies that were used to build a particular lean binary is not given by a git hash. This is something nix can ensure since all input is hashed.<br>\nNow nix has its problems no doubt, but in the end I think this is how all software should be built. <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 262070035,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1637330769
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/262070035\">said</a>:</p>\n<blockquote>\n<p>If git hashes was enough then every git project ever could be called content addressed.</p>\n</blockquote>\n<p>Every Git project <em>is</em> content addressed (at least source wise). That is what Git is, a content addressed VCS. The problem that things like Nix try to resolve, though, is that most project <em>builds</em> are not content addressed for two reasons: 1) they use inputs outside the project itself (like system compilers) which are not content addressed 2) many build systems do not produce content addresses of their outputs. </p>\n<p>For Lean projects, the Git hash of Lean uniquely determines the Lean toolchain being used (which now includes the C compiler to build Lean outputs), thus the Git hash works as a content address for the Lean input to Lean project build. That is, Lean Git Hash + Hash of Lean source file uniquely determines (is a content address for) the olean output of the source.</p>",
        "id": 262076004,
        "sender_full_name": "Mac",
        "timestamp": 1637333643
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/262070035\">said</a>:</p>\n<blockquote>\n<p>The compiler and all dependencies that were used to build a particular lean binary is not given by a git hash. This is something nix can ensure since all input is hashed.</p>\n</blockquote>\n<p>I am a bit confused by this statement. Hashes are not reversible, so it is not possible to derive the compiler and all dependencies from any hash. The point of a content addressed hash is simply to uniquely determine the content of said object, which the Git hash is sufficient for the Lean toolchain obtained from elan. When building from source, though, you are right, you need something more.</p>",
        "id": 262077662,
        "sender_full_name": "Mac",
        "timestamp": 1637334305
    },
    {
        "content": "<p>Yes, git is content addressed, and I weren't saying otherwise. But content addressing is more than uniquely determining something although that can be seen as sufficient in some cases.<br>\nThe thing is, as I have tried, when downloading and trying to build a project with lake a lot of things can go wrong. Especially if you are using something not standard like NixOS. I it good to hear that lean is now bundled with all dependencies, but the git hash still does not tell you anything about which configuration flags were used or if it was liked against some library or a fork of something else. In the trivial case it is fine, but as soon as things get more complicated and customized it is not. I have struggled so many times with build issues relating to some undocumented env parameter or system setup needing to be present. What nix does is demanding that _all_ input is accounted for and that the actual build process can not be affected by changing returns from a web service or similar. This is a restriction that conflicts with the design of most builders, but ensures that the build is always deterministic.</p>\n<p>The thing about content addresses outside of hashing is that you can actually look it up as an address. That is why an actual content address of the lean binary is a hash of the actual binary not the git hash that produced it. There are always some details that are not accounted for when you don't .</p>\n<p>A build is a function and that can be content addressed as an AST of whatever build expression is used + a Merkle tree. It only makes sense to call a particular build content addressed when it is fully deterministic. In lake you can do arbitrary IO which essentially means there is no guarantees. Also system architecture has a lot to say. The same git hash does not produce the same output on different architectures.</p>\n<p>My dream scenario would be to have something like lean as a frontend for nix providing end-to-end type checking where possible.</p>",
        "id": 262110494,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1637347474
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/262110494\">said</a>:</p>\n<blockquote>\n<p>A build is a function and that can be content addressed as an AST of whatever build expression is used + a Merkle tree. It only makes sense to call a particular build content addressed when it is fully deterministic.</p>\n</blockquote>\n<p>I understand that you like Nix's approach. My point is that what you described here is merely one form of content addressed builds -- in particular, Nix's approach -- however a build system does not need to do exactly this to be considered content addressed. </p>\n<p>All content addressed storage requires is that content can be fetched by its content address and that addresses are equal if and only if their content is equal (for the content relevant to the store). I can use the Git hash of Lean to uniquely to fetch a particular Lean toolchain (which is more than the shingle binary, by the way) and the same hash will map to the same toolchain if and only if they match. Therefore, it is a valid content address of the toolchain.</p>\n<p>You are right that this does not account for the platform in question. However, Lean oleans are platform agnostic, so the platform should not be considered an input to them (even if it is an input to the compiler that built Lean). This is one problem Nix has (as far as I understand), which is that traces are a Merkel tree of all transitive inputs, even when the direct hash of an intermediate output may be sufficient. Hence why Nix building mathlib is a problem.</p>",
        "id": 262126632,
        "sender_full_name": "Mac",
        "timestamp": 1637354337
    },
    {
        "content": "<p>(If one did want to take the platform into account, mixing Lean's Git hash with the platform descriptor would give a cross-platform trace.)</p>",
        "id": 262127433,
        "sender_full_name": "Mac",
        "timestamp": 1637354806
    },
    {
        "content": "<p>I'm clearly biased as a nix fan, but that is not without a reason. Plug and play dev setups and no config builds are super nice.<br>\nBut what you are describing of mixing more and more hashes of relevant input to correctly input address a lean lake build is just doing what nix already is doing.<br>\nI'm not so sure nix would have a problem caching mathlib correctly. I might set it up to see what happens.</p>",
        "id": 262142882,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1637362853
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/262142882\">said</a>:</p>\n<blockquote>\n<p>I'm clearly biased as a nix fan, but that is not without a reason. Plug and play dev setups and no config builds are super nice.</p>\n</blockquote>\n<p>If all you want is a plug and play dev setup VSCode + elan + lake already provide that. I feel like you clearly want something more than just plug and play.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"433842\">Anders Christiansen Sørby</span> <a href=\"#narrow/stream/270676-lean4/topic/Nix.20builds/near/262142882\">said</a>:</p>\n<blockquote>\n<p>But what you are describing of mixing more and more hashes of relevant input to correctly input address a lean lake build is just doing what nix already is doing.</p>\n</blockquote>\n<p>Yes, but my point was that which hashes you choose to mix is important. Many times you don't want to mix all the hashes of all possible inputs (which, as I understand it, is what Nix does) because the output is more generic than its inputs. Lean is a good example of this, as the oleans it produces are more generic  than the compiler which produces them (i.e., they are cross-platform while the Lean binary is not).</p>",
        "id": 262150359,
        "sender_full_name": "Mac",
        "timestamp": 1637368277
    },
    {
        "content": "<p>So this should obviously be replaced with a little program that uses the Nix API directly in any serious solution, but it <em>is</em> possible to use the content-addressed store to \"build\" .oleans for foreign platforms</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># build on Linux, note derivation hash</span>\n$ nix --store <span class=\"nv\">$PWD</span>/store-linux --extra-experimental-features <span class=\"s1\">'ca-derivations'</span> build .#Init.Prelude.out -vvvv <span class=\"m\">2</span>&gt; &gt;<span class=\"o\">(</span>grep -E <span class=\"s1\">'^(error:|drv output)'</span><span class=\"o\">)</span> --json\ndrv output <span class=\"s1\">'sha256:5510cbd31d1e34ce34cfa48dbb2aa9ab4bff7034155f25a072f658ba94611294!out'</span> is required, but there is no substituter that can provide it\ndrv output <span class=\"s1\">'sha256:41a2bddf2e70c43558ed8e8c559cb116b67861a9183c8b2976febe663e671ae6!out'</span> is required, but there is no substituter that can provide it\ndrv output <span class=\"s1\">'sha256:41a2bddf2e70c43558ed8e8c559cb116b67861a9183c8b2976febe663e671ae6!c'</span> is required, but there is no substituter that can provide it\n<span class=\"o\">[{</span><span class=\"s2\">\"drvPath\"</span>:<span class=\"s2\">\"/nix/store/dj4ngv0s1k544qwxmdzjg7shwcq5qfjm-Init.Prelude.drv\"</span>,<span class=\"s2\">\"outputs\"</span>:<span class=\"o\">{</span><span class=\"s2\">\"out\"</span>:<span class=\"s2\">\"/nix/store/x8s1mk4yfixj3zmj5glnazxalpjzw7gn-Init.Prelude\"</span><span class=\"o\">}}]</span>\n\n<span class=\"c1\"># try to build for macOS, note derivation hash</span>\n$ nix --store <span class=\"nv\">$PWD</span>/store-linux --extra-experimental-features <span class=\"s1\">'ca-derivations'</span> build .#packages.x86_64-darwin.Init.Prelude.out -vvvv <span class=\"m\">2</span>&gt; &gt;<span class=\"o\">(</span>grep -E <span class=\"s1\">'^(error:|drv output)'</span><span class=\"o\">)</span> --json\ndrv output <span class=\"s1\">'sha256:e1b18fc3fb3c4327a0dd8ed462056fd49172bd8b403b37032bb66d4d1a71a260!out'</span> is required, but there is no substituter that can provide it\nerror: a <span class=\"s1\">'x86_64-darwin'</span> with features <span class=\"o\">{}</span> is required to build <span class=\"s1\">'/nix/store/rc7737ppa23biwj7hjazn5a2z4rs5wsk-ccache-links.drv'</span>, but I am a <span class=\"s1\">'x86_64-linux'</span> with features <span class=\"o\">{</span>benchmark, big-parallel, ca-derivations, kvm, nixos-test<span class=\"o\">}</span>\n\n<span class=\"c1\"># map macOS hash to build result of Linux hash</span>\n$ nix shell nixpkgs#sqlite -c sqlite3 store-linux/nix/var/nix/db/db.sqlite <span class=\"s1\">'insert into Realisations (drvPath, outputName, outputPath, signatures) select \"sha256:e1b18fc3fb3c4327a0dd8ed462056fd49172bd8b403b37032bb66d4d1a71a260\" as drvPath, outputName, outputPath, signatures from Realisations as r where r.drvPath = \"sha256:41a2bddf2e70c43558ed8e8c559cb116b67861a9183c8b2976febe663e671ae6\";'</span>\n\n<span class=\"c1\"># macOS now builds successfully!</span>\n$ nix --store <span class=\"nv\">$PWD</span>/store-linux --extra-experimental-features <span class=\"s1\">'ca-derivations'</span> build .#packages.x86_64-darwin.Init.Prelude.out -vvvv <span class=\"m\">2</span>&gt; &gt;<span class=\"o\">(</span>grep -E <span class=\"s1\">'^(error:|drv output)'</span><span class=\"o\">)</span> --json\n<span class=\"o\">[{</span><span class=\"s2\">\"drvPath\"</span>:<span class=\"s2\">\"/nix/store/dsxn7yibv6mqws8annkprln97f2ydbva-Init.Prelude.drv\"</span>,<span class=\"s2\">\"outputs\"</span>:<span class=\"o\">{</span><span class=\"s2\">\"out\"</span>:<span class=\"s2\">\"/nix/store/x8s1mk4yfixj3zmj5glnazxalpjzw7gn-Init.Prelude\"</span><span class=\"o\">}}]</span>\n\n<span class=\"c1\"># while we're at it, demonstrate that content addressing indeed works</span>\n$ <span class=\"nb\">echo</span> <span class=\"s2\">\"-- </span><span class=\"k\">$(</span>date<span class=\"k\">)</span><span class=\"s2\">\"</span> &gt;&gt; src/Init/Prelude.lean\n$ nix --store <span class=\"nv\">$PWD</span>/store-linux --extra-experimental-features <span class=\"s1\">'ca-derivations'</span> build .#Init.Prelude.out -vvvv <span class=\"m\">2</span>&gt; &gt;<span class=\"o\">(</span>grep -E <span class=\"s1\">'^(error:|drv output)'</span><span class=\"o\">)</span> --json\ndrv output <span class=\"s1\">'sha256:bc7911ecd77d575bf6a42d4640f077fd799bdc166942f3246425f135cb8eb00f!out'</span> is required, but there is no substituter that can provide it\ndrv output <span class=\"s1\">'sha256:ec7bbeea22c8a967cc097eb9ca48b36d7be1ca87a40e02ddd694712732b945c4!out'</span> is required, but there is no substituter that can provide it\ndrv output <span class=\"s1\">'sha256:ec7bbeea22c8a967cc097eb9ca48b36d7be1ca87a40e02ddd694712732b945c4!c'</span> is required, but there is no substituter that can provide it\n<span class=\"o\">[{</span><span class=\"s2\">\"drvPath\"</span>:<span class=\"s2\">\"/nix/store/3pnpr0gjyby1mgwpzi9llhfifzvsa7ph-Init.Prelude.drv\"</span>,<span class=\"s2\">\"outputs\"</span>:<span class=\"o\">{</span><span class=\"s2\">\"out\"</span>:<span class=\"s2\">\"/nix/store/x8s1mk4yfixj3zmj5glnazxalpjzw7gn-Init.Prelude\"</span><span class=\"o\">}}]</span>\n</code></pre></div>",
        "id": 262237952,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1637497178
    },
    {
        "content": "<p>Is it hacky? Absolutely. But otherwise this is no different from implicitly assuming that Lean generates identical oleans for different platforms (which we know is not true in the presence of arbitrary metaprograms anyway).</p>",
        "id": 262238115,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1637497433
    },
    {
        "content": "<p>I have some questions about the LSP implementation when using nix. What I have been doing so far is just to hook up the correct lean to PATH with nix develop and run <code>lean --server</code> however I also want to put my lean files in a <code>src</code> or <code>test</code>directory. Is there some config / flag to fix this?<br>\nAlso I get this error that I should open the directory as a workspace (in neovim with coc.nvim and in VSCode). <br>\nWhat could this mean?</p>",
        "id": 262457435,
        "sender_full_name": "Anders Christiansen Sørby",
        "timestamp": 1637675332
    },
    {
        "content": "<p><span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span></p>",
        "id": 317273673,
        "sender_full_name": "cognivore",
        "timestamp": 1671670118
    },
    {
        "content": "<p>I'm trying to run a workflow verbatim (as suggested in <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/stream/270676-lean4/topic/.E2.9C.94.20Easily.20test.20lean4.20patch\">#lean4 &gt; ✔ Easily test lean4 patch</a>), but it fails with nix stack overflow: <a href=\"https://github.com/cognivore/lean4/actions/runs/3753931115/jobs/6377674941\">https://github.com/cognivore/lean4/actions/runs/3753931115/jobs/6377674941</a></p>",
        "id": 317273710,
        "sender_full_name": "cognivore",
        "timestamp": 1671670161
    },
    {
        "content": "<p>Currently, I'm trying to reproduce the commands locally by entering <code>nix shell</code> and will tinker to understand what's going on. In the meantime, I'll have Github build the exact copy of <code>lean4</code>'s main branch under my user.</p>\n<p>If someone understands what's going on or have seen an error like this before, however, please do share your knowledge! It will be highly appreciated <span aria-label=\"bow\" class=\"emoji emoji-1f647\" role=\"img\" title=\"bow\">:bow:</span></p>",
        "id": 317273829,
        "sender_full_name": "cognivore",
        "timestamp": 1671670250
    },
    {
        "content": "<p>(Reproduced at home with my branch)</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">Thu</span> <span class=\"n\">Dec</span> <span class=\"mi\">22</span> <span class=\"mi\">00</span><span class=\"o\">:</span><span class=\"mi\">46</span><span class=\"o\">:</span><span class=\"mi\">34</span><span class=\"o\">:</span><span class=\"mi\">143384200</span> <span class=\"n\">cognivore</span><span class=\"bp\">@</span><span class=\"n\">conflagrate</span> <span class=\"bp\">~/</span><span class=\"n\">github</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">float</span><span class=\"bp\">-</span><span class=\"n\">fork</span> <span class=\"o\">(</span><span class=\"n\">cognivore</span><span class=\"bp\">/</span><span class=\"n\">deopaque</span><span class=\"bp\">-</span><span class=\"n\">ofscientific</span><span class=\"o\">)</span>\n<span class=\"bp\">λ</span> <span class=\"n\">nix</span> <span class=\"n\">shell</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">builder</span> <span class=\"n\">for</span> <span class=\"bp\">'/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">x05m7zq51f7bfzajl464lsxj2y35b5sr</span><span class=\"bp\">-</span><span class=\"n\">Lean.Data.FuzzyMatching.drv'</span> <span class=\"n\">failed</span> <span class=\"k\">with</span> <span class=\"n\">exit</span> <span class=\"n\">code</span> <span class=\"mi\">1</span><span class=\"bp\">;</span>\n       <span class=\"n\">last</span> <span class=\"mi\">1</span> <span class=\"n\">log</span> <span class=\"n\">lines</span><span class=\"o\">:</span>\n       <span class=\"bp\">&gt;</span> <span class=\"n\">deep</span> <span class=\"n\">recursion</span> <span class=\"n\">was</span> <span class=\"n\">detected</span> <span class=\"n\">at</span> <span class=\"bp\">'</span><span class=\"n\">whnf'</span> <span class=\"o\">(</span><span class=\"n\">potential</span> <span class=\"n\">solution</span><span class=\"o\">:</span> <span class=\"n\">increase</span> <span class=\"n\">stack</span> <span class=\"n\">space</span> <span class=\"k\">in</span> <span class=\"n\">your</span> <span class=\"n\">system</span><span class=\"o\">)</span>\n       <span class=\"n\">For</span> <span class=\"n\">full</span> <span class=\"n\">logs</span><span class=\"o\">,</span> <span class=\"n\">run</span> <span class=\"bp\">'</span><span class=\"n\">nix</span> <span class=\"n\">log</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">x05m7zq51f7bfzajl464lsxj2y35b5sr</span><span class=\"bp\">-</span><span class=\"n\">Lean.Data.FuzzyMatching.drv'.</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"mi\">1</span> <span class=\"n\">dependencies</span> <span class=\"n\">of</span> <span class=\"n\">derivation</span> <span class=\"bp\">'/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">qy9pr2jfb3lgflicyv72vf4k3gf6yigp</span><span class=\"bp\">-</span><span class=\"n\">Lean</span><span class=\"bp\">-</span><span class=\"n\">depRoot.drv'</span> <span class=\"n\">failed</span> <span class=\"n\">to</span> <span class=\"n\">build</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"mi\">1</span> <span class=\"n\">dependencies</span> <span class=\"n\">of</span> <span class=\"n\">derivation</span> <span class=\"bp\">'/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">7</span><span class=\"n\">kqdnr2fvkvxx63r2vw8jngzkx60sxd0</span><span class=\"bp\">-</span><span class=\"n\">Lean.Data.FuzzyMatching</span><span class=\"bp\">-</span><span class=\"n\">cc.drv'</span> <span class=\"n\">failed</span> <span class=\"n\">to</span> <span class=\"n\">build</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"mi\">1</span> <span class=\"n\">dependencies</span> <span class=\"n\">of</span> <span class=\"n\">derivation</span> <span class=\"bp\">'/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"n\">yj80f2jrccxwbxbwgwn9n3r4yffyvv1</span><span class=\"bp\">-</span><span class=\"n\">Lean.Server.Completion</span><span class=\"bp\">-</span><span class=\"n\">depRoot.drv'</span> <span class=\"n\">failed</span> <span class=\"n\">to</span> <span class=\"n\">build</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"mi\">1</span> <span class=\"n\">dependencies</span> <span class=\"n\">of</span> <span class=\"n\">derivation</span> <span class=\"bp\">'/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">5</span><span class=\"n\">na9mfb04v33fvf783ks5haa14kmmm3v</span><span class=\"bp\">-</span><span class=\"n\">Lean.Server.Watchdog</span><span class=\"bp\">-</span><span class=\"n\">depRoot.drv'</span> <span class=\"n\">failed</span> <span class=\"n\">to</span> <span class=\"n\">build</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"mi\">1</span> <span class=\"n\">dependencies</span> <span class=\"n\">of</span> <span class=\"n\">derivation</span> <span class=\"bp\">'/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">lf07py4slm4371x8pks996kvvc5i3y65</span><span class=\"bp\">-</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">stage1.drv'</span> <span class=\"n\">failed</span> <span class=\"n\">to</span> <span class=\"n\">build</span>\n</code></pre></div>",
        "id": 317274178,
        "sender_full_name": "cognivore",
        "timestamp": 1671670510
    },
    {
        "content": "<p><a href=\"https://github.com/cognivore/lean4/actions/runs/3754045206\">Carbon copy works!</a>, so I wrote a bug in the patch.</p>\n<p>Now the question is how to learn why is it a bug! When you get a log like this, how do you learn how exactly does the build fail?</p>",
        "id": 317276776,
        "sender_full_name": "cognivore",
        "timestamp": 1671672838
    },
    {
        "content": "<p>I would like to have a <strong>dev shell</strong> without building <code>lean</code> and then manually reproduce the build steps from <code>lean-all</code>.</p>",
        "id": 317276882,
        "sender_full_name": "cognivore",
        "timestamp": 1671672925
    },
    {
        "content": "<p>Try running <code>nix develop</code> instead of <code>nix shell</code>. Running the build steps manually can typically be done by running <code>genericBuild</code> inside the resulting shell, and that can typically be broken into phases depending on the concrete use case.</p>",
        "id": 317277772,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1671673879
    },
    {
        "content": "<p>Ok, thank you!</p>",
        "id": 317277775,
        "sender_full_name": "cognivore",
        "timestamp": 1671673894
    },
    {
        "content": "<p>So just to make clear, you do <em>not</em> have to use Nix if you don't want to! Your first link doesn't work for me, so I'm missing a bit of context (edit: found it).</p>",
        "id": 317339591,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1671707877
    }
]