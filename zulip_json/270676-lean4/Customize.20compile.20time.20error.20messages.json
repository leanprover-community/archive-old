[
    {
        "content": "<p>I'm in need to parse Lean's compiler error messages and was wondering if:</p>\n<ol>\n<li>There is a structured output format such as json or similar besides text.</li>\n<li>Can the output be customized for certain cases. For example I have:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">GTE0</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">Int</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span> <span class=\"n\">n</span> <span class=\"bp\">&gt;=</span> <span class=\"mi\">0</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span> <span class=\"n\">GTE0</span> <span class=\"mi\">6</span> <span class=\"c1\">-- works</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span> <span class=\"n\">GTE0</span> <span class=\"bp\">-</span><span class=\"mi\">1</span>\n<span class=\"c1\">-- failed to synthesize instance</span>\n<span class=\"c1\">--  HSub (Int → Prop) Nat Prop</span>\n</code></pre></div>\n<p>I'd like to get a more meaningful error than the type class isn't resolved. Something like <code>-1 is not gte 0</code><br>\nI'm using lean as a backend to verify third party languages whose types may include refinements like the ones above for programs I have no control over.</p>\n<p>Thanks!</p>",
        "id": 322354058,
        "sender_full_name": "Raúl Raja Martínez",
        "timestamp": 1674154272
    },
    {
        "content": "<p>But the issue above is not that lean cannot infere automatically that -1 is not gte 0, you are never constructing a proof of that statement, the issue is that lean is not parsing your stuff in the way you expect, this works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span> <span class=\"n\">GTE0</span> <span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 322354714,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1674154464
    },
    {
        "content": "<p>Your example is parsed as <code>(GTE0) - 1</code> to be clear.</p>",
        "id": 322354776,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1674154491
    },
    {
        "content": "<p>I'm also not exactly sure how you are planning to do verification of third party languages in a way where the above would be an issue? Are you planning to just straight up translate their code into Lean code? That seems rather excessive to me, You could instead write inductive types that represent terms of your other language + algorithms on those types + proofs for those algorithms for example</p>",
        "id": 322355320,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1674154656
    },
    {
        "content": "<p>The direct translation approach is <a href=\"https://pp.ipd.kit.edu/uploads/publikationen/ullrich16masterarbeit.pdf\">way cooler</a> though (but nowadays you should probably just read <a href=\"https://arxiv.org/abs/2206.07185\">https://arxiv.org/abs/2206.07185</a> instead)</p>",
        "id": 322362806,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1674157014
    },
    {
        "content": "<p>Thanks everyone for the input. </p>\n<p>I'll try to elaborate more what I'm trying to do in case you have a better idea on how I might accomplish this.<br>\nFirst, I'm new to lean, I'm investigating lean to use as backend for verification of Scala, Kotlin and some other mainstream languages.</p>\n<p>We have already developed tools in some of those languages backed by SMT such as <a href=\"https://arrow-kt.io/docs/analysis/conditions/\">https://arrow-kt.io/docs/analysis/conditions/</a><br>\nHere in Arrow analysis we use a form of Hoare logic to have <code>pre</code>, <code>post</code>, <code>invariant</code> conditions over functions to detect common errors that end up in runtime exceptions in most of these languages. For example Arrow analysis can analyze unsafe calls given Kotlin data flow and fail at compile time like this:<br>\nGiven an imported law such as:</p>\n<div class=\"codehilite\" data-code-language=\"Kotlin\"><pre><span></span><code><span class=\"nd\">@Law</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"kd\">inline</span><span class=\"w\"> </span><span class=\"kd\">fun</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">E</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"nf\">List</span><span class=\"o\">&lt;</span><span class=\"n\">E</span><span class=\"o\">&gt;</span><span class=\"p\">.</span><span class=\"na\">getLaw</span><span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">Int</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">pre</span><span class=\"p\">(</span><span class=\"n\">index</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"s\">\"index within bounds\"</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">get</span><span class=\"p\">(</span><span class=\"n\">index</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The following expression fails to compile</p>\n<div class=\"codehilite\" data-code-language=\"Kotlin\"><pre><span></span><code><span class=\"kd\">val</span><span class=\"w\"> </span><span class=\"nv\">wrong</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">emptyList</span><span class=\"o\">&lt;</span><span class=\"kt\">Int</span><span class=\"o\">&gt;</span><span class=\"p\">().</span><span class=\"na\">get</span><span class=\"p\">(</span><span class=\"m\">2</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">e</span><span class=\"o\">:</span> <span class=\"n\">Example.kt</span><span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">18</span><span class=\"o\">):</span> <span class=\"n\">pre</span><span class=\"bp\">-</span><span class=\"n\">condition</span> <span class=\"bp\">`</span><span class=\"n\">index</span> <span class=\"n\">within</span> <span class=\"n\">bounds</span><span class=\"bp\">`</span> <span class=\"n\">is</span> <span class=\"n\">not</span> <span class=\"n\">satisfied</span> <span class=\"k\">in</span> <span class=\"bp\">`</span><span class=\"n\">get</span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">`</span>\n  <span class=\"bp\">-&gt;</span> <span class=\"n\">unsatisfiable</span> <span class=\"n\">constraint</span><span class=\"o\">:</span> <span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"mi\">2</span> <span class=\"bp\">&gt;=</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">&amp;&amp;</span> <span class=\"o\">(</span><span class=\"mi\">2</span> <span class=\"bp\">&lt;</span> <span class=\"n\">emptyList</span><span class=\"bp\">&lt;</span><span class=\"n\">Int</span><span class=\"bp\">&gt;</span><span class=\"o\">()</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">))</span><span class=\"bp\">`</span>\n  <span class=\"bp\">-&gt;</span> <span class=\"bp\">`</span><span class=\"mi\">2</span><span class=\"bp\">`</span> <span class=\"n\">bound</span> <span class=\"n\">to</span> <span class=\"n\">param</span> <span class=\"bp\">`</span><span class=\"n\">index</span><span class=\"bp\">`</span> <span class=\"k\">in</span> <span class=\"bp\">`</span><span class=\"n\">kotlin.collections.List.get</span><span class=\"bp\">`</span>\n  <span class=\"bp\">-&gt;</span> <span class=\"n\">main</span> <span class=\"n\">function</span> <span class=\"n\">body</span>\n</code></pre></div>\n<p>I would like to replace our current scope based approach using SMT for a lean backend.</p>\n<p>I'm trying two different approaches.</p>\n<ol>\n<li>\n<p>Embed the foreign language into lean using lean's macro and syntax system. Expressing semantics of unknown types is still something I'm not sure how to encode but I got Java and a subset of Kotlin parsed which is missng elab functions to expand to lean command and terms. I even dreamed that If I build first support for antlr grammars I can get syntax automatically using most of the antlr .g4 files for most langs <a href=\"https://github.com/antlr/grammars-v4\">https://github.com/antlr/grammars-v4</a></p>\n</li>\n<li>\n<p>Directly translate with compiler plugins in Kotlin elsewhere their AST to Lean in a transpiler fashion. I'm not sure here yet how to map foreign symbols in jars and other binaries to which I have no body access. I suppose lean would allow me to declare abstract declarations from which I can still infer interesting things.</p>\n</li>\n</ol>\n<p>If you wanted to verify in Lean something like the example above for unsafe access to an empty list, what would be the equivalent lean code for that example? what kind of error would it produce when it detects an unsafe access?</p>\n<p>Thanks!</p>",
        "id": 322366851,
        "sender_full_name": "Raúl Raja Martínez",
        "timestamp": 1674158308
    }
]