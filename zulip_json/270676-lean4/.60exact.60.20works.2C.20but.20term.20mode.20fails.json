[
    {
        "content": "<p>In this MWE, the first example works, but the second doesn't. There's no implicit undecidable higher-order unification going on as far as I can see, so what prevents Lean from type-checking it?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">noncomputable</span> <span class=\"kn\">section</span>\n\n<span class=\"kd\">axiom</span> <span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">α</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₁</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₂</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₃</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">α</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₄</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">P</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">f₁</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"n\">a</span> <span class=\"n\">P</span><span class=\"o\">)</span> <span class=\"bp\">↔</span> <span class=\"n\">f₁</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"bp\">∧</span> <span class=\"n\">P</span> <span class=\"n\">b</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₅</span> <span class=\"o\">{</span><span class=\"n\">P</span> <span class=\"n\">Q</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">P</span> <span class=\"bp\">∧</span> <span class=\"n\">Q</span> <span class=\"bp\">→</span> <span class=\"n\">Q</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₆</span> <span class=\"o\">{</span><span class=\"n\">P</span> <span class=\"n\">Q</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">P</span> <span class=\"bp\">↔</span> <span class=\"n\">Q</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">P</span> <span class=\"bp\">→</span> <span class=\"n\">Q</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">f₇</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"o\">:=</span> <span class=\"n\">f₃</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">b</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">f₂</span> <span class=\"n\">b</span> <span class=\"n\">a</span><span class=\"o\">)</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f₁</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₇</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"n\">f₂</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"k\">have</span> <span class=\"n\">h₁</span> <span class=\"o\">:=</span> <span class=\"n\">f₅</span> <span class=\"o\">(</span><span class=\"n\">f₆</span> <span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n  <span class=\"n\">exact</span> <span class=\"n\">h₁</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f₁</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₇</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"n\">f₂</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n<span class=\"n\">f₅</span> <span class=\"o\">(</span><span class=\"n\">f₆</span> <span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 286828895,
        "sender_full_name": "Patrick Johnson",
        "timestamp": 1655751128
    },
    {
        "content": "<p>It's not exact that is failing here, inlining the have fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f₁</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₇</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"n\">f₂</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">exact</span> <span class=\"n\">f₅</span> <span class=\"o\">(</span><span class=\"n\">f₆</span> <span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and using a let in the second one suceeds:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f₁</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₇</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"n\">f₂</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n  <span class=\"k\">let</span> <span class=\"n\">foo</span> <span class=\"o\">:=</span> <span class=\"n\">f₅</span> <span class=\"o\">(</span><span class=\"n\">f₆</span> <span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n  <span class=\"n\">foo</span>\n</code></pre></div>\n<p>But I'm afraid I dont have a clue why this makes a difference</p>",
        "id": 286829478,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1655751531
    },
    {
        "content": "<p>I'd guess it has something to do with differences in elaboration when there's an expected type. This doesn't work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f₁</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₇</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"n\">f₂</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"k\">have</span> <span class=\"n\">h₁</span> <span class=\"o\">:</span> <span class=\"n\">f₂</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span> <span class=\"n\">f₅</span> <span class=\"o\">(</span><span class=\"n\">f₆</span> <span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n  <span class=\"n\">exact</span> <span class=\"n\">h₁</span>\n</code></pre></div>\n<p>Curiously, in Lean 3 this is a workaround, but it doesn't change anything for Lean 4:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f₁</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₇</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"n\">f₂</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n<span class=\"n\">id</span> <span class=\"n\">f₅</span> <span class=\"o\">(</span><span class=\"n\">f₆</span> <span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 286829853,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1655751760
    },
    {
        "content": "<p>Using the coercion arrow seems to cause it to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f₁</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₇</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"n\">f₂</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n<span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"n\">f₅</span> <span class=\"o\">(</span><span class=\"n\">f₆</span> <span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>That seems to be in line with the theory that it's about whether there's an expected type (though I'm using my understanding of Lean 3 here, which might not apply to Lean 4).</p>",
        "id": 286829952,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1655751841
    },
    {
        "content": "<p>More minimization:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">noncomputable</span> <span class=\"kn\">section</span>\n\n<span class=\"kd\">axiom</span> <span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">α</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₃</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">α</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₄</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">P</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"n\">a</span> <span class=\"n\">P</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"bp\">∧</span> <span class=\"n\">P</span> <span class=\"n\">b</span>\n\n<span class=\"c1\">-- Works</span>\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"k\">have</span> <span class=\"n\">h₁</span> <span class=\"o\">:=</span> <span class=\"n\">And.right</span> <span class=\"o\">(</span><span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n  <span class=\"n\">exact</span> <span class=\"n\">h₁</span>\n\n<span class=\"c1\">-- Fails</span>\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n<span class=\"n\">And.right</span> <span class=\"o\">(</span><span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"c\">/-</span><span class=\"cm\"></span>\n<span class=\"cm\">application type mismatch</span>\n<span class=\"cm\">  f₄ h</span>\n<span class=\"cm\">argument</span>\n<span class=\"cm\">  h</span>\n<span class=\"cm\">has type</span>\n<span class=\"cm\">  f b (f₃ x fun a_1 =&gt; f a_1 a) : Prop</span>\n<span class=\"cm\">but is expected to have type</span>\n<span class=\"cm\">  f a (f₃ ?m.91 (f b)) : Prop</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"c1\">-- Works</span>\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n<span class=\"o\">(</span><span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">right</span>\n</code></pre></div>",
        "id": 286831399,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1655752780
    },
    {
        "content": "<p>in lean 3, we could use Chris's trick <code>(And.right (f₄ h) : _)</code> to do this in term mode, but it doesn't seem to work in lean 4. <code>by exact</code> sometimes works for this. I think we should just add a macro which does this explicitly</p>",
        "id": 286832763,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1655753755
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span> <span class=\"n\">Lean</span> <span class=\"n\">Elab</span> <span class=\"n\">Term</span>\n\n<span class=\"n\">elab</span> <span class=\"n\">tm</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"s2\">\":!\"</span> <span class=\"o\">:</span> <span class=\"n\">term</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">elabTermEnsuringType</span> <span class=\"n\">tm</span> <span class=\"n\">none</span>\n\n<span class=\"c1\">-- Works</span>\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n<span class=\"n\">And.right</span> <span class=\"o\">(</span><span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span> <span class=\"o\">:</span><span class=\"bp\">!</span>\n</code></pre></div>",
        "id": 286833616,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1655754405
    },
    {
        "content": "<p>making a good syntax here is hard though. I kind of just want to hack the type ascription elaborator to make <code>: _</code> work, since it has no other use</p>",
        "id": 286833679,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1655754481
    },
    {
        "content": "<p><code>:)</code> looks friendlier.</p>",
        "id": 286835705,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1655756009
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">elab</span> <span class=\"s2\">\"(\"</span> <span class=\"n\">tm</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"s2\">\":\"</span> <span class=\"s2\">\")\"</span> <span class=\"o\">:</span> <span class=\"n\">term</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">elabTermEnsuringType</span> <span class=\"n\">tm</span> <span class=\"n\">none</span>\n\n<span class=\"c1\">-- Works</span>\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n<span class=\"o\">(</span><span class=\"n\">And.right</span> <span class=\"o\">(</span><span class=\"n\">f₄</span> <span class=\"n\">h</span><span class=\"o\">)</span> <span class=\"o\">:)</span>\n</code></pre></div>",
        "id": 286835981,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1655756248
    },
    {
        "content": "<p>I really like how the type ascription ends in a smile!</p>",
        "id": 286836074,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1655756315
    },
    {
        "content": "<p>Why isn't this the default behavior? I mean, what prevents the elaborator from unfolding the terms further until their types match?</p>",
        "id": 286885117,
        "sender_full_name": "Patrick Johnson",
        "timestamp": 1655802159
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"456794\">@Patrick Johnson</span> Which thing are you referring to? At least with your example the problem is that unification goes down the wrong path, and with the minimized versions there's nothing to unfold. My understanding is that it's due to the order of elaboration, since when the expected type is known it tries to solve for <code>P</code> before it even considers the <code>h</code> argument.</p>\n<p>Here it is minimized even further:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">noncomputable</span> <span class=\"kn\">section</span>\n\n<span class=\"kd\">axiom</span> <span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">α</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₃</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">α</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₄</span> <span class=\"o\">{</span><span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">P</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"n\">P</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">P</span> <span class=\"n\">b</span>\n\n<span class=\"c1\">-- Works</span>\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"k\">have</span> <span class=\"n\">h₁</span> <span class=\"o\">:=</span> <span class=\"n\">f₄</span> <span class=\"n\">h</span>\n  <span class=\"n\">exact</span> <span class=\"n\">h₁</span>\n\n<span class=\"c1\">-- Fails</span>\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n<span class=\"n\">f₄</span> <span class=\"n\">h</span>\n<span class=\"c\">/-</span><span class=\"cm\"></span>\n<span class=\"cm\">application type mismatch</span>\n<span class=\"cm\">  f₄ h</span>\n<span class=\"cm\">argument</span>\n<span class=\"cm\">  h</span>\n<span class=\"cm\">has type</span>\n<span class=\"cm\">  f b (f₃ fun a_1 =&gt; f a_1 a) : Prop</span>\n<span class=\"cm\">but is expected to have type</span>\n<span class=\"cm\">  f a (f₃ (f b)) : Prop</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"c1\">-- Succeeds</span>\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span> <span class=\"o\">:=</span>\n<span class=\"n\">f₄</span> <span class=\"o\">(</span><span class=\"n\">P</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"n\">h</span>\n</code></pre></div>",
        "id": 286926340,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1655823562
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/.60exact.60.20works.2C.20but.20term.20mode.20fails/near/286926340\">said</a>:</p>\n<blockquote>\n<p>When the expected type is known it tries to solve for <code>P</code> before it even considers the <code>h</code> argument.</p>\n</blockquote>\n<p>Why would the elaborator do that in the first place? <code>P</code> is a predicate of type <code>α → Prop</code>, so it doesn't seem like a great idea to try to unify it until all other attempts are exhausted. In your minimized example, this is what I think the elaborator should do:</p>\n<p>Step 1: <code>f₄ h</code> must have type <code>f b a</code></p>\n<p>Step 2: The type of <code>f₄ h</code> is <code>?P ?b</code> for some variables <code>?P</code> and <code>?b</code> as long as the type of <code>h</code> is <code>f ?b (f₃ ?P)</code></p>\n<p>Step 3: Type of <code>h</code> is <code>f b (f₃ (λ x =&gt; f x a))</code> and it must unify with <code>f ?b (f₃ ?P)</code>. Since <code>f</code> is irreducible, it means that <code>b</code> must unify with <code>?b</code> and <code>f₃ (λ x =&gt; f x a)</code> must unify with <code>f₃ ?P</code>. In this step, we learn that <code>?b</code> is <code>b</code></p>\n<p>Step 4: Since <code>f₃ (λ x =&gt; f x a)</code> must unify with <code>f₃ ?P</code> and since <code>f₃</code> is irreducible, it means that <code>?P</code> is <code>λ x =&gt; f x a</code></p>\n<p>Step 5: The remaining equation is that <code>f b a</code> must unify with <code>?P ?b</code>. Since in step 3 we learned that <code>?b</code> is <code>b</code> and in step 4 we learned that <code>?P</code> is <code>λ x =&gt; f x a</code>, it means that <code>(λ x =&gt; f x a) b</code> must be <code>f b a</code>, which is trivially true after performing beta reduction.</p>",
        "id": 286931295,
        "sender_full_name": "Patrick Johnson",
        "timestamp": 1655825511
    },
    {
        "content": "<p>My understanding is that the challenge is that with step 1 and step 2 you have an unresolved unification problem <code>?P ?b =?= f b a</code> and lean <em>solves</em> it, to <code>?P := f b</code> and <code>?b := a</code>. This is a heuristic which can go wrong, but it is actually pretty important in practice unless you want to unfold all functions everywhere in case you have a term <code>foo x</code> where it turns out that <code>foo</code> is defined after unfolding 7 layers of definition to be a constant function, so that <code>foo x =?= foo y</code> does not imply <code>x =?= y</code>.</p>\n<p>There is a special case where this is usually the wrong heuristic, and that is recursors. These usually have a type that ends in <code>motive x</code> where <code>motive</code> is a variable, and when unifying <code>?motive x =?= x /\\ x</code> we do not want to take <code>?motive := And x</code> but rather <code>?motive := fun a =&gt; a /\\ a</code>. This is what lean 3 <code>@[elab_as_eliminator]</code> does, and in lean 4 you can get this behavior using <code>induction x using thm</code> where <code>thm</code> is the theorem to apply.</p>",
        "id": 286933596,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1655826268
    },
    {
        "content": "<p>Regarding \"why doesn't it always act like the <code>(e :)</code> version\", consider that all we have to do to foil it on this example is swap the arrows:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Lean</span>\n<span class=\"kn\">open</span> <span class=\"n\">Lean</span> <span class=\"n\">Elab</span> <span class=\"n\">Term</span>\n\n<span class=\"n\">elab</span> <span class=\"s2\">\"(\"</span> <span class=\"n\">tm</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"s2\">\":\"</span> <span class=\"s2\">\")\"</span> <span class=\"o\">:</span> <span class=\"n\">term</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">elabTermEnsuringType</span> <span class=\"n\">tm</span> <span class=\"n\">none</span>\n\n<span class=\"kd\">axiom</span> <span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">α</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₃</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">α</span>\n<span class=\"kd\">axiom</span> <span class=\"n\">f₄</span> <span class=\"o\">{</span><span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">P</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">P</span> <span class=\"n\">b</span> <span class=\"bp\">→</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"n\">P</span><span class=\"o\">)</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"n\">f₄</span> <span class=\"n\">h</span> <span class=\"c1\">-- works</span>\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"n\">a</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"n\">b</span> <span class=\"o\">(</span><span class=\"n\">f₃</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">·</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">f₄</span> <span class=\"n\">h</span> <span class=\"o\">:)</span> <span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 286934389,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1655826576
    }
]