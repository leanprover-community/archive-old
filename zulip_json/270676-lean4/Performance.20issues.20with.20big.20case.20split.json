[
    {
        "content": "<p>A colleague who wanted to try Lean gave me this test case:  <a href=\"/user_uploads/3121/7JpfFtgg-1TLku20Bavw2YQD/automaton.lean\">automaton.lean</a> (the file is too big for a Zulip message). It defines an automaton as a set of states and a transition function, then tries to prove a certain lemma. This proof involves three nested case splits with 35 possibilities each, so 35³ cases in total. Each case is proven by a trivial <code>rfl</code>.</p>\n<p>Coq compiles the file (<a href=\"/user_uploads/3121/j3DOwhrSq96LvrRL7ln9rPSk/automaton.v\">automaton.v</a>) in 16s or so on my machine. Lean 4 (latest nightly) still wasn't finished after 1h. According to my mental model of Lean 4, it should be fast in this case, so I'd like to understand why it isn't.</p>",
        "id": 278283043,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1649412759
    },
    {
        "content": "<p>It seems to still deal fine with <code>cases x &lt;;&gt; cases y &lt;;&gt; sorry</code> but if you add the additional split on <code>z</code> stuff starts blowing up massively, my system almost OOMed while trying to compute that.</p>",
        "id": 278285364,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1649414259
    },
    {
        "content": "<p>I also have absolutely 0 knowledge in benching Lean but if I'm wrong on this someone will correct me sooner or later and I'll have learned something^^</p>\n<p>From running <code>perf mem record</code> it seems like <code>Level.collectMVars</code> is storing tons of meta variables (which makes sense considering all of the 35^3 goals are mvars) away which is consuming a ton of memory and also among the parts that is consuming the most CPU time together with (of course) the garbage collection. So my bet is that it's related to this^^</p>",
        "id": 278289455,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1649416751
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span> Do you have a generator for this file? A script that given the number of states, returns the .lean file. <br>\nWhen fixing the performance bottleneck, it would be great to have a smaller <code>n &lt; 35</code> that we can solve in a few seconds.</p>",
        "id": 278291039,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1649417690
    },
    {
        "content": "<p>This is a real proof they wanted to do, so I don't have a generator, but I can write one.</p>",
        "id": 278298661,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1649422079
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span> <a href=\"#narrow/stream/270676-lean4/topic/Performance.20issues.20with.20big.20case.20split/near/278298661\">said</a>:</p>\n<blockquote>\n<p>This is a real proof they wanted to do, so I don't have a generator, but I can write one.</p>\n</blockquote>\n<p>That would be very useful. Thanks.</p>",
        "id": 278299044,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1649422298
    },
    {
        "content": "<p>A simple generator written in Haskell:</p>\n<div class=\"codehilite\" data-code-language=\"Haskell\"><pre><span></span><code><span class=\"kr\">import</span><span class=\"w\"> </span><span class=\"nn\">Data.List</span><span class=\"w\"></span>\n\n<span class=\"nf\">states_num</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"></span>\n<span class=\"nf\">out_file</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"s\">\"test.lean\"</span><span class=\"w\"></span>\n\n<span class=\"nf\">main</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"n\">writeFile</span><span class=\"w\"> </span><span class=\"n\">out_file</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"w\"> </span><span class=\"n\">unlines</span><span class=\"w\"> </span><span class=\"n\">mk_lines</span><span class=\"w\"></span>\n<span class=\"nf\">states</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">\\</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"sc\">'s'</span><span class=\"w\"> </span><span class=\"kt\">:</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"n\">states_num</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"nf\">mk_lines</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"s\">\"inductive States\"</span><span class=\"o\">++</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"w\"> </span><span class=\"n\">states</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"s\">\" | \"</span><span class=\"w\"> </span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"s\">\"open States\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"s\">\"def f : States → States → States\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"o\">$</span><span class=\"w\"> </span><span class=\"n\">states</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">states</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">concat</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s\">\"</span><span class=\"se\">\\n</span><span class=\"s\">| \"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\", \"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\" =&gt; s0\"</span><span class=\"p\">],</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"s\">\"set_option maxHeartbeats 0\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"s\">\"example : ∀ x y z, f (f (f s0 x) y) z = f (f x z) (f y z) := by\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"s\">\" intros x y z\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"s\">\" cases x &lt;;&gt; cases y &lt;;&gt; cases z &lt;;&gt; rfl\"</span><span class=\"w\"> </span><span class=\"p\">]</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 278305492,
        "sender_full_name": "Patrick Johnson",
        "timestamp": 1649425389
    },
    {
        "content": "<p>Thank you very much Patrick! For me, the test files scale like this:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>states | time (s)\n7      | 1.6\n8      | 3.1\n9      | 5.5\n10     | 9.2\n11     | 15.1\n12     | 23.6\n</code></pre></div>",
        "id": 278342058,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1649441516
    },
    {
        "content": "<p>For the benefit of people without a GHC handy, the Lean file for 8 states:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">States</span> <span class=\"bp\">|</span> <span class=\"n\">s0</span> <span class=\"bp\">|</span> <span class=\"n\">s1</span> <span class=\"bp\">|</span> <span class=\"n\">s2</span> <span class=\"bp\">|</span> <span class=\"n\">s3</span> <span class=\"bp\">|</span> <span class=\"n\">s4</span> <span class=\"bp\">|</span> <span class=\"n\">s5</span> <span class=\"bp\">|</span> <span class=\"n\">s6</span> <span class=\"bp\">|</span> <span class=\"n\">s7</span>\n<span class=\"kn\">open</span> <span class=\"n\">States</span>\n<span class=\"kd\">def</span> <span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">States</span> <span class=\"bp\">→</span> <span class=\"n\">States</span> <span class=\"bp\">→</span> <span class=\"n\">States</span>\n<span class=\"bp\">|</span> <span class=\"n\">s0</span><span class=\"o\">,</span> <span class=\"n\">s0</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s0</span><span class=\"o\">,</span> <span class=\"n\">s1</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s0</span><span class=\"o\">,</span> <span class=\"n\">s2</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s0</span><span class=\"o\">,</span> <span class=\"n\">s3</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s0</span><span class=\"o\">,</span> <span class=\"n\">s4</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s0</span><span class=\"o\">,</span> <span class=\"n\">s5</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s0</span><span class=\"o\">,</span> <span class=\"n\">s6</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s0</span><span class=\"o\">,</span> <span class=\"n\">s7</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s1</span><span class=\"o\">,</span> <span class=\"n\">s0</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s1</span><span class=\"o\">,</span> <span class=\"n\">s1</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s1</span><span class=\"o\">,</span> <span class=\"n\">s2</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s1</span><span class=\"o\">,</span> <span class=\"n\">s3</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s1</span><span class=\"o\">,</span> <span class=\"n\">s4</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s1</span><span class=\"o\">,</span> <span class=\"n\">s5</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s1</span><span class=\"o\">,</span> <span class=\"n\">s6</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s1</span><span class=\"o\">,</span> <span class=\"n\">s7</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s2</span><span class=\"o\">,</span> <span class=\"n\">s0</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s2</span><span class=\"o\">,</span> <span class=\"n\">s1</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s2</span><span class=\"o\">,</span> <span class=\"n\">s2</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s2</span><span class=\"o\">,</span> <span class=\"n\">s3</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s2</span><span class=\"o\">,</span> <span class=\"n\">s4</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s2</span><span class=\"o\">,</span> <span class=\"n\">s5</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s2</span><span class=\"o\">,</span> <span class=\"n\">s6</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s2</span><span class=\"o\">,</span> <span class=\"n\">s7</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s3</span><span class=\"o\">,</span> <span class=\"n\">s0</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s3</span><span class=\"o\">,</span> <span class=\"n\">s1</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s3</span><span class=\"o\">,</span> <span class=\"n\">s2</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s3</span><span class=\"o\">,</span> <span class=\"n\">s3</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s3</span><span class=\"o\">,</span> <span class=\"n\">s4</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s3</span><span class=\"o\">,</span> <span class=\"n\">s5</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s3</span><span class=\"o\">,</span> <span class=\"n\">s6</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s3</span><span class=\"o\">,</span> <span class=\"n\">s7</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s4</span><span class=\"o\">,</span> <span class=\"n\">s0</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s4</span><span class=\"o\">,</span> <span class=\"n\">s1</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s4</span><span class=\"o\">,</span> <span class=\"n\">s2</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s4</span><span class=\"o\">,</span> <span class=\"n\">s3</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s4</span><span class=\"o\">,</span> <span class=\"n\">s4</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s4</span><span class=\"o\">,</span> <span class=\"n\">s5</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s4</span><span class=\"o\">,</span> <span class=\"n\">s6</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s4</span><span class=\"o\">,</span> <span class=\"n\">s7</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s5</span><span class=\"o\">,</span> <span class=\"n\">s0</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s5</span><span class=\"o\">,</span> <span class=\"n\">s1</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s5</span><span class=\"o\">,</span> <span class=\"n\">s2</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s5</span><span class=\"o\">,</span> <span class=\"n\">s3</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s5</span><span class=\"o\">,</span> <span class=\"n\">s4</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s5</span><span class=\"o\">,</span> <span class=\"n\">s5</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s5</span><span class=\"o\">,</span> <span class=\"n\">s6</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s5</span><span class=\"o\">,</span> <span class=\"n\">s7</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s6</span><span class=\"o\">,</span> <span class=\"n\">s0</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s6</span><span class=\"o\">,</span> <span class=\"n\">s1</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s6</span><span class=\"o\">,</span> <span class=\"n\">s2</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s6</span><span class=\"o\">,</span> <span class=\"n\">s3</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s6</span><span class=\"o\">,</span> <span class=\"n\">s4</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s6</span><span class=\"o\">,</span> <span class=\"n\">s5</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s6</span><span class=\"o\">,</span> <span class=\"n\">s6</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s6</span><span class=\"o\">,</span> <span class=\"n\">s7</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s7</span><span class=\"o\">,</span> <span class=\"n\">s0</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s7</span><span class=\"o\">,</span> <span class=\"n\">s1</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s7</span><span class=\"o\">,</span> <span class=\"n\">s2</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s7</span><span class=\"o\">,</span> <span class=\"n\">s3</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s7</span><span class=\"o\">,</span> <span class=\"n\">s4</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s7</span><span class=\"o\">,</span> <span class=\"n\">s5</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s7</span><span class=\"o\">,</span> <span class=\"n\">s6</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"bp\">|</span> <span class=\"n\">s7</span><span class=\"o\">,</span> <span class=\"n\">s7</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s0</span>\n<span class=\"kd\">set_option</span> <span class=\"n\">maxHeartbeats</span> <span class=\"mi\">0</span>\n<span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"n\">z</span><span class=\"o\">,</span> <span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">s0</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"n\">z</span> <span class=\"bp\">=</span> <span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"n\">z</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">y</span> <span class=\"n\">z</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n <span class=\"n\">intros</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"n\">z</span>\n <span class=\"n\">cases</span> <span class=\"n\">x</span> <span class=\"bp\">&lt;;&gt;</span> <span class=\"n\">cases</span> <span class=\"n\">y</span> <span class=\"bp\">&lt;;&gt;</span> <span class=\"n\">cases</span> <span class=\"n\">z</span> <span class=\"bp\">&lt;;&gt;</span> <span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 278342233,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1649441585
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span> Thanks for posting the Lean file. It was quite handy for me since I don't have GHC installed on my machine.<br>\nI pushed some perf improvements. The 8 states file was taking 2.0s on my machine, and it now takes around 0.3s.<br>\nCould you please post the file for 12 states?</p>",
        "id": 278426644,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1649532828
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/-Atz0wzYRI3TIosOs6mNUm_Y/test.lean\">test.lean</a> <span class=\"user-mention\" data-user-id=\"112857\">@Leonardo de Moura</span></p>",
        "id": 278426731,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1649532923
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 278426740,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1649532939
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112857\">Leonardo de Moura</span> <a href=\"#narrow/stream/270676-lean4/topic/Performance.20issues.20with.20big.20case.20split/near/278426644\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span> Thanks for posting the Lean file. It was quite handy for me since I don't have GHC installed on my machine.<br>\nI pushed some perf improvements. The 8 states file was taking 2.0s on my machine, and it now takes around 0.3s.<br>\nCould you please post the file for 12 states?</p>\n</blockquote>\n<p>Out of curiosity, I checked the last 3 perf commits to see what you did this one being the biggest performance increase <a href=\"https://github.com/leanprover/lean4/commit/7d99f6f555fd80a0dece420be9618f6d9b83f071\">https://github.com/leanprover/lean4/commit/7d99f6f555fd80a0dece420be9618f6d9b83f071</a>.</p>\n<p>And if I'm understanding it correctly there is basically a isClassQuick that says for sure if its not a class and undefined if its not sure which was acting overeager, causing too much calls to the expensive variant to happen which does unfoldings right? How did you figure that this was actually at fault for issues with state8.lean? Or was that just luck?</p>",
        "id": 278427273,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1649533718
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> </p>\n<blockquote>\n<p>causing too much calls to the expensive variant to happen which does unfoldings right?</p>\n</blockquote>\n<p>Correct.</p>\n<blockquote>\n<p>How did you figure that this was actually at fault for issues with state8.lean?</p>\n</blockquote>\n<p>I used</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">perf</span> <span class=\"n\">record</span> <span class=\"c1\">--call-graph dwarf stage1/bin/lean state8.lean</span>\n<span class=\"n\">hotspot</span>\n</code></pre></div>\n<p><code>perf</code> is amazing. It is the most precise profiler I have ever used. Other profilers would often put me in the \"wrong direction\".</p>",
        "id": 278427574,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1649534114
    },
    {
        "content": "<p>I took a quick look at <code>state12.lean</code>, and as far as I can tell we need to improve the kernel reduction engine to substantially reduce the runtime now. I created an issue for this <a href=\"https://github.com/leanprover/lean4/issues/1101\">https://github.com/leanprover/lean4/issues/1101</a>.<br>\nWe want to do it anyway to improve the \"proof by reflection\" support.</p>",
        "id": 278427663,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1649534274
    },
    {
        "content": "<p>Online test case generator: <a href=\"https://user7230724.github.io/lean/lean4-perf-test-gen.htm\">https://user7230724.github.io/lean/lean4-perf-test-gen.htm</a></p>",
        "id": 278428901,
        "sender_full_name": "Patrick Johnson",
        "timestamp": 1649536051
    },
    {
        "content": "<p>I was about to suggest that as a joke when Leo asked for the next one xd</p>",
        "id": 278429041,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1649536257
    },
    {
        "content": "<p>If you are willing to trust the Lean compiler and interpreter,  then you can check the 35 states instance in approx. 1s (on my machine) using <code>native_decide</code>.<br>\n<a href=\"https://github.com/leanprover/lean4/blob/1db11ed5c750c7f5e782a31ad12e202d12e41832/tests/lean/run/states35.lean\">https://github.com/leanprover/lean4/blob/1db11ed5c750c7f5e782a31ad12e202d12e41832/tests/lean/run/states35.lean</a><br>\nThis is may be a reasonable compromise until we have a better reduction engine in the kernel.</p>",
        "id": 278432849,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1649541153
    }
]