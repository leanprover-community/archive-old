[
    {
        "content": "<p>How could I make a macro in Lean such that </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">define</span> <span class=\"o\">(</span><span class=\"n\">add</span> <span class=\"o\">[</span><span class=\"n\">x</span> <span class=\"n\">Nat</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">y</span> <span class=\"n\">Nat</span><span class=\"o\">])</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"n\">y</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>expands into</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">add</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"n\">y</span>\n</code></pre></div>",
        "id": 282975293,
        "sender_full_name": "Joseph O",
        "timestamp": 1652986325
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">syntax</span> <span class=\"n\">binder</span> <span class=\"o\">:=</span> <span class=\"s2\">\"[\"</span> <span class=\"n\">ident</span> <span class=\"n\">term</span> <span class=\"s2\">\"]\"</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"(\"</span> <span class=\"s2\">\"define\"</span> <span class=\"s2\">\"(\"</span> <span class=\"n\">ident</span> <span class=\"n\">binder</span><span class=\"bp\">*</span> <span class=\"s2\">\")\"</span> <span class=\"n\">term</span> <span class=\"s2\">\" : \"</span> <span class=\"n\">term</span> <span class=\"s2\">\")\"</span> <span class=\"o\">:</span> <span class=\"n\">command</span>\n\n<span class=\"n\">macro_rules</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">define</span> <span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">])</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"o\">:</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kd\">def</span> <span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">:</span> <span class=\"bp\">$</span><span class=\"n\">ty</span> <span class=\"bp\">→</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span> <span class=\"o\">:=</span> <span class=\"k\">fun</span> <span class=\"bp\">$</span><span class=\"n\">nm</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">define</span> <span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"o\">:</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">define</span> <span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"k\">fun</span> <span class=\"bp\">$</span><span class=\"n\">nm</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"o\">:</span> <span class=\"bp\">$</span><span class=\"n\">ty</span> <span class=\"bp\">→</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span>\n\n<span class=\"o\">(</span><span class=\"n\">define</span> <span class=\"o\">(</span><span class=\"n\">add</span> <span class=\"o\">[</span><span class=\"n\">x</span> <span class=\"n\">Nat</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">y</span> <span class=\"n\">Nat</span><span class=\"o\">])</span> <span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">add</span> <span class=\"mi\">3</span> <span class=\"mi\">5</span> <span class=\"c1\">-- 5</span>\n</code></pre></div>",
        "id": 282985507,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1652991038
    },
    {
        "content": "<p>Here's a fun idea:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">syntax</span> <span class=\"n\">binder</span> <span class=\"o\">:=</span> <span class=\"s2\">\"[\"</span> <span class=\"n\">ident</span> <span class=\"n\">term</span> <span class=\"s2\">\"]\"</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"(\"</span> <span class=\"s2\">\"define\"</span> <span class=\"s2\">\"(\"</span> <span class=\"s2\">\"[\"</span> <span class=\"n\">ident</span> <span class=\"n\">term</span> <span class=\"s2\">\"]\"</span> <span class=\"n\">binder</span><span class=\"bp\">*</span> <span class=\"s2\">\")\"</span> <span class=\"n\">term</span> <span class=\"s2\">\")\"</span> <span class=\"o\">:</span> <span class=\"n\">command</span>\n\n<span class=\"n\">macro_rules</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">])</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kd\">def</span> <span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">:</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"bp\">→</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"o\">:=</span> <span class=\"k\">fun</span> <span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"bp\">→</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"k\">fun</span> <span class=\"bp\">$</span><span class=\"n\">nm</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span>\n\n<span class=\"o\">(</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"n\">add</span> <span class=\"n\">Nat</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">x</span> <span class=\"n\">Nat</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">y</span> <span class=\"n\">Nat</span><span class=\"o\">])</span> <span class=\"n\">x</span><span class=\"o\">)</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">add</span> <span class=\"mi\">3</span> <span class=\"mi\">5</span> <span class=\"c1\">-- 5</span>\n</code></pre></div>",
        "id": 282985928,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1652991248
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 282988007,
        "sender_full_name": "Joseph O",
        "timestamp": 1652992222
    },
    {
        "content": "<p>There's something wrong with my code tho</p>",
        "id": 282988136,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1652992277
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"n\">add</span> <span class=\"n\">Nat</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">x</span> <span class=\"n\">Nat</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">bla</span> <span class=\"n\">Int</span><span class=\"o\">])</span> <span class=\"n\">x</span><span class=\"o\">)</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">add</span> <span class=\"mi\">3</span> <span class=\"mi\">5</span> <span class=\"c1\">-- 5</span>\n</code></pre></div>\n<p>I would expect that to eval to <code>3</code>, but it's being evaluated to <code>5</code>. Maybe someone else might be able to help you</p>",
        "id": 282988560,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1652992467
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"451983\">@Arthur Paulino</span> I think its because the arguments are reversed</p>",
        "id": 282991324,
        "sender_full_name": "Joseph O",
        "timestamp": 1652993864
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"467926\">Joseph O</span> has marked this topic as unresolved.</p>",
        "id": 283066749,
        "sender_full_name": "Notification Bot",
        "timestamp": 1653052215
    },
    {
        "content": "<p>Hm can someone explain this weird behavior?<br>\n<a href=\"/user_uploads/3121/gsoDTwnvvwOyVsyUUq_bRhc0/image.png\">image.png</a> <br>\n<a href=\"/user_uploads/3121/sscpr5FgCNQwdVtinZ3vBsTu/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/gsoDTwnvvwOyVsyUUq_bRhc0/image.png\" title=\"image.png\"><img src=\"/user_uploads/3121/gsoDTwnvvwOyVsyUUq_bRhc0/image.png\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/3121/sscpr5FgCNQwdVtinZ3vBsTu/image.png\" title=\"image.png\"><img src=\"/user_uploads/3121/sscpr5FgCNQwdVtinZ3vBsTu/image.png\"></a></div>",
        "id": 283066800,
        "sender_full_name": "Joseph O",
        "timestamp": 1653052237
    },
    {
        "content": "<p>I can't understand what's wrong with those screenshots</p>",
        "id": 283066935,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1653052318
    },
    {
        "content": "<p>For more context, here is <code>test3</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">test3</span> <span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span>\n  <span class=\"k\">let</span> <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">2</span><span class=\"o\">],</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"k\">in</span> <span class=\"n\">x</span> <span class=\"bp\">++</span> <span class=\"n\">y</span>\n</code></pre></div>",
        "id": 283067048,
        "sender_full_name": "Joseph O",
        "timestamp": 1653052355
    },
    {
        "content": "<p>I believe you posted on the wrong thread</p>",
        "id": 283067120,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1653052390
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> <a href=\"#narrow/stream/270676-lean4/topic/Definition.20Macro.3F/near/283067120\">said</a>:</p>\n<blockquote>\n<p>I believe you posted on the wrong thread</p>\n</blockquote>\n<p>I don't think so, because this has something to do with the definition macro</p>",
        "id": 283067297,
        "sender_full_name": "Joseph O",
        "timestamp": 1653052482
    },
    {
        "content": "<p>As when it is uncommented (the <code>add</code> function), it breaks <code>test3</code></p>",
        "id": 283067330,
        "sender_full_name": "Joseph O",
        "timestamp": 1653052501
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> please</p>",
        "id": 283067369,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1653052525
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> <a href=\"#narrow/stream/270676-lean4/topic/Definition.20Macro.3F/near/283067369\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> please</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">syntax</span> <span class=\"n\">binder</span> <span class=\"o\">:=</span> <span class=\"n\">ident</span> <span class=\"s2\">\" := \"</span> <span class=\"n\">term</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"let\"</span> <span class=\"n\">binder</span><span class=\"o\">,</span><span class=\"bp\">+</span> <span class=\"s2\">\" in \"</span> <span class=\"n\">term</span> <span class=\"o\">:</span> <span class=\"n\">term</span>\n\n<span class=\"n\">macro_rules</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">let</span> <span class=\"bp\">$</span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">:=</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"k\">in</span> <span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">let</span> <span class=\"bp\">$</span><span class=\"n\">name</span> <span class=\"o\">:=</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"bp\">;</span> <span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">let</span> <span class=\"bp\">$</span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">:=</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">,</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder</span><span class=\"o\">,</span><span class=\"bp\">*</span> <span class=\"k\">in</span> <span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">let</span> <span class=\"bp\">$</span><span class=\"n\">name</span> <span class=\"o\">:=</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"bp\">;</span> <span class=\"k\">let</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder</span><span class=\"o\">,</span><span class=\"bp\">*</span> <span class=\"k\">in</span> <span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span>\n\n<span class=\"n\">syntax</span> <span class=\"n\">binder</span> <span class=\"o\">:=</span> <span class=\"s2\">\"[\"</span> <span class=\"n\">ident</span> <span class=\"n\">term</span> <span class=\"s2\">\"]\"</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"(\"</span> <span class=\"s2\">\"define\"</span> <span class=\"s2\">\"(\"</span> <span class=\"n\">binder</span><span class=\"bp\">+</span> <span class=\"s2\">\")\"</span> <span class=\"n\">term</span> <span class=\"s2\">\")\"</span> <span class=\"o\">:</span> <span class=\"n\">command</span>\n\n<span class=\"n\">macro_rules</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">])</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kd\">def</span> <span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">:</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"bp\">→</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"o\">:=</span> <span class=\"k\">fun</span> <span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"bp\">→</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"k\">fun</span> <span class=\"bp\">$</span><span class=\"n\">nm</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">test3</span> <span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span>\n  <span class=\"k\">let</span> <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">2</span><span class=\"o\">],</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"k\">in</span> <span class=\"n\">x</span> <span class=\"bp\">++</span> <span class=\"n\">y</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">test3</span> <span class=\"c1\">-- [1, 2, 3, 4]</span>\n\n<span class=\"c1\">-- try commenting and uncommenting this line, and see what happens to the eval</span>\n<span class=\"o\">(</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"n\">add</span> <span class=\"n\">Nat</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">x</span> <span class=\"n\">Nat</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">y</span> <span class=\"n\">Nat</span><span class=\"o\">])</span> <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 283070062,
        "sender_full_name": "Joseph O",
        "timestamp": 1653053698
    },
    {
        "content": "<p>There's a conflict with the declaration of <code>binder</code></p>",
        "id": 283070599,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1653053903
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> <a href=\"#narrow/stream/270676-lean4/topic/Definition.20Macro.3F/near/283070599\">said</a>:</p>\n<blockquote>\n<p>There's a conflict with the declaration of <code>binder</code></p>\n</blockquote>\n<p>Oh I see</p>",
        "id": 283070638,
        "sender_full_name": "Joseph O",
        "timestamp": 1653053917
    },
    {
        "content": "<p>I renamed them and I still get the same error</p>",
        "id": 283070953,
        "sender_full_name": "Joseph O",
        "timestamp": 1653054040
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"467926\">Joseph O</span> <a href=\"#narrow/stream/270676-lean4/topic/Definition.20Macro.3F/near/283066800\">said</a>:</p>\n<blockquote>\n<p>Hm can someone explain this weird behavior?<br>\n<a href=\"/user_uploads/3121/gsoDTwnvvwOyVsyUUq_bRhc0/image.png\">image.png</a> <br>\n<a href=\"/user_uploads/3121/sscpr5FgCNQwdVtinZ3vBsTu/image.png\">image.png</a></p>\n</blockquote>\n<p>I got similar errors.  I think Lean is interpreting <code>(define ...)</code> as a term to which test3 is applied.  See if the error goes away if you put <code>section end</code> between the <code>#eval</code> and <code>(define ...)</code>.<br>\nAs for how to make <code>(define ...)</code> recognised as a separate command, I don't know.</p>",
        "id": 283071945,
        "sender_full_name": "Raghuram",
        "timestamp": 1653054421
    },
    {
        "content": "<p>Wait; are you not getting any errors on the <code>(define ...)</code> line when it's uncommented?  That's different from what I got.</p>",
        "id": 283072207,
        "sender_full_name": "Raghuram",
        "timestamp": 1653054523
    },
    {
        "content": "<p>Apparently the parens from <code>(define ⋯</code> is causing the confusion. This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">syntax</span> <span class=\"n\">binder</span> <span class=\"o\">:=</span> <span class=\"n\">ident</span> <span class=\"s2\">\" := \"</span> <span class=\"n\">term</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"let \"</span> <span class=\"n\">binder</span><span class=\"o\">,</span><span class=\"bp\">+</span> <span class=\"s2\">\" in \"</span> <span class=\"n\">term</span> <span class=\"o\">:</span> <span class=\"n\">term</span>\n\n<span class=\"n\">macro_rules</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">let</span> <span class=\"bp\">$</span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">:=</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"k\">in</span> <span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">let</span> <span class=\"bp\">$</span><span class=\"n\">name</span> <span class=\"o\">:=</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"bp\">;</span> <span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">let</span> <span class=\"bp\">$</span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">:=</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">,</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder</span><span class=\"o\">,</span><span class=\"bp\">*</span> <span class=\"k\">in</span> <span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">let</span> <span class=\"bp\">$</span><span class=\"n\">name</span> <span class=\"o\">:=</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"bp\">;</span> <span class=\"k\">let</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder</span><span class=\"o\">,</span><span class=\"bp\">*</span> <span class=\"k\">in</span> <span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span>\n\n<span class=\"n\">syntax</span> <span class=\"n\">binder'</span> <span class=\"o\">:=</span> <span class=\"s2\">\"[\"</span> <span class=\"n\">ident</span> <span class=\"n\">term</span> <span class=\"s2\">\"]\"</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"⦃\"</span> <span class=\"s2\">\"define\"</span> <span class=\"s2\">\"(\"</span> <span class=\"n\">binder'</span><span class=\"bp\">+</span> <span class=\"s2\">\")\"</span> <span class=\"n\">term</span> <span class=\"s2\">\"⦄\"</span> <span class=\"o\">:</span> <span class=\"n\">command</span>\n\n<span class=\"n\">macro_rules</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(⦃</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">])</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">⦄)</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kd\">def</span> <span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"o\">:</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"bp\">→</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"o\">:=</span> <span class=\"k\">fun</span> <span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(⦃</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder'</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">⦄)</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"bp\">`</span><span class=\"o\">(⦃</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span> <span class=\"bp\">→</span> <span class=\"bp\">$</span><span class=\"n\">ty'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span> <span class=\"bp\">$</span><span class=\"n\">bs</span><span class=\"o\">:</span><span class=\"n\">binder'</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"k\">fun</span> <span class=\"bp\">$</span><span class=\"n\">nm</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">⦄)</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">test3</span> <span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span>\n  <span class=\"k\">let</span> <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">2</span><span class=\"o\">],</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"k\">in</span> <span class=\"n\">x</span> <span class=\"bp\">++</span> <span class=\"n\">y</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">test3</span> <span class=\"c1\">-- [1, 2, 3, 4] works</span>\n\n<span class=\"o\">⦃</span><span class=\"n\">define</span> <span class=\"o\">([</span><span class=\"n\">add</span> <span class=\"n\">Nat</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">x</span> <span class=\"n\">Nat</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">y</span> <span class=\"n\">Nat</span><span class=\"o\">])</span> <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"n\">y</span><span class=\"o\">⦄</span> <span class=\"c1\">-- works</span>\n</code></pre></div>",
        "id": 283072610,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1653054706
    }
]