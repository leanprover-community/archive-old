[
    {
        "content": "<p>I was writing up some code for an indexed monad (m i j a) and was surprised that Lean accepted my definition of an IMonad instance for it. After some tests it seems like the type of IMonad.bind is \"wrong\" in that it doesn't match the type I would expect. I made an <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> using the common \"you can't open a door twice\" example indexed monad:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">DoorState</span> <span class=\"n\">where</span>\n<span class=\"bp\">|</span> <span class=\"n\">DoorOpen</span>\n<span class=\"bp\">|</span> <span class=\"n\">DoorClosed</span>\n\n<span class=\"kn\">open</span> <span class=\"n\">DoorState</span>\n\n<span class=\"c1\">-- i is \"input\" state and o is the \"output\" state</span>\n<span class=\"kd\">def</span> <span class=\"n\">DoorMonad</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"n\">DoorState</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">o</span> <span class=\"o\">:</span> <span class=\"n\">DoorState</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">α</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">pureDoor</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">DoorMonad</span> <span class=\"n\">DoorOpen</span> <span class=\"n\">DoorOpen</span> <span class=\"n\">α</span> <span class=\"o\">:=</span> <span class=\"n\">id</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">bindDoor</span> <span class=\"o\">:</span> <span class=\"n\">DoorMonad</span> <span class=\"n\">i₁</span> <span class=\"n\">i₂</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">DoorMonad</span> <span class=\"n\">i₂</span> <span class=\"n\">i₃</span> <span class=\"n\">β</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">DoorMonad</span> <span class=\"n\">i₁</span> <span class=\"n\">i₃</span> <span class=\"n\">β</span> <span class=\"o\">:=</span> <span class=\"k\">fun</span> <span class=\"n\">m</span> <span class=\"n\">f</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">f</span> <span class=\"n\">m</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">Monad</span> <span class=\"o\">(</span><span class=\"n\">DoorMonad</span> <span class=\"n\">i</span> <span class=\"n\">o</span><span class=\"o\">)</span> <span class=\"n\">where</span>\n  <span class=\"n\">pure</span> <span class=\"o\">:=</span> <span class=\"n\">pureDoor</span>\n  <span class=\"n\">bind</span> <span class=\"o\">:=</span> <span class=\"n\">bindDoor</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">startOpen</span> <span class=\"o\">:</span> <span class=\"n\">DoorMonad</span> <span class=\"n\">DoorOpen</span> <span class=\"n\">DoorOpen</span> <span class=\"n\">Unit</span> <span class=\"o\">:=</span> <span class=\"o\">()</span>\n<span class=\"kd\">def</span> <span class=\"n\">startClosed</span> <span class=\"o\">:</span> <span class=\"n\">DoorMonad</span> <span class=\"n\">DoorClosed</span> <span class=\"n\">DoorClosed</span> <span class=\"n\">Unit</span> <span class=\"o\">:=</span> <span class=\"o\">()</span>\n<span class=\"kd\">def</span> <span class=\"n\">closeDoor</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">DoorMonad</span> <span class=\"n\">DoorOpen</span> <span class=\"n\">DoorClosed</span> <span class=\"n\">α</span> <span class=\"o\">:=</span> <span class=\"n\">id</span>\n<span class=\"kd\">def</span> <span class=\"n\">openDoor</span>  <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">DoorMonad</span> <span class=\"n\">DoorClosed</span> <span class=\"n\">DoorOpen</span> <span class=\"n\">α</span> <span class=\"o\">:=</span> <span class=\"n\">id</span>\n\n<span class=\"c1\">-- I would expect all these to have type \"DoorMonad DoorOpen DoorClosed Unit\"</span>\n<span class=\"k\">#check</span> <span class=\"n\">bindDoor</span> <span class=\"n\">startOpen</span> <span class=\"n\">closeDoor</span>      <span class=\"c1\">-- DoorMonad DoorOpen DoorClosed Unit</span>\n<span class=\"k\">#check</span> <span class=\"n\">bind</span>     <span class=\"n\">startOpen</span> <span class=\"n\">closeDoor</span>      <span class=\"c1\">-- DoorMonad DoorOpen DoorOpen Unit</span>\n<span class=\"k\">#check</span>          <span class=\"n\">startOpen</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">closeDoor</span>  <span class=\"c1\">-- DoorMonad DoorOpen DoorOpen Unit</span>\n\n<span class=\"c1\">-- correct constructions where monad input/outputs match up</span>\n<span class=\"k\">#eval</span> <span class=\"n\">bindDoor</span> <span class=\"o\">(</span><span class=\"n\">bindDoor</span> <span class=\"n\">startClosed</span> <span class=\"n\">openDoor</span><span class=\"o\">)</span> <span class=\"n\">closeDoor</span>\n<span class=\"k\">#eval</span> <span class=\"n\">bind</span>     <span class=\"o\">(</span><span class=\"n\">bind</span>     <span class=\"n\">startClosed</span> <span class=\"n\">openDoor</span><span class=\"o\">)</span> <span class=\"n\">closeDoor</span>\n\n<span class=\"c1\">-- these should be errors due to bad type matching (can't open a door twice in a row)</span>\n<span class=\"k\">#eval</span> <span class=\"n\">bindDoor</span> <span class=\"o\">(</span><span class=\"n\">bindDoor</span> <span class=\"n\">startClosed</span> <span class=\"n\">openDoor</span><span class=\"o\">)</span> <span class=\"n\">openDoor</span>     <span class=\"c1\">-- fails</span>\n<span class=\"k\">#eval</span> <span class=\"n\">bind</span>     <span class=\"o\">(</span><span class=\"n\">bind</span>     <span class=\"n\">startClosed</span> <span class=\"n\">openDoor</span><span class=\"o\">)</span> <span class=\"n\">openDoor</span>     <span class=\"c1\">-- no error</span>\n<span class=\"k\">#eval</span> <span class=\"n\">startClosed</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">openDoor</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">openDoor</span>                 <span class=\"c1\">-- no error</span>\n</code></pre></div>\n<p>I'm not sure if this is a bug or if I'm incorrectly interpreting the IMonad instance. I figured that I wouldn't be able to define bind for an indexed monad at all, since the type of <code>bindDoor</code> isn't strictly the same as the type of <code>bind</code>,</p>",
        "id": 284529372,
        "sender_full_name": "Gary Haussmann",
        "timestamp": 1654026881
    },
    {
        "content": "<p>Lean can unfold the definition to see that <code>DoorMonad i o</code> is definitionally equal to <code>DoorMonad i' o'</code> for any <code>i</code>, <code>o</code>, <code>i'</code>, <code>o'</code>, so all these variations will type check.</p>",
        "id": 284529892,
        "sender_full_name": "Reid Barton",
        "timestamp": 1654027207
    },
    {
        "content": "<p>If you make <code>DoorMonad</code> a <code>structure</code> or something then you should get the behavior you expect (the <code>Monad (DoorMonad i o)</code> instance will be rejected).</p>",
        "id": 284530137,
        "sender_full_name": "Reid Barton",
        "timestamp": 1654027322
    }
]