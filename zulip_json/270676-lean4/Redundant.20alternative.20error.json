[
    {
        "content": "<p>Why does the last line produce a \"redundant alternative error\"? I think that the alternative is not redundant. Moreover, why swapping the last two lines make the error go away?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"c1\">-- Positive number literal</span>\n<span class=\"n\">declare_syntax_cat</span> <span class=\"n\">adig</span>\n<span class=\"n\">declare_syntax_cat</span> <span class=\"n\">apos</span>\n\n<span class=\"n\">syntax</span> <span class=\"s2\">\"⋄\"</span> <span class=\"o\">:</span> <span class=\"n\">adig</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"‡\"</span> <span class=\"o\">:</span> <span class=\"n\">adig</span>\n<span class=\"n\">syntax</span> <span class=\"n\">adig</span> <span class=\"o\">:</span> <span class=\"n\">apos</span>\n<span class=\"n\">syntax</span> <span class=\"n\">apos</span> <span class=\"n\">adig</span> <span class=\"o\">:</span> <span class=\"n\">apos</span>\n\n<span class=\"c1\">-- Arithmetic Expression</span>\n<span class=\"n\">declare_syntax_cat</span> <span class=\"n\">aexp</span>\n\n<span class=\"n\">syntax</span> <span class=\"n\">apos</span> <span class=\"o\">:</span> <span class=\"n\">aexp</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"⌢\"</span> <span class=\"n\">apos</span> <span class=\"o\">:</span> <span class=\"n\">aexp</span>\n<span class=\"n\">syntax</span> <span class=\"n\">aexp</span> <span class=\"s2\">\"⊹\"</span> <span class=\"o\">:</span> <span class=\"n\">aexp</span>\n<span class=\"n\">syntax</span> <span class=\"n\">aexp</span> <span class=\"s2\">\"⁻¹\"</span> <span class=\"o\">:</span> <span class=\"n\">aexp</span>\n\n<span class=\"c1\">-- Continuation</span>\n<span class=\"n\">declare_syntax_cat</span> <span class=\"n\">contelem</span>\n<span class=\"n\">declare_syntax_cat</span> <span class=\"n\">cont</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"|\"</span> <span class=\"n\">aexp</span> <span class=\"s2\">\"]\"</span> <span class=\"o\">:</span> <span class=\"n\">contelem</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"&amp;neg\"</span> <span class=\"o\">:</span> <span class=\"n\">contelem</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"&amp;⊹\"</span> <span class=\"o\">:</span> <span class=\"n\">contelem</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"&amp;⁻¹\"</span> <span class=\"o\">:</span> <span class=\"n\">contelem</span>\n<span class=\"n\">syntax</span> <span class=\"n\">contelem</span><span class=\"bp\">+</span> <span class=\"o\">:</span> <span class=\"n\">cont</span>\n\n<span class=\"n\">syntax</span> <span class=\"s2\">\"`[teval\"</span> <span class=\"n\">cont</span> <span class=\"o\">:</span> <span class=\"n\">term</span>\n\n\n<span class=\"c1\">-- Executing continuation, ⊹</span>\n<span class=\"n\">macro_rules</span>\n<span class=\"bp\">|`</span><span class=\"o\">(</span><span class=\"bp\">`</span><span class=\"o\">[</span><span class=\"n\">teval</span> <span class=\"bp\">|⌢$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">apos</span><span class=\"o\">]</span> <span class=\"bp\">&amp;⁻¹</span> <span class=\"bp\">$</span><span class=\"n\">ct</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">`</span><span class=\"o\">[</span><span class=\"n\">teval</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">apos</span><span class=\"o\">]</span> <span class=\"bp\">&amp;⊹</span> <span class=\"bp\">&amp;</span><span class=\"n\">neg</span> <span class=\"bp\">$</span><span class=\"n\">ct</span><span class=\"bp\">*</span><span class=\"o\">)</span>\n<span class=\"bp\">|`</span><span class=\"o\">(</span><span class=\"bp\">`</span><span class=\"o\">[</span><span class=\"n\">teval</span> <span class=\"bp\">|⌢⋄</span><span class=\"o\">]</span> <span class=\"bp\">&amp;⊹</span> <span class=\"bp\">$</span><span class=\"n\">ct</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">`</span><span class=\"o\">[</span><span class=\"n\">teval</span> <span class=\"bp\">|‡</span><span class=\"o\">]</span> <span class=\"bp\">$</span><span class=\"n\">ct</span><span class=\"bp\">*</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 301275172,
        "sender_full_name": "Yicheng Qian",
        "timestamp": 1664382338
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span> <span class=\"n\">adig</span>\n<span class=\"n\">declare_syntax_cat</span> <span class=\"n\">apos</span>\n\n<span class=\"n\">syntax</span> <span class=\"s2\">\"⋄\"</span> <span class=\"o\">:</span> <span class=\"n\">adig</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"‡\"</span> <span class=\"o\">:</span> <span class=\"n\">adig</span>\n<span class=\"n\">syntax</span> <span class=\"n\">adig</span> <span class=\"o\">:</span> <span class=\"n\">apos</span>\n<span class=\"n\">syntax</span> <span class=\"n\">apos</span> <span class=\"n\">adig</span> <span class=\"o\">:</span> <span class=\"n\">apos</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"`[|\"</span> <span class=\"n\">apos</span> <span class=\"s2\">\",\"</span> <span class=\"n\">adig</span> <span class=\"s2\">\"]\"</span> <span class=\"o\">:</span> <span class=\"n\">term</span>\n\n<span class=\"n\">macro_rules</span>\n<span class=\"bp\">|`</span><span class=\"o\">(</span><span class=\"bp\">`</span><span class=\"o\">[</span><span class=\"bp\">|$</span><span class=\"n\">_</span><span class=\"o\">:</span><span class=\"n\">apos</span><span class=\"o\">,</span> <span class=\"bp\">⋄</span><span class=\"o\">])</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"bp\">|`</span><span class=\"o\">(</span><span class=\"bp\">`</span><span class=\"o\">[</span><span class=\"bp\">|⋄</span><span class=\"o\">,</span> <span class=\"bp\">‡</span><span class=\"o\">])</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 301352217,
        "sender_full_name": "Yicheng Qian",
        "timestamp": 1664412657
    },
    {
        "content": "<p>I think this is difficult for the current syntax match to support. You should write the second alternative first</p>",
        "id": 301352720,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1664413161
    },
    {
        "content": "<p>Another option is to reorder the match order:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">macro_rules</span>\n<span class=\"bp\">|`</span><span class=\"o\">(</span><span class=\"bp\">`</span><span class=\"o\">[</span><span class=\"bp\">|$</span><span class=\"n\">a</span><span class=\"o\">,</span> <span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">])</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">match</span> <span class=\"n\">b</span><span class=\"o\">,</span> <span class=\"n\">a</span> <span class=\"k\">with</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">adig</span><span class=\"bp\">|</span> <span class=\"bp\">⋄</span><span class=\"o\">),</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">adig</span><span class=\"bp\">|</span> <span class=\"bp\">‡</span><span class=\"o\">),</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">apos</span><span class=\"bp\">|</span> <span class=\"bp\">⋄</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">Macro.throwUnsupported</span>\n</code></pre></div>",
        "id": 301352863,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1664413309
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 301354051,
        "sender_full_name": "Yicheng Qian",
        "timestamp": 1664414472
    },
    {
        "content": "<p>Using <code>match</code> seems to be more flexible.</p>",
        "id": 301354053,
        "sender_full_name": "Yicheng Qian",
        "timestamp": 1664414479
    },
    {
        "content": "<p>I'm also getting a <code>redundant alternative #2</code> error, and strangely it seems to be tied to the presence of the syntax category in the match:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">syntax</span> <span class=\"n\">myParser</span> <span class=\"o\">:=</span> <span class=\"s2\">\"aa\"</span> <span class=\"bp\">&lt;|&gt;</span> <span class=\"s2\">\"bb\"</span>\n\n<span class=\"c1\">-- Error:</span>\n<span class=\"kd\">def</span> <span class=\"n\">getMyParserState</span> <span class=\"o\">:</span> <span class=\"n\">TSyntax</span> <span class=\"bp\">`</span><span class=\"n\">myParser</span> <span class=\"bp\">-&gt;</span> <span class=\"n\">Bool</span>\n<span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myParser</span><span class=\"bp\">|</span><span class=\"n\">aa</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">true</span>\n<span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myParser</span><span class=\"bp\">|</span><span class=\"n\">bb</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">false</span> <span class=\"c1\">-- redundant alternative #2</span>\n<span class=\"bp\">|</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">unreachable</span><span class=\"bp\">!</span>\n\n<span class=\"c1\">-- Error:</span>\n<span class=\"kd\">def</span> <span class=\"n\">getMyParserState'</span> <span class=\"o\">:</span> <span class=\"n\">TSyntax</span> <span class=\"bp\">`</span><span class=\"n\">myParser</span> <span class=\"bp\">-&gt;</span> <span class=\"n\">Bool</span>\n<span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myParser</span><span class=\"bp\">|$</span><span class=\"n\">stx</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">match</span> <span class=\"n\">stx</span> <span class=\"k\">with</span> <span class=\"c1\">-- same behavior if using `($stx)</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myParser</span><span class=\"bp\">|</span><span class=\"n\">aa</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">true</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myParser</span><span class=\"bp\">|</span><span class=\"n\">bb</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">false</span> <span class=\"c1\">-- redundant alternative #2</span>\n  <span class=\"bp\">|</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">unreachable</span><span class=\"bp\">!</span>\n\n<span class=\"c1\">-- No error:</span>\n<span class=\"kd\">def</span> <span class=\"n\">getMyParserState''</span> <span class=\"o\">:</span> <span class=\"n\">TSyntax</span> <span class=\"bp\">`</span><span class=\"n\">myParser</span> <span class=\"bp\">-&gt;</span> <span class=\"n\">Bool</span>\n<span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myParser</span><span class=\"bp\">|$</span><span class=\"n\">stx</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">match</span> <span class=\"n\">stx</span> <span class=\"k\">with</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">aa</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">true</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bb</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">false</span>\n  <span class=\"bp\">|</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">unreachable</span><span class=\"bp\">!</span>\n</code></pre></div>\n<p>(The behavior is the same whether using <code>declare_syntax_cat myParser</code> or <code>def myParser := leading_parser ...</code>, and if <code>TSyntax</code> is abandoned in favor of <code>Syntax</code>.)</p>\n<ol>\n<li>Is this a bug?</li>\n<li>Why do I need to include <code>unreachable!</code>? If I leave out the <code>_</code> case, it says \"non-exhaustive match\"...but shouldn't it be able to tell that this is exhaustive?</li>\n</ol>",
        "id": 307853314,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1667515302
    },
    {
        "content": "<p>update your lean install</p>",
        "id": 307853497,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667515394
    },
    {
        "content": "<p>yay! (so satisfying when a bug is fixed by updating <span aria-label=\"octopus\" class=\"emoji emoji-1f419\" role=\"img\" title=\"octopus\">:octopus:</span>)</p>",
        "id": 307853782,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1667515534
    },
    {
        "content": "<p>Your examples all compile on nightly. The reason it used to fail is because syntax match does not make use of the content of atoms, so the first arm would match both <code>aa</code> and <code>bb</code> and the second branch is unreachable. The workaround was to add an additional syntax node like so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">syntax</span> <span class=\"n\">aaStx</span> <span class=\"o\">:=</span> <span class=\"s2\">\"aa\"</span>\n<span class=\"n\">syntax</span> <span class=\"n\">bbStx</span> <span class=\"o\">:=</span> <span class=\"s2\">\"bb\"</span>\n<span class=\"n\">syntax</span> <span class=\"n\">myParser</span> <span class=\"o\">:=</span> <span class=\"n\">aaStx</span> <span class=\"bp\">&lt;|&gt;</span> <span class=\"n\">bbStx</span>\n</code></pre></div>\n<p>Since a few weeks ago this transformation is now done automatically, so syntax match works as expected.</p>",
        "id": 307853985,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667515641
    },
    {
        "content": "<p>The <code>unreachable!</code> case is not formally unreachable, since you can always lie and put some garbage in a <code>TSyntax</code>. More importantly, you always have to be prepared to receive a <code>Syntax.missing</code>, which most parsers will produce if the syntax they were parsing was malformed in some way</p>",
        "id": 307854183,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1667515739
    },
    {
        "content": "<p>Nice, thanks! That explanation is very useful—now I know how to deal with things manually via <code>leading_parser</code> too. :) Ah, that makes sense (re: <code>unreachable!</code>)!</p>",
        "id": 307855148,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1667516198
    }
]