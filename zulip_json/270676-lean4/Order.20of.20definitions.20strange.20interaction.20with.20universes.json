[
    {
        "content": "<p>It's not news that Lean is sensitive to the order in which things get declared, but I found a very strange interaction between this and an error about type universes in the delaborator. Here's a MWE:</p>\n<p>This works perfectly fine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">Foo</span>\n<span class=\"bp\">|</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span>\n\n<span class=\"kd\">inductive</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">foobar</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">somelist</span> <span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"n\">Bar</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n</code></pre></div>\n<p>Whereas if we reverse the order of declaration, i.e.:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">foobar</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">somelist</span> <span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"n\">Bar</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n\n<span class=\"kd\">inductive</span> <span class=\"n\">Foo</span>\n<span class=\"bp\">|</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span>\n</code></pre></div>\n<p>It will give the error: \"failed to compute resulting universe level of inductive datatype, provide universe explicitly\"</p>\n<p>It seems to also need both the mutually inductive construction (here with <code>List Bar</code>) *and * the unresolved type of Foo.  Does someone know what's happening here? Why does it behave differently than, say, <code>def</code>, where something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">Bar</span> <span class=\"o\">:=</span> <span class=\"n\">Foo</span>\n<span class=\"kd\">def</span> <span class=\"n\">Foo</span> <span class=\"o\">:=</span> <span class=\"n\">Nat</span>\n</code></pre></div>\n<p>Lean will complain that it doesn't know the identifier <code>Foo</code>, but </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n<span class=\"kd\">def</span> <span class=\"n\">Foo</span> <span class=\"o\">:=</span> <span class=\"n\">Nat</span>\n</code></pre></div>\n<p>works perfectly fine. Is this a fundamental difference or just part of the WIP nature of Lean4?</p>",
        "id": 281663155,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1652091348
    },
    {
        "content": "<p>In Lean 3, </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">foobar</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">somelist</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">Bar</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n\n<span class=\"kd\">inductive</span> <span class=\"n\">Foo</span>\n<span class=\"bp\">|</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span>\n</code></pre></div>\n<p>just gives an error <code>unknown identifier 'Foo'</code> in the obvious place. Is Lean 4 different in this regard?</p>",
        "id": 281663855,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1652091777
    },
    {
        "content": "<p>It is probably declaring <code>Foo</code> in the <code>Bar</code> definition as an auto implicit type. If you put <code>mutual</code> above and <code>end</code> in the end of your code block it will actually do the mutual definition.</p>",
        "id": 281663907,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1652091830
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/270676-lean4/topic/Order.20of.20definitions.20strange.20interaction.20with.20universes/near/281663855\">said</a>:</p>\n<blockquote>\n<p>In Lean 3, </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">foobar</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">somelist</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">Bar</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n\n<span class=\"kd\">inductive</span> <span class=\"n\">Foo</span>\n<span class=\"bp\">|</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span>\n</code></pre></div>\n<p>just gives an error <code>unknown identifier 'Foo'</code> in the obvious place. Is Lean 4 different in this regard?</p>\n</blockquote>\n<p>yep, Lean4 will complain about universes there. Maybe it's just a bug then?</p>",
        "id": 281663968,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1652091850
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/270676-lean4/topic/Order.20of.20definitions.20strange.20interaction.20with.20universes/near/281663907\">said</a>:</p>\n<blockquote>\n<p>It is probably declaring <code>Foo</code> in the <code>Bar</code> definition as an auto implicit type. If you put <code>mutual</code> above and <code>end</code> in the end of your code block it will actually do the mutual definition.</p>\n</blockquote>\n<p>That makes sense. The mutual thing does actually also get it to work as well. Might be better (more explicit) than changing the order. I guess the whole auto implicit types thing might just be more brittle for now. Thanks for the pointer!</p>",
        "id": 281664326,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1652092129
    },
    {
        "content": "<p>I don't think the feature itself is brittle, the conclusion that it can't determine the desired universe of the auto implicit type is true since you do not give it any information at all about what that universe should be, though you can maybe argue it should indicate that something is wrong with Bar.</p>",
        "id": 281664622,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1652092345
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/270676-lean4/topic/Order.20of.20definitions.20strange.20interaction.20with.20universes/near/281663855\">said</a>:</p>\n<blockquote>\n<p>Is Lean 4 different in this regard?</p>\n</blockquote>\n<p>Yes, it is. <br>\nJust to make explicit what <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> wrote about auto-implicit behavior above:<br>\nIf <code>Foo</code> isn't a known type, then Lean 4 interprets the  following definition of <code>Bar</code> as:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">foobar</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n\n<span class=\"k\">#print</span> <span class=\"n\">Bar.foobar</span> <span class=\"c1\">-- constructor Bar.foobar.{u_1} : {Foo : Sort u_1} → Foo → Bar</span>\n</code></pre></div>\n<p>That is, the <code>Foo</code> automatically becomes an implicit parameter (of type <code>Sort u_1</code>) to the <code>foobar</code> constructor.<br>\nIf <code>Foo</code> is a known type, it has the \"regular\" behavior:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">Foo</span>\n\n<span class=\"kd\">inductive</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">foobar</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span>\n\n<span class=\"k\">#print</span> <span class=\"n\">Bar.foobar</span> <span class=\"c1\">-- constructor Bar.foobar: Foo → Bar</span>\n</code></pre></div>",
        "id": 281673056,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1652097835
    },
    {
        "content": "<p>This prevents Lean from creating implicit parameters automatically:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span> <span class=\"n\">autoImplicit</span> <span class=\"n\">false</span>\n\n<span class=\"kd\">inductive</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">foobar</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span> <span class=\"c1\">-- unknown identifier 'Foo'</span>\n</code></pre></div>\n<p>Or if you don't want that behavior in a particular declaration:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span> <span class=\"n\">autoImplicit</span> <span class=\"n\">false</span> <span class=\"k\">in</span>\n<span class=\"kd\">inductive</span> <span class=\"n\">Bar</span>\n<span class=\"bp\">|</span> <span class=\"n\">foobar</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"bp\">→</span> <span class=\"n\">Bar</span> <span class=\"c1\">-- unknown identifier 'Foo'</span>\n</code></pre></div>",
        "id": 281674111,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1652098390
    },
    {
        "content": "<p>We will try to improve the error message. <br>\nBTW, in most color themes, variables and constants are highlighted using different colors.<br>\n<a href=\"/user_uploads/3121/mRpJxHLNuqvp1QyTCjBy9GIq/image.png\">image.png</a><br>\n<a href=\"/user_uploads/3121/ti7IsT1Yg7yREntDNLPcsSxm/image.png\">image.png</a> <br>\nNote that in the second picture, <code>Foo</code> is blue because it has <strong>not</strong> been interpreted as a constant.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/mRpJxHLNuqvp1QyTCjBy9GIq/image.png\" title=\"image.png\"><img src=\"/user_uploads/3121/mRpJxHLNuqvp1QyTCjBy9GIq/image.png\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/3121/ti7IsT1Yg7yREntDNLPcsSxm/image.png\" title=\"image.png\"><img src=\"/user_uploads/3121/ti7IsT1Yg7yREntDNLPcsSxm/image.png\"></a></div>",
        "id": 281677577,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1652100203
    }
]