[
    {
        "content": "<p>I've been spending the past few days working on a simple and rudimentary programming language. I'm using Lean 4 to build an interpreter.</p>\n<p>The thing is: I am struggling with the parser. I tried looking at <code>Parsec</code> but I couldn't understand how to use it in a way that wouldn't be too laborious. <a href=\"https://github.com/arthurpaulino/FunnyLang/blob/master/FunnyLang/FunnyParser.lean\">This</a> is how the parser is implemented at the moment. And I'm afraid things are going very sideways at this point.</p>\n<p>This is an example of what I'm trying to parse:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">a</span> <span class=\"o\">:=</span> <span class=\"mi\">4</span>         <span class=\"c1\"># int</span>\n<span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"n\">x</span> <span class=\"o\">+</span> <span class=\"n\">y</span> <span class=\"c1\"># function _ → _ → _</span>\n<span class=\"n\">fa</span> <span class=\"o\">:=</span> <span class=\"n\">f</span> <span class=\"n\">a</span>      <span class=\"c1\"># function int → int</span>\n<span class=\"n\">fa3</span> <span class=\"o\">:=</span> <span class=\"n\">fa</span> <span class=\"mi\">3</span>    <span class=\"c1\"># 7 : int</span>\n<span class=\"n\">g</span> <span class=\"n\">n</span> <span class=\"o\">:=</span>\n  <span class=\"n\">s</span> <span class=\"o\">:=</span> <span class=\"mi\">0</span>\n  <span class=\"k\">while</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span>\n    <span class=\"n\">s</span> <span class=\"o\">:=</span> <span class=\"n\">s</span> <span class=\"o\">+</span> <span class=\"n\">n</span>\n    <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"n\">n</span> <span class=\"o\">-</span> <span class=\"mi\">1</span>\n  <span class=\"n\">s</span>\n<span class=\"nb\">print</span> <span class=\"n\">g</span> <span class=\"mi\">5</span>      <span class=\"c1\"># 15</span>\n</code></pre></div>\n<p>Ideas and feedback are very much welcome <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span></p>",
        "id": 277222369,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648689524
    },
    {
        "content": "<p>Have you considered using Lean's own extensible <code>Syntax</code>? For example as in <a href=\"https://github.com/leanprover/lean4/blob/2bd04285f86b22fc44ce69a1846f81a569fc438b/doc/tutorial/metaprogramming-arith.md\">here</a> and the webserver <a href=\"https://github.com/leanprover/lean4/blob/2bd04285f86b22fc44ce69a1846f81a569fc438b/tests/playground/webserver/Webserver.lean#L93\">demo</a>. Also the <code>do</code> notation <a href=\"https://github.com/leanprover/lean4/blob/2bd04285f86b22fc44ce69a1846f81a569fc438b/src/Lean/Parser/Do.lean#L21\">definitions</a> have an imperative flavour similar to your language.</p>",
        "id": 277226408,
        "sender_full_name": "Wojciech Nawrocki",
        "timestamp": 1648694464
    },
    {
        "content": "<p>Will take a look tomorrow for sure. I always thought of <code>Syntax</code> as something exclusive for Lean's own compiler</p>",
        "id": 277226539,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648694623
    },
    {
        "content": "<p>My main difficulty is extracting data from a formatted text (a term of type <code>String</code>) without regex</p>",
        "id": 277226780,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648694857
    },
    {
        "content": "<p>It's not all pretty, but it's possible to use Lean's parser outside of Lean, yes. Lean 4 Leanpkg used to do this to parse TOML files: <a href=\"https://github.com/leanprover/lean4/blob/2b7427c962ddab1fc28c9b1f933947b5f7cd60cb/src/Leanpkg/Toml.lean\">https://github.com/leanprover/lean4/blob/2b7427c962ddab1fc28c9b1f933947b5f7cd60cb/src/Leanpkg/Toml.lean</a></p>",
        "id": 277243850,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1648712542
    },
    {
        "content": "<p>This should get nicer in the future when we have <code>builtin syntax</code> for syntax compiled into the binary (currently covered by <code>leading_parser</code> etc.) and per-category token sets.</p>",
        "id": 277244033,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1648712707
    },
    {
        "content": "<p>Huh, I was scared of that approach. Am I mistaken or that program loads up the TOML file as a Lean file (hence the \"HACKHACKHACK\")?<br>\nI will seek other solutions for now then. Maybe something useful comes out of it</p>",
        "id": 277261554,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648723468
    },
    {
        "content": "<p>I don't think it is necessary to load the file as a lean file, you should be able to create and call the <code>Parser</code> directly</p>",
        "id": 277261612,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648723521
    },
    {
        "content": "<p>the simplest solution is if you can literally embed the syntax in a lean file, headed by a macro or something</p>",
        "id": 277261752,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648723590
    },
    {
        "content": "<p>If this is possible, then I most likely can take care of the rest:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">MyType</span>\n  <span class=\"bp\">|</span> <span class=\"n\">num</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"bp\">→</span> <span class=\"n\">MyType</span>\n  <span class=\"bp\">|</span> <span class=\"n\">op</span>  <span class=\"o\">:</span> <span class=\"n\">MyType</span> <span class=\"bp\">→</span> <span class=\"n\">MyType</span> <span class=\"bp\">→</span> <span class=\"n\">MyType</span>\n  <span class=\"n\">deriving</span> <span class=\"n\">Repr</span>\n\n<span class=\"n\">declare_syntax_cat</span> <span class=\"n\">mytype</span>\n<span class=\"n\">syntax</span> <span class=\"n\">num</span> <span class=\"o\">:</span> <span class=\"n\">mytype</span>\n<span class=\"n\">syntax</span> <span class=\"n\">num</span> <span class=\"s2\">\" !! \"</span> <span class=\"n\">num</span> <span class=\"o\">:</span> <span class=\"n\">mytype</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">parseMyType</span> <span class=\"o\">(</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">String</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">MyType</span> <span class=\"o\">:=</span> <span class=\"gr\">sorry</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">parseMyType</span> <span class=\"s2\">\"3\"</span>      <span class=\"c1\">-- MyType.num 3</span>\n<span class=\"k\">#eval</span> <span class=\"n\">parseMyType</span> <span class=\"s2\">\"4 !! 5\"</span> <span class=\"c1\">-- MyType.op (MyType.num 4) (MyType.num 5)</span>\n</code></pre></div>",
        "id": 277262152,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648723858
    },
    {
        "content": "<p>do you mind if it lives in a monad, say <code>MetaM</code>?</p>",
        "id": 277262355,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648723971
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> <a href=\"#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/277261554\">said</a>:</p>\n<blockquote>\n<p>that program loads up the TOML file as a Lean file</p>\n</blockquote>\n<p>No, the file is parsed in the category <code>file</code> defined above <a href=\"https://github.com/leanprover/lean4/blob/2b7427c962ddab1fc28c9b1f933947b5f7cd60cb/src/Leanpkg/Toml.lean#L60\">https://github.com/leanprover/lean4/blob/2b7427c962ddab1fc28c9b1f933947b5f7cd60cb/src/Leanpkg/Toml.lean#L60</a></p>",
        "id": 277262429,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1648724026
    },
    {
        "content": "<p>I think the first two <code>HACK</code>s are obsolete, we now create antiquotations for syntax abbrevs</p>",
        "id": 277262531,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1648724085
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/277262355\">said</a>:</p>\n<blockquote>\n<p>do you mind if it lives in a monad, say <code>MetaM</code>?</p>\n</blockquote>\n<p>Nope. I already need to be in <code>IO</code> because I have to read a file. And I remember lifting a <code>MetaM</code> monad from IO</p>",
        "id": 277262625,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648724149
    },
    {
        "content": "<p>if you need to lift from <code>IO</code> to <code>MetaM</code>, keep in mind that you need an environment that contains those <code>syntax</code> declarations</p>",
        "id": 277262736,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648724198
    },
    {
        "content": "<p>in the example this is done using <code>importModules [{ module := `Leanpkg.Toml }] {}</code></p>",
        "id": 277262774,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648724227
    },
    {
        "content": "<p>where the syntax declarations are in <code>Leanpkg.Toml</code></p>",
        "id": 277262797,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648724240
    },
    {
        "content": "<p>I don't understand it. Is <code>Leanpkg.Toml</code> on that very same file?</p>",
        "id": 277263017,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648724367
    },
    {
        "content": "<p>(I ask this because I see <code>namespace Toml</code>)</p>",
        "id": 277263050,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648724385
    },
    {
        "content": "<p>yes, <code>Leanpkg.Toml</code> is the file itself</p>",
        "id": 277263136,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648724410
    },
    {
        "content": "<p>this is a lean file that at runtime reads the olean file it created at compile time</p>",
        "id": 277263218,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648724432
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/277262355\">said</a>:</p>\n<blockquote>\n<p>do you mind if it lives in a monad, say <code>MetaM</code>?</p>\n</blockquote>\n<p>I got the impression that you were about to propose a solution that's simpler than the TOML example. Were you :D ?</p>",
        "id": 277263944,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648724828
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Lean</span>\n<span class=\"kn\">open</span> <span class=\"n\">Lean</span> <span class=\"n\">Parser</span>\n<span class=\"kd\">inductive</span> <span class=\"n\">MyType</span>\n  <span class=\"bp\">|</span> <span class=\"n\">num</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"bp\">→</span> <span class=\"n\">MyType</span>\n  <span class=\"bp\">|</span> <span class=\"n\">op</span>  <span class=\"o\">:</span> <span class=\"n\">MyType</span> <span class=\"bp\">→</span> <span class=\"n\">MyType</span> <span class=\"bp\">→</span> <span class=\"n\">MyType</span>\n  <span class=\"n\">deriving</span> <span class=\"n\">Repr</span>\n\n<span class=\"n\">declare_syntax_cat</span> <span class=\"n\">mytype</span>\n<span class=\"n\">syntax</span> <span class=\"n\">num</span> <span class=\"o\">:</span> <span class=\"n\">mytype</span>\n<span class=\"n\">syntax</span> <span class=\"n\">mytype</span> <span class=\"s2\">\" !! \"</span> <span class=\"n\">mytype</span> <span class=\"o\">:</span> <span class=\"n\">mytype</span>\n\n\n<span class=\"n\">partial</span> <span class=\"kd\">def</span> <span class=\"n\">parseMyType</span> <span class=\"o\">(</span><span class=\"n\">env</span> <span class=\"o\">:</span> <span class=\"n\">Environment</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">String</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Except</span> <span class=\"n\">String</span> <span class=\"n\">MyType</span> <span class=\"o\">:=</span> <span class=\"k\">do</span>\n  <span class=\"k\">let</span> <span class=\"n\">rec</span> <span class=\"n\">parseCore</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">mytype</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">numLit</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">pure</span> <span class=\"bp\">$</span> <span class=\"n\">MyType.num</span> <span class=\"n\">x.toNat</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">mytype</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">a</span> <span class=\"bp\">!!</span> <span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">return</span> <span class=\"n\">MyType.op</span> <span class=\"o\">(</span><span class=\"bp\">←</span> <span class=\"n\">parseCore</span> <span class=\"n\">a</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"bp\">←</span> <span class=\"n\">parseCore</span> <span class=\"n\">b</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">throw</span> <span class=\"s2\">\"parse error\"</span>\n  <span class=\"n\">parseCore</span> <span class=\"o\">(</span><span class=\"bp\">←</span> <span class=\"n\">runParserCategory</span> <span class=\"n\">env</span> <span class=\"bp\">`</span><span class=\"n\">mytype</span> <span class=\"n\">s</span><span class=\"o\">)</span>\n\n<span class=\"k\">#eval</span> <span class=\"k\">show</span> <span class=\"n\">MetaM</span> <span class=\"n\">_</span> <span class=\"k\">from</span> <span class=\"n\">return</span> <span class=\"n\">parseMyType</span> <span class=\"o\">(</span><span class=\"bp\">←</span> <span class=\"n\">getEnv</span><span class=\"o\">)</span> <span class=\"s2\">\"3\"</span>      <span class=\"c1\">-- MyType.num 3</span>\n<span class=\"k\">#eval</span> <span class=\"k\">show</span> <span class=\"n\">MetaM</span> <span class=\"n\">_</span> <span class=\"k\">from</span> <span class=\"n\">return</span> <span class=\"n\">parseMyType</span> <span class=\"o\">(</span><span class=\"bp\">←</span> <span class=\"n\">getEnv</span><span class=\"o\">)</span> <span class=\"s2\">\"4 !! 5\"</span> <span class=\"c1\">-- MyType.op (MyType.num 4) (MyType.num 5)</span>\n</code></pre></div>",
        "id": 277264049,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648724884
    },
    {
        "content": "<p>Holy smokes, let me try using that idea <span aria-label=\"open mouth\" class=\"emoji emoji-1f62e\" role=\"img\" title=\"open mouth\">:open_mouth:</span></p>",
        "id": 277264299,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648725018
    },
    {
        "content": "<p>it even gives kind-of-good error messages</p>",
        "id": 277264377,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648725079
    },
    {
        "content": "<p>It's working!</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">#eval</span> <span class=\"k\">show</span> <span class=\"n\">MetaM</span> <span class=\"n\">_</span> <span class=\"k\">from</span> <span class=\"n\">return</span> <span class=\"n\">parseProgram</span> <span class=\"o\">(</span><span class=\"bp\">←</span> <span class=\"n\">getEnv</span><span class=\"o\">)</span> <span class=\"s2\">\"a := 3; b := a + a; b + 1\"</span>\n<span class=\"c1\">-- Except.ok (Program.attribution</span>\n<span class=\"c1\">--   \"a\"</span>\n<span class=\"c1\">--   (Program.sequence</span>\n<span class=\"c1\">--     (Program.evaluation (Expression.atom (Value.int 3)))</span>\n<span class=\"c1\">--     (Program.attribution</span>\n<span class=\"c1\">--       \"b\"</span>\n<span class=\"c1\">--       (Program.sequence</span>\n<span class=\"c1\">--         (Program.evaluation (Expression.add (Expression.var \"a\") (Expression.var \"a\")))</span>\n<span class=\"c1\">--         (Program.evaluation (Expression.add (Expression.var \"b\") (Expression.atom (Value.int 1))))))))</span>\n</code></pre></div>",
        "id": 277271060,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648728886
    },
    {
        "content": "<p>Although it should start with <code>Program.sequence ...</code>. It's parsing as an attribution of <code>3; b := a + a; b + 1</code> to the variable <code>a</code></p>",
        "id": 277271454,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648729102
    },
    {
        "content": "<p>You should be able to fix this by giving the precedences explicitly</p>",
        "id": 277271633,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1648729205
    },
    {
        "content": "<p>I was able to create the <code>env</code> by doing</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">initSearchPath</span> <span class=\"o\">(</span><span class=\"bp\">←</span> <span class=\"n\">Lean.findSysroot</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"s2\">\"build/lib\"</span><span class=\"o\">]</span>\n<span class=\"k\">let</span> <span class=\"n\">env</span> <span class=\"bp\">←</span> <span class=\"n\">importModules</span> <span class=\"o\">[{</span> <span class=\"n\">module</span> <span class=\"o\">:=</span> <span class=\"bp\">`</span><span class=\"n\">FunnyLang.Parser</span> <span class=\"o\">}]</span> <span class=\"o\">{}</span>\n</code></pre></div>\n<p>But now my binary relies on being inside the repository. Is there a workaround for this?</p>",
        "id": 277301430,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648741631
    },
    {
        "content": "<p>There is one solution, which is keeping a copy of the <code>Parser.lean</code> file as a string and then running Lean's frontend on it to get the env. But I <em>really</em> don't want to touch that</p>",
        "id": 277304938,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648743021
    },
    {
        "content": "<p>You do not need the source file, but you do need the .olean file and those of its dependencies</p>",
        "id": 277305580,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1648743298
    },
    {
        "content": "<p>Does it mean that if I wanted to release a binary for this interpreter, I'd need to release the olean file as well?</p>",
        "id": 277305854,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648743431
    },
    {
        "content": "<p>Is this kind of issue that <code>builtin syntax</code> would solve?</p>",
        "id": 277306027,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648743513
    },
    {
        "content": "<p>yes to both</p>",
        "id": 277306078,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1648743549
    },
    {
        "content": "<p>You could do the latter right now by using <code>Parser</code> instead of <code>syntax</code> like Lean itself does, but it <em>is</em> quite different.</p>",
        "id": 277306135,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1648743582
    },
    {
        "content": "<p>is there an example I can see that's not the Lean 4 parser itself? Maybe some simple test case</p>",
        "id": 277306686,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648743843
    },
    {
        "content": "<p>I don't think so, no. I developed <code>syntax</code> so most people could avoid <code>Parser/leading_parser</code> :)</p>",
        "id": 277306801,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1648743903
    },
    {
        "content": "<p>I'm happy waiting for <code>builtin syntax</code> then (and using this current solution) <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 277306899,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648743955
    },
    {
        "content": "<p>Still on the topic of syntax, I'm not being able to figure this out on my own.<br>\nI believe <a href=\"https://github.com/arthurpaulino/FunnyLang/blob/f6bced8c6b581640ac88c93e0490241c42da0ddc/FunnyLang/Meta.lean#L36\">this line</a> is the culprit.</p>\n<p>I've set up a bunch of tests below <a href=\"https://github.com/arthurpaulino/FunnyLang/blob/f6bced8c6b581640ac88c93e0490241c42da0ddc/FunnyLang/Meta.lean#L115\">this line</a> and I want to define the syntax such that those <code>#assert</code> lines say nothing. Some of them are already passing, but most of them are complaining.</p>\n<p>I'm trying to make the parser understand indentation. But as soon as I use <code>withPosition</code> on the <code>syntax:25 program program : program</code> line, Lean breaks down and the server dies due to some loop that I don't understand.</p>\n<p>As always, guidance is very much appreciated <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span></p>",
        "id": 277506426,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648875078
    },
    {
        "content": "<p>wait, how is <code>syntax:25 program program : program</code> supposed to work? That's just going to cause unbounded recursion</p>",
        "id": 277508241,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648877826
    },
    {
        "content": "<p>is the intention to support newline-separated statements like in <code>by</code> blocks? If so you can look at how <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Parser/Term.lean#L34-L39\">tactic</a> does it</p>",
        "id": 277508306,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648877889
    },
    {
        "content": "<p>the key part there is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.many1indent#src\">src4#Lean.Parser.many1indent</a>, which would be written <code>withPosition(colGe p)</code> in the <code>syntax</code> language</p>",
        "id": 277508448,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648878114
    },
    {
        "content": "<p>Here's a version that works, except that I had to adjust the indentation in <code>p10</code> and <code>p11</code> since all the lines have to line up</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span>                            <span class=\"n\">value</span>\n<span class=\"n\">syntax</span> <span class=\"o\">(</span><span class=\"s2\">\"-\"</span> <span class=\"n\">noWs</span><span class=\"o\">)</span><span class=\"bp\">?</span> <span class=\"n\">num</span>                      <span class=\"o\">:</span> <span class=\"n\">value</span>\n<span class=\"n\">syntax</span> <span class=\"n\">str</span>                                  <span class=\"o\">:</span> <span class=\"n\">value</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"true\"</span>                               <span class=\"o\">:</span> <span class=\"n\">value</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"false\"</span>                              <span class=\"o\">:</span> <span class=\"n\">value</span>\n<span class=\"n\">syntax</span> <span class=\"o\">(</span><span class=\"s2\">\"-\"</span> <span class=\"n\">noWs</span><span class=\"o\">)</span><span class=\"bp\">?</span> <span class=\"n\">num</span> <span class=\"n\">noWs</span> <span class=\"s2\">\".\"</span> <span class=\"o\">(</span><span class=\"n\">noWs</span> <span class=\"n\">num</span><span class=\"o\">)</span><span class=\"bp\">?</span> <span class=\"o\">:</span> <span class=\"n\">value</span>\n<span class=\"n\">syntax</span> <span class=\"n\">withPosition</span><span class=\"o\">(</span><span class=\"s2\">\"[ \"</span> <span class=\"n\">colGt</span> <span class=\"n\">value</span><span class=\"bp\">*</span> <span class=\"s2\">\" ]\"</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">value</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"nil\"</span>                                <span class=\"o\">:</span> <span class=\"n\">value</span>\n\n<span class=\"n\">declare_syntax_cat</span>                    <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"n\">value</span>                        <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\" ! \"</span> <span class=\"n\">expression</span>             <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"n\">expression</span> <span class=\"s2\">\" + \"</span>  <span class=\"n\">expression</span> <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"n\">expression</span> <span class=\"s2\">\" * \"</span>  <span class=\"n\">expression</span> <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"n\">expression</span> <span class=\"s2\">\" = \"</span>  <span class=\"n\">expression</span> <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"n\">expression</span> <span class=\"s2\">\" != \"</span> <span class=\"n\">expression</span> <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"n\">expression</span> <span class=\"s2\">\" &lt; \"</span>  <span class=\"n\">expression</span> <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"n\">expression</span> <span class=\"s2\">\" &lt;= \"</span> <span class=\"n\">expression</span> <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"n\">expression</span> <span class=\"s2\">\" &gt; \"</span>  <span class=\"n\">expression</span> <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"n\">expression</span> <span class=\"s2\">\" &gt;= \"</span> <span class=\"n\">expression</span> <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"n\">ident</span> <span class=\"o\">(</span><span class=\"n\">colGt</span> <span class=\"n\">expression</span><span class=\"o\">)</span><span class=\"bp\">*</span>    <span class=\"o\">:</span> <span class=\"n\">expression</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"( \"</span> <span class=\"n\">expression</span> <span class=\"s2\">\" )\"</span>         <span class=\"o\">:</span> <span class=\"n\">expression</span>\n\n<span class=\"n\">declare_syntax_cat</span> <span class=\"n\">program</span>\n\n<span class=\"n\">syntax</span> <span class=\"n\">programSeq</span> <span class=\"o\">:=</span> <span class=\"n\">withPosition</span><span class=\"o\">((</span><span class=\"n\">colGe</span> <span class=\"n\">program</span><span class=\"o\">)</span><span class=\"bp\">+</span><span class=\"o\">)</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"skip\"</span>                                                 <span class=\"o\">:</span> <span class=\"n\">program</span>\n<span class=\"n\">syntax</span> <span class=\"n\">withPosition</span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"bp\">+</span> <span class=\"s2\">\" := \"</span> <span class=\"n\">colGt</span> <span class=\"n\">programSeq</span><span class=\"o\">)</span>           <span class=\"o\">:</span> <span class=\"n\">program</span>\n<span class=\"n\">syntax</span> <span class=\"n\">expression</span>                                             <span class=\"o\">:</span> <span class=\"n\">program</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\"if\"</span> <span class=\"n\">expression</span> <span class=\"s2\">\"then\"</span> <span class=\"n\">colGt</span> <span class=\"n\">programSeq</span> <span class=\"s2\">\"else\"</span> <span class=\"n\">colGt</span> <span class=\"n\">programSeq</span> <span class=\"o\">:</span> <span class=\"n\">program</span>\n<span class=\"n\">syntax</span> <span class=\"n\">withPosition</span><span class=\"o\">(</span><span class=\"s2\">\"while\"</span> <span class=\"n\">expression</span> <span class=\"s2\">\"do\"</span> <span class=\"n\">colGt</span> <span class=\"n\">programSeq</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">program</span>\n<span class=\"n\">syntax</span> <span class=\"s2\">\" ( \"</span> <span class=\"n\">programSeq</span> <span class=\"s2\">\" ) \"</span> <span class=\"o\">:</span> <span class=\"n\">program</span>\n\n<span class=\"kn\">open</span> <span class=\"n\">Lean</span> <span class=\"n\">Elab</span> <span class=\"n\">Meta</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">mkApp'</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"o\">:</span> <span class=\"n\">Name</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">Expr</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Expr</span> <span class=\"o\">:=</span>\n  <span class=\"n\">mkApp</span> <span class=\"o\">(</span><span class=\"n\">mkConst</span> <span class=\"n\">name</span><span class=\"o\">)</span> <span class=\"n\">e</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">elabValue</span> <span class=\"o\">:</span> <span class=\"n\">Syntax</span> <span class=\"bp\">→</span> <span class=\"n\">TermElabM</span> <span class=\"n\">Expr</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">value</span><span class=\"bp\">|$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">numLit</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Value.int</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mkApp'</span> <span class=\"bp\">``</span><span class=\"n\">Int.ofNat</span> <span class=\"o\">(</span><span class=\"n\">mkNatLit</span> <span class=\"n\">n.toNat</span><span class=\"o\">)]</span>\n  <span class=\"bp\">|</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">elabStringOfIdent</span> <span class=\"o\">(</span><span class=\"n\">id</span> <span class=\"o\">:</span> <span class=\"n\">Syntax</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Expr</span> <span class=\"o\">:=</span>\n  <span class=\"n\">mkStrLit</span> <span class=\"n\">id.getId.toString</span>\n\n<span class=\"n\">partial</span> <span class=\"kd\">def</span> <span class=\"n\">elabExpression</span> <span class=\"o\">:</span> <span class=\"n\">Syntax</span> <span class=\"bp\">→</span> <span class=\"n\">TermElabM</span> <span class=\"n\">Expr</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">value</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span> <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.atom</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabValue</span> <span class=\"n\">v</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">!</span> <span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.not</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">e</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">es</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"k\">let</span> <span class=\"n\">es</span> <span class=\"bp\">←</span> <span class=\"n\">es.data.mapM</span> <span class=\"n\">elabExpression</span>\n    <span class=\"k\">match</span> <span class=\"n\">es</span> <span class=\"k\">with</span>\n    <span class=\"bp\">|</span> <span class=\"o\">[]</span>      <span class=\"bp\">=&gt;</span> <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.var</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">elabStringOfIdent</span> <span class=\"n\">n</span><span class=\"o\">]</span>\n    <span class=\"bp\">|</span> <span class=\"n\">e</span> <span class=\"o\">::</span> <span class=\"n\">es</span> <span class=\"bp\">=&gt;</span>\n      <span class=\"k\">let</span> <span class=\"n\">l</span>  <span class=\"bp\">←</span> <span class=\"n\">mkListLit</span> <span class=\"o\">(</span><span class=\"n\">Lean.mkConst</span> <span class=\"bp\">``</span><span class=\"n\">Expression</span><span class=\"o\">)</span> <span class=\"n\">es</span>\n      <span class=\"k\">let</span> <span class=\"n\">nl</span> <span class=\"bp\">←</span> <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">List.toNEList</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">e</span><span class=\"o\">,</span> <span class=\"n\">l</span><span class=\"o\">]</span>\n      <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.app</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">elabStringOfIdent</span> <span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"n\">nl</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">expression</span> <span class=\"bp\">+</span> <span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.add</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">l</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">r</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">expression</span> <span class=\"bp\">*</span> <span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.mul</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">l</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">r</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">expression</span> <span class=\"bp\">=</span> <span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.eq</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">l</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">r</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">expression</span> <span class=\"bp\">!=</span> <span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.ne</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">l</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">r</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">expression</span> <span class=\"bp\">&lt;</span> <span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.lt</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">l</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">r</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">expression</span> <span class=\"bp\">&lt;=</span> <span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.le</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">l</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">r</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">expression</span> <span class=\"bp\">&gt;</span> <span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.gt</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">l</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">r</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">expression</span> <span class=\"bp\">&gt;=</span> <span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Expression.ge</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">l</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">r</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">expression</span><span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">))</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">elabExpression</span> <span class=\"n\">e</span>\n  <span class=\"bp\">|</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"n\">partial</span> <span class=\"kd\">def</span> <span class=\"n\">elabProgram</span> <span class=\"o\">:</span> <span class=\"n\">Syntax</span> <span class=\"bp\">→</span> <span class=\"n\">TermElabM</span> <span class=\"n\">Expr</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">programSeq</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">p1</span><span class=\"o\">:</span><span class=\"n\">program</span> <span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">p.foldlM</span> <span class=\"o\">(</span><span class=\"n\">init</span> <span class=\"o\">:=</span> <span class=\"bp\">←</span> <span class=\"n\">elabProgram</span> <span class=\"n\">p1</span><span class=\"o\">)</span> <span class=\"k\">fun</span> <span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n      <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Program.sequence</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabProgram</span> <span class=\"n\">b</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"bp\">|</span> <span class=\"n\">skip</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">return</span> <span class=\"n\">mkConst</span> <span class=\"bp\">``</span><span class=\"n\">Program.skip</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">ns</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"bp\">*</span> <span class=\"o\">:=</span> <span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"n\">programSeq</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"k\">match</span> <span class=\"n\">ns.data.map</span> <span class=\"n\">elabStringOfIdent</span> <span class=\"k\">with</span>\n    <span class=\"bp\">|</span> <span class=\"o\">[]</span>      <span class=\"bp\">=&gt;</span>\n      <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Program.attribution</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">elabStringOfIdent</span> <span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabProgram</span> <span class=\"n\">p</span><span class=\"o\">]</span>\n    <span class=\"bp\">|</span> <span class=\"n\">n'</span> <span class=\"o\">::</span> <span class=\"n\">ns</span> <span class=\"bp\">=&gt;</span>\n      <span class=\"k\">let</span> <span class=\"n\">l</span>  <span class=\"bp\">←</span> <span class=\"n\">mkListLit</span> <span class=\"o\">(</span><span class=\"n\">Lean.mkConst</span> <span class=\"bp\">``</span><span class=\"n\">String</span><span class=\"o\">)</span> <span class=\"n\">ns</span>\n      <span class=\"k\">let</span> <span class=\"n\">nl</span> <span class=\"bp\">←</span> <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">List.toNEList</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">n'</span><span class=\"o\">,</span> <span class=\"n\">l</span><span class=\"o\">]</span>\n      <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Program.attribution</span> <span class=\"bp\">#</span><span class=\"o\">[</span>\n        <span class=\"n\">elabStringOfIdent</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n        <span class=\"n\">mkApp'</span> <span class=\"bp\">``</span><span class=\"n\">Program.evaluation</span> <span class=\"bp\">$</span>\n          <span class=\"n\">mkApp'</span> <span class=\"bp\">``</span><span class=\"n\">Expression.atom</span> <span class=\"bp\">$</span>\n            <span class=\"bp\">←</span> <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Value.curry</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">nl</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabProgram</span> <span class=\"n\">p</span><span class=\"o\">]</span>\n      <span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"bp\">|</span> <span class=\"k\">if</span> <span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">expression</span> <span class=\"k\">then</span> <span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"n\">programSeq</span> <span class=\"k\">else</span> <span class=\"bp\">$</span><span class=\"n\">q</span><span class=\"o\">:</span><span class=\"n\">programSeq</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Program.ifElse</span>\n      <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">e</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabProgram</span> <span class=\"n\">p</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabProgram</span> <span class=\"n\">q</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"bp\">|</span> <span class=\"n\">while</span> <span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">expression</span> <span class=\"k\">do</span> <span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"n\">programSeq</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Program.whileLoop</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">e</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">elabProgram</span> <span class=\"n\">p</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">expression</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n    <span class=\"n\">mkAppM</span> <span class=\"bp\">``</span><span class=\"n\">Program.evaluation</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">elabExpression</span> <span class=\"n\">e</span><span class=\"o\">]</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"n\">programSeq</span><span class=\"o\">))</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">elabProgram</span> <span class=\"n\">p</span>\n  <span class=\"bp\">|</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"c1\">------- ↓↓ testing area ↓↓</span>\n\n<span class=\"n\">elab</span> <span class=\"s2\">\"&gt;&gt;\"</span> <span class=\"n\">ppLine</span> <span class=\"n\">p</span><span class=\"o\">:</span><span class=\"n\">programSeq</span> <span class=\"n\">ppLine</span> <span class=\"s2\">\"&lt;&lt;\"</span> <span class=\"o\">:</span> <span class=\"n\">term</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">elabProgram</span> <span class=\"n\">p</span>\n\n<span class=\"kn\">open</span> <span class=\"n\">Lean.Elab.Command</span> <span class=\"n\">Lean.Elab.Term</span> <span class=\"k\">in</span>\n<span class=\"n\">elab</span> <span class=\"s2\">\"#assert \"</span> <span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">60</span> <span class=\"s2\">\" = \"</span> <span class=\"n\">y</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">60</span> <span class=\"o\">:</span> <span class=\"n\">command</span> <span class=\"bp\">=&gt;</span>\n  <span class=\"n\">liftTermElabM</span> <span class=\"bp\">`</span><span class=\"n\">assert</span> <span class=\"k\">do</span>\n    <span class=\"k\">let</span> <span class=\"n\">x</span> <span class=\"bp\">←</span> <span class=\"n\">elabTerm</span> <span class=\"n\">x</span> <span class=\"n\">none</span>\n    <span class=\"k\">let</span> <span class=\"n\">y</span> <span class=\"bp\">←</span> <span class=\"n\">elabTerm</span> <span class=\"n\">y</span> <span class=\"n\">none</span>\n    <span class=\"n\">synthesizeSyntheticMVarsNoPostponing</span>\n    <span class=\"n\">unless</span> <span class=\"o\">(</span><span class=\"bp\">←</span> <span class=\"n\">isDefEq</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"k\">do</span>\n      <span class=\"n\">throwError</span> <span class=\"s2\">\"{← reduce x}</span><span class=\"se\">\\n</span><span class=\"s2\">------------------------</span><span class=\"se\">\\n</span><span class=\"s2\">{← reduce y}\"</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p1</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"n\">min</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:=</span>\n  <span class=\"k\">if</span> <span class=\"n\">x</span> <span class=\"bp\">&lt;</span> <span class=\"n\">y</span>\n    <span class=\"k\">then</span> <span class=\"n\">x</span>\n    <span class=\"k\">else</span> <span class=\"n\">y</span>\n<span class=\"n\">min</span> <span class=\"mi\">5</span> <span class=\"mi\">3</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p2</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"o\">(</span><span class=\"n\">min</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:=</span>\n  <span class=\"k\">if</span> <span class=\"n\">x</span> <span class=\"bp\">&lt;</span> <span class=\"n\">y</span>\n    <span class=\"k\">then</span> <span class=\"n\">x</span>\n    <span class=\"k\">else</span> <span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"n\">min</span> <span class=\"mi\">5</span> <span class=\"mi\">3</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"bp\">#</span><span class=\"n\">assert</span> <span class=\"n\">p1</span> <span class=\"bp\">=</span> <span class=\"n\">p2</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p3</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"n\">while</span> <span class=\"mi\">1</span> <span class=\"bp\">&lt;</span> <span class=\"n\">a</span> <span class=\"k\">do</span>\n  <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"mi\">2</span>\n<span class=\"n\">a</span> <span class=\"bp\">&lt;</span> <span class=\"mi\">3</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p4</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"n\">while</span> <span class=\"mi\">1</span> <span class=\"bp\">&lt;</span> <span class=\"n\">a</span> <span class=\"k\">do</span> <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"mi\">2</span>\n<span class=\"n\">a</span> <span class=\"bp\">&lt;</span> <span class=\"mi\">3</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p5</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"o\">(</span><span class=\"n\">while</span> <span class=\"mi\">1</span> <span class=\"bp\">&lt;</span> <span class=\"n\">a</span> <span class=\"k\">do</span> <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"n\">a</span> <span class=\"bp\">&lt;</span> <span class=\"mi\">3</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"bp\">#</span><span class=\"n\">assert</span> <span class=\"n\">p3</span> <span class=\"bp\">=</span> <span class=\"n\">p4</span>\n<span class=\"bp\">#</span><span class=\"n\">assert</span> <span class=\"n\">p4</span> <span class=\"bp\">=</span> <span class=\"n\">p5</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p6</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:=</span>\n  <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"o\">(</span><span class=\"n\">f3</span> <span class=\"o\">:=</span> <span class=\"n\">f</span> <span class=\"mi\">3</span><span class=\"o\">)</span>\n<span class=\"n\">f32</span> <span class=\"o\">:=</span> <span class=\"n\">f3</span> <span class=\"mi\">2</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p7</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"o\">(</span><span class=\"n\">f3</span> <span class=\"o\">:=</span> <span class=\"n\">f</span> <span class=\"mi\">3</span><span class=\"o\">)</span>\n<span class=\"n\">f32</span> <span class=\"o\">:=</span> <span class=\"n\">f3</span> <span class=\"mi\">2</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"bp\">#</span><span class=\"n\">assert</span> <span class=\"n\">p6</span> <span class=\"bp\">=</span> <span class=\"n\">p7</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p8</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"n\">y</span>\n<span class=\"n\">f3</span> <span class=\"o\">:=</span> <span class=\"n\">f</span> <span class=\"mi\">3</span>\n<span class=\"n\">f32</span> <span class=\"o\">:=</span> <span class=\"n\">f3</span> <span class=\"mi\">2</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"bp\">#</span><span class=\"n\">assert</span> <span class=\"n\">p7</span> <span class=\"bp\">=</span> <span class=\"n\">p8</span>\n\n\n<span class=\"kd\">def</span> <span class=\"n\">p9</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"n\">a</span> <span class=\"o\">:=</span>\n  <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"mi\">5</span>\n  <span class=\"n\">y</span> <span class=\"bp\">=</span> <span class=\"mi\">5</span>\n<span class=\"mi\">2</span> <span class=\"bp\">+</span> <span class=\"mi\">5</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p9'</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">:=</span>\n  <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"mi\">5</span>\n  <span class=\"n\">y</span> <span class=\"bp\">=</span> <span class=\"mi\">5</span><span class=\"o\">)</span>\n<span class=\"mi\">2</span> <span class=\"bp\">+</span> <span class=\"mi\">5</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p10</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"n\">a</span> <span class=\"o\">:=</span>\n  <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"mi\">5</span>\n   <span class=\"n\">y</span> <span class=\"bp\">=</span> <span class=\"mi\">5</span><span class=\"o\">)</span>\n<span class=\"mi\">2</span> <span class=\"bp\">+</span> <span class=\"mi\">5</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">p11</span> <span class=\"o\">:=</span> <span class=\"bp\">&gt;&gt;</span>\n<span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">:=</span>\n  <span class=\"o\">((</span><span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"mi\">5</span><span class=\"o\">)</span>\n   <span class=\"n\">y</span> <span class=\"bp\">=</span> <span class=\"mi\">5</span><span class=\"o\">))</span>\n<span class=\"mi\">2</span> <span class=\"bp\">+</span> <span class=\"mi\">5</span>\n<span class=\"bp\">&lt;&lt;.</span><span class=\"n\">toString</span>\n\n<span class=\"bp\">#</span><span class=\"n\">assert</span> <span class=\"n\">p9</span> <span class=\"bp\">=</span> <span class=\"n\">p9'</span>\n<span class=\"bp\">#</span><span class=\"n\">assert</span> <span class=\"n\">p9</span> <span class=\"bp\">=</span> <span class=\"n\">p10</span>\n<span class=\"bp\">#</span><span class=\"n\">assert</span> <span class=\"n\">p10</span> <span class=\"bp\">=</span> <span class=\"n\">p11</span>\n</code></pre></div>",
        "id": 277509605,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1648879696
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> <a href=\"#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/277506426\">said</a>:</p>\n<blockquote>\n<p>I'm trying to make the parser understand indentation. But as soon as I use <code>withPosition</code> on the <code>syntax:25 program program : program</code> line, Lean breaks down and the server dies due to some loop that I don't understand.</p>\n</blockquote>\n<p>Lean eliminates the left recursion in <code>syntax cat ... : cat</code>, but if you wrap it in <code>withPosition</code>, it doesn't happen anymore</p>",
        "id": 277513991,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1648886172
    },
    {
        "content": "<p>And as always, thanks a lot <span aria-label=\"octopus\" class=\"emoji emoji-1f419\" role=\"img\" title=\"octopus\">:octopus:</span></p>",
        "id": 277521249,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648895538
    },
    {
        "content": "<p>(I just noticed that you fixed other syntax definitions in my code, thanks for those as well <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span>)</p>",
        "id": 277642422,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1648999948
    },
    {
        "content": "<p>I ran into a syntax trouble again <span aria-label=\"face palm\" class=\"emoji emoji-1f926\" role=\"img\" title=\"face palm\">:face_palm:</span> <br>\nI apologize upfront for not being able to reduce the code to a smaller <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>.</p>\n<p>I'm trying to represent a function application:</p>\n<ul>\n<li><code>f 3 3</code> applies 3 and 3 to the function <code>f</code></li>\n<li><code>f a 3</code> applies <code>a</code> and 3 to the function <code>f</code></li>\n</ul>\n<p>In <a href=\"https://github.com/arthurpaulino/FunnyLang/blob/7f7fb451deeae27e6b3ec3a6afd30a59e2ad519a/FunnyLang/Meta.lean#L133\">my code</a>, <code>f 3 3</code> is properly parsed as \"f [3 3]\", \"[3 3]\" being a list of expressions. However, I can't seem to be able to make Lean understand <code>f a 3</code> as \"f [a 3]\". Instead, it's parsing as if I were passing an application of 3 to the \"function\" <code>a</code> and then passing the result to the function <code>f</code></p>\n<p>As you can see, I put a debug message so we can know the number of application arguments being parsed. In the <code>f 3 3</code> example it prints out <code>2</code>, which is correct. But in <code>f a 3</code> it prints out <code>1</code> and then <code>1</code> again, which is coherent with the behavior I'm describing above.</p>\n<p>Any ideas how I can escape of this right precedence behavior? I tried setting precedence values in a lot of different ways without success</p>",
        "id": 277664377,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1649024460
    },
    {
        "content": "<p>While trying to create an <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>, I was able to make this small prototype work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Lean</span>\n\n<span class=\"n\">declare_syntax_cat</span> <span class=\"n\">foo</span>\n<span class=\"n\">syntax</span> <span class=\"n\">num</span>                      <span class=\"o\">:</span> <span class=\"n\">foo</span>\n<span class=\"n\">syntax</span><span class=\"o\">:</span><span class=\"mi\">51</span> <span class=\"n\">ident</span>                 <span class=\"o\">:</span> <span class=\"n\">foo</span>\n<span class=\"n\">syntax</span><span class=\"o\">:</span><span class=\"mi\">49</span> <span class=\"n\">ident</span> <span class=\"o\">(</span><span class=\"n\">colGt</span> <span class=\"n\">foo</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"o\">)</span><span class=\"bp\">+</span> <span class=\"o\">:</span> <span class=\"n\">foo</span>\n\n<span class=\"n\">elab</span> <span class=\"s2\">\" ⟪ \"</span> <span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">foo</span> <span class=\"s2\">\" ⟫ \"</span> <span class=\"o\">:</span> <span class=\"n\">term</span> <span class=\"bp\">=&gt;</span>\n  <span class=\"k\">match</span> <span class=\"n\">f</span> <span class=\"k\">with</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"bp\">|</span> <span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span> <span class=\"bp\">$</span><span class=\"n\">fs</span><span class=\"o\">:</span><span class=\"n\">foo</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span>\n    <span class=\"n\">dbg_trace</span> <span class=\"n\">fs.size</span>\n    <span class=\"n\">default</span>\n  <span class=\"bp\">|</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">default</span>\n\n<span class=\"k\">#eval</span> <span class=\"bp\">⟪</span><span class=\"n\">f</span> <span class=\"mi\">3</span> <span class=\"mi\">3</span><span class=\"bp\">⟫</span> <span class=\"c1\">-- 2</span>\n<span class=\"k\">#eval</span> <span class=\"bp\">⟪</span><span class=\"n\">f</span> <span class=\"n\">a</span> <span class=\"mi\">3</span><span class=\"bp\">⟫</span> <span class=\"c1\">-- 2</span>\n</code></pre></div>\n<p>But when I try to plug this idea in my code, it breaks all my other examples with working syntax</p>",
        "id": 277664562,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1649024695
    },
    {
        "content": "<p>Wait, nevermind. I got it!<br>\nI had to add a match case for the <code>| `(expression| $n:ident)</code> alone <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 277665467,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1649025891
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> has marked this topic as resolved.</p>",
        "id": 277665471,
        "sender_full_name": "Notification Bot",
        "timestamp": 1649025898
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> has marked this topic as unresolved.</p>",
        "id": 277666198,
        "sender_full_name": "Notification Bot",
        "timestamp": 1649026839
    },
    {
        "content": "<p>Hi everyone! I'm happy to announce that the first iteration my first ever programming language is finished and documented. I named it <a href=\"https://github.com/arthurpaulino/FxyLang\">Fxy</a>.</p>\n<p>There's still a lot of work on the reasoning front, but the implementation is working nicely already. I wouldn't have been able to do it without the ideas from <span class=\"user-mention\" data-user-id=\"110026\">@Simon Hudon</span> and <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>. Also, big thanks to everyone who helped me in this thread.</p>\n<p>Fxy is (obviously) infinitely simpler than Lean 4 and thus might serve as a small (and yet not too trivial) showcase of how to use Lean 4 for programming purposes.</p>\n<p>A small example of a Fxy program to compute the sum of the <code>n</code> first natural numbers:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">f</span> <span class=\"n\">n</span> <span class=\"o\">:=</span>\n  <span class=\"n\">s</span> <span class=\"o\">:=</span> <span class=\"mi\">0</span>\n  <span class=\"n\">i</span> <span class=\"o\">:=</span> <span class=\"mi\">0</span>\n  <span class=\"k\">while</span> <span class=\"n\">i</span> <span class=\"o\">&lt;</span> <span class=\"n\">n</span> <span class=\"n\">do</span>\n    <span class=\"n\">i</span> <span class=\"o\">:=</span> <span class=\"n\">i</span> <span class=\"o\">+</span> <span class=\"mi\">1</span>\n    <span class=\"n\">s</span> <span class=\"o\">:=</span> <span class=\"n\">s</span> <span class=\"o\">+</span> <span class=\"n\">i</span>\n  <span class=\"n\">s</span>\n<span class=\"err\">!</span><span class=\"nb\">print</span> <span class=\"n\">f</span> <span class=\"mi\">5</span> <span class=\"c1\"># prints 15</span>\n</code></pre></div>",
        "id": 280868705,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1651495474
    },
    {
        "content": "<p>Very very cool Arthur. I see you're also working on showing off some reasoning there now -- is the idea that someone will be able to take a Fxy program like that one and prove things about it from within Lean via some exposed intermediate API? If so in some nice future world where someone writes an e.g. Python interpreter in Lean 4 that will be very cool.</p>",
        "id": 280873613,
        "sender_full_name": "Julian Berman",
        "timestamp": 1651498313
    },
    {
        "content": "<p>That idea actually blew my mind. No, it wasn't on my radar. I just want to learn about semantics reasoning and that's why there exists an implementation of small steps. But hey, being able to reason about Python code from Lean would be pretty cool! (Although I believe that only a subset of Python  could be considered in such scenario)</p>",
        "id": 280874214,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1651498636
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/280873613\">said</a>:</p>\n<blockquote>\n<p>Very very cool Arthur. I see you're also working on showing off some reasoning there now -- is the idea that someone will be able to take a Fxy program like that one and prove things about it from within Lean via some exposed intermediate API? If so in some nice future world where someone writes an e.g. Python interpreter in Lean 4 that will be very cool.</p>\n</blockquote>\n<p>Formally arguing about non functional languages is usually rather complicated because of all the pointer/reference stuff that can change all the time. The Coq people have done huge amounts of efforts to argue about a C subset, I imagine an even more complicated and less typed language like python will be much harder.</p>",
        "id": 280875588,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1651499327
    },
    {
        "content": "<p>Thanks, I figured this was definitely not a new idea and likely a hard one :D -- seems like I found <a href=\"http://staff.ustc.edu.cn/~fuming/papers/p97-cao.pdf\">this</a> or <a href=\"https://link.springer.com/article/10.1007/s00165-007-0055-2\">this</a> fairly quickly to peruse.</p>",
        "id": 280876774,
        "sender_full_name": "Julian Berman",
        "timestamp": 1651499898
    },
    {
        "content": "<p>Very nice! At some point I might attempt to parse existing scripting language VEX in Houdini to Lean 4 and looking at Fxy as a guiding example will be tremendously helpful.</p>",
        "id": 280876909,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1651499977
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/280876774\">said</a>:</p>\n<blockquote>\n<p>Thanks, I figured this was definitely not a new idea and likely a hard one :D -- seems like I found <a href=\"http://staff.ustc.edu.cn/~fuming/papers/p97-cao.pdf\">this</a> or <a href=\"https://link.springer.com/article/10.1007/s00165-007-0055-2\">this</a> fairly quickly to peruse.</p>\n</blockquote>\n<p>The two big names in Coq world regarding formalization of C are CompCert and VST/Verified Software Toolchain if youre interested in that.</p>",
        "id": 280877430,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1651500182
    },
    {
        "content": "<p>I am indeed, thanks for pointing me in the right direction! (Now I'll probably stop crowding Arthur's cool thread!)</p>",
        "id": 280877844,
        "sender_full_name": "Julian Berman",
        "timestamp": 1651500407
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346070\">@Tomas Skrivan</span> I also implemented a way to parse Fxy code in Lean itself (not from a string). I used it mostly for debugging (see <code>MetaDebug.lean</code>), but I believe cooler things can be done with it</p>",
        "id": 280878021,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1651500528
    },
    {
        "content": "<p>I have no clue how these things work ... are you using the same parser code to parse Fxy from a *.fxy file and from within a *.lean file?</p>",
        "id": 280878472,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1651500786
    },
    {
        "content": "<p>Ughhh I'm confused, you have two ways of running Fxy, right? Either you have your own execution defined in <code>Executaion.lean</code> or you turn Fxy code into Lean expression, in <code>MetaDebug.lean</code>, and execute that. Why do you have these two ways of doing that?</p>",
        "id": 280878834,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1651500954
    },
    {
        "content": "<p>There are two ways to <em>parse</em> Fxy code and two ways to <em>run</em> a (parsed) Fxy program. Those are orthogonal.</p>\n<p>You can parse code from a fxy file or from a lean file. Once you have a <code>Program</code>, you can run it using the verifiable runner or the non-verifiable runner.</p>\n<p>The parsers use the same syntax (see <code>Syntax.lean</code>). Hm, I should explain this better in the repo</p>",
        "id": 280879827,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1651501441
    },
    {
        "content": "<p>The parsers themselves are very similar, but one produces a term of <code>Program</code> (when reading from a fxy file) and the other produces a term of <code>Expr</code> (this is what you'd do in term elaboration - read <a href=\"https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/md/elaboration.md\">this chapter</a> written by <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> )</p>",
        "id": 280880422,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1651501732
    },
    {
        "content": "<p>Answering the question of \"why\", it was just for debugging. It's much faster to debug the executor if the code can be parsed from Lean code than if I had to do cycles of <code>lake build</code> and fxy file editing everytime. And btw this was one aspect of the development which really made Lean 4 shine IMO</p>",
        "id": 280881076,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1651502039
    },
    {
        "content": "<p>That makes sense, is there a way to keep those two executors in sync?  Or you just hope they match each other? As the language grows I guess you will drop the debugging executor, or no?</p>",
        "id": 280889328,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1651505405
    },
    {
        "content": "<p>Very Nice. One hope of mine to try some day is the <a href=\"https://www.gap-system.org/Manuals/doc/ref/chap4.html#X7FE7C0C17E1ED118\">GAP system</a> so a bunch of mathematical algorithms run in Lean 4. Hopefully they can be lifted step-by-step to certified ones.</p>",
        "id": 280890426,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1651505922
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346070\">@Tomas Skrivan</span> I think you mean the debugging parser. Maybe!<br>\nIf you see the file you'll notice that it's also easy to create test cases with it</p>",
        "id": 280892960,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1651506985
    },
    {
        "content": "<p>Similarly it might be cool if Lean 4 would eventually be used to replace the bespoke scripting languages in Singular, Macaulay 2 etc. with something that has more solid foundations.</p>",
        "id": 280899233,
        "sender_full_name": "Christian Pehle",
        "timestamp": 1651509707
    },
    {
        "content": "<p>If using Lean's <code>syntax</code> to parse generic strings (e.g. extracted from text files) becomes a thing, then a proper workaround for <a href=\"https://github.com/arthurpaulino/FxyLang/blob/afcd0db77d320438d625bac9cb8cf55413c47e52/Main.lean#L14\">this part</a> might be more useful than expected</p>",
        "id": 280903158,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1651511409
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"266304\">@Siddhartha Gadgil</span> which group theory algorithms in particular are you interested in? I'm assuming that \"formally verify GAP algorithms\" is not really possible, so it's \"re-implement GAP algorithms in Lean and prove they're correct\"?</p>",
        "id": 281017341,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1651586565
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>  The actual algorithms I plan to try to implement (with proofs) are those from Geometric/Combinatorial group theory. For example, the word and conjugacy problems for surface groups and free groups. I do not know if these are in GAP, but either way I would work from scratch in Lean 4.</p>\n<p>The GAP stuff was more speculation. What I mean was that since the syntax of lean 4 is so nicely extendable, elaborators will translate appropriately enclosed (or read from files) objects as lean objects. So in principle one can try to prove theorems about these. A variant is to use the pretty printer to actually generate lean code and work with this. The broad idea is to start with lean purely as a programming language, with interpreters able to run code in at least small languages like GAP. And see if algorithms can be enriched incrementally with proofs. </p>\n<p>Whether this is even remotely practical I have no idea, and won't till it is tried.</p>",
        "id": 281020860,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1651587927
    },
    {
        "content": "<p>I think it's an interesting idea whether or not it's practical. It might be hard to sell to the math community -- \"oh GAP is a pretty good piece of software and I'll continue to use it over yours because it's faster and you don't usually hit bugs\" -- but I think that formally verified serious mathematical software will only get better over time and it's worth trying to put down some markers, so we can discover what the state of the art looks like.</p>",
        "id": 281023729,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1651589068
    },
    {
        "content": "<p>One thought might be to run GAP algorithms unverified in Lean, and then <em>verify</em> that the results are correct via proof certificates within Lean4. So GAP is used to import untrusted algorithms, whose results we check with formally proven verifiers..I've started on a GAP embedding in Lean (<a href=\"https://github.com/opencompl/lean-gap\">https://github.com/opencompl/lean-gap</a>), though it's early days yet.</p>",
        "id": 281026690,
        "sender_full_name": "Siddharth Bhat",
        "timestamp": 1651590250
    },
    {
        "content": "<p>A verified algorithm can also give a formal proof. For instance one may want to show that something is not a sphere, and a verified algorithm may show that its fundamental group is non-trivial (there is an actual published paper in a top journal with the opposite error - something that was claimed about a sphere but turns out was about a space with non-trivial fundamental group).</p>",
        "id": 281027717,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1651590646
    },
    {
        "content": "<p>Just speculation at this point, but how hard will it be to have a command elaborator for say <code>importFxy filename</code> which imports an fxy file and makes <em>lean</em> definitions corresponding to function definitions in the <em>fxy</em> file?</p>",
        "id": 281965556,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1652275992
    },
    {
        "content": "<p>i'm guessing you'd intend to do it at compilation time, because at execution time it's already the current flow.</p>\n<p>If you can perform IO operations (reading a text file) at compilation time, then you can pass the content of a <code>fxy</code> file to the <a href=\"https://github.com/arthurpaulino/FxyLang/blob/d7cf6aeff91f02d59bf9387e853983184a001c44/FxyLang/Implementation/Parser.lean#L106\">parse function</a>, which should take care of the rest. Notice that the current parsing method also requires an <code>Environment</code> containing the syntax definitions, but it can be done from a monad like <code>MetaM</code> via <code>getEnv</code>.</p>",
        "id": 281966862,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1652276618
    },
    {
        "content": "<p>So the question becomes: how to read an arbitrary text file at compilation time? I don't know, but I do recall seeing people do it</p>",
        "id": 281967379,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1652276822
    },
    {
        "content": "<p>Easily, because <code>IO</code> can be lifted into <code>CoreM</code> etc</p>",
        "id": 281967756,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1652276995
    },
    {
        "content": "<p>That is what I thought <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> - and am I correct that this should work in the interpreter too? (My agenda eventually is to target GAP).</p>",
        "id": 281968925,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1652277444
    },
    {
        "content": "<p>There should be no semantic difference between compiled code and the interpreter except that the latter cannot directly call <code>extern</code> declarations</p>",
        "id": 281970055,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1652277833
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> I just want to point out that <a href=\"#narrow/stream/270676-lean4/topic/PrettyPrinter/near/265959260\">this</a> still happens with yesterday's nightly build</p>",
        "id": 281971146,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1652278273
    }
]