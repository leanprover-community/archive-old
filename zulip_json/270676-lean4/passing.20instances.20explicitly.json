[
    {
        "content": "<p>How can I pass instances explicitly to a function <code>f</code> as below?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span> <span class=\"n\">Chromatic</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"n\">where</span> <span class=\"c1\">-- something that has color</span>\n  <span class=\"n\">chroma</span> <span class=\"o\">:</span> <span class=\"n\">String</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">Chromatic</span> <span class=\"n\">α</span> <span class=\"n\">where</span> <span class=\"c1\">-- everything is green</span>\n  <span class=\"n\">chroma</span> <span class=\"o\">:=</span> <span class=\"s2\">\"green\"</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">f</span> <span class=\"o\">[</span><span class=\"n\">χ</span> <span class=\"o\">:</span> <span class=\"n\">Chromatic</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span> <span class=\"n\">χ.chroma</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">f</span> <span class=\"c1\">-- does not work</span>\n</code></pre></div>",
        "id": 318932006,
        "sender_full_name": "Petar Maymounkov",
        "timestamp": 1672632916
    },
    {
        "content": "<p>You can use <code>@</code> to pass in hidden parameters such as this one.<br>\nI only got it working when saving it to a variable though:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">Chromatic</span> <span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"k\">#eval</span> <span class=\"bp\">@</span><span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">Chromatic</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"c1\">-- does not work</span>\n<span class=\"k\">#eval</span> <span class=\"n\">foo</span> <span class=\"c1\">-- does work</span>\n</code></pre></div>",
        "id": 318932260,
        "sender_full_name": "Stuart Geipel",
        "timestamp": 1672633230
    },
    {
        "content": "<p>That's puzzling. I wonder what the rationale is. A related question. I would have expected this to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">f2</span> <span class=\"o\">[</span><span class=\"n\">Chromatic</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span> <span class=\"n\">chroma</span>\n</code></pre></div>\n<p>I have seen this pattern in the implementation of <code>Monad</code>. However in this case here, the compiler returns the function <code>chroma</code> (which requires a <code>self</code> parameter), rather than the value that <code>chroma</code> returns.</p>",
        "id": 318932594,
        "sender_full_name": "Petar Maymounkov",
        "timestamp": 1672633729
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"295150\">Petar Maymounkov</span> <a href=\"#narrow/stream/270676-lean4/topic/passing.20instances.20explicitly/near/318932006\">said</a>:</p>\n<blockquote>\n<p>How can I pass instances explicitly to a function <code>f</code> as below?</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span> <span class=\"n\">Chromatic</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"n\">where</span> <span class=\"c1\">-- something that has color</span>\n  <span class=\"n\">chroma</span> <span class=\"o\">:</span> <span class=\"n\">String</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">Chromatic</span> <span class=\"n\">α</span> <span class=\"n\">where</span> <span class=\"c1\">-- everything is green</span>\n  <span class=\"n\">chroma</span> <span class=\"o\">:=</span> <span class=\"s2\">\"green\"</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">f</span> <span class=\"o\">[</span><span class=\"n\">χ</span> <span class=\"o\">:</span> <span class=\"n\">Chromatic</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span> <span class=\"n\">χ.chroma</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">f</span> <span class=\"c1\">-- does not work</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>The reason this does not work is because your function signature is badly formed for type inference. if you just call it like that the only thing Lean will ever be able to infere is that it returns a String, it will never be able to make statements about the alpha parameter and thus also not about the type class instance. What you actually want to write here is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">χ</span> <span class=\"o\">:</span> <span class=\"n\">Chromatic</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span> <span class=\"n\">χ.chroma</span>\n\n<span class=\"k\">#eval</span> <span class=\"n\">f</span> <span class=\"n\">Nat</span>\n</code></pre></div>\n<p><span class=\"user-mention silent\" data-user-id=\"499256\">Stuart Geipel</span> <a href=\"#narrow/stream/270676-lean4/topic/passing.20instances.20explicitly/near/318932260\">said</a>:</p>\n<blockquote>\n<p>You can use <code>@</code> to pass in hidden parameters such as this one.<br>\nI only got it working when saving it to a variable though:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">Chromatic</span> <span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"k\">#eval</span> <span class=\"bp\">@</span><span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">Chromatic</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"c1\">-- does not work</span>\n<span class=\"k\">#eval</span> <span class=\"n\">foo</span> <span class=\"c1\">-- does work</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Your approach is doing something bad if you <code>#check f</code> You will see that it takes at first the type parameter, then the instance as an implicit argument which now both become explicit thanks to the <code>@f</code> so what you are passing is <code>Chromatic Nat</code> as type parameter for alpha Lean will end up inferring that you actually wanted to write this in your <code>def</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"n\">χ</span> <span class=\"o\">:</span> <span class=\"n\">Chromatic</span> <span class=\"o\">(</span><span class=\"n\">Chromatic</span> <span class=\"n\">Nat</span><span class=\"o\">)]</span> <span class=\"bp\">→</span> <span class=\"n\">String</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">Chromatic</span> <span class=\"n\">Nat</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>by use of the implicit lambda feature. It is however of course perfectly possible to call this function since there is a <code>Chromatic</code> instance for <code>Chromatic Nat</code> that can be automatically inferred.</p>\n<p>On the other side your direct evaluation attempt is not hidden behind a def or w/e so it will not do the implicit lambda but leave the now explicit type class argument explicit so your code does not end up being executable since it is still missing a parameter. What you would've wanted to write in this case is something like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">#eval</span> <span class=\"bp\">@</span><span class=\"n\">f</span> <span class=\"n\">Nat</span> <span class=\"n\">_</span>\n</code></pre></div>\n<p>or alternatively for more clarity</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">#eval</span> <span class=\"bp\">@</span><span class=\"n\">f</span> <span class=\"n\">Nat</span> <span class=\"n\">inferInstance</span>\n</code></pre></div>\n<p><span class=\"user-mention silent\" data-user-id=\"295150\">Petar Maymounkov</span> <a href=\"#narrow/stream/270676-lean4/topic/passing.20instances.20explicitly/near/318932594\">said</a>:</p>\n<blockquote>\n<p>That's puzzling. I wonder what the rationale is. A related question. I would have expected this to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">f2</span> <span class=\"o\">[</span><span class=\"n\">Chromatic</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span> <span class=\"n\">chroma</span>\n</code></pre></div>\n<p>I have seen this pattern in the implementation of <code>Monad</code>. However in this case here, the compiler returns the function <code>chroma</code> (which requires a <code>self</code> parameter), rather than the value that <code>chroma</code> returns.</p>\n</blockquote>\n<p>This does not end up working out because of the same type inference issue as your original definition. The Monad definitions usually contain the generic <code>m</code> type in its return type so it can trivially infere what is being referred to while here it again can only know that you want a <code>String</code> but it has no clue what chroma instance you want to base this on. However Lean is actually smart enough to notice that you made this mistake on its own as you can see from the error message it provides if you add the correct export annotation for this to work out in the first place:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span> <span class=\"n\">Chromatic</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"n\">where</span> <span class=\"c1\">-- something that has color</span>\n  <span class=\"n\">chroma</span> <span class=\"o\">:</span> <span class=\"n\">String</span>\n<span class=\"kn\">export</span> <span class=\"n\">Chromatic</span> <span class=\"o\">(</span><span class=\"n\">chroma</span><span class=\"o\">)</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">Chromatic</span> <span class=\"n\">α</span> <span class=\"n\">where</span> <span class=\"c1\">-- everything is green</span>\n  <span class=\"n\">chroma</span> <span class=\"o\">:=</span> <span class=\"s2\">\"green\"</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">f2</span> <span class=\"o\">[</span><span class=\"n\">Chromatic</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span> <span class=\"n\">chroma</span>\n</code></pre></div>\n<p>gives:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">type</span> <span class=\"n\">mismatch</span>\n  <span class=\"n\">chroma</span>\n<span class=\"n\">has</span> <span class=\"n\">type</span>\n  <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"o\">[</span><span class=\"n\">self</span> <span class=\"o\">:</span> <span class=\"n\">Chromatic</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"bp\">→</span> <span class=\"n\">String</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"mi\">1</span>\n<span class=\"n\">but</span> <span class=\"n\">is</span> <span class=\"n\">expected</span> <span class=\"n\">to</span> <span class=\"k\">have</span> <span class=\"n\">type</span>\n  <span class=\"n\">String</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span>\n</code></pre></div>\n<p>as you can see Lean was smart enough on its own to notice that it won't be able to infere the alpha type with the way that chroma is defined and decided to add it as an explicit argument for when you have to call chroma (note that it hides this from you for when you are defining the Chromatic instance because there it has enough information (namely the instance type itself) to know what type you are asking about)</p>\n<p>So if we just pass the type explicitly to chroma now:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span> <span class=\"n\">Chromatic</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"n\">where</span> <span class=\"c1\">-- something that has color</span>\n  <span class=\"n\">chroma</span> <span class=\"o\">:</span> <span class=\"n\">String</span>\n<span class=\"kn\">export</span> <span class=\"n\">Chromatic</span> <span class=\"o\">(</span><span class=\"n\">chroma</span><span class=\"o\">)</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">Chromatic</span> <span class=\"n\">α</span> <span class=\"n\">where</span> <span class=\"c1\">-- everything is green</span>\n  <span class=\"n\">chroma</span> <span class=\"o\">:=</span> <span class=\"s2\">\"green\"</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">f2</span> <span class=\"o\">[</span><span class=\"n\">Chromatic</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span> <span class=\"n\">chroma</span> <span class=\"n\">α</span>\n</code></pre></div>\n<p>This too works.</p>",
        "id": 318955168,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1672650093
    },
    {
        "content": "<p>Wow. What a clear and comprehesnive answer. Thank you <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span></p>",
        "id": 319086952,
        "sender_full_name": "Petar Maymounkov",
        "timestamp": 1672688591
    }
]