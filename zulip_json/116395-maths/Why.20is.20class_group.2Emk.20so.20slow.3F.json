[
    {
        "content": "<p>I was trying to define a map to the class group of a very explicit polynomial ring of a curve and prove some properties, but it quickly became incredibly annoying because elaborating the definition takes ~10s on my machine, while any theorems I prove would take several minutes to type-check and times out with the standard timeout settings.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">ring_theory.class_group</span>\n<span class=\"kn\">open</span> <span class=\"n\">polynomial</span>\n<span class=\"n\">open_locale</span> <span class=\"n\">non_zero_divisors</span> <span class=\"n\">polynomial</span>\n\n<span class=\"kd\">variables</span> <span class=\"o\">(</span><span class=\"n\">K</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">field</span> <span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"kd\">structure</span> <span class=\"n\">my_curve</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">K</span><span class=\"o\">)</span>\n<span class=\"kd\">variables</span> <span class=\"o\">{</span><span class=\"n\">K</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">M</span> <span class=\"o\">:</span> <span class=\"n\">my_curve</span> <span class=\"n\">K</span><span class=\"o\">)</span>\n<span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">my_polynomial</span> <span class=\"o\">:</span> <span class=\"n\">K</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">][</span><span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">:=</span> <span class=\"n\">X</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">-</span> <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"n\">X</span> <span class=\"bp\">^</span> <span class=\"mi\">3</span> <span class=\"bp\">+</span> <span class=\"n\">C</span> <span class=\"n\">M.a</span><span class=\"o\">)</span>\n<span class=\"kd\">@[derive comm_ring]</span> <span class=\"kd\">def</span> <span class=\"n\">my_ring</span> <span class=\"o\">:=</span> <span class=\"n\">adjoin_root</span> <span class=\"bp\">$</span> <span class=\"n\">my_polynomial</span> <span class=\"n\">M</span>\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">is_domain</span> <span class=\"bp\">$</span> <span class=\"n\">my_ring</span> <span class=\"n\">M</span> <span class=\"o\">:=</span> <span class=\"gr\">sorry</span>\n\n<span class=\"kd\">set_option</span> <span class=\"n\">profiler</span> <span class=\"n\">true</span>\n<span class=\"kd\">set_option</span> <span class=\"n\">profiler.freq</span> <span class=\"mi\">1</span>\n\n<span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">my_ideal</span> <span class=\"o\">:</span> <span class=\"n\">ideal</span> <span class=\"bp\">$</span> <span class=\"n\">my_ring</span> <span class=\"n\">M</span> <span class=\"o\">:=</span> <span class=\"n\">ideal.span</span> <span class=\"o\">{</span><span class=\"n\">adjoin_root.mk</span> <span class=\"o\">(</span><span class=\"n\">my_polynomial</span> <span class=\"n\">M</span><span class=\"o\">)</span> <span class=\"n\">X</span><span class=\"o\">}</span>\n<span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">my_units</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">fractional_ideal</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span><span class=\"bp\">⁰</span> <span class=\"bp\">$</span> <span class=\"n\">fraction_ring</span> <span class=\"bp\">$</span> <span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span><span class=\"bp\">ˣ</span> <span class=\"o\">:=</span> <span class=\"o\">⟨</span><span class=\"n\">my_ideal</span> <span class=\"n\">M</span><span class=\"o\">,</span> <span class=\"n\">my_ideal</span> <span class=\"n\">M</span><span class=\"o\">,</span> <span class=\"gr\">sorry</span><span class=\"o\">,</span> <span class=\"gr\">sorry</span><span class=\"o\">⟩</span>\n<span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">my_class</span> <span class=\"o\">:</span> <span class=\"n\">class_group</span> <span class=\"bp\">$</span> <span class=\"n\">my_ring</span> <span class=\"n\">M</span> <span class=\"o\">:=</span> <span class=\"n\">class_group.mk</span> <span class=\"bp\">$</span> <span class=\"n\">my_units</span> <span class=\"n\">M</span> <span class=\"c1\">-- ~10s</span>\n</code></pre></div>\n<p>The complete version of this is in <a href=\"https://github.com/leanprover-community/mathlib/blob/20856a1ac218a2e287c28b341eae0329fcf060f5/src/algebraic_geometry/elliptic_curve/point.lean#L618\">the associativity branch</a>, which has the theorem I want to prove but times out. Why is <code>class_group.mk</code> so slow? Is it because the construction just has too many layers for Lean to parse in time? Are there any speed-up tricks I can do to go around this problem?</p>\n<p>This is a continuation of <a href=\"#narrow/stream/116395-maths/topic/thoughts.20on.20elliptic.20curves/near/310230907\">the speed issue in the elliptic curves thread</a> that is still unresolved.</p>",
        "id": 316468700,
        "sender_full_name": "David Ang",
        "timestamp": 1671288247
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib_docs/find/class_group.mk\">docs#class_group.mk</a></p>",
        "id": 316472988,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1671289989
    },
    {
        "content": "<p>On my computer it's faster, less than 4s. I'm on commit 809e920edf, or maybe just my machine is faster (i9-9880H @ 2.30GHz).<br>\nTwo observations: first,</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">my_class'</span> <span class=\"o\">:</span> <span class=\"n\">class_group</span> <span class=\"bp\">$</span> <span class=\"n\">my_ring</span> <span class=\"n\">M</span> <span class=\"o\">:=</span>\n<span class=\"n\">class_group.mk</span> <span class=\"o\">⟨(</span><span class=\"n\">my_ideal</span> <span class=\"n\">M</span> <span class=\"o\">:</span> <span class=\"n\">fractional_ideal</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span><span class=\"bp\">⁰</span> <span class=\"bp\">$</span> <span class=\"n\">fraction_ring</span> <span class=\"bp\">$</span> <span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">),</span>\n  <span class=\"n\">my_ideal</span> <span class=\"n\">M</span><span class=\"o\">,</span> <span class=\"gr\">sorry</span><span class=\"o\">,</span> <span class=\"gr\">sorry</span><span class=\"o\">⟩</span>\n</code></pre></div>\n<p>is fast enough (&lt;0.7s).<br>\nSecond, if I add a \"shortcut\" instance</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">noncomputable</span> <span class=\"kd\">instance</span> <span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">algebra</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">fraction_ring</span> <span class=\"bp\">$</span> <span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">infer_instance</span>\n</code></pre></div>\n<p>then the version above takes ~1.1s, while your original version times out (&gt;1min).</p>",
        "id": 316624487,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1671389049
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/stream/116395-maths/topic/Why.20is.20class_group.2Emk.20so.20slow.3F/near/316624487\">said</a>:</p>\n<blockquote>\n<p>On my computer it's faster, less than 4s. I'm on commit 809e920edf, or maybe just my machine is faster (i9-9880H @ 2.30GHz).<br>\nTwo observations: first,</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">my_class'</span> <span class=\"o\">:</span> <span class=\"n\">class_group</span> <span class=\"bp\">$</span> <span class=\"n\">my_ring</span> <span class=\"n\">M</span> <span class=\"o\">:=</span>\n<span class=\"n\">class_group.mk</span> <span class=\"o\">⟨(</span><span class=\"n\">my_ideal</span> <span class=\"n\">M</span> <span class=\"o\">:</span> <span class=\"n\">fractional_ideal</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span><span class=\"bp\">⁰</span> <span class=\"bp\">$</span> <span class=\"n\">fraction_ring</span> <span class=\"bp\">$</span> <span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">),</span>\n  <span class=\"n\">my_ideal</span> <span class=\"n\">M</span><span class=\"o\">,</span> <span class=\"gr\">sorry</span><span class=\"o\">,</span> <span class=\"gr\">sorry</span><span class=\"o\">⟩</span>\n</code></pre></div>\n<p>is fast enough (&lt;0.7s).<br>\nSecond, if I add a \"shortcut\" instance</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">noncomputable</span> <span class=\"kd\">instance</span> <span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">algebra</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">fraction_ring</span> <span class=\"bp\">$</span> <span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">infer_instance</span>\n</code></pre></div>\n<p>then the version above takes ~1.1s, while your original version times out (&gt;1min).</p>\n</blockquote>\n<p>The shortcut instance doesn't really do much for me, but replacing <code>my_units M</code> with its definition does elaborate the definition significantly faster. The problem with this is that each of these <code>sorry</code>s is very long when filled in properly, and it's not realistic to copy the entire unit structure everywhere. I did try replacing every definition/lemma in the result I'm trying to prove with their actual definition/proofs and it does elaborate within somewhat reasonable time, but the proof becomes extremely wordy i.e. essentially squeezing most of the definitions and lemmas from line 472 to line 623 in the branch into one proof.</p>\n<p>I don't know why your version is significantly faster, but I'm guessing this is some reducibility or elaboration order issue that I don't know how to control at all. In the original branch I've tried making the analogue of <code>my_ring</code> reducible, and even introduced something like a reducible <code>function_field := fraction_ring $ my_ring M</code>, and it seems to make everything even slower.</p>",
        "id": 316657888,
        "sender_full_name": "David Ang",
        "timestamp": 1671416347
    },
    {
        "content": "<blockquote>\n<p>The shortcut instance doesn't really do much for me</p>\n</blockquote>\n<p>Yes, what I observed is that it makes things <em>slower</em>, which is puzzling. It's also puzzling that replacing my_units M with its definition makes things faster.</p>",
        "id": 316668980,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1671427133
    },
    {
        "content": "<p>Let me take a look. If adding a shortcut instance makes it slower, it's probably the unifier that is being slow.</p>",
        "id": 316714311,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1671447828
    },
    {
        "content": "<p>Indeed, <code>set_option trace.class_instances</code> true gives about 5x more output for <code>my_units</code> than <code>my_class</code>, while <code>my_units</code> is about 3x faster than <code>my_class</code>.</p>",
        "id": 316714701,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1671447954
    },
    {
        "content": "<p>As I suspected: <code>set_option trace.type_context.is_def_eq_detail true</code> gives about 240 000 lines of output on <code>my_class</code> before timing out. From the trace, it seems we're triggering unification inside types, which Lean is very slow at:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]:</span> <span class=\"o\">(</span><span class=\"n\">fractional_ideal</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span><span class=\"bp\">⁰</span> <span class=\"o\">(</span><span class=\"n\">fraction_ring</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)))</span><span class=\"bp\">ˣ</span> <span class=\"bp\">=?=</span> <span class=\"o\">(</span><span class=\"n\">fractional_ideal</span> <span class=\"bp\">?</span><span class=\"n\">m_3⁰</span> <span class=\"bp\">?</span><span class=\"n\">m_5</span><span class=\"o\">)</span><span class=\"bp\">ˣ</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">]:</span> <span class=\"n\">units</span> <span class=\"bp\">=?=</span> <span class=\"n\">units</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">]:</span> <span class=\"n\">fractional_ideal</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span><span class=\"bp\">⁰</span> <span class=\"o\">(</span><span class=\"n\">fraction_ring</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">))</span> <span class=\"bp\">=?=</span> <span class=\"n\">fractional_ideal</span> <span class=\"bp\">?</span><span class=\"n\">m_3⁰</span> <span class=\"bp\">?</span><span class=\"n\">m_5</span>\n<span class=\"bp\">...</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">]:</span> <span class=\"n\">my_ring.comm_ring</span> <span class=\"n\">M</span> <span class=\"bp\">=?=</span> <span class=\"n\">my_ring.comm_ring</span> <span class=\"n\">M</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">]:</span> <span class=\"n\">localization.comm_ring</span> <span class=\"bp\">=?=</span> <span class=\"n\">euclidean_domain.to_comm_ring</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"n\">unfold</span> <span class=\"n\">left</span><span class=\"o\">:</span> <span class=\"n\">localization.comm_ring</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">]:</span> <span class=\"o\">{</span><span class=\"n\">add</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.add</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">add_assoc</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zero</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.zero</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">zero_add</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_zero</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">nsmul</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.nsmul</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">nsmul_zero'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">nsmul_succ'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">neg</span> <span class=\"o\">:=</span> <span class=\"n\">has_neg.neg</span> <span class=\"n\">localization.has_neg</span><span class=\"o\">,</span>\n <span class=\"n\">sub</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">localization</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span><span class=\"bp\">⁰</span><span class=\"o\">),</span> <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"bp\">-</span><span class=\"n\">y</span><span class=\"o\">,</span>\n <span class=\"n\">sub_eq_add_neg</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul</span> <span class=\"o\">:=</span> <span class=\"n\">has_smul.smul</span> <span class=\"n\">localization.has_smul</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul_zero'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul_succ'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul_neg'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_left_neg</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_comm</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">int_cast</span> <span class=\"o\">:=</span> <span class=\"n\">ring.int_cast._default</span> <span class=\"n\">comm_semiring.nat_cast</span> <span class=\"n\">comm_semiring.add</span> <span class=\"n\">localization.comm_ring._proof_13</span>\n               <span class=\"n\">comm_semiring.zero</span>\n               <span class=\"n\">localization.comm_ring._proof_14</span>\n               <span class=\"n\">localization.comm_ring._proof_15</span>\n               <span class=\"n\">comm_semiring.nsmul</span>\n               <span class=\"n\">localization.comm_ring._proof_16</span>\n               <span class=\"n\">localization.comm_ring._proof_17</span>\n               <span class=\"n\">comm_semiring.one</span>\n               <span class=\"n\">localization.comm_ring._proof_18</span>\n               <span class=\"n\">localization.comm_ring._proof_19</span>\n               <span class=\"n\">has_neg.neg</span>\n               <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">localization</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span><span class=\"bp\">⁰</span><span class=\"o\">),</span> <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"bp\">-</span><span class=\"n\">y</span><span class=\"o\">)</span>\n               <span class=\"n\">localization.comm_ring._proof_20</span>\n               <span class=\"n\">has_smul.smul</span>\n               <span class=\"n\">localization.comm_ring._proof_21</span>\n               <span class=\"n\">localization.comm_ring._proof_22</span>\n               <span class=\"n\">localization.comm_ring._proof_23</span>\n               <span class=\"n\">localization.comm_ring._proof_24</span><span class=\"o\">,</span>\n <span class=\"n\">nat_cast</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.nat_cast</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">one</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.one</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">nat_cast_zero</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">nat_cast_succ</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">int_cast_of_nat</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">int_cast_neg_succ_of_nat</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.mul</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">mul_assoc</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">one_mul</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul_one</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">npow</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.npow</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">npow_zero'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">npow_succ'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">left_distrib</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">right_distrib</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul_comm</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">}</span> <span class=\"bp\">=?=</span> <span class=\"n\">euclidean_domain.to_comm_ring</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"o\">]:</span> <span class=\"o\">{</span><span class=\"n\">add</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.add</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">add_assoc</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zero</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.zero</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">zero_add</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_zero</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">nsmul</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.nsmul</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">nsmul_zero'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">nsmul_succ'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">neg</span> <span class=\"o\">:=</span> <span class=\"n\">has_neg.neg</span> <span class=\"n\">localization.has_neg</span><span class=\"o\">,</span>\n <span class=\"n\">sub</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">localization</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span><span class=\"bp\">⁰</span><span class=\"o\">),</span> <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"bp\">-</span><span class=\"n\">y</span><span class=\"o\">,</span>\n <span class=\"n\">sub_eq_add_neg</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul</span> <span class=\"o\">:=</span> <span class=\"n\">has_smul.smul</span> <span class=\"n\">localization.has_smul</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul_zero'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul_succ'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul_neg'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_left_neg</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_comm</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">int_cast</span> <span class=\"o\">:=</span> <span class=\"n\">ring.int_cast._default</span> <span class=\"n\">comm_semiring.nat_cast</span> <span class=\"n\">comm_semiring.add</span> <span class=\"n\">localization.comm_ring._proof_13</span>\n               <span class=\"n\">comm_semiring.zero</span>\n               <span class=\"n\">localization.comm_ring._proof_14</span>\n               <span class=\"n\">localization.comm_ring._proof_15</span>\n               <span class=\"n\">comm_semiring.nsmul</span>\n               <span class=\"n\">localization.comm_ring._proof_16</span>\n               <span class=\"n\">localization.comm_ring._proof_17</span>\n               <span class=\"n\">comm_semiring.one</span>\n               <span class=\"n\">localization.comm_ring._proof_18</span>\n               <span class=\"n\">localization.comm_ring._proof_19</span>\n               <span class=\"n\">has_neg.neg</span>\n               <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">localization</span> <span class=\"o\">(</span><span class=\"n\">my_ring</span> <span class=\"n\">M</span><span class=\"o\">)</span><span class=\"bp\">⁰</span><span class=\"o\">),</span> <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"bp\">-</span><span class=\"n\">y</span><span class=\"o\">)</span>\n               <span class=\"n\">localization.comm_ring._proof_20</span>\n               <span class=\"n\">has_smul.smul</span>\n               <span class=\"n\">localization.comm_ring._proof_21</span>\n               <span class=\"n\">localization.comm_ring._proof_22</span>\n               <span class=\"n\">localization.comm_ring._proof_23</span>\n               <span class=\"n\">localization.comm_ring._proof_24</span><span class=\"o\">,</span>\n <span class=\"n\">nat_cast</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.nat_cast</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">one</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.one</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">nat_cast_zero</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">nat_cast_succ</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">int_cast_of_nat</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">int_cast_neg_succ_of_nat</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.mul</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">mul_assoc</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">one_mul</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul_one</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">npow</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring.npow</span> <span class=\"n\">localization.comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">npow_zero'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">npow_succ'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">left_distrib</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">right_distrib</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul_comm</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">}</span> <span class=\"bp\">=?=</span> <span class=\"o\">{</span><span class=\"n\">add</span> <span class=\"o\">:=</span> <span class=\"n\">has_add.add</span> <span class=\"o\">(</span><span class=\"n\">distrib.to_has_add</span> <span class=\"bp\">?</span><span class=\"n\">m_3</span><span class=\"o\">),</span>\n <span class=\"n\">add_assoc</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zero</span> <span class=\"o\">:=</span> <span class=\"mi\">0</span><span class=\"o\">,</span>\n <span class=\"n\">zero_add</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_zero</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">nsmul</span> <span class=\"o\">:=</span> <span class=\"n\">field.nsmul</span> <span class=\"bp\">?</span><span class=\"n\">m_4</span><span class=\"o\">,</span>\n <span class=\"n\">nsmul_zero'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">nsmul_succ'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">neg</span> <span class=\"o\">:=</span> <span class=\"n\">has_neg.neg</span> <span class=\"o\">(</span><span class=\"n\">sub_neg_monoid.to_has_neg</span> <span class=\"bp\">?</span><span class=\"n\">m_3</span><span class=\"o\">),</span>\n <span class=\"n\">sub</span> <span class=\"o\">:=</span> <span class=\"n\">field.sub</span> <span class=\"bp\">?</span><span class=\"n\">m_4</span><span class=\"o\">,</span>\n <span class=\"n\">sub_eq_add_neg</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul</span> <span class=\"o\">:=</span> <span class=\"n\">field.zsmul</span> <span class=\"bp\">?</span><span class=\"n\">m_4</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul_zero'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul_succ'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zsmul_neg'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_left_neg</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_comm</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">int_cast</span> <span class=\"o\">:=</span> <span class=\"n\">field.int_cast</span> <span class=\"bp\">?</span><span class=\"n\">m_4</span><span class=\"o\">,</span>\n <span class=\"n\">nat_cast</span> <span class=\"o\">:=</span> <span class=\"n\">field.nat_cast</span> <span class=\"bp\">?</span><span class=\"n\">m_4</span><span class=\"o\">,</span>\n <span class=\"n\">one</span> <span class=\"o\">:=</span> <span class=\"mi\">1</span><span class=\"o\">,</span>\n <span class=\"n\">nat_cast_zero</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">nat_cast_succ</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">int_cast_of_nat</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">int_cast_neg_succ_of_nat</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul</span> <span class=\"o\">:=</span> <span class=\"n\">has_mul.mul</span> <span class=\"o\">(</span><span class=\"n\">distrib.to_has_mul</span> <span class=\"bp\">?</span><span class=\"n\">m_3</span><span class=\"o\">),</span>\n <span class=\"n\">mul_assoc</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">one_mul</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul_one</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">npow</span> <span class=\"o\">:=</span> <span class=\"n\">field.npow</span> <span class=\"bp\">?</span><span class=\"n\">m_4</span><span class=\"o\">,</span>\n <span class=\"n\">npow_zero'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">npow_succ'</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">left_distrib</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">right_distrib</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul_comm</span> <span class=\"o\">:=</span> <span class=\"n\">_</span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 316715891,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1671448388
    },
    {
        "content": "<p>Thanks so much Anne!</p>",
        "id": 316716687,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1671448682
    },
    {
        "content": "<p>Okay, so one solution is to add <code>attribute [irreducible] my_ring.comm_ring</code>, which at least will block the type-level unification at a doable level. That cuts elaboration time on my machine by a factor 6 or so.</p>",
        "id": 316717977,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1671449113
    },
    {
        "content": "<p>Making other things irreducible either doesn't help much or causes errors because diamond inheritance doesn't line up anymore.</p>",
        "id": 316718227,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1671449218
    },
    {
        "content": "<p>I was looking for another thread where we discuss this, but can't find anything good. In short: under some circumstances (which might just be \"always\"), checking the definitional equality of two terms requires checking the equality of their types, which can require checking the types' types' equality, etc. And under some circumstances, Lean does not cache these equalities of types, which means  it has to recheck the types are equal, and the types' types, and so on. So Lean will do something like (term size)^(type complexity) defeq checks in this case, which is quite slow.</p>\n<p>I recall that there are cases where this checking is indeed needed, and definitional structure eta in Lean 4 might shrink the set of circumstances that trigger this bad behaviour. Still I'd like to see this fixed in these common cases, especially where making things irreducible speeds it up so much.</p>",
        "id": 316721074,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1671450125
    },
    {
        "content": "<p>Until then your best bet is to make as many definitions that are defined in terms of other types <code>irreducible</code> or <code>structure</code>s.</p>",
        "id": 316721437,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1671450262
    },
    {
        "content": "<p>Just to be clear, by type complexity I'm talking about the nesting depth in <code>units (fractional_ideal (localization (non_zero_divisors (quotient (ideal (polynomial (polynomial K)))))))</code>, each head of which depends on some sort of ring instance on the type inside it.</p>",
        "id": 316721740,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1671450369
    },
    {
        "content": "<p>Thank you so much for this! The result I wanted to prove now elaborates within reasonable time at around ~30 seconds on my machine.</p>",
        "id": 316735381,
        "sender_full_name": "David Ang",
        "timestamp": 1671455088
    },
    {
        "content": "<p>Thanks! I guess the blowup issue fixed at <a href=\"https://github.com/leanprover/lean4/pull/1102\">lean4#1102</a> is related?</p>",
        "id": 316751139,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1671458796
    }
]