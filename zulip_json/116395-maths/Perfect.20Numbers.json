[
    {
        "content": "<p>I have a rough but working proof of the Perfect Number/Euclid-Euler Theorem, Freek 70, at <a href=\"https://github.com/awainverse/perfect_number\">https://github.com/awainverse/perfect_number</a></p>",
        "id": 201098280,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592364604
    },
    {
        "content": "<p>I’m interested in people’s input on several things. One thing that comes to mind is whether some of the nat variables should be replaced with pnats.</p>",
        "id": 201098342,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592364705
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"302826\">@Aaron Anderson</span> Interesting! I will write some feedback after breakfast.</p>",
        "id": 201102012,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592370307
    },
    {
        "content": "<p>If it builds, then we can add it to our list.</p>",
        "id": 201102122,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1592370473
    },
    {
        "content": "<p>Could you please open a PR to <code>mathlib/archive</code>? We'll probably want to merge some parts to <code>src/</code> but it would be nice to have a green light from CI before adding a link to this PR to the website.</p>",
        "id": 201102195,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1592370576
    },
    {
        "content": "<p>I'm trying to figure out how, but creating my own repository to host this today was already stretching my understanding of github...</p>",
        "id": 201104062,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592373417
    },
    {
        "content": "<p>I just downloaded the repo and it built locally with no warnings or errors.</p>",
        "id": 201104148,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1592373539
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"302826\">@Aaron Anderson</span> We can coach you through it.</p>",
        "id": 201104312,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592373745
    },
    {
        "content": "<p>Are you on windows or linux?</p>",
        "id": 201104346,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592373814
    },
    {
        "content": "<p>(Or mac...)</p>",
        "id": 201104351,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592373818
    },
    {
        "content": "<p>Linux.</p>",
        "id": 201104411,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592373874
    },
    {
        "content": "<p>Ooh great, than it's easy-peasy</p>",
        "id": 201104416,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592373884
    },
    {
        "content": "<p>You should have just received an email with an invitation for write access to mathlib.</p>",
        "id": 201104431,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592373907
    },
    {
        "content": "<p>I know a few of the basic git commands at this point</p>",
        "id": 201104435,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592373916
    },
    {
        "content": "<p>Do you by chance have <code>leanproject</code> installed?</p>",
        "id": 201104446,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592373941
    },
    {
        "content": "<p>Yes, and I used that to create my perfect_number repo</p>",
        "id": 201104455,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592373959
    },
    {
        "content": "<p>Ok, great.</p>",
        "id": 201104586,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374125
    },
    {
        "content": "<p>(I've accepted the email invitation)</p>",
        "id": 201104593,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592374137
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"302826\">@Aaron Anderson</span> so if you accept that invitation, and then <code>leanproject get mathlib</code> (in a directory where you do not yet have a copy of mathlib), then you are halfway there.</p>",
        "id": 201104605,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374158
    },
    {
        "content": "<p>Ok, I've done that, and have a \"mathlib\" folder on my computer.</p>",
        "id": 201104718,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592374320
    },
    {
        "content": "<p>After that, you can write</p>\n<div class=\"codehilite\"><pre><span></span><code>git checkout -b freek-70\n</code></pre></div>",
        "id": 201104756,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374328
    },
    {
        "content": "<p>This creates a new branch, for your PR</p>",
        "id": 201104760,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374339
    },
    {
        "content": "<p>After that, you have to copy your file to<br>\n<code>archive/100-theorems-list/70_perfect_numbers.lean</code></p>",
        "id": 201104781,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374383
    },
    {
        "content": "<p>(Or something like that)</p>",
        "id": 201104785,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374390
    },
    {
        "content": "<p>And then</p>\n<div class=\"codehilite\"><pre><span></span><code>git add archive/100-theorems-list/70_perfect_numbers.lean\ngit commit\n</code></pre></div>",
        "id": 201104793,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374424
    },
    {
        "content": "<p>In the commit message, you can use something like</p>\n<div class=\"codehilite\"><pre><span></span><code>feat(archive/100-theorems-list): perfect numbers (nr 70)\n</code></pre></div>\n\n\n<p>or something better (-;</p>",
        "id": 201104846,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374472
    },
    {
        "content": "<p>Once you have done that:</p>\n<div class=\"codehilite\"><pre><span></span><code>git push\n</code></pre></div>\n\n\n<p>and this will give an error message, saying that you need to set an upstream thingy. It will tell you which command to execute instead. Do that.</p>",
        "id": 201104878,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374540
    },
    {
        "content": "<p>This last command will give you a URL in it's output. You can visit that URL to open a PR.<br>\n(Alternatively, just go to the mathlib page on github, and it will recognise that you recently pushed a branch, and suggest to open a PR.)</p>",
        "id": 201104943,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374598
    },
    {
        "content": "<p>Finally, you can (if you want <span aria-label=\"stuck out tongue wink\" class=\"emoji emoji-1f61c\" role=\"img\" title=\"stuck out tongue wink\">:stuck_out_tongue_wink:</span>) post a message here of the form <code>#3057</code> where <code>3057</code> is the PR number on the github page, and Zulip will automatically turn it into a link that we can click on to see your latest creation.</p>",
        "id": 201104963,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374655
    },
    {
        "content": "<p>Now for some feedback on the code. I've gone through the first 100 lines or so.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">totient</span>\n\n<span class=\"n\">open_locale</span> <span class=\"n\">classical</span>\n<span class=\"n\">open_locale</span> <span class=\"n\">big_operators</span>\n\n<span class=\"kn\">section</span> <span class=\"n\">definitions</span>\n\n<span class=\"kn\">variable</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span>\n\n<span class=\"n\">def</span> <span class=\"n\">divisors</span> <span class=\"o\">:</span> <span class=\"n\">finset</span> <span class=\"bp\">ℕ</span> <span class=\"o\">:=</span>\n<span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">filter</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span> <span class=\"n\">x</span> <span class=\"err\">∣</span> <span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">Ico</span> <span class=\"mi\">1</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">))</span>\n\n<span class=\"n\">def</span> <span class=\"n\">proper_divisors</span> <span class=\"o\">:</span> <span class=\"n\">finset</span> <span class=\"bp\">ℕ</span> <span class=\"o\">:=</span>\n<span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">filter</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span> <span class=\"n\">x</span> <span class=\"err\">∣</span> <span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">Ico</span> <span class=\"mi\">1</span> <span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">not_proper_self</span> <span class=\"o\">:</span>\n  <span class=\"n\">n</span> <span class=\"err\">∉</span> <span class=\"n\">proper_divisors</span> <span class=\"n\">n</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">proper_divisors</span><span class=\"o\">]</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">mem_divisors</span> <span class=\"o\">{</span><span class=\"n\">m</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">:</span>\n<span class=\"n\">n</span> <span class=\"err\">∈</span> <span class=\"n\">divisors</span> <span class=\"n\">m</span> <span class=\"bp\">↔</span> <span class=\"n\">n</span> <span class=\"err\">∣</span> <span class=\"n\">m</span> <span class=\"bp\">∧</span> <span class=\"n\">m</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span><span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n  <span class=\"n\">suffices</span> <span class=\"o\">:</span> <span class=\"n\">n</span> <span class=\"err\">∣</span> <span class=\"n\">m</span> <span class=\"bp\">∧</span> <span class=\"mi\">1</span> <span class=\"bp\">≤</span> <span class=\"n\">n</span> <span class=\"bp\">∧</span> <span class=\"n\">n</span> <span class=\"bp\">&lt;</span> <span class=\"n\">m</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span> <span class=\"bp\">↔</span> <span class=\"n\">n</span> <span class=\"err\">∣</span> <span class=\"n\">m</span> <span class=\"bp\">∧</span> <span class=\"bp\">¬</span><span class=\"n\">m</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span><span class=\"o\">,</span>\n  <span class=\"k\">by</span> <span class=\"n\">simpa</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">divisors</span><span class=\"o\">,</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">Ico</span><span class=\"bp\">.</span><span class=\"n\">mem</span><span class=\"o\">,</span> <span class=\"n\">ne</span><span class=\"bp\">.</span><span class=\"n\">def</span><span class=\"o\">,</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">mem_filter</span><span class=\"o\">,</span> <span class=\"n\">and_comm</span><span class=\"o\">],</span>\n  <span class=\"n\">split</span><span class=\"o\">,</span>\n  <span class=\"o\">{</span> <span class=\"n\">intro</span> <span class=\"n\">hyp</span><span class=\"o\">,</span> <span class=\"n\">refine</span> <span class=\"bp\">⟨</span><span class=\"n\">hyp</span><span class=\"bp\">.</span><span class=\"n\">left</span><span class=\"o\">,</span> <span class=\"bp\">_⟩</span><span class=\"o\">,</span> <span class=\"k\">have</span> <span class=\"n\">h1</span> <span class=\"o\">:=</span> <span class=\"n\">hyp</span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"o\">,</span> <span class=\"n\">omega</span> <span class=\"o\">},</span>\n  <span class=\"o\">{</span> <span class=\"n\">intro</span> <span class=\"n\">hyp</span><span class=\"o\">,</span> <span class=\"n\">refine</span> <span class=\"bp\">⟨</span><span class=\"n\">hyp</span><span class=\"bp\">.</span><span class=\"n\">left</span><span class=\"o\">,</span> <span class=\"bp\">_⟩</span><span class=\"o\">,</span>\n    <span class=\"n\">rcases</span> <span class=\"n\">hyp</span> <span class=\"k\">with</span> <span class=\"bp\">⟨⟨</span><span class=\"n\">c</span><span class=\"o\">,</span> <span class=\"n\">rfl</span><span class=\"bp\">⟩</span><span class=\"o\">,</span> <span class=\"n\">nonzero</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n    <span class=\"n\">split</span><span class=\"o\">,</span>\n    <span class=\"o\">{</span> <span class=\"n\">cases</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n      <span class=\"o\">{</span> <span class=\"n\">simpa</span> <span class=\"kn\">using</span> <span class=\"n\">nonzero</span> <span class=\"o\">},</span>\n      <span class=\"o\">{</span> <span class=\"n\">exact</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">le_add_left</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">,</span> <span class=\"o\">},</span> <span class=\"o\">},</span>\n    <span class=\"o\">{</span> <span class=\"n\">cases</span> <span class=\"n\">c</span><span class=\"o\">,</span>\n      <span class=\"o\">{</span> <span class=\"n\">simpa</span> <span class=\"kn\">using</span> <span class=\"n\">nonzero</span> <span class=\"o\">},</span>\n      <span class=\"o\">{</span> <span class=\"k\">calc</span> <span class=\"n\">n</span> <span class=\"bp\">=</span> <span class=\"n\">n</span> <span class=\"bp\">*</span> <span class=\"mi\">1</span>           <span class=\"o\">:</span> <span class=\"k\">by</span> <span class=\"n\">rw</span> <span class=\"n\">mul_one</span>\n           <span class=\"bp\">...</span> <span class=\"bp\">≤</span> <span class=\"n\">n</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">)</span>     <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">mul_le_mul_left</span> <span class=\"bp\">_</span> <span class=\"o\">(</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">le_add_left</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">)</span>\n           <span class=\"bp\">...</span> <span class=\"bp\">&lt;</span> <span class=\"n\">n</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">lt_succ_self</span> <span class=\"bp\">_</span><span class=\"o\">,</span> <span class=\"o\">}</span> <span class=\"o\">}</span> <span class=\"o\">}</span>\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">variable</span> <span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">}</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">le_of_mem_divisors</span> <span class=\"o\">{</span><span class=\"n\">m</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">n</span> <span class=\"err\">∈</span> <span class=\"n\">divisors</span> <span class=\"n\">m</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">n</span> <span class=\"bp\">≤</span> <span class=\"n\">m</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"o\">{</span> <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">mem_divisors</span><span class=\"o\">,</span> <span class=\"err\">←</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pos_iff_ne_zero</span><span class=\"o\">]</span> <span class=\"n\">at</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">apply</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">le_of_dvd</span> <span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"mi\">2</span> <span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"mi\">1</span> <span class=\"o\">}</span>\n\n<span class=\"kn\">variable</span> <span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"c1\">--lemma mem_proper_divisors : sorry := sorry</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">divisors_eq_proper_divisors_insert_self</span> <span class=\"o\">(</span><span class=\"n\">posn</span> <span class=\"o\">:</span> <span class=\"mi\">0</span> <span class=\"bp\">&lt;</span> <span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n  <span class=\"n\">divisors</span> <span class=\"n\">n</span> <span class=\"bp\">=</span> <span class=\"n\">insert</span> <span class=\"n\">n</span> <span class=\"o\">(</span><span class=\"n\">proper_divisors</span> <span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n  <span class=\"n\">ext</span><span class=\"o\">,</span>\n  <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">mem_insert</span><span class=\"o\">,</span> <span class=\"n\">divisors</span><span class=\"o\">,</span> <span class=\"n\">proper_divisors</span><span class=\"o\">,</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">Ico</span><span class=\"bp\">.</span><span class=\"n\">succ_top</span> <span class=\"n\">posn</span><span class=\"o\">,</span>\n    <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">filter_insert</span><span class=\"o\">,</span> <span class=\"n\">if_true</span><span class=\"o\">,</span> <span class=\"n\">dvd_refl</span><span class=\"o\">,</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">mem_insert</span><span class=\"o\">],</span>\n<span class=\"kn\">end</span>\n\n<span class=\"n\">def</span> <span class=\"n\">sum_divisors</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span> <span class=\"o\">:=</span>\n<span class=\"err\">∑</span> <span class=\"n\">i</span> <span class=\"k\">in</span> <span class=\"n\">divisors</span> <span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"n\">i</span>\n\n<span class=\"n\">def</span> <span class=\"n\">sum_proper_divisors</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span> <span class=\"o\">:=</span>\n<span class=\"err\">∑</span> <span class=\"n\">i</span> <span class=\"k\">in</span> <span class=\"n\">proper_divisors</span> <span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"n\">i</span>\n\n<span class=\"bp\">@</span><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span> <span class=\"kn\">lemma</span> <span class=\"n\">divisors_zero</span> <span class=\"o\">:</span> <span class=\"n\">divisors</span> <span class=\"mi\">0</span> <span class=\"bp\">=</span> <span class=\"err\">∅</span> <span class=\"o\">:=</span> <span class=\"n\">dec_trivial</span>\n\n<span class=\"bp\">@</span><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span> <span class=\"kn\">lemma</span> <span class=\"n\">proper_divisors_zero</span> <span class=\"o\">:</span> <span class=\"n\">proper_divisors</span> <span class=\"mi\">0</span> <span class=\"bp\">=</span> <span class=\"err\">∅</span> <span class=\"o\">:=</span> <span class=\"n\">dec_trivial</span>\n\n<span class=\"bp\">@</span><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span> <span class=\"kn\">lemma</span> <span class=\"n\">sum_divisors_zero</span> <span class=\"o\">:</span> <span class=\"n\">sum_divisors</span> <span class=\"mi\">0</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span> <span class=\"o\">:=</span> <span class=\"n\">dec_trivial</span>\n\n<span class=\"bp\">@</span><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span> <span class=\"kn\">lemma</span> <span class=\"n\">sum_proper_divisors_zero</span> <span class=\"o\">:</span> <span class=\"n\">sum_proper_divisors</span> <span class=\"mi\">0</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span> <span class=\"o\">:=</span> <span class=\"n\">dec_trivial</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">sum_divisors_eq_sum_proper_divisors_add_self</span> <span class=\"o\">:</span>\n<span class=\"n\">sum_divisors</span> <span class=\"n\">n</span> <span class=\"bp\">=</span> <span class=\"n\">sum_proper_divisors</span> <span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"n\">n</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n  <span class=\"n\">by_cases</span> <span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">n</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"o\">{</span> <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span> <span class=\"o\">},</span>\n  <span class=\"n\">replace</span> <span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"mi\">0</span> <span class=\"bp\">&lt;</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pos_iff_ne_zero</span><span class=\"bp\">.</span><span class=\"n\">mpr</span> <span class=\"n\">h</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">sum_divisors</span><span class=\"o\">,</span> <span class=\"n\">sum_proper_divisors</span><span class=\"o\">,</span> <span class=\"n\">divisors_eq_proper_divisors_insert_self</span> <span class=\"bp\">_</span> <span class=\"n\">h</span><span class=\"o\">,</span>\n    <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">sum_insert</span> <span class=\"o\">(</span><span class=\"n\">not_proper_self</span> <span class=\"bp\">_</span><span class=\"o\">),</span> <span class=\"n\">add_comm</span><span class=\"o\">],</span>\n<span class=\"kn\">end</span>\n\n<span class=\"n\">def</span> <span class=\"n\">perfect</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span>\n<span class=\"n\">sum_proper_divisors</span> <span class=\"n\">n</span> <span class=\"bp\">=</span> <span class=\"n\">n</span>\n\n<span class=\"kn\">end</span> <span class=\"n\">definitions</span>\n\n<span class=\"kn\">section</span> <span class=\"n\">basic_lemmas</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">perfect_iff_sum_divisors_twice</span> <span class=\"o\">{</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">:</span>\n  <span class=\"n\">perfect</span> <span class=\"n\">n</span> <span class=\"bp\">↔</span> <span class=\"n\">sum_divisors</span> <span class=\"n\">n</span> <span class=\"bp\">=</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">n</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"o\">{</span> <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">sum_divisors_eq_sum_proper_divisors_add_self</span><span class=\"o\">,</span> <span class=\"n\">perfect</span><span class=\"o\">],</span> <span class=\"n\">omega</span> <span class=\"o\">}</span>\n\n<span class=\"bp\">@</span><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span> <span class=\"kn\">lemma</span> <span class=\"n\">divisors_one</span> <span class=\"o\">:</span> <span class=\"n\">divisors</span> <span class=\"mi\">1</span> <span class=\"bp\">=</span> <span class=\"o\">({</span><span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">finset</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"o\">{</span> <span class=\"n\">ext</span><span class=\"o\">,</span> <span class=\"n\">rw</span> <span class=\"n\">mem_divisors</span><span class=\"o\">,</span> <span class=\"n\">simp</span> <span class=\"o\">}</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">one_mem_divisors</span> <span class=\"o\">{</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">nonzero</span> <span class=\"o\">:</span> <span class=\"n\">n</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span><span class=\"o\">):</span>\n<span class=\"mi\">1</span> <span class=\"err\">∈</span> <span class=\"n\">divisors</span> <span class=\"n\">n</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">mem_divisors</span><span class=\"o\">,</span> <span class=\"n\">nonzero</span><span class=\"o\">]</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">self_mem_divisors</span> <span class=\"o\">{</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">nonzero</span> <span class=\"o\">:</span> <span class=\"n\">n</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span><span class=\"o\">):</span>\n  <span class=\"n\">n</span> <span class=\"err\">∈</span> <span class=\"n\">divisors</span> <span class=\"n\">n</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">mem_divisors</span><span class=\"o\">,</span> <span class=\"n\">nonzero</span><span class=\"o\">]</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">pos_sum_divisors</span> <span class=\"o\">{</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">posn</span> <span class=\"o\">:</span> <span class=\"mi\">0</span> <span class=\"bp\">&lt;</span> <span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n  <span class=\"mi\">0</span> <span class=\"bp\">&lt;</span> <span class=\"n\">sum_divisors</span> <span class=\"n\">n</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n  <span class=\"n\">rw</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pos_iff_ne_zero</span> <span class=\"n\">at</span> <span class=\"n\">posn</span><span class=\"o\">,</span>\n  <span class=\"k\">calc</span> <span class=\"mi\">0</span> <span class=\"bp\">=</span> <span class=\"err\">∑</span> <span class=\"n\">i</span> <span class=\"k\">in</span> <span class=\"n\">divisors</span> <span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"mi\">0</span> <span class=\"o\">:</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">sum_const_zero</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n     <span class=\"bp\">...</span> <span class=\"bp\">&lt;</span> <span class=\"n\">sum_divisors</span> <span class=\"n\">n</span>       <span class=\"o\">:</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">sum_lt_sum</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">,</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">zero_le</span> <span class=\"bp\">_</span><span class=\"o\">)</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n  <span class=\"n\">use</span> <span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"n\">exact</span> <span class=\"bp\">⟨</span><span class=\"n\">one_mem_divisors</span> <span class=\"n\">posn</span><span class=\"o\">,</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">zero_lt_one</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"kn\">end</span>\n</code></pre></div>",
        "id": 201105188,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374949
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib/issues/3094\">#3094</a></p>",
        "id": 201105199,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592374965
    },
    {
        "content": "<p>I should say that I think the code was already really good!</p>",
        "id": 201105200,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592374967
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"302826\">@Aaron Anderson</span> Nice!</p>",
        "id": 201105216,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592375005
    },
    {
        "content": "<p>Another thing that can make your life easier: you often need to exclude <code>n = 0</code>. Sometimes you use <code>0 &lt; n</code>, sometimes <code>0 ≠ n</code>. You should choose one, and use it everywhere. It will make it a lot easier to pass the assumption back and forth.<br>\nNow you constantly need to convert between the two versions.</p>",
        "id": 201105273,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592375068
    },
    {
        "content": "<p>I'm still wondering if I do anything that'd make it difficult to just shift to pnats</p>",
        "id": 201105297,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592375134
    },
    {
        "content": "<p>It might help a bit... But I'm not sure if it will matter much</p>",
        "id": 201105376,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592375205
    },
    {
        "content": "<p>I think the correct thing to say here is \"sure, just switch to pnats, and when you find holes in the pnat library just make a PR to mathlib which fixes them\"</p>",
        "id": 201105393,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1592375242
    },
    {
        "content": "<p>Another thing:</p>\n<div class=\"codehilite\"><pre><span></span><code>src/number_theory/lucas_lehmer.lean:def mersenne (p : ℕ) : ℕ := 2^p - 1\n</code></pre></div>",
        "id": 201105397,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592375249
    },
    {
        "content": "<p>You could import that file.</p>",
        "id": 201105401,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592375255
    },
    {
        "content": "<p>Maybe it even contains some lemmas that you could reuse.</p>",
        "id": 201105413,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592375265
    },
    {
        "content": "<p>I think pnats deserve some more love</p>",
        "id": 201105414,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1592375266
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"302826\">@Aaron Anderson</span> and there is also</p>\n<div class=\"codehilite\"><pre><span></span><code>src/data/padics/padic_norm.lean:def padic_val_nat (p : ℕ) (n : ℕ) : ℕ :=\n</code></pre></div>\n\n\n<p>which can help with the <code>multiplicity</code> lemmas</p>",
        "id": 201105483,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592375340
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span> Don't you think that 95% of the code should go into <code>src/</code>?</p>",
        "id": 201105747,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592375618
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"302826\">@Aaron Anderson</span> A lot of your lemmas seem useful and reusable. So we might want to butcher your file into tiny pieces that end up in 10 different places in mathlib.</p>",
        "id": 201105821,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592375689
    },
    {
        "content": "<p>Awesome.</p>",
        "id": 201105833,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592375705
    },
    {
        "content": "<p>I think pnats might be good for defining multiplicative functions in general</p>",
        "id": 201105844,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592375747
    },
    {
        "content": "<p>Feel free to experiment!</p>",
        "id": 201105913,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592375819
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"302826\">@Aaron Anderson</span> By the way, probably relevant: if you want to make changes to the code in the PR, just edit the files in your clone of mathlib, and then <code>git commit -a</code>, write a message, and <code>git push</code>. That's it.</p>",
        "id": 201107280,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592377482
    },
    {
        "content": "<p>I use <code>git commit -am \"message\"</code></p>",
        "id": 201108401,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1592378636
    },
    {
        "content": "<p>Johan, if you don't have a convenient link you could have used instead of writing all those git explanations then you're welcome to copy paste this into our contributing guide, or a new file linked from our contributing guide.</p>",
        "id": 201109317,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1592379416
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/116395-maths/topic/Perfect.20Numbers/near/201105747\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> Don't you think that 95% of the code should go into <code>src/</code>?</p>\n</blockquote>\n<p>I didn't look at the code yet.</p>",
        "id": 201109820,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1592379838
    },
    {
        "content": "<p>I've started refactoring to pnats. Proving inequalities is easier, but the tactics seem much weaker. Along the way, I found that having to switch between pnats and nats made me want to use nat.primes for my prime numbers, but this is maybe too cumbersome...</p>",
        "id": 201231114,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592460803
    },
    {
        "content": "<p>It's in a new file here <a href=\"https://github.com/awainverse/perfect_number\">https://github.com/awainverse/perfect_number</a></p>",
        "id": 201231117,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592460810
    },
    {
        "content": "<p>I'd like to be able to talk about multiplicative functions in general, and prove something to the effect of <code>∀ n : ℕ+, f(n) = (factorisation n).prod (λ p : nat.primes, λ k : ℕ, f (p ^ k))</code> for a multiplicative function f, and factorisation a finsupp of multiplicities</p>",
        "id": 201231297,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592461052
    },
    {
        "content": "<p>I think this is a good argument that I should keep going on pnats, and maybe nat.primes?</p>",
        "id": 201231348,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592461087
    },
    {
        "content": "<p>The reason I would not use pnats if I were knocking off this sort of proof is precisely that they're not as well developed as nats, and the reason they're not as well developed is precisely because people don't use them. This vicious circle is not there for any particular reason and that's why I think keeping going on pnats is a good idea. Any factoring stuff will work better with pnats than nats the moment pnats have the right infrastructure. Pnats are a  monoid with cancellation; monoids with 0 are a different thing somehow</p>",
        "id": 201231971,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1592461884
    },
    {
        "content": "<p>Well, I have no idea how the omega tactic works, other than sometimes it solves my problems with nats, but as I go I'm designating which lemmas about pnats maybe should be simp lemmas</p>",
        "id": 201302646,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592502310
    },
    {
        "content": "<p>I'm proving (usually 2-line proofs or so) a lot of lemmas about pnats which are basically wrappers for existing nat lemmas. I think pnats would be way more useful if there was a common generalization of some kind of divisibility-structure, and facts about coprime and gcd were proved for that.</p>",
        "id": 201455138,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592615362
    },
    {
        "content": "<p>I know that ring_theory/coprime exists, but pnats aren't a semiring, and gcd doesn't seem to be defined in that context.</p>",
        "id": 201455194,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592615415
    },
    {
        "content": "<p>This probably wants some definition of a divisibilty poset?</p>",
        "id": 201455212,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592615479
    },
    {
        "content": "<p>(Not at all necessary just to get this project in mathlib, but it'd be cool to start proving things about multiplicative functions, Dirichlet convolution, and even incidence algebras)</p>",
        "id": 201455256,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592615558
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"302826\">@Aaron Anderson</span> Do you have any idea what kind of structure you need (weaker than semiring) in which you can prove your facts?</p>",
        "id": 201462484,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592629523
    },
    {
        "content": "<p>I guess (tongue in cheek) you might need a <code>canonically_ordered_semirig</code></p>",
        "id": 201462547,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592629668
    },
    {
        "content": "<p>I think that addition is unnecessary, a <code>comm_monoid</code> should be enough context</p>",
        "id": 201462898,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592630339
    },
    {
        "content": "<p>Or perhaps <code>has_dvd</code></p>",
        "id": 201462976,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592630466
    },
    {
        "content": "<p>Incidence algebras would be great!</p>",
        "id": 201462982,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1592630501
    },
    {
        "content": "<p>Something like “if you have an operation called gcd, which is provably equivalent to the sup in the poset with relation dvd, which has sensible properties, then you have these lemmas”</p>",
        "id": 201463042,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592630569
    },
    {
        "content": "<p>I did a tiny bit on incidence algebras a long time ago, its completely broken now <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span> (but I guess this means mathlib has advanced a lot) (and it was badly written / experimental to begin with) but just in case you are curious here is what I had:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">tactic</span>\n<span class=\"kn\">import</span> <span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">rat</span><span class=\"bp\">.</span><span class=\"n\">basic</span>\n<span class=\"kn\">import</span> <span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"bp\">.</span><span class=\"n\">intervals</span>\n<span class=\"kn\">import</span> <span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"bp\">.</span><span class=\"n\">finite</span>\n<span class=\"kn\">import</span> <span class=\"n\">init</span><span class=\"bp\">.</span><span class=\"n\">algebra</span><span class=\"bp\">.</span><span class=\"n\">order</span>\n\n<span class=\"kn\">open</span> <span class=\"n\">nat</span> <span class=\"n\">set</span>\n\n<span class=\"kn\">variable</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span>\n\n<span class=\"n\">class</span> <span class=\"n\">locally_finite</span> <span class=\"kn\">extends</span> <span class=\"n\">partial_order</span> <span class=\"n\">α</span> <span class=\"o\">:=</span>\n<span class=\"o\">(</span><span class=\"n\">fin_Icc</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">fintype</span> <span class=\"o\">(</span><span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">))</span>\n\n<span class=\"n\">def</span> <span class=\"n\">my_Icc</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"n\">m</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"bp\">ℕ</span> <span class=\"o\">:=</span> <span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">range&#39;</span> <span class=\"n\">n</span> <span class=\"o\">(</span><span class=\"n\">m</span> <span class=\"bp\">-</span> <span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"n\">def</span> <span class=\"n\">Icc_multi</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"n\">m</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">multiset</span> <span class=\"bp\">ℕ</span> <span class=\"o\">:=</span> <span class=\"n\">my_Icc</span> <span class=\"n\">n</span> <span class=\"n\">m</span>\n<span class=\"kn\">theorem</span> <span class=\"n\">nodup</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"n\">m</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">nodup</span> <span class=\"o\">(</span><span class=\"n\">my_Icc</span> <span class=\"n\">n</span> <span class=\"n\">m</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"n\">dsimp</span> <span class=\"o\">[</span><span class=\"n\">my_Icc</span><span class=\"o\">]</span><span class=\"bp\">;</span> <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">nodup_range&#39;</span><span class=\"o\">]</span>\n\n<span class=\"kn\">theorem</span> <span class=\"n\">my_nodup</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"n\">m</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">multiset</span><span class=\"bp\">.</span><span class=\"n\">nodup</span> <span class=\"o\">(</span><span class=\"n\">Icc_multi</span> <span class=\"n\">n</span> <span class=\"n\">m</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">nodup</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span>\n<span class=\"n\">def</span> <span class=\"n\">tIcc</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"n\">m</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">finset</span> <span class=\"bp\">ℕ</span> <span class=\"o\">:=</span> <span class=\"bp\">⟨_</span><span class=\"o\">,</span> <span class=\"n\">my_nodup</span> <span class=\"n\">n</span> <span class=\"n\">m</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span> <span class=\"n\">Icc_ℕ_fintype</span> <span class=\"o\">(</span><span class=\"n\">l</span> <span class=\"n\">u</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">fintype</span> <span class=\"o\">(</span><span class=\"n\">Icc</span> <span class=\"n\">l</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"n\">fintype</span><span class=\"bp\">.</span><span class=\"n\">of_finset</span> <span class=\"o\">(</span><span class=\"n\">tIcc</span> <span class=\"n\">l</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span>\n<span class=\"k\">begin</span> <span class=\"n\">split</span><span class=\"o\">,</span> <span class=\"n\">intro</span> <span class=\"n\">h</span><span class=\"o\">,</span><span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">],</span> <span class=\"n\">split</span><span class=\"o\">,</span> <span class=\"o\">{</span><span class=\"n\">simp</span> <span class=\"o\">[(</span><span class=\"err\">∈</span><span class=\"o\">)]</span> <span class=\"n\">at</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">sorry</span><span class=\"o\">},</span><span class=\"n\">sorry</span><span class=\"o\">,</span><span class=\"n\">sorry</span><span class=\"o\">,</span> <span class=\"kn\">end</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span> <span class=\"o\">:</span> <span class=\"n\">partial_order</span> <span class=\"bp\">ℕ</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">apply_instance</span>\n\n<span class=\"kn\">instance</span> <span class=\"o\">:</span> <span class=\"n\">locally_finite</span> <span class=\"bp\">ℕ</span> <span class=\"o\">:=</span>\n<span class=\"o\">{</span> <span class=\"n\">fin_Icc</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"n\">Icc_ℕ_fintype</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">,</span>\n  <span class=\"bp\">..</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">partial_order</span> <span class=\"o\">}</span>\n\n<span class=\"kn\">variables</span> <span class=\"o\">[</span><span class=\"n\">locally_finite</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"n\">def</span> <span class=\"n\">incidence_algebra</span> <span class=\"o\">:=</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">R</span>\n\n<span class=\"n\">def</span> <span class=\"n\">δ</span> <span class=\"o\">[</span><span class=\"n\">decidable_eq</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">incidence_algebra</span> <span class=\"n\">α</span> <span class=\"n\">R</span> <span class=\"o\">:=</span>\n<span class=\"bp\">λ</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"k\">if</span> <span class=\"n\">x</span> <span class=\"bp\">=</span> <span class=\"n\">y</span> <span class=\"k\">then</span> <span class=\"mi\">1</span> <span class=\"k\">else</span> <span class=\"mi\">0</span>\n\n<span class=\"bp\">#</span><span class=\"kn\">check</span> <span class=\"n\">δ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span>\n<span class=\"bp\">#</span><span class=\"kn\">eval</span> <span class=\"n\">δ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span> <span class=\"mi\">1</span> <span class=\"mi\">0</span>\n\n<span class=\"n\">def</span> <span class=\"n\">ζ</span> <span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">decidable_rel</span> <span class=\"n\">α</span> <span class=\"o\">(</span><span class=\"bp\">≤</span><span class=\"o\">)]</span> <span class=\"o\">:</span> <span class=\"n\">incidence_algebra</span> <span class=\"n\">α</span> <span class=\"n\">R</span> <span class=\"o\">:=</span>\n<span class=\"bp\">λ</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"k\">if</span> <span class=\"n\">x</span> <span class=\"bp\">≤</span> <span class=\"n\">y</span> <span class=\"k\">then</span> <span class=\"mi\">1</span> <span class=\"k\">else</span> <span class=\"mi\">0</span>\n\n<span class=\"bp\">#</span><span class=\"kn\">check</span> <span class=\"n\">ζ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span>\n<span class=\"bp\">#</span><span class=\"kn\">eval</span> <span class=\"n\">ζ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span> <span class=\"mi\">1</span> <span class=\"mi\">3</span>\n<span class=\"bp\">#</span><span class=\"kn\">eval</span> <span class=\"n\">ζ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span> <span class=\"mi\">1</span> <span class=\"mi\">0</span>\n\n<span class=\"kn\">instance</span> <span class=\"o\">[</span><span class=\"n\">decidable_eq</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">has_one</span> <span class=\"o\">(</span><span class=\"n\">incidence_algebra</span> <span class=\"n\">α</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">⟨</span><span class=\"n\">δ</span> <span class=\"n\">α</span> <span class=\"n\">R</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span> <span class=\"o\">:</span> <span class=\"n\">has_mul</span> <span class=\"o\">(</span><span class=\"n\">incidence_algebra</span> <span class=\"n\">α</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"bp\">⟨λ</span> <span class=\"n\">f</span> <span class=\"n\">g</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"o\">((</span><span class=\"n\">locally_finite</span><span class=\"bp\">.</span><span class=\"n\">fin_Icc</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">elems</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">z</span><span class=\"o\">,</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"n\">z</span> <span class=\"bp\">*</span> <span class=\"n\">g</span> <span class=\"n\">z</span> <span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">⟩</span>\n\n<span class=\"bp\">#</span><span class=\"kn\">check</span> <span class=\"o\">(</span><span class=\"n\">δ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span> <span class=\"bp\">*</span> <span class=\"n\">δ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"kn\">eval</span> <span class=\"o\">(</span><span class=\"n\">δ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span> <span class=\"bp\">*</span> <span class=\"n\">δ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span><span class=\"o\">)</span> <span class=\"mi\">1</span> <span class=\"mi\">1</span>\n<span class=\"bp\">#</span><span class=\"kn\">eval</span> <span class=\"o\">(</span><span class=\"n\">δ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span> <span class=\"bp\">*</span> <span class=\"n\">ζ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span><span class=\"o\">)</span> <span class=\"mi\">1</span> <span class=\"mi\">1</span>\n\n<span class=\"kn\">instance</span> <span class=\"o\">[</span><span class=\"n\">decidable_eq</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">monoid</span> <span class=\"o\">(</span><span class=\"n\">incidence_algebra</span> <span class=\"n\">α</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"o\">{</span> <span class=\"n\">mul</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"bp\">*</span><span class=\"o\">),</span>\n  <span class=\"n\">mul_assoc</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"n\">z</span><span class=\"o\">,</span> <span class=\"k\">begin</span> <span class=\"n\">sorry</span> <span class=\"kn\">end</span><span class=\"o\">,</span>\n  <span class=\"n\">one</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">),</span>\n  <span class=\"n\">one_mul</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">a</span><span class=\"o\">,</span> <span class=\"k\">begin</span> <span class=\"n\">ext</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"n\">simp</span> <span class=\"o\">[(</span><span class=\"bp\">*</span><span class=\"o\">),</span><span class=\"n\">has_one</span><span class=\"bp\">.</span><span class=\"n\">one</span><span class=\"o\">,</span><span class=\"n\">δ</span><span class=\"o\">],</span><span class=\"n\">sorry</span> <span class=\"kn\">end</span><span class=\"o\">,</span>\n  <span class=\"n\">mul_one</span> <span class=\"o\">:=</span> <span class=\"n\">sorry</span> <span class=\"o\">}</span>\n\n<span class=\"kn\">instance</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">fintype</span> <span class=\"o\">(</span><span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">locally_finite</span><span class=\"bp\">.</span><span class=\"n\">fin_Icc</span> <span class=\"n\">x</span> <span class=\"n\">y</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">card_Icc_lt_card_Icc_of_lt</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"n\">z</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hxz</span> <span class=\"o\">:</span> <span class=\"n\">x</span> <span class=\"bp\">≤</span> <span class=\"n\">z</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hzy</span> <span class=\"o\">:</span> <span class=\"n\">z</span> <span class=\"bp\">&lt;</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span> <span class=\"o\">(</span><span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">z</span><span class=\"o\">)</span> <span class=\"bp\">&lt;</span> <span class=\"n\">fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span> <span class=\"o\">(</span><span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n   <span class=\"k\">have</span> <span class=\"n\">hxy</span> <span class=\"o\">:</span> <span class=\"n\">x</span> <span class=\"bp\">≤</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"n\">le_of_lt</span> <span class=\"o\">(</span><span class=\"n\">lt_of_le_of_lt</span> <span class=\"n\">hxz</span> <span class=\"n\">hzy</span><span class=\"o\">),</span>\n   <span class=\"k\">have</span> <span class=\"n\">y_not_mem</span> <span class=\"o\">:</span> <span class=\"n\">y</span> <span class=\"err\">∉</span> <span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">z</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"k\">begin</span>\n      <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">hxy</span><span class=\"o\">,</span> <span class=\"n\">true_and</span><span class=\"o\">,</span> <span class=\"n\">mem_Icc</span><span class=\"o\">]</span> <span class=\"n\">at</span> <span class=\"n\">h</span><span class=\"o\">,</span>\n      <span class=\"n\">exact</span> <span class=\"n\">lt_irrefl</span> <span class=\"bp\">_</span> <span class=\"o\">(</span><span class=\"n\">lt_of_le_of_lt</span> <span class=\"n\">h</span> <span class=\"n\">hzy</span><span class=\"o\">),</span>\n   <span class=\"kn\">end</span><span class=\"o\">,</span>\n   <span class=\"k\">have</span> <span class=\"n\">y_mem</span> <span class=\"o\">:</span> <span class=\"n\">y</span> <span class=\"err\">∈</span> <span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">hxy</span><span class=\"o\">],</span>\n   <span class=\"k\">have</span> <span class=\"o\">:</span> <span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">z</span> <span class=\"err\">⊆</span> <span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"n\">Icc_subset_Icc_right</span> <span class=\"o\">(</span><span class=\"n\">le_of_lt</span> <span class=\"n\">hzy</span><span class=\"o\">),</span>\n   <span class=\"n\">exact</span> <span class=\"n\">card_lt_card</span> <span class=\"bp\">⟨</span><span class=\"n\">this</span><span class=\"o\">,</span> <span class=\"bp\">λ</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"k\">by</span> <span class=\"n\">cc</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"kn\">end</span>\n\n<span class=\"n\">def</span> <span class=\"n\">μaux</span> <span class=\"o\">[</span><span class=\"n\">decidable_eq</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">R</span>\n<span class=\"bp\">|</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"k\">if</span> <span class=\"n\">x</span> <span class=\"bp\">=</span> <span class=\"n\">y</span> <span class=\"k\">then</span> <span class=\"mi\">1</span> <span class=\"k\">else</span> <span class=\"k\">begin</span>\n   <span class=\"n\">haveI</span> <span class=\"o\">:</span> <span class=\"n\">fintype</span> <span class=\"o\">(</span><span class=\"n\">Ico</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">sorry</span><span class=\"o\">,</span>\n   <span class=\"n\">exact</span> <span class=\"bp\">-</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"o\">(</span><span class=\"n\">fintype</span><span class=\"bp\">.</span><span class=\"n\">elems</span> <span class=\"o\">(</span><span class=\"n\">Ico</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">z</span><span class=\"o\">,</span>\n      <span class=\"k\">have</span> <span class=\"n\">fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span> <span class=\"err\">↥</span><span class=\"o\">(</span><span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">z</span><span class=\"o\">)</span> <span class=\"bp\">&lt;</span> <span class=\"n\">fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span> <span class=\"err\">↥</span><span class=\"o\">(</span><span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n         <span class=\"n\">card_Icc_lt_card_Icc_of_lt</span> <span class=\"n\">α</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"n\">z</span><span class=\"bp\">.</span><span class=\"mi\">1</span> <span class=\"n\">z</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">1</span> <span class=\"n\">z</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"o\">,</span>\n      <span class=\"n\">μaux</span> <span class=\"n\">z</span><span class=\"o\">),</span>\n<span class=\"kn\">end</span>\n<span class=\"n\">using_well_founded</span> <span class=\"o\">{</span><span class=\"n\">rel_tac</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">,</span> <span class=\"bp\">`</span><span class=\"o\">[</span><span class=\"n\">exact</span> <span class=\"bp\">⟨_</span><span class=\"o\">,</span> <span class=\"n\">measure_wf</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">y</span><span class=\"o\">,</span>\n   <span class=\"n\">fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span> <span class=\"o\">(</span><span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"o\">)</span><span class=\"bp\">⟩</span><span class=\"o\">]}</span>\n\n<span class=\"n\">def</span> <span class=\"n\">μ</span> <span class=\"o\">[</span><span class=\"n\">decidable_eq</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">incidence_algebra</span> <span class=\"n\">α</span> <span class=\"n\">R</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">μaux</span> <span class=\"n\">α</span> <span class=\"n\">R</span> <span class=\"n\">x</span>\n\n<span class=\"kn\">set_option</span> <span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">all</span> <span class=\"n\">false</span>\n\n<span class=\"kn\">example</span> <span class=\"o\">:</span> <span class=\"n\">μ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span> <span class=\"bp\">=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"k\">if</span> <span class=\"n\">x</span> <span class=\"bp\">=</span> <span class=\"n\">y</span> <span class=\"k\">then</span> <span class=\"mi\">1</span> <span class=\"k\">else</span> <span class=\"o\">(</span><span class=\"k\">if</span> <span class=\"n\">y</span> <span class=\"bp\">=</span> <span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span> <span class=\"k\">then</span> <span class=\"bp\">-</span><span class=\"mi\">1</span> <span class=\"k\">else</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n   <span class=\"n\">ext</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">,</span>\n   <span class=\"n\">split_ifs</span><span class=\"o\">,</span>\n   <span class=\"o\">{</span><span class=\"n\">dsimp</span> <span class=\"o\">[</span><span class=\"n\">μ</span><span class=\"o\">],</span> <span class=\"n\">rwa</span> <span class=\"o\">[</span><span class=\"n\">μaux</span><span class=\"o\">,</span> <span class=\"n\">if_pos</span><span class=\"o\">],</span> <span class=\"o\">},</span>\n   <span class=\"o\">{</span><span class=\"n\">dsimp</span> <span class=\"o\">[</span><span class=\"n\">μ</span><span class=\"o\">],</span> <span class=\"n\">rwa</span> <span class=\"o\">[</span><span class=\"n\">μaux</span><span class=\"o\">],</span> <span class=\"n\">rwa</span> <span class=\"o\">[</span><span class=\"n\">if_neg</span><span class=\"o\">,</span> <span class=\"n\">h_1</span><span class=\"o\">],</span> <span class=\"n\">simp</span><span class=\"o\">,</span>\n   <span class=\"k\">have</span> <span class=\"o\">:</span> <span class=\"n\">Ico</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">}</span> <span class=\"o\">:=</span> <span class=\"n\">sorry</span><span class=\"o\">,</span>\n   <span class=\"n\">conv_lhs</span>\n   <span class=\"o\">{</span>\n      <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">this</span><span class=\"o\">],</span>\n      <span class=\"n\">congr</span><span class=\"o\">,</span>\n      <span class=\"n\">skip</span><span class=\"o\">,</span>\n      <span class=\"n\">funext</span><span class=\"o\">,</span>\n      <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">μaux</span><span class=\"o\">],</span>\n      <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">if_pos</span> <span class=\"o\">(</span><span class=\"n\">sorry</span>  <span class=\"o\">:</span> <span class=\"n\">x</span> <span class=\"bp\">=</span> <span class=\"err\">↑</span> <span class=\"n\">z</span><span class=\"o\">)],</span>\n   <span class=\"o\">},</span> <span class=\"n\">simp</span><span class=\"o\">,</span> <span class=\"k\">have</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">locally_finite</span><span class=\"bp\">.</span><span class=\"n\">fin_Icc</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">complete</span><span class=\"o\">,</span> <span class=\"n\">simp</span> <span class=\"n\">at</span> <span class=\"n\">this</span><span class=\"o\">,</span>\n   <span class=\"n\">norm_cast</span><span class=\"o\">,</span>\n   <span class=\"n\">rw</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">card_eq_one</span><span class=\"o\">,</span>\n   <span class=\"n\">use</span> <span class=\"n\">x</span><span class=\"o\">,</span>\n   <span class=\"n\">simp</span><span class=\"o\">,</span>\n   <span class=\"n\">dsimp</span><span class=\"o\">,</span>\n   <span class=\"n\">dunfold</span> <span class=\"n\">coe_sort</span><span class=\"o\">,</span>\n   <span class=\"n\">dunfold</span> <span class=\"n\">has_coe_to_sort</span><span class=\"bp\">.</span><span class=\"n\">coe</span><span class=\"o\">,</span><span class=\"n\">dsimp</span><span class=\"o\">,</span>\n   <span class=\"n\">simp</span><span class=\"o\">,</span>\n   <span class=\"n\">ext</span><span class=\"o\">,</span>\n   <span class=\"n\">simp</span> <span class=\"n\">at</span> <span class=\"n\">a</span><span class=\"o\">,</span>\n   <span class=\"n\">split</span><span class=\"o\">,</span>\n   <span class=\"n\">intro</span> <span class=\"n\">h</span><span class=\"o\">,</span>\n\n   <span class=\"k\">have</span> <span class=\"o\">:=</span> <span class=\"n\">this</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"k\">by</span> <span class=\"n\">simp</span><span class=\"o\">),</span>\n   <span class=\"n\">erw</span> <span class=\"o\">[(</span><span class=\"n\">sorry</span> <span class=\"o\">:</span> <span class=\"n\">Icc</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">})]</span> <span class=\"n\">at</span> <span class=\"n\">this</span><span class=\"o\">,</span>  <span class=\"o\">},</span>\n<span class=\"kn\">end</span>\n<span class=\"bp\">#</span><span class=\"kn\">eval</span> <span class=\"n\">μ</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">ℤ</span> <span class=\"mi\">1</span> <span class=\"mi\">1</span>\n<span class=\"bp\">#</span><span class=\"kn\">check</span> <span class=\"n\">set</span><span class=\"bp\">.</span><span class=\"n\">has_coe_to_sort</span>\n<span class=\"kn\">lemma</span> <span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"o\">:</span>  <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"o\">(</span><span class=\"n\">fintype</span><span class=\"bp\">.</span><span class=\"n\">elems</span> <span class=\"o\">{</span><span class=\"n\">x_1</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">//</span> <span class=\"n\">p</span> <span class=\"n\">x</span><span class=\"o\">})</span> <span class=\"n\">f</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">μ_inv_ζ_eq_one</span> <span class=\"o\">[</span><span class=\"n\">decidable_eq</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">decidable_rel</span> <span class=\"n\">α</span> <span class=\"o\">(</span><span class=\"bp\">≤</span><span class=\"o\">)]</span> <span class=\"o\">:</span> <span class=\"n\">μ</span> <span class=\"n\">α</span> <span class=\"n\">R</span> <span class=\"bp\">*</span> <span class=\"n\">ζ</span> <span class=\"n\">α</span> <span class=\"n\">R</span> <span class=\"bp\">=</span> <span class=\"mi\">1</span> <span class=\"o\">:=</span> <span class=\"k\">begin</span>\n<span class=\"n\">ext</span> <span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">,</span>\n<span class=\"n\">dsimp</span><span class=\"o\">,</span>\n<span class=\"n\">simp</span> <span class=\"o\">[(</span><span class=\"bp\">*</span><span class=\"o\">)],</span>\n<span class=\"n\">unfold_coes</span><span class=\"o\">,</span>\n   <span class=\"n\">dunfold</span> <span class=\"n\">coe_sort</span><span class=\"o\">,</span>\n   <span class=\"n\">dunfold</span> <span class=\"n\">has_coe_to_sort</span><span class=\"bp\">.</span><span class=\"n\">coe</span><span class=\"o\">,</span><span class=\"n\">dsimp</span><span class=\"o\">,</span>\n   <span class=\"n\">simp</span><span class=\"o\">,</span>\n<span class=\"kn\">end</span>\n\n\n<span class=\"bp\">#</span><span class=\"n\">lint</span>\n</code></pre></div>",
        "id": 201463174,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1592630778
    },
    {
        "content": "<p>Looks like <code>list.Icc</code> still isn't in mathlib, maybe we should add this as a (help wanted / easy) issue on github rather than just a comment in <a href=\"https://github.com/leanprover-community/mathlib/blob/fbc9592788fe71b15bdefc972a98f40b79d29bab/src/data/list/intervals.lean#L19\">https://github.com/leanprover-community/mathlib/blob/fbc9592788fe71b15bdefc972a98f40b79d29bab/src/data/list/intervals.lean#L19</a> so people can find it?</p>",
        "id": 201463314,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1592631062
    },
    {
        "content": "<p>Isn't <code>pnat</code> a canonically ordered comm monoid with a lattice structure? Won't this be enough for most things?</p>",
        "id": 201468595,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1592642220
    },
    {
        "content": "<p>Note that nat isn't because of zero. But nat might well be a monoid with 0 with good factorisation properties. I was talking to <span class=\"user-mention\" data-user-id=\"110044\">@Chris Hughes</span> about this the other day. The ideals in a commutative ring are a monoid and the ideals in a Dedekind domain are a monoid with a zero and, other than that, good factorisation properties. This all very much reminds me of <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> 's group with 0 insight. There's some natural structure here that we're missing and we would like, but mathematicians didn't spot it yet. Is it an incidence algebra? I don't know what they are</p>",
        "id": 201468720,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1592642421
    },
    {
        "content": "<p><a href=\"https://en.wikipedia.org/wiki/Incidence_algebra\">Incidence algebras</a> are what you define to generalize the Mobius inversion formula to settings like finite subsets where it becomes inclusion-exclusion.</p>",
        "id": 201468848,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1592642750
    },
    {
        "content": "<p>Isn't <code>nat</code> a \"canonically ordered comm monoid with lattice structure\", where 0 is the maximal element? I think the problem with <code>nat</code> is that Dirichlet convolutions make no sense at 0, since <code>a * b = 0</code> has infinitely many solutions</p>",
        "id": 201468954,
        "sender_full_name": "David Wärn",
        "timestamp": 1592642924
    },
    {
        "content": "<p>If the axioms work out for nat too then the situation is even better than I expected</p>",
        "id": 201469527,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1592644107
    },
    {
        "content": "<p>The concept of a UFD generalises to monoids, was Chris' observation. And then there's this dichotomy depending on whether there's a 0 or not. At the end of the day the answer to the original question is that pnat as a monoid has the property that it is free, so you get all the juicy consequences of the universal property including a lattice structure with arbitrary nonzero infs. Does pnat have a lattice instance? Probably not because if there's an order it will be the usual one, not divisibility</p>",
        "id": 201469657,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1592644383
    },
    {
        "content": "<p>I think there are at least three things happening with <code>pnat</code> that we can try to generalize:</p>\n<ul>\n<li>\n<p><strong>Dirichlet convolutions of arithmetic functions.</strong> Incidence algebras sort of make sense of this, but an element of the incidence algebra contains superfluous information. Another concept is this: given a ring R and a category C, such that every arrow in C has only finitely many factorisations into two arrows, we can form the \"<a href=\"https://en.wikipedia.org/wiki/Category_algebra#Incidence_algebra-style_definition\">category algebra</a>\", which assigns a scalar in R to every arrow, and where convolution makes sense because of the finiteness condition. Given a monoid like <code>pnat</code> (but unlike <code>nat</code> under multiplication!) we can thus form the category algebra on the single object category, and get the usual notion of arithmetic function &amp; Dirichlet convolution. We also get incidence algebras, since posets are categories. We get a \"Zeta function\" by assigning 1 to every arrow, and a \"delta function\" (identity for convolution) by assigning 1 to identity arrows and 0 to everything else.</p>\n</li>\n<li>\n<p><strong>Multiplicative functions.</strong> Over \"sufficiently nice\" monoids (in particular free monoids like <code>pnat</code>), we can talk about multiplicative functions. I think for perfect numbers the relevant facts are \"Zeta function is multiplicative\", \"the coercion <code>pnat -&gt; int</code> is multiplicative\", and \"convolution of multiplicative functions is multiplicative\".</p>\n</li>\n<li>\n<p><strong>Möbius inversion.</strong>Sometimes we can find a Möbius function, inverse to the Zeta function. In particular it always exists in an incidence algebra.</p>\n</li>\n</ul>",
        "id": 201471936,
        "sender_full_name": "David Wärn",
        "timestamp": 1592648905
    },
    {
        "content": "<p>It sounds like this incidence stuff is useful for the theory of so-called \"multiplicative functions\" (f(ab)=f(a)f(b) if gcd(a,b)=1), which do I think work on nat (f(0) can be anything). I wonder to what extent mobius inversion is useful though? I don't think you need it for perfect numbers</p>",
        "id": 201472518,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1592649958
    },
    {
        "content": "<p>Note that the standard usage of the phrase in number theory books has this gcd condition -- a monoid hom is called a strictly multiplicative function in the number theory literature. Coefficients of certain modular forms are multiplicative but not monoid homs, somehow the weaker notion was isolated as being useful</p>",
        "id": 201472628,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1592650165
    },
    {
        "content": "<p>Yes, multiplicative function is a good concept, but I'm not sure how it generalizes. Presumably there's a connection to be made with measures, which are only additive when your sets are disjoint</p>",
        "id": 201472926,
        "sender_full_name": "David Wärn",
        "timestamp": 1592650715
    },
    {
        "content": "<p>Meanwhile, the concept of category algebra generalizes matrix algebras (which I unsuccessfully tried to make sense of a while ago) as well, via indiscrete categories. What a concept!</p>",
        "id": 201473033,
        "sender_full_name": "David Wärn",
        "timestamp": 1592650890
    },
    {
        "content": "<p>I also don't think you need Möbius inversion for Perfect numbers -- but of course it's often useful for counting things. As far as I can see the main (only?) advantage of incidence algebras over category algebras is that you always have a Möbius function (the upshot of the category algebra is that you get the usual notion of arithmetic function).</p>",
        "id": 201473930,
        "sender_full_name": "David Wärn",
        "timestamp": 1592652583
    },
    {
        "content": "<p>All you need right now for perfect numbers to work for pnats are some duplicate lemmas about gcd and stuff, which I’ve written, and an alteration of the fin_mult and coprime_part ideas to work with pnat.factors rather than multiplicity, which needs a semiring</p>",
        "id": 201485012,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592670330
    },
    {
        "content": "<p>But I’m just thinking about how to avoid writing so many duplicate lemmas if I (or someone else) keeps writing related elementary number theory</p>",
        "id": 201485066,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592670401
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/116395-maths/topic/Perfect.20Numbers/near/201468595\">said</a>:</p>\n<blockquote>\n<p>Isn't <code>pnat</code> a canonically ordered comm monoid with a lattice structure? Won't this be enough for most things?</p>\n</blockquote>\n<p>This is likely what I'm looking for. There's no definition yet of a multiplicative canonically_ordered_comm_monoid, and maybe that's what I'm looking for... one problem I wouldn't know how to deal with is how to recognize <code>dvd</code> as a partial order, without interfering with the linear order <code>le</code> from the additive structure. Then also I'm not sure syntactically it'd be easy to prove things about the gcd function without just repeatedly rewriting gcd_eq_sup_dvd or something</p>",
        "id": 201489728,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592676575
    },
    {
        "content": "<p>AFAIR there is some theory about \"dvd as a partial order\" in <code>algebra/associated</code>.</p>",
        "id": 201490367,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1592677347
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/stream/116395-maths/topic/Perfect.20Numbers/near/201490367\">said</a>:</p>\n<blockquote>\n<p>AFAIR there is some theory about \"dvd as a partial order\" in <code>algebra/associated</code>.</p>\n</blockquote>\n<p>That does seem useful. I'd want to prove things about the special case where <code>associates</code> is a partial order, in bijection with the original monoid, because there's only one unit.</p>",
        "id": 201494315,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592682845
    },
    {
        "content": "<p>I've retrofitted most of my file to deal with pnats, and created a new file, multiplicity_vectors.lean, that introduces yet another kind of prime factorisation (as a finsupp), but contains a lot of sorries</p>",
        "id": 201556112,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592779294
    },
    {
        "content": "<p>This new factorisation would be pretty useful for talking about multiplicative functions, and maybe other things, I'm interested to see if anyone else is interested in it. Probably the next thing to do with that would be to show that it's order isomorphic and add_monoid isomorphic to factor_multiset, and then a bunch of the sorried properties will probably be reduced to lemmas saying that lattices respect order isomorphisms, which either should exist or do already</p>",
        "id": 201556234,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592779481
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"302826\">@Aaron Anderson</span> Note that there is already an isomorphism between <code>multiset X</code> and <code>finsupp X nat</code>. You could use that to transport the definition and a bunch of lemmas...<br>\nAlternatively, we might decide that the <code>finsupp</code> approach is the more flexible point of view, and just ditch the <code>multiset</code> approach completely.</p>",
        "id": 201568317,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592802217
    },
    {
        "content": "<p>I’ve used .to_multiset to define it, and I know that’s invertible and a strict_mono. Is that the isomorphism you’re referring to?</p>",
        "id": 201568482,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1592802470
    },
    {
        "content": "<p>Yup, exactly</p>",
        "id": 201568536,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592802520
    },
    {
        "content": "<p>The inverse is <code>.to_finsupp</code></p>",
        "id": 201568539,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1592802528
    },
    {
        "content": "<p>I made a new commit, and started a PR review thread for 3094.</p>",
        "id": 202529537,
        "sender_full_name": "Aaron Anderson",
        "timestamp": 1593577260
    }
]