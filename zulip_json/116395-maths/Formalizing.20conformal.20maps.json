[
    {
        "content": "<p>Hello, I have written some codes for conformal maps between inner product spaces, which was previously discussed <a href=\"#narrow/stream/116395-maths/topic/Conformal.20maps\">here</a>. My code is available <a href=\"https://github.com/justadzr/Lean_2021/blob/complex-diff/src/conformal.lean\">here</a>, which is still a rough draft. The proofs and style were modified once, according to some very valuable comments from <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span>  provided by Prof. Buzzard.  I am extremely grateful for any suggestion. Some of the relatively trivial lemmas might be redundant but I was unable to find the appropriate alternatives in mathlib. <a href=\"https://github.com/justadzr/Lean_2021/blob/complex-diff/src/conformal'.lean\">Here</a> is a file with shorter proofs but less compact statements.</p>\n<p>Also, do we need partial derivatives to formalize Liouville's theorem on C^4 conformal mappings between Euclidean spaces?</p>\n<p>Thanks in advance.</p>",
        "id": 246428735,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626683481
    },
    {
        "content": "<p>I have only glanced at this but it looks really great! If you are wondering what to do next, I suggest you carve off a small piece and turn it into a PR.</p>",
        "id": 246432120,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1626685812
    },
    {
        "content": "<p>I played with some of the first 150 lines. Your code is really good! In the comments below I show you some more tips.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">tactic</span>\n<span class=\"kn\">import</span> <span class=\"n\">data.matrix.notation</span>\n<span class=\"kn\">import</span> <span class=\"n\">analysis.complex.basic</span>\n<span class=\"kn\">import</span> <span class=\"n\">geometry.manifold.charted_space</span>\n<span class=\"kn\">import</span> <span class=\"n\">analysis.normed_space.inner_product</span>\n<span class=\"kn\">import</span> <span class=\"n\">linear_algebra.matrix.to_linear_equiv</span>\n<span class=\"kn\">import</span> <span class=\"n\">geometry.euclidean.basic</span>\n<span class=\"kn\">import</span> <span class=\"n\">analysis.complex.isometry</span>\n<span class=\"kn\">import</span> <span class=\"n\">analysis.normed_space.finite_dimension</span>\n\n<span class=\"kd\">noncomputable theory</span>\n\n<span class=\"c1\">-- I personally like to have section names which are \"obviously not namespaces\"</span>\n<span class=\"c1\">-- so that when I see `end conformal_API` I will know it's not the end of a namespace</span>\n\n<span class=\"kn\">section</span> <span class=\"n\">conformal_API</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">is_conformal_map</span> <span class=\"o\">{</span><span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n<span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"bp\">∃</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hc</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">lie</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">≃ₗᵢ</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">),</span> <span class=\"bp\">⇑</span><span class=\"n\">f'</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"n\">c</span> <span class=\"bp\">•</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"bp\">∘</span> <span class=\"n\">lie</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">conformal_at</span>\n<span class=\"o\">{</span><span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"bp\">∃</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">),</span> <span class=\"n\">has_fderiv_at</span> <span class=\"n\">f</span> <span class=\"n\">f'</span> <span class=\"n\">x</span> <span class=\"bp\">∧</span> <span class=\"n\">is_conformal_map</span> <span class=\"n\">f'</span>\n\n<span class=\"c1\">-- let's make an API for `conformal_at` before we start on `conformal`.</span>\n<span class=\"c1\">-- Let's do it in a namespace and set up variables for that namespace.</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">conformal_at</span>\n\n<span class=\"kd\">variables</span> <span class=\"o\">{</span><span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"n\">Z</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n  <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Z</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- save some time by opening these</span>\n<span class=\"kn\">open</span> <span class=\"n\">linear_isometry_equiv</span> <span class=\"n\">continuous_linear_map</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">differentiable_at</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"n\">differentiable_at</span> <span class=\"n\">ℝ</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"k\">let</span> <span class=\"o\">⟨</span><span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"n\">h₁</span><span class=\"o\">,</span> <span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"n\">_</span><span class=\"o\">⟩</span> <span class=\"o\">:=</span> <span class=\"n\">h</span> <span class=\"k\">in</span> <span class=\"n\">h₁.differentiable_at</span>\n\n<span class=\"c1\">-- I can use `refl` now instead of `linear_isometry_equiv.refl`</span>\n<span class=\"kd\">theorem</span> <span class=\"n\">id</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">conformal_at</span> <span class=\"n\">id</span> <span class=\"n\">x</span> <span class=\"o\">:=</span>\n<span class=\"o\">⟨</span><span class=\"n\">id</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">,</span> <span class=\"n\">has_fderiv_at_id</span> <span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"n\">one_ne_zero</span><span class=\"o\">,</span> <span class=\"n\">refl</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">,</span> <span class=\"kd\">by</span> <span class=\"n\">ext</span><span class=\"bp\">;</span> <span class=\"n\">simp</span><span class=\"o\">⟩</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">const_smul</span> <span class=\"o\">{</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">conformal_at</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x'</span><span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">),</span> <span class=\"n\">c</span> <span class=\"bp\">•</span> <span class=\"n\">x'</span><span class=\"o\">)</span> <span class=\"n\">x</span> <span class=\"o\">:=</span>\n<span class=\"c1\">-- no `by apply` needed</span>\n<span class=\"o\">⟨</span><span class=\"n\">c</span> <span class=\"bp\">•</span> <span class=\"n\">continuous_linear_map.id</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">,</span> <span class=\"n\">has_fderiv_at.const_smul</span> <span class=\"o\">(</span><span class=\"n\">has_fderiv_at_id</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"n\">c</span><span class=\"o\">,</span> <span class=\"n\">c</span><span class=\"o\">,</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">refl</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">,</span> <span class=\"kd\">by</span> <span class=\"n\">ext</span><span class=\"bp\">;</span> <span class=\"n\">simp</span><span class=\"o\">⟩</span>\n\n<span class=\"c1\">-- putting conformal_at f x before the colon means you can `rintro` everything</span>\n<span class=\"kd\">theorem</span> <span class=\"n\">comp</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">Y</span> <span class=\"bp\">→</span> <span class=\"n\">Z</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">}</span> <span class=\"o\">:</span>\n  <span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"bp\">→</span> <span class=\"n\">conformal_at</span> <span class=\"n\">g</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">conformal_at</span> <span class=\"o\">(</span><span class=\"n\">g</span> <span class=\"bp\">∘</span> <span class=\"n\">f</span><span class=\"o\">)</span> <span class=\"n\">x</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">rintro</span> <span class=\"o\">⟨</span><span class=\"n\">f'</span><span class=\"o\">,</span> <span class=\"n\">hf₁</span><span class=\"o\">,</span> <span class=\"n\">cf</span><span class=\"o\">,</span> <span class=\"n\">hcf</span><span class=\"o\">,</span> <span class=\"n\">lief</span><span class=\"o\">,</span> <span class=\"n\">hf₂</span><span class=\"o\">⟩</span> <span class=\"o\">⟨</span><span class=\"n\">g'</span><span class=\"o\">,</span> <span class=\"n\">hg₁</span><span class=\"o\">,</span> <span class=\"n\">cg</span><span class=\"o\">,</span> <span class=\"n\">hcg</span><span class=\"o\">,</span> <span class=\"n\">lieg</span><span class=\"o\">,</span> <span class=\"n\">hg₂</span><span class=\"o\">⟩,</span>\n  <span class=\"c1\">-- ⟨ ⟩ can be used for `exists` too, no need for `use`</span>\n  <span class=\"n\">exact</span> <span class=\"o\">⟨</span><span class=\"n\">g'.comp</span> <span class=\"n\">f'</span><span class=\"o\">,</span> <span class=\"n\">has_fderiv_at.comp</span> <span class=\"n\">x</span> <span class=\"n\">hg₁</span> <span class=\"n\">hf₁</span><span class=\"o\">,</span> <span class=\"n\">cg</span> <span class=\"bp\">*</span> <span class=\"n\">cf</span><span class=\"o\">,</span> <span class=\"n\">mul_ne_zero</span> <span class=\"n\">hcg</span> <span class=\"n\">hcf</span><span class=\"o\">,</span> <span class=\"n\">lief.trans</span> <span class=\"n\">lieg</span><span class=\"o\">,</span>\n  <span class=\"c1\">-- let `simp` do all the work. You don't need `simp only` if you can close the goal.</span>\n    <span class=\"kd\">by</span> <span class=\"o\">{</span><span class=\"n\">ext</span><span class=\"o\">,</span> <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">coe_comp'</span> <span class=\"n\">f'</span> <span class=\"n\">g'</span><span class=\"o\">,</span> <span class=\"n\">hf₂</span><span class=\"o\">,</span> <span class=\"n\">hg₂</span><span class=\"o\">,</span> <span class=\"n\">smul_smul</span> <span class=\"n\">cg</span> <span class=\"n\">cf</span><span class=\"o\">]</span> <span class=\"o\">}⟩,</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">_root_.conformal_at_iff</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">f'</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">≃</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">}</span>\n<span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">has_fderiv_at</span> <span class=\"n\">f</span> <span class=\"n\">f'.to_continuous_linear_map</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"bp\">↔</span> <span class=\"bp\">∃</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hc</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">&gt;</span> <span class=\"mi\">0</span><span class=\"o\">),</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">),</span> <span class=\"n\">inner</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span><span class=\"o\">)</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">split</span><span class=\"o\">,</span>\n  <span class=\"o\">{</span> <span class=\"c1\">-- intros + rcases = rintros</span>\n    <span class=\"n\">rintros</span> <span class=\"o\">⟨</span><span class=\"n\">f₁</span><span class=\"o\">,</span> <span class=\"n\">h₁</span><span class=\"o\">,</span> <span class=\"n\">c₁</span><span class=\"o\">,</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span> <span class=\"n\">lie</span><span class=\"o\">,</span> <span class=\"n\">h₂</span><span class=\"o\">⟩,</span>\n    <span class=\"c1\">-- `use` and `intros` can be put together with `refine`. Note: also use `c₁ * c₁` not `c₁^2`, then you don't need `pow_two` later.</span>\n    <span class=\"n\">refine</span> <span class=\"o\">⟨</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span><span class=\"o\">,</span> <span class=\"n\">mul_self_pos</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span> <span class=\"bp\">λ</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">,</span> <span class=\"n\">_</span><span class=\"o\">⟩,</span>\n    <span class=\"c1\">-- dot notation `f'.coe_coe` is much more brief than `continuous_linear_equiv.coe_coe f'`</span>\n    <span class=\"c1\">-- Also -- make `simp` do the work. You don't need to rewrite and then simp; simp does rewrites for you.</span>\n    <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">f'.coe_coe</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">f'.coe_def_rev</span><span class=\"o\">,</span> <span class=\"n\">has_fderiv_at.unique</span> <span class=\"n\">h</span> <span class=\"n\">h₁</span><span class=\"o\">,</span> <span class=\"n\">h₂</span><span class=\"o\">,</span> <span class=\"n\">inner_map_map</span><span class=\"o\">,</span> <span class=\"n\">real_inner_smul_left</span><span class=\"o\">,</span>\n      <span class=\"n\">real_inner_smul_right</span><span class=\"o\">,</span> <span class=\"n\">mul_assoc</span><span class=\"o\">]</span> <span class=\"o\">},</span>\n  <span class=\"o\">{</span><span class=\"n\">rintro</span> <span class=\"o\">⟨</span><span class=\"n\">c₁</span><span class=\"o\">,</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span> <span class=\"n\">huv</span><span class=\"o\">⟩,</span>\n    <span class=\"k\">let</span> <span class=\"n\">c</span> <span class=\"o\">:=</span> <span class=\"n\">real.sqrt</span> <span class=\"n\">c₁</span><span class=\"bp\">⁻¹</span><span class=\"o\">,</span>\n    <span class=\"k\">have</span> <span class=\"n\">hc</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">w</span><span class=\"o\">,</span> <span class=\"kd\">by</span> <span class=\"o\">{</span><span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">c</span><span class=\"o\">]</span> <span class=\"n\">at</span> <span class=\"n\">w</span><span class=\"bp\">;</span>\n      <span class=\"n\">exact</span> <span class=\"o\">(</span><span class=\"n\">real.sqrt_ne_zero'.mpr</span> <span class=\"bp\">$</span> <span class=\"n\">inv_pos.mpr</span> <span class=\"n\">hc₁</span><span class=\"o\">)</span> <span class=\"n\">w</span><span class=\"o\">},</span>\n    <span class=\"k\">let</span> <span class=\"n\">c_map</span> <span class=\"o\">:=</span> <span class=\"n\">linear_equiv.smul_of_ne_zero</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span> <span class=\"n\">c</span> <span class=\"n\">hc</span><span class=\"o\">,</span>\n    <span class=\"k\">let</span> <span class=\"n\">f₁</span> <span class=\"o\">:=</span> <span class=\"n\">f'.to_linear_equiv.trans</span> <span class=\"n\">c_map</span><span class=\"o\">,</span>\n    <span class=\"k\">have</span> <span class=\"n\">minor</span> <span class=\"o\">:</span> <span class=\"bp\">⇑</span><span class=\"n\">f₁</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">Y</span><span class=\"o\">),</span> <span class=\"n\">c</span> <span class=\"bp\">•</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"bp\">∘</span> <span class=\"n\">f'</span> <span class=\"o\">:=</span> <span class=\"n\">rfl</span><span class=\"o\">,</span>\n    <span class=\"k\">have</span> <span class=\"n\">minor'</span> <span class=\"o\">:</span> <span class=\"bp\">⇑</span><span class=\"n\">f'</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">Y</span><span class=\"o\">),</span> <span class=\"n\">c</span><span class=\"bp\">⁻¹</span> <span class=\"bp\">•</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"bp\">∘</span> <span class=\"n\">f₁</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">ext</span><span class=\"bp\">;</span>\n      <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">minor</span><span class=\"o\">,</span> <span class=\"n\">function.comp_apply</span><span class=\"o\">,</span> <span class=\"n\">function.comp_apply</span><span class=\"o\">,</span>\n          <span class=\"n\">smul_smul</span><span class=\"o\">,</span> <span class=\"n\">inv_mul_cancel</span> <span class=\"n\">hc</span><span class=\"o\">,</span> <span class=\"n\">one_smul</span><span class=\"o\">],</span>\n    <span class=\"k\">have</span> <span class=\"n\">key</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">),</span> <span class=\"n\">inner</span> <span class=\"o\">(</span><span class=\"n\">f₁</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f₁</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">,</span> <span class=\"kd\">by</span>\n      <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">minor</span><span class=\"o\">,</span> <span class=\"n\">function.comp_app</span><span class=\"o\">,</span> <span class=\"n\">function.comp_app</span><span class=\"o\">,</span> <span class=\"n\">real_inner_smul_left</span><span class=\"o\">,</span>\n          <span class=\"n\">real_inner_smul_right</span><span class=\"o\">,</span> <span class=\"n\">huv</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">mul_assoc</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">mul_assoc</span><span class=\"o\">,</span>\n          <span class=\"n\">real.mul_self_sqrt</span> <span class=\"bp\">$</span> <span class=\"n\">le_of_lt</span> <span class=\"bp\">$</span> <span class=\"n\">inv_pos.mpr</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span>\n          <span class=\"n\">inv_mul_cancel</span> <span class=\"bp\">$</span> <span class=\"n\">ne_of_gt</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span> <span class=\"n\">one_mul</span><span class=\"o\">],</span>\n    <span class=\"n\">exact</span> <span class=\"o\">⟨</span><span class=\"n\">f'.to_continuous_linear_map</span><span class=\"o\">,</span> <span class=\"o\">⟨</span><span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">c</span><span class=\"bp\">⁻¹</span><span class=\"o\">,</span> <span class=\"n\">inv_ne_zero</span> <span class=\"n\">hc</span><span class=\"o\">,</span> <span class=\"n\">f₁.isometry_of_inner</span> <span class=\"n\">key</span><span class=\"o\">,</span> <span class=\"n\">minor'</span><span class=\"o\">⟩⟩,</span>\n  <span class=\"o\">},</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">char_fun</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">{</span><span class=\"n\">f'</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">≃</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">}</span>\n<span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">has_fderiv_at</span> <span class=\"n\">f</span> <span class=\"n\">f'.to_continuous_linear_map</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">H</span> <span class=\"o\">:</span> <span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span> <span class=\"o\">:=</span>\n<span class=\"kd\">by</span> <span class=\"n\">choose</span> <span class=\"n\">c</span> <span class=\"n\">hc</span> <span class=\"n\">huv</span> <span class=\"n\">using</span> <span class=\"o\">(</span><span class=\"n\">conformal_at_iff</span> <span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span> <span class=\"n\">H</span><span class=\"bp\">;</span> <span class=\"n\">exact</span> <span class=\"n\">c</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">_root_.conformal_at_preserves_angle</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">f'</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">≃</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">}</span>\n<span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">has_fderiv_at</span> <span class=\"n\">f</span> <span class=\"n\">f'.to_continuous_linear_map</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">H</span> <span class=\"o\">:</span> <span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n  <span class=\"n\">inner_product_geometry.angle</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">inner_product_geometry.angle</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"c1\">-- don't begin a proof with `intros u v`, just put them before the colon</span>\n  <span class=\"n\">repeat</span> <span class=\"o\">{</span><span class=\"n\">rw</span> <span class=\"n\">inner_product_geometry.angle</span><span class=\"o\">},</span>\n  <span class=\"k\">suffices</span> <span class=\"n\">new</span> <span class=\"o\">:</span> <span class=\"n\">inner</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">f'</span> <span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">f'</span> <span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">),</span>\n  <span class=\"o\">{</span> <span class=\"n\">rw</span> <span class=\"n\">new</span><span class=\"o\">,</span> <span class=\"o\">},</span>\n  <span class=\"o\">{</span>\n    <span class=\"n\">rcases</span> <span class=\"n\">H</span> <span class=\"k\">with</span> <span class=\"o\">⟨</span><span class=\"n\">f₁</span><span class=\"o\">,</span> <span class=\"n\">h₁</span><span class=\"o\">,</span> <span class=\"n\">c₁</span><span class=\"o\">,</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span> <span class=\"n\">lie</span><span class=\"o\">,</span> <span class=\"n\">h₂</span><span class=\"o\">⟩,</span>\n    <span class=\"k\">have</span> <span class=\"n\">minor</span> <span class=\"o\">:</span> <span class=\"bp\">∥</span><span class=\"n\">c₁</span><span class=\"bp\">∥</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">w</span><span class=\"o\">,</span> <span class=\"n\">hc₁</span> <span class=\"o\">(</span><span class=\"n\">norm_eq_zero.mp</span> <span class=\"n\">w</span><span class=\"o\">),</span>\n    <span class=\"k\">have</span> <span class=\"o\">:</span> <span class=\"n\">f'.to_continuous_linear_map</span> <span class=\"bp\">=</span> <span class=\"n\">f₁</span> <span class=\"o\">:=</span> <span class=\"n\">has_fderiv_at.unique</span> <span class=\"n\">h</span> <span class=\"n\">h₁</span><span class=\"o\">,</span>\n    <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">continuous_linear_equiv.coe_coe</span> <span class=\"n\">f'</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">continuous_linear_equiv.coe_def_rev</span> <span class=\"n\">f'</span><span class=\"o\">],</span>\n    <span class=\"n\">repeat</span> <span class=\"o\">{</span><span class=\"n\">rw</span> <span class=\"n\">inner_product_angle.def</span><span class=\"o\">},</span>\n    <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">this</span><span class=\"o\">,</span> <span class=\"n\">h₂</span><span class=\"o\">],</span>\n    <span class=\"n\">repeat</span> <span class=\"o\">{</span><span class=\"n\">rw</span> <span class=\"n\">function.comp_apply</span><span class=\"o\">},</span>\n    <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">real_inner_smul_left</span><span class=\"o\">,</span> <span class=\"n\">real_inner_smul_right</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">mul_assoc</span><span class=\"o\">,</span> <span class=\"n\">linear_isometry_equiv.inner_map_map</span><span class=\"o\">],</span>\n    <span class=\"n\">repeat</span> <span class=\"o\">{</span><span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">norm_smul</span><span class=\"o\">,</span> <span class=\"n\">linear_isometry_equiv.norm_map</span><span class=\"o\">]},</span>\n    <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">mul_assoc</span><span class=\"o\">],</span>\n    <span class=\"n\">exact</span> <span class=\"k\">calc</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">c₁</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">c₁</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span>\n            <span class=\"bp\">=</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">c₁</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">c₁</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">mul_comm</span><span class=\"o\">,</span> <span class=\"n\">mul_assoc</span><span class=\"o\">]</span>\n        <span class=\"bp\">...</span> <span class=\"bp\">=</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"n\">abs</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">abs</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">real.norm_eq_abs</span><span class=\"o\">]</span>\n        <span class=\"bp\">...</span> <span class=\"bp\">=</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">pow_two</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">sq_abs</span><span class=\"o\">,</span> <span class=\"n\">pow_two</span><span class=\"o\">]</span>\n        <span class=\"bp\">...</span> <span class=\"bp\">=</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">mul_assoc</span><span class=\"o\">]</span>\n        <span class=\"bp\">...</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">rw</span> <span class=\"n\">mul_div_mul_left</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">hc₁</span>\n        <span class=\"bp\">...</span> <span class=\"bp\">=</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">rw</span> <span class=\"n\">mul_div_mul_left</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span>\n  <span class=\"o\">},</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">conformal_at</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">conformal</span>\n<span class=\"o\">{</span><span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">),</span> <span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">conformal</span>\n\n<span class=\"kd\">variables</span> <span class=\"o\">{</span><span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"n\">Z</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Z</span><span class=\"o\">]</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">differentiable</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">conformal</span> <span class=\"n\">f</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"n\">differentiable</span> <span class=\"n\">ℝ</span> <span class=\"n\">f</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">differentiable_at</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">id</span> <span class=\"o\">:</span> <span class=\"n\">conformal</span> <span class=\"o\">(</span><span class=\"n\">id</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">conformal_at.id</span> <span class=\"n\">x</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">const_smul</span> <span class=\"o\">{</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"n\">conformal</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">),</span> <span class=\"n\">c</span> <span class=\"bp\">•</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">conformal_at.const_smul</span> <span class=\"n\">h</span> <span class=\"n\">x</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">comp</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">Y</span> <span class=\"bp\">→</span> <span class=\"n\">Z</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">hf</span> <span class=\"o\">:</span> <span class=\"n\">conformal</span> <span class=\"n\">f</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hg</span> <span class=\"o\">:</span> <span class=\"n\">conformal</span> <span class=\"n\">g</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"n\">conformal</span> <span class=\"o\">(</span><span class=\"n\">g</span> <span class=\"bp\">∘</span> <span class=\"n\">f</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">conformal_at.comp</span> <span class=\"o\">(</span><span class=\"n\">hf</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hg</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">x</span><span class=\"o\">))</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">conformal</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">conformal_API</span>\n</code></pre></div>",
        "id": 246432185,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1626685889
    },
    {
        "content": "<p>You might be surprised at how much dicussion just a few lines of new code can generate when under review so the smaller the PR, the better. As I say, I have only glanced but <a href=\"https://github.com/justadzr/Lean_2021/blob/5ed65e21aaa1225d34dc2bf886596039336d11d0/src/conformal.lean#L13-L136\">this much</a> looks like a possible first PR.</p>",
        "id": 246432193,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1626685895
    },
    {
        "content": "<p>The way dot notation works is that if <code>f'</code> has type <code>X ≃L[ℝ] Y</code> then of course this is just notation, and <code>f'</code> really has type <code>continuous_linear_equiv blah blah blah...</code> so <code>f'.coe_coe</code> is shorthand for <code>continuous_linear_equiv.coe_coe f'</code>.</p>",
        "id": 246432431,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1626686049
    },
    {
        "content": "<p>Oh cool, Oliver's suggestion is pretty much exactly what I just read through :-) Consider that to be your first review!</p>",
        "id": 246432482,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1626686104
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246432185\">said</a>:</p>\n<blockquote>\n<p>I played with some of the first 150 lines. Your code is really good! In the comments below I show you some more tips.</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">tactic</span>\n<span class=\"kn\">import</span> <span class=\"n\">data.matrix.notation</span>\n<span class=\"kn\">import</span> <span class=\"n\">analysis.complex.basic</span>\n<span class=\"kn\">import</span> <span class=\"n\">geometry.manifold.charted_space</span>\n<span class=\"kn\">import</span> <span class=\"n\">analysis.normed_space.inner_product</span>\n<span class=\"kn\">import</span> <span class=\"n\">linear_algebra.matrix.to_linear_equiv</span>\n<span class=\"kn\">import</span> <span class=\"n\">geometry.euclidean.basic</span>\n<span class=\"kn\">import</span> <span class=\"n\">analysis.complex.isometry</span>\n<span class=\"kn\">import</span> <span class=\"n\">analysis.normed_space.finite_dimension</span>\n\n<span class=\"kd\">noncomputable theory</span>\n\n<span class=\"c1\">-- I personally like to have section names which are \"obviously not namespaces\"</span>\n<span class=\"c1\">-- so that when I see `end conformal_API` I will know it's not the end of a namespace</span>\n\n<span class=\"kn\">section</span> <span class=\"n\">conformal_API</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">is_conformal_map</span> <span class=\"o\">{</span><span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n<span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"bp\">∃</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hc</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">lie</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">≃ₗᵢ</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">),</span> <span class=\"bp\">⇑</span><span class=\"n\">f'</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"n\">c</span> <span class=\"bp\">•</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"bp\">∘</span> <span class=\"n\">lie</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">conformal_at</span>\n<span class=\"o\">{</span><span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"bp\">∃</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">),</span> <span class=\"n\">has_fderiv_at</span> <span class=\"n\">f</span> <span class=\"n\">f'</span> <span class=\"n\">x</span> <span class=\"bp\">∧</span> <span class=\"n\">is_conformal_map</span> <span class=\"n\">f'</span>\n\n<span class=\"c1\">-- let's make an API for `conformal_at` before we start on `conformal`.</span>\n<span class=\"c1\">-- Let's do it in a namespace and set up variables for that namespace.</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">conformal_at</span>\n\n<span class=\"kd\">variables</span> <span class=\"o\">{</span><span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"n\">Z</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n  <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Z</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- save some time by opening these</span>\n<span class=\"kn\">open</span> <span class=\"n\">linear_isometry_equiv</span> <span class=\"n\">continuous_linear_map</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">differentiable_at</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"n\">differentiable_at</span> <span class=\"n\">ℝ</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"k\">let</span> <span class=\"o\">⟨</span><span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"n\">h₁</span><span class=\"o\">,</span> <span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"n\">_</span><span class=\"o\">⟩</span> <span class=\"o\">:=</span> <span class=\"n\">h</span> <span class=\"k\">in</span> <span class=\"n\">h₁.differentiable_at</span>\n\n<span class=\"c1\">-- I can use `refl` now instead of `linear_isometry_equiv.refl`</span>\n<span class=\"kd\">theorem</span> <span class=\"n\">id</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">conformal_at</span> <span class=\"n\">id</span> <span class=\"n\">x</span> <span class=\"o\">:=</span>\n<span class=\"o\">⟨</span><span class=\"n\">id</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">,</span> <span class=\"n\">has_fderiv_at_id</span> <span class=\"n\">_</span><span class=\"o\">,</span> <span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"n\">one_ne_zero</span><span class=\"o\">,</span> <span class=\"n\">refl</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">,</span> <span class=\"kd\">by</span> <span class=\"n\">ext</span><span class=\"bp\">;</span> <span class=\"n\">simp</span><span class=\"o\">⟩</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">const_smul</span> <span class=\"o\">{</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">conformal_at</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x'</span><span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">),</span> <span class=\"n\">c</span> <span class=\"bp\">•</span> <span class=\"n\">x'</span><span class=\"o\">)</span> <span class=\"n\">x</span> <span class=\"o\">:=</span>\n<span class=\"c1\">-- no `by apply` needed</span>\n<span class=\"o\">⟨</span><span class=\"n\">c</span> <span class=\"bp\">•</span> <span class=\"n\">continuous_linear_map.id</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">,</span> <span class=\"n\">has_fderiv_at.const_smul</span> <span class=\"o\">(</span><span class=\"n\">has_fderiv_at_id</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"n\">c</span><span class=\"o\">,</span> <span class=\"n\">c</span><span class=\"o\">,</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">refl</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">,</span> <span class=\"kd\">by</span> <span class=\"n\">ext</span><span class=\"bp\">;</span> <span class=\"n\">simp</span><span class=\"o\">⟩</span>\n\n<span class=\"c1\">-- putting conformal_at f x before the colon means you can `rintro` everything</span>\n<span class=\"kd\">theorem</span> <span class=\"n\">comp</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">Y</span> <span class=\"bp\">→</span> <span class=\"n\">Z</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">}</span> <span class=\"o\">:</span>\n  <span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"bp\">→</span> <span class=\"n\">conformal_at</span> <span class=\"n\">g</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">conformal_at</span> <span class=\"o\">(</span><span class=\"n\">g</span> <span class=\"bp\">∘</span> <span class=\"n\">f</span><span class=\"o\">)</span> <span class=\"n\">x</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">rintro</span> <span class=\"o\">⟨</span><span class=\"n\">f'</span><span class=\"o\">,</span> <span class=\"n\">hf₁</span><span class=\"o\">,</span> <span class=\"n\">cf</span><span class=\"o\">,</span> <span class=\"n\">hcf</span><span class=\"o\">,</span> <span class=\"n\">lief</span><span class=\"o\">,</span> <span class=\"n\">hf₂</span><span class=\"o\">⟩</span> <span class=\"o\">⟨</span><span class=\"n\">g'</span><span class=\"o\">,</span> <span class=\"n\">hg₁</span><span class=\"o\">,</span> <span class=\"n\">cg</span><span class=\"o\">,</span> <span class=\"n\">hcg</span><span class=\"o\">,</span> <span class=\"n\">lieg</span><span class=\"o\">,</span> <span class=\"n\">hg₂</span><span class=\"o\">⟩,</span>\n  <span class=\"c1\">-- ⟨ ⟩ can be used for `exists` too, no need for `use`</span>\n  <span class=\"n\">exact</span> <span class=\"o\">⟨</span><span class=\"n\">g'.comp</span> <span class=\"n\">f'</span><span class=\"o\">,</span> <span class=\"n\">has_fderiv_at.comp</span> <span class=\"n\">x</span> <span class=\"n\">hg₁</span> <span class=\"n\">hf₁</span><span class=\"o\">,</span> <span class=\"n\">cg</span> <span class=\"bp\">*</span> <span class=\"n\">cf</span><span class=\"o\">,</span> <span class=\"n\">mul_ne_zero</span> <span class=\"n\">hcg</span> <span class=\"n\">hcf</span><span class=\"o\">,</span> <span class=\"n\">lief.trans</span> <span class=\"n\">lieg</span><span class=\"o\">,</span>\n  <span class=\"c1\">-- let `simp` do all the work. You don't need `simp only` if you can close the goal.</span>\n    <span class=\"kd\">by</span> <span class=\"o\">{</span><span class=\"n\">ext</span><span class=\"o\">,</span> <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">coe_comp'</span> <span class=\"n\">f'</span> <span class=\"n\">g'</span><span class=\"o\">,</span> <span class=\"n\">hf₂</span><span class=\"o\">,</span> <span class=\"n\">hg₂</span><span class=\"o\">,</span> <span class=\"n\">smul_smul</span> <span class=\"n\">cg</span> <span class=\"n\">cf</span><span class=\"o\">]</span> <span class=\"o\">}⟩,</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">_root_.conformal_at_iff</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">f'</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">≃</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">}</span>\n<span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">has_fderiv_at</span> <span class=\"n\">f</span> <span class=\"n\">f'.to_continuous_linear_map</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"bp\">↔</span> <span class=\"bp\">∃</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hc</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">&gt;</span> <span class=\"mi\">0</span><span class=\"o\">),</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">),</span> <span class=\"n\">inner</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span><span class=\"o\">)</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">split</span><span class=\"o\">,</span>\n  <span class=\"o\">{</span> <span class=\"c1\">-- intros + rcases = rintros</span>\n    <span class=\"n\">rintros</span> <span class=\"o\">⟨</span><span class=\"n\">f₁</span><span class=\"o\">,</span> <span class=\"n\">h₁</span><span class=\"o\">,</span> <span class=\"n\">c₁</span><span class=\"o\">,</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span> <span class=\"n\">lie</span><span class=\"o\">,</span> <span class=\"n\">h₂</span><span class=\"o\">⟩,</span>\n    <span class=\"c1\">-- `use` and `intros` can be put together with `refine`. Note: also use `c₁ * c₁` not `c₁^2`, then you don't need `pow_two` later.</span>\n    <span class=\"n\">refine</span> <span class=\"o\">⟨</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span><span class=\"o\">,</span> <span class=\"n\">mul_self_pos</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span> <span class=\"bp\">λ</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">,</span> <span class=\"n\">_</span><span class=\"o\">⟩,</span>\n    <span class=\"c1\">-- dot notation `f'.coe_coe` is much more brief than `continuous_linear_equiv.coe_coe f'`</span>\n    <span class=\"c1\">-- Also -- make `simp` do the work. You don't need to rewrite and then simp; simp does rewrites for you.</span>\n    <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">f'.coe_coe</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">f'.coe_def_rev</span><span class=\"o\">,</span> <span class=\"n\">has_fderiv_at.unique</span> <span class=\"n\">h</span> <span class=\"n\">h₁</span><span class=\"o\">,</span> <span class=\"n\">h₂</span><span class=\"o\">,</span> <span class=\"n\">inner_map_map</span><span class=\"o\">,</span> <span class=\"n\">real_inner_smul_left</span><span class=\"o\">,</span>\n      <span class=\"n\">real_inner_smul_right</span><span class=\"o\">,</span> <span class=\"n\">mul_assoc</span><span class=\"o\">]</span> <span class=\"o\">},</span>\n  <span class=\"o\">{</span><span class=\"n\">rintro</span> <span class=\"o\">⟨</span><span class=\"n\">c₁</span><span class=\"o\">,</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span> <span class=\"n\">huv</span><span class=\"o\">⟩,</span>\n    <span class=\"k\">let</span> <span class=\"n\">c</span> <span class=\"o\">:=</span> <span class=\"n\">real.sqrt</span> <span class=\"n\">c₁</span><span class=\"bp\">⁻¹</span><span class=\"o\">,</span>\n    <span class=\"k\">have</span> <span class=\"n\">hc</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">w</span><span class=\"o\">,</span> <span class=\"kd\">by</span> <span class=\"o\">{</span><span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">c</span><span class=\"o\">]</span> <span class=\"n\">at</span> <span class=\"n\">w</span><span class=\"bp\">;</span>\n      <span class=\"n\">exact</span> <span class=\"o\">(</span><span class=\"n\">real.sqrt_ne_zero'.mpr</span> <span class=\"bp\">$</span> <span class=\"n\">inv_pos.mpr</span> <span class=\"n\">hc₁</span><span class=\"o\">)</span> <span class=\"n\">w</span><span class=\"o\">},</span>\n    <span class=\"k\">let</span> <span class=\"n\">c_map</span> <span class=\"o\">:=</span> <span class=\"n\">linear_equiv.smul_of_ne_zero</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span> <span class=\"n\">c</span> <span class=\"n\">hc</span><span class=\"o\">,</span>\n    <span class=\"k\">let</span> <span class=\"n\">f₁</span> <span class=\"o\">:=</span> <span class=\"n\">f'.to_linear_equiv.trans</span> <span class=\"n\">c_map</span><span class=\"o\">,</span>\n    <span class=\"k\">have</span> <span class=\"n\">minor</span> <span class=\"o\">:</span> <span class=\"bp\">⇑</span><span class=\"n\">f₁</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">Y</span><span class=\"o\">),</span> <span class=\"n\">c</span> <span class=\"bp\">•</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"bp\">∘</span> <span class=\"n\">f'</span> <span class=\"o\">:=</span> <span class=\"n\">rfl</span><span class=\"o\">,</span>\n    <span class=\"k\">have</span> <span class=\"n\">minor'</span> <span class=\"o\">:</span> <span class=\"bp\">⇑</span><span class=\"n\">f'</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">Y</span><span class=\"o\">),</span> <span class=\"n\">c</span><span class=\"bp\">⁻¹</span> <span class=\"bp\">•</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"bp\">∘</span> <span class=\"n\">f₁</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">ext</span><span class=\"bp\">;</span>\n      <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">minor</span><span class=\"o\">,</span> <span class=\"n\">function.comp_apply</span><span class=\"o\">,</span> <span class=\"n\">function.comp_apply</span><span class=\"o\">,</span>\n          <span class=\"n\">smul_smul</span><span class=\"o\">,</span> <span class=\"n\">inv_mul_cancel</span> <span class=\"n\">hc</span><span class=\"o\">,</span> <span class=\"n\">one_smul</span><span class=\"o\">],</span>\n    <span class=\"k\">have</span> <span class=\"n\">key</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">),</span> <span class=\"n\">inner</span> <span class=\"o\">(</span><span class=\"n\">f₁</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f₁</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">,</span> <span class=\"kd\">by</span>\n      <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">minor</span><span class=\"o\">,</span> <span class=\"n\">function.comp_app</span><span class=\"o\">,</span> <span class=\"n\">function.comp_app</span><span class=\"o\">,</span> <span class=\"n\">real_inner_smul_left</span><span class=\"o\">,</span>\n          <span class=\"n\">real_inner_smul_right</span><span class=\"o\">,</span> <span class=\"n\">huv</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">mul_assoc</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">mul_assoc</span><span class=\"o\">,</span>\n          <span class=\"n\">real.mul_self_sqrt</span> <span class=\"bp\">$</span> <span class=\"n\">le_of_lt</span> <span class=\"bp\">$</span> <span class=\"n\">inv_pos.mpr</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span>\n          <span class=\"n\">inv_mul_cancel</span> <span class=\"bp\">$</span> <span class=\"n\">ne_of_gt</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span> <span class=\"n\">one_mul</span><span class=\"o\">],</span>\n    <span class=\"n\">exact</span> <span class=\"o\">⟨</span><span class=\"n\">f'.to_continuous_linear_map</span><span class=\"o\">,</span> <span class=\"o\">⟨</span><span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">c</span><span class=\"bp\">⁻¹</span><span class=\"o\">,</span> <span class=\"n\">inv_ne_zero</span> <span class=\"n\">hc</span><span class=\"o\">,</span> <span class=\"n\">f₁.isometry_of_inner</span> <span class=\"n\">key</span><span class=\"o\">,</span> <span class=\"n\">minor'</span><span class=\"o\">⟩⟩,</span>\n  <span class=\"o\">},</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">char_fun</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">{</span><span class=\"n\">f'</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">≃</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">}</span>\n<span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">has_fderiv_at</span> <span class=\"n\">f</span> <span class=\"n\">f'.to_continuous_linear_map</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">H</span> <span class=\"o\">:</span> <span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span> <span class=\"o\">:=</span>\n<span class=\"kd\">by</span> <span class=\"n\">choose</span> <span class=\"n\">c</span> <span class=\"n\">hc</span> <span class=\"n\">huv</span> <span class=\"n\">using</span> <span class=\"o\">(</span><span class=\"n\">conformal_at_iff</span> <span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span> <span class=\"n\">H</span><span class=\"bp\">;</span> <span class=\"n\">exact</span> <span class=\"n\">c</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">_root_.conformal_at_preserves_angle</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">f'</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">≃</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span> <span class=\"n\">Y</span><span class=\"o\">}</span>\n<span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">has_fderiv_at</span> <span class=\"n\">f</span> <span class=\"n\">f'.to_continuous_linear_map</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">H</span> <span class=\"o\">:</span> <span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n  <span class=\"n\">inner_product_geometry.angle</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">inner_product_geometry.angle</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"c1\">-- don't begin a proof with `intros u v`, just put them before the colon</span>\n  <span class=\"n\">repeat</span> <span class=\"o\">{</span><span class=\"n\">rw</span> <span class=\"n\">inner_product_geometry.angle</span><span class=\"o\">},</span>\n  <span class=\"k\">suffices</span> <span class=\"n\">new</span> <span class=\"o\">:</span> <span class=\"n\">inner</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f'</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">f'</span> <span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">f'</span> <span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">),</span>\n  <span class=\"o\">{</span> <span class=\"n\">rw</span> <span class=\"n\">new</span><span class=\"o\">,</span> <span class=\"o\">},</span>\n  <span class=\"o\">{</span>\n    <span class=\"n\">rcases</span> <span class=\"n\">H</span> <span class=\"k\">with</span> <span class=\"o\">⟨</span><span class=\"n\">f₁</span><span class=\"o\">,</span> <span class=\"n\">h₁</span><span class=\"o\">,</span> <span class=\"n\">c₁</span><span class=\"o\">,</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span> <span class=\"n\">lie</span><span class=\"o\">,</span> <span class=\"n\">h₂</span><span class=\"o\">⟩,</span>\n    <span class=\"k\">have</span> <span class=\"n\">minor</span> <span class=\"o\">:</span> <span class=\"bp\">∥</span><span class=\"n\">c₁</span><span class=\"bp\">∥</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">w</span><span class=\"o\">,</span> <span class=\"n\">hc₁</span> <span class=\"o\">(</span><span class=\"n\">norm_eq_zero.mp</span> <span class=\"n\">w</span><span class=\"o\">),</span>\n    <span class=\"k\">have</span> <span class=\"o\">:</span> <span class=\"n\">f'.to_continuous_linear_map</span> <span class=\"bp\">=</span> <span class=\"n\">f₁</span> <span class=\"o\">:=</span> <span class=\"n\">has_fderiv_at.unique</span> <span class=\"n\">h</span> <span class=\"n\">h₁</span><span class=\"o\">,</span>\n    <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">continuous_linear_equiv.coe_coe</span> <span class=\"n\">f'</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">continuous_linear_equiv.coe_def_rev</span> <span class=\"n\">f'</span><span class=\"o\">],</span>\n    <span class=\"n\">repeat</span> <span class=\"o\">{</span><span class=\"n\">rw</span> <span class=\"n\">inner_product_angle.def</span><span class=\"o\">},</span>\n    <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">this</span><span class=\"o\">,</span> <span class=\"n\">h₂</span><span class=\"o\">],</span>\n    <span class=\"n\">repeat</span> <span class=\"o\">{</span><span class=\"n\">rw</span> <span class=\"n\">function.comp_apply</span><span class=\"o\">},</span>\n    <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">real_inner_smul_left</span><span class=\"o\">,</span> <span class=\"n\">real_inner_smul_right</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">mul_assoc</span><span class=\"o\">,</span> <span class=\"n\">linear_isometry_equiv.inner_map_map</span><span class=\"o\">],</span>\n    <span class=\"n\">repeat</span> <span class=\"o\">{</span><span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">norm_smul</span><span class=\"o\">,</span> <span class=\"n\">linear_isometry_equiv.norm_map</span><span class=\"o\">]},</span>\n    <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">mul_assoc</span><span class=\"o\">],</span>\n    <span class=\"n\">exact</span> <span class=\"k\">calc</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">c₁</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">c₁</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span>\n            <span class=\"bp\">=</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">c₁</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">c₁</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">mul_comm</span><span class=\"o\">,</span> <span class=\"n\">mul_assoc</span><span class=\"o\">]</span>\n        <span class=\"bp\">...</span> <span class=\"bp\">=</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"n\">abs</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">abs</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">real.norm_eq_abs</span><span class=\"o\">]</span>\n        <span class=\"bp\">...</span> <span class=\"bp\">=</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"bp\">←</span> <span class=\"n\">pow_two</span><span class=\"o\">,</span> <span class=\"bp\">←</span> <span class=\"n\">sq_abs</span><span class=\"o\">,</span> <span class=\"n\">pow_two</span><span class=\"o\">]</span>\n        <span class=\"bp\">...</span> <span class=\"bp\">=</span> <span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">mul_assoc</span><span class=\"o\">]</span>\n        <span class=\"bp\">...</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"n\">c₁</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">rw</span> <span class=\"n\">mul_div_mul_left</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">hc₁</span>\n        <span class=\"bp\">...</span> <span class=\"bp\">=</span> <span class=\"n\">inner</span> <span class=\"n\">u</span> <span class=\"n\">v</span> <span class=\"bp\">/</span> <span class=\"o\">(</span><span class=\"bp\">∥</span><span class=\"n\">u</span><span class=\"bp\">∥</span> <span class=\"bp\">*</span> <span class=\"bp\">∥</span><span class=\"n\">v</span><span class=\"bp\">∥</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kd\">by</span> <span class=\"n\">rw</span> <span class=\"n\">mul_div_mul_left</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">hc₁</span><span class=\"o\">,</span>\n  <span class=\"o\">},</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">conformal_at</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">conformal</span>\n<span class=\"o\">{</span><span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">),</span> <span class=\"n\">conformal_at</span> <span class=\"n\">f</span> <span class=\"n\">x</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">conformal</span>\n\n<span class=\"kd\">variables</span> <span class=\"o\">{</span><span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"n\">Z</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">X</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Y</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">inner_product_space</span> <span class=\"n\">ℝ</span> <span class=\"n\">Z</span><span class=\"o\">]</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">differentiable</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">conformal</span> <span class=\"n\">f</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"n\">differentiable</span> <span class=\"n\">ℝ</span> <span class=\"n\">f</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">differentiable_at</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">id</span> <span class=\"o\">:</span> <span class=\"n\">conformal</span> <span class=\"o\">(</span><span class=\"n\">id</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">conformal_at.id</span> <span class=\"n\">x</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">const_smul</span> <span class=\"o\">{</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">ℝ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">c</span> <span class=\"bp\">≠</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"n\">conformal</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">),</span> <span class=\"n\">c</span> <span class=\"bp\">•</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">conformal_at.const_smul</span> <span class=\"n\">h</span> <span class=\"n\">x</span>\n\n<span class=\"kd\">theorem</span> <span class=\"n\">comp</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">X</span> <span class=\"bp\">→</span> <span class=\"n\">Y</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">Y</span> <span class=\"bp\">→</span> <span class=\"n\">Z</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">hf</span> <span class=\"o\">:</span> <span class=\"n\">conformal</span> <span class=\"n\">f</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hg</span> <span class=\"o\">:</span> <span class=\"n\">conformal</span> <span class=\"n\">g</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"n\">conformal</span> <span class=\"o\">(</span><span class=\"n\">g</span> <span class=\"bp\">∘</span> <span class=\"n\">f</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">conformal_at.comp</span> <span class=\"o\">(</span><span class=\"n\">hf</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hg</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"n\">x</span><span class=\"o\">))</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">conformal</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">conformal_API</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Thank you for the comments! I will study them and adjust the rest of the file accordingly, especially not starting the proof with intros something.</p>",
        "id": 246432484,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626686106
    },
    {
        "content": "<p>You should perhaps just PR this directly to mathlib. Your github username is <code>justadzr</code> -- <span class=\"user-group-mention\" data-user-group-id=\"2494\">@maintainers</span> can Yourong have PR access to non-master branches of mathlib?</p>",
        "id": 246432538,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1626686162
    },
    {
        "content": "<p>If you make a PR you will get some more experts looking at it carefully, including people (unlike me!) who actually know something about the subject.</p>",
        "id": 246432596,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1626686195
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246432482\">said</a>:</p>\n<blockquote>\n<p>Oh cool, Oliver's suggestion is pretty much exactly what I just read through :-) Consider that to be your first review!</p>\n</blockquote>\n<p>Great, I will cut the first section and turn it into a PR.</p>",
        "id": 246432599,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626686198
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"384549\">@Yourong Zang</span> <a href=\"https://github.com/leanprover-community/mathlib/invitations\">https://github.com/leanprover-community/mathlib/invitations</a></p>",
        "id": 246432724,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1626686294
    },
    {
        "content": "<p>Making stuff a PR will not slow down your work, because you can make the PR and then make your own project have that specific branch of mathlib as a dependency rather than <code>master</code>.  My understanding is that you might find it difficult to just switch directly to working directly on a branch of mathlib because for your work on Riemann surfaces you might need some tricky facts about holomorphic functions which are not yet there. But this conformal stuff looks to me to be directly ready for mathlib. Thanks a lot for writing it!</p>",
        "id": 246432789,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1626686366
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246432789\">said</a>:</p>\n<blockquote>\n<p>Making stuff a PR will not slow down your work, because you can make the PR and then make your own project have that specific branch of mathlib as a dependency rather than <code>master</code>.  My understanding is that you might find it difficult to just switch directly to working directly on a branch of mathlib because for your work on Riemann surfaces you might need some tricky facts about holomorphic functions which are not yet there. But this conformal stuff looks to me to be directly ready for mathlib. Thanks a lot for writing it!</p>\n</blockquote>\n<p>Thank you. But in which branch should I make this pull request?</p>",
        "id": 246432925,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626686501
    },
    {
        "content": "<p><code>git checkout -b new-conformal-map-branch</code> will create a new branch for you</p>",
        "id": 246433057,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1626686610
    },
    {
        "content": "<p>But you can also use the git interface in VScode.</p>",
        "id": 246433154,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1626686659
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"384549\">@Yourong Zang</span> there is a youtube video on how to make mathlib PRs. If you are unfamiliar with git/github/PRs, you might want to watch it.</p>",
        "id": 246433179,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1626686690
    },
    {
        "content": "<p><a href=\"https://www.youtube.com/watch?v=Bnc8w9lxe8A\">#howtoPR</a></p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"Bnc8w9lxe8A\" href=\"https://www.youtube.com/watch?v=Bnc8w9lxe8A\"><img src=\"https://uploads.zulipusercontent.net/ae6a5158c3c3f73f7cadb724ecaee86e98129753/68747470733a2f2f692e7974696d672e636f6d2f76692f426e633877396c786538412f64656661756c742e6a7067\"></a></div>",
        "id": 246433231,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1626686740
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246433179\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"384549\">Yourong Zang</span> there is a youtube video on how to make mathlib PRs. If you are unfamiliar with git/github/PRs, you might want to watch it.</p>\n</blockquote>\n<p>That is extremely helpful. Thank you!</p>",
        "id": 246433316,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626686794
    },
    {
        "content": "<p>This is very nice but I still think it's much more standard to ask that conformal linear maps are <em>positive</em> multiples of isometries.</p>",
        "id": 246434009,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1626687246
    },
    {
        "content": "<p>Possibly stupid question alert: isn't multiplication by -1 an isometry, so it doesn't matter?</p>",
        "id": 246434358,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1626687503
    },
    {
        "content": "<p>Right, I guess I meant you should add that they are orientation preserving.</p>",
        "id": 246434863,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1626687894
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246434863\">said</a>:</p>\n<blockquote>\n<p>Right, I guess I meant you should add that they are orientation preserving.</p>\n</blockquote>\n<p>But wouldn't that exclude inversions in spaces of odd dimensions?</p>",
        "id": 246435253,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626688164
    },
    {
        "content": "<p>It's true this is weird. But anti-holomorphic map in complex dimension 1 should be anti-conformal, not conformal.</p>",
        "id": 246435359,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1626688235
    },
    {
        "content": "<p>But that's not super important, especially since we are used to having more general definitions in formalization.</p>",
        "id": 246435419,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1626688288
    },
    {
        "content": "<p>We should at least have a big warning in the relevant docstrings.</p>",
        "id": 246435447,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1626688307
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246435359\">said</a>:</p>\n<blockquote>\n<p>It's true this is weird. But anti-holomorphic map in complex dimension 1 should be anti-conformal, not conformal.</p>\n</blockquote>\n<p>Then should I PR a file with the orientation-preserving definition?</p>",
        "id": 246435974,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626688619
    },
    {
        "content": "<p>I think you can keep your definition as long as you put a warning in the docstrings (at module and declaration levels).</p>",
        "id": 246436144,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1626688757
    },
    {
        "content": "<p>Style remark: in mathlib we never put a brace alone on its line.  See <a href=\"https://leanprover-community.github.io/contribute/style.html\">https://leanprover-community.github.io/contribute/style.html</a>. Also, you should never need to type ⇑</p>",
        "id": 246436493,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1626688993
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246436144\">said</a>:</p>\n<blockquote>\n<p>I think you can keep your definition as long as you put a warning in the docstrings (at module and declaration levels).</p>\n</blockquote>\n<p>Would it be better to just call these maps angle-preserving instead of conformal?</p>",
        "id": 246436772,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626689178
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246436493\">said</a>:</p>\n<blockquote>\n<p>Style remark: in mathlib we never put a brace alone on its line.  See <a href=\"https://leanprover-community.github.io/contribute/style.html\">https://leanprover-community.github.io/contribute/style.html</a>. Also, you should never need to type ⇑</p>\n</blockquote>\n<p>Thank you for the information. I will adjust the code.</p>",
        "id": 246436787,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626689192
    },
    {
        "content": "<p>angle-preserving is also ambiguous since it could mean either oriented or unoriented angles. And writing <code>unoriented_angle_preserving</code> would be too long.</p>",
        "id": 246436915,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1626689293
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246436915\">said</a>:</p>\n<blockquote>\n<p>angle-preserving is also ambiguous since it could mean either oriented or unoriented angles. And writing <code>unoriented_angle_preserving</code> would be too long.</p>\n</blockquote>\n<p>Ok then I will put a warning in the docstrings.</p>",
        "id": 246436978,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626689356
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246436915\">said</a>:</p>\n<blockquote>\n<p>angle-preserving is also ambiguous since it could mean either oriented or unoriented angles. And writing <code>unoriented_angle_preserving</code> would be too long.</p>\n</blockquote>\n<p>Thank you for the instructions! They are extremely helpful.</p>",
        "id": 246436992,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626689375
    },
    {
        "content": "<p>Just wanted to say that I am also very excited to hear conformal maps are now on their way to mathlib, thanks to <span class=\"user-mention\" data-user-id=\"384549\">@Yourong Zang</span>! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> <span aria-label=\"globe\" class=\"emoji emoji-1f310\" role=\"img\" title=\"globe\">:globe:</span></p>",
        "id": 246497282,
        "sender_full_name": "Kalle Kytölä",
        "timestamp": 1626720975
    },
    {
        "content": "<p>Thank you! Though the maps are not defined in the most general sense.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"373986\">Kalle Kytölä</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246497282\">said</a>:</p>\n<blockquote>\n<p>Just wanted to say that I am also very excited to hear conformal maps are now on their way to mathlib, thanks to <span class=\"user-mention silent\" data-user-id=\"384549\">Yourong Zang</span>! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> <span aria-label=\"globe\" class=\"emoji emoji-1f310\" role=\"img\" title=\"globe\">:globe:</span></p>\n</blockquote>",
        "id": 246497977,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626721306
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"384549\">Yourong Zang</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246428735\">said</a>:</p>\n<blockquote>\n<p>Also, do we need partial derivatives to formalize Liouville's theorem on C^4 conformal mappings between Euclidean spaces?</p>\n</blockquote>\n<p>Thanks for the PR, <span class=\"user-mention\" data-user-id=\"384549\">@Yourong Zang</span>!  In answer to this question -- you can use <a href=\"https://leanprover-community.github.io/mathlib_docs/find/times_cont_diff\">docs#times_cont_diff</a>, letting <code>n</code> be 4, or just requiring <code>4 ≤ n</code>.</p>",
        "id": 246500535,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1626722296
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246500535\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"384549\">Yourong Zang</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246428735\">said</a>:</p>\n<blockquote>\n<p>Also, do we need partial derivatives to formalize Liouville's theorem on C^4 conformal mappings between Euclidean spaces?</p>\n</blockquote>\n<p>Thanks for the PR, <span class=\"user-mention silent\" data-user-id=\"384549\">Yourong Zang</span>!  In answer to this question -- you can use <a href=\"https://leanprover-community.github.io/mathlib_docs/find/times_cont_diff\">docs#times_cont_diff</a>, letting <code>n</code> be 4, or just requiring <code>4 ≤ n</code>.</p>\n</blockquote>\n<p>Thank you for the comments. I didn't see anything about partial derivatives in mathlib/Zulip. Should I define them like <code>fderiv \\R f x (v i)</code> for some standard basis <code>v</code> of a Euclidean space?</p>",
        "id": 246501873,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626722904
    },
    {
        "content": "<p>I don't think that it's really necessary to work with a basis -- can you try to give a more abstract version of the argument that doesn't require it?</p>",
        "id": 246501962,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1626722956
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246501962\">said</a>:</p>\n<blockquote>\n<p>I don't think that it's really necessary to work with a basis -- can you try to give a more abstract version of the argument that doesn't require it?</p>\n</blockquote>\n<p>Unfortunately I am not sure about that. The materials I could find are quite limited, and most of them involve dealing with partial derivatives or Jacobians.</p>",
        "id": 246502352,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626723114
    },
    {
        "content": "<p>Which source are you following?  I can try to suggest a route to a more abstract argument.</p>",
        "id": 246502471,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1626723147
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/116395-maths/topic/Formalizing.20conformal.20maps/near/246502471\">said</a>:</p>\n<blockquote>\n<p>Which source are you following?  I can try to suggest a route to a more abstract argument.</p>\n</blockquote>\n<p>That would be wonderful and extremely helpful! I am currently searching for different proofs online to resolve the problem.</p>",
        "id": 246502640,
        "sender_full_name": "Yourong Zang",
        "timestamp": 1626723240
    }
]