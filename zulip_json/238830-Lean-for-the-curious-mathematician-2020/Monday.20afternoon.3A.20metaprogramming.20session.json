[
    {
        "content": "<p>Hi everyone! The \"intermediate track\" for the afternoon is a tutorial about metaprogramming (i.e. writing your own tactics). We expect most people to follow the other track; this is aimed at people who have some familiarity with Lean already. If that sounds like you, and you're interested in metaprogramming, read on.</p>",
        "id": 203696144,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594634015
    },
    {
        "content": "<p>Under the assumption that many more people will watch these recorded than live, I pre-recorded the videos. They're all on YouTube for you to watch at your leisure. <a href=\"https://www.youtube.com/playlist?list=PLlF-CfQhukNnq2kDCw2P_vI5AfXN7egP2\">https://www.youtube.com/playlist?list=PLlF-CfQhukNnq2kDCw2P_vI5AfXN7egP2</a></p>",
        "id": 203696209,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594634051
    },
    {
        "content": "<p>I'll be around this afternoon if anyone has questions, comments, or wants to try something out.</p>",
        "id": 203696241,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594634082
    },
    {
        "content": "<p>Thanks a lot for doing the recording!</p>",
        "id": 203696261,
        "sender_full_name": "Carl Friedrich Bolz-Tereick",
        "timestamp": 1594634091
    },
    {
        "content": "<p>When/where does this session take place?</p>",
        "id": 203703840,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1594640010
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110596\">@Rob Lewis</span></p>",
        "id": 203703909,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1594640043
    },
    {
        "content": "<p>One sec! Zoom link is coming.</p>",
        "id": 203703930,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594640062
    },
    {
        "content": "<p>But the obvious place to start is the YouTube videos :)</p>",
        "id": 203703940,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594640072
    },
    {
        "content": "<p>There's like 90 minutes of stuff there.</p>",
        "id": 203703945,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594640079
    },
    {
        "content": "<p><a href=\"https://vu-live.zoom.us/j/99368691219\">https://vu-live.zoom.us/j/99368691219</a> (Password: 654479)</p>",
        "id": 203703971,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594640109
    },
    {
        "content": "<p>Rob, what we need to know is when people can do exercises.</p>",
        "id": 203703980,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1594640118
    },
    {
        "content": "<p>Video 5 gets you to the point where you can tackle the first couple exercises I posted, as well as many from the Hitchhiker's Guide.</p>",
        "id": 203704132,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594640251
    },
    {
        "content": "<p>I'm happy to answer questions in the Zoom chat.</p>",
        "id": 203704161,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594640279
    },
    {
        "content": "<p>If people have watched the videos and want to work on exercises together, I can set that up too.</p>",
        "id": 203704218,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594640295
    },
    {
        "content": "<p>People who want the exercises can run <code>leanproject get lftcm2020</code> then <code>cp -r lftcm2020/src/exercises_sources/ lftcm2020/src/my_exercises\n</code> before <code>code lftcm2020</code> and see whatever sits in <code>src/my_exercises/monday</code></p>",
        "id": 203704270,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1594640358
    },
    {
        "content": "<p>is this \"suggested\" for those who already completed the NNG?</p>",
        "id": 203704679,
        "sender_full_name": "Amos Turchet",
        "timestamp": 1594640735
    },
    {
        "content": "<p>To clarify again for people joining this session: there's no \"live presentation.\" I'll be hanging out in the Zoom room to answer questions. If you'd like to collaborate with people on the exercises, we can set that up too.</p>",
        "id": 203704696,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594640749
    },
    {
        "content": "<p>There is quite a gap from NNG to this session</p>",
        "id": 203704704,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1594640756
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"319141\">@Amos Turchet</span>, it might still be a jump.</p>",
        "id": 203704710,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1594640759
    },
    {
        "content": "<p>But I have nothing to say if you don't have anything to ask :)</p>",
        "id": 203704751,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594640763
    },
    {
        "content": "<p>If you have done NNG but nothing else, then you should probably wait for tomorrow morning session.</p>",
        "id": 203704781,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1594640788
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"319141\">@Amos Turchet</span> There is also the \"complex number game\"</p>",
        "id": 203704808,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1594640805
    },
    {
        "content": "<p>There are perhaps four levels of things to do:</p>\n<ol>\n<li>the natural numbers game</li>\n<li><code>leanproject get tutorial</code></li>\n<li><code>leanproject get lftcm2020</code> and have a go at the exercises (really intended for later in the week)</li>\n<li>Rob's meta-programming tutorials</li>\n</ol>",
        "id": 203704822,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1594640821
    },
    {
        "content": "<p>And I think Kevin has some more games up his sleeve</p>",
        "id": 203704823,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1594640821
    },
    {
        "content": "<p>And the natural numbers game also includes hanging out with Kevin and helping people who are working through the NNG.</p>",
        "id": 203704844,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1594640848
    },
    {
        "content": "<p>yeah Kevin just gave stuff to do, I'll try that first and then follow the suggestions. Thanks!</p>",
        "id": 203704853,
        "sender_full_name": "Amos Turchet",
        "timestamp": 1594640862
    },
    {
        "content": "<p>Kevin is also saying right now that he has some extra levels/worlds available for people finished with the NNG but not ready to go on to more advanced things.</p>",
        "id": 203704860,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1594640872
    },
    {
        "content": "<p>the \"lost levels\" are perfect to do after the NNG thanks!</p>",
        "id": 203705681,
        "sender_full_name": "Amos Turchet",
        "timestamp": 1594641577
    },
    {
        "content": "<p>I should add: even if you're not interested in writing metaprograms, the first two videos of the metaprogramming session should be reasonably accessible. They won't get you to the stage where you can do anything. But you could still learn something.</p>",
        "id": 203706167,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594641940
    },
    {
        "content": "<p>Seconding this --- the first two videos are useful as soon as you've done a few levels of the natural numbers game.</p>",
        "id": 203706234,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1594641981
    },
    {
        "content": "<p>Can someone post the address for getting the local version of the natural numbers game?</p>",
        "id": 203706282,
        "sender_full_name": "Jeremy Avigad",
        "timestamp": 1594642026
    },
    {
        "content": "<p>(the lost levels)</p>",
        "id": 203706342,
        "sender_full_name": "Jeremy Avigad",
        "timestamp": 1594642072
    },
    {
        "content": "<p>you can see the link here</p>",
        "id": 203706593,
        "sender_full_name": "Amos Turchet",
        "timestamp": 1594642233
    },
    {
        "content": "<p><a href=\"#narrow/stream/238830-Lean-for.20the.20curious.20mathematician.202020/topic/Mon.20afternoon.3A.20natural.20number.20game/near/203703423\">https://leanprover.zulipchat.com/#narrow/stream/238830-Lean-for.20the.20curious.20mathematician.202020/topic/Mon.20afternoon.3A.20natural.20number.20game/near/203703423</a></p>",
        "id": 203706595,
        "sender_full_name": "Amos Turchet",
        "timestamp": 1594642234
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110596\">@Rob Lewis</span> Thank you for creating these videos. I have only watched <a href=\"https://github.com/leanprover-community/mathlib/issues/1\">#1</a> and <a href=\"https://github.com/leanprover-community/mathlib/issues/2\">#2</a> so far but they are so clearly explained. <span aria-label=\"clap\" class=\"emoji emoji-1f44f\" role=\"img\" title=\"clap\">:clap:</span> My plan is to get through all of your videos as my own pace spread out over this week.</p>",
        "id": 203717843,
        "sender_full_name": "Vaibhav Karve",
        "timestamp": 1594648759
    },
    {
        "content": "<p>You're welcome! I hope the clarity stays throughout the series, but no promises ;)</p>",
        "id": 203718557,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594649108
    },
    {
        "content": "<p>yes, thanks very much <span class=\"user-mention\" data-user-id=\"110596\">@Rob Lewis</span>. I have watched 1-4 so far, just what I was looking for to break into lean metaprogramming properly</p>",
        "id": 203732764,
        "sender_full_name": "Matt Earnshaw",
        "timestamp": 1594655615
    },
    {
        "content": "<p>Regarding the <code>add_nonneg_proof</code> exercise - after I've done <code>d ← get_decl n</code>, how can I inspect the <code>d</code> object? Neither<code>trace d</code> nor <code>trace (expr.to_raw_fmt d)</code> work, and that exhausts my list of inspection tools.</p>",
        "id": 203739128,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1594658947
    },
    {
        "content": "<p>Ah, I didn't realize <code>declaration</code> doesn't have a formatting instance. <code>trace d</code> really should work. We can fix that. In the meantime, if you look around <a href=\"https://leanprover-community.github.io/mathlib_docs/find/declaration\">docs#declaration</a> you'll see lots of functions operating on declarations. You can trace <code>d.to_name</code>, <code>d.type</code>, things like that.</p>",
        "id": 203739335,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594659071
    },
    {
        "content": "<p>Nice videos, and I can work on it at my own pace. There is one thing I don't <del>quite</del> understand, on the first exercise (write a tactic for finding contradictions), the following works :</p>\n<p><code>do ctx ← local_context,\n  exfalso,\n  ctx.mfirst ( λ x, do apply x, ctx.mfirst ( λ y, exact y ) )</code></p>\n<p>while this doesn't (nor does any variation I tried on this second version):</p>\n<p><code>do ctx ← local_context,\n  exfalso,\n  ctx.mfirst ( λ x, do ctx.mfirst ( λ y, exact (x y) ) )</code></p>\n<p>How come?</p>",
        "id": 203770249,
        "sender_full_name": "Damien Thomine",
        "timestamp": 1594673836
    },
    {
        "content": "<p>What error messages are you getting? Could you post a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>?</p>",
        "id": 203789230,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1594688425
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"320882\">@Damien Thomine</span> My guess (but I'm at about the same level as you) is that you can't simply write <code>(x y)</code>, and you need something like <code>mk_app x [y]</code>.</p>",
        "id": 203798153,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1594701506
    },
    {
        "content": "<p>Of maybe <code>exact ``(x y)</code> will work?</p>",
        "id": 203798182,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1594701539
    },
    {
        "content": "<p>maybe with some antiquotations?</p>",
        "id": 203800572,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1594705318
    },
    {
        "content": "<p>Aah, probably... like I said: I'm very much a beginner myself. So you mean <code>exact ``(%%x %%y)</code> ?</p>",
        "id": 203800617,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1594705364
    },
    {
        "content": "<p>Yes, but perhaps you need to elaborate it first, with <code>to_expr ``(%%x %%y) &gt;&gt;= exact</code>? I'd have to actually run the code to know.</p>",
        "id": 203800633,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1594705430
    },
    {
        "content": "<p>Just practicing metaprogramming and I have an issue. As a warmup to what I actually want to do, I'd like to find and print everything in the context that look like this <code>WF Γ A a</code>. It looks like my \"is_WF\" function is wrong, since the filtered list is always empty. Is it because <code>WF Γ A a</code> actually has the structure <code>((WF Γ) A) a</code>?</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">meta</span> <span class=\"n\">def</span> <span class=\"n\">is_WF</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">bool</span>\n<span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"err\">%%</span> <span class=\"bp\">_</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">tt</span>\n<span class=\"bp\">|</span> <span class=\"bp\">_</span> <span class=\"o\">:=</span> <span class=\"n\">ff</span>\n\n<span class=\"n\">meta</span> <span class=\"n\">def</span> <span class=\"n\">tactic</span><span class=\"bp\">.</span><span class=\"n\">interactive</span><span class=\"bp\">.</span><span class=\"n\">print_WFs</span> <span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">unit</span> <span class=\"o\">:=</span>\n<span class=\"n\">do</span>\n  <span class=\"n\">x</span> <span class=\"err\">←</span> <span class=\"n\">local_context</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">mfilter</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">do</span> <span class=\"n\">H</span> <span class=\"err\">←</span> <span class=\"n\">infer_type</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">return</span> <span class=\"o\">(</span><span class=\"n\">is_WF</span> <span class=\"n\">H</span><span class=\"o\">)),</span>\n  <span class=\"n\">trace</span> <span class=\"n\">x</span><span class=\"o\">,</span>\n  <span class=\"n\">skip</span>\n</code></pre></div>",
        "id": 203804792,
        "sender_full_name": "Billy Price",
        "timestamp": 1594710786
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"320882\">@Damien Thomine</span> You've actually stumbled onto something pretty subtle here.</p>\n<p>Your second version should be fine, in principle. <code>x y</code> is equivalent to <code>expr.app x y</code>. Most of the time in your tactic, this is a badly formed expression -- it's something like a proof of B applied to a proof of A, which is type incorrect. Using <code>expr.app</code> doesn't give you any checks on whether your expressions are type correct. But this should be alright, because <code>exact</code> should realize the expression is badly formed and fail.</p>\n<p>However, <code>exact</code> takes some shortcuts for efficiency reasons. The vast majority of expressions it gets are well typed. So it doesn't do a full check for correctness. It will notice that the proof of B applied to the proof of A is bad. But if you give it a proof of ¬B applied to a proof of A, I think, it will recognize that you have a function (B → false) applied to an argument and assume the result is of type false, without checking the argument.</p>\n<p>So your tactic is actually succeeding. It's closing the goal with a badly formed proof. Of course this isn't valid. When the tactic is done running, the kernel gets its result, and needs to check that it's a term with the type you claim. But it isn't, so the kernel fails. Notice how in your failing example, the error is reported at the word <code>example</code> instead of at the tactic call <code>by contr</code>. Normally, if your tactic was bad, it would report the error at the tactic call.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">meta</span> <span class=\"n\">def</span> <span class=\"n\">contr</span> <span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">unit</span> <span class=\"o\">:=</span>\n<span class=\"n\">do</span> <span class=\"n\">ctx</span> <span class=\"err\">←</span> <span class=\"n\">local_context</span><span class=\"o\">,</span> <span class=\"n\">exfalso</span><span class=\"o\">,</span> <span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">mfirst</span> <span class=\"o\">(</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">do</span> <span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">mfirst</span> <span class=\"o\">(</span> <span class=\"bp\">λ</span> <span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"n\">exact</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"o\">)</span> <span class=\"o\">)</span>\n\n<span class=\"kn\">example</span> <span class=\"o\">(</span><span class=\"n\">A</span> <span class=\"n\">B</span> <span class=\"n\">C</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">ha</span> <span class=\"o\">:</span> <span class=\"n\">A</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hb</span> <span class=\"o\">:</span> <span class=\"n\">B</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hna</span> <span class=\"o\">:</span> <span class=\"bp\">¬</span> <span class=\"n\">A</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">false</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"n\">contr</span>\n</code></pre></div>\n\n\n<p>One workaround to this: you can ask the tactic to fully type check the term before feeding it into <code>exact</code>.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">meta</span> <span class=\"n\">def</span> <span class=\"n\">contr</span> <span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">unit</span> <span class=\"o\">:=</span>\n<span class=\"n\">do</span> <span class=\"n\">ctx</span> <span class=\"err\">←</span> <span class=\"n\">local_context</span><span class=\"o\">,</span> <span class=\"n\">exfalso</span><span class=\"o\">,</span> <span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">mfirst</span> <span class=\"o\">(</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">do</span> <span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">mfirst</span> <span class=\"o\">(</span> <span class=\"bp\">λ</span> <span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"n\">do</span> <span class=\"n\">type_check</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">),</span> <span class=\"n\">exact</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"o\">)</span> <span class=\"o\">)</span>\n\n<span class=\"kn\">example</span> <span class=\"o\">(</span><span class=\"n\">A</span> <span class=\"n\">B</span> <span class=\"n\">C</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">ha</span> <span class=\"o\">:</span> <span class=\"n\">A</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hb</span> <span class=\"o\">:</span> <span class=\"n\">B</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hna</span> <span class=\"o\">:</span> <span class=\"bp\">¬</span> <span class=\"n\">A</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">false</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"n\">contr</span>\n</code></pre></div>",
        "id": 203804814,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594710825
    },
    {
        "content": "<p>This is a very slick solution to the exercise, by the way!</p>",
        "id": 203804864,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594710852
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"255481\">@Billy Price</span> <code>TT.WF</code> takes three arguments? You probably want your match to be <code>`(TT.WF _ _ _) </code>.</p>",
        "id": 203804977,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594710973
    },
    {
        "content": "<p>The double <code>%%</code> in that position is used for binding a variable.</p>",
        "id": 203805007,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594711006
    },
    {
        "content": "<p>i.e. <code>``(TT.WF %%a %%b _) </code>would let you use <code>a</code> and <code>b</code> on the right hand side.</p>",
        "id": 203805029,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594711043
    },
    {
        "content": "<p>Got it</p>",
        "id": 203805287,
        "sender_full_name": "Billy Price",
        "timestamp": 1594711308
    },
    {
        "content": "<p>thanks</p>",
        "id": 203805428,
        "sender_full_name": "Billy Price",
        "timestamp": 1594711453
    },
    {
        "content": "<p>Wow I made something that works, it finds any proofs of well-formedness of complex terms in the context, and uses <code>cases</code> to break it down and bring the simpler well-formedness proofs into the context, which will be caught by my WF_prover tactic.</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">meta</span> <span class=\"n\">def</span> <span class=\"n\">is_complex_WF</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">bool</span>\n<span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">star</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">ff</span>\n<span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">top</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">ff</span>\n<span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">bot</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">ff</span>\n<span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">tt</span>\n<span class=\"bp\">|</span> <span class=\"bp\">_</span> <span class=\"o\">:=</span> <span class=\"n\">ff</span>\n\n<span class=\"n\">meta</span> <span class=\"n\">def</span> <span class=\"n\">tactic</span><span class=\"bp\">.</span><span class=\"n\">interactive</span><span class=\"bp\">.</span><span class=\"n\">reduce_WFs</span> <span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">unit</span> <span class=\"o\">:=</span>\n<span class=\"n\">do</span>\n  <span class=\"n\">local_context</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">mmap&#39;</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">do</span> <span class=\"n\">H</span> <span class=\"err\">←</span> <span class=\"n\">infer_type</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"k\">if</span> <span class=\"o\">(</span><span class=\"n\">is_complex_WF</span> <span class=\"n\">H</span><span class=\"o\">)</span> <span class=\"k\">then</span> <span class=\"o\">(</span><span class=\"n\">do</span> <span class=\"n\">cases</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">skip</span><span class=\"o\">)</span> <span class=\"k\">else</span> <span class=\"n\">skip</span><span class=\"o\">)</span>\n</code></pre></div>\n\n\n<p>Here's a very simple use case,</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kn\">example</span> <span class=\"o\">{</span><span class=\"err\">Γ</span> <span class=\"n\">p</span> <span class=\"n\">q</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">WF</span> <span class=\"err\">Γ</span> <span class=\"err\">Ω</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"err\">⋀</span> <span class=\"n\">q</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">WF</span> <span class=\"err\">Γ</span> <span class=\"err\">Ω</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"err\">⋁</span> <span class=\"n\">q</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n  <span class=\"n\">intro</span> <span class=\"n\">wfpq</span><span class=\"o\">,</span>\n  <span class=\"n\">reduce_WFs</span><span class=\"o\">,</span>\n  <span class=\"n\">WF_prover</span><span class=\"o\">,</span>\n<span class=\"kn\">end</span>\n</code></pre></div>\n\n\n<p>edit: forgot my WF_prover in the example proofs, which will essentially just apply <code>WF.or</code> and then grab the two well-formedness proofs we just extracted</p>",
        "id": 203807250,
        "sender_full_name": "Billy Price",
        "timestamp": 1594713372
    },
    {
        "content": "<p>My ambition is to have this work recursively and only pull out the WF proofs which are on variables, like getting just  <code>WF Γ Ω p</code> and <code>WF Γ Ω q</code> from <code>WF Γ Ω (⊤ ⋁ p ⋁ q)</code>. Does this already exist as a tactic?</p>",
        "id": 203807582,
        "sender_full_name": "Billy Price",
        "timestamp": 1594713622
    },
    {
        "content": "<p>There are a few ways you could do that. One way: your tactic could fail if it doesn't destruct anything. Then you can call <code>repeat {reduce_WFs}</code>, which will keep looking for things to destruct until nothing is left. A more efficient way: the <code>cases</code> tactic returns a list of the things it creates. So <code>reduce_WFs</code> could collect all of the new hypotheses that it creates using <code>cases</code>, and recurse on these. You'll want something with <code>list.mfoldl</code> instead of <code>mmap'</code>.</p>",
        "id": 203809309,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594715014
    },
    {
        "content": "<p>Can I prevent the <code>cases</code> tactic from adding the results to the context? And can I make it so that <code>apply_rules WF_rules</code> has access to the local context and also that list of well-formedness things I extracted?</p>",
        "id": 203810272,
        "sender_full_name": "Billy Price",
        "timestamp": 1594715794
    },
    {
        "content": "<p>I may be missing some context here... But no, I don't think you can stop <code>cases</code> from adding things to the context. Maybe you could <code>clear</code> things you don't want after. I'm not sure where <code>apply_rule</code> first into the picture.</p>",
        "id": 203810722,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594716129
    },
    {
        "content": "<p>Thank you very much for the explanation!</p>",
        "id": 203814534,
        "sender_full_name": "Damien Thomine",
        "timestamp": 1594719470
    },
    {
        "content": "<p><code>WF_rules</code> contains things like <code>WF.or   {Γ p q}     : WF Γ Ω p → WF Γ Ω q → WF Γ Ω (p ⋁ q)</code>, so <code>apply_rules WF_rules</code> keeps hitting the target and resulting targets with appropriate rules (or assumption) until it can't make any more progress. In <br>\n the process of explaining that - I've found what apply_rules is under the hood, and I think I can pick this apart to do what I want. Thanks for introducing me to metaprogramming! I can read this stuff now.</p>",
        "id": 203818231,
        "sender_full_name": "Billy Price",
        "timestamp": 1594722663
    },
    {
        "content": "<p>Does <code>meta constant</code> mean it was implemented in C++?</p>\n<p><code>meta constant cases_core (h : expr) (ns : list name := []) (md := semireducible) : tactic (list (name × list expr × list (name × expr)))</code></p>",
        "id": 203819133,
        "sender_full_name": "Billy Price",
        "timestamp": 1594723392
    },
    {
        "content": "<p>yes</p>",
        "id": 203819248,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1594723507
    },
    {
        "content": "<p>well, it's not a necessity but a pretty strong correlation. Pretty much all <code>meta constant</code>s in lean core have built in implementations in C++</p>",
        "id": 203819325,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1594723570
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/lean/blob/master/src/library/tactic/cases_tactic.cpp#L648-L678\">https://github.com/leanprover-community/lean/blob/master/src/library/tactic/cases_tactic.cpp#L648-L678</a></p>",
        "id": 203819395,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1594723672
    },
    {
        "content": "<p>Is is possible to do what cases does without spilling the results into the local context? Just collect them into a list?</p>",
        "id": 203819482,
        "sender_full_name": "Billy Price",
        "timestamp": 1594723753
    },
    {
        "content": "<p>collect what?</p>",
        "id": 203819575,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1594723828
    },
    {
        "content": "<p>the metavariables that cases produces exist in an extended context</p>",
        "id": 203819593,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1594723862
    },
    {
        "content": "<p>In my mind, if I have <code>h : WF Γ Ω (p ⋁ q)</code>, cases is a magic machine that gives me <code>h_1 : WF Γ Ω q</code> and <code>h_2 : WF Γ Ω p</code>. That's all I want out of it.</p>",
        "id": 203819625,
        "sender_full_name": "Billy Price",
        "timestamp": 1594723914
    },
    {
        "content": "<p>What do you get instead?</p>",
        "id": 203819687,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1594723940
    },
    {
        "content": "<p>I want the machine to deliver that as a <code>list expr</code> (I think) in my meta code so that I can feed it to <code>meta def apply_rules (hs : list pexpr) (n : nat) : tactic unit</code> (the one in tactic.core), and not dump all the results into the interactive context.</p>",
        "id": 203819981,
        "sender_full_name": "Billy Price",
        "timestamp": 1594724174
    },
    {
        "content": "<p>To directly answer your question it does work as I described - I just want it to not put the results into the context, just use them to prove stuff and then throw them away.</p>",
        "id": 203820108,
        "sender_full_name": "Billy Price",
        "timestamp": 1594724290
    },
    {
        "content": "<p>perhaps you should prove theorems like <code>WF Γ Ω (p ⋁ q) -&gt; WF Γ Ω p</code> and use them as necessary</p>",
        "id": 203820179,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1594724369
    },
    {
        "content": "<p>Oh of course! Thanks :)</p>",
        "id": 203820248,
        "sender_full_name": "Billy Price",
        "timestamp": 1594724408
    },
    {
        "content": "<p>you can also scope subproofs so that the cases is only used to prove an intermediate statement</p>",
        "id": 203820274,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1594724433
    },
    {
        "content": "<p>i.e. <code>have : WF Γ Ω p, { cases h, assumption }</code></p>",
        "id": 203820322,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1594724482
    },
    {
        "content": "<p>I can't do this because <code>h</code> is an expr, what am I supposed to do? I ambivalent to the use of cases, can I just retrieve the result of applying this function?</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kn\">lemma</span> <span class=\"n\">WF</span><span class=\"bp\">.</span><span class=\"n\">and_elim</span>  <span class=\"o\">:</span> <span class=\"n\">WF</span> <span class=\"err\">Γ</span> <span class=\"err\">Ω&#39;</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"err\">⋀</span> <span class=\"n\">q</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">WF</span> <span class=\"err\">Γ</span> <span class=\"err\">Ω&#39;</span> <span class=\"n\">p</span> <span class=\"bp\">∧</span> <span class=\"n\">WF</span> <span class=\"err\">Γ</span> <span class=\"err\">Ω&#39;</span> <span class=\"n\">q</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"o\">{</span><span class=\"n\">intro</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">cases</span> <span class=\"n\">h</span><span class=\"o\">,</span> <span class=\"n\">tidy</span><span class=\"o\">}</span>\n\n<span class=\"n\">meta</span> <span class=\"n\">def</span> <span class=\"n\">decompose_WF</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">list</span> <span class=\"n\">expr</span>\n<span class=\"bp\">|</span> <span class=\"bp\">_</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">star</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"o\">[]</span>\n<span class=\"bp\">|</span> <span class=\"bp\">_</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">top</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"o\">[]</span>\n<span class=\"bp\">|</span> <span class=\"bp\">_</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">bot</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"o\">[]</span>\n<span class=\"bp\">|</span> <span class=\"n\">h</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">and</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"n\">cases</span> <span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span><span class=\"bp\">.</span><span class=\"n\">and_elim</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"c1\">-- other cases omitted</span>\n</code></pre></div>",
        "id": 204053042,
        "sender_full_name": "Billy Price",
        "timestamp": 1594884358
    },
    {
        "content": "<p>Here's an improved version, thought now I get errors (pasted below) why can't it figure out those implicit arguments?</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">meta</span> <span class=\"n\">def</span> <span class=\"n\">decompose_WF</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">tactic</span> <span class=\"o\">(</span><span class=\"n\">list</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"bp\">×</span> <span class=\"n\">list</span> <span class=\"n\">expr</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span> <span class=\"bp\">_</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">star</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">return</span> <span class=\"o\">[]</span>\n<span class=\"bp\">|</span> <span class=\"bp\">_</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">top</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">return</span> <span class=\"o\">[]</span>\n<span class=\"bp\">|</span> <span class=\"bp\">_</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">bot</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">return</span> <span class=\"o\">[]</span>\n<span class=\"bp\">|</span> <span class=\"n\">h</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">and</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"n\">cases</span> <span class=\"o\">(</span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">app</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span><span class=\"bp\">.</span><span class=\"n\">and_elim</span><span class=\"o\">)</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span> <span class=\"n\">h</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">or</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"n\">cases</span> <span class=\"o\">(</span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">app</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span><span class=\"bp\">.</span><span class=\"n\">or_elim</span><span class=\"o\">)</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span> <span class=\"n\">h</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">imp</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"n\">cases</span> <span class=\"o\">(</span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">app</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span><span class=\"bp\">.</span><span class=\"n\">imp_elim</span><span class=\"o\">)</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span> <span class=\"n\">h</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">pair</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"n\">cases</span> <span class=\"o\">(</span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">app</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span><span class=\"bp\">.</span><span class=\"n\">pair_elim</span><span class=\"o\">)</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span> <span class=\"n\">h</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">comp</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"n\">cases</span> <span class=\"o\">(</span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">app</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span><span class=\"bp\">.</span><span class=\"n\">comp_elim</span><span class=\"o\">)</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span> <span class=\"n\">h</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">all</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"n\">cases</span> <span class=\"o\">(</span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">app</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span><span class=\"bp\">.</span><span class=\"n\">all_elim</span><span class=\"o\">)</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span> <span class=\"n\">h</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">ex</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"n\">cases</span> <span class=\"o\">(</span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">app</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span><span class=\"bp\">.</span><span class=\"n\">ex_elim</span><span class=\"o\">)</span> <span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span> <span class=\"o\">:=</span> <span class=\"n\">return</span> <span class=\"o\">[]</span>\n</code></pre></div>\n\n\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span><span class=\"bp\">.</span><span class=\"n\">and_elim</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"o\">{</span><span class=\"err\">Γ</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"n\">q</span> <span class=\"o\">:</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"err\">Ω&#39;</span> <span class=\"o\">:</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"o\">},</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"err\">Γ</span> <span class=\"err\">Ω&#39;</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"err\">⋀</span> <span class=\"n\">q</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"err\">Γ</span> <span class=\"err\">Ω&#39;</span> <span class=\"n\">p</span> <span class=\"bp\">∧</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">WF</span> <span class=\"err\">Γ</span> <span class=\"err\">Ω&#39;</span> <span class=\"n\">q</span>\n<span class=\"n\">don&#39;t</span> <span class=\"n\">know</span> <span class=\"n\">how</span> <span class=\"n\">to</span> <span class=\"n\">synthesize</span> <span class=\"n\">placeholder</span>\n<span class=\"kn\">context</span><span class=\"o\">:</span>\n<span class=\"n\">decompose_WF</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">tactic</span> <span class=\"o\">(</span><span class=\"n\">list</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"bp\">×</span> <span class=\"n\">list</span> <span class=\"n\">expr</span><span class=\"o\">)),</span>\n<span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">expr</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">level</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">expr</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">level</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">expr</span>\n<span class=\"err\">⊢</span> <span class=\"n\">list</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">typeLean</span>\n\n<span class=\"n\">don&#39;t</span> <span class=\"n\">know</span> <span class=\"n\">how</span> <span class=\"n\">to</span> <span class=\"n\">synthesize</span> <span class=\"n\">placeholder</span>\n<span class=\"kn\">context</span><span class=\"o\">:</span>\n<span class=\"n\">decompose_WF</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">tactic</span> <span class=\"o\">(</span><span class=\"n\">list</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"bp\">×</span> <span class=\"n\">list</span> <span class=\"n\">expr</span><span class=\"o\">)),</span>\n<span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">expr</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">level</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">expr</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">level</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">expr</span>\n<span class=\"err\">⊢</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">typeLean</span>\n\n<span class=\"n\">don&#39;t</span> <span class=\"n\">know</span> <span class=\"n\">how</span> <span class=\"n\">to</span> <span class=\"n\">synthesize</span> <span class=\"n\">placeholder</span>\n<span class=\"kn\">context</span><span class=\"o\">:</span>\n<span class=\"n\">decompose_WF</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">tactic</span> <span class=\"o\">(</span><span class=\"n\">list</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"bp\">×</span> <span class=\"n\">list</span> <span class=\"n\">expr</span><span class=\"o\">)),</span>\n<span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">expr</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">level</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">expr</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">level</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">expr</span>\n<span class=\"err\">⊢</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">termLean</span>\n\n<span class=\"n\">don&#39;t</span> <span class=\"n\">know</span> <span class=\"n\">how</span> <span class=\"n\">to</span> <span class=\"n\">synthesize</span> <span class=\"n\">placeholder</span>\n<span class=\"kn\">context</span><span class=\"o\">:</span>\n<span class=\"n\">decompose_WF</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">tactic</span> <span class=\"o\">(</span><span class=\"n\">list</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"bp\">×</span> <span class=\"n\">list</span> <span class=\"n\">expr</span><span class=\"o\">)),</span>\n<span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">expr</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">level</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">expr</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">level</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"bp\">_</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">expr</span>\n<span class=\"err\">⊢</span> <span class=\"n\">TT</span><span class=\"bp\">.</span><span class=\"n\">termLean</span>\n</code></pre></div>",
        "id": 204054135,
        "sender_full_name": "Billy Price",
        "timestamp": 1594885258
    },
    {
        "content": "<p>Remember that using <code>expr.app</code> directly doesn't do any kind of unification or type inference at all. When you write <code>`(TT.WF.and_elim)</code> Lean has no idea what the implicit arguments should be, and using <code>expr.app</code> to apply it to <code>h</code> won't help.</p>",
        "id": 204057493,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594887921
    },
    {
        "content": "<p>You probably want something like <code>e ← mk_app `TT.WF.and_elim [h], cases e</code></p>",
        "id": 204057565,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594887967
    },
    {
        "content": "<p>For anyone who followed my metaprogramming tutorial and is looking for more practice: I posted <a href=\"#narrow/stream/239415-metaprogramming-.2F.20tactics/topic/linarith.20preprocessing\">a topic in the metaprogramming stream here</a> with a proposal that came up yesterday. With what you learned from the videos and a bit of ingenuity, this project is totally in scope.</p>",
        "id": 204059687,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594889685
    },
    {
        "content": "<p>Cool thanks :). While debugging, I noticed my tactic wouldn't update its behaviour in other files that import it, after I make a change. Once I restart the lean server, it updates. Is this expected behaviour, something wrong with my setup or a bug in Lean?</p>",
        "id": 204065842,
        "sender_full_name": "Billy Price",
        "timestamp": 1594894433
    },
    {
        "content": "<p>This isn't expected and I haven't seen it before. Are you using any custom flags for the Lean process?</p>",
        "id": 204074559,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594901529
    },
    {
        "content": "<p>I don't know what that is</p>",
        "id": 204074600,
        "sender_full_name": "Billy Price",
        "timestamp": 1594901553
    },
    {
        "content": "<p>Then probably not.</p>",
        "id": 204074624,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594901571
    },
    {
        "content": "<p>What if you change the type of a declaration that's used in an imported file, does it notice that?</p>",
        "id": 204074706,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594901637
    },
    {
        "content": "<p>It doesn't notice that, in fact it doesn't even recognise anything newly declared in the imported file until I restart the lean server</p>",
        "id": 204075047,
        "sender_full_name": "Billy Price",
        "timestamp": 1594901874
    },
    {
        "content": "<p>Is this in VSCode?</p>",
        "id": 204075134,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594901919
    },
    {
        "content": "<p>yes</p>",
        "id": 204075140,
        "sender_full_name": "Billy Price",
        "timestamp": 1594901924
    },
    {
        "content": "<p>I tried to recreate the error with two fresh files, and the error doesn't occur.</p>",
        "id": 204075279,
        "sender_full_name": "Billy Price",
        "timestamp": 1594902039
    },
    {
        "content": "<p>Is it because I use sorry in some places in the file?</p>",
        "id": 204075310,
        "sender_full_name": "Billy Price",
        "timestamp": 1594902071
    },
    {
        "content": "<p>I don't think so. I don't remember seeing this behavior before.</p>",
        "id": 204075396,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594902128
    },
    {
        "content": "<p>I need to go in a second. Maybe if you post a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> someone can try to reproduce.</p>",
        "id": 204075414,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1594902157
    },
    {
        "content": "<p>I've figured out the issue, part of it is a vs-code bug, but it could possibly be fixed on the lean side?</p>\n<p>Steps to reproduce</p>\n<ol>\n<li><code>leanproject new bugtest</code></li>\n<li>create <code>src/file1.Lean</code> and <code>src/file2.lean</code> within vs code (pay attention to capitalisation)</li>\n<li>in <code>file2.lean</code> put <code>import file1</code></li>\n<li>Rename <code>file1.Lean</code> to <code>file1.lean</code> (remove the capitalisation), either in vs-code's browser or elsewhere</li>\n<li>Observe vs-code does not detect this change in the opened tab-name (this can be fixed by reopening the tab, but regardless the following issues still occur)</li>\n<li>Put <code>def foo : ℕ := 3</code> in <code>file1.lean</code> in vs-code </li>\n<li>do <code>#check foo</code> in <code>file2.lean</code> and observe it doesn't recognise it.</li>\n<li>Restart the lean server and observe it now recognises it</li>\n<li>Make any change to <code>file1.lean</code> (like change the type of <code>foo</code> or just delete <code>foo</code>) and observe it doesn't update in <code>file2.lean</code> until the lean server or vs code is restarted (after which the problem still persists).</li>\n</ol>\n<p>There seems to be nothing you can do to fix this broken import relationship. I got it working again by changing the file name of <code>file1.lean</code> beyond capitalisation, say to <code>file0.lean</code>, in my normal non-vs-code file browser, after which vs-code recognises <code>file1.lean</code> has been deleted from the disk, and then the import relationship is fixed again, once the import is changed to <code>import file0</code></p>\n<p>This issue also occurs when capitalising or uncapitalising other parts of the filename, say <code>File1.lean</code> vs <code>file1.lean</code>, which is arguably more likely to occur.</p>\n<p>Can anyone else reproduce this, and is this something I should register as an issue on the vscode github or the vscode-lean<br>\ngithub?</p>",
        "id": 204089557,
        "sender_full_name": "Billy Price",
        "timestamp": 1594909178
    },
    {
        "content": "<p>I think this might be the lean extension, since I've just noticed at the top of the Lean Infoview, it never updates the filename from <code>file1.Lean</code>, even after restarting the lean server and restarting vs-code. Once the file name is changed beyond just uncapitalisation, it recognises the change and fixes the link.</p>",
        "id": 204090956,
        "sender_full_name": "Billy Price",
        "timestamp": 1594909764
    },
    {
        "content": "<p>The VSCode  Lean extension has changed a lot in the last few weeks (with great results!), so having a new bug in this area is rather plausible.</p>",
        "id": 204091451,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1594909936
    },
    {
        "content": "<p>Is the lean extension responsible for the lean server? Because it's not just the info-view that fails to update the import.</p>",
        "id": 204092642,
        "sender_full_name": "Billy Price",
        "timestamp": 1594910437
    },
    {
        "content": "<p>No, the Lean extension is not responsible for the Lean server. However there were also changes on the Lean side to accommodate the new fancy widgets.</p>",
        "id": 204093859,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1594910956
    },
    {
        "content": "<p>Where should I submit this as an issue? It’s not clear to me where the source of the problem is</p>",
        "id": 204094149,
        "sender_full_name": "Billy Price",
        "timestamp": 1594911057
    },
    {
        "content": "<p>If you can't reproduce the issue without VSCode I would put it in the vscode-lean repo. In any case you expect Gabriel to handle it, and he is currently unavailable.</p>",
        "id": 204094859,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1594911323
    },
    {
        "content": "<p>I also think this conversation has drifted and should not be in that stream. <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> could you move this to the general stream (since the first message of Billy mentioning this bug)?</p>",
        "id": 204095030,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1594911380
    },
    {
        "content": "<p>This topic was moved by <span class=\"user-mention silent\" data-user-id=\"110087\">Scott Morrison</span> to <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/stream/113488-general/topic/VS.20code.20updating.20bug.3F\">#general &gt; VS code updating bug?</a></p>",
        "id": 204097961,
        "sender_full_name": "Notification Bot",
        "timestamp": 1594912618
    }
]