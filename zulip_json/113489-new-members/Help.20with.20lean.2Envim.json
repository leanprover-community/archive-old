[
    {
        "content": "<p>I am trying to use the lean.nvim plugin for Neovim (0.7), but when typing <code>:LeanGoal</code> in Neovim, I get an error message <code>\"LSP server not connected\"</code>.</p>\n<p>I have followed <a href=\"https://github.com/Julian/lean.nvim/tree/20a963c7601d019b3d69edbaabc22ba9ef5e4016\">this</a> guide for setting up the plugin, and then also, since I didn't have a \"preferred setup which includes LSP key mappings and (auto)completion\", I have followed <a href=\"https://github.com/Julian/lean.nvim/wiki/Getting-Started\">this</a> guide for setting up my <code>lean.lua</code>.</p>\n<p>One guess is that there is something wrong with my lean-language-server. If I type <code>lean-language-server</code> into the terminal, I get the following message back:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">simon</span><span class=\"bp\">@</span><span class=\"n\">orvar</span><span class=\"o\">:</span><span class=\"bp\">~$</span> <span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">language</span><span class=\"bp\">-</span><span class=\"n\">server</span>\n<span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"kn\">local</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">node_modules</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">language</span><span class=\"bp\">-</span><span class=\"n\">server</span><span class=\"bp\">/</span><span class=\"n\">node_modules</span><span class=\"bp\">/</span><span class=\"n\">vscode</span><span class=\"bp\">-</span><span class=\"n\">languageserver</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">node</span><span class=\"bp\">/</span><span class=\"n\">main.js</span><span class=\"o\">:</span><span class=\"mi\">185</span>\n        <span class=\"n\">throw</span> <span class=\"n\">new</span> <span class=\"n\">Error</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">Connection</span> <span class=\"n\">input</span> <span class=\"n\">stream</span> <span class=\"n\">is</span> <span class=\"n\">not</span> <span class=\"n\">set.</span> <span class=\"bp\">'</span> <span class=\"bp\">+</span> <span class=\"n\">commandLineMessage</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n        <span class=\"bp\">^</span>\n\n<span class=\"n\">Error</span><span class=\"o\">:</span> <span class=\"n\">Connection</span> <span class=\"n\">input</span> <span class=\"n\">stream</span> <span class=\"n\">is</span> <span class=\"n\">not</span> <span class=\"n\">set.</span> <span class=\"n\">Use</span> <span class=\"n\">arguments</span> <span class=\"n\">of</span> <span class=\"n\">createConnection</span> <span class=\"n\">or</span> <span class=\"n\">set</span> <span class=\"n\">command</span> <span class=\"n\">line</span> <span class=\"kd\">parameters</span><span class=\"o\">:</span> <span class=\"bp\">'</span><span class=\"c1\">--node-ipc', '--stdio' or '--socket={number}'</span>\n    <span class=\"n\">at</span> <span class=\"n\">_createConnection</span> <span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"kn\">local</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">node_modules</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">language</span><span class=\"bp\">-</span><span class=\"n\">server</span><span class=\"bp\">/</span><span class=\"n\">node_modules</span><span class=\"bp\">/</span><span class=\"n\">vscode</span><span class=\"bp\">-</span><span class=\"n\">languageserver</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">node</span><span class=\"bp\">/</span><span class=\"n\">main.js</span><span class=\"o\">:</span><span class=\"mi\">185</span><span class=\"o\">:</span><span class=\"mi\">15</span><span class=\"o\">)</span>\n    <span class=\"n\">at</span> <span class=\"n\">Object.createConnection</span> <span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"kn\">local</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">node_modules</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">language</span><span class=\"bp\">-</span><span class=\"n\">server</span><span class=\"bp\">/</span><span class=\"n\">node_modules</span><span class=\"bp\">/</span><span class=\"n\">vscode</span><span class=\"bp\">-</span><span class=\"n\">languageserver</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">node</span><span class=\"bp\">/</span><span class=\"n\">main.js</span><span class=\"o\">:</span><span class=\"mi\">132</span><span class=\"o\">:</span><span class=\"mi\">12</span><span class=\"o\">)</span>\n    <span class=\"n\">at</span> <span class=\"n\">Object.</span><span class=\"bp\">&lt;</span><span class=\"n\">anonymous</span><span class=\"bp\">&gt;</span> <span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"kn\">local</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">node_modules</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">language</span><span class=\"bp\">-</span><span class=\"n\">server</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">index.js</span><span class=\"o\">:</span><span class=\"mi\">17</span><span class=\"o\">:</span><span class=\"mi\">27</span><span class=\"o\">)</span>\n    <span class=\"n\">at</span> <span class=\"n\">Module._compile</span> <span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">modules</span><span class=\"bp\">/</span><span class=\"n\">cjs</span><span class=\"bp\">/</span><span class=\"n\">loader</span><span class=\"o\">:</span><span class=\"mi\">1105</span><span class=\"o\">:</span><span class=\"mi\">14</span><span class=\"o\">)</span>\n    <span class=\"n\">at</span> <span class=\"n\">Module._extensions..js</span> <span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">modules</span><span class=\"bp\">/</span><span class=\"n\">cjs</span><span class=\"bp\">/</span><span class=\"n\">loader</span><span class=\"o\">:</span><span class=\"mi\">1159</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"o\">)</span>\n    <span class=\"n\">at</span> <span class=\"n\">Module.load</span> <span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">modules</span><span class=\"bp\">/</span><span class=\"n\">cjs</span><span class=\"bp\">/</span><span class=\"n\">loader</span><span class=\"o\">:</span><span class=\"mi\">981</span><span class=\"o\">:</span><span class=\"mi\">32</span><span class=\"o\">)</span>\n    <span class=\"n\">at</span> <span class=\"n\">Module._load</span> <span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">modules</span><span class=\"bp\">/</span><span class=\"n\">cjs</span><span class=\"bp\">/</span><span class=\"n\">loader</span><span class=\"o\">:</span><span class=\"mi\">827</span><span class=\"o\">:</span><span class=\"mi\">12</span><span class=\"o\">)</span>\n    <span class=\"n\">at</span> <span class=\"n\">Function.executeUserEntryPoint</span> <span class=\"o\">[</span><span class=\"n\">as</span> <span class=\"n\">runMain</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">modules</span><span class=\"bp\">/</span><span class=\"n\">run_main</span><span class=\"o\">:</span><span class=\"mi\">77</span><span class=\"o\">:</span><span class=\"mi\">12</span><span class=\"o\">)</span>\n    <span class=\"n\">at</span> <span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">main</span><span class=\"bp\">/</span><span class=\"n\">run_main_module</span><span class=\"o\">:</span><span class=\"mi\">17</span><span class=\"o\">:</span><span class=\"mi\">47</span>\n\n<span class=\"n\">Node.js</span> <span class=\"n\">v18.2.0</span>\n</code></pre></div>\n<p>Possibly related, I get an error message when typing <code>&lt;LocalLeader&gt;s</code> in Neovim:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">E5108</span><span class=\"o\">:</span> <span class=\"n\">Error</span> <span class=\"n\">executing</span> <span class=\"n\">lua</span> <span class=\"bp\">...</span><span class=\"n\">n</span><span class=\"bp\">/.</span><span class=\"n\">vim</span><span class=\"bp\">/</span><span class=\"n\">plugged_for_nvim_0.7</span><span class=\"bp\">/</span><span class=\"n\">lean.nvim</span><span class=\"bp\">/</span><span class=\"n\">lua</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"gr\">sorry</span><span class=\"bp\">.</span><span class=\"n\">lua</span><span class=\"o\">:</span><span class=\"mi\">25</span><span class=\"o\">:</span> <span class=\"n\">bad</span>\n<span class=\"n\">argument</span> <span class=\"bp\">#</span><span class=\"mi\">1</span> <span class=\"n\">to</span> <span class=\"bp\">'</span><span class=\"n\">pairs'</span> <span class=\"o\">(</span><span class=\"n\">table</span> <span class=\"n\">expected</span><span class=\"o\">,</span> <span class=\"n\">got</span> <span class=\"n\">nil</span><span class=\"o\">)</span>\n<span class=\"n\">stack</span> <span class=\"n\">traceback</span><span class=\"o\">:</span>\n        <span class=\"o\">[</span><span class=\"n\">C</span><span class=\"o\">]:</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">'</span><span class=\"n\">pairs'</span>\n        <span class=\"bp\">...</span><span class=\"n\">n</span><span class=\"bp\">/.</span><span class=\"n\">vim</span><span class=\"bp\">/</span><span class=\"n\">plugged_for_nvim_0.7</span><span class=\"bp\">/</span><span class=\"n\">lean.nvim</span><span class=\"bp\">/</span><span class=\"n\">lua</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"gr\">sorry</span><span class=\"bp\">.</span><span class=\"n\">lua</span><span class=\"o\">:</span><span class=\"mi\">25</span><span class=\"o\">:</span> <span class=\"k\">in</span> <span class=\"n\">function</span> <span class=\"bp\">'</span><span class=\"n\">fill'</span>\n        <span class=\"o\">[</span><span class=\"n\">string</span> <span class=\"s2\">\":lua\"</span><span class=\"o\">]:</span><span class=\"mi\">1</span><span class=\"o\">:</span> <span class=\"k\">in</span> <span class=\"n\">main</span> <span class=\"n\">chunk</span>\n</code></pre></div>\n<p>Below is the <code>init.vim</code> I'm using.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">let</span> <span class=\"n\">g</span><span class=\"o\">:</span><span class=\"n\">plugged_home</span> <span class=\"bp\">=</span> <span class=\"bp\">'~/.</span><span class=\"n\">vim</span><span class=\"bp\">/</span><span class=\"n\">plugged_for_nvim_0.7'</span>\n\n<span class=\"n\">call</span> <span class=\"n\">plug</span><span class=\"bp\">#</span><span class=\"kd\">begin</span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"o\">:</span><span class=\"n\">plugged_home</span><span class=\"o\">)</span>\n    <span class=\"n\">Plug</span> <span class=\"bp\">'</span><span class=\"n\">Julian</span><span class=\"bp\">/</span><span class=\"n\">lean.nvim'</span>\n    <span class=\"n\">Plug</span> <span class=\"bp\">'</span><span class=\"n\">neovim</span><span class=\"bp\">/</span><span class=\"n\">nvim</span><span class=\"bp\">-</span><span class=\"n\">lspconfig'</span>\n    <span class=\"n\">Plug</span> <span class=\"bp\">'</span><span class=\"n\">nvim</span><span class=\"bp\">-</span><span class=\"n\">lua</span><span class=\"bp\">/</span><span class=\"n\">plenary.nvim'</span>\n    <span class=\"n\">Plug</span> <span class=\"bp\">'</span><span class=\"n\">hrsh7th</span><span class=\"bp\">/</span><span class=\"n\">nvim</span><span class=\"bp\">-</span><span class=\"n\">compe'</span>\n<span class=\"n\">call</span> <span class=\"n\">plug</span><span class=\"bp\">#</span><span class=\"kd\">end</span><span class=\"o\">()</span>\n\n<span class=\"n\">autocmd</span> <span class=\"n\">FileType</span> <span class=\"n\">lean</span> <span class=\"k\">let</span> <span class=\"n\">maplocalleader</span><span class=\"bp\">=</span><span class=\"s2\">\"+\"</span>\n</code></pre></div>",
        "id": 286529247,
        "sender_full_name": "Simon Jacobsson",
        "timestamp": 1655491989
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321696\">@Julian Berman</span></p>",
        "id": 286529276,
        "sender_full_name": "Simon Jacobsson",
        "timestamp": 1655492013
    },
    {
        "content": "<p>The <code>lean-language-server</code> error seems fine, unfortunately language servers occasionally have this tendency to be pretty unhelpful if you run them interactively and don't know what the right way to invoke them is. In this case, one needs to run <code>lean-language-server --stdio</code>, which <code>neovim</code> is going to do.</p>",
        "id": 286529559,
        "sender_full_name": "Julian Berman",
        "timestamp": 1655492152
    },
    {
        "content": "<p>I'm about to jump on a call, so I may have to come back, but just to confirm, you're running <code>:LeanGoal</code> after having opened a lean file right?</p>",
        "id": 286529635,
        "sender_full_name": "Julian Berman",
        "timestamp": 1655492172
    },
    {
        "content": "<p>Not just from an empty buffer?</p>",
        "id": 286529648,
        "sender_full_name": "Julian Berman",
        "timestamp": 1655492180
    },
    {
        "content": "<p>Before I run, a possible problem from the crystal ball :P is you're probably opening a single file somewhere? That works fine, but the default version of Lean will be Lean 4 in that case, which you may not have installed. If I'm correct and you're just doing <code>nvim foo.lean</code>, either try first opening a file in a mathlib clone (follow the <code>leanproject get</code> instructions from the site), and if that works, we'll either be able to tell <code>lean.nvim</code> you want Lean 3 by default or you should create a project with <code>leanproject new</code>, which <code>lean.nvim</code> will then realize means you're using Lean 3.</p>",
        "id": 286529859,
        "sender_full_name": "Julian Berman",
        "timestamp": 1655492311
    },
    {
        "content": "<p>And if all the above is wrong, I'll help later.</p>",
        "id": 286529867,
        "sender_full_name": "Julian Berman",
        "timestamp": 1655492316
    },
    {
        "content": "<p>Also idly, you don't want to set <code>maplocalleader</code> in an <code>autocmd</code> like that -- I'm not even 100% sure it'll work, the way <code>localleader</code> works is via this funny macro expansion, so it's probably going to be defined too late -- but also, you almost certainly want to use the same local leader key for all your filetypes</p>",
        "id": 286530140,
        "sender_full_name": "Julian Berman",
        "timestamp": 1655492456
    },
    {
        "content": "<p>So just do it globally, e.g.: <a href=\"https://github.com/Julian/dotfiles/blob/main/.config/nvim/init.vim#L4\">https://github.com/Julian/dotfiles/blob/main/.config/nvim/init.vim#L4</a></p>",
        "id": 286530203,
        "sender_full_name": "Julian Berman",
        "timestamp": 1655492483
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/stream/113489-new-members/topic/Help.20with.20lean.2Envim/near/286529559\">said</a>:</p>\n<blockquote>\n<p>The <code>lean-language-server</code> error seems fine, unfortunately language servers occasionally have this tendency to be pretty unhelpful if you run them interactively and don't know what the right way to invoke them is. In this case, one needs to run <code>lean-language-server --stdio</code>, which <code>neovim</code> is going to do.</p>\n</blockquote>\n<p>Yes, running 'lean-language-server --stdio' didn't give me any error messages.</p>",
        "id": 286531834,
        "sender_full_name": "Simon Jacobsson",
        "timestamp": 1655493333
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/stream/113489-new-members/topic/Help.20with.20lean.2Envim/near/286529859\">said</a>:</p>\n<blockquote>\n<p>Before I run, a possible problem from the crystal ball :P is you're probably opening a single file somewhere? That works fine, but the default version of Lean will be Lean 4 in that case, which you may not have installed. If I'm correct and you're just doing <code>nvim foo.lean</code>, either try first opening a file in a mathlib clone (follow the <code>leanproject get</code> instructions from the site), and if that works, we'll either be able to tell <code>lean.nvim</code> you want Lean 3 by default or you should create a project with <code>leanproject new</code>, which <code>lean.nvim</code> will then realize means you're using Lean 3.</p>\n</blockquote>\n<p>You were right!<br>\nI ran<code>leanproject get tutorials</code> and opened a file from there. Now I get the continuous compilation and I can go to definitions. <code>&lt;LocalLeader&gt;s</code> now also does what it should.</p>",
        "id": 286533034,
        "sender_full_name": "Simon Jacobsson",
        "timestamp": 1655494050
    },
    {
        "content": "<p>thanks alot :D</p>\n<p>I did not know about <code>leanproject</code> but it seems like a sane tool.</p>",
        "id": 286533556,
        "sender_full_name": "Simon Jacobsson",
        "timestamp": 1655494348
    },
    {
        "content": "<p>Great, glad to hear it. Enjoy.</p>",
        "id": 286539307,
        "sender_full_name": "Julian Berman",
        "timestamp": 1655497892
    }
]