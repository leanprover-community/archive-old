[
    {
        "content": "<p>I've occasionally run into a situation where I know an instance for some class exists (because apply_instance finds it) but the instance isn't found automatically in the way I expect. Here is a recent example I ran into:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">order.filter.countable_Inter</span>\n<span class=\"kn\">import</span> <span class=\"n\">order.filter.curry</span>\n\n<span class=\"kd\">instance</span> <span class=\"n\">countable_Inter_filter_curry</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">filter</span> <span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">filter</span> <span class=\"n\">β</span><span class=\"o\">}</span>\n  <span class=\"o\">[</span><span class=\"n\">countable_Inter_filter</span> <span class=\"n\">f</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">countable_Inter_filter</span> <span class=\"n\">g</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">countable_Inter_filter</span> <span class=\"o\">(</span><span class=\"n\">f.curry</span> <span class=\"n\">g</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">constructor</span><span class=\"o\">,</span>\n  <span class=\"n\">intros</span> <span class=\"n\">S</span> <span class=\"n\">Sct</span> <span class=\"n\">hS</span><span class=\"o\">,</span>\n  <span class=\"n\">dsimp</span><span class=\"o\">[</span><span class=\"n\">filter.curry</span><span class=\"o\">],</span>\n  <span class=\"n\">simp_rw</span><span class=\"o\">[</span><span class=\"n\">eventually_countable_ball</span> <span class=\"n\">Sct</span><span class=\"o\">],</span>\n  <span class=\"n\">exact</span> <span class=\"n\">hS</span><span class=\"o\">,</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"n\">β</span><span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">filter</span> <span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">filter</span> <span class=\"n\">β</span><span class=\"o\">}</span>\n  <span class=\"o\">[</span><span class=\"n\">countable_Inter_filter</span> <span class=\"n\">f</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">countable_Inter_filter</span> <span class=\"n\">g</span><span class=\"o\">]</span>\n  <span class=\"o\">{</span><span class=\"n\">S</span> <span class=\"o\">:</span> <span class=\"n\">set</span> <span class=\"o\">(</span><span class=\"n\">set</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"bp\">×</span> <span class=\"n\">β</span><span class=\"o\">))}</span> <span class=\"o\">(</span><span class=\"n\">Sct</span> <span class=\"o\">:</span> <span class=\"n\">S.countable</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hS</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"n\">s</span> <span class=\"bp\">∈</span> <span class=\"n\">S</span><span class=\"o\">,</span> <span class=\"n\">s</span> <span class=\"bp\">∈</span> <span class=\"n\">f.curry</span> <span class=\"n\">g</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n  <span class=\"bp\">⋂₀</span> <span class=\"n\">S</span> <span class=\"bp\">∈</span> <span class=\"n\">f.curry</span> <span class=\"n\">g</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"c1\">--exact (countable_sInter_mem Sct).mpr hS, this works, but i'd like to be able to use rw</span>\n  <span class=\"n\">rw</span> <span class=\"n\">countable_sInter_mem</span> <span class=\"n\">Sct</span><span class=\"o\">,</span> <span class=\"o\">{</span><span class=\"n\">exact</span> <span class=\"n\">hS</span><span class=\"o\">},</span>\n  <span class=\"n\">apply_instance</span><span class=\"o\">,</span> <span class=\"c1\">--why wasn't this found in the rewrite?</span>\n<span class=\"kd\">end</span>\n</code></pre></div>\n<p>The theorem <code>countable_sInter_mem</code> invoked in the example requires knowing that some filter is a <code>countable_Inter_filter</code>. When I <code>rw</code> with the theorem, it creates a goal to show the filter is a <code>countable_Inter_filter</code> instead of using the instance I just registered. If <code>apply_instance</code> closes the goal, why isn't the instance found during the <code>rw</code>?</p>",
        "id": 314255215,
        "sender_full_name": "Felix Weilacher",
        "timestamp": 1670338908
    },
    {
        "content": "<p>it's an order of operations issue. What happens is that first the term <code>countable_sInter_mem Sct</code> is elaborated, and without any context one of the typeclasses can't be determined yet. This becomes a subgoal. Then the term with metavariables is used to search for matching subexpressions in the goal, which often solves the subgoals before they appear, but in this case not. At this point we have lost track of which of the subgoals are intended to be solved by typeclass inference so we can't just go back and clean up the remaining goals with <code>apply_instance</code> without potentially calling it on things that shouldn't be solved that way</p>",
        "id": 314255858,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1670339115
    },
    {
        "content": "<p>You could do</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code>  <span class=\"n\">rw</span> <span class=\"n\">countable_sInter_mem</span><span class=\"o\">,</span>\n  <span class=\"n\">exact</span> <span class=\"n\">hS</span><span class=\"o\">,</span>\n  <span class=\"n\">exact</span> <span class=\"n\">Sct</span><span class=\"o\">,</span>\n</code></pre></div>\n<p>in this situation instead if you prefer, which sort of sidesteps the issue mario explains</p>",
        "id": 314256549,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1670339293
    },
    {
        "content": "<p>Thanks for the explanation! I think I follow you and I think I understand why Alex's suggestion works. I find it pretty unintuitive that providing less information (by leaving out <code>Sct</code>) causes the inference to succeed, though.</p>",
        "id": 314261027,
        "sender_full_name": "Felix Weilacher",
        "timestamp": 1670340610
    }
]