[
    {
        "content": "<p>While working with what to me looks a fairly reasonable definition, I ran into a\"failed to add declaration to environment\" error. Where did I go wrong?</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">geometry</span><span class=\"bp\">.</span><span class=\"n\">manifold</span><span class=\"bp\">.</span><span class=\"n\">times_cont_mdiff</span>\n<span class=\"kn\">import</span> <span class=\"n\">topology</span><span class=\"bp\">.</span><span class=\"n\">continuous_map</span>\n\n<span class=\"c\">/-</span><span class=\"cm\">!</span>\n<span class=\"cm\"># Smooth bundled map</span>\n\n<span class=\"cm\">In this file we define the type `smooth_map` of smooth bundled maps.</span>\n\n<span class=\"cm\">-/</span>\n\n<span class=\"kn\">variables</span> <span class=\"o\">{</span><span class=\"err\">ğ•œ</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">nondiscrete_normed_field</span> <span class=\"err\">ğ•œ</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">E</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">normed_group</span> <span class=\"n\">E</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">normed_space</span> <span class=\"err\">ğ•œ</span> <span class=\"n\">E</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">E&#39;</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">normed_group</span> <span class=\"n\">E&#39;</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">normed_space</span> <span class=\"err\">ğ•œ</span> <span class=\"n\">E&#39;</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">H</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">topological_space</span> <span class=\"n\">H</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">H&#39;</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">topological_space</span> <span class=\"n\">H&#39;</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">I</span> <span class=\"o\">:</span> <span class=\"n\">model_with_corners</span> <span class=\"err\">ğ•œ</span> <span class=\"n\">E</span> <span class=\"n\">H</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">I&#39;</span> <span class=\"o\">:</span> <span class=\"n\">model_with_corners</span> <span class=\"err\">ğ•œ</span> <span class=\"n\">E&#39;</span> <span class=\"n\">H&#39;</span><span class=\"o\">}</span>\n<span class=\"o\">{</span><span class=\"n\">M</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">topological_space</span> <span class=\"n\">M</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">charted_space</span> <span class=\"n\">H</span> <span class=\"n\">M</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">smooth_manifold_with_corners</span> <span class=\"n\">I</span> <span class=\"n\">M</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">M&#39;</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">topological_space</span> <span class=\"n\">M&#39;</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">charted_space</span> <span class=\"n\">H&#39;</span> <span class=\"n\">M&#39;</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">smooth_manifold_with_corners</span> <span class=\"n\">I&#39;</span> <span class=\"n\">M&#39;</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">E&#39;&#39;</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">normed_group</span> <span class=\"n\">E&#39;&#39;</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">normed_space</span> <span class=\"err\">ğ•œ</span> <span class=\"n\">E&#39;&#39;</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">H&#39;&#39;</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">topological_space</span> <span class=\"n\">H&#39;&#39;</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">I&#39;&#39;</span> <span class=\"o\">:</span> <span class=\"n\">model_with_corners</span> <span class=\"err\">ğ•œ</span> <span class=\"n\">E&#39;&#39;</span> <span class=\"n\">H&#39;&#39;</span><span class=\"o\">}</span>\n<span class=\"o\">{</span><span class=\"n\">M&#39;&#39;</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">topological_space</span> <span class=\"n\">M&#39;&#39;</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">charted_space</span> <span class=\"n\">H&#39;&#39;</span> <span class=\"n\">M&#39;&#39;</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">smooth_manifold_with_corners</span> <span class=\"n\">I&#39;&#39;</span> <span class=\"n\">M&#39;&#39;</span><span class=\"o\">]</span>\n\n<span class=\"kn\">variables</span> <span class=\"o\">(</span><span class=\"n\">I</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">I&#39;</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">M</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">M&#39;</span><span class=\"o\">)</span>\n\n<span class=\"bp\">@</span><span class=\"o\">[</span><span class=\"n\">protect_proj</span><span class=\"o\">]</span>\n<span class=\"kn\">structure</span> <span class=\"n\">smooth_map</span> <span class=\"o\">:=</span>\n<span class=\"o\">(</span><span class=\"n\">to_fun</span>             <span class=\"o\">:</span> <span class=\"n\">M</span> <span class=\"bp\">â†’</span> <span class=\"n\">M&#39;</span><span class=\"o\">)</span>\n<span class=\"o\">(</span><span class=\"n\">smooth_to_fun</span>      <span class=\"o\">:</span> <span class=\"n\">smooth</span> <span class=\"n\">I</span> <span class=\"n\">I&#39;</span> <span class=\"n\">to_fun</span><span class=\"o\">)</span>\n\n<span class=\"kn\">notation</span> <span class=\"bp\">`</span><span class=\"n\">C</span><span class=\"err\">âˆ</span><span class=\"o\">(</span><span class=\"bp\">`</span> <span class=\"n\">I</span> <span class=\"bp\">`</span><span class=\"o\">,</span> <span class=\"bp\">`</span> <span class=\"n\">M</span> <span class=\"bp\">`;</span> <span class=\"bp\">`</span> <span class=\"n\">I&#39;</span> <span class=\"bp\">`</span><span class=\"o\">,</span> <span class=\"bp\">`</span> <span class=\"n\">M&#39;</span> <span class=\"bp\">`</span><span class=\"o\">)</span><span class=\"bp\">`</span> <span class=\"o\">:=</span> <span class=\"n\">smooth_map</span> <span class=\"n\">I</span> <span class=\"n\">I&#39;</span> <span class=\"n\">M</span> <span class=\"n\">M&#39;</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">smooth_map</span>\n\n<span class=\"kn\">variables</span> <span class=\"o\">{</span><span class=\"n\">I</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">I&#39;</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">M</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">M&#39;</span><span class=\"o\">}</span>\n\n<span class=\"kn\">instance</span> <span class=\"o\">:</span> <span class=\"n\">has_coe_to_fun</span> <span class=\"n\">C</span><span class=\"err\">âˆ</span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"o\">,</span> <span class=\"n\">M</span><span class=\"bp\">;</span> <span class=\"n\">I&#39;</span><span class=\"o\">,</span> <span class=\"n\">M&#39;</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">âŸ¨_</span><span class=\"o\">,</span> <span class=\"n\">smooth_map</span><span class=\"bp\">.</span><span class=\"n\">to_fun</span><span class=\"bp\">âŸ©</span>\n<span class=\"kn\">instance</span> <span class=\"o\">:</span> <span class=\"n\">has_coe</span> <span class=\"n\">C</span><span class=\"err\">âˆ</span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"o\">,</span> <span class=\"n\">M</span><span class=\"bp\">;</span> <span class=\"n\">I&#39;</span><span class=\"o\">,</span> <span class=\"n\">M&#39;</span><span class=\"o\">)</span> <span class=\"n\">C</span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"o\">,</span> <span class=\"n\">M&#39;</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"bp\">âŸ¨Î»</span> <span class=\"n\">f</span><span class=\"o\">,</span> <span class=\"bp\">âŸ¨</span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">to_fun</span><span class=\"o\">,</span> <span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">smooth_to_fun</span><span class=\"bp\">.</span><span class=\"n\">continuous</span><span class=\"bp\">âŸ©âŸ©</span>\n\n<span class=\"kn\">variables</span> <span class=\"o\">{</span><span class=\"n\">f</span> <span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">C</span><span class=\"err\">âˆ</span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"o\">,</span> <span class=\"n\">M</span><span class=\"bp\">;</span> <span class=\"n\">I&#39;</span><span class=\"o\">,</span> <span class=\"n\">M&#39;</span><span class=\"o\">)}</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">coe_inj</span> <span class=\"o\">â¦ƒ</span><span class=\"n\">f</span> <span class=\"n\">g</span> <span class=\"o\">:</span> <span class=\"n\">C</span><span class=\"err\">âˆ</span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"o\">,</span> <span class=\"n\">M</span><span class=\"bp\">;</span> <span class=\"n\">I&#39;</span><span class=\"o\">,</span> <span class=\"n\">M&#39;</span><span class=\"o\">)â¦„</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">M</span> <span class=\"bp\">â†’</span> <span class=\"n\">M&#39;</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">g</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"bp\">=</span> <span class=\"n\">g</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"n\">cases</span> <span class=\"n\">f</span><span class=\"bp\">;</span> <span class=\"n\">cases</span> <span class=\"n\">g</span><span class=\"bp\">;</span> <span class=\"n\">cases</span> <span class=\"n\">h</span><span class=\"bp\">;</span> <span class=\"n\">refl</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"></span>\n<span class=\"cm\">kernel failed to type check declaration &#39;ext&#39; this is usually due to a buggy tactic or a bug in the builtin elaborator</span>\n<span class=\"cm\">elaborated type:</span>\n<span class=\"cm\">  âˆ€ {ğ•œ : Type u_1} [_inst_1 : nondiscrete_normed_field ğ•œ] {E : Type u_2} [_inst_2 : normed_group E]</span>\n<span class=\"cm\">  [_inst_3 : normed_space ğ•œ E] {E&#39; : Type u_3} [_inst_4 : normed_group E&#39;] [_inst_5 : normed_space ğ•œ E&#39;]</span>\n<span class=\"cm\">  [_inst_6 : topological_space H] {H&#39; : Type u_5} [_inst_7 : topological_space H&#39;] {I : model_with_corners ğ•œ E H}</span>\n<span class=\"cm\">  {I&#39; : model_with_corners ğ•œ E&#39; H&#39;} {M : Type u_6} [_inst_8 : topological_space M] [_inst_9 : charted_space H M]</span>\n<span class=\"cm\">  [_inst_10 : smooth_manifold_with_corners I M] {M&#39; : Type u_7} [_inst_11 : topological_space M&#39;]</span>\n<span class=\"cm\">  [_inst_12 : charted_space H&#39; M&#39;] [_inst_13 : smooth_manifold_with_corners I&#39; M&#39;] {f g : Câˆ(I, M; I&#39;, M&#39;)}</span>\n<span class=\"cm\">  {H_1 : Type u_4}, (âˆ€ (x : M), â‡‘f x = â‡‘g x) â†’ f = g</span>\n<span class=\"cm\">elaborated value:</span>\n<span class=\"cm\">  Î» {ğ•œ : Type u_1} [_inst_1 : nondiscrete_normed_field ğ•œ] {E : Type u_2} [_inst_2 : normed_group E]</span>\n<span class=\"cm\">  [_inst_3 : normed_space ğ•œ E] {E&#39; : Type u_3} [_inst_4 : normed_group E&#39;] [_inst_5 : normed_space ğ•œ E&#39;]</span>\n<span class=\"cm\">  [_inst_6 : topological_space H] {H&#39; : Type u_5} [_inst_7 : topological_space H&#39;] {I : model_with_corners ğ•œ E H}</span>\n<span class=\"cm\">  {I&#39; : model_with_corners ğ•œ E&#39; H&#39;} {M : Type u_6} [_inst_8 : topological_space M] [_inst_9 : charted_space H M]</span>\n<span class=\"cm\">  [_inst_10 : smooth_manifold_with_corners I M] {M&#39; : Type u_7} [_inst_11 : topological_space M&#39;]</span>\n<span class=\"cm\">  [_inst_12 : charted_space H&#39; M&#39;] [_inst_13 : smooth_manifold_with_corners I&#39; M&#39;] {f g : Câˆ(I, M; I&#39;, M&#39;)}</span>\n<span class=\"cm\">  {H_1 : Type u_4} (H_1 : âˆ€ (x : M), â‡‘f x = â‡‘g x), sorry</span>\n<span class=\"cm\">nested exception message:</span>\n<span class=\"cm\">failed to add declaration to environment, it contains local constants</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"bp\">@</span><span class=\"o\">[</span><span class=\"n\">ext</span><span class=\"o\">]</span> <span class=\"kn\">theorem</span> <span class=\"n\">ext</span> <span class=\"o\">(</span><span class=\"n\">H</span> <span class=\"o\">:</span> <span class=\"bp\">âˆ€</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"bp\">=</span> <span class=\"n\">g</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">f</span> <span class=\"bp\">=</span> <span class=\"n\">g</span> <span class=\"o\">:=</span> <span class=\"n\">sorry</span>\n</code></pre></div>",
        "id": 205494185,
        "sender_full_name": "NicolÃ² Cavalleri",
        "timestamp": 1596123341
    },
    {
        "content": "<p>You have a space <code>H</code> and an assumption <code>H</code>, and Lean is confused. Use another letter for your assumption, and things should hopefully be better.</p>",
        "id": 205496455,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1596124444
    },
    {
        "content": "<p>Ops haha I did not notice that, I copied the file from topology, changed smooth with continuous and did not even look at the name of the hypothesis</p>",
        "id": 205499674,
        "sender_full_name": "NicolÃ² Cavalleri",
        "timestamp": 1596125987
    },
    {
        "content": "<p>The error message is not extremely helpful, indeed :-)</p>",
        "id": 205507992,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1596130501
    },
    {
        "content": "<p>Yes it's impressively bad on this occasion, something perhaps to remember. Actually I'm not sure I ever remember seeing this message and it being caused by a buggy tactic or a bug in the built-in elaborator</p>",
        "id": 205508396,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1596130718
    }
]