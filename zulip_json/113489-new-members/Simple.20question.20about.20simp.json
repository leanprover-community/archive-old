[
    {
        "content": "<p>The behavior of simp depends on how the rules for computing function values are presented, in a way I don't quite understand. What follows are two ways of writing a list append function. The first case is verbose, as it lists rules for all four combinations of nil and non-nil values. The second is more concise and is the usual way one would see this function defined. Following the alternative implementations is part of a proof that a length function distributes over append. When the first definition of append is used, the simp in the last line of the proof fails, while if the second, simp succeeds. The expressions to be simplified are the same in both cases. Thanks for enlightening me as to why this is so. I know this is an easy one. --ks</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"kn\">inductive</span> <span class=\"n\">nlist</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span>\n<span class=\"bp\">|</span> <span class=\"n\">nil</span> <span class=\"o\">:</span> <span class=\"n\">nlist</span>\n<span class=\"bp\">|</span> <span class=\"n\">cons</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span>\n\n<span class=\"bp\">```</span> <span class=\"n\">lean</span>\n<span class=\"n\">def</span> <span class=\"n\">len</span> <span class=\"o\">:</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"bp\">ℕ</span>\n<span class=\"bp\">|</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span> <span class=\"o\">:=</span> <span class=\"mi\">0</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">cons</span> <span class=\"n\">h</span> <span class=\"n\">t</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"mi\">1</span> <span class=\"bp\">+</span> <span class=\"n\">len</span> <span class=\"n\">t</span>\n\n<span class=\"bp\">```</span> <span class=\"n\">lean</span>\n<span class=\"n\">def</span> <span class=\"n\">app</span> <span class=\"o\">:</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span>\n<span class=\"bp\">|</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span>  <span class=\"o\">:=</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span>\n<span class=\"bp\">|</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span> <span class=\"n\">l2</span> <span class=\"o\">:=</span> <span class=\"n\">l2</span>\n<span class=\"bp\">|</span> <span class=\"n\">l1</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span> <span class=\"o\">:=</span> <span class=\"n\">l1</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">cons</span> <span class=\"n\">h</span> <span class=\"n\">t</span><span class=\"o\">)</span> <span class=\"n\">l2</span> <span class=\"o\">:=</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">cons</span> <span class=\"n\">h</span> <span class=\"o\">(</span><span class=\"n\">app</span> <span class=\"n\">t</span> <span class=\"n\">l2</span><span class=\"o\">)</span>\n</pre></div>\n\n\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">def</span> <span class=\"n\">app</span>  <span class=\"o\">:</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span>\n<span class=\"bp\">|</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span> <span class=\"n\">l2</span>  <span class=\"o\">:=</span> <span class=\"n\">l2</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">cons</span> <span class=\"n\">h</span> <span class=\"n\">t</span><span class=\"o\">)</span> <span class=\"n\">l2</span> <span class=\"o\">:=</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">cons</span> <span class=\"n\">h</span> <span class=\"o\">(</span><span class=\"n\">app</span> <span class=\"n\">t</span> <span class=\"n\">l2</span><span class=\"o\">)</span>\n</pre></div>\n\n\n<div class=\"codehilite\"><pre><span></span><span class=\"kn\">example</span> <span class=\"o\">:</span>\n    <span class=\"bp\">∀</span> <span class=\"n\">l1</span> <span class=\"n\">l2</span> <span class=\"o\">:</span> <span class=\"n\">nlist</span><span class=\"o\">,</span>\n        <span class=\"n\">len</span> <span class=\"o\">(</span><span class=\"n\">app</span> <span class=\"n\">l1</span> <span class=\"n\">l2</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"n\">len</span> <span class=\"n\">l1</span><span class=\"o\">)</span> <span class=\"bp\">+</span> <span class=\"o\">(</span><span class=\"n\">len</span> <span class=\"n\">l2</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n<span class=\"n\">intros</span> <span class=\"n\">l1</span> <span class=\"n\">l2</span><span class=\"o\">,</span>\n<span class=\"n\">induction</span> <span class=\"n\">l1</span><span class=\"o\">,</span>\n<span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">len</span><span class=\"o\">],</span>\n<span class=\"c1\">-- len (app nlist.nil l2) = len l2</span>\n<span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">app</span><span class=\"o\">],</span>\n<span class=\"bp\">_</span>\n<span class=\"kn\">end</span>\n</pre></div>",
        "id": 151460730,
        "sender_full_name": "Kevin Sullivan",
        "timestamp": 1544548194
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"124175\">@Kevin Sullivan</span> It's easier to answer these questions if you can post a full example -- we can't try that out without definitions for <code>nlist</code> and <code>len</code>. But you can see the difference between the two by comparing the outputs of <code>#print prefix app</code>. The simp lemmas that are generated for the first definition will only fire when argument 2 is either <code>nil</code> or <code>cons</code> because you've defined those cases differently. You'd need to do something like <code>cases l2; simp [app]</code> to use that definition.</p>",
        "id": 151461827,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1544549188
    },
    {
        "content": "<blockquote>\n<p><span class=\"user-mention\" data-user-id=\"124175\">@Kevin Sullivan</span> It's easier to answer these questions if you can post a full example -- we can't try that out without definitions for <code>nlist</code> and <code>len</code>. But you can see the difference between the two by comparing the outputs of <code>#print prefix app</code>. The simp lemmas that are generated for the first definition will only fire when argument 2 is either <code>nil</code> or <code>cons</code> because you've defined those cases differently. You'd need to do something like <code>cases l2; simp [app]</code> to use that definition.</p>\n</blockquote>\n<p>Yes, just added previous defs to message above. Will evaluate your answer. Thank you, Rob.</p>",
        "id": 151462030,
        "sender_full_name": "Kevin Sullivan",
        "timestamp": 1544549388
    },
    {
        "content": "<blockquote>\n<p>Yes, just added previous defs to message above. Will evaluate your answer. Thank you, Rob.</p>\n</blockquote>\n<p>Logically equivalent definitions can sometimes create different equation lemmas which would affect the behaviour of <code>simp</code>. I am not a computer scientist, but I <em>think</em> that what <code>simp [len]</code>actually does it that it tells Lean to use the so-called equation lemmas for <code>len</code>, which you can see yourself by typing <code>#print prefix len.equations</code>.</p>",
        "id": 151510730,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1544604117
    },
    {
        "content": "<p>OK so this is the question, I think:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"kn\">inductive</span> <span class=\"n\">nlist</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span>\n<span class=\"bp\">|</span> <span class=\"n\">nil</span> <span class=\"o\">:</span> <span class=\"n\">nlist</span>\n<span class=\"bp\">|</span> <span class=\"n\">cons</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span>\n\n<span class=\"n\">def</span> <span class=\"n\">len</span> <span class=\"o\">:</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"bp\">ℕ</span>\n<span class=\"bp\">|</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span> <span class=\"o\">:=</span> <span class=\"mi\">0</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">cons</span> <span class=\"n\">h</span> <span class=\"n\">t</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"mi\">1</span> <span class=\"bp\">+</span> <span class=\"n\">len</span> <span class=\"n\">t</span>\n\n<span class=\"n\">def</span> <span class=\"n\">app1</span> <span class=\"o\">:</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span>\n<span class=\"bp\">|</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span>  <span class=\"o\">:=</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span>\n<span class=\"bp\">|</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span> <span class=\"n\">l2</span> <span class=\"o\">:=</span> <span class=\"n\">l2</span>\n<span class=\"bp\">|</span> <span class=\"n\">l1</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span> <span class=\"o\">:=</span> <span class=\"n\">l1</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">cons</span> <span class=\"n\">h</span> <span class=\"n\">t</span><span class=\"o\">)</span> <span class=\"n\">l2</span> <span class=\"o\">:=</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">cons</span> <span class=\"n\">h</span> <span class=\"o\">(</span><span class=\"n\">app1</span> <span class=\"n\">t</span> <span class=\"n\">l2</span><span class=\"o\">)</span>\n\n<span class=\"n\">def</span> <span class=\"n\">app2</span>  <span class=\"o\">:</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span> <span class=\"bp\">→</span> <span class=\"n\">nlist</span>\n<span class=\"bp\">|</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">nil</span> <span class=\"n\">l2</span>  <span class=\"o\">:=</span> <span class=\"n\">l2</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">cons</span> <span class=\"n\">h</span> <span class=\"n\">t</span><span class=\"o\">)</span> <span class=\"n\">l2</span> <span class=\"o\">:=</span> <span class=\"n\">nlist</span><span class=\"bp\">.</span><span class=\"n\">cons</span> <span class=\"n\">h</span> <span class=\"o\">(</span><span class=\"n\">app2</span> <span class=\"n\">t</span> <span class=\"n\">l2</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span> <span class=\"o\">:</span>\n  <span class=\"bp\">∀</span> <span class=\"n\">l1</span> <span class=\"n\">l2</span> <span class=\"o\">:</span> <span class=\"n\">nlist</span><span class=\"o\">,</span>\n    <span class=\"n\">len</span> <span class=\"o\">(</span><span class=\"n\">app1</span> <span class=\"n\">l1</span> <span class=\"n\">l2</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"n\">len</span> <span class=\"n\">l1</span><span class=\"o\">)</span> <span class=\"bp\">+</span> <span class=\"o\">(</span><span class=\"n\">len</span> <span class=\"n\">l2</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n  <span class=\"n\">intros</span> <span class=\"n\">l1</span> <span class=\"n\">l2</span><span class=\"o\">,</span>\n  <span class=\"n\">induction</span> <span class=\"n\">l1</span><span class=\"o\">,</span>\n  <span class=\"o\">{</span> <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">len</span><span class=\"o\">],</span>\n    <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">app1</span><span class=\"o\">],</span>\n    <span class=\"c1\">-- goal len (app1 nlist.nil l2) = len l2</span>\n    <span class=\"n\">sorry</span>\n  <span class=\"o\">},</span>\n  <span class=\"n\">sorry</span>\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">example</span> <span class=\"o\">:</span>\n  <span class=\"bp\">∀</span> <span class=\"n\">l1</span> <span class=\"n\">l2</span> <span class=\"o\">:</span> <span class=\"n\">nlist</span><span class=\"o\">,</span>\n    <span class=\"n\">len</span> <span class=\"o\">(</span><span class=\"n\">app2</span> <span class=\"n\">l1</span> <span class=\"n\">l2</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"n\">len</span> <span class=\"n\">l1</span><span class=\"o\">)</span> <span class=\"bp\">+</span> <span class=\"o\">(</span><span class=\"n\">len</span> <span class=\"n\">l2</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n  <span class=\"n\">intros</span> <span class=\"n\">l1</span> <span class=\"n\">l2</span><span class=\"o\">,</span>\n  <span class=\"n\">induction</span> <span class=\"n\">l1</span><span class=\"o\">,</span>\n  <span class=\"o\">{</span> <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">len</span><span class=\"o\">],</span>\n    <span class=\"n\">simp</span> <span class=\"o\">[</span><span class=\"n\">app2</span><span class=\"o\">],</span>\n    <span class=\"c1\">-- no goals this time</span>\n  <span class=\"o\">},</span>\n  <span class=\"n\">sorry</span>\n<span class=\"kn\">end</span>\n</pre></div>\n\n\n<p>Trying to prove the same thing with the two equivalent definitions, but a technique succeeds with <code>app2</code> and fails with <code>app1</code>.</p>",
        "id": 151511099,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1544604571
    },
    {
        "content": "<p>I changed your <code>simp [len]</code> to <code>simp only [len]</code> because you are not supposed to use <code>simp</code> in the middle of a proof -- people can add and remove simp lemmas whenever they like, which makes the behaviour unpredictable, so the general rule is to only use it to close a goal or else you are writing code which is hard to maintain.</p>",
        "id": 151511168,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1544604651
    },
    {
        "content": "<p>So the problem is exactly what Rob says: at the crucial moment where the stories diverge you are faced with a goal containing <code>app nlist.nil l2</code> and if you want to use <code>simp</code> then you are going to be hoping that the equation lemmas for <code>app</code> can deal with this. Now the equation lemmas aren't a big secret here -- they are the things you used to define <code>app</code>. So if you use <code>app1</code> then there are four equation lemmas, saying what to do in the nil/nil, nil/cons, cons/nil and cons/cons case, as you can see with <code>#print prefix app1.equations</code>. But none of these are any use to you if your goal is <code>app1 nlist.nil l2</code> because we don't know whether <code>l2</code> is a nil or a cons, so none of the lemmas apply! You can guess the rest. The equation lemmas for <code>app2</code> explicitly mention this nil/l2 case, so <code>simp</code> works. And as Rob also said, the way to fix this in the app1 situation is to branch on whether <code>l2</code> is a nil or a cons using induction or cases.</p>",
        "id": 151511471,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1544605079
    }
]