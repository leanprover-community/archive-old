[
    {
        "content": "<p>It seems that the <code>fails_quickly</code> linter is unhappy with <a href=\"https://github.com/leanprover-community/mathlib/pull/12719\">#12719</a> </p>\n<p>I checked the typeclass trace to the best of my ability, and didn't see anything too suspicious.<br>\nI think it would be worthwhile to ask for input from someone who knows the inner workings better than I do before trying to increase thee limit in the <code>fails_quickly</code> linter.</p>\n<p>Any thoughts?</p>",
        "id": 275566513,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1647459503
    },
    {
        "content": "<p>Actually, there may actually be an issue.</p>",
        "id": 275579259,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1647465833
    },
    {
        "content": "<p>After some troubleshooting, it seems that the instance</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">variables</span> <span class=\"o\">(</span><span class=\"n\">A</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">A</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">is_domain</span> <span class=\"n\">A</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">discrete_valuation_ring</span> <span class=\"n\">A</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[priority 100]</span>\n<span class=\"kd\">instance</span> <span class=\"n\">of_discrete_valuation_ring</span> <span class=\"o\">:</span> <span class=\"n\">valuation_ring</span> <span class=\"n\">A</span> <span class=\"o\">:=</span> <span class=\"bp\">...</span>\n</code></pre></div>\n<p>was causing some issues with <code>witt_vector</code>. </p>\n<p>I have no idea why, and it seems to me that we want the <code>DVR -&gt; valuation_ring</code> instance to be an actual instance as opposed to a mere lemma. Any help in troubleshooting this would be greatly appreciated! </p>\n<p>For now I have changed the instance to a lemma in the PR.</p>",
        "id": 275666867,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1647529538
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110596\">@Rob Lewis</span> could you debug this instance issue?</p>",
        "id": 275668961,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1647530293
    },
    {
        "content": "<p>With</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"sd\">/-- A DVR is a valuation ring. -/</span>\n<span class=\"kd\">@[priority 100]</span>\n<span class=\"kd\">instance</span> <span class=\"n\">of_discrete_valuation_ring</span> <span class=\"o\">:</span> <span class=\"n\">valuation_ring</span> <span class=\"n\">A</span> <span class=\"o\">:=</span>\n</code></pre></div>\n<p>I don't get any error. Should I change some import too see it?</p>",
        "id": 275669173,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1647530383
    },
    {
        "content": "<p>It's the <code>fails_quickly</code> linter that complains</p>",
        "id": 275669211,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1647530396
    },
    {
        "content": "<p>Doing the <code>import all</code> test, it seems that there is some loop happening, but I don't know how to debug beyond that.</p>",
        "id": 275669321,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1647530419
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/275668961\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110596\">Rob Lewis</span> could you debug this instance issue?</p>\n</blockquote>\n<p>Probably not today, I'm afraid</p>",
        "id": 275669807,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1647530585
    },
    {
        "content": "<p>There's no rush at all! I'll be busy all day today with teaching anyway.</p>",
        "id": 275670925,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1647530954
    },
    {
        "content": "<p><span aria-label=\"ping pong\" class=\"emoji emoji-1f3d3\" role=\"img\" title=\"ping pong\">:ping_pong:</span> <br>\nI would like to get this PR moving again (as well as the followup <a href=\"https://github.com/leanprover-community/mathlib/pull/12741\">#12741</a> ).</p>\n<p>I'm happy to leave <code>of_discrete_valuation_ring</code>as a non-instance lemma for now, but if there is a quick fix to the <code>fails_quickly</code> linter failing, that would be preferable.</p>",
        "id": 276655960,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1648230649
    },
    {
        "content": "<p>It may not be connected, but does your branch have Gabriel's removal of the path connected instance? This was causing a bunch of issues and that fix resolved two PRs for me.</p>",
        "id": 276657890,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1648231541
    },
    {
        "content": "<p>I don't think that's the issue --- I suspect it has something to do with the DVR instance for Witt vectors.<br>\nAnyway, let me merge master just in case.</p>",
        "id": 276658582,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1648231851
    },
    {
        "content": "<p>Okay, it seems that we have the same issue with the instance as before, even after merging master.</p>",
        "id": 276685463,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1648246128
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib/runs/5697987432?check_suite_focus=true\">https://github.com/leanprover-community/mathlib/runs/5697987432?check_suite_focus=true</a></p>",
        "id": 276685490,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1648246148
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> you delegated this PR, but are you happy to have the DVR-&gt;valuation instance be a lemma to make the linter happy? If so, I'll change it to a non-instance and call on bors.</p>",
        "id": 276727659,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1648303387
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> hmm, I don't know what the problem is here. It would be nice if we can keep it as an instance</p>",
        "id": 276728920,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1648305237
    },
    {
        "content": "<p>Yeah I agree</p>",
        "id": 276728961,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1648305250
    },
    {
        "content": "<p>And everything is a prop... It's strange</p>",
        "id": 276728971,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1648305266
    },
    {
        "content": "<p>Unfortunately I don't know much about debugging such things</p>",
        "id": 276729039,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1648305386
    },
    {
        "content": "<p>I stripped it down to a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">ring_theory.valuation.valuation_ring</span>\n<span class=\"c1\">--import ring_theory.witt_vector.basic -- import this doesn't yield timeout</span>\n<span class=\"kn\">import</span> <span class=\"n\">ring_theory.witt_vector.discrete_valuation_ring</span> <span class=\"c1\">-- must import this to get timeout</span>\n<span class=\"c1\">--set_option trace.class_instances true</span>\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">nontrivial</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">apply_instance</span>\n</code></pre></div>\n<p>looks like the <code>valuation_ring.local_ring</code> introduced by this PR is also involved:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_7</span> <span class=\"o\">:</span> <span class=\"n\">nontrivial</span> <span class=\"n\">R</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">local_ring.to_nontrivial</span> <span class=\"bp\">?</span><span class=\"n\">x_142</span> <span class=\"bp\">?</span><span class=\"n\">x_143</span> <span class=\"bp\">?</span><span class=\"n\">x_144</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_144</span> <span class=\"o\">:</span> <span class=\"bp\">@</span><span class=\"n\">local_ring</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_143</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">valuation_ring.local_ring</span> <span class=\"bp\">?</span><span class=\"n\">x_145</span> <span class=\"bp\">?</span><span class=\"n\">x_146</span> <span class=\"bp\">?</span><span class=\"n\">x_147</span> <span class=\"bp\">?</span><span class=\"n\">x_148</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_148</span> <span class=\"o\">:</span> <span class=\"bp\">@</span><span class=\"n\">valuation_ring</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_146</span> <span class=\"bp\">?</span><span class=\"n\">x_147</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">valuation_ring.of_discrete_valuation_ring</span> <span class=\"bp\">?</span><span class=\"n\">x_149</span> <span class=\"bp\">?</span><span class=\"n\">x_150</span> <span class=\"bp\">?</span><span class=\"n\">x_151</span> <span class=\"bp\">?</span><span class=\"n\">x_152</span>\n</code></pre></div>\n<p>and finally instance inference is stuck at <code>field R</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">field</span> <span class=\"n\">R</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">cached</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">field</span> <span class=\"n\">R</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">cached</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">field</span> <span class=\"n\">R</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>Full trace at <a href=\"https://gist.github.com/alreadydone/cd9fd4abf86dedae861884724586fc30\">https://gist.github.com/alreadydone/cd9fd4abf86dedae861884724586fc30</a> if anyone wants to take a look</p>",
        "id": 277093738,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1648614943
    },
    {
        "content": "<p>Thanks! <span class=\"user-mention\" data-user-id=\"110043\">@Gabriel Ebner</span> do you think you can understand what the issue is here?</p>",
        "id": 277096884,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1648619091
    },
    {
        "content": "<p>The repeated <code>cached failure for field R</code> messages suggest that there's a unification problem hitting some exponential case.</p>",
        "id": 277110793,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1648629389
    },
    {
        "content": "<p>With <code>set_option trace.type_context.is_def_eq_detail true</code> we get a trace like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">field</span> <span class=\"n\">R</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">]:</span> <span class=\"bp\">@</span><span class=\"n\">comm_ring.to_ring</span> <span class=\"bp\">?</span><span class=\"n\">x_135</span> <span class=\"bp\">?</span><span class=\"n\">x_136</span> <span class=\"bp\">=?=</span> <span class=\"bp\">@</span><span class=\"n\">comm_ring.to_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">hp</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)))</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">cached</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">field</span> <span class=\"n\">R</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">]:</span> <span class=\"bp\">@</span><span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">hp</span> <span class=\"n\">_inst_1</span> <span class=\"bp\">=?=</span> <span class=\"bp\">@</span><span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">hp</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">cached</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">field</span> <span class=\"n\">R</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"o\">]:</span> <span class=\"n\">_inst_1</span> <span class=\"bp\">=?=</span> <span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">_inst_1</span> <span class=\"bp\">=?=</span> <span class=\"bp\">@</span><span class=\"n\">comm_ring.mk</span> <span class=\"n\">R</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_add.add</span> <span class=\"n\">R</span>\n     <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">distrib.to_has_add</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ring.to_distrib</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">division_ring.to_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_division_ring</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)))))</span>\n  <span class=\"n\">_</span>\n  <span class=\"mi\">0</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.nsmul</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_neg.neg</span> <span class=\"n\">R</span>\n     <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">sub_neg_monoid.to_has_neg</span> <span class=\"n\">R</span>\n        <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">add_group.to_sub_neg_monoid</span> <span class=\"n\">R</span>\n           <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">add_comm_group.to_add_group</span> <span class=\"n\">R</span>\n              <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ring.to_add_comm_group</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">division_ring.to_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_division_ring</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)))))))</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.sub</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)</span>\n  <span class=\"n\">_</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.zsmul</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_mul.mul</span> <span class=\"n\">R</span>\n     <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">distrib.to_has_mul</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ring.to_distrib</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">division_ring.to_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_division_ring</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)))))</span>\n  <span class=\"n\">_</span>\n  <span class=\"mi\">1</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.npow</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"n\">on</span> <span class=\"n\">failure</span><span class=\"o\">:</span> <span class=\"n\">_inst_1</span> <span class=\"bp\">=?=</span> <span class=\"bp\">@</span><span class=\"n\">comm_ring.mk</span> <span class=\"n\">R</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_add.add</span> <span class=\"n\">R</span>\n     <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">distrib.to_has_add</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ring.to_distrib</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">division_ring.to_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_division_ring</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)))))</span>\n  <span class=\"n\">_</span>\n  <span class=\"mi\">0</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.nsmul</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_neg.neg</span> <span class=\"n\">R</span>\n     <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">sub_neg_monoid.to_has_neg</span> <span class=\"n\">R</span>\n        <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">add_group.to_sub_neg_monoid</span> <span class=\"n\">R</span>\n           <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">add_comm_group.to_add_group</span> <span class=\"n\">R</span>\n              <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ring.to_add_comm_group</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">division_ring.to_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_division_ring</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)))))))</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.sub</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)</span>\n  <span class=\"n\">_</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.zsmul</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_mul.mul</span> <span class=\"n\">R</span>\n     <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">distrib.to_has_mul</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ring.to_distrib</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">division_ring.to_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_division_ring</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)))))</span>\n  <span class=\"n\">_</span>\n  <span class=\"mi\">1</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.npow</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"n\">unfold</span> <span class=\"n\">left</span><span class=\"bp\">&amp;</span><span class=\"n\">right</span><span class=\"o\">:</span> <span class=\"n\">witt_vector.comm_ring</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"o\">]:</span> <span class=\"bp\">@</span><span class=\"n\">function.surjective.comm_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial</span> <span class=\"n\">R</span> <span class=\"n\">â„¤</span> <span class=\"n\">int.comm_semiring</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">comm_ring_auxâ‚‚</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">hp</span> <span class=\"n\">_inst_1</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_zero</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_one</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_add</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_mul</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_neg</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_sub</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_nat_scalar</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_int_scalar</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_nat_pow</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.map_fun</span> <span class=\"n\">p</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial</span> <span class=\"n\">R</span> <span class=\"n\">â„¤</span> <span class=\"n\">int.comm_semiring</span><span class=\"o\">)</span> <span class=\"n\">R</span> <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span><span class=\"o\">))</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span> <span class=\"bp\">=?=</span> <span class=\"bp\">@</span><span class=\"n\">function.surjective.comm_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial</span> <span class=\"n\">R</span> <span class=\"n\">â„¤</span> <span class=\"n\">int.comm_semiring</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">comm_ring_auxâ‚‚</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">hp</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)))</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_zero</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_one</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_add</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_mul</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_neg</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_sub</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_nat_scalar</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_int_scalar</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.has_nat_pow</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span> <span class=\"n\">hp</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">witt_vector.map_fun</span> <span class=\"n\">p</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial</span> <span class=\"n\">R</span> <span class=\"n\">â„¤</span> <span class=\"n\">int.comm_semiring</span><span class=\"o\">)</span> <span class=\"n\">R</span>\n     <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))))</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n  <span class=\"n\">_</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"bp\">@</span><span class=\"n\">witt_vector.map_fun</span> <span class=\"n\">p</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial</span> <span class=\"n\">R</span> <span class=\"n\">â„¤</span> <span class=\"n\">int.comm_semiring</span><span class=\"o\">)</span> <span class=\"n\">R</span> <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span><span class=\"o\">)</span> <span class=\"bp\">=?=</span> <span class=\"bp\">@</span><span class=\"n\">witt_vector.map_fun</span> <span class=\"n\">p</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial</span> <span class=\"n\">R</span> <span class=\"n\">â„¤</span> <span class=\"n\">int.comm_semiring</span><span class=\"o\">)</span> <span class=\"n\">R</span>\n  <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)))</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">7</span><span class=\"o\">]:</span> <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span><span class=\"o\">)</span> <span class=\"bp\">=?=</span> <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">)))</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">8</span><span class=\"o\">]:</span> <span class=\"bp\">@</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span> <span class=\"bp\">=?=</span> <span class=\"bp\">@</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">cached</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">field</span> <span class=\"n\">R</span>\n</code></pre></div>",
        "id": 277110880,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1648629445
    },
    {
        "content": "<p>Somehow, the system has decided that the <code>comm_ring R</code> instance derives from a hypothetical <code>field R</code> instance (rather than using <code>_inst_1</code> from the context). The rules for unification where a metavariable is in the place of an instance are basically:</p>\n<ul>\n<li>try to synthesize the instance (which fails here, leading to the \"cached failure for field R\" messages)</li>\n<li>failing that, treat it as a normal metavariable, and hope that unification will solve the metavariable (which means here to unfold everything and try unifying the subterms, leading to the blowup)</li>\n</ul>",
        "id": 277112059,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1648630016
    },
    {
        "content": "<p>What I don't quite understand is the following behaviour:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">discrete_valuation_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">apply_instance</span> <span class=\"c1\">-- Fails quickly because there is no `is_domain (witt_vector p R)` instance in the context</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:=</span>\n<span class=\"n\">valuation_ring.of_discrete_valuation_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"c1\">-- Times out on `discrete_valuation_ring (witt_vector p R)`</span>\n</code></pre></div>",
        "id": 277113273,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1648630676
    },
    {
        "content": "<p>It's also suspicious that <code>field R</code> failure is cached twice (line 165 and 490). Is that normal? <del>Maybe the two <code>field R</code> have different inferred implicit arguments?</del> (<code>field R</code> doesn't have any implicit arguments...)</p>",
        "id": 277141588,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1648645760
    },
    {
        "content": "<p>It's possible that the first failure occurs in a temporary context that doesn't get reused in the second search. This is supposed to ensure that the elaborator making a wrong guess the first time won't cause issues when it tries the correct path.</p>",
        "id": 277142275,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1648646056
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib_docs/find/field\">docs#field</a> doesn't have any other parameters than <code>R</code>, so the only reason I can think of that they differ is that <code>R</code> has a different universe which is defeq. But that's probably not the case.</p>",
        "id": 277142413,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1648646126
    },
    {
        "content": "<p>The issues seem to be there even if we switch everything to <code>Type</code>.</p>",
        "id": 277144781,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1648647235
    },
    {
        "content": "<p>Here's the trace with <code>set_option pp.universes true</code>: <a href=\"https://gist.github.com/alreadydone/01a2048941a3d31088fbfc96be92b76a\">https://gist.github.com/alreadydone/01a2048941a3d31088fbfc96be92b76a</a> Indeed the two <code>field R</code> are <code>field.{?u_61} R</code> and <code>field.{?u_60} R</code> respectively, and <code>u_60</code> also appears in the cached <code>comm_ring.{?u_60} R</code> instance, while <code>u_61</code> seems \"free\".</p>",
        "id": 277149390,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1648649073
    },
    {
        "content": "<p>I'm not sure what the mwe is for this, but I expect this last bit is another instance of \"<code>Type*</code> considered harmful\"</p>",
        "id": 277151406,
        "sender_full_name": "Reid Barton",
        "timestamp": 1648649862
    },
    {
        "content": "<p>Thanks everyone for all the help with this! <br>\nUnfortunately, I still don't understand the issue, but, for now, I removed all <code>Type*</code> and replaced them with explicit universe parameters.<br>\nThis probably won't fix anything considering Kevin's comment above, but it might be worth a shot anyway.</p>\n<p>Unfortunately, I'm quite busy at the moment as it's near the end of our semester right now, so I won't have much time for lean for the next 1-2 weeks.</p>\n<p>BTW, if anyone wants to push to this branch, please feel free!</p>",
        "id": 277212755,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1648680462
    },
    {
        "content": "<p>Looks like explicit universes didn't work either <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 277248322,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1648715492
    },
    {
        "content": "<p>They should at least simplify/clarify the instance trace though.</p>",
        "id": 277273751,
        "sender_full_name": "Reid Barton",
        "timestamp": 1648730402
    },
    {
        "content": "<p>I have extracted the following MWE</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">ring_theory.witt_vector.discrete_valuation_ring</span>\n\n<span class=\"kd\">universe</span> <span class=\"n\">u</span>\n\n<span class=\"kd\">lemma</span> <span class=\"n\">foobar</span> <span class=\"o\">(</span><span class=\"n\">A</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">A</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">is_domain</span> <span class=\"n\">A</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">discrete_valuation_ring</span> <span class=\"n\">A</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n  <span class=\"n\">true</span> <span class=\"o\">:=</span> <span class=\"n\">trivial</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span>\n  <span class=\"o\">[</span><span class=\"n\">is_domain</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)]</span> <span class=\"o\">:</span> <span class=\"n\">true</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"k\">have</span> <span class=\"o\">:=</span> <span class=\"n\">foobar</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">),</span> <span class=\"c1\">-- &lt;-- this causes a timeout.</span>\n  <span class=\"gr\">sorry</span><span class=\"o\">,</span>\n<span class=\"kd\">end</span>\n</code></pre></div>\n<p>In any case, it seems that this is not really related to the <code>dvr -&gt; valuation_ring</code> instance introduced by the PR in question.<br>\nHow should we proceed? I would like to get this PR merged soon as it's blocking some other stuff I have planned.</p>\n<p>Option 1) Make <a href=\"https://leanprover-community.github.io/mathlib_docs/find/witt_vector.discrete_valuation_ring\">docs#witt_vector.discrete_valuation_ring</a> a noninstance<br>\nOption 2) Make <code>valuation_ring.of_discrete_valuation_ring</code> (which is part of this PR) a noninstance<br>\nOption 3) Actually fix the problem (I don't know how to do this).</p>",
        "id": 278021918,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1649251201
    },
    {
        "content": "<p>Ping <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> <span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span></p>",
        "id": 278022130,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1649251306
    },
    {
        "content": "<p>I also extracted the MWE</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"n\">p.prime</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">is_domain</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)]</span> <span class=\"o\">:</span>\n<span class=\"n\">discrete_valuation_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">apply_instance</span>\n</code></pre></div>\n<p>which is roughly the same. The timeout happens during checking the following defeq with a hypothetical <code>field R</code> instance:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"n\">p.prime</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">field</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"bp\">=</span> <span class=\"bp\">@</span><span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">hp</span> <span class=\"n\">field.to_euclidean_domain.to_comm_ring</span> <span class=\"o\">:=</span>\n<span class=\"kd\">by</span> <span class=\"n\">refl</span>\n</code></pre></div>\n<p>The above code however doesn't yield a timeout, though it takes a long time (many seconds) to check, as <code>witt_vector</code> is complicated and not <code>irreducible</code>. This is because <code>field R</code> isn't a metavariable here; during instance inference where <code>field R</code> is metavariable, when Lean unfold down to a field of a structure that actually use the <code>field R</code> instance, it will hit the cache failure, but it doesn't just declare not defeq, but will try to unify further to somehow make up/synthesize the instance, which seems hopeless and bad behavior, and that seems to be what's causing the exponential blowup.</p>",
        "id": 278029402,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649254428
    },
    {
        "content": "<p><a href=\"https://gist.github.com/alreadydone/22805c29bcc5f5e29469004e183ed993#file-instance_is_def_eq_detail-lean-L6637\">As an example</a>, here Lean tries to unify</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">non_unital_non_assoc_semiring.mk</span> <span class=\"n\">R</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">non_unital_non_assoc_ring.add</span> <span class=\"n\">R</span>\n     <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">non_assoc_ring.to_non_unital_non_assoc_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ring.to_non_assoc_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">comm_ring.to_ring</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span><span class=\"o\">))))</span> <span class=\"bp\">...</span>\n</code></pre></div>\n<p>(notice the third line, which will appear again below)<br>\nwith the same thing with <code>_inst_ 1: comm_ring R</code> replaced by</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">comm_ring.to_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain.to_comm_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">field.to_euclidean_domain</span> <span class=\"n\">R</span> <span class=\"bp\">?</span><span class=\"n\">x_159</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>with <code>?x_159 : field R</code>. It proceeds to unify the <code>@non_unital_non_assoc_ring.add</code> field, but hits cached failure for  <code>field R</code>. It doesn't immediately declare unification/defeq failure, but proceeds to</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">27</span><span class=\"o\">]:</span> <span class=\"bp\">@</span><span class=\"n\">non_assoc_ring.to_non_unital_non_assoc_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ring.to_non_assoc_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">comm_ring.to_ring</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span><span class=\"o\">))</span> <span class=\"bp\">=?=</span>\n</code></pre></div>\n<p>leading to exponential blowup.</p>",
        "id": 278031279,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649255208
    },
    {
        "content": "<p>So what's the conclusion? Is this a bug in TC resolution?</p>",
        "id": 278031598,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1649255338
    },
    {
        "content": "<p>I would say it's a bug since I don't see how this behavior could ever be helpful, and I doubt it's used under the hood anywhere in mathlib, but I guess I should ping experts like <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> to determine if there's an easy fix. I think the instances are all reasonable and wouldn't like to be forced to give up one of them. It seems that some caching mechanism for such unifications could avoid the exponential blowup?</p>",
        "id": 278031916,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649255465
    },
    {
        "content": "<p>(continued) In contrast, when <code>field R</code> isn't a metavariable, Lean doesn't try to unify further and direct proceed to unfold the next level:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"n\">unfold</span> <span class=\"n\">left</span><span class=\"bp\">&amp;</span><span class=\"n\">right</span><span class=\"o\">:</span> <span class=\"n\">non_unital_non_assoc_ring.to_non_unital_non_assoc_semiring</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">23</span><span class=\"o\">]:</span> <span class=\"o\">{</span><span class=\"n\">add</span> <span class=\"o\">:=</span> <span class=\"n\">non_unital_non_assoc_ring.add</span> <span class=\"o\">(</span><span class=\"n\">non_assoc_ring.to_non_unital_non_assoc_ring</span> <span class=\"n\">R</span><span class=\"o\">),</span> <span class=\"bp\">...</span><span class=\"o\">}</span> <span class=\"bp\">=?=</span> <span class=\"bp\">...</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">24</span><span class=\"o\">]:</span> <span class=\"n\">non_unital_non_assoc_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">non_unital_non_assoc_ring.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">25</span><span class=\"o\">]:</span> <span class=\"n\">non_assoc_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">non_assoc_ring.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">26</span><span class=\"o\">]:</span> <span class=\"n\">ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">ring.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">27</span><span class=\"o\">]:</span> <span class=\"n\">comm_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">comm_ring.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">28</span><span class=\"o\">]:</span> <span class=\"n\">comm_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">has_add.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">29</span><span class=\"o\">]:</span> <span class=\"n\">comm_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">distrib.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">30</span><span class=\"o\">]:</span> <span class=\"n\">comm_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">ring.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">31</span><span class=\"o\">]:</span> <span class=\"n\">comm_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">division_ring.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">32</span><span class=\"o\">]:</span> <span class=\"n\">comm_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">field.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">33</span><span class=\"o\">]:</span> <span class=\"n\">comm_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">field.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"n\">on</span> <span class=\"n\">failure</span><span class=\"o\">:</span> <span class=\"n\">comm_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">field.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"n\">on</span> <span class=\"n\">failure</span><span class=\"o\">:</span> <span class=\"n\">comm_ring.add</span> <span class=\"bp\">=?=</span> <span class=\"n\">field.add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"n\">on</span> <span class=\"n\">failure</span><span class=\"o\">:</span> <span class=\"o\">{</span><span class=\"n\">add</span> <span class=\"o\">:=</span> <span class=\"n\">non_unital_non_assoc_ring.add</span> <span class=\"o\">(</span><span class=\"n\">non_assoc_ring.to_non_unital_non_assoc_ring</span> <span class=\"n\">R</span><span class=\"o\">),</span> <span class=\"bp\">...</span><span class=\"o\">}</span> <span class=\"bp\">=?=</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"n\">unfold</span> <span class=\"n\">left</span><span class=\"bp\">&amp;</span><span class=\"n\">right</span><span class=\"o\">:</span> <span class=\"n\">non_unital_non_assoc_semiring.to_mul_zero_class</span>\n</code></pre></div>\n<p>More: <a href=\"https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f\">https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f</a></p>",
        "id": 278032195,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649255567
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/278029402\">said</a>:</p>\n<blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"n\">p.prime</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">field</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"bp\">=</span> <span class=\"bp\">@</span><span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">hp</span> <span class=\"n\">field.to_euclidean_domain.to_comm_ring</span> <span class=\"o\">:=</span>\n<span class=\"kd\">by</span> <span class=\"n\">refl</span>\n</code></pre></div>\n<p>The above code however doesn't yield a timeout, though it takes a long time (many seconds) to check, as <code>witt_vector</code> is complicated and not <code>irreducible</code>.</p>\n</blockquote>\n<p>I initially suspected the same, but if we check <a href=\"https://leanprover-community.github.io/mathlib_docs/find/witt_vector\">docs#witt_vector</a>, we see it's already a <code>structure</code>.</p>",
        "id": 278034248,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1649256410
    },
    {
        "content": "<p>So what? It still get unfolded during defeq check as it's not <code>@[irreducible]</code>.</p>",
        "id": 278034619,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649256554
    },
    {
        "content": "<p>By the way,<br>\n<span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/277113273\">said</a>:</p>\n<blockquote>\n<p>What I don't quite understand is the following behaviour:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">discrete_valuation_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">apply_instance</span> <span class=\"c1\">-- Fails quickly because there is no `is_domain (witt_vector p R)` instance in the context</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:=</span>\n<span class=\"n\">valuation_ring.of_discrete_valuation_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"c1\">-- Times out on `discrete_valuation_ring (witt_vector p R)`</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Both fail quickly on my machine.</p>",
        "id": 278034663,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649256576
    },
    {
        "content": "<p>What exactly are you talking about being unfolded?</p>",
        "id": 278034668,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1649256578
    },
    {
        "content": "<p>Here's my full file:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">ring_theory.valuation.valuation_ring</span>\n<span class=\"c1\">--import ring_theory.witt_vector.basic -- import this doesn't yield timeout</span>\n<span class=\"kn\">import</span> <span class=\"n\">ring_theory.witt_vector.discrete_valuation_ring</span> <span class=\"c1\">-- must import this to get timeout</span>\n\n<span class=\"kd\">set_option</span> <span class=\"n\">profiler</span> <span class=\"n\">true</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:=</span>\n<span class=\"n\">valuation_ring.of_discrete_valuation_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">local_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">valuation_ring.local_ring</span> <span class=\"n\">_</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">local_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">apply_instance</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">nontrivial</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">apply_instance</span>\n</code></pre></div>",
        "id": 278034996,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1649256681
    },
    {
        "content": "<p>Conversely, your example fails quickly on my machine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">ring_theory.valuation.valuation_ring</span>\n<span class=\"c1\">--import ring_theory.witt_vector.basic -- import this doesn't yield timeout</span>\n<span class=\"kn\">import</span> <span class=\"n\">ring_theory.witt_vector.discrete_valuation_ring</span> <span class=\"c1\">-- must import this to get timeout</span>\n\n<span class=\"kd\">set_option</span> <span class=\"n\">profiler</span> <span class=\"n\">true</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"n\">p.prime</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">field</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"bp\">=</span> <span class=\"bp\">@</span><span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">hp</span> <span class=\"n\">field.to_euclidean_domain.to_comm_ring</span> <span class=\"o\">:=</span>\n<span class=\"kd\">by</span> <span class=\"n\">refl</span> <span class=\"c1\">-- less than 100 ms</span>\n</code></pre></div>",
        "id": 278035142,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1649256723
    },
    {
        "content": "<p><code>witt_vector</code> gets unfolded like this in <a href=\"https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f\">https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">]:</span> <span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"bp\">=?=</span> <span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span>\n<span class=\"bp\">...</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">]:</span> <span class=\"n\">function.surjective.comm_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector.map_fun</span> <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span><span class=\"o\">))</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"bp\">=?=</span> <span class=\"n\">function.surjective.comm_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector.map_fun</span> <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span><span class=\"o\">))</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span> <span class=\"n\">_</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">]:</span> <span class=\"n\">witt_vector.map_fun</span> <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"bp\">=?=</span> <span class=\"n\">witt_vector.map_fun</span> <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"o\">]:</span> <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"bp\">=?=</span> <span class=\"bp\">â‡‘</span><span class=\"o\">(</span><span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"o\">[</span><span class=\"n\">type_context.is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span> <span class=\"bp\">=?=</span> <span class=\"n\">mv_polynomial.counit</span> <span class=\"n\">R</span>\n<span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 278035248,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649256767
    },
    {
        "content": "<p>Looks like you're seeing the unfulding of the instance <code>witt_vector.comm_ring</code>, not the structure <code>witt_vector</code>.</p>",
        "id": 278035472,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1649256846
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/278035142\">said</a>:</p>\n<blockquote>\n<p>Conversely, your example fails quickly on my machine:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">ring_theory.valuation.valuation_ring</span>\n<span class=\"c1\">--import ring_theory.witt_vector.basic -- import this doesn't yield timeout</span>\n<span class=\"kn\">import</span> <span class=\"n\">ring_theory.witt_vector.discrete_valuation_ring</span> <span class=\"c1\">-- must import this to get timeout</span>\n\n<span class=\"kd\">set_option</span> <span class=\"n\">profiler</span> <span class=\"n\">true</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"n\">p.prime</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">field</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"bp\">=</span> <span class=\"bp\">@</span><span class=\"n\">witt_vector.comm_ring</span> <span class=\"n\">p</span> <span class=\"n\">R</span> <span class=\"n\">hp</span> <span class=\"n\">field.to_euclidean_domain.to_comm_ring</span> <span class=\"o\">:=</span>\n<span class=\"kd\">by</span> <span class=\"n\">refl</span> <span class=\"c1\">-- less than 100 ms</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Yes, I said it doesn't yield a timeout:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">The</span> <span class=\"n\">above</span> <span class=\"n\">code</span> <span class=\"n\">however</span> <span class=\"n\">doesn't</span> <span class=\"n\">yield</span> <span class=\"n\">a</span> <span class=\"n\">timeout</span><span class=\"o\">,</span> <span class=\"n\">though</span> <span class=\"n\">it</span> <span class=\"n\">takes</span> <span class=\"n\">a</span> <span class=\"n\">long</span> <span class=\"n\">time</span> <span class=\"o\">(</span><span class=\"n\">many</span> <span class=\"n\">seconds</span><span class=\"o\">)</span> <span class=\"n\">to</span> <span class=\"n\">check</span><span class=\"o\">,</span> <span class=\"n\">as</span> <span class=\"n\">witt_vector</span> <span class=\"n\">is</span> <span class=\"n\">complicated</span> <span class=\"n\">and</span> <span class=\"n\">not</span> <span class=\"n\">irreducible.</span>\n</code></pre></div>",
        "id": 278035529,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649256867
    },
    {
        "content": "<p>Line 65 of your gist says which definition is being unfolded: <code>[type_context.is_def_eq_detail] unfold left&amp;right: witt_vector.comm_ring</code></p>",
        "id": 278035620,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1649256904
    },
    {
        "content": "<p>Oh yes, that's my confusion. So making <code>witt_vector</code> irreducible won't help, making <code>witt_vector.comm_ring</code> irreducible might?</p>",
        "id": 278035684,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649256934
    },
    {
        "content": "<p>Unfortunately, it will have to be somewhat reducible so that <a href=\"https://leanprover-community.github.io/mathlib_docs/find/witt_vector.has_zero\">docs#witt_vector.has_zero</a> can unify with <code>comm_ring.to_has_zero witt_vector.comm_ring</code></p>",
        "id": 278035974,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1649257044
    },
    {
        "content": "<p>I don't think making typeclasses irreducible is a good idea at all (it's important for different paths to the same instance to be defeq, and irreducibility blocks that)</p>",
        "id": 278036194,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1649257116
    },
    {
        "content": "<p>Elsewhere we've just made the value of the <code>add</code> field (and the others) irreducible</p>",
        "id": 278036236,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1649257134
    },
    {
        "content": "<p>But I get the feeling that might not fix the problem here</p>",
        "id": 278036320,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1649257164
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">Yes</span><span class=\"o\">,</span> <span class=\"n\">I</span> <span class=\"n\">said</span> <span class=\"n\">it</span> <span class=\"n\">doesn't</span> <span class=\"n\">yield</span> <span class=\"n\">a</span> <span class=\"n\">timeout</span><span class=\"o\">:</span>\n</code></pre></div>\n<p>Oh, I see you're saying it takes 100ms on your machine but several seconds on mine.</p>",
        "id": 278036382,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649257184
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/278036382\">said</a>:</p>\n<blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">Yes</span><span class=\"o\">,</span> <span class=\"n\">I</span> <span class=\"n\">said</span> <span class=\"n\">it</span> <span class=\"n\">doesn't</span> <span class=\"n\">yield</span> <span class=\"n\">a</span> <span class=\"n\">timeout</span><span class=\"o\">:</span>\n</code></pre></div>\n<p>Oh, I see you're saying it takes 100ms on your machine but several seconds on mine.</p>\n</blockquote>\n<p>Perhaps you are running it with a lot of trace options on? That has slowed down elaboration dramatically for me before.</p>",
        "id": 278036657,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1649257253
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:</span>\n<span class=\"n\">local_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">valuation_ring.local_ring</span> <span class=\"n\">_</span>\n</code></pre></div>\n<p>yields a timeout but</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">R</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">hp</span> <span class=\"o\">:</span> <span class=\"n\">fact</span> <span class=\"o\">(</span><span class=\"n\">nat.prime</span> <span class=\"n\">p</span><span class=\"o\">)]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">R</span><span class=\"o\">]</span> <span class=\"o\">:=</span>\n<span class=\"n\">valuation_ring.of_discrete_valuation_ring</span> <span class=\"o\">(</span><span class=\"n\">witt_vector</span> <span class=\"n\">p</span> <span class=\"n\">R</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>still does not.</p>",
        "id": 278036745,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649257283
    },
    {
        "content": "<p>Yes probably, it takes several seconds to produce the trace <a href=\"https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f\">https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f</a> , not just checking the defeq.</p>",
        "id": 278037034,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649257369
    },
    {
        "content": "<p>Just the two options though</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span> <span class=\"n\">trace.class_instances</span> <span class=\"n\">true</span>\n<span class=\"kd\">set_option</span> <span class=\"n\">trace.type_context.is_def_eq_detail</span> <span class=\"n\">true</span>\n</code></pre></div>",
        "id": 278037130,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649257408
    },
    {
        "content": "<p>I also observed the slowdown:<br>\nAdding <code>set_option trace.type_context.is_def_eq_detail true</code> slow down Lean by a lot: without defeq detail, Lean outputs 75,312 lines with 74,828 lines of <code>[class_instances] cached failure for field R</code> before timeout; with defeq detail, the output has 36,117 lines with merely 411 lines of <code>field R</code> cache failures. If I increase the time limit to 10x, the output has 228,871 lines with 2676 lines of <code>field R</code> cache failures.</p>",
        "id": 278037293,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649257470
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/278036236\">said</a>:</p>\n<blockquote>\n<p>Elsewhere we've just made the value of the <code>add</code> field (and the others) irreducible</p>\n</blockquote>\n<p>The equivalent here would be to make <code>witt_vector.map_fun</code> irreducible, which unfortunately doesn't seem to help here.</p>",
        "id": 278038416,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1649257877
    },
    {
        "content": "<p>(<a href=\"https://leanprover-community.github.io/mathlib_docs/find/witt_vector.map_fun\">docs#witt_vector.map_fun</a>)</p>",
        "id": 278045138,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1649260442
    },
    {
        "content": "<p>I'm not convinced, all the typeclass stuff happens in its argument</p>",
        "id": 278045243,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1649260493
    },
    {
        "content": "<p>I've produced a truly minimal example exhibiting 2^n exponential blowup: </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span> <span class=\"n\">trace.class_instances</span> <span class=\"n\">true</span>\n<span class=\"kd\">set_option</span> <span class=\"n\">trace.type_context.is_def_eq_detail</span> <span class=\"n\">true</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">cls11</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u11</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls10</span> <span class=\"kd\">extends</span> <span class=\"n\">cls11</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u10</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls9</span> <span class=\"kd\">extends</span> <span class=\"n\">cls10</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u9</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls8</span> <span class=\"kd\">extends</span> <span class=\"n\">cls9</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u8</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls7</span> <span class=\"kd\">extends</span> <span class=\"n\">cls8</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u7</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls6</span> <span class=\"kd\">extends</span> <span class=\"n\">cls7</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u6</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls5</span> <span class=\"kd\">extends</span> <span class=\"n\">cls6</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u5</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls4</span> <span class=\"kd\">extends</span> <span class=\"n\">cls5</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u4</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls3</span> <span class=\"kd\">extends</span> <span class=\"n\">cls4</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u3</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls2</span> <span class=\"kd\">extends</span> <span class=\"n\">cls3</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u2</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls1</span> <span class=\"kd\">extends</span> <span class=\"n\">cls2</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u1</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls0</span> <span class=\"kd\">extends</span> <span class=\"n\">cls1</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u0</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n\n<span class=\"kd\">variable</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">)</span>\n<span class=\"kn\">include</span> <span class=\"n\">n</span>\n<span class=\"kd\">class</span> <span class=\"n\">comm_ring</span> <span class=\"kd\">extends</span> <span class=\"n\">cls0</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">ucr</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">field</span> <span class=\"kd\">extends</span> <span class=\"n\">comm_ring</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">uf</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">dvr</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">n</span><span class=\"o\">]</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">udvr</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">[</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">comm_ring</span> <span class=\"n\">n</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">comm_ring</span> <span class=\"n\">n.succ</span> <span class=\"o\">:=</span> <span class=\"o\">{</span> <span class=\"n\">ucr</span> <span class=\"o\">:=</span> <span class=\"n\">c.u11</span> <span class=\"o\">}</span>\n<span class=\"kd\">instance</span> <span class=\"o\">[</span><span class=\"n\">field</span> <span class=\"n\">n</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">dvr</span> <span class=\"n\">n.succ</span> <span class=\"o\">:=</span> <span class=\"o\">âŸ¨()âŸ©</span>\n<span class=\"k\">#print</span> <span class=\"n\">nat.succ.comm_ring</span>\n<span class=\"kn\">omit</span> <span class=\"n\">n</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"mi\">0</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">dvr</span> <span class=\"mi\">1</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">apply_instance</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> ucr := c.u11 : 67416 lines -/</span>\n<span class=\"c\">/-</span><span class=\"cm\"> ... -/</span>\n<span class=\"c\">/-</span><span class=\"cm\"> ucr := c.u5 : 1062 lines, diff = 524 -/</span>\n<span class=\"c\">/-</span><span class=\"cm\"> ucr := c.u4 : 538 lines, diff = 264 -/</span>\n<span class=\"c\">/-</span><span class=\"cm\"> ucr := c.u3 : 274 lines, diff = 130 -/</span>\n<span class=\"c\">/-</span><span class=\"cm\"> ucr := c.u2 : 144 lines, diff = 64 -/</span>\n<span class=\"c\">/-</span><span class=\"cm\"> ucr := c.u1 : 80 lines, diff = 32 -/</span>\n<span class=\"c\">/-</span><span class=\"cm\"> ucr := c.u0 : 48 lines, diff = 16 -/</span>\n<span class=\"c\">/-</span><span class=\"cm\"> ucr := c.ucr : 32 lines -/</span>\n</code></pre></div>\n<p>Here <code>instance [c : comm_ring n] : comm_ring n.succ</code> is the analogue of <code>witt_vector.comm_ring</code> (which is more complicated and possibly leads to faster blowup), and <code>instance [field n] : dvr n.succ</code> is the analogue of <code>witt_vector.discrete_valuation_ring</code>. The cls0, cls1, cls2, ... hierarchy is the analogue of the algebraic hierarchy, showing up in the trace like</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">has_zero.mk</span> <span class=\"n\">R</span>\n  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mul_zero_class.zero</span> <span class=\"n\">R</span>\n     <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">non_unital_non_assoc_semiring.to_mul_zero_class</span> <span class=\"n\">R</span>\n        <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">non_unital_non_assoc_ring.to_non_unital_non_assoc_semiring</span> <span class=\"n\">R</span>\n           <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">non_assoc_ring.to_non_unital_non_assoc_ring</span> <span class=\"n\">R</span>\n              <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ring.to_non_assoc_ring</span> <span class=\"n\">R</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">comm_ring.to_ring</span> <span class=\"n\">R</span> <span class=\"n\">_inst_1</span><span class=\"o\">))))))</span>\n</code></pre></div>",
        "id": 278445918,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649562094
    },
    {
        "content": "<p>Can someone reproduce this in Lean 4?</p>",
        "id": 278446041,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649562355
    },
    {
        "content": "<p>Indeed changing <code>ucr</code> to something more complicated like <code>ucr := if c.u11 then c.u10 else c.u9</code> (with <code>u11 : unit</code> changed to <code>u11 : bool</code>) generates 9x larger output.</p>",
        "id": 278446405,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649563027
    },
    {
        "content": "<p>It appears that the exponential blowup is caused by certain defeq/unification problems being solved exponentially many times, so a caching mechanism would likely help. We just want find a way to fail quickly in this case to safisfy the linter. <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Are you interested in looking into this? Should I open an issue at the Lean3 repo?</p>",
        "id": 278446904,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649563777
    },
    {
        "content": "<p>there are several known exponential blowup issues in lean 3 typeclass inference, this is one of the major motivations for the rewrite in lean 4 (<a href=\"https://arxiv.org/abs/2001.04301\">https://arxiv.org/abs/2001.04301</a>) and I don't expect things to get fundamentally better in lean 3</p>",
        "id": 278458413,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1649583321
    },
    {
        "content": "<p>Here's the lean 4 version</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span> <span class=\"n\">trace.Meta.synthInstance</span> <span class=\"n\">true</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">cls11</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u11</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls10</span> <span class=\"kd\">extends</span> <span class=\"n\">cls11</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u10</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls9</span> <span class=\"kd\">extends</span> <span class=\"n\">cls10</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u9</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls8</span> <span class=\"kd\">extends</span> <span class=\"n\">cls9</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u8</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls7</span> <span class=\"kd\">extends</span> <span class=\"n\">cls8</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u7</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls6</span> <span class=\"kd\">extends</span> <span class=\"n\">cls7</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u6</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls5</span> <span class=\"kd\">extends</span> <span class=\"n\">cls6</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u5</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls4</span> <span class=\"kd\">extends</span> <span class=\"n\">cls5</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u4</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls3</span> <span class=\"kd\">extends</span> <span class=\"n\">cls4</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u3</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls2</span> <span class=\"kd\">extends</span> <span class=\"n\">cls3</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u2</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls1</span> <span class=\"kd\">extends</span> <span class=\"n\">cls2</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u1</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">cls0</span> <span class=\"kd\">extends</span> <span class=\"n\">cls1</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u0</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n\n<span class=\"kd\">variable</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">CommRing</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"kd\">extends</span> <span class=\"n\">cls0</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">ucr</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">Field</span> <span class=\"kd\">extends</span> <span class=\"n\">CommRing</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">uf</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">DVR</span> <span class=\"o\">[</span><span class=\"n\">CommRing</span> <span class=\"n\">n</span><span class=\"o\">]</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">udvr</span> <span class=\"o\">:</span> <span class=\"n\">Unit</span><span class=\"o\">)</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">[</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">CommRing</span> <span class=\"n\">n</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">CommRing</span> <span class=\"n\">n.succ</span> <span class=\"o\">:=</span> <span class=\"o\">{</span> <span class=\"n\">ucr</span> <span class=\"o\">:=</span> <span class=\"n\">c.u11</span> <span class=\"o\">}</span>\n<span class=\"kd\">instance</span> <span class=\"o\">[</span><span class=\"n\">Field</span> <span class=\"n\">n</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">DVR</span> <span class=\"n\">n.succ</span> <span class=\"o\">:=</span> <span class=\"o\">âŸ¨()âŸ©</span>\n<span class=\"k\">#print</span> <span class=\"n\">instCommRingSucc</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">[</span><span class=\"n\">CommRing</span> <span class=\"mi\">0</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">DVR</span> <span class=\"mi\">1</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">infer_instance</span>\n</code></pre></div>\n<p>The last line fails, but it seems like it is supposed to from the test?</p>",
        "id": 278459373,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1649584746
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Thanks for pointing to the paper. Yes it's supposed to fail as there's no hope to synthesize the <code>field 0</code> instance (especially if you replace <code>uf : unit</code> by <code>uf : empty</code>), so we'd like it to fail quickly, but Lean3 keeps trying to unify, as if it might come up with the instance somehow.<br>\nDo you see the expoential blowup from the trace in Lean4? For example, replace <code>ucr := c.u11</code> by <code>ucr := c.u10</code> and check whether the output shrink to 1/2. I should probably set up Lean4 on my machine sometime ... or is there a web editor?<br>\nIf Lean4 doesn't have the exponential blowup, maybe we should find a workaround for the current PR, instead of backporting to Lean3 (which would be too hard)?</p>",
        "id": 278467790,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649596731
    },
    {
        "content": "<p>it's almost instant so I don't think the issue manifests</p>",
        "id": 278467800,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1649596771
    },
    {
        "content": "<p>Okay, so what should I do about <a href=\"https://github.com/leanprover-community/mathlib/pull/12719\">#12719</a> ? (I'll make a poll)</p>",
        "id": 278468127,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1649597252
    },
    {
        "content": "<p>/poll What should we do about <a href=\"https://github.com/leanprover-community/mathlib/pull/12719\">#12719</a><br>\nMake DVR -&gt; valuation ring a noninstance.<br>\nMake the discrete valuation ring instance on Witt vectors a noninstance.</p>",
        "id": 278468202,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1649597369
    },
    {
        "content": "<p>In any case, I would add a <code>TODO</code> comment saying that the instance could be added back after the port to Lean4</p>",
        "id": 278468256,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1649597415
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/278467800\">said</a>:</p>\n<blockquote>\n<p>it's almost instant so I don't think the issue manifests</p>\n</blockquote>\n<p>Actually in Lean3 I also need <code>ucr := c.u20</code> to get (deterministic) timeout without tracing options, and for <code>c.u11</code> it's also almost instant. So it would be nice if someone can confirm there's no exponential blowup in Lean4. (The max depth is 53 in the case of <a href=\"https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f\">witt_vector.comm_ring</a> even though there seems to be no <code>extends</code> chain as long as 20; the max depth is only 17 in the <code>c.u11</code> MWE.)</p>\n<p>(<a href=\"https://gist.github.com/alreadydone/1b52f7ea9edf00b7a1fb83f90efd8a33\">Lean3 MWE with <code>c.u20</code></a>)</p>",
        "id": 278470842,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649600561
    },
    {
        "content": "<p>Wow, I find that adding an <code>id</code> before <code>c.u11</code> has the effect of making the trace 4x as large, but adding two <code>id</code>s only makes it 8x as large. So we may replace the <code>extends</code> chain by <code>id $ id $ ...</code>.</p>",
        "id": 278476507,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649607823
    },
    {
        "content": "<p>Now we just need three typeclasses and three instances (one from <code>extends</code>) to produce the exponential blowup!</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span> <span class=\"n\">comm_ring</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">ucr</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n<span class=\"kd\">variable</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">â„•</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">field</span> <span class=\"kd\">extends</span> <span class=\"n\">comm_ring</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">empty</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span> <span class=\"n\">dvr</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">n</span><span class=\"o\">]</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">u</span> <span class=\"o\">:</span> <span class=\"n\">unit</span><span class=\"o\">)</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">[</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">comm_ring</span> <span class=\"n\">n</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">comm_ring</span> <span class=\"n\">n.succ</span> <span class=\"o\">:=</span> <span class=\"o\">âŸ¨</span><span class=\"n\">id</span><span class=\"bp\">^</span><span class=\"o\">[</span><span class=\"mi\">19</span><span class=\"o\">]</span> <span class=\"n\">c.ucr</span><span class=\"o\">âŸ©</span>\n<span class=\"kd\">instance</span> <span class=\"o\">[</span><span class=\"n\">field</span> <span class=\"n\">n</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">dvr</span> <span class=\"n\">n.succ</span> <span class=\"o\">:=</span> <span class=\"o\">âŸ¨()âŸ©</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"mi\">0</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">dvr</span> <span class=\"mi\">1</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">apply_instance</span>\n</code></pre></div>",
        "id": 278477059,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649608439
    },
    {
        "content": "<p>(In lean 4) Using a deep hierarchy on its own does not make it take very long, but using <code>c.u20</code> it hits the timeout. Using <code>Nat.repeat id 19 c.ucr</code> as in your last example still works fine</p>",
        "id": 278478115,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1649609713
    },
    {
        "content": "<p>Thanks for testing! I wonder how long the current longest <code>extends</code> chain in mathlib is? If it's ~10 then maybe we need not worry about Lean4 according to your test.</p>",
        "id": 278478327,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649609995
    },
    {
        "content": "<p>reported as <a href=\"https://github.com/leanprover/lean4/pull/1102\">lean4#1102</a></p>",
        "id": 278478569,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1649610235
    },
    {
        "content": "<p>Maybe not just <code>extends</code> chains, but also arbitrary instance chain; e.g. <a href=\"https://leanprover-community.github.io/mathlib_docs/find/ring.to_non_assoc_ring/src\">src#ring.to_non_assoc_ring</a> isn't from <code>extends</code> in the witt_vector example.</p>",
        "id": 278478651,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649610327
    },
    {
        "content": "<p>You said in the issue that the example is a bit artificial, and I'd agree in the sense that the linter is a bit artificial, since it works by dropping assumptions from mathlib instances and checking they fail quickly. In <a href=\"https://github.com/leanprover-community/mathlib/runs/5855466421?check_suite_focus=true\">the instance that triggered the whole discusssion</a>, the <code>[nontrivial R]</code> assumption is dropped, while in practice maybe you'd never try to synthesize that instance when <code>[nontrivial R]</code> is not in the context?</p>",
        "id": 278479215,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1649611017
    }
]