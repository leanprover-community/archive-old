[
    {
        "content": "<p>Dear All,</p>\n<p>I just created the latest iteration of the refactoring of the <code>ordered</code> hierarchy (PR <a href=\"https://github.com/leanprover-community/mathlib/issues/7574\">#7574</a>).  While there is still room for weakening of assumptions, I believe that the current level already shows a good balance between flexibility and usability.</p>\n<p>Of course, any comments are welcome!  I plan to weaken further assumptions on <code>ordered</code> classes, but have decided that this is a good point for really attempting at getting this PR merged.</p>\n<p>As mentioned, this is the third iteration.  The previous ones are <a href=\"https://github.com/leanprover-community/mathlib/issues/7371\">#7371</a> and <a href=\"https://github.com/leanprover-community/mathlib/issues/7396\">#7396</a>.  I plan to close those PRs soon, since all that I have learned from them and from the comments is implemented in the current one.</p>",
        "id": 238261826,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620717225
    },
    {
        "content": "<p>The main guiding principle is that \"technical\" lemmas are proven with separate assumptions:</p>\n<ul>\n<li>an assumption on what properties the operation has (the operation is currently add or mul);</li>\n<li>an assumption on what kind of order there is (e.g. <code>preorder</code>, <code>partial_order</code>, <code>linear_order</code>,...);</li>\n<li>a mix of the two in the form of some kind of monotonicity is assumed (these follow a general pattern of <code>covariant</code> and <code>contravariant</code> definitions that are part of this PR).</li>\n</ul>",
        "id": 238262107,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620717378
    },
    {
        "content": "<p>On top of those technical lemmas, there are more \"standard\" lemmas that only assume a single typeclass, such as <code>linear_ordered_comm_group_with_zero</code>, that fixes all three parameters \"in the background\".</p>",
        "id": 238262212,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620717452
    },
    {
        "content": "<p>Dear All,</p>\n<p>it seems that this PR is breaking something structural and I do not know what to do.  CI came with this error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">Error</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">runner</span><span class=\"bp\">/</span><span class=\"n\">work</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/</span><span class=\"n\">test</span><span class=\"bp\">/</span><span class=\"n\">norm_num.lean</span><span class=\"o\">:</span><span class=\"mi\">49</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span>\n<span class=\"n\">type</span> <span class=\"n\">mismatch</span> <span class=\"n\">at</span> <span class=\"n\">application</span>\n  <span class=\"bp\">@</span><span class=\"n\">add_group.to_sub_neg_monoid</span> <span class=\"n\">ℤ</span> <span class=\"n\">_</span>\n<span class=\"n\">term</span>\n  <span class=\"bp\">@</span><span class=\"n\">norm_num.lt_one_bit0</span> <span class=\"n\">ℤ</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">linear_ordered_comm_ring.to_linear_ordered_semiring</span> <span class=\"n\">ℤ</span> <span class=\"n\">int.linear_ordered_comm_ring</span><span class=\"o\">)</span> <span class=\"mi\">1</span>\n    <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">le_refl</span> <span class=\"n\">ℤ</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">directed_order.to_preorder</span> <span class=\"n\">ℤ</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">linear_order.to_directed_order</span> <span class=\"n\">ℤ</span> <span class=\"n\">int.linear_order</span><span class=\"o\">))</span> <span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"n\">has</span> <span class=\"n\">type</span>\n  <span class=\"mi\">1</span> <span class=\"bp\">&lt;</span> <span class=\"mi\">2</span>\n<span class=\"n\">but</span> <span class=\"n\">is</span> <span class=\"n\">expected</span> <span class=\"n\">to</span> <span class=\"k\">have</span> <span class=\"n\">type</span>\n  <span class=\"n\">add_group</span> <span class=\"n\">ℤ</span>\n<span class=\"n\">Error</span><span class=\"o\">:</span> <span class=\"n\">Process</span> <span class=\"n\">completed</span> <span class=\"k\">with</span> <span class=\"n\">exit</span> <span class=\"n\">code</span> <span class=\"mi\">1</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 238305826,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620739367
    },
    {
        "content": "<p>In previous runs, I had noticed that <code>norm_num</code> caused some funny behaviour and I replaced <code>norm_num</code> proofs with actual explicit proofs and that solved the issue.  But now, it seems that Lean really wants to get to the bottom of this and I do not know what I did to break this...</p>",
        "id": 238305964,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620739421
    },
    {
        "content": "<p>I am really at a loss: what should I do, now that tests are failing?  <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>\n<p>Direct link to error:</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib/pull/7574/checks?check_run_id=2555528374\">https://github.com/leanprover-community/mathlib/pull/7574/checks?check_run_id=2555528374</a></p>",
        "id": 238306071,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620739456
    },
    {
        "content": "<p>Did you change the parameters to <code>neg_lt_neg</code>? From my understanding of <code>norm_num</code>, it looks like the error occurs <a href=\"https://github.com/leanprover-community/mathlib/blob/master/src/tactic/norm_num.lean#L480\">here</a>. I suspect <code>norm_num</code> should be updated to handle the changed parameters.</p>",
        "id": 238308580,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1620740384
    },
    {
        "content": "<p>I did not change <code>neg_lt_neg</code>, certainly not intentionally, and, I think, also not unintentionally...</p>",
        "id": 238309194,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620740579
    },
    {
        "content": "<p>Also, which parameters are those?  I introduced more typeclasses, but I did not do funny things with the old ones...</p>",
        "id": 238309254,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620740611
    },
    {
        "content": "<p>Anne, looking at the link that you gave, I had to fix a broken proof in a <code>match</code> environment.  I had never used that, but now you make me wonder that this might be the issue?</p>",
        "id": 238309491,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620740688
    },
    {
        "content": "<p>I meant the new typeclass parameters that you introduced, so yes, <code>neg_lt_neg</code> does have different parameters now :)</p>",
        "id": 238309787,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1620740795
    },
    {
        "content": "<p>What's going on is that this call to <code>ic.mk_app</code> fills in only one typeclass parameter, which used to work when it was just <code>[ordered_add_group α]</code>. But now it's <code>[add_group α] [preorder α] [has_add_lt_add_left α] [has_add_lt_add_right α]</code></p>",
        "id": 238309987,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1620740882
    },
    {
        "content": "<p>I am trying to understand, but I am failing.  Though, maybe I am starting!  This should come from a <code>inv_lt_inv</code>, via <code>to_additive</code>, right?</p>",
        "id": 238310019,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620740884
    },
    {
        "content": "<p>Ok, I am getting there, slowly!</p>",
        "id": 238310100,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620740917
    },
    {
        "content": "<p>Yes, and a bit higher up you have the <code>variables [has_mul_lt_mul_left α] [has_mul_lt_mul_right α]</code> line, which adds these parameters to all the theorems below</p>",
        "id": 238310127,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1620740932
    },
    {
        "content": "<p>so, should I simply go to the test file and make it work, as I would a normal file?</p>",
        "id": 238310139,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620740939
    },
    {
        "content": "<p>(this is probably a silly question, but in my mind, tests were \"outside my reach\"!)</p>",
        "id": 238310228,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620740973
    },
    {
        "content": "<p>Not really: the test file tells us when there's something broken inside <code>norm_num</code>, so we'll have to fix the tactic.</p>",
        "id": 238310278,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1620740987
    },
    {
        "content": "<p>Ah, ok.  So, I will give a try to fixing norm_num...</p>",
        "id": 238310372,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741008
    },
    {
        "content": "<p>(although this seems like something that will require someone else's help!)</p>",
        "id": 238310434,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741026
    },
    {
        "content": "<p>I think <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> wrote most of this code</p>",
        "id": 238310522,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1620741058
    },
    {
        "content": "<p>Summary of my diagnosis for Mario: <code>instance_cache.mk_app</code> only fills in one typeclass parameter, but now the theorems used by <code>norm_num</code> require multiple typeclass parameters. What is the best way to fix this?</p>",
        "id": 238310868,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1620741183
    },
    {
        "content": "<p>is there a mwe?</p>",
        "id": 238310903,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741196
    },
    {
        "content": "<p>I would prefer for there to be only one typeclass for efficiency reasons. Can the necessary typeclasses be bundled into one composite?</p>",
        "id": 238311039,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741244
    },
    {
        "content": "<p>Mario, I can dig out one of the fixes where I removed a norm_num, if you want.</p>",
        "id": 238311055,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741253
    },
    {
        "content": "<p>Is this what you are asking?  I am really unsure about much of this conversation...</p>",
        "id": 238311126,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741277
    },
    {
        "content": "<p>Did you modify the norm_num lemmas?</p>",
        "id": 238311128,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741278
    },
    {
        "content": "<p>I do not think that I did... I only worked \"inside\" mathlib...</p>",
        "id": 238311167,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741297
    },
    {
        "content": "<p>There are a number of lemmas called by <code>norm_num</code> that got changed, but nothing inside the <code>tactic/norm_num.lean</code> file AFAICT</p>",
        "id": 238311284,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1620741343
    },
    {
        "content": "<p>there are a couple regular lemmas that norm_num uses too</p>",
        "id": 238311316,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741363
    },
    {
        "content": "<p>which of them changed and how?</p>",
        "id": 238311372,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741370
    },
    {
        "content": "<p>Ok, so, I found an example of a proof that I changed so that it would not use norm_num: this one</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib/pull/7574/commits/48b19fffacde0f99e0498b38b25a42fc7e08c318\">https://github.com/leanprover-community/mathlib/pull/7574/commits/48b19fffacde0f99e0498b38b25a42fc7e08c318</a></p>",
        "id": 238311547,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741450
    },
    {
        "content": "<p>I do not remember going into <code>tactic</code>.</p>",
        "id": 238311703,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741498
    },
    {
        "content": "<p>No, I mean regular theorems that changed their signature</p>",
        "id": 238311798,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741531
    },
    {
        "content": "<p>the tactic is using a lemma like <code>neg_le_neg</code> and expecting that it has a particular signature</p>",
        "id": 238311866,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741553
    },
    {
        "content": "<p>A signature is the statement of the theorem?</p>\n<p>I am finding some lemmas tagged with <code>norm_cast</code> whose assumptions I revised</p>",
        "id": 238311989,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741593
    },
    {
        "content": "<p>yes</p>",
        "id": 238312014,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741601
    },
    {
        "content": "<p>(mostly their typeclasses, I think)</p>",
        "id": 238312033,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741603
    },
    {
        "content": "<p>typeclass changes count</p>",
        "id": 238312099,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741615
    },
    {
        "content": "<p>Ok, so some statements that are tagged <code>norm_cast</code> have been changed due to this, certainly.</p>",
        "id": 238312120,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741623
    },
    {
        "content": "<p>norm_cast is not relevant to norm_num</p>",
        "id": 238312128,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741627
    },
    {
        "content": "<p>the relevant lemmas are not tagged or anything, they are referred to by name in <code>tactic/norm_num</code></p>",
        "id": 238312234,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620741651
    },
    {
        "content": "<p>I am failing to find <code>norm_num</code> tags, but they might be there: I simply did not pay attention to those, I simply left the tags alone.</p>",
        "id": 238312244,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741654
    },
    {
        "content": "<p>ah, ok, so let me find out the list and which ones have been changed!</p>",
        "id": 238312315,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741673
    },
    {
        "content": "<p>(likely quite a few, since the changes happen at the very early lemmas on inequalities...)</p>",
        "id": 238312356,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741691
    },
    {
        "content": "<p>sorry for the long stream of questions, but I have never looked carefully at any tactic.  I extracted this from <code>tactic/norm_num</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"sd\">/-- Given `a` a rational numeral, returns `⊢ 1 ≤ a`. -/</span>\n<span class=\"kd\">meta</span> <span class=\"kd\">def</span> <span class=\"n\">prove_nonneg</span> <span class=\"o\">(</span><span class=\"n\">ic</span> <span class=\"o\">:</span> <span class=\"n\">instance_cache</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">tactic</span> <span class=\"o\">(</span><span class=\"n\">instance_cache</span> <span class=\"bp\">×</span> <span class=\"n\">expr</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span> <span class=\"n\">e</span><span class=\"bp\">@`</span><span class=\"o\">(</span><span class=\"n\">has_zero.zero</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">ic.mk_app</span> <span class=\"bp\">``</span><span class=\"n\">le_refl</span> <span class=\"o\">[</span><span class=\"n\">e</span><span class=\"o\">]</span>\n<span class=\"bp\">|</span> <span class=\"n\">e</span> <span class=\"o\">:=</span>\n  <span class=\"k\">if</span> <span class=\"n\">ic.α</span> <span class=\"bp\">=</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span> <span class=\"k\">then</span>\n    <span class=\"n\">return</span> <span class=\"o\">(</span><span class=\"n\">ic</span><span class=\"o\">,</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">nat.zero_le</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mk_app</span> <span class=\"o\">[</span><span class=\"n\">e</span><span class=\"o\">])</span>\n  <span class=\"k\">else</span> <span class=\"k\">do</span>\n    <span class=\"o\">(</span><span class=\"n\">ic</span><span class=\"o\">,</span> <span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"bp\">←</span> <span class=\"n\">prove_pos</span> <span class=\"n\">ic</span> <span class=\"n\">e</span><span class=\"o\">,</span>\n    <span class=\"n\">ic.mk_app</span> <span class=\"bp\">``</span><span class=\"n\">nonneg_pos</span> <span class=\"o\">[</span><span class=\"n\">e</span><span class=\"o\">,</span> <span class=\"n\">p</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I interpret the last line as saying that <code>nonneg_pos</code> is implied.  Is this what I should be looking out for?<br>\n<del>I am almost certain that I have changed the assumptions on <code>nonneg_pos</code>.</del>  Ok, I did not touch this, there was a lemma with a similar, but different, name.</p>",
        "id": 238313218,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620741961
    },
    {
        "content": "<p><code>has_zero.zero</code>, <code>zero_mul</code>, <code>mul_zero</code>, <code>mul_one</code>, <code>one_mul</code>, <code>bit0_pos</code>, <code>bit1_pos'</code>, <code>div_pos</code>, <code>nat.zero_le</code>, <code>neg_lt_neg</code>, <code>neg_neg_of_pos</code>, <code>neg_le_neg</code>, <code>neg_nonpos_of_nonneg</code>, <code>ne_of_lt</code>, <code>ne_of_gt</code>, <code>rat.cast_zero</code>, <code>rat.cast_one</code>, <code>has_div.div</code>, <code>has_neg.neg</code>, <code>has_one.one</code>, <code>neg_neg</code>, <code>neg_zero</code>, <code>sub_zero</code>, <code>pow_zero</code>, <code>pow_one</code>, <code>lt_irrefl</code>, <code>not_lt_of_gt</code>, <code>le_refl</code>, <code>not_le_of_gt</code>, <code>has_lt.lt</code>, <code>has_le.le</code></p>",
        "id": 238314137,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742295
    },
    {
        "content": "<p>The last line means \"given the instance cache  <code>ic</code> and proof <code>p</code> that we've fetched using <code>prove_pos</code>, construct the proof that <code>nonneg_pos</code> implies, using the expression <code>e</code> that we are carrying around\"</p>",
        "id": 238314142,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1620742298
    },
    {
        "content": "<p>those are the lemmas used by norm_num that are not in the norm_num file</p>",
        "id": 238314185,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742315
    },
    {
        "content": "<p>any changes to them could break norm_num</p>",
        "id": 238314242,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742327
    },
    {
        "content": "<p>Ok, I have just found an example: <code>neg_neg_of_pos</code> has changed.</p>",
        "id": 238314249,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620742333
    },
    {
        "content": "<p>can you make your change the primed version?</p>",
        "id": 238314285,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742350
    },
    {
        "content": "<p>At the moment, I replaced the lemmas with the weaker assumptions.  I can duplicate all lemmas, if this is what is preferred.</p>",
        "id": 238314411,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620742393
    },
    {
        "content": "<p>then again, this is also possibly evidence that tactics like norm_num should make local aliases of all lemmas they intend to use</p>",
        "id": 238314458,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742414
    },
    {
        "content": "<p>what is the change?</p>",
        "id": 238314562,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742445
    },
    {
        "content": "<p>I can certainly use primes, however, my intention was to weaken the assumption of existing lemmas, not adding further lemmas whose assumptions are weaker and then prove the earlier lemmas as applications of the weaker ones...</p>",
        "id": 238314613,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620742464
    },
    {
        "content": "<p>If there are more typeclasses then it is a potential performance issue</p>",
        "id": 238314678,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742492
    },
    {
        "content": "<p>If I am correct, the new lemmas have a subset of the assumptions, but they are bundled differently.</p>",
        "id": 238314694,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620742499
    },
    {
        "content": "<p>It will be a lot more work to have to prove that in a given context this type is both an add_left thing and and add_right thing</p>",
        "id": 238314797,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742536
    },
    {
        "content": "<p>I don't know what you've actually changed though so I'm making things up</p>",
        "id": 238314853,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742555
    },
    {
        "content": "<p>if you want, I can be more specific about the changes.</p>",
        "id": 238314923,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620742571
    },
    {
        "content": "<p>could you <code>#print neg_neg_of_pos</code></p>",
        "id": 238314952,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742583
    },
    {
        "content": "<p>before and after</p>",
        "id": 238314970,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742589
    },
    {
        "content": "<p>actually here's the before</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">theorem</span> <span class=\"n\">neg_neg_of_pos</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">_inst_1</span> <span class=\"o\">:</span> <span class=\"n\">ordered_add_comm_group</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">},</span> <span class=\"mi\">0</span> <span class=\"bp\">&lt;</span> <span class=\"n\">a</span> <span class=\"bp\">→</span> <span class=\"bp\">-</span><span class=\"n\">a</span> <span class=\"bp\">&lt;</span> <span class=\"mi\">0</span> <span class=\"o\">:=</span>\n</code></pre></div>",
        "id": 238315023,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742614
    },
    {
        "content": "<p>This is the after:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">theorem</span> <span class=\"n\">neg_neg_of_pos</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">_inst_1</span> <span class=\"o\">:</span> <span class=\"n\">add_group</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">_inst_2</span> <span class=\"o\">:</span> <span class=\"n\">preorder</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">_inst_3</span> <span class=\"o\">:</span> <span class=\"n\">has_add_lt_add_left</span> <span class=\"n\">α</span><span class=\"o\">],</span>\n  <span class=\"mi\">0</span> <span class=\"bp\">&lt;</span> <span class=\"n\">a</span> <span class=\"bp\">→</span> <span class=\"bp\">-</span><span class=\"n\">a</span> <span class=\"bp\">&lt;</span> <span class=\"mi\">0</span> <span class=\"o\">:=</span>\n</code></pre></div>",
        "id": 238315319,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620742722
    },
    {
        "content": "<p>The new typeclasses are subsets of the old ones and they do not cover all the old ones, just pick out some of them.</p>",
        "id": 238315402,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620742760
    },
    {
        "content": "<p>(for instance, <code>ordered_add_comm_group</code> contains <code>add_comm</code> which is not implied by any of the later ones.)</p>",
        "id": 238315743,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620742898
    },
    {
        "content": "<p>True, but does it matter?</p>",
        "id": 238315780,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742914
    },
    {
        "content": "<p>I do not know that it matters: I have changed some proofs, but the \"mathematical formula\" should be the same...</p>",
        "id": 238315910,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620742952
    },
    {
        "content": "<p>I mean using all the axioms piecemeal like this is much more expensive than having everything bundled into one typeclass</p>",
        "id": 238316006,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620742997
    },
    {
        "content": "<p>you have to run every typeclass search three times</p>",
        "id": 238316068,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620743016
    },
    {
        "content": "<p>and in case you were not aware typeclass search is one of the biggest performance issues in mathlib</p>",
        "id": 238316149,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620743044
    },
    {
        "content": "<p>Ah, for instance, this allows to have lemmas on ordered stuff without having them commutative, for instance.  This is something that is useful, and not done at the moment in lean.</p>",
        "id": 238316216,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743062
    },
    {
        "content": "<p>Since typeclasses are cached I don't know whether it makes a real difference in terms of performance?</p>",
        "id": 238316246,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1620743078
    },
    {
        "content": "<p>they are cached until they have to be searched again</p>",
        "id": 238316291,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620743094
    },
    {
        "content": "<p>Ok, I have no idea of what the expensive things are in mathlib, so I certainly defer to you to the performance of these changes!</p>",
        "id": 238316320,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743102
    },
    {
        "content": "<p>the cache doesn't last that long</p>",
        "id": 238316329,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620743105
    },
    {
        "content": "<p>The cache lasts for a whole proof, no?</p>",
        "id": 238316363,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1620743117
    },
    {
        "content": "<p>okay, mathlib has many proofs</p>",
        "id": 238316391,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620743125
    },
    {
        "content": "<p>also <code>haveI</code> clears the cache</p>",
        "id": 238316424,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620743139
    },
    {
        "content": "<p>Ok, so I can certainly argue that mathematically there is value in picking your own assumptions on commutativity/left/right/ orders.  Whether this is implementable in Lean in a performing way, I do not know...</p>",
        "id": 238316510,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743164
    },
    {
        "content": "<p>Sure, but most proofs don't have <code>haveI</code>. I am not claiming it's not creating a performance problem, I'm just saying it's not obvious to me if it really does.</p>",
        "id": 238316584,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1620743188
    },
    {
        "content": "<p>What I would like to know is what the motivation is, besides reverse mathematics</p>",
        "id": 238316586,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620743188
    },
    {
        "content": "<p>yes you can just take the absolute minimal assumptions for everything but specifying minimal assumptions is a lot more complicated than using generic classes</p>",
        "id": 238316685,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620743228
    },
    {
        "content": "<p>Left/right/bi/ordered groups are fairly studied, especially in the geometric group theory community, for instance.</p>",
        "id": 238316728,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743246
    },
    {
        "content": "<p>If it is only used by a small subcommunity then that would be a good candidate for a primed lemma</p>",
        "id": 238316911,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620743305
    },
    {
        "content": "<p>Just for my understanding, a small number of typeclass assumptions (even with many fields) is better than many typeclasses assumptions (with fewer combined fields)?</p>",
        "id": 238316949,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743319
    },
    {
        "content": "<p>yes, although defeq of different paths to the same typeclass is also expensive</p>",
        "id": 238317059,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620743362
    },
    {
        "content": "<p>Damiano, what was the original reason you embarked on this refactor? Was there some actual mathematics which was inconvenient to do in Lean as it is right now?</p>",
        "id": 238317081,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620743369
    },
    {
        "content": "<p>At the moment, it was informed by the possibility of applying these lemmas with not necessarily commutative rings, but I had not started doing anything with it.</p>\n<p>Also, note that I do not mind using primes for the lemmas that Mario mentioned above.  I am trying to understand a bit of how lean works, so that in the future I may not be taking similar wrong paths!</p>",
        "id": 238317398,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743488
    },
    {
        "content": "<p>So can you give an explicit example of a statement involving noncommutative rings which is not possible to do right now in Lean?</p>",
        "id": 238317595,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620743557
    },
    {
        "content": "<p>Specifically, I had been trying to prove a lemma for the nnreals, but the needed lemmas were not accessible, so I decided to make them work!</p>",
        "id": 238317606,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743563
    },
    {
        "content": "<p>But nnreal is commutative?</p>",
        "id": 238317641,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620743580
    },
    {
        "content": "<p>I'm only following this at a distance but I wouldn't call this a \"wrong path\". At worst this sort of effort is exactly how we learn what works best etc.</p>",
        "id": 238317674,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1620743586
    },
    {
        "content": "<p>With time, I can find an example in nnreal, but for non-commutative, anything involving orders is out of the question.</p>",
        "id": 238317734,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743601
    },
    {
        "content": "<p>can you be more precise?</p>",
        "id": 238317813,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620743633
    },
    {
        "content": "<p>I mean, write down a mathematical statement which is somehow problematic in Lean?</p>",
        "id": 238317879,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620743645
    },
    {
        "content": "<p>Here is a reference that was shown to me when I brought this up earlier:<br>\n<a href=\"https://hal.archives-ouvertes.fr/hal-02872310/document\">https://hal.archives-ouvertes.fr/hal-02872310/document</a></p>",
        "id": 238317886,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743647
    },
    {
        "content": "<p>Notice that these results are provable in Lean, and this is why I had started this refactor! <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 238317986,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743684
    },
    {
        "content": "<p>Can you name a precise result rather than just linking to a paper? I'm still trying to understand what the exact problem is.</p>",
        "id": 238318056,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620743710
    },
    {
        "content": "<p>At the moment, there is no typeclass expressing the fact that a non-commutative group has an order and multiplication is left-monotone.  So giving this example is tricky.</p>",
        "id": 238318258,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743770
    },
    {
        "content": "<p>Would Proposition 2.2 of the link work as an example?</p>",
        "id": 238318311,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743792
    },
    {
        "content": "<p>I can certainly formulate the statement without using typeclasses, though.</p>",
        "id": 238318386,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743825
    },
    {
        "content": "<p>So the issue is that for some reason you cannot make the relevant typeclass? I still don't understand</p>",
        "id": 238318444,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620743851
    },
    {
        "content": "<p>just like you can always explicitly copy the fields in as assumptions.  I would not consider this a good solution, though.</p>",
        "id": 238318450,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743854
    },
    {
        "content": "<p>To prove these results, I would like to use lemmas like if you multiply by the inverse on the left an inequality, the inequality still holds.  This lemma has the same proof as the one with the commutativity assumption, but would have to be reproven to work without assuming commutativity.</p>",
        "id": 238318657,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743918
    },
    {
        "content": "<p>So yes, I would like to use the order API that already exists, but remove unused assumptions, so that it applies to noncommutative groups (or even commutative groups with zero, which is tricky at the moment, even in the presence of a linear order).</p>",
        "id": 238318818,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620743976
    },
    {
        "content": "<p>so the proposal is to make a bunch of new typeclasses, but to keep the old typeclasses?</p>",
        "id": 238318939,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620744015
    },
    {
        "content": "<p>I had initially proposed introducing only two typeclasses are removing <em>all</em> <code>ordered_...</code> ones.  However, I have been told that this was not the way to go, but introducing more typeclasses was better.</p>",
        "id": 238319080,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620744064
    },
    {
        "content": "<p>If so, you can just not mess with Mario's lemmas like <code>neg_neg_of_pos</code>, and make your own versions but called <code>neg_neg_of_pos'</code> with your more general assumptions.</p>",
        "id": 238319130,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620744080
    },
    {
        "content": "<p>I can get all the flexibility needed introducing only 2 typeclasses, and removing everything that has an <code>order_</code> in.  The cost is that I would need to use more typeclasses simultaneously.  At the moment, the largest number of typeclass assumptions that I have seen is 5.</p>",
        "id": 238319307,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620744135
    },
    {
        "content": "<p>and then the tests will start working again</p>",
        "id": 238319310,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1620744135
    },
    {
        "content": "<p>Sure, this is certainly something that I can and intend to do!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> </p>\n<p>I was simply trying to get more into the mechanics of this, to understand what was going on!</p>",
        "id": 238319419,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620744179
    },
    {
        "content": "<p>Anyway, I think that I understand better why the test broke, what the issue is and that it can be fixed easily by simply changing a name!</p>\n<p>At the beginning of this thread, I did not know that this was the case, so I am much happier now!</p>",
        "id": 238319702,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620744273
    },
    {
        "content": "<p>If there is still some interest left in this conversation, these are the lemmas that appear to use the new typeclasses and that I will now replace with primed versions:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">neg_lt_neg</span>\n<span class=\"n\">neg_neg_of_pos</span>\n<span class=\"n\">neg_le_neg</span>\n<span class=\"n\">neg_nonpos_of_nonneg</span>\n</code></pre></div>",
        "id": 238322124,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620745182
    },
    {
        "content": "<p>As an update, the current commit was successfully built by CI!</p>",
        "id": 238423714,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620797805
    },
    {
        "content": "<p>Dear All,</p>\n<p>Jannis kindly timed the two proposed ordered refactors against the same version of master from which they branched.  The results are here:</p>\n<ul>\n<li>\n<p><code>master</code>:<br>\na7e1696f5b1bd29f1575d99162e9f80141b28e4c: 2h15m49s/2h16m15s</p>\n</li>\n<li>\n<p>refactor with 16 new typeclasses:<br>\n88d6a72d98b13d5bcae1a4560260cae17f60d309: 2h17m16s/2h16m3s</p>\n</li>\n<li>\n<p>refactor with two new typeclasses:<br>\n03b502c386905abef9892d59d09c36220c04a0da: 2h12m28s</p>\n</li>\n</ul>\n<p>(this is a link to the actual conversation:<br>\n<a href=\"#narrow/stream/113488-general/topic/performance.20of.20ordered.20refactor/near/238609226\">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance.20of.20ordered.20refactor/near/238609226</a>)</p>\n<p>The results seem to show that, marginally, the refactor with two new typeclasses performs better than <code>master</code>.  Thus, I would like to go on with that one.</p>\n<p>Is there any reason not to?  Anything else that I might have overlooked?</p>\n<p>In the long run, I could even see that the <code>ordered_</code> typeclasses might disappear (at least some of them), giving way to simply mixing assumptions as needed.  This would not be part of the current refactor anyway.</p>",
        "id": 238616747,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620910400
    },
    {
        "content": "<p>For ease of reference, these are the two refactors:</p>\n<ul>\n<li>PR <a href=\"https://github.com/leanprover-community/mathlib/issues/7371\">#7371</a> - the \"fast\" one, with two new typeclasses</li>\n<li>PR <a href=\"https://github.com/leanprover-community/mathlib/issues/7574\">#7574</a> - the \"slow\" one, with 16 new typeclasses</li>\n</ul>",
        "id": 238617987,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620911128
    },
    {
        "content": "<p>Wow, so the timing is not at all what we expected. <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> what do you think? Should we reconsider mixins in other places as well?</p>",
        "id": 238624992,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1620914539
    },
    {
        "content": "<p>I am not sure how relevant my opinion is, but using the two typeclasses felt \"right\"...</p>",
        "id": 238625941,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620914978
    },
    {
        "content": "<p>This is evidence that this particular refactor isn't going to impact things too much, but I haven't looked at exactly how much of mathlib was directly affected by the change, so I wouldn't draw general conclusions from this noisy data.</p>",
        "id": 238625942,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620914980
    },
    {
        "content": "<p>I'm fine with the two typeclasses version; what was done about the norm num lemmas?</p>",
        "id": 238626033,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1620915011
    },
    {
        "content": "<p>Mario, you are right (of course, just stating the obvious!).  I have not implemented the change very extensively, but I am more willing to try it now.</p>",
        "id": 238626081,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620915036
    },
    {
        "content": "<p>Actually, the norm_num lemmas were not affected by the 2 typeclass change.  In the other refactor, I simply added primes to the versions of the lemmas with different assumptions and that was that.</p>",
        "id": 238626173,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620915081
    },
    {
        "content": "<p>Also, I will do the same in the 2 typeclass refactor, I just did not get around to that stage of the change yet.</p>",
        "id": 238626339,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620915152
    },
    {
        "content": "<p>Before I continue with extending the refactor, I will wait for the current \"winning\" PR <a href=\"https://github.com/leanprover-community/mathlib/issues/7371\">#7371</a> to be accepted.  It is already fairly extensive, though mostly for moving lemmas from one file to another.</p>\n<p>I also changed its status to <code>awaiting-review</code>.</p>",
        "id": 238626495,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1620915239
    }
]