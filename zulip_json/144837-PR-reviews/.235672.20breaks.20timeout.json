[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib/issues/5672\">#5672</a> doesn't build, not because of the files that it modifies, but because then it times out in a completely unrelated file (<code>times_cont_mdiff.lean</code> in the manifold part). Indeed, the theorem <a href=\"https://leanprover-community.github.io/mathlib_docs/find/times_cont_mdiff_on.times_cont_mdiff_on_tangent_map_within\">docs#times_cont_mdiff_on.times_cont_mdiff_on_tangent_map_within</a> takes, on my computer, 27s on master and 30s with the PR.</p>\n<p>I tried to understand a little bit what is going on. It turns out that, in the proofs of this file, every call to <code>simp</code> tries to show that everything is a subsingleton. I mean, for instance, if I replace the proof of a lemma with <code>simp only</code> like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">lemma</span> <span class=\"n\">times_cont_diff_within_at_local_invariant_prop_mono</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">with_top</span> <span class=\"n\">‚Ñï</span><span class=\"o\">)</span>\n  <span class=\"o\">‚¶É</span><span class=\"n\">s</span> <span class=\"n\">x</span> <span class=\"n\">t</span><span class=\"o\">‚¶Ñ</span> <span class=\"o\">‚¶É</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">H</span> <span class=\"bp\">‚Üí</span> <span class=\"n\">H'</span><span class=\"o\">‚¶Ñ</span> <span class=\"o\">(</span><span class=\"n\">hts</span> <span class=\"o\">:</span> <span class=\"n\">t</span> <span class=\"bp\">‚äÜ</span> <span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">times_cont_diff_within_at_prop</span> <span class=\"n\">I</span> <span class=\"n\">I'</span> <span class=\"n\">n</span> <span class=\"n\">f</span> <span class=\"n\">s</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n  <span class=\"n\">times_cont_diff_within_at_prop</span> <span class=\"n\">I</span> <span class=\"n\">I'</span> <span class=\"n\">n</span> <span class=\"n\">f</span> <span class=\"n\">t</span> <span class=\"n\">x</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">simp</span> <span class=\"n\">only</span><span class=\"o\">,</span>\n<span class=\"kd\">end</span>\n</code></pre></div>\n<p>then the trace instance of the <code>simp only</code> starts with</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span>  <span class=\"kd\">class</span><span class=\"bp\">-</span><span class=\"kd\">instance</span> <span class=\"n\">resolution</span> <span class=\"n\">trace</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u_1</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">category_theory.is_iso.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_1</span> <span class=\"bp\">?</span><span class=\"n\">x_2</span> <span class=\"bp\">?</span><span class=\"n\">x_3</span> <span class=\"bp\">?</span><span class=\"n\">x_4</span> <span class=\"bp\">?</span><span class=\"n\">x_5</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n</code></pre></div>\n<p>Then, after a long time checking that it can not prove that <code>Type u_1</code> is a subsingleton, it tries to prove <code>subsingleton (nondiscrete_normed_field ùïú)</code> (and fails again). Then <code>subsingleton (Type u_2)</code>. And so on, on every object that shows up in the statement. And the output stops with <code>message too long, truncated at 262144 characters</code>. So, I am not surprised that <a href=\"https://github.com/leanprover-community/mathlib/issues/5672\">#5672</a>, that introduces a new way to check that something is a subsingleton, increases the compile time. Of course, <a href=\"https://github.com/leanprover-community/mathlib/issues/5672\">#5672</a> is not at fault, but I don't understand what is going on here.</p>",
        "id": 223001979,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610826225
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110050\">@Sebastien Gouezel</span> aah, in the PR there was also a timeout with <code>witt_vector</code>, see the PR page.</p>",
        "id": 223002393,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1610826821
    },
    {
        "content": "<p>The issue there was that I was using <code>convert</code> and probably it was now looking for some <code>subsingleton</code> instance and spending a lot of time on that. So I changed it to <code>convert ... using 1</code> and the problem was gone.</p>",
        "id": 223002444,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1610826866
    },
    {
        "content": "<p>But, with <code>simp</code> the solution is maybe not so easy...</p>",
        "id": 223002458,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1610826925
    },
    {
        "content": "<p>In fact <code>simp</code> does that in all the files. This seems crazy. I don't think it has always been like that. <span class=\"user-mention\" data-user-id=\"110043\">@Gabriel Ebner</span> , is there a recent change to Lean that might have changed the simp behavior?</p>",
        "id": 223002463,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610826942
    },
    {
        "content": "<p>I think it's always done that. I remember a long time ago tracking some horrible <code>simp</code> behavior in category theory to some bad <code>subsingleton</code> lemmas</p>",
        "id": 223003065,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1610827797
    },
    {
        "content": "<p>I have wondered if <a href=\"https://leanprover-community.github.io/mathlib_docs/find/eq_iff_true_of_subsingleton\">docs#eq_iff_true_of_subsingleton</a> is a bad simp lemma, but it doesn't seem to be the culprit here</p>",
        "id": 223003127,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1610827831
    },
    {
        "content": "<p>Indeed, I have tried to go back a little bit in time, and I always see this behavior. Is there a good reason for this? It looks like a major performance problem to me.</p>",
        "id": 223004186,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610828625
    },
    {
        "content": "<p>As a data point, <a href=\"https://leanprover-community.github.io/mathlib_docs/find/times_cont_mdiff_on.times_cont_mdiff_on_tangent_map_within\">docs#times_cont_mdiff_on.times_cont_mdiff_on_tangent_map_within</a> takes 27s to compile on my computer. If I add <code>local attribute [-instance]</code> to all subsingleton instances, it drops to 5s. Given this, I think we should either fix simp, or disable all the subsingleton instances and only activate them locally where needed. Thoughts?</p>",
        "id": 223005082,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610829770
    },
    {
        "content": "<p>wow, that's a pretty impressive speedup</p>",
        "id": 223006591,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1610831547
    },
    {
        "content": "<p>Just adding <code>local attribute [-instance] unique.subsingleton pi.subsingleton</code> is enough to go from 27s to 9s. I'm wondering if I should add these to <code>open_locale manifold</code> for now, as the manifold code is very <code>simp</code>-heavy, while waiting for a more proper fix.</p>",
        "id": 223006768,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610831715
    },
    {
        "content": "<p>If you add those to the manifold files, what is the speed gain for that part of the library?</p>",
        "id": 223006961,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1610831987
    },
    {
        "content": "<p>sounds like you might shave off several minutes</p>",
        "id": 223007008,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1610832015
    },
    {
        "content": "<p>That's likely. Fixing simp over the whole library should even be much more substantial.</p>",
        "id": 223007111,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610832153
    },
    {
        "content": "<p>I'm taking this PR off the queue again... another batch failed just now</p>",
        "id": 223007908,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1610833198
    },
    {
        "content": "<p>I'm confused how it ended back on the queue, since it was already canceled.</p>",
        "id": 223007975,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1610833300
    },
    {
        "content": "<p>I don't understand what bors is doing. Normally, it should have been cancelled when I merged master.</p>",
        "id": 223007983,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610833315
    },
    {
        "content": "<p>You don't understand bors, you just get used to it...</p>",
        "id": 223008043,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1610833368
    },
    {
        "content": "<p>Well, I opened an issue <a href=\"https://github.com/bors-ng/bors-ng/issues/1130\">https://github.com/bors-ng/bors-ng/issues/1130</a></p>",
        "id": 223008178,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1610833565
    },
    {
        "content": "<p><code>hack(manifold): ...</code> --- should we update the style guide to include hacks?</p>",
        "id": 223008310,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1610833779
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib/issues/5779\">#5779</a>. I'd be curious to know how much it shaves off the compile time.</p>",
        "id": 223008311,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610833782
    },
    {
        "content": "<p>I couldn't find a better name :-)</p>",
        "id": 223008315,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610833797
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110050\">Sebastien Gouezel</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.235672.20breaks.20timeout/near/223007111\">said</a>:</p>\n<blockquote>\n<p>That's likely. Fixing simp over the whole library should even be much more substantial.</p>\n</blockquote>\n<p>In principle failures to infer <code>subsingleton</code> should be cached, and there seems to be something pathological in these examples. I have no sense of what kind of effect a change here would have on the whole library, either in terms of breakage or speedup.</p>",
        "id": 223034339,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1610876105
    },
    {
        "content": "<p>Yes they are cached. But when there are many types around it takes apparently a lot of time to check that all of them are not subsingletons. I would understand if <code>simp</code> tried to see if there is a subsingleton when it sees an equality <code>x = y</code> and wants to discharge it. But the problem is that it does check for subsingletons even when there is no equality to be discharged, before trying anything else.</p>",
        "id": 223034447,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610876324
    },
    {
        "content": "<p><code>simp</code> uses <code>congr</code> to traverse terms, and <code>congr</code> checks all of the function's arguments for subsingleton to see if that subterm equality proof can be elided</p>",
        "id": 223034551,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1610876517
    },
    {
        "content": "<p>Can you say a little bit more about that? Is it something like <code>simp</code>sees <code>f a b : alpha</code>, and down the road it simplifies <code>a</code>to <code>a'</code>, so it will reduce <code>f a b</code> to <code>f a ' b</code> and build a proof of the reduction. But if <code>alpha</code> were a subsingleton then the reduction would be for free, so it would use that instead as a shortcut?</p>",
        "id": 223034778,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610876912
    },
    {
        "content": "<p>If simp sees <code>f a b</code>, before it traverses into the subterms, it first needs a congr theorem to apply. So it asks <code>congr</code> to build a congr lemma for <code>f</code>, that is, a theorem of the form <code>x = x' -&gt; y = y' -&gt; f x y = f x' y'</code>, and while doing so congr will try to see if it can discharge one of the <code>x = x'</code> and <code>y = y'</code> theorems using <code>subsingleton.elim</code>. Let's say it's successful in discharging <code>y = y'</code>; then it will return to simp the theorem <code>x = x' -&gt; f x y = f x' y'</code>, and then simp will simplify <code>a</code> to <code>a'</code> and return <code>f a' b</code></p>",
        "id": 223034911,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1610877128
    },
    {
        "content": "<p>I'm not sure if it tries to simplify <code>b</code> as well under these circumstances, I think it just ignores it</p>",
        "id": 223034917,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1610877179
    },
    {
        "content": "<p>Just for the record of what we are talking about. Given the lemma</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span> <span class=\"n\">trace.class_instances</span> <span class=\"n\">true</span>\n\n<span class=\"kd\">lemma</span> <span class=\"n\">zou</span> <span class=\"o\">(</span><span class=\"n\">Œ±</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">Œ±</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">x</span> <span class=\"bp\">=</span> <span class=\"n\">y</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">simp</span> <span class=\"n\">only</span><span class=\"o\">,</span>\n<span class=\"kd\">end</span>\n</code></pre></div>\n<p>the instance trace that shows up when clicking on the <code>simp</code> is</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span>  <span class=\"kd\">class</span><span class=\"bp\">-</span><span class=\"kd\">instance</span> <span class=\"n\">resolution</span> <span class=\"n\">trace</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">order_dual.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_1</span> <span class=\"bp\">?</span><span class=\"n\">x_2</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">unique.subsingleton_unique</span> <span class=\"bp\">?</span><span class=\"n\">x_3</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">trunc.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_4</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">subsingleton_pempty</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">subsingleton.prod</span> <span class=\"bp\">?</span><span class=\"n\">x_5</span> <span class=\"bp\">?</span><span class=\"n\">x_6</span> <span class=\"bp\">?</span><span class=\"n\">x_7</span> <span class=\"bp\">?</span><span class=\"n\">x_8</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">empty.subsingleton</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">punit.subsingleton</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">pi.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_9</span> <span class=\"bp\">?</span><span class=\"n\">x_10</span> <span class=\"bp\">?</span><span class=\"n\">x_11</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">decidable.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_12</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">subsingleton_prop</span> <span class=\"bp\">?</span><span class=\"n\">x_13</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">unique.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_14</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">set.unique_singleton</span> <span class=\"bp\">?</span><span class=\"n\">x_16</span> <span class=\"bp\">?</span><span class=\"n\">x_17</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">pi.unique</span> <span class=\"bp\">?</span><span class=\"n\">x_18</span> <span class=\"bp\">?</span><span class=\"n\">x_19</span> <span class=\"bp\">?</span><span class=\"n\">x_20</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">fin.unique</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">punit.unique</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">unique</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">subsingleton</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span>  <span class=\"kd\">class</span><span class=\"bp\">-</span><span class=\"kd\">instance</span> <span class=\"n\">resolution</span> <span class=\"n\">trace</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">order_dual.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_1</span> <span class=\"bp\">?</span><span class=\"n\">x_2</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">unique.subsingleton_unique</span> <span class=\"bp\">?</span><span class=\"n\">x_3</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">trunc.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_4</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">subsingleton_pempty</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">subsingleton.prod</span> <span class=\"bp\">?</span><span class=\"n\">x_5</span> <span class=\"bp\">?</span><span class=\"n\">x_6</span> <span class=\"bp\">?</span><span class=\"n\">x_7</span> <span class=\"bp\">?</span><span class=\"n\">x_8</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">empty.subsingleton</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">punit.subsingleton</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">pi.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_9</span> <span class=\"bp\">?</span><span class=\"n\">x_10</span> <span class=\"bp\">?</span><span class=\"n\">x_11</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">decidable.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_12</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">subsingleton_prop</span> <span class=\"bp\">?</span><span class=\"n\">x_13</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">unique.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_14</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">set.unique_singleton</span> <span class=\"bp\">?</span><span class=\"n\">x_16</span> <span class=\"bp\">?</span><span class=\"n\">x_17</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">pi.unique</span> <span class=\"bp\">?</span><span class=\"n\">x_18</span> <span class=\"bp\">?</span><span class=\"n\">x_19</span> <span class=\"bp\">?</span><span class=\"n\">x_20</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">fin.unique</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">punit.unique</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">unique</span> <span class=\"n\">Œ±</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span>  <span class=\"kd\">class</span><span class=\"bp\">-</span><span class=\"kd\">instance</span> <span class=\"n\">resolution</span> <span class=\"n\">trace</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">order_dual.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_1</span> <span class=\"bp\">?</span><span class=\"n\">x_2</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">unique.subsingleton_unique</span> <span class=\"bp\">?</span><span class=\"n\">x_3</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">trunc.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_4</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">subsingleton_pempty</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">subsingleton.prod</span> <span class=\"bp\">?</span><span class=\"n\">x_5</span> <span class=\"bp\">?</span><span class=\"n\">x_6</span> <span class=\"bp\">?</span><span class=\"n\">x_7</span> <span class=\"bp\">?</span><span class=\"n\">x_8</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">empty.subsingleton</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">punit.subsingleton</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">pi.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_9</span> <span class=\"bp\">?</span><span class=\"n\">x_10</span> <span class=\"bp\">?</span><span class=\"n\">x_11</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">decidable.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_12</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">subsingleton_prop</span> <span class=\"bp\">?</span><span class=\"n\">x_13</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_0</span> <span class=\"o\">:</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">unique.subsingleton</span> <span class=\"bp\">?</span><span class=\"n\">x_14</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">set.unique_singleton</span> <span class=\"bp\">?</span><span class=\"n\">x_16</span> <span class=\"bp\">?</span><span class=\"n\">x_17</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">pi.unique</span> <span class=\"bp\">?</span><span class=\"n\">x_18</span> <span class=\"bp\">?</span><span class=\"n\">x_19</span> <span class=\"bp\">?</span><span class=\"n\">x_20</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">fin.unique</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"bp\">?</span><span class=\"n\">x_15</span> <span class=\"o\">:</span> <span class=\"n\">unique</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"n\">punit.unique</span>\n<span class=\"n\">failed</span> <span class=\"n\">is_def_eq</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">unique</span> <span class=\"n\">Œ±</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span>\n<span class=\"o\">[</span><span class=\"n\">class_instances</span><span class=\"o\">]</span> <span class=\"n\">caching</span> <span class=\"n\">failure</span> <span class=\"n\">for</span> <span class=\"n\">subsingleton</span> <span class=\"n\">Œ±</span>\n</code></pre></div>\n<p>(Not sure that the cache is working optimally here, by the way)</p>",
        "id": 223034983,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610877328
    },
    {
        "content": "<p>My guess is that this is happening during the construction of a congr lemma for <code>eq</code></p>",
        "id": 223035160,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1610877622
    },
    {
        "content": "<p>Do you think there would be a way to disable this for <code>congr</code> when it is called from <code>simp</code> (or maybe just use cached subsingleton instances, but don't look for new ones -- and cache once and for all beforehand the fact that Prop is a subsingleton, this one is definitely relevant)? Since most types aren't subsingletons, this seems like a waste of time.</p>",
        "id": 223035318,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1610877847
    },
    {
        "content": "<p>Here's an example of using the congr lemma generator directly (if you trace instances you will see the same subsingleton searches come up)</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">open</span> <span class=\"n\">tactic</span>\n<span class=\"kd\">lemma</span> <span class=\"n\">zou</span> <span class=\"o\">(</span><span class=\"n\">Œ±</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">Œ±</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">x</span> <span class=\"bp\">=</span> <span class=\"n\">y</span> <span class=\"o\">:=</span>\n<span class=\"kd\">by</span> <span class=\"k\">do</span>\n  <span class=\"n\">t</span> <span class=\"bp\">‚Üê</span> <span class=\"n\">target</span><span class=\"o\">,</span>\n  <span class=\"n\">lem</span> <span class=\"bp\">‚Üê</span> <span class=\"n\">mk_specialized_congr_lemma_simp</span> <span class=\"n\">t</span><span class=\"o\">,</span>\n  <span class=\"n\">trace</span> <span class=\"n\">lem.type</span>\n</code></pre></div>",
        "id": 223035399,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1610877990
    },
    {
        "content": "<p>This trick has always struck me as a waste of time. I think it should be a default-disabled simp option</p>",
        "id": 223035426,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1610878061
    },
    {
        "content": "<p>it's certainly occasionally useful, for example when you want to get out of a pickle involving a diamond that doesn't definitionally commute, but it's not something that is worth checking all the time</p>",
        "id": 223035502,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1610878150
    },
    {
        "content": "<p>I just did a nonscientific test with the <code>simp_nf</code> linter. Adding <code>local attribute [-instance] unique.subsingleton pi.subsingleton</code> before running it shaved off 16% of the runtime.</p>",
        "id": 223232442,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1611066133
    },
    {
        "content": "<p>So this seems like a pretty significant performance hit in general, one that's worth taking a look at.</p>",
        "id": 223232576,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1611066208
    },
    {
        "content": "<p>Playing a little bit more with this -- a proof in <a href=\"https://github.com/leanprover-community/mathlib/issues/5878\">#5878</a> takes 30s on my computer, adding <code>local attribute [-instance] unique.subsingleton pi.subsingleton</code> makes it twice as fast. I noticed that there is a caching issue: all <code>simp</code> calls in the proof try to show that the same types are not subsingletons, again and again and again. Mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">analysis.specific_limits</span>\n\n<span class=\"kd\">set_option</span> <span class=\"n\">trace.class_instances</span> <span class=\"n\">true</span>\n\n<span class=\"kd\">lemma</span> <span class=\"n\">foo</span> <span class=\"o\">(</span><span class=\"n\">Œ±</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"n\">z</span> <span class=\"n\">t</span> <span class=\"o\">:</span> <span class=\"n\">Œ±</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hx</span> <span class=\"o\">:</span> <span class=\"n\">x</span> <span class=\"bp\">=</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">hy</span> <span class=\"o\">:</span> <span class=\"n\">y</span> <span class=\"bp\">=</span> <span class=\"n\">y</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">z</span> <span class=\"bp\">=</span> <span class=\"n\">t</span> <span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n  <span class=\"n\">simp</span> <span class=\"n\">at</span> <span class=\"n\">hx</span><span class=\"o\">,</span>\n  <span class=\"n\">simp</span> <span class=\"n\">at</span> <span class=\"n\">hy</span><span class=\"o\">,</span>\n  <span class=\"gr\">sorry</span>\n<span class=\"kd\">end</span>\n</code></pre></div>\n<p>Both <code>simp</code> calls try to show that <code>Type u_1</code> is a subsingleton, and that <code>Œ±</code> is a subsingleton. I.e., the instance search for the first call is not cached for the second one. <span class=\"user-mention\" data-user-id=\"110043\">@Gabriel Ebner</span> , is it something to be expected? (Btw, it also tries to show that <code>Œ±</code> is an <code>add_comm_monoid</code>, for some reason I don't get -- this is not cached either from one simp call to the next)</p>",
        "id": 224042101,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1611669655
    },
    {
        "content": "<p>It's not expected.  Type class caching should work across tactics.  But I don't have time to debug this at the moment.</p>",
        "id": 224050187,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1611672998
    },
    {
        "content": "<p>It's definitely very low priority since Lean 4 is coming.</p>",
        "id": 224052678,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1611674014
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110050\">@Sebastien Gouezel</span> should we just add a bunch of these instances to locales? Even if Lean 4 is around the corner, I don't mind shaving several multiples of 10 minutes from the total compile time.</p>",
        "id": 224053328,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1611674273
    },
    {
        "content": "<p>The thing is that these instances are sometimes useful. To craft  <a href=\"https://github.com/leanprover-community/mathlib/tree/singleton_instances\">branch#singleton_instances</a>, I had to fix all the breakage coming from disabling just <code>unique.subsingleton</code>, and there were many of them.  And in the end it's really just a hack, which might trip some people since it makes <code>simp</code> or <code>congr</code> effectively less powerful.</p>",
        "id": 224053762,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1611674441
    },
    {
        "content": "<p>So personnally I'd go for proper fix or no fix -- slightly longer compile time is not really a problem when it's not done on my computer :-)</p>",
        "id": 224054165,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1611674593
    },
    {
        "content": "<p>ok, agreed</p>",
        "id": 224054207,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1611674610
    },
    {
        "content": "<p>I have registered an issue <a href=\"https://github.com/leanprover-community/lean/issues/521\">lean#521</a> to make sure it's not completely forgotten.</p>",
        "id": 224054749,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1611674793
    },
    {
        "content": "<p>In recent PRs we've recently stopped adding any more subsingleton instances. I've filed <a href=\"https://github.com/leanprover-community/mathlib/issues/6025\">#6025</a> to track the fact we're doing that, so that we can eventually convert them back to instances once all is fixed</p>",
        "id": 225144614,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1612436340
    },
    {
        "content": "<p>I was having performance problems with proofs that use a lot of <code>simp only</code>s, and when I traced the simplifier, I saw all the subsingleton nonsense. Floris pointed me to this thread, and disabling them worked beautifully. For the record, below is a locale I made to solve the problem. (I harvested all the names from the simplifier trace.)</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">localized</span> <span class=\"s2\">\"attribute [-instance] unique.subsingleton pi.subsingleton invertible.subsingleton</span>\n<span class=\"s2\">subsingleton_fin_one subsingleton_fin_zero zmod.subsingleton_units fintype.subsingleton</span>\n<span class=\"s2\">principal_seg.subsingleton initial_seg.subsingleton zmod.subsingleton_ring_equiv</span>\n<span class=\"s2\">zmod.subsingleton_ring_hom nat_algebra_subsingleton int_algebra_subsingleton</span>\n<span class=\"s2\">add_comm_group.module.subsingleton rat.subsingleton_ring_hom vector.zero_subsingleton</span>\n<span class=\"s2\">ring_hom.int.subsingleton_ring_hom nat.subsingleton_ring_hom plift.subsingleton ulift.subsingleton</span>\n<span class=\"s2\">unique.subsingleton_unique trunc.subsingleton subsingleton_pempty subsingleton.prod</span>\n<span class=\"s2\">empty.subsingleton punit.subsingleton decidable.subsingleton subsingleton_prop char_p.subsingleton\"</span>\n<span class=\"k\">in</span> <span class=\"n\">disable_subsingleton_simps</span>\n</code></pre></div>",
        "id": 228692045,
        "sender_full_name": "Jeremy Avigad",
        "timestamp": 1614816426
    },
    {
        "content": "<p>If that's just every subsingleton instance, presumably <code>#print instances subsingleton</code> would harvest them too?</p>",
        "id": 228692618,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1614816755
    },
    {
        "content": "<p>Oh, uh, yeah.... Here's the list harvested from <code>#print instances</code>. If I counted right, it picked up one more.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">localized</span> <span class=\"s2\">\"attribute [-instance] principal_seg.subsingleton initial_seg.subsingleton</span>\n<span class=\"s2\">invertible.subsingleton subsingleton_fin_one subsingleton_fin_zero zmod.subsingleton_ring_equiv</span>\n<span class=\"s2\">zmod.subsingleton_ring_hom zmod.subsingleton_units nat_algebra_subsingleton int_algebra_subsingleton</span>\n<span class=\"s2\">add_comm_group.module.subsingleton rat.subsingleton_ring_hom fintype.subsingleton</span>\n<span class=\"s2\">vector.zero_subsingleton ring_hom.int.subsingleton_ring_hom nat.subsingleton_ring_hom</span>\n<span class=\"s2\">plift.subsingleton ulift.subsingleton unique.subsingleton_unique trunc.subsingleton</span>\n<span class=\"s2\">subsingleton_pempty subsingleton.prod empty.subsingleton punit.subsingleton pi.subsingleton</span>\n<span class=\"s2\">decidable.subsingleton char_p.subsingleton unique.subsingleton\"</span>\n<span class=\"k\">in</span> <span class=\"n\">disable_singleton_simps</span>\n</code></pre></div>",
        "id": 228695254,
        "sender_full_name": "Jeremy Avigad",
        "timestamp": 1614818262
    },
    {
        "content": "<p>Maybe two more.</p>",
        "id": 228695421,
        "sender_full_name": "Jeremy Avigad",
        "timestamp": 1614818401
    },
    {
        "content": "<p>Is <a href=\"https://leanprover-community.github.io/mathlib_docs/find/eq_iff_true_of_subsingleton\">docs#eq_iff_true_of_subsingleton</a> to blame here for subsingleton making <code>simp</code> slow?</p>",
        "id": 233324163,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1617717911
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Could we check by timing mathlib with and without the simp lemma?</p>",
        "id": 233701657,
        "sender_full_name": "Thomas Browning",
        "timestamp": 1617905219
    },
    {
        "content": "<p>Even finding a slow simp and replacing it with <code>simp [-eq_iff_true_of_subsingleton]</code> would be enough to check I think</p>",
        "id": 233702044,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1617905353
    },
    {
        "content": "<p>Well Lean 4 still isn't here and this still isn't solved, has anything changed in the past 18 months?</p>",
        "id": 292866687,
        "sender_full_name": "Violeta Hern√°ndez",
        "timestamp": 1660193254
    },
    {
        "content": "<p>I guess <code>unique</code> instances are not so bad because once you disable <code>unique.subsingleton</code> (as some of the hacks above do) then they are no longer involved in <code>subsingleton</code> instance search ... The context is <a href=\"https://github.com/leanprover-community/mathlib/pull/16017#issuecomment-1212574728\">#16017</a>.</p>\n<p>If the changes to core Lean doesn't warrant a reconsideration of the ban on new subsingleton/unique instances, please let me know and I'll just close <a href=\"https://github.com/leanprover-community/mathlib/pull/16017\">#16017</a>.</p>",
        "id": 293036129,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1660270318
    },
    {
        "content": "<p>The problem has been solved by <span class=\"user-mention\" data-user-id=\"110043\">@Gabriel Ebner</span>  some time ago: simp no longer uses subsingleton instances, so the ban does not make sense any more.</p>",
        "id": 293072256,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1660296020
    },
    {
        "content": "<p>Thanks, that's great to know! Seems it's fixed in <a href=\"https://github.com/leanprover-community/lean/pull/665\">lean#665</a> and it's been there for 7 months! I think <a href=\"https://github.com/leanprover-community/mathlib/pull/16017\">#16017</a> can go ahead then? <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> </p>\n<p>So we should probably make a PR to replace subsingleton defs that <a href=\"https://github.com/leanprover-community/mathlib/search?q=gh-6025\">reference gh-6025</a> by instances, and then we can close <a href=\"https://github.com/leanprover-community/mathlib/pull/6025\">#6025</a>.</p>",
        "id": 293121083,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1660314844
    },
    {
        "content": "<p>I think it would be best to start by removing the hacks, just to be sure they're no longer needed</p>",
        "id": 293135385,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1660318063
    },
    {
        "content": "<p>looks like <span class=\"user-mention\" data-user-id=\"110050\">@Sebastien Gouezel</span> <a href=\"https://github.com/leanprover-community/mathlib/commit/c7626b7dfe2bf35b48cf43178a32d74f5dbf8b3f#diff-02976f8e19552b3c7ea070e30761e4e99f1333085cc5bb94fa170861c6ed27bcL497-L498\">already removed one hack</a> mentioned above.</p>",
        "id": 293138353,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1660318906
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> I have benchmarked the performance before and after removing the hack in <em>analysis/normed_space/multilinear</em> using <code>set_option profiler true</code>. Below is the data collected (with numbers &lt; 1s omitted, and I only recorded \"tactic execution\" numbers at the beginning). I think the difference is pretty much negligible; with the hack (the left number) declarations compile slightly faster in general, but sometimes they compile faster without the hack (the right number). Of course these numbers may fluctuate due to multithreading etc. but you get the idea. Based on the numbers, I'm in favor of removing the hack.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">bound_of_shell</span> <span class=\"n\">took</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">55</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">89</span><span class=\"n\">s</span>\n<span class=\"n\">elaboration</span><span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">execution</span> <span class=\"n\">took</span> <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">62</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">86</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">exists_bound_of_continuous</span> <span class=\"n\">took</span> <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">22</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">46</span><span class=\"n\">s</span>\n<span class=\"n\">elaboration</span><span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">execution</span> <span class=\"n\">took</span> <span class=\"mi\">3</span><span class=\"bp\">.</span><span class=\"mi\">49</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">3</span><span class=\"bp\">.</span><span class=\"mi\">66</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">norm_image_sub_le_of_bound'</span> <span class=\"n\">took</span> <span class=\"mi\">9</span><span class=\"bp\">.</span><span class=\"mi\">84</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">10</span><span class=\"bp\">.</span><span class=\"mi\">7</span><span class=\"n\">s</span>\n<span class=\"n\">elaboration</span><span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">execution</span> <span class=\"n\">took</span> <span class=\"mi\">3</span><span class=\"bp\">.</span><span class=\"mi\">65</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">3</span><span class=\"bp\">.</span><span class=\"mi\">7</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span><span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">execution</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">79</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">9</span><span class=\"n\">s</span>\n<span class=\"n\">elaboration</span><span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">execution</span> <span class=\"n\">took</span> <span class=\"mi\">8</span><span class=\"bp\">.</span><span class=\"mi\">19</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">8</span><span class=\"bp\">.</span><span class=\"mi\">87</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">norm_image_sub_le_of_bound</span> <span class=\"n\">took</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">29</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">38</span><span class=\"n\">s</span>\n<span class=\"n\">elaboration</span><span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">execution</span> <span class=\"n\">took</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">79</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">77</span><span class=\"n\">s</span>\n<span class=\"n\">elaboration</span><span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">execution</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">28</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">28</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span><span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">execution</span> <span class=\"n\">took</span> <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">42</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">45</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_of_bound</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">89</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">86</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span><span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">execution</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">55</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">51</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">op_norm_zero_iff</span> <span class=\"n\">took</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">19</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">22</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">op_norm_neg</span> <span class=\"n\">took</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">56</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">64</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">norm_pi</span> <span class=\"n\">took</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">77</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">94</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">restrict_scalars_linear</span> <span class=\"n\">took</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">23</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">4</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_eval</span> <span class=\"n\">took</span> <span class=\"mi\">3</span><span class=\"bp\">.</span><span class=\"mi\">37</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">3</span><span class=\"bp\">.</span><span class=\"mi\">19</span><span class=\"n\">s</span>\n\n<span class=\"bp\">!</span> <span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">has_sum_eval</span> <span class=\"n\">took</span> <span class=\"mi\">6</span><span class=\"bp\">.</span><span class=\"mi\">38</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">98</span><span class=\"n\">s</span>\n\n<span class=\"bp\">!</span> <span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">complete_space</span> <span class=\"n\">took</span> <span class=\"mi\">8</span><span class=\"bp\">.</span><span class=\"mi\">62</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">7</span><span class=\"bp\">.</span><span class=\"mi\">67</span><span class=\"n\">s</span>\n\n<span class=\"bp\">!</span> <span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">norm_mk_pi_algebra_of_empty</span> <span class=\"n\">took</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">75</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">32</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">norm_mk_pi_algebra</span> <span class=\"n\">took</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">06</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">73</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">norm_mk_pi_algebra_fin_zero</span> <span class=\"n\">took</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">12</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">88</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">norm_mk_pi_algebra_fin</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">84</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">64</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">norm_mk_pi_field</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">64</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">37</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">pi_field_equiv</span> <span class=\"n\">took</span> <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">25</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">3</span><span class=\"bp\">.</span><span class=\"mi\">48</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">comp_continuous_multilinear_mapL</span> <span class=\"n\">took</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">3</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">81</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">flip_multilinear</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">69</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">7</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">mk_continuous_linear</span> <span class=\"n\">took</span> <span class=\"mi\">14</span><span class=\"bp\">.</span><span class=\"mi\">9</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">15</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">mk_continuous_multilinear</span> <span class=\"n\">took</span> <span class=\"mi\">11</span><span class=\"bp\">.</span><span class=\"mi\">8</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">11</span><span class=\"bp\">.</span><span class=\"mi\">8</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_map.norm_map_cons_le</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">38</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">43</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_map.norm_map_snoc_le</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">33</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">42</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_curry_left_equiv</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">04</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">02</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_map.uncurry_right</span> <span class=\"n\">took</span> <span class=\"mi\">7</span><span class=\"bp\">.</span><span class=\"mi\">62</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">8</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_map.curry_right</span> <span class=\"n\">took</span> <span class=\"mi\">7</span><span class=\"bp\">.</span><span class=\"mi\">12</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">7</span><span class=\"bp\">.</span><span class=\"mi\">56</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_map.uncurry_curry_right</span> <span class=\"n\">took</span> <span class=\"mi\">3</span><span class=\"bp\">.</span><span class=\"mi\">95</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">3</span><span class=\"bp\">.</span><span class=\"mi\">99</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_curry_right_equiv</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">21</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">19</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_map.apply_zero_curry0</span> <span class=\"n\">took</span> <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">28</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">3</span><span class=\"bp\">.</span><span class=\"mi\">68</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_map.uncurry0_curry0</span> <span class=\"n\">took</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">49</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">16</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_map.curry0_norm</span> <span class=\"n\">took</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">96</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">75</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_map.fin0_apply_norm</span> <span class=\"n\">took</span> <span class=\"mi\">8</span><span class=\"bp\">.</span><span class=\"mi\">27</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">7</span><span class=\"bp\">.</span><span class=\"mi\">74</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">continuous_multilinear_map.uncurry0_norm</span> <span class=\"n\">took</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">56</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">18</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">curry_sum</span> <span class=\"n\">took</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">71</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">39</span><span class=\"n\">s</span>\n\n<span class=\"bp\">!</span> <span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">uncurry_sum</span> <span class=\"n\">took</span> <span class=\"mi\">11</span><span class=\"bp\">.</span><span class=\"mi\">4</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">9</span><span class=\"bp\">.</span><span class=\"mi\">5</span><span class=\"n\">s</span>\n\n<span class=\"n\">elaboration</span> <span class=\"n\">of</span> <span class=\"n\">curry_sum_equiv</span> <span class=\"n\">took</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"n\">s</span> <span class=\"bp\">-</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">77</span><span class=\"n\">s</span>\n</code></pre></div>",
        "id": 293228091,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1660368482
    },
    {
        "content": "<p>It would be harder to test the localized hack in <em>geometry/manifold/charted_space</em>, since the locale is not opened in the same file, and I'd need to find files with <code>open_locale manifold</code> to test it. Any recommendations?</p>",
        "id": 293228333,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1660368742
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110050\">@Sebastien Gouezel</span> Since you added the manifold hack, do you have any file that you want me to test on, or should I just remove the hack without worrying about it?</p>",
        "id": 293228525,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1660368965
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"459227\">@Violeta Hern√°ndez</span> I've pushed <a href=\"https://github.com/leanprover-community/mathlib/tree/remove_subsingleton_hack\">branch#remove_subsingleton_hack</a> to see if it builds. It replaced all defs mentioning gh-6025 by global instances. The next step would be removing explicit invocations (haveI, letI) of these added instances.</p>",
        "id": 293229082,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1660369612
    },
    {
        "content": "<p>Nice!</p>",
        "id": 293232302,
        "sender_full_name": "Violeta Hern√°ndez",
        "timestamp": 1660372526
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib/pull/16046\">#16046</a> chore(*): restore subsingleton instances and remove hacks<br>\nis now open.</p>",
        "id": 293332575,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1660437316
    }
]