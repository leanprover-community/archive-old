---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/slow.20proof.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html">slow proof</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="234979594"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234979594" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234979594">(Apr 17 2021 at 10:47)</a>:</h4>
<p>I am in the process of speeding up proofs that fail when <code>gsmul</code> is made into data, on my branch <code>gsmul_data</code>. First incredible example:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">forget₂_AddCommGroup_preserves_limits_aux</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">J</span> <span class="bp">⥤</span> <span class="n">Ring</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">is_limit</span> <span class="o">((</span><span class="n">forget₂</span> <span class="n">Ring</span> <span class="n">AddCommGroup</span><span class="o">)</span><span class="bp">.</span><span class="n">map_cone</span> <span class="o">(</span><span class="n">limit_cone</span> <span class="n">F</span><span class="o">))</span> <span class="o">:=</span>
<span class="n">AddCommGroup.limit_cone_is_limit</span> <span class="o">(</span><span class="n">F</span> <span class="bp">⋙</span> <span class="n">forget₂</span> <span class="n">Ring</span> <span class="n">AddCommGroup</span><span class="o">)</span>
</code></pre></div>
<p>Takes 35s on my branch. Changing it to</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">forget₂_AddCommGroup_preserves_limits_aux</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">J</span> <span class="bp">⥤</span> <span class="n">Ring</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">is_limit</span> <span class="o">((</span><span class="n">forget₂</span> <span class="n">Ring</span> <span class="n">AddCommGroup</span><span class="o">)</span><span class="bp">.</span><span class="n">map_cone</span> <span class="o">(</span><span class="n">limit_cone</span> <span class="n">F</span><span class="o">))</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="k">have</span> <span class="o">:=</span> <span class="n">AddCommGroup.limit_cone_is_limit</span> <span class="o">(</span><span class="n">F</span> <span class="bp">⋙</span> <span class="n">forget₂</span> <span class="n">Ring</span> <span class="n">AddCommGroup</span><span class="o">),</span>
  <span class="n">exact</span> <span class="n">this</span>
<span class="kd">end</span>
</code></pre></div>
<p>goes down to 185ms. I haven't found a term-mode way to achieve this (even with <code>(... : _)</code> or <code>id</code> insertion or whatever).</p>



<a name="234980904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234980904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jason Rute <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234980904">(Apr 17 2021 at 11:11)</a>:</h4>
<p>I have a silly question:  What is the term proof you get by <code>#print forget₂_AddCommGroup_preserves_limits_aux</code> (tactic version), and how long does it take to run that term proof?</p>



<a name="234981501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234981501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234981501">(Apr 17 2021 at 11:22)</a>:</h4>
<p>Wow. That's really terrible, and largely my fault. (I don't know a fix, I guess I just have too high tolerance for slow-to-compile proofs.)</p>



<a name="234981565"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234981565" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234981565">(Apr 17 2021 at 11:22)</a>:</h4>
<p>That's not your fault, that's Lean's fault, obviously.</p>



<a name="234981582"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234981582" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234981582">(Apr 17 2021 at 11:23)</a>:</h4>
<p>The question is whether there is some way to let it switch automatically to the other elaboration procedure that makes the proof essentially instant.</p>



<a name="234982214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234982214" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234982214">(Apr 17 2021 at 11:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="115715">Jason Rute</span> <a href="#narrow/stream/113488-general/topic/slow.20proof/near/234980904">said</a>:</p>
<blockquote>
<p>I have a silly question:  What is the term proof you get by <code>#print forget₂_AddCommGroup_preserves_limits_aux</code> (tactic version), and how long does it take to run that term proof?</p>
</blockquote>
<p>The proof term is the same for the tactic mode and the term mode version. Even using the <code>pp.all</code> output, like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">yet_another_try</span> <span class="o">{</span><span class="n">J</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">_inst_1</span> <span class="o">:</span> <span class="n">small_category</span> <span class="n">J</span><span class="o">]</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">J</span> <span class="bp">⥤</span> <span class="n">Ring</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">is_limit</span> <span class="o">((</span><span class="n">forget₂</span> <span class="n">Ring</span> <span class="n">AddCommGroup</span><span class="o">)</span><span class="bp">.</span><span class="n">map_cone</span> <span class="o">(</span><span class="n">limit_cone</span> <span class="n">F</span><span class="o">))</span> <span class="o">:=</span>
<span class="bp">@</span><span class="n">AddCommGroup.limit_cone_is_limit.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">J</span> <span class="n">_inst_1</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">category_theory.functor.comp.</span><span class="o">{</span><span class="n">u</span> <span class="n">u</span> <span class="n">u</span> <span class="n">u</span> <span class="n">u</span><span class="bp">+</span><span class="mi">1</span> <span class="n">u</span><span class="bp">+</span><span class="mi">1</span><span class="o">}</span> <span class="n">J</span> <span class="n">_inst_1</span> <span class="n">Ring.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">Ring.large_category.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">AddCommGroup.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span>
       <span class="n">AddCommGroup.large_category.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span>
       <span class="n">F</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">category_theory.forget₂.</span><span class="o">{</span><span class="n">u</span><span class="bp">+</span><span class="mi">1</span> <span class="n">u</span><span class="bp">+</span><span class="mi">1</span> <span class="n">u</span> <span class="n">u</span> <span class="n">u</span><span class="o">}</span> <span class="n">Ring.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">AddCommGroup.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">Ring.large_category.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span>
          <span class="n">Ring.concrete_category.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span>
          <span class="n">AddCommGroup.large_category.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span>
          <span class="n">AddCommGroup.concrete_category.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span>
          <span class="n">Ring.has_forget_to_AddCommGroup.</span><span class="o">{</span><span class="n">u</span><span class="o">}))</span>
</code></pre></div>
<p>This takes 21s to compile (so, a little bit faster than the original term mode, but still 150 times slower than the tactic mode version, that gives exactly the same proof). I don't understand how this is possible.</p>



<a name="234982649"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234982649" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234982649">(Apr 17 2021 at 11:42)</a>:</h4>
<p>Does the @ trick work? (<code>:= @AddCommGroup.limit_cone_is_limit _ _ ...</code>)This changes default elaboration procedure</p>



<a name="234982697"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234982697" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234982697">(Apr 17 2021 at 11:43)</a>:</h4>
<p>The <code>pp.all</code> version I gave uses <code>@</code> versions for everything, and it is super-slow.</p>



<a name="234982959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234982959" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234982959">(Apr 17 2021 at 11:48)</a>:</h4>
<p>This is very strange. Can I see it in action on some branch?</p>



<a name="234983136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234983136" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234983136">(Apr 17 2021 at 11:50)</a>:</h4>
<p>Yes, on <a href="https://github.com/leanprover-community/mathlib/tree/gsmul_data">branch#gsmul_data</a>, in the file algebra/category/CommRing/limits.lean, line 282. Should be the same in master, by the way (although a little bit faster, so a little bit easier to investigate).</p>



<a name="234984348"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234984348" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234984348">(Apr 17 2021 at 12:10)</a>:</h4>
<p>There is a motive here. Next super-slow proof in the file is</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="sd">/-- Auxiliary construction for the `creates_limit` instance below. -/</span>
<span class="kd">def</span> <span class="n">is_limit_lifted_cone</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">J</span> <span class="bp">⥤</span> <span class="n">CommRing</span><span class="o">)</span> <span class="o">:</span> <span class="n">is_limit</span> <span class="o">(</span><span class="n">lifted_cone</span> <span class="n">F</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">is_limit.of_faithful</span> <span class="o">(</span><span class="n">forget₂</span> <span class="n">_</span> <span class="n">Ring.</span><span class="o">{</span><span class="n">u</span><span class="o">})</span> <span class="o">(</span><span class="n">Ring.limit_cone_is_limit</span> <span class="n">_</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="o">(</span><span class="n">Ring.limit_cone_is_limit</span> <span class="n">_</span><span class="o">)</span><span class="bp">.</span><span class="n">lift</span> <span class="o">((</span><span class="n">forget₂</span> <span class="n">_</span> <span class="n">Ring.</span><span class="o">{</span><span class="n">u</span><span class="o">})</span><span class="bp">.</span><span class="n">map_cone</span> <span class="n">s</span><span class="o">))</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="n">rfl</span><span class="o">)</span>
</code></pre></div>
<p>taking 38s seconds. Changing it to</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="sd">/-- Auxiliary construction for the `creates_limit` instance below. -/</span>
<span class="kd">def</span> <span class="n">is_limit_lifted_cone</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">J</span> <span class="bp">⥤</span> <span class="n">CommRing</span><span class="o">)</span> <span class="o">:</span> <span class="n">is_limit</span> <span class="o">(</span><span class="n">lifted_cone</span> <span class="n">F</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="k">let</span> <span class="o">:=</span> <span class="n">Ring.limit_cone_is_limit</span> <span class="o">(</span><span class="n">F</span> <span class="bp">⋙</span> <span class="n">forget₂</span> <span class="n">CommRing</span> <span class="n">Ring</span><span class="o">),</span>
  <span class="n">exact</span> <span class="n">is_limit.of_faithful</span> <span class="o">(</span><span class="n">forget₂</span> <span class="n">_</span> <span class="n">Ring.</span><span class="o">{</span><span class="n">u</span><span class="o">})</span> <span class="n">this</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="o">(</span><span class="n">Ring.limit_cone_is_limit</span> <span class="n">_</span><span class="o">)</span><span class="bp">.</span><span class="n">lift</span> <span class="o">((</span><span class="n">forget₂</span> <span class="n">_</span> <span class="n">Ring.</span><span class="o">{</span><span class="n">u</span><span class="o">})</span><span class="bp">.</span><span class="n">map_cone</span> <span class="n">s</span><span class="o">))</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="n">rfl</span><span class="o">),</span>
<span class="kd">end</span>
</code></pre></div>
<p>it takes 250 ms.</p>



<a name="234984407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234984407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234984407">(Apr 17 2021 at 12:11)</a>:</h4>
<p>Just understanding what is going on here and giving some good practice rules could be extremely helpful (I just found this by random trial and error!)</p>



<a name="234990361"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/234990361" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Oliver Nash <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#234990361">(Apr 17 2021 at 14:00)</a>:</h4>
<p>I wonder could we have a job that maintains a list of the slowest proofs (and defs) in Mathlib and publishes the slowest 100 somewhere, not to apply pressure to anyone, but just to give some visibility.</p>



<a name="235003249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235003249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235003249">(Apr 17 2021 at 17:11)</a>:</h4>
<p>I'm starting to investigate. The problem seems to be that the type of the <code>def</code> is not fully elaborated before the term gets elaborated. <br>
Just adding <code>by exact</code> at the start of the proof speeds it up (so far I'm only investigating <code>yet_another_try</code>)</p>



<a name="235004089"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235004089" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235004089">(Apr 17 2021 at 17:24)</a>:</h4>
<p>Oh, but that doesn't necessarily help in other examples.</p>



<a name="235004301"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235004301" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235004301">(Apr 17 2021 at 17:27)</a>:</h4>
<p>Fwiw, in <a href="#narrow/stream/267928-condensed-mathematics/topic/thm95.2Ehomotopy/near/234983175">https://leanprover.zulipchat.com/#narrow/stream/267928-condensed-mathematics/topic/thm95.2Ehomotopy/near/234983175</a> we needed <code>by convert</code></p>



<a name="235005373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235005373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235005373">(Apr 17 2021 at 17:44)</a>:</h4>
<p>Yeah <code>by apply</code> or <code>by convert</code> work better. They have basically the same effect as what Sebastien did in the first post (<code>by { have := foo, exact foo }</code>)</p>



<a name="235007098"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235007098" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235007098">(Apr 17 2021 at 18:12)</a>:</h4>
<p>I don't have much to report after investigating. The elaborator has to do <em>a lot</em> of definitional unfolding to make sense of these proofs, and presumably it starts unfolding the wrong things to try to make two types definitionally equal.</p>



<a name="235009318"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235009318" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235009318">(Apr 17 2021 at 18:51)</a>:</h4>
<p>I really like the <code>by convert</code> strategy. It really means: build this term as you like, and afterwards try to match it up with the required type. And it works more efficiently than putting <code>( : _)</code> (which is supposed to do the same) or adding an <code>id</code> somewhere. I just used it to speed up another proof, by the way, from</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="n">refine</span> <span class="n">jacobson_bot_of_integral_localization</span> <span class="o">(</span><span class="n">quotient_map</span> <span class="n">P</span> <span class="n">C</span> <span class="n">le_rfl</span><span class="o">)</span> <span class="n">quotient_map_injective</span>
      <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="n">localization.of</span> <span class="o">(</span><span class="n">submonoid.powers</span> <span class="o">(</span><span class="n">p.map</span> <span class="o">(</span><span class="n">quotient.mk</span> <span class="o">(</span><span class="n">P.comap</span> <span class="n">C</span><span class="o">)))</span><span class="bp">.</span><span class="n">leading_coeff</span><span class="o">))</span>
      <span class="o">(</span><span class="n">localization.of</span> <span class="n">_</span><span class="o">)</span> <span class="o">(</span><span class="n">is_integral_localization_map_polynomial_quotient</span> <span class="n">P</span> <span class="n">_</span> <span class="n">pP</span> <span class="n">_</span> <span class="n">_</span><span class="o">),</span>
</code></pre></div>
<p>to</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="n">refine</span> <span class="n">jacobson_bot_of_integral_localization</span> <span class="o">(</span><span class="n">quotient_map</span> <span class="n">P</span> <span class="n">C</span> <span class="n">le_rfl</span><span class="o">)</span> <span class="n">quotient_map_injective</span>
      <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="n">localization.of</span> <span class="o">(</span><span class="n">submonoid.powers</span> <span class="o">(</span><span class="n">p.map</span> <span class="o">(</span><span class="n">quotient.mk</span> <span class="o">(</span><span class="n">P.comap</span> <span class="n">C</span><span class="o">)))</span><span class="bp">.</span><span class="n">leading_coeff</span><span class="o">))</span>
      <span class="o">(</span><span class="n">localization.of</span> <span class="n">_</span><span class="o">)</span>
      <span class="o">(</span><span class="kd">by</span> <span class="n">convert</span> <span class="o">(</span><span class="n">is_integral_localization_map_polynomial_quotient</span> <span class="n">P</span> <span class="n">_</span> <span class="n">pP</span> <span class="n">_</span> <span class="n">_</span><span class="o">)),</span>
</code></pre></div>
<p>(goes down from 20s to 1s).</p>



<a name="235009408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235009408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235009408">(Apr 17 2021 at 18:52)</a>:</h4>
<p>I just notice and fix these along the way because the build fails otherwise, but I think it's great to force us to do this, because otherwise these would get unnoticed.</p>



<a name="235009450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235009450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235009450">(Apr 17 2021 at 18:53)</a>:</h4>
<p>(And I am afraid this PR will globally add a few minutes again, because all the basic structures we use all the time get more complicated).</p>



<a name="235084730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235084730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235084730">(Apr 18 2021 at 16:48)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> has (rightly!) raised in <a href="https://github.com/leanprover-community/mathlib/issues/7253">#7253</a> the concern that <code>by convert</code> proofs are not suitable for defs, because they introduce additional <code>eq.mpr</code>. On the other hand, the pattern</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">begin</span>
  <span class="k">have</span> <span class="o">:=</span> <span class="bp">...</span>
  <span class="n">exact</span> <span class="n">this</span>
<span class="kd">end</span>
</code></pre></div>
<p>produces exactly the same <code>pp.all</code> output as <code>...</code> (so in particular <code>have</code> does not forget the data it is given, which is surprising to me), and in the situations of interest it is much faster than just <code>...</code> (ratio 1 to 100)! Its main problem is that it is too verbose compared to <code>by convert ...</code>. A tactic <code>speedup</code> (or <code>unusual_elaboration</code> or whatever) doing this would be better, but I am completely unable to write this (which should normally be a one-liner). I tried something like</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">ring_theory.subring</span>

<span class="kn">open</span> <span class="n">tactic</span>
<span class="n">setup_tactic_parser</span>

<span class="kn">namespace</span> <span class="n">tactic</span>
<span class="kn">namespace</span> <span class="n">interactive</span>

<span class="sd">/-- Try another elaboration tactic -/</span>
<span class="kd">meta</span> <span class="kd">def</span> <span class="n">speedup</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">texpr</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="bp">`</span><span class="o">[</span> <span class="k">have</span> <span class="o">:=</span> <span class="n">q</span><span class="o">,</span> <span class="n">exact</span> <span class="n">this</span><span class="o">]</span>

<span class="kd">end</span> <span class="n">interactive</span>
<span class="kd">end</span> <span class="n">tactic</span>
</code></pre></div>
<p>but of course it doesn't work since <code>have := q</code> is not referring to <code>parse texpr</code>. Anyone know how to do this?</p>



<a name="235084861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235084861" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235084861">(Apr 18 2021 at 16:51)</a>:</h4>
<p>Do you have an example lemma where you want to apply this tactic?</p>



<a name="235084913"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235084913" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235084913">(Apr 18 2021 at 16:52)</a>:</h4>
<p>I mean a MWE, not the snippets from this thread</p>



<a name="235085232"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085232" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085232">(Apr 18 2021 at 16:59)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.category.CommRing.limits</span>

<span class="kn">open</span> <span class="n">category_theory</span>
<span class="kn">open</span> <span class="n">category_theory.limits</span>

<span class="kd">universe</span> <span class="n">u</span>

<span class="kn">namespace</span> <span class="n">SemiRing</span>
<span class="kn">open</span> <span class="n">has_limits</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">J</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">small_category</span> <span class="n">J</span><span class="o">]</span>

<span class="kd">set_option</span> <span class="n">profiler</span> <span class="n">true</span>

<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">J</span> <span class="bp">⥤</span> <span class="n">SemiRing</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">is_limit</span> <span class="o">((</span><span class="n">forget₂</span> <span class="n">SemiRing</span> <span class="n">AddCommMon</span><span class="o">)</span><span class="bp">.</span><span class="n">map_cone</span> <span class="o">(</span><span class="n">limit_cone</span> <span class="n">F</span><span class="o">))</span> <span class="o">:=</span>
<span class="n">AddCommMon.limit_cone_is_limit</span> <span class="o">(</span><span class="n">F</span> <span class="bp">⋙</span> <span class="n">forget₂</span> <span class="n">SemiRing</span> <span class="n">AddCommMon</span><span class="o">)</span>

<span class="kd">end</span> <span class="n">SemiRing</span>
</code></pre></div>
<p>takes 2s on my computer. With <code>by convert</code> or the <code>begin have := ..., exact this end</code>, it goes down to 100ms.</p>



<a name="235085247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085247">(Apr 18 2021 at 16:59)</a>:</h4>
<p>(on mathlib master)</p>



<a name="235085393"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085393" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085393">(Apr 18 2021 at 17:01)</a>:</h4>
<p>Could you try the naive </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">speedup</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">texpr</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">to_expr</span> <span class="n">q</span> <span class="bp">&gt;&gt;=</span> <span class="n">tactic.exact</span>
</code></pre></div>



<a name="235085572"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085572" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085572">(Apr 18 2021 at 17:04)</a>:</h4>
<p>I see</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elaboration</span><span class="o">:</span> <span class="n">tactic</span> <span class="n">compilation</span> <span class="n">took</span> <span class="mi">2</span><span class="bp">.</span><span class="mi">09</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">30</span><span class="o">:</span><span class="mi">3</span>
<span class="n">elaboration</span><span class="o">:</span> <span class="n">tactic</span> <span class="n">execution</span> <span class="n">took</span> <span class="mi">38</span><span class="n">ms</span>
<span class="n">num.</span> <span class="n">allocated</span> <span class="n">objects</span><span class="o">:</span>  <span class="mi">76</span>
<span class="n">num.</span> <span class="n">allocated</span> <span class="n">closures</span><span class="o">:</span> <span class="mi">270</span>
   <span class="mi">38</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.interactive.speedup</span>
   <span class="mi">38</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">_interaction._lambda_2</span>
   <span class="mi">38</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.step</span>
   <span class="mi">38</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">_interaction</span>
   <span class="mi">38</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.istep</span>
   <span class="mi">38</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.istep._lambda_1</span>
   <span class="mi">38</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">scope_trace</span>
   <span class="mi">35</span><span class="n">ms</span>    <span class="mi">92</span><span class="bp">.</span><span class="mi">1</span><span class="bp">%</span>   <span class="n">tactic.exact</span>
    <span class="mi">3</span><span class="n">ms</span>     <span class="mi">7</span><span class="bp">.</span><span class="mi">9</span><span class="bp">%</span>   <span class="n">tactic.to_expr</span>
</code></pre></div>



<a name="235085594"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085594" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085594">(Apr 18 2021 at 17:04)</a>:</h4>
<p>Works like a charm! Thanks!</p>



<a name="235085687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085687" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085687">(Apr 18 2021 at 17:05)</a>:</h4>
<p>Can you give us the figures you get with <code>by exact</code>, to compare?</p>



<a name="235085760"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085760" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085760">(Apr 18 2021 at 17:06)</a>:</h4>
<p>I know you're busy, but one day you should take  one hour to read <a href="https://leanprover-community.github.io/extras/tactic_writing.html">https://leanprover-community.github.io/extras/tactic_writing.html</a>. I'm sure you'll enjoy being able to write such a basic tactic yourself (and that one is totally covered by this simple minded tutorial).</p>



<a name="235085789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085789">(Apr 18 2021 at 17:06)</a>:</h4>
<p>Without any tactic I read</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">parsing</span> <span class="n">took</span> <span class="mi">0</span><span class="bp">.</span><span class="mi">337</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">elaboration</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">1</span><span class="bp">.</span><span class="mi">53</span><span class="n">s</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">type</span> <span class="n">checking</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">23</span><span class="bp">.</span><span class="mi">3</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">decl</span> <span class="n">post</span><span class="bp">-</span><span class="n">processing</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">21</span><span class="bp">.</span><span class="mi">2</span><span class="n">ms</span>
</code></pre></div>



<a name="235085806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085806" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085806">(Apr 18 2021 at 17:07)</a>:</h4>
<p>Sorry, this is not quite the same trace.</p>



<a name="235085809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085809" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085809">(Apr 18 2021 at 17:07)</a>:</h4>
<p>With the tactic I get:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">parsing</span> <span class="n">took</span> <span class="mi">1</span><span class="bp">.</span><span class="mi">09</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">elaboration</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">48</span><span class="bp">.</span><span class="mi">1</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">type</span> <span class="n">checking</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">22</span><span class="bp">.</span><span class="mi">3</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">decl</span> <span class="n">post</span><span class="bp">-</span><span class="n">processing</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">22</span><span class="bp">.</span><span class="mi">6</span><span class="n">ms</span>
</code></pre></div>



<a name="235085841"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085841" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085841">(Apr 18 2021 at 17:08)</a>:</h4>
<p>So I guess the comparison you are interested in is the 1.53s  vs 48.1ms</p>



<a name="235085929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085929">(Apr 18 2021 at 17:08)</a>:</h4>
<p>But of course parsing takes away a tiny bit of this gain.</p>



<a name="235085963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235085963" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235085963">(Apr 18 2021 at 17:09)</a>:</h4>
<p>And with <code>by exact</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">parsing</span> <span class="n">took</span> <span class="mi">1</span><span class="bp">.</span><span class="mi">13</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">elaboration</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">1</span><span class="bp">.</span><span class="mi">37</span><span class="n">s</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">type</span> <span class="n">checking</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">22</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">decl</span> <span class="n">post</span><span class="bp">-</span><span class="n">processing</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">20</span><span class="bp">.</span><span class="mi">8</span><span class="n">ms</span>
</code></pre></div>



<a name="235086023"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235086023" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235086023">(Apr 18 2021 at 17:10)</a>:</h4>
<p><span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span> <code>apply q</code> does almost the same as <code>have := q, exact this</code>. Does that work instead?</p>



<a name="235086074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235086074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235086074">(Apr 18 2021 at 17:11)</a>:</h4>
<p>And yet another one, with <code>(stuff  : _)</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">parsing</span> <span class="n">took</span> <span class="mi">0</span><span class="bp">.</span><span class="mi">481</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">elaboration</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">847</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">type</span> <span class="n">checking</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">20</span><span class="bp">.</span><span class="mi">3</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">decl</span> <span class="n">post</span><span class="bp">-</span><span class="n">processing</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">20</span><span class="n">ms</span>
</code></pre></div>



<a name="235086137"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235086137" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235086137">(Apr 18 2021 at 17:12)</a>:</h4>
<p>And another for Floris, with <code>by apply stuff</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">parsing</span> <span class="n">took</span> <span class="mi">1</span><span class="bp">.</span><span class="mi">32</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">elaboration</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">50</span><span class="bp">.</span><span class="mi">3</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">type</span> <span class="n">checking</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">21</span><span class="bp">.</span><span class="mi">7</span><span class="n">ms</span>
<span class="n">scratch.lean</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">18</span>
<span class="n">decl</span> <span class="n">post</span><span class="bp">-</span><span class="n">processing</span> <span class="n">of</span> <span class="n">forget₂_AddCommMon_preserves_limits_aux'</span> <span class="n">took</span> <span class="mi">21</span><span class="bp">.</span><span class="mi">4</span><span class="n">ms</span>
</code></pre></div>



<a name="235086281"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235086281" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235086281">(Apr 18 2021 at 17:15)</a>:</h4>
<p>Yes, <code>by apply</code> is perfect, thanks (and it takes less characters to type than <code>by speedup</code>).</p>



<a name="235086403"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235086403" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235086403">(Apr 18 2021 at 17:17)</a>:</h4>
<p>If someone could explain to me what is going on under the hood, I'd be extremely happy. My impression was that a tactic proof was creating a term proof, and that at the end of the proof this term proof was checked by the kernel. So I don't get how a tactic proof can be so much faster than the <code>pp.all</code> term it generates, for which there is no elaboration do be done.</p>



<a name="235086496"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235086496" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235086496">(Apr 18 2021 at 17:19)</a>:</h4>
<p>I know nothing about how Lean really works, but my only guesses are some kind of cache or subterm sharing is involved.</p>



<a name="235086728"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235086728" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235086728">(Apr 18 2021 at 17:22)</a>:</h4>
<p>If you give the <code>pp.all</code> term for the type also, then all examples (that I've tried) are really quick. The problem with <code>yet_another_try</code> above is that there are still implicit arguments in the type of the definition, which is being elaborated simultaneously with the term. Even though you give the term explicitly, because of all the definitional unfolding required to unify the term with the type (which still has implicit information), presumably the Lean elaborator goes into a wrong rabbit hole of unfolding the wrong thing and getting huge terms.<br>
Note that for example making <code>yet_another_try</code> a <code>lemma</code> forces Lean to first elaborate the type before even looking at the term. That is also quick.</p>



<a name="235086967"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235086967" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235086967">(Apr 18 2021 at 17:26)</a>:</h4>
<p>Ah, I had not imagined it could come from the type of the definition, thanks!</p>



<a name="235087057"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235087057" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235087057">(Apr 18 2021 at 17:28)</a>:</h4>
<p>Unrelated question: it looks like fixing the nsmul diamond has been a huge performance hit for leanchecker (doubling its time, roughly from 30 minutes to 1 hour). Is this something we should worry about, or that should not surprise us?</p>



<a name="235087460"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235087460" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235087460">(Apr 18 2021 at 17:34)</a>:</h4>
<p>Does fixing the gsmul diamond make things even worse?</p>



<a name="235087583"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235087583" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235087583">(Apr 18 2021 at 17:36)</a>:</h4>
<p>I don't know, as this PR hasn't reached the leanchecker step yet.</p>



<a name="235110196"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235110196" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235110196">(Apr 18 2021 at 23:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110050">Sebastien Gouezel</span> <a href="#narrow/stream/113488-general/topic/slow.20proof/near/235087057">said</a>:</p>
<blockquote>
<p>Unrelated question: it looks like fixing the nsmul diamond has been a huge performance hit for leanchecker (doubling its time, roughly from 30 minutes to 1 hour). Is this something we should worry about, or that should not surprise us?</p>
</blockquote>
<p>I think there is a serious bug here, that I posted about on the PR about switching nat mul recursion order, but might be related to this as well. The issue that came up there is that the kernel is unfolding numerals, like <code>int.add 23 45 = 23 + 45</code> will go and unfold <code>23</code> instead of the typeclass for <code>+</code>.</p>



<a name="235137564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20proof/near/235137564" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20proof.html#235137564">(Apr 19 2021 at 07:14)</a>:</h4>
<p>The leanchecker step on <a href="https://github.com/leanprover-community/mathlib/issues/7255">#7255</a> fixing the gsmul diamonds is indeed taking 1h27...</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>