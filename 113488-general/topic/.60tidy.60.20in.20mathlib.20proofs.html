---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html">`tidy` in mathlib proofs</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="266414378"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266414378" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266414378">(Dec 30 2021 at 09:19)</a>:</h4>
<p>What's the policy on using <code>tidy</code> in proofs in mathlib?  Several people have indicated that it's intended as a "get the job done" tactic that you should then replace before PRing.  But a quick search turns up 637 instances of <code>tidy</code> in 165 files in mathlib (excluding the folders <code>archive</code>, <code>scripts</code>, <code>tactic</code>, and <code>test</code>). So would it be worthwhile to start working through these and replacing them with more explicit proofs, as I've been doing with <code>finish</code>?  Or is there a plan to automate them away in the port to Lean 4?</p>



<a name="266414704"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266414704" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266414704">(Dec 30 2021 at 09:24)</a>:</h4>
<p>There will be plenty more occurrences of <code>tidy</code> because it's invoked as an autoparam via <code>obviously</code> in the category theory part of mathlib</p>



<a name="266414928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266414928" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266414928">(Dec 30 2021 at 09:29)</a>:</h4>
<p>Ah yes, another 166 results after filtering out some comments</p>



<a name="266415241"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266415241" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266415241">(Dec 30 2021 at 09:34)</a>:</h4>
<p><span class="user-mention" data-user-id="422543">@Stuart Presnell</span> there are several things to consider:</p>
<ol>
<li>Stability. If the behaviour of a tactic can change due to "independent" contributions to mathlib, then it can be a maintenance hazard. Because someone adds a lemma in file <code>X.lean</code> suddenly a proof in <code>Y.lean</code> breaks. And the poor person that modified <code>X.lean</code> has no idea how to fix the broken proof.<br>
The main example of this is <code>simp</code>. By changing the set of <code>simp</code>-lemmas (e.g., by adding some) the behaviour of <code>simp</code> can change. For this reason, <code>simp</code> is only allowed as "finishing" tactic. And non-terminal <code>simp</code> calls must be of the special shape <code>simp only [lemma1, lemma2]</code>, which explicitly list the lemmas that <code>simp</code> can use. In other words, <code>simp only</code> is again deterministic, and therefore much more stable.</li>
</ol>
<p>Since <code>tidy</code> calls <code>simp</code> under the hood, using <code>tidy</code> in a non-finishing manner is dangerous.</p>
<ol start="2">
<li>Speed. Since mathlib is large, and used by many people, we want it to be reasonably fast. This is another reason why <code>simp</code>s are often squeezed into <code>simp only</code>s. It often shaves of seconds of a proof, and these seconds add up to shaving many minutes if not hours off the total mathlib compile time.</li>
</ol>
<p>For the same reason, <code>tidy</code> is often replaced by the output of <code>tidy?</code>, to speed up proofs by "caching" (in this case, inlining) the result that <code>tidy</code> found.</p>



<a name="266415454"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266415454" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266415454">(Dec 30 2021 at 09:37)</a>:</h4>
<p>From a cursory skim through the search results I'm only seeing <code>tidy</code> in terminal position, so I guess the speed issue is the more salient one here.</p>



<a name="266415539"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266415539" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266415539">(Dec 30 2021 at 09:39)</a>:</h4>
<p>Right, because (1) is a hard rule. We don't want non-terminal <code>simp</code> or <code>tidy</code> in mathlib <em>at all</em>. But (2) is a balancing act. There is no rule against terminal <code>simp</code> or <code>tidy</code>.</p>



<a name="266415554"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266415554" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266415554">(Dec 30 2021 at 09:39)</a>:</h4>
<p>The compile-speed has to be balanced against brevity and "development speed".</p>



<a name="266415625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266415625" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266415625">(Dec 30 2021 at 09:40)</a>:</h4>
<p>After all, I value human-time over computer-time. Which means the factor is &gt; 1. But it isn't infinite (-;</p>



<a name="266416039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266416039" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266416039">(Dec 30 2021 at 09:47)</a>:</h4>
<p>Right, it wouldn't be worth sinking weeks of work into shaving off a few nanoseconds of compile time.  Are there places where the use of <code>tidy</code> is causing a particular slowdown, where replacing it would be worthwhile?  Is there some kind of profiling tool that could be used to find the slow instances?</p>



<a name="266416207"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266416207" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266416207">(Dec 30 2021 at 09:50)</a>:</h4>
<p>Do you know about <code>set_option profiler true</code>?</p>



<a name="266416218"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266416218" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266416218">(Dec 30 2021 at 09:50)</a>:</h4>
<p>I don't think we have other tools to find slow proofs.</p>



<a name="266416247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266416247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266416247">(Dec 30 2021 at 09:51)</a>:</h4>
<p><span class="user-mention" data-user-id="422543">@Stuart Presnell</span> ooh, and there are the links posted in the <a class="stream" data-stream-id="113538" href="/#narrow/stream/113538-CI">#CI</a> stream, such as <a href="https://mathlib-bench.limperg.de/commit/e003d6e278e4cbb0bf9c0abad75b1d04794bf08a">https://mathlib-bench.limperg.de/commit/e003d6e278e4cbb0bf9c0abad75b1d04794bf08a</a></p>



<a name="266416261"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266416261" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266416261">(Dec 30 2021 at 09:51)</a>:</h4>
<p>Oh, I didn't, thanks!</p>



<a name="266416262"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266416262" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266416262">(Dec 30 2021 at 09:51)</a>:</h4>
<p>That contains timing data for full mathlib builds.</p>



<a name="266416316"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266416316" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266416316">(Dec 30 2021 at 09:52)</a>:</h4>
<p>So you might want to mine that. I've never looked at it in a systematic way; there might be some "gems" there.</p>



<a name="266421872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266421872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266421872">(Dec 30 2021 at 11:31)</a>:</h4>
<p>I'd like to see not just the slowest 10% of files highlighted but the actual order, ie which is the slowest etc</p>



<a name="266422774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266422774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266422774">(Dec 30 2021 at 11:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110038">Kevin Buzzard</span> <a href="#narrow/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs/near/266421872">said</a>:</p>
<blockquote>
<p>I'd like to see not just the slowest 10% of files highlighted but the actual order, ie which is the slowest etc</p>
</blockquote>
<p>Here, you can load this up on LibreCalc or something: <a href="/user_uploads/3121/S--6zBJW3s6dgUC8Nr1Td2tg/ordered.csv">ordered.csv</a></p>



<a name="266423363"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/266423363" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#266423363">(Dec 30 2021 at 12:00)</a>:</h4>
<p>Would be nice if we had the file size easily on that data so we could order by <code>timings/file_size</code> instead</p>



<a name="269972670"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/269972670" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#269972670">(Jan 31 2022 at 02:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs/near/266416247">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="422543">Stuart Presnell</span> ooh, and there are the links posted in the <a class="stream" data-stream-id="113538" href="/#narrow/stream/113538-CI">#CI</a> stream, such as <a href="https://mathlib-bench.limperg.de/commit/e003d6e278e4cbb0bf9c0abad75b1d04794bf08a">https://mathlib-bench.limperg.de/commit/e003d6e278e4cbb0bf9c0abad75b1d04794bf08a</a></p>
</blockquote>
<p>How is this data being generated?</p>



<a name="269972917"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/269972917" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#269972917">(Jan 31 2022 at 02:26)</a>:</h4>
<p><span class="user-mention" data-user-id="256311">@Jannis Limperg</span> runs the build time bot which generates that data. It looks like the Zulip thread from around when it was set up is <a href="#narrow/stream/113488-general/topic/Preview.20of.20new.20build.20time.20benchmark/near/215115739">here</a>.</p>



<a name="269973097"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/269973097" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#269973097">(Jan 31 2022 at 02:30)</a>:</h4>
<p>I'm wondering if it would be too troublesome to add file sizes on that table</p>



<a name="270017610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/270017610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#270017610">(Jan 31 2022 at 11:39)</a>:</h4>
<p>Not very. Ping me if I haven't done it until next week.</p>



<a name="270017928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/270017928" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#270017928">(Jan 31 2022 at 11:42)</a>:</h4>
<p><span class="user-mention" data-user-id="256311">@Jannis Limperg</span> is the code on GitHub? I can open a PR (I didn't intend to bother you)</p>



<a name="270018975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/270018975" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#270018975">(Jan 31 2022 at 11:51)</a>:</h4>
<p>Code is here: <a href="https://github.com/JLimperg/mathlib-bench">https://github.com/JLimperg/mathlib-bench</a></p>
<p>But the change is not entirely trivial (it requires a DB schema change) and the program is a little bit overengineered in general (ahem), so it's probably more efficient if I do it.</p>



<a name="270020610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/270020610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#270020610">(Jan 31 2022 at 12:06)</a>:</h4>
<p>Ah, okay<br>
Just to explain the motivation: file A being 5 times slower to build than file B doesn't mean much if it's also 5 times bigger. So I was thinking about adding two extra columns: <code>n_lines</code> and <code>time_by_line</code> and ordering by <code>time_by_line</code> in descending order. So we could flag files that take long to build despite not being so big</p>



<a name="270021495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/270021495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#270021495">(Jan 31 2022 at 12:15)</a>:</h4>
<p>Maybe number of declarations in the file would be another useful column for that purpose (even a rough guess-timate of count of <code>def</code> <code>theorem</code> and <code>lemma</code> strings (maybe surrounded by regex <code>\b</code>s))</p>



<a name="270024274"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/270024274" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#270024274">(Jan 31 2022 at 12:39)</a>:</h4>
<p>You want to count slocs (without blank lines), not locs then.</p>



<a name="270025516"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/270025516" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#270025516">(Jan 31 2022 at 12:50)</a>:</h4>
<p>I didn't want to increase the scope of this task too much. The number of lines can serve as a first proxy and when Jannis make the change in the DB scheme we can jump in and polish it as we like (removing empty lines, docstrings etc)</p>



<a name="270030221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/270030221" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#270030221">(Jan 31 2022 at 13:26)</a>:</h4>
<p>The <code>cloc</code> command already has Lean support, so nothing to do here for Jannis :)</p>



<a name="271367106"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271367106" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271367106">(Feb 10 2022 at 00:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256311">Jannis Limperg</span> <a href="#narrow/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs/near/270017610">said</a>:</p>
<blockquote>
<p>Not very. Ping me if I haven't done it until next week.</p>
</blockquote>
<p><span aria-label="ping pong" class="emoji emoji-1f3d3" role="img" title="ping pong">:ping_pong:</span> just because you asked me to <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="271407135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271407135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271407135">(Feb 10 2022 at 09:43)</a>:</h4>
<p>Thanks! I was just looking for this topic to announce that it's done, so the ping was very helpful. ;)</p>
<p><a href="https://mathlib-bench.limperg.de/commit/352e06424adc5b5de32cff69c12e3acddfc192c1">https://mathlib-bench.limperg.de/commit/352e06424adc5b5de32cff69c12e3acddfc192c1</a></p>
<p>Leading the list are a bunch of <code>default.lean</code> files which have very few LOC but high startup overhead. I should maybe filter these.</p>



<a name="271407597"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271407597" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271407597">(Feb 10 2022 at 09:48)</a>:</h4>
<p>Looks like the real winner is <code>category_theory/linear/yoneda.lean</code>!</p>



<a name="271407690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271407690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271407690">(Feb 10 2022 at 09:49)</a>:</h4>
<p>And for non-category theory, <code>analysis/calculus/extend_deriv.lean</code></p>



<a name="271422084"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271422084" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271422084">(Feb 10 2022 at 12:09)</a>:</h4>
<p>Thanks!! This is really nice.<br>
A possibility for those files that just have overhead is to force them to rank bad in the queue. But this is already cool!</p>



<a name="271434392"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271434392" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271434392">(Feb 10 2022 at 13:59)</a>:</h4>
<p>Could the last column be changed to <code>ms/LOC</code> so it's easier to see the range (currently from ~1ms to ~5000ms)?</p>



<a name="271434875"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271434875" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271434875">(Feb 10 2022 at 14:02)</a>:</h4>
<p>I'm going to take a look at <a href="https://github.com/JLimperg/mathlib-bench">https://github.com/JLimperg/mathlib-bench</a> later today</p>



<a name="271435610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271435610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271435610">(Feb 10 2022 at 14:08)</a>:</h4>
<p>If you don't mind another (very unimportant) wishlist item: is there an easy way to add a link to the relevant docs page for each file?</p>



<a name="271435756"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271435756" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271435756">(Feb 10 2022 at 14:09)</a>:</h4>
<p>Linking to the source on github for the specified commit would probably be useful to</p>



<a name="271436156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271436156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271436156">(Feb 10 2022 at 14:12)</a>:</h4>
<p>Although the json is all available on the website anyway, so you can always just make your own viewer that consumes it, like Bryan did.</p>



<a name="271474418"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271474418" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271474418">(Feb 10 2022 at 18:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127136">Alex J. Best</span> <a href="#narrow/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs/near/271407597">said</a>:</p>
<blockquote>
<p>Looks like the real winner is <code>category_theory/linear/yoneda.lean</code>!</p>
</blockquote>
<p>This</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">linear_yoneda</span> <span class="o">:</span> <span class="n">C</span> <span class="bp">⥤</span> <span class="n">C</span><span class="bp">ᵒᵖ</span> <span class="bp">⥤</span> <span class="n">Module</span> <span class="n">R</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">X</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">Y</span><span class="o">,</span> <span class="n">Module.of</span> <span class="n">R</span> <span class="o">(</span><span class="n">unop</span> <span class="n">Y</span> <span class="bp">⟶</span> <span class="n">X</span><span class="o">),</span>
    <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">Y</span> <span class="n">Y'</span> <span class="n">f</span><span class="o">,</span> <span class="n">linear.left_comp</span> <span class="n">R</span> <span class="n">_</span> <span class="n">f.unop</span><span class="o">,</span>
    <span class="n">map_comp'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="kd">begin</span> <span class="n">ext</span><span class="o">,</span> <span class="n">dsimp</span><span class="o">,</span> <span class="n">erw</span> <span class="o">[</span><span class="n">category.assoc</span><span class="o">]</span> <span class="kd">end</span><span class="o">,</span>
    <span class="n">map_id'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">Y</span><span class="o">,</span> <span class="kd">begin</span> <span class="n">ext</span><span class="o">,</span> <span class="n">dsimp</span><span class="o">,</span> <span class="n">erw</span> <span class="o">[</span><span class="n">category.id_comp</span><span class="o">]</span> <span class="kd">end</span> <span class="o">},</span>
  <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">X</span> <span class="n">X'</span> <span class="n">f</span><span class="o">,</span> <span class="o">{</span> <span class="n">app</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">Y</span><span class="o">,</span> <span class="n">linear.right_comp</span> <span class="n">R</span> <span class="n">_</span> <span class="n">f</span> <span class="o">},</span>
  <span class="n">map_id'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">X</span><span class="o">,</span> <span class="kd">by</span> <span class="o">{</span> <span class="n">ext</span><span class="o">,</span> <span class="n">simp</span> <span class="o">},</span>
  <span class="n">map_comp'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="kd">by</span> <span class="o">{</span> <span class="n">ext</span><span class="o">,</span> <span class="n">simp</span> <span class="o">}</span> <span class="o">}</span>
</code></pre></div>
<p>cuts down compile time from 7 seconds to 3.5 on my computer (supplying proofs of the last <code>map_id'</code> and <code>map_comp'</code> instead of getting <code>tidy</code> to prove them). It will make Scott sad though (he once coherently argued to me that the whole point was to get the computer to do the boring parts)</p>



<a name="271474865"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271474865" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271474865">(Feb 10 2022 at 18:37)</a>:</h4>
<p>But it also gets boring to wait for the computer to do the same boring work over and over <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="271511325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271511325" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271511325">(Feb 10 2022 at 23:44)</a>:</h4>
<p>What the heck? <code>tidy</code> just made a 10 line proof of a lemma I had no idea how to prove. How did I miss this awesome tactic for the past year?</p>



<a name="271511389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271511389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271511389">(Feb 10 2022 at 23:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs/near/271474865">said</a>:</p>
<blockquote>
<p>But it also gets boring to wait for the computer to do the same boring work over and over <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>
</blockquote>
<p>Seems like you can do <code>tidy?</code> to see what tidy finds and substitute it so you don't have to wait.</p>



<a name="271511554"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271511554" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271511554">(Feb 10 2022 at 23:47)</a>:</h4>
<p>Yeah, that's what I did on a PR. But some proofs got longer (even after some golfing)</p>
<p><a href="https://github.com/leanprover-community/mathlib/pull/11746">#11746</a> (not merged)</p>



<a name="271599226"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271599226" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271599226">(Feb 11 2022 at 16:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110038">Kevin Buzzard</span> <a href="#narrow/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs/near/271474418">said</a>:</p>
<blockquote>
<p>This [...] cuts down compile time from 7 seconds to 3.5 on my computer (supplying proofs of the last <code>map_id'</code> and <code>map_comp'</code> instead of getting <code>tidy</code> to prove them).</p>
</blockquote>
<p>I've just PRed this (with credit to you, of course) in <a href="https://github.com/leanprover-community/mathlib/pull/11979">#11979</a>, and similarly removed some uses of <code>obvious</code> in <code>category_theory/monad/equiv_mon</code> in <a href="https://github.com/leanprover-community/mathlib/pull/11980">#11980</a>.  It'll be interesting to see how much difference this makes to the stats.</p>



<a name="271599884"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271599884" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271599884">(Feb 11 2022 at 16:21)</a>:</h4>
<p>I don't think the difference will be noticeable given the variance of the build time</p>



<a name="271599914"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271599914" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271599914">(Feb 11 2022 at 16:21)</a>:</h4>
<p>What's the point in removing <code>tidy</code> exactly?</p>



<a name="271600032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271600032" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271600032">(Feb 11 2022 at 16:22)</a>:</h4>
<p>I understand that it can be slow, but unless something breaks with timeouts (like what happened with the Cech nerve a little while ago), I'm inclined to keep the automatic proofs in place.</p>



<a name="271600360"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271600360" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271600360">(Feb 11 2022 at 16:25)</a>:</h4>
<p>In either case it's good to record that tidy generated or can generate the proof as a comment. So if the proof breaks it's easy to fix by re-tidying and to remind people that some of these proofs aren't really intended to be hand written</p>



<a name="271600389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271600389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271600389">(Feb 11 2022 at 16:25)</a>:</h4>
<p>If the goal is to eventually move to lean 4, where tactics like this should be much faster, then why would we do this? Will you replace the non-automatic proofs with the automatic ones once the port to lean4 happens?</p>



<a name="271600759"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271600759" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271600759">(Feb 11 2022 at 16:28)</a>:</h4>
<p><del>Just something to chew, but keeping automatic proofs in code may make their development harder because one can't reason on trade-offs of the kind "this PR makes &lt;auto-tactic&gt; prove 5 times the number of proofs it was able to in half of the time it used to, but some few cases are no longer provable by it"</del> (Unless the improvement PR also replaces the proofs it wasn't able to prove with something that works)</p>



<a name="271600765"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271600765" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271600765">(Feb 11 2022 at 16:28)</a>:</h4>
<p>I feel like most <code>tidy</code>able goals can be done with <code>ext, dsimp, simp</code>. Should we replace <code>obviously</code> with <code>by { ext, dsimp, simp } &lt;|&gt; old_obviously</code>?</p>



<a name="271601877"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271601877" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271601877">(Feb 11 2022 at 16:37)</a>:</h4>
<p>The aim here was just to try to speed up two of the slowest files (in ms/LOC) and to see how much time can be shaved off.  Searching for <code>obviously</code> throughout mathlib turns up lots of comments like "Relying on <code>obviously</code> to fill out these proofs is very slow :(", so it seemed worth trying.</p>
<p>The explicit proofs are generally of the form <code>ext, simp</code> or <code>intros, refl</code>, so nothing particularly clever or fragile.</p>



<a name="271602055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271602055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271602055">(Feb 11 2022 at 16:38)</a>:</h4>
<p>What I'm saying is that the solution should not be to remove the automation, but rather to <em>improve</em> the automation.</p>



<a name="271602382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271602382" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271602382">(Feb 11 2022 at 16:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243562">Adam Topaz</span> <a href="#narrow/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs/near/271600765">said</a>:</p>
<blockquote>
<p>I feel like most <code>tidy</code>able goals can be done with <code>ext, dsimp, simp</code>. Should we replace <code>obviously</code> with <code>by { ext, dsimp, simp } &lt;|&gt; old_obviously</code>?</p>
</blockquote>
<p>Implementation detail: the last <code>simp</code> might fail if <code>dsimp</code> closes the goal, forcing it to try <code>old_obviously</code> unnecessarily</p>



<a name="271602407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271602407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271602407">(Feb 11 2022 at 16:40)</a>:</h4>
<p>Certainly, much nicer to have obvious things proved without even having to mention them.</p>



<a name="271602577"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271602577" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271602577">(Feb 11 2022 at 16:41)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic</span>

<span class="kd">meta</span> <span class="kd">def</span> <span class="n">hacky_obviously</span> <span class="o">:=</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">try</span> <span class="o">{</span><span class="n">intros</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">refl</span><span class="o">},</span> <span class="n">done</span><span class="o">]</span> <span class="bp">&lt;|&gt;</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">try</span> <span class="o">{</span><span class="n">intros</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">ext</span> <span class="o">:</span> <span class="mi">1</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">dsimp</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">simp</span><span class="o">},</span> <span class="n">done</span><span class="o">]</span> <span class="bp">&lt;|&gt;</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">try</span> <span class="o">{</span><span class="n">intros</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">ext</span> <span class="o">:</span> <span class="mi">2</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">dsimp</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">simp</span><span class="o">},</span> <span class="n">done</span><span class="o">]</span> <span class="bp">&lt;|&gt;</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">try</span> <span class="o">{</span><span class="n">intros</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">ext</span> <span class="o">:</span> <span class="mi">3</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">dsimp</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">simp</span><span class="o">},</span> <span class="n">done</span><span class="o">]</span> <span class="bp">&lt;|&gt;</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">try</span> <span class="o">{</span><span class="n">intros</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">ext</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">dsimp</span><span class="o">},</span> <span class="n">try</span> <span class="o">{</span><span class="n">simp</span><span class="o">},</span> <span class="n">done</span><span class="o">]</span> <span class="bp">&lt;|&gt;</span>
  <span class="n">obviously'</span>
</code></pre></div>



<a name="271603070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271603070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271603070">(Feb 11 2022 at 16:45)</a>:</h4>
<p>Maybe with a few additional <code>refl</code>s?</p>



<a name="271603576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271603576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271603576">(Feb 11 2022 at 16:49)</a>:</h4>
<p>Do we understand what is going on in examples where <code>tidy</code> is slow but these other suggestions are fast?</p>



<a name="271603634"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271603634" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271603634">(Feb 11 2022 at 16:49)</a>:</h4>
<p>(e.g. trying <code>refl</code> that fails might be slow?)</p>



<a name="271603674"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271603674" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271603674">(Feb 11 2022 at 16:49)</a>:</h4>
<p>A simple idea is just to run <code>tidy</code> itself but at reducible transparency level</p>



<a name="271775225"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271775225" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271775225">(Feb 14 2022 at 00:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs/near/271422084">said</a>:</p>
<blockquote>
<p>Thanks!! This is really nice.<br>
A possibility for those files that just have overhead is to force them to rank bad in the queue. But this is already cool!</p>
<p>Another possibility is to subtract some empirical overhead (apparently ~3s) from the numerator, capping at zero, before dividing by <code>LOC</code> (this is probably easier to implement)</p>
</blockquote>
<p>I did a simple linear regression on that data</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">&gt;&gt;&gt;</span> <span class="n">model</span> <span class="bp">=</span> <span class="n">LinearRegression</span><span class="o">()</span><span class="bp">.</span><span class="n">fit</span><span class="o">(</span><span class="n">data</span><span class="o">[[</span><span class="s2">"loc"</span><span class="o">]],</span> <span class="n">data</span><span class="o">[</span><span class="s2">"time"</span><span class="o">])</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">model.coef_</span>
<span class="n">array</span><span class="o">([</span><span class="mi">0</span><span class="bp">.</span><span class="mi">03309283</span><span class="o">])</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">model.intercept_</span>
<span class="mi">4</span><span class="bp">.</span><span class="mi">108744359416694</span>
</code></pre></div>
<p>After subtracting the timings by 4.11, redoing the ratio and reordering, these are the new top 30 files:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">&gt;&gt;&gt;</span> <span class="n">data</span><span class="o">[[</span><span class="s2">"time"</span><span class="o">,</span> <span class="s2">"loc"</span><span class="o">,</span> <span class="s2">"time_fixed"</span><span class="o">,</span> <span class="s2">"ratio"</span><span class="o">]]</span><span class="bp">.</span><span class="n">head</span><span class="o">(</span><span class="mi">30</span><span class="o">)</span>
                                                          <span class="n">time</span>  <span class="n">loc</span>  <span class="n">time_fixed</span>     <span class="n">ratio</span>
<span class="n">number_theory</span><span class="bp">/</span><span class="n">padics</span><span class="bp">/</span><span class="n">default.lean</span>                     <span class="mi">5</span><span class="bp">.</span><span class="mi">039645</span>    <span class="mi">1</span>    <span class="mi">0</span><span class="bp">.</span><span class="mi">929645</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">929645</span>
<span class="n">topology</span><span class="bp">/</span><span class="n">continuous_function</span><span class="bp">/</span><span class="n">locally_constant.lean</span>   <span class="mi">19</span><span class="bp">.</span><span class="mi">322954</span>   <span class="mi">28</span>   <span class="mi">15</span><span class="bp">.</span><span class="mi">212954</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">543320</span>
<span class="n">category_theory</span><span class="bp">/</span><span class="n">triangulated</span><span class="bp">/</span><span class="n">rotate.lean</span>             <span class="mi">77</span><span class="bp">.</span><span class="mi">534261</span>  <span class="mi">138</span>   <span class="mi">73</span><span class="bp">.</span><span class="mi">424261</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">532060</span>
<span class="n">algebra</span><span class="bp">/</span><span class="n">homology</span><span class="bp">/</span><span class="n">flip.lean</span>                           <span class="mi">35</span><span class="bp">.</span><span class="mi">378277</span>   <span class="mi">60</span>   <span class="mi">31</span><span class="bp">.</span><span class="mi">268277</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">521138</span>
<span class="n">analysis</span><span class="bp">/</span><span class="n">calculus</span><span class="bp">/</span><span class="n">extend_deriv.lean</span>                  <span class="mi">83</span><span class="bp">.</span><span class="mi">843026</span>  <span class="mi">158</span>   <span class="mi">79</span><span class="bp">.</span><span class="mi">733026</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">504639</span>
<span class="n">category_theory</span><span class="bp">/</span><span class="n">linear</span><span class="bp">/</span><span class="n">yoneda.lean</span>                   <span class="mi">29</span><span class="bp">.</span><span class="mi">376513</span>   <span class="mi">53</span>   <span class="mi">25</span><span class="bp">.</span><span class="mi">266513</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">476727</span>
<span class="n">category_theory</span><span class="bp">/</span><span class="n">monoidal</span><span class="bp">/</span><span class="n">internal</span><span class="bp">/</span><span class="n">functor_categ...</span>   <span class="mi">65</span><span class="bp">.</span><span class="mi">362993</span>  <span class="mi">135</span>   <span class="mi">61</span><span class="bp">.</span><span class="mi">252993</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">453726</span>
<span class="n">category_theory</span><span class="bp">/</span><span class="n">monoidal</span><span class="bp">/</span><span class="n">internal</span><span class="bp">/</span><span class="n">types.lean</span>         <span class="mi">34</span><span class="bp">.</span><span class="mi">909689</span>   <span class="mi">71</span>   <span class="mi">30</span><span class="bp">.</span><span class="mi">799689</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">433798</span>
<span class="n">linear_algebra</span><span class="bp">/</span><span class="n">clifford_algebra</span><span class="bp">/</span><span class="n">conjugation.lean</span>     <span class="mi">36</span><span class="bp">.</span><span class="mi">738326</span>   <span class="mi">76</span>   <span class="mi">32</span><span class="bp">.</span><span class="mi">628326</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">429320</span>
<span class="n">geometry</span><span class="bp">/</span><span class="n">euclidean</span><span class="bp">/</span><span class="n">default.lean</span>                       <span class="mi">5</span><span class="bp">.</span><span class="mi">771453</span>    <span class="mi">4</span>    <span class="mi">1</span><span class="bp">.</span><span class="mi">661453</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">415363</span>
<span class="n">algebraic_geometry</span><span class="bp">/</span><span class="n">pullbacks.lean</span>                   <span class="mi">187</span><span class="bp">.</span><span class="mi">383844</span>  <span class="mi">455</span>  <span class="mi">183</span><span class="bp">.</span><span class="mi">273844</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">402800</span>
<span class="n">algebra</span><span class="bp">/</span><span class="n">homology</span><span class="bp">/</span><span class="n">differential_object.lean</span>            <span class="mi">41</span><span class="bp">.</span><span class="mi">252757</span>   <span class="mi">99</span>   <span class="mi">37</span><span class="bp">.</span><span class="mi">142757</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">375179</span>
<span class="n">control</span><span class="bp">/</span><span class="n">equiv_functor</span><span class="bp">/</span><span class="n">instances.lean</span>                  <span class="mi">8</span><span class="bp">.</span><span class="mi">051191</span>   <span class="mi">11</span>    <span class="mi">3</span><span class="bp">.</span><span class="mi">941191</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">358290</span>
<span class="n">category_theory</span><span class="bp">/</span><span class="n">monoidal</span><span class="bp">/</span><span class="n">CommMon_.lean</span>               <span class="mi">40</span><span class="bp">.</span><span class="mi">622094</span>  <span class="mi">102</span>   <span class="mi">36</span><span class="bp">.</span><span class="mi">512094</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">357962</span>
<span class="n">analysis</span><span class="bp">/</span><span class="n">inner_product_space</span><span class="bp">/</span><span class="n">lax_milgram.lean</span>        <span class="mi">32</span><span class="bp">.</span><span class="mi">601701</span>   <span class="mi">81</span>   <span class="mi">28</span><span class="bp">.</span><span class="mi">491701</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">351749</span>
<span class="n">linear_algebra</span><span class="bp">/</span><span class="n">free_module</span><span class="bp">/</span><span class="n">strong_rank_conditio...</span>   <span class="mi">12</span><span class="bp">.</span><span class="mi">949288</span>   <span class="mi">26</span>    <span class="mi">8</span><span class="bp">.</span><span class="mi">839288</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">339973</span>
<span class="n">algebra</span><span class="bp">/</span><span class="n">lie</span><span class="bp">/</span><span class="n">universal_enveloping.lean</span>                <span class="mi">22</span><span class="bp">.</span><span class="mi">128558</span>   <span class="mi">54</span>   <span class="mi">18</span><span class="bp">.</span><span class="mi">018558</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">333677</span>
<span class="n">category_theory</span><span class="bp">/</span><span class="n">monad</span><span class="bp">/</span><span class="n">equiv_mon.lean</span>                 <span class="mi">31</span><span class="bp">.</span><span class="mi">273470</span>   <span class="mi">82</span>   <span class="mi">27</span><span class="bp">.</span><span class="mi">163470</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">331262</span>
<span class="n">topology</span><span class="bp">/</span><span class="n">sheaves</span><span class="bp">/</span><span class="n">presheaf_of_functions.lean</span>          <span class="mi">25</span><span class="bp">.</span><span class="mi">039205</span>   <span class="mi">65</span>   <span class="mi">20</span><span class="bp">.</span><span class="mi">929205</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">321988</span>
<span class="n">analysis</span><span class="bp">/</span><span class="n">fourier.lean</span>                                <span class="mi">52</span><span class="bp">.</span><span class="mi">368428</span>  <span class="mi">150</span>   <span class="mi">48</span><span class="bp">.</span><span class="mi">258428</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">321723</span>
<span class="n">geometry</span><span class="bp">/</span><span class="n">manifold</span><span class="bp">/</span><span class="n">algebra</span><span class="bp">/</span><span class="n">left_invariant_deriva...</span>   <span class="mi">41</span><span class="bp">.</span><span class="mi">657494</span>  <span class="mi">120</span>   <span class="mi">37</span><span class="bp">.</span><span class="mi">547494</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">312896</span>
<span class="n">analysis</span><span class="bp">/</span><span class="n">inner_product_space</span><span class="bp">/</span><span class="n">spectrum.lean</span>           <span class="mi">47</span><span class="bp">.</span><span class="mi">181419</span>  <span class="mi">138</span>   <span class="mi">43</span><span class="bp">.</span><span class="mi">071419</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">312112</span>
<span class="n">category_theory</span><span class="bp">/</span><span class="n">adjunction</span><span class="bp">/</span><span class="n">whiskering.lean</span>           <span class="mi">15</span><span class="bp">.</span><span class="mi">568603</span>   <span class="mi">37</span>   <span class="mi">11</span><span class="bp">.</span><span class="mi">458603</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">309692</span>
<span class="n">category_theory</span><span class="bp">/</span><span class="n">fin_category.lean</span>                    <span class="mi">20</span><span class="bp">.</span><span class="mi">668713</span>   <span class="mi">54</span>   <span class="mi">16</span><span class="bp">.</span><span class="mi">558713</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">306643</span>
<span class="n">algebra</span><span class="bp">/</span><span class="n">lie</span><span class="bp">/</span><span class="n">matrix.lean</span>                              <span class="mi">16</span><span class="bp">.</span><span class="mi">942918</span>   <span class="mi">43</span>   <span class="mi">12</span><span class="bp">.</span><span class="mi">832918</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">298440</span>
<span class="n">analysis</span><span class="bp">/</span><span class="n">normed_space</span><span class="bp">/</span><span class="n">weak_dual.lean</span>                 <span class="mi">25</span><span class="bp">.</span><span class="mi">537664</span>   <span class="mi">73</span>   <span class="mi">21</span><span class="bp">.</span><span class="mi">427664</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">293530</span>
<span class="n">algebra</span><span class="bp">/</span><span class="n">category</span><span class="bp">/</span><span class="n">Module</span><span class="bp">/</span><span class="n">abelian.lean</span>                 <span class="mi">17</span><span class="bp">.</span><span class="mi">242939</span>   <span class="mi">48</span>   <span class="mi">13</span><span class="bp">.</span><span class="mi">132939</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">273603</span>
<span class="n">algebra</span><span class="bp">/</span><span class="n">homology</span><span class="bp">/</span><span class="n">additive.lean</span>                       <span class="mi">48</span><span class="bp">.</span><span class="mi">411229</span>  <span class="mi">162</span>   <span class="mi">44</span><span class="bp">.</span><span class="mi">301229</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">273464</span>
<span class="n">measure_theory</span><span class="bp">/</span><span class="n">probability_mass_function</span><span class="bp">/</span><span class="n">monad....</span>   <span class="mi">69</span><span class="bp">.</span><span class="mi">939399</span>  <span class="mi">244</span>   <span class="mi">65</span><span class="bp">.</span><span class="mi">829399</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">269793</span>
<span class="n">algebraic_topology</span><span class="bp">/</span><span class="n">Moore_complex.lean</span>                <span class="mi">25</span><span class="bp">.</span><span class="mi">858943</span>   <span class="mi">81</span>   <span class="mi">21</span><span class="bp">.</span><span class="mi">748943</span>  <span class="mi">0</span><span class="bp">.</span><span class="mi">268505</span>
</code></pre></div>



<a name="271798708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271798708" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Stuart Presnell <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271798708">(Feb 14 2022 at 08:58)</a>:</h4>
<p><code>category_theory/monad/equiv_mon.lean                 31.273470</code><br>
Just as a data point, the temporary changes I made to this file in <a href="https://github.com/leanprover-community/mathlib/pull/11980">#11980</a> have cut its compile time down from 45s (<a href="https://mathlib-bench.limperg.de/commit/352e06424adc5b5de32cff69c12e3acddfc192c1">https://mathlib-bench.limperg.de/commit/352e06424adc5b5de32cff69c12e3acddfc192c1</a>) to 31s.  So there's plenty of scope to make <code>obviously</code> do its magic more quickly.</p>
<p>(with the caveat that compile times are quite variable from one run to the next, etc.)</p>



<a name="271826699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60tidy%60%20in%20mathlib%20proofs/near/271826699" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60tidy.60.20in.20mathlib.20proofs.html#271826699">(Feb 14 2022 at 13:39)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/pull/12031">#12031</a> targets <code>category_theory/triangulated/rotate.lean</code> (3rd file in the list above). Compilation time dropped from ~100s to ~70s on my machine. It also removes some non-terminal <code>simp</code>s</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>