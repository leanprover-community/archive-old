---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html">Deterministic timeout when proving a theorem</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="193546490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193546490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Donald Sebastian Leung <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193546490">(Apr 10 2020 at 08:00)</a>:</h4>
<p>So I'm using Lean v3.7.2 with mathlib commit <code>732f7109c5cb2ece35481c200faa38fbbb4dc995</code> and encountered a deterministic timeout when trying to prove a theorem, which is certainly a first for me:</p>
<p><code>Preloaded.lean</code>:</p>
<div class="codehilite"><pre><span></span><span class="kn">inductive</span> <span class="n">times_3_plus_5</span> <span class="o">:</span> <span class="n">set</span> <span class="bp">ℕ</span>
<span class="bp">|</span> <span class="n">start</span> <span class="o">:</span>
    <span class="n">times_3_plus_5</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="n">times_3</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span>
    <span class="n">times_3_plus_5</span> <span class="n">n</span> <span class="bp">→</span>
    <span class="n">times_3_plus_5</span> <span class="o">(</span><span class="n">n</span> <span class="bp">*</span> <span class="mi">3</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">plus_5</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span>
    <span class="n">times_3_plus_5</span> <span class="n">n</span> <span class="bp">→</span>
    <span class="n">times_3_plus_5</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">5</span><span class="o">)</span>

<span class="n">def</span> <span class="n">decide</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">bool</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">n</span> <span class="err">%</span> <span class="mi">5</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">ff</span>
  <span class="bp">|</span> <span class="mi">2</span> <span class="o">:=</span> <span class="mi">27</span> <span class="bp">≤</span> <span class="n">n</span>
  <span class="bp">|</span> <span class="mi">4</span> <span class="o">:=</span> <span class="mi">9</span> <span class="bp">≤</span> <span class="n">n</span>
  <span class="bp">|</span> <span class="bp">_</span> <span class="o">:=</span> <span class="n">tt</span>
  <span class="kn">end</span>

<span class="n">def</span> <span class="n">SUBMISSION</span> <span class="o">:=</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span> <span class="n">times_3_plus_5</span> <span class="n">n</span> <span class="bp">↔</span> <span class="n">decide</span> <span class="n">n</span> <span class="bp">=</span> <span class="n">tt</span>
<span class="kn">notation</span> <span class="bp">`</span><span class="n">SUBMISSION</span><span class="bp">`</span> <span class="o">:=</span> <span class="n">SUBMISSION</span>
</pre></div>


<p><code>Solution.lean</code>:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">Preloaded</span> <span class="n">tactic</span> <span class="n">data</span><span class="bp">.</span><span class="n">nat</span><span class="bp">.</span><span class="n">modeq</span>

<span class="kn">open</span> <span class="n">times_3_plus_5</span> <span class="n">nat</span> <span class="n">nat</span><span class="bp">.</span><span class="n">modeq</span>

<span class="kn">theorem</span> <span class="n">decide_works</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">times_3_plus_5</span> <span class="n">n</span> <span class="bp">↔</span> <span class="n">decide</span> <span class="n">n</span> <span class="bp">=</span> <span class="n">tt</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">split</span><span class="bp">;</span> <span class="n">simp</span> <span class="o">[</span><span class="n">decide</span><span class="o">]</span><span class="bp">;</span> <span class="n">intros</span> <span class="n">h</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">induction</span> <span class="n">h</span><span class="o">,</span>
    <span class="n">case</span> <span class="n">start</span> <span class="o">:</span> <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="n">case</span> <span class="n">times_3</span> <span class="o">:</span> <span class="n">m</span> <span class="n">hm</span> <span class="n">ihm</span> <span class="o">{</span>
      <span class="k">have</span> <span class="n">hm5</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">&lt;</span> <span class="mi">5</span> <span class="o">:=</span> <span class="n">mod_lt</span> <span class="n">m</span> <span class="n">dec_trivial</span><span class="o">,</span>
      <span class="n">interval_cases</span> <span class="o">(</span><span class="n">m</span> <span class="err">%</span> <span class="mi">5</span><span class="o">),</span>
      <span class="o">{</span> <span class="n">rw</span> <span class="n">lh</span> <span class="n">at</span> <span class="n">ihm</span><span class="o">,</span> <span class="n">contradiction</span> <span class="o">},</span>
      <span class="o">{</span> <span class="k">have</span> <span class="n">hm1</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">1</span> <span class="err">%</span> <span class="mi">5</span><span class="o">,</span> <span class="k">by</span> <span class="n">assumption</span><span class="o">,</span>
        <span class="k">have</span> <span class="n">hm3</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">1</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="o">:=</span> <span class="n">modeq_mul_right</span> <span class="bp">_</span> <span class="n">hm1</span><span class="o">,</span>
        <span class="n">rw</span> <span class="n">hm3</span><span class="o">,</span>
        <span class="n">refl</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">rw</span> <span class="n">lh</span> <span class="n">at</span> <span class="n">ihm</span><span class="o">,</span>
        <span class="n">simp</span> <span class="o">[</span><span class="n">decide</span><span class="o">]</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
        <span class="k">have</span> <span class="n">hm2</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">2</span> <span class="err">%</span> <span class="mi">5</span><span class="o">,</span> <span class="k">by</span> <span class="n">assumption</span><span class="o">,</span>
        <span class="k">have</span> <span class="n">hm3</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">2</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="o">:=</span> <span class="n">modeq_mul_right</span> <span class="bp">_</span> <span class="n">hm2</span><span class="o">,</span>
        <span class="n">rw</span> <span class="n">hm3</span><span class="o">,</span>
        <span class="n">refl</span> <span class="o">},</span>
      <span class="o">{</span> <span class="k">have</span> <span class="n">hm3</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span><span class="o">,</span> <span class="k">by</span> <span class="n">assumption</span><span class="o">,</span>
        <span class="k">have</span> <span class="n">hm4</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">4</span> <span class="o">:=</span> <span class="n">modeq_mul_right</span> <span class="bp">_</span> <span class="n">hm3</span><span class="o">,</span>
        <span class="n">rw</span> <span class="n">hm4</span><span class="o">,</span>
        <span class="n">simp</span> <span class="o">[</span><span class="n">decide</span><span class="o">],</span>
        <span class="n">generalize</span> <span class="n">h</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="bp">=</span> <span class="n">m&#39;</span><span class="o">,</span>
        <span class="n">iterate</span> <span class="mi">9</span> <span class="o">{</span> <span class="n">all_goals</span> <span class="o">{</span> <span class="n">try</span> <span class="o">{</span> <span class="n">cases</span> <span class="n">m&#39;</span> <span class="o">}</span> <span class="o">}</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">rw</span> <span class="n">h</span> <span class="n">at</span> <span class="n">hm4</span><span class="bp">;</span> <span class="n">contradiction</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">},</span>
        <span class="o">{</span> <span class="k">have</span> <span class="n">hm1</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">=</span> <span class="mi">1</span><span class="o">,</span> <span class="k">by</span> <span class="n">omega</span><span class="o">,</span> <span class="n">subst</span> <span class="n">hm1</span><span class="o">,</span> <span class="n">cases</span> <span class="n">lh</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">},</span>
        <span class="o">{</span> <span class="k">have</span> <span class="n">hm2</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">=</span> <span class="mi">2</span><span class="o">,</span> <span class="k">by</span> <span class="n">omega</span><span class="o">,</span> <span class="n">subst</span> <span class="n">hm2</span><span class="o">,</span> <span class="n">cases</span> <span class="n">lh</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">}</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">sorry</span> <span class="o">}</span>
    <span class="o">},</span>
    <span class="n">case</span> <span class="n">plus_5</span> <span class="o">:</span> <span class="o">{</span> <span class="n">sorry</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">sorry</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>


<p>As far as I can see, all the tactics I've used so far succeed, but I get a red squiggly line just below the <code>theorem</code> in <code>theorem decide_works ...</code>, and upon hovering my mouse over it, it says <code>(deterministic) timeout</code>. The thing is, I've written proofs that take way longer than this one to compile (&gt; 30s compared to maybe about 10s on this one) and have not seen such an error before so was this timing restriction added recently, or am I missing something?</p>



<a name="193546872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193546872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193546872">(Apr 10 2020 at 08:05)</a>:</h4>
<p>yay you're translating more kata</p>



<a name="193546928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193546928" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193546928">(Apr 10 2020 at 08:06)</a>:</h4>
<p>deterministic timeout has always existed (and always will)</p>



<a name="193546939"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193546939" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193546939">(Apr 10 2020 at 08:06)</a>:</h4>
<p>the multitude of <code>omega</code> may or may not be the cause</p>



<a name="193548487"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193548487" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Donald Sebastian Leung <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193548487">(Apr 10 2020 at 08:31)</a>:</h4>
<p>So a tactic-mode proof cannot have too many steps? In that case maybe I'll try extracting out a few lemmas and see if it helps.</p>



<a name="193548668"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193548668" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193548668">(Apr 10 2020 at 08:34)</a>:</h4>
<p>You can turn off the timeout, and I think it is disabled by default if you run lean via the command line</p>



<a name="193549971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193549971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Donald Sebastian Leung <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193549971">(Apr 10 2020 at 08:54)</a>:</h4>
<p>Thanks. In any case, it seems that it was indeed the excessive use of <code>omega</code> which caused the timeout. I pulled out all uses of <code>omega</code> into separate lemmas and that seems to have solved my timeout issues, at least for now.</p>



<a name="193551327"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193551327" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193551327">(Apr 10 2020 at 09:13)</a>:</h4>
<p>I think there is some underlying weirdness going on here. Here's a situation where I prove one goal with <code>omega</code> in two different situations, and it takes 0.08 seconds in the first and 3 seconds in the second one on my machine, to solve exactly the same goal.</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span>  <span class="n">tactic</span> <span class="n">data</span><span class="bp">.</span><span class="n">nat</span><span class="bp">.</span><span class="n">modeq</span>

<span class="kn">inductive</span> <span class="n">times_3_plus_5</span> <span class="o">:</span> <span class="n">set</span> <span class="bp">ℕ</span>
<span class="bp">|</span> <span class="n">start</span> <span class="o">:</span>
    <span class="n">times_3_plus_5</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="n">times_3</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span>
    <span class="n">times_3_plus_5</span> <span class="n">n</span> <span class="bp">→</span>
    <span class="n">times_3_plus_5</span> <span class="o">(</span><span class="n">n</span> <span class="bp">*</span> <span class="mi">3</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">plus_5</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span>
    <span class="n">times_3_plus_5</span> <span class="n">n</span> <span class="bp">→</span>
    <span class="n">times_3_plus_5</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">5</span><span class="o">)</span>

<span class="n">def</span> <span class="n">decide</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">bool</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">n</span> <span class="err">%</span> <span class="mi">5</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">ff</span>
  <span class="bp">|</span> <span class="mi">2</span> <span class="o">:=</span> <span class="mi">27</span> <span class="bp">≤</span> <span class="n">n</span>
  <span class="bp">|</span> <span class="mi">4</span> <span class="o">:=</span> <span class="mi">9</span> <span class="bp">≤</span> <span class="n">n</span>
  <span class="bp">|</span> <span class="bp">_</span> <span class="o">:=</span> <span class="n">tt</span>
  <span class="kn">end</span>

<span class="kn">open</span> <span class="n">times_3_plus_5</span> <span class="n">nat</span> <span class="n">nat</span><span class="bp">.</span><span class="n">modeq</span>

<span class="c1">-- I can make Lean solve the following goal in 0 seconds and in 3 seconds with the same tactic</span>

<span class="c">/-</span><span class="cm"></span>
<span class="cm">n m : ℕ,</span>
<span class="cm">hm : times_3_plus_5 m,</span>
<span class="cm">ihm : decide._match_1 m (m % 5) = tt,</span>
<span class="cm">hm5 : m % 5 &lt; 5,</span>
<span class="cm">lh : m % 5 = 3,</span>
<span class="cm">hm3 : m % 5 = 3 % 5,</span>
<span class="cm">hm4 : m * 3 % 5 = 4,</span>
<span class="cm">h : m * 3 = 7</span>
<span class="cm">⊢ 9 ≤ 7</span>
<span class="cm">-/</span>

<span class="kn">set_option</span> <span class="n">profiler</span> <span class="n">true</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">n</span> <span class="n">m</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span>
<span class="o">(</span><span class="n">hm</span> <span class="o">:</span> <span class="n">times_3_plus_5</span> <span class="n">m</span><span class="o">)</span>
<span class="o">(</span><span class="n">ihm</span> <span class="o">:</span> <span class="n">decide</span><span class="bp">._</span><span class="n">match_1</span> <span class="n">m</span> <span class="o">(</span><span class="n">m</span> <span class="err">%</span> <span class="mi">5</span><span class="o">)</span> <span class="bp">=</span> <span class="n">tt</span><span class="o">)</span>
<span class="o">(</span><span class="n">hm5</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">&lt;</span> <span class="mi">5</span><span class="o">)</span>
<span class="o">(</span><span class="n">lh</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">3</span><span class="o">)</span>
<span class="o">(</span><span class="n">hm3</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span><span class="o">)</span>
<span class="o">(</span><span class="n">hm4</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">4</span><span class="o">)</span>
<span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="bp">=</span> <span class="mi">7</span><span class="o">)</span>
<span class="o">:</span> <span class="mi">9</span> <span class="bp">≤</span> <span class="mi">7</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">omega</span> <span class="c1">-- &lt;- finishes almost instantly</span>

<span class="c1">-- Now look in the middle of a proof</span>

<span class="kn">theorem</span> <span class="n">decide_works</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">times_3_plus_5</span> <span class="n">n</span> <span class="bp">↔</span> <span class="n">decide</span> <span class="n">n</span> <span class="bp">=</span> <span class="n">tt</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">split</span><span class="bp">;</span> <span class="n">simp</span> <span class="o">[</span><span class="n">decide</span><span class="o">]</span><span class="bp">;</span> <span class="n">intros</span> <span class="n">h</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">induction</span> <span class="n">h</span><span class="o">,</span>
    <span class="n">case</span> <span class="n">start</span> <span class="o">:</span> <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="n">case</span> <span class="n">times_3</span> <span class="o">:</span> <span class="n">m</span> <span class="n">hm</span> <span class="n">ihm</span> <span class="o">{</span>
      <span class="k">have</span> <span class="n">hm5</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">&lt;</span> <span class="mi">5</span> <span class="o">:=</span> <span class="n">mod_lt</span> <span class="n">m</span> <span class="n">dec_trivial</span><span class="o">,</span>
      <span class="n">interval_cases</span> <span class="o">(</span><span class="n">m</span> <span class="err">%</span> <span class="mi">5</span><span class="o">),</span>
      <span class="o">{</span> <span class="n">rw</span> <span class="n">lh</span> <span class="n">at</span> <span class="n">ihm</span><span class="o">,</span> <span class="n">contradiction</span> <span class="o">},</span>
      <span class="o">{</span> <span class="k">have</span> <span class="n">hm1</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">1</span> <span class="err">%</span> <span class="mi">5</span><span class="o">,</span> <span class="k">by</span> <span class="n">assumption</span><span class="o">,</span>
        <span class="k">have</span> <span class="n">hm3</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">1</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="o">:=</span> <span class="n">modeq_mul_right</span> <span class="bp">_</span> <span class="n">hm1</span><span class="o">,</span>
        <span class="n">rw</span> <span class="n">hm3</span><span class="o">,</span>
        <span class="n">refl</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">rw</span> <span class="n">lh</span> <span class="n">at</span> <span class="n">ihm</span><span class="o">,</span>
        <span class="n">simp</span> <span class="o">[</span><span class="n">decide</span><span class="o">]</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
        <span class="k">have</span> <span class="n">hm2</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">2</span> <span class="err">%</span> <span class="mi">5</span><span class="o">,</span> <span class="k">by</span> <span class="n">assumption</span><span class="o">,</span>
        <span class="k">have</span> <span class="n">hm3</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">2</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="o">:=</span> <span class="n">modeq_mul_right</span> <span class="bp">_</span> <span class="n">hm2</span><span class="o">,</span>
        <span class="n">rw</span> <span class="n">hm3</span><span class="o">,</span>
        <span class="n">refl</span> <span class="o">},</span>
      <span class="o">{</span> <span class="k">have</span> <span class="n">hm3</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span><span class="o">,</span> <span class="k">by</span> <span class="n">assumption</span><span class="o">,</span>
        <span class="k">have</span> <span class="n">hm4</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">4</span> <span class="o">:=</span> <span class="n">modeq_mul_right</span> <span class="bp">_</span> <span class="n">hm3</span><span class="o">,</span>
        <span class="n">rw</span> <span class="n">hm4</span><span class="o">,</span>
        <span class="n">simp</span> <span class="o">[</span><span class="n">decide</span><span class="o">],</span>
        <span class="n">generalize</span> <span class="n">h</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="bp">=</span> <span class="n">m&#39;</span><span class="o">,</span>
        <span class="n">iterate</span> <span class="mi">9</span> <span class="o">{</span> <span class="n">all_goals</span> <span class="o">{</span> <span class="n">try</span> <span class="o">{</span> <span class="n">cases</span> <span class="n">m&#39;</span> <span class="o">}</span> <span class="o">}</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">rw</span> <span class="n">h</span> <span class="n">at</span> <span class="n">hm4</span><span class="bp">;</span> <span class="n">contradiction</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">},</span>
        <span class="o">{</span> <span class="k">have</span> <span class="n">hm1</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">=</span> <span class="mi">1</span><span class="o">,</span> <span class="k">by</span> <span class="n">omega</span><span class="o">,</span> <span class="n">subst</span> <span class="n">hm1</span><span class="o">,</span> <span class="n">cases</span> <span class="n">lh</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span> <span class="o">},</span>
        <span class="o">{</span> <span class="k">have</span> <span class="n">hm2</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">=</span> <span class="mi">2</span><span class="o">,</span> <span class="k">by</span> <span class="n">omega</span><span class="o">,</span> <span class="n">subst</span> <span class="n">hm2</span><span class="o">,</span> <span class="n">cases</span> <span class="n">lh</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">omega</span><span class="o">},</span> <span class="c1">-- &lt;- this omega takes 3 seconds; replace with sorry and observe profiler change</span>
        <span class="n">sorry</span><span class="o">,</span><span class="n">sorry</span><span class="o">},</span><span class="n">sorry</span><span class="o">},</span><span class="n">sorry</span><span class="o">},</span><span class="n">sorry</span><span class="o">,</span><span class="kn">end</span> <span class="c1">-- &lt;- look at profiler output here</span>
</pre></div>



<a name="193551408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193551408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193551408">(Apr 10 2020 at 09:14)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> how can that happen?</p>



<a name="193551666"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193551666" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193551666">(Apr 10 2020 at 09:18)</a>:</h4>
<p>How do I begin to debug this? All I know is how to turn the profiler on. Are there hidden metavariable goals?</p>



<a name="193551899"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193551899" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193551899">(Apr 10 2020 at 09:21)</a>:</h4>
<p>Aah! If I type <code>recover</code> before the omega, then all of a sudden I have 5 goals.</p>



<a name="193551950"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193551950" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193551950">(Apr 10 2020 at 09:22)</a>:</h4>
<p>Does this indicate that something is not clearing up as it should be?</p>



<a name="193552126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193552126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193552126">(Apr 10 2020 at 09:25)</a>:</h4>
<p>Oh -- is that actually expected behaviour of <code>recover</code> when one is in a sub-<code>{}</code> block?</p>



<a name="193552208"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193552208" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193552208">(Apr 10 2020 at 09:26)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">(</span><span class="n">P</span> <span class="n">Q</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">P</span><span class="o">)</span> <span class="o">(</span><span class="n">hq</span> <span class="o">:</span> <span class="n">Q</span><span class="o">)</span> <span class="o">:</span> <span class="n">P</span> <span class="bp">∧</span> <span class="n">Q</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">split</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">recover</span><span class="o">,</span> <span class="n">exact</span> <span class="n">hq</span><span class="o">,</span> <span class="n">exact</span> <span class="n">hp</span><span class="o">},</span>
<span class="kn">end</span>
</pre></div>


<p>Maybe I'm back to square 1.</p>



<a name="193552359"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193552359" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193552359">(Apr 10 2020 at 09:28)</a>:</h4>
<p>I can see two possible ways this could happen: 1) <code>7</code> is not the same as <code>7</code>.  You could enable <code>pp.all</code> and check if the two goals are actually the same.  2) <code>omega</code> is non-deterministic because it depends on the state of the caches, the order of the assumptions, the names of the assumptions, the hash codes of the expressions, etc.</p>



<a name="193552458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193552458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193552458">(Apr 10 2020 at 09:30)</a>:</h4>
<p>I hope that <code>omega</code> only looks at the current goal and not at other metavariables.  So I don't think it's got anything to do with <code>recover</code>.</p>



<a name="193552537"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193552537" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193552537">(Apr 10 2020 at 09:30)</a>:</h4>
<p>7 is indeed not the same as 7. They're both nats though.</p>



<a name="193552557"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193552557" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193552557">(Apr 10 2020 at 09:31)</a>:</h4>
<p><code>(nat.succ (nat.succ (nat.succ (nat.succ (nat.succ (nat.succ (nat.succ nat.zero)))))))</code> v <code>(@bit1.{0} nat nat.has_one nat.has_add (@bit1.{0} nat nat.has_one nat.has_add (@has_one.one.{0} nat nat.has_one)))</code></p>



<a name="193552652"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193552652" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193552652">(Apr 10 2020 at 09:32)</a>:</h4>
<p>Oh nice Gabriel -- this is exactly it!</p>



<a name="193552690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193552690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193552690">(Apr 10 2020 at 09:33)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">omega</span>

<span class="kn">set_option</span> <span class="n">profiler</span> <span class="n">true</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">m</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span>
<span class="o">(</span><span class="n">hm5</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">&lt;</span> <span class="mi">5</span><span class="o">)</span>
<span class="o">(</span><span class="n">lh</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">3</span><span class="o">)</span>
<span class="o">(</span><span class="n">hm3</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span><span class="o">)</span>
<span class="o">(</span><span class="n">hm4</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">4</span><span class="o">)</span>
<span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="bp">=</span> <span class="mi">7</span><span class="o">)</span>
<span class="o">:</span> <span class="mi">9</span> <span class="bp">≤</span> <span class="mi">7</span> <span class="o">:=</span> <span class="k">begin</span>
 <span class="n">omega</span> <span class="c1">-- &lt;- finishes almost instantly</span>
<span class="kn">end</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">m</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span>
<span class="o">(</span><span class="n">hm5</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">&lt;</span> <span class="mi">5</span><span class="o">)</span>
<span class="o">(</span><span class="n">lh</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">3</span><span class="o">)</span>
<span class="o">(</span><span class="n">hm3</span> <span class="o">:</span> <span class="n">m</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span><span class="o">)</span>
<span class="o">(</span><span class="n">hm4</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="err">%</span> <span class="mi">5</span> <span class="bp">=</span> <span class="mi">4</span><span class="o">)</span>
<span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">3</span> <span class="bp">=</span> <span class="mi">7</span><span class="o">)</span>
<span class="o">:</span> <span class="mi">9</span> <span class="bp">≤</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">succ</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">succ</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">succ</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">succ</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">succ</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">succ</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">succ</span> <span class="n">nat</span><span class="bp">.</span><span class="n">zero</span><span class="o">)))))))</span> <span class="o">:=</span> <span class="k">begin</span>
 <span class="n">omega</span> <span class="c1">-- &lt;- takes three seconds</span>
<span class="kn">end</span>
</pre></div>



<a name="193552718"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193552718" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193552718">(Apr 10 2020 at 09:33)</a>:</h4>
<p>The prettyprinter displays them both as 7 and they're both nats</p>



<a name="193553314"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193553314" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193553314">(Apr 10 2020 at 09:41)</a>:</h4>
<p>Here's what's happening: as a preprocessing step, <code>omega</code> replaces <code>nat.succ</code> by <code>+ 1</code>: <a href="https://github.com/leanprover-community/mathlib/blob/f723f37531502d76e9f7a3a27c225884918a70b5/src/tactic/omega/nat/main.lean#L24" title="https://github.com/leanprover-community/mathlib/blob/f723f37531502d76e9f7a3a27c225884918a70b5/src/tactic/omega/nat/main.lean#L24">https://github.com/leanprover-community/mathlib/blob/f723f37531502d76e9f7a3a27c225884918a70b5/src/tactic/omega/nat/main.lean#L24</a>  So instead of <code>7</code> it sees <code>0 + 1 + 1 + 1 + 1 + 1 + 1 +1</code>.</p>



<a name="193553508"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193553508" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193553508">(Apr 10 2020 at 09:44)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/2376" title="https://github.com/leanprover-community/mathlib/issues/2376">#2376</a></p>



<a name="193595308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Deterministic%20timeout%20when%20proving%20a%20theorem/near/193595308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Deterministic.20timeout.20when.20proving.20a.20theorem.html#193595308">(Apr 10 2020 at 17:30)</a>:</h4>
<p><span class="user-mention" data-user-id="264734">@Donald Sebastian Leung</span> there is some issue with <code>omega</code> taking too long, but in your code above if you replace <code>iterate 9 { all_goals { try { cases m' } } }, </code> with <code>iterate 9 { all_goals { try { cases m'; simp } } },</code> you might be back on track.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>