---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/notational.20leakage.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html">notational leakage</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="169636247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169636247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169636247">(Jul 04 2019 at 10:21)</a>:</h4>
<p>My understanding of idiomatic Lean is that a lot of simple terms have some kind of "canonical form", and when writing Lean code (especially simp lemmas) one should write each such term in its canonical form rather than any of the defeq other forms which can be used, because defeq is fine for <code>rfl</code> but not for <code>rw</code>.</p>
<p>In the past, when things have not come out in the "canonical form" which I want them to be, this was user error, because this user in particular had no idea about this canonical form philosophy until recently. </p>
<p>I'm now attempting to stick to it rigidly whilst writing teaching materials. Here is an example where I decide that <code>0</code> (i.e. <code>has_zero.zero</code>) is my canonical form for <code>mynat.zero</code> and then a <code>mynat.zero</code> appears:</p>
<div class="codehilite"><pre><span></span><span class="kn">inductive</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">zero</span> <span class="o">:</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">succ</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>

<span class="c1">-- I want to never see mynat.zero again</span>
<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span><span class="bp">⟩</span>

<span class="kn">namespace</span> <span class="n">mynat</span>

<span class="kn">definition</span> <span class="n">add</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">n</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">n</span>
<span class="bp">|</span> <span class="n">n</span> <span class="o">(</span><span class="n">succ</span> <span class="n">p</span><span class="o">)</span> <span class="o">:=</span> <span class="n">succ</span> <span class="o">(</span><span class="n">add</span> <span class="n">n</span> <span class="n">p</span><span class="o">)</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_add</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span>

<span class="kn">theorem</span> <span class="n">zero_add</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">,</span> <span class="mi">0</span> <span class="bp">+</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">intro</span> <span class="n">x</span><span class="o">,</span>
  <span class="n">induction</span> <span class="n">x</span> <span class="k">with</span> <span class="n">d</span> <span class="n">hd</span><span class="o">,</span>
  <span class="o">{</span> <span class="c1">-- ⊢ 0 + zero = zero -- leakage of &quot;zero&quot; i.e. mynat.zero</span>
    <span class="n">sorry</span>
  <span class="o">},</span>
  <span class="o">{</span> <span class="c1">-- inductive case is fine</span>
    <span class="n">sorry</span>
  <span class="o">}</span>
<span class="kn">end</span>

<span class="c">/-</span><span class="cm"></span>
<span class="cm">⊢ @eq.{1} mynat (@has_add.add.{0} mynat mynat.has_add (@has_zero.zero.{0} mynat mynat.has_zero) mynat.zero) mynat.zero</span>
<span class="cm">-/</span>
</pre></div>


<p>I was thinking I could just fix this with my own induction <em>function</em>, which does all the rewriting of <code>mynat.zero</code> to <code>has_zero.zero</code>. But I can't do it, because the <code>induction</code> tactic eats some new variable names and this is convenient, so I would have to write my own tactic to do this. I don't know where to start with writing tactics though. I think that in practice all I want to do is some kind of <code>repeat {rw (show mynat.zero = (0 : mynat), from rfl) at *},</code> after every application of any tactic which leaks.</p>
<p>Does anyone have any advice on how to make Lean a bit more noob-friendly here? I just want it to work for beginners and them never ever see <code>zero</code>.</p>



<a name="169636552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169636552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169636552">(Jul 04 2019 at 10:25)</a>:</h4>
<p>Also, this doesn't seem to happen when you reprove <code>zero_add</code> for Lean's version of <code>nat</code>, right?</p>



<a name="169636567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169636567" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169636567">(Jul 04 2019 at 10:25)</a>:</h4>
<p>Let me check.</p>



<a name="169636657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169636657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169636657">(Jul 04 2019 at 10:26)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="mi">1</span> <span class="n">goal</span>
<span class="n">case</span> <span class="n">nat</span><span class="bp">.</span><span class="n">zero</span>
<span class="err">⊢</span> <span class="mi">0</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span>
</pre></div>



<a name="169636672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169636672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169636672">(Jul 04 2019 at 10:27)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">zero_add&#39;</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span> <span class="mi">0</span> <span class="bp">+</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">intro</span> <span class="n">x</span><span class="o">,</span>
  <span class="n">induction</span> <span class="n">x</span> <span class="k">with</span> <span class="n">d</span> <span class="n">hd</span><span class="o">,</span>
  <span class="o">{</span> <span class="c1">-- ⊢ 0 + 0 = 0 -- no leakage of &quot;zero&quot;</span>
    <span class="n">sorry</span>
  <span class="o">},</span>
  <span class="o">{</span> <span class="c1">-- inductive case is fine</span>
    <span class="n">sorry</span>
  <span class="o">}</span>
<span class="kn">end</span>
</pre></div>



<a name="169636692"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169636692" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169636692">(Jul 04 2019 at 10:27)</a>:</h4>
<p>So somehow the induction tactic picked up that <code>nat.zero</code> is not canonical form, and it should use <code>0</code>.</p>



<a name="169636770"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169636770" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169636770">(Jul 04 2019 at 10:28)</a>:</h4>
<p>It's not that hard to use a custom recursor, including getting names for the variables in the cases. You just use <code>refine</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">refine</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">rec_on&#39;</span> <span class="n">n</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">m</span> <span class="n">IH</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
</pre></div>



<a name="169636827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169636827" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169636827">(Jul 04 2019 at 10:29)</a>:</h4>
<p>This doesn't happen for <code>nat</code> because the pretty printer has magic to print <code>nat.zero</code> as <code>0</code> even though it's not the same as <code>has_zero.zero nat</code></p>



<a name="169636886"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169636886" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169636886">(Jul 04 2019 at 10:30)</a>:</h4>
<p>so the leakage is still happening, you just can't see it because of the pp</p>



<a name="169637008"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637008" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637008">(Jul 04 2019 at 10:32)</a>:</h4>
<p>We could try writing an <code>induction'</code> which doesn't have a broken <code>using</code> clause. I never use it because the <code>refine</code> version is shorter, but if the using clause was triggered automatically with an attribute that could be a lot of value added for custom recursors</p>



<a name="169637063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637063">(Jul 04 2019 at 10:33)</a>:</h4>
<p>I think this could be quite helpful to beginners...</p>



<a name="169637071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637071">(Jul 04 2019 at 10:33)</a>:</h4>
<p>In some sense the <code>induction</code> tactic is quite useless as it is.</p>



<a name="169637164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637164">(Jul 04 2019 at 10:34)</a>:</h4>
<p>I would wish that <code>refine blah.rec_on _ _ _</code> isn't "idiomatic". Because the informal proof says "use induction on <code>x</code>". It would be great if you could actually type <code>induction x</code> in the Lean proof.</p>



<a name="169637246"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637246" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637246">(Jul 04 2019 at 10:36)</a>:</h4>
<p>And I wouldn't want a <code>using</code> clause, that's very verbose. I'd rather have some sort of attribute.</p>



<a name="169637283"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637283" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637283">(Jul 04 2019 at 10:36)</a>:</h4>
<p>If we tag <code>mynat.custom_rec_on</code> with <code>@induction</code> then the <code>induction'</code> tactic could pick that up, right?</p>



<a name="169637308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637308">(Jul 04 2019 at 10:37)</a>:</h4>
<p>that's the idea</p>



<a name="169637315"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637315" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637315">(Jul 04 2019 at 10:37)</a>:</h4>
<p>I like refine because it's the swiss army knife of lean tactics</p>



<a name="169637370"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637370" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637370">(Jul 04 2019 at 10:38)</a>:</h4>
<p>it's very straightforward to use and less to remember</p>



<a name="169637380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637380">(Jul 04 2019 at 10:38)</a>:</h4>
<p>and it doesn't have gotchas like <code>apply</code></p>



<a name="169637570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637570" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637570">(Jul 04 2019 at 10:41)</a>:</h4>
<p>Sure <code>refine</code> is great as Swiss army knife. But it doesn't give you the semantics that <code>induction</code> has.</p>



<a name="169637621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637621">(Jul 04 2019 at 10:42)</a>:</h4>
<p>If you want people to see in a glance what the idea behind the proof is...</p>



<a name="169637631"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637631" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637631">(Jul 04 2019 at 10:42)</a>:</h4>
<p>Of course you can get almost every where with <code>refine</code>, <code>rw</code> and maybe occasionally a <code>simp [foo,bar]</code>.</p>



<a name="169637678"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169637678" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169637678">(Jul 04 2019 at 10:43)</a>:</h4>
<p>But if you want to write "beautiful, beginner-friendly proofs"...</p>



<a name="169698599"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169698599" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169698599">(Jul 05 2019 at 10:19)</a>:</h4>
<p>What I need are non-leaky tactics, maybe called <code>induction'</code> and <code>cases'</code>, so that</p>
<div class="codehilite"><pre><span></span><span class="n">induction&#39;</span> <span class="n">n</span> <span class="k">with</span> <span class="n">d</span> <span class="n">hd</span><span class="o">,</span>
</pre></div>


<p>is the same as</p>
<div class="codehilite"><pre><span></span>  <span class="n">induction</span> <span class="n">n</span> <span class="k">with</span> <span class="n">d</span> <span class="n">hd</span><span class="o">,</span>
  <span class="n">repeat</span> <span class="o">{</span><span class="n">all_goals</span> <span class="o">{</span><span class="n">rw</span> <span class="o">(</span><span class="k">show</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">),</span> <span class="k">from</span> <span class="n">rfl</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">}},</span>
  <span class="n">repeat</span> <span class="o">{</span><span class="n">all_goals</span> <span class="o">{</span><span class="n">rw</span> <span class="o">(</span><span class="k">show</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">le</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">has_le</span><span class="bp">.</span><span class="n">le</span> <span class="n">mynat</span> <span class="bp">_</span><span class="o">,</span> <span class="k">from</span> <span class="n">rfl</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">}},</span>
</pre></div>


<p>etc etc</p>
<p>and <code>induction'</code> should fail iff <code>induction</code> fails.</p>
<p>Are these trivial to write?</p>



<a name="169698901"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169698901" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169698901">(Jul 05 2019 at 10:25)</a>:</h4>
<p>I also want a rewrite tactic which does <em>not</em> try <code>rfl</code> at the end. Is this already in Lean?</p>



<a name="169698952"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169698952" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169698952">(Jul 05 2019 at 10:26)</a>:</h4>
<p>Does this work?</p>
<div class="codehilite"><pre><span></span><span class="kn">namespace</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">open</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span> <span class="n">interactive</span><span class="bp">.</span><span class="n">types</span> <span class="n">expr</span> <span class="n">lean</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span> <span class="n">tactic</span> <span class="n">interactive</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">induction&#39;</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">cases_arg_p</span><span class="o">)</span> <span class="o">(</span><span class="n">ids</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">with_ident_list</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">induction</span> <span class="n">hp</span> <span class="n">none</span> <span class="n">ids</span> <span class="n">none</span><span class="o">,</span>
<span class="bp">`</span><span class="o">[</span><span class="n">repeat</span> <span class="o">{</span><span class="n">all_goals</span> <span class="o">{</span><span class="n">rw</span> <span class="o">(</span><span class="k">show</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">=</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">),</span> <span class="k">from</span> <span class="n">rfl</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">}},</span>
  <span class="n">repeat</span> <span class="o">{</span><span class="n">all_goals</span> <span class="o">{</span><span class="n">rw</span> <span class="o">(</span><span class="k">show</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">le</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">has_le</span><span class="bp">.</span><span class="n">le</span> <span class="n">mynat</span> <span class="bp">_</span><span class="o">,</span> <span class="k">from</span> <span class="n">rfl</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">}}]</span>

<span class="kn">end</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>
</pre></div>



<a name="169698965"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169698965" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169698965">(Jul 05 2019 at 10:27)</a>:</h4>
<p>You could also write a recursor using <code>has_zero.zero</code> and do <code>induction ... using</code></p>



<a name="169699058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169699058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169699058">(Jul 05 2019 at 10:28)</a>:</h4>
<p>It would be better to use <code>change mynat.zero with 0 at *</code> instead of <code>rw rfl</code> like that</p>



<a name="169699986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169699986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169699986">(Jul 05 2019 at 10:49)</a>:</h4>
<p>For the rw with no refl I just copied a bunch of private defs from core and then deleted a random line and I think I got lucky:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">open</span> <span class="n">lean</span>
<span class="kn">open</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span>

<span class="n">local</span> <span class="kn">postfix</span> <span class="bp">`</span><span class="err">?</span><span class="bp">`</span><span class="o">:</span><span class="mi">9001</span> <span class="o">:=</span> <span class="n">optional</span>
<span class="n">local</span> <span class="kn">postfix</span> <span class="bp">*</span><span class="o">:</span><span class="mi">9001</span> <span class="o">:=</span> <span class="n">many</span>

<span class="kn">namespace</span> <span class="n">tactic</span>
<span class="kn">namespace</span> <span class="n">interactive</span>
<span class="kn">open</span> <span class="n">interactive</span> <span class="n">interactive</span><span class="bp">.</span><span class="n">types</span> <span class="n">expr</span>

<span class="kn">private</span> <span class="n">meta</span> <span class="n">def</span> <span class="n">resolve_name&#39;</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">name</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">expr</span> <span class="o">:=</span>
<span class="n">do</span> <span class="o">{</span>
  <span class="n">p</span> <span class="err">←</span> <span class="n">resolve_name</span> <span class="n">n</span><span class="o">,</span>
  <span class="k">match</span> <span class="n">p</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">expr</span><span class="bp">.</span><span class="n">const</span> <span class="n">n</span> <span class="bp">_</span> <span class="o">:=</span> <span class="n">mk_const</span> <span class="n">n</span> <span class="c1">-- create metavars for universe levels</span>
  <span class="bp">|</span> <span class="bp">_</span>              <span class="o">:=</span> <span class="n">i_to_expr</span> <span class="n">p</span>
  <span class="kn">end</span>
<span class="o">}</span>

<span class="kn">private</span> <span class="n">meta</span> <span class="n">def</span> <span class="n">rw_goal</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">rewrite_cfg</span><span class="o">)</span> <span class="o">(</span><span class="n">rs</span> <span class="o">:</span> <span class="n">list</span> <span class="n">rw_rule</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">rs</span><span class="bp">.</span><span class="n">mmap&#39;</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="n">do</span>
 <span class="n">save_info</span> <span class="n">r</span><span class="bp">.</span><span class="n">pos</span><span class="o">,</span>
 <span class="n">eq_lemmas</span> <span class="err">←</span> <span class="n">get_rule_eqn_lemmas</span> <span class="n">r</span><span class="o">,</span>
 <span class="n">orelse&#39;</span>
   <span class="o">(</span><span class="n">do</span> <span class="n">e</span> <span class="err">←</span> <span class="n">to_expr&#39;</span> <span class="n">r</span><span class="bp">.</span><span class="n">rule</span><span class="o">,</span> <span class="n">rewrite_target</span> <span class="n">e</span> <span class="o">{</span><span class="n">symm</span> <span class="o">:=</span> <span class="n">r</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span> <span class="bp">..</span><span class="n">cfg</span><span class="o">})</span>
   <span class="o">(</span><span class="n">eq_lemmas</span><span class="bp">.</span><span class="n">mfirst</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">do</span> <span class="n">e</span> <span class="err">←</span> <span class="n">mk_const</span> <span class="n">n</span><span class="o">,</span> <span class="n">rewrite_target</span> <span class="n">e</span> <span class="o">{</span><span class="n">symm</span> <span class="o">:=</span> <span class="n">r</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span> <span class="bp">..</span><span class="n">cfg</span><span class="o">})</span>
   <span class="o">(</span><span class="n">eq_lemmas</span><span class="bp">.</span><span class="n">empty</span><span class="o">)</span>

<span class="kn">private</span> <span class="n">meta</span> <span class="n">def</span> <span class="n">uses_hyp</span> <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="n">expr</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">expr</span><span class="o">)</span> <span class="o">:</span> <span class="n">bool</span> <span class="o">:=</span>
<span class="n">e</span><span class="bp">.</span><span class="n">fold</span> <span class="n">ff</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">t</span> <span class="bp">_</span> <span class="n">r</span><span class="o">,</span> <span class="n">r</span> <span class="bp">||</span> <span class="n">to_bool</span> <span class="o">(</span><span class="n">t</span> <span class="bp">=</span> <span class="n">h</span><span class="o">)</span>

<span class="kn">private</span> <span class="n">meta</span> <span class="n">def</span> <span class="n">rw_hyp</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">rewrite_cfg</span><span class="o">)</span> <span class="o">:</span> <span class="n">list</span> <span class="n">rw_rule</span> <span class="bp">→</span> <span class="n">expr</span> <span class="bp">→</span> <span class="n">tactic</span> <span class="n">unit</span>
<span class="bp">|</span> <span class="o">[]</span>      <span class="n">hyp</span> <span class="o">:=</span> <span class="n">skip</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">r</span><span class="bp">::</span><span class="n">rs</span><span class="o">)</span> <span class="n">hyp</span> <span class="o">:=</span> <span class="n">do</span>
  <span class="n">save_info</span> <span class="n">r</span><span class="bp">.</span><span class="n">pos</span><span class="o">,</span>
  <span class="n">eq_lemmas</span> <span class="err">←</span> <span class="n">get_rule_eqn_lemmas</span> <span class="n">r</span><span class="o">,</span>
  <span class="n">orelse&#39;</span>
    <span class="o">(</span><span class="n">do</span> <span class="n">e</span> <span class="err">←</span> <span class="n">to_expr&#39;</span> <span class="n">r</span><span class="bp">.</span><span class="n">rule</span><span class="o">,</span> <span class="n">when</span> <span class="o">(</span><span class="n">not</span> <span class="o">(</span><span class="n">uses_hyp</span> <span class="n">e</span> <span class="n">hyp</span><span class="o">))</span> <span class="err">$</span> <span class="n">rewrite_hyp</span> <span class="n">e</span> <span class="n">hyp</span> <span class="o">{</span><span class="n">symm</span> <span class="o">:=</span> <span class="n">r</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span> <span class="bp">..</span><span class="n">cfg</span><span class="o">}</span> <span class="bp">&gt;&gt;=</span> <span class="n">rw_hyp</span> <span class="n">rs</span><span class="o">)</span>
    <span class="o">(</span><span class="n">eq_lemmas</span><span class="bp">.</span><span class="n">mfirst</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">do</span> <span class="n">e</span> <span class="err">←</span> <span class="n">mk_const</span> <span class="n">n</span><span class="o">,</span> <span class="n">rewrite_hyp</span> <span class="n">e</span> <span class="n">hyp</span> <span class="o">{</span><span class="n">symm</span> <span class="o">:=</span> <span class="n">r</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span> <span class="bp">..</span><span class="n">cfg</span><span class="o">}</span> <span class="bp">&gt;&gt;=</span> <span class="n">rw_hyp</span> <span class="n">rs</span><span class="o">)</span>
    <span class="o">(</span><span class="n">eq_lemmas</span><span class="bp">.</span><span class="n">empty</span><span class="o">)</span>

<span class="kn">private</span> <span class="n">meta</span> <span class="n">def</span> <span class="n">rw_core</span> <span class="o">(</span><span class="n">rs</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">rw_rules</span><span class="o">)</span> <span class="o">(</span><span class="n">loca</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">location</span><span class="o">)</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">rewrite_cfg</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="k">match</span> <span class="n">loca</span> <span class="k">with</span>
<span class="bp">|</span> <span class="n">loc</span><span class="bp">.</span><span class="n">wildcard</span> <span class="o">:=</span> <span class="n">loca</span><span class="bp">.</span><span class="n">try_apply</span> <span class="o">(</span><span class="n">rw_hyp</span> <span class="n">cfg</span> <span class="n">rs</span><span class="bp">.</span><span class="n">rules</span><span class="o">)</span> <span class="o">(</span><span class="n">rw_goal</span> <span class="n">cfg</span> <span class="n">rs</span><span class="bp">.</span><span class="n">rules</span><span class="o">)</span>
<span class="bp">|</span> <span class="bp">_</span>            <span class="o">:=</span> <span class="n">loca</span><span class="bp">.</span><span class="n">apply</span> <span class="o">(</span><span class="n">rw_hyp</span> <span class="n">cfg</span> <span class="n">rs</span><span class="bp">.</span><span class="n">rules</span><span class="o">)</span> <span class="o">(</span><span class="n">rw_goal</span> <span class="n">cfg</span> <span class="n">rs</span><span class="bp">.</span><span class="n">rules</span><span class="o">)</span>
<span class="kn">end</span> <span class="bp">&gt;&gt;</span> <span class="o">(</span><span class="n">returnopt</span> <span class="n">rs</span><span class="bp">.</span><span class="n">end_pos</span> <span class="bp">&gt;&gt;=</span> <span class="n">save_info</span> <span class="bp">&lt;|&gt;</span> <span class="n">skip</span><span class="o">)</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">rw&#39;</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">rw_rules</span><span class="o">)</span> <span class="o">(</span><span class="n">l</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">location</span><span class="o">)</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">rewrite_cfg</span> <span class="o">:=</span> <span class="o">{})</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">propagate_tags</span> <span class="o">(</span><span class="n">rw_core</span> <span class="n">q</span> <span class="n">l</span> <span class="n">cfg</span><span class="o">)</span>

<span class="kn">end</span> <span class="n">interactive</span>
<span class="kn">end</span> <span class="n">tactic</span>
</pre></div>


<p>Is this a silly way to do it? I just deleted one of the <code>&gt;&gt;</code> lines after <code>end</code> in <code>rw_core</code></p>



<a name="169700707"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169700707" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169700707">(Jul 05 2019 at 11:04)</a>:</h4>
<p>like I said, use <code>change with</code> instead of <code>rw</code></p>



<a name="169700739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169700739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169700739">(Jul 05 2019 at 11:04)</a>:</h4>
<p>use <code>erw</code></p>



<a name="169701636"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169701636" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169701636">(Jul 05 2019 at 11:25)</a>:</h4>
<p><code>change with</code> just looks more complicated than <code>rw</code>. I have a working <code>rw'</code>. I don't mind writing new tactics. To be honest I don't even mind modding core Lean for this project, it's a standalone thing.</p>



<a name="169701647"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169701647" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169701647">(Jul 05 2019 at 11:25)</a>:</h4>
<p>Chris I'll try your induction code when I get back in front of Lean. Thanks!</p>



<a name="169702257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702257" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702257">(Jul 05 2019 at 11:39)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> I think Mario means that you should use <code>change with</code> inside <code>induction'</code> instead of using <code>rw</code> there.</p>



<a name="169702285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702285" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702285">(Jul 05 2019 at 11:39)</a>:</h4>
<p>I just want one tactic which is simple to apply and which doesn't leak. I am not sure I understand what is being suggested.</p>



<a name="169702334"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702334" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702334">(Jul 05 2019 at 11:40)</a>:</h4>
<p>At the minute I am writing</p>
<div class="codehilite"><pre><span></span><span class="n">induction</span> <span class="n">n</span> <span class="k">with</span> <span class="n">d</span> <span class="n">hd</span><span class="o">,</span>
<span class="n">clear_up_leaks</span><span class="o">,</span>
<span class="o">{</span> <span class="bp">...</span> <span class="o">}</span> <span class="o">{</span> <span class="bp">...</span> <span class="o">}</span>
</pre></div>



<a name="169702353"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702353" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702353">(Jul 05 2019 at 11:40)</a>:</h4>
<p>and I want to write </p>
<div class="codehilite"><pre><span></span><span class="n">induction&#39;</span> <span class="n">n</span> <span class="k">with</span> <span class="n">d</span> <span class="n">hd</span>
<span class="o">{</span> <span class="c1">-- no leaks here}</span>
<span class="o">{</span> <span class="c1">-- or here}</span>
</pre></div>



<a name="169702611"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702611" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702611">(Jul 05 2019 at 11:46)</a>:</h4>
<p>Right, and Mario says that <code>clear_up_leaks</code> should use <code>change</code> instead of <code>rw</code>.</p>



<a name="169702649"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702649" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702649">(Jul 05 2019 at 11:47)</a>:</h4>
<p>We might want an attribute <code>@antileak</code> or something like that, that will change terms into defeq terms that are more canonical.</p>



<a name="169702654"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702654" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702654">(Jul 05 2019 at 11:47)</a>:</h4>
<p>I guess we could also use <code>dsimp</code> for this?</p>



<a name="169702725"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702725" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702725">(Jul 05 2019 at 11:48)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> what happens if you write a simp lemma (tagged with <code>@[simp]</code> that says <code>mynat.zero = 0 := rfl</code>.<br>
And then you call <code>induction n with d hd; dsimp</code>.</p>



<a name="169702749"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702749" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702749">(Jul 05 2019 at 11:49)</a>:</h4>
<p>Similarly you will want <code>mynat.succ n = n + 1 := rfl</code>.</p>



<a name="169702759"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702759" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702759">(Jul 05 2019 at 11:49)</a>:</h4>
<p>Is that sufficient to clear up the leaks?</p>



<a name="169702763"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169702763" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169702763">(Jul 05 2019 at 11:49)</a>:</h4>
<p>That's strictly worse than <code>clear_up_leaks</code> because formally it's the same thing ("apply a tactic and then type something which you don't want") and secondly <code>simp</code> will close various goals, like <code>rfl</code> goals -- it does too much.</p>



<a name="169705115"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169705115" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169705115">(Jul 05 2019 at 12:34)</a>:</h4>
<p>using <code>change with</code> will not close any goals</p>



<a name="169705204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169705204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169705204">(Jul 05 2019 at 12:34)</a>:</h4>
<p>And I am talking about the definition of <code>induction'</code>, like Johan says</p>



<a name="169706003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169706003" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169706003">(Jul 05 2019 at 12:49)</a>:</h4>
<p>This works:</p>
<div class="codehilite"><pre><span></span><span class="n">meta</span> <span class="n">def</span> <span class="n">induction&#39;</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">cases_arg_p</span><span class="o">)</span> <span class="o">(</span><span class="n">ids</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">with_ident_list</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">induction</span> <span class="n">hp</span> <span class="n">none</span> <span class="n">ids</span> <span class="n">none</span><span class="o">,</span>
<span class="n">all_goals</span> <span class="bp">`</span><span class="o">[</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">le</span> <span class="k">with</span> <span class="o">(</span><span class="bp">≤</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="bp">@</span><span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="k">with</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="n">at</span> <span class="bp">*</span><span class="o">}]</span>

<span class="kn">theorem</span> <span class="n">zero_add</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">intro</span> <span class="n">x</span><span class="o">,</span>
  <span class="n">induction&#39;</span> <span class="n">x</span> <span class="k">with</span> <span class="n">d</span> <span class="n">hd</span><span class="o">,</span>
  <span class="c1">-- ⊢ 0 + 0 = 0</span>
  <span class="c1">-- 0 + d = d ⊢ 0 + (d + 1) = d + 1</span>
<span class="kn">end</span>
</pre></div>


<p>Unfortunately <code>change with</code> does not support arguments in the lemmas, so I use some beta reduction at the end there. I don't think it will use <code>rfl</code> at the end though. Also <code>propagate_tags</code> undoes the work for some reason, so you can't use <code>case</code> with this</p>



<a name="169706509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169706509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169706509">(Jul 05 2019 at 12:56)</a>:</h4>
<p>So this <code>induction'</code> thing, and <code>rw'</code> and also this <code>structure_helper</code> thing are all attempts to write more user-friendly ways of doing stuff. The idea is that we are shielding the users from Lean's weak spots here. And we're also shielding the user from definitions and recursion; I want to ask them to only prove theorems.</p>



<a name="169706885"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169706885" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169706885">(Jul 05 2019 at 13:02)</a>:</h4>
<p>Yes, but you could say that about any tactic</p>



<a name="169714923"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169714923" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169714923">(Jul 05 2019 at 14:56)</a>:</h4>
<p>I agree you can say this about any tactic, but Kevin is implicitly making a point dear to my heart here --- whenever something is even slightly painful, we should grind away on it, by building suitable tactics, until it becomes smooth and easy. The payoff for building tactics that make life easier is really high!</p>



<a name="169714973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169714973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169714973">(Jul 05 2019 at 14:57)</a>:</h4>
<p>Both Scott and I are speaking as mathematicians who have to deal with questions from undergrads of the form "why doesn't this rewrite work?" and we give technical answers involving <code>pp.all</code> but we'd rather the rewrite just worked ;-)</p>



<a name="169724557"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169724557" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169724557">(Jul 05 2019 at 17:37)</a>:</h4>
<blockquote>
<p>This works:</p>
<div class="codehilite"><pre><span></span><span class="n">meta</span> <span class="n">def</span> <span class="n">induction&#39;</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">cases_arg_p</span><span class="o">)</span> <span class="o">(</span><span class="n">ids</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">with_ident_list</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">induction</span> <span class="n">hp</span> <span class="n">none</span> <span class="n">ids</span> <span class="n">none</span><span class="o">,</span>
<span class="n">all_goals</span> <span class="bp">`</span><span class="o">[</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">le</span> <span class="k">with</span> <span class="o">(</span><span class="bp">≤</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="bp">@</span><span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="k">with</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="n">at</span> <span class="bp">*</span><span class="o">}]</span>
</pre></div>


</blockquote>
<p>What do I need to open to make this compile? </p>
<div class="codehilite"><pre><span></span>unknown identifier &#39;parse&#39;
unknown identifier &#39;cases_arg_p&#39;
unknown identifier &#39;parse&#39;
unknown identifier &#39;with_ident_list&#39;
</pre></div>


<p>Regarding <code>succ</code>, are you suggesting that <code>n + 1</code> is the canonical way of writing <code>succ n</code>? I had assumed it was the other way around.</p>



<a name="169725741"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169725741" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169725741">(Jul 05 2019 at 17:58)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">inductive</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">zero</span> <span class="o">:</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">succ</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>

<span class="c1">-- I want to never see mynat.zero again</span>
<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span><span class="bp">⟩</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_one</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="mi">0</span><span class="bp">⟩</span>

<span class="kn">namespace</span> <span class="n">mynat</span>

<span class="kn">definition</span> <span class="n">add</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">n</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">n</span>
<span class="bp">|</span> <span class="n">n</span> <span class="o">(</span><span class="n">succ</span> <span class="n">p</span><span class="o">)</span> <span class="o">:=</span> <span class="n">succ</span> <span class="o">(</span><span class="n">add</span> <span class="n">n</span> <span class="n">p</span><span class="o">)</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_add</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span>

<span class="kn">end</span> <span class="n">mynat</span>

<span class="kn">namespace</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">open</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span> <span class="n">interactive</span><span class="bp">.</span><span class="n">types</span> <span class="n">expr</span> <span class="n">lean</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span> <span class="n">tactic</span> <span class="n">interactive</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">induction&#39;</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">cases_arg_p</span><span class="o">)</span> <span class="o">(</span><span class="n">ids</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">with_ident_list</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">induction</span> <span class="n">hp</span> <span class="n">none</span> <span class="n">ids</span> <span class="n">none</span><span class="o">,</span>
<span class="n">all_goals</span> <span class="bp">`</span><span class="o">[</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">le</span> <span class="k">with</span> <span class="o">(</span><span class="bp">≤</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="bp">@</span><span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="k">with</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="n">at</span> <span class="bp">*</span><span class="o">}]</span>

<span class="kn">end</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">namespace</span> <span class="n">mynat</span>

<span class="kn">theorem</span> <span class="n">zero_add</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">intro</span> <span class="n">x</span><span class="o">,</span>
  <span class="n">induction&#39;</span> <span class="n">x</span> <span class="k">with</span> <span class="n">d</span> <span class="n">hd</span><span class="o">,</span>
  <span class="c1">-- ⊢ 0 + 0 = 0</span>
  <span class="c1">-- 0 + d = d ⊢ 0 + (d + 1) = d + 1</span>
<span class="kn">end</span>
</pre></div>



<a name="169730976"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169730976" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169730976">(Jul 05 2019 at 19:28)</a>:</h4>
<p>Thanks. What I am surprised about is that you want to replace succ with + 1. I decided in my development that succ x was more canonical than x + 1. Is there anything wrong with this decision?</p>



<a name="169731209"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169731209" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169731209">(Jul 05 2019 at 19:33)</a>:</h4>
<p>I guess that it doesn't look very "mathematical"...</p>



<a name="169732243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169732243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169732243">(Jul 05 2019 at 19:54)</a>:</h4>
<p>I don't really care one away or another... the lean magic is pretty strong in being able to conflate them for nat. The only downside of <code>n+1</code> is simp has a nasty habit of changing it to <code>1+n</code></p>



<a name="169732280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169732280" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169732280">(Jul 05 2019 at 19:55)</a>:</h4>
<p>Isn't that because <code>add_comm</code> is a simp-lemma for some reason?</p>



<a name="169732284"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169732284" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169732284">(Jul 05 2019 at 19:55)</a>:</h4>
<p>I've seen it show up in the results of <code>squeeze_simp</code>.</p>



<a name="169751123"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169751123" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Keeley Hoek <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169751123">(Jul 06 2019 at 04:18)</a>:</h4>
<p>I'm adamant that definitions should be able have attached a way to format themselves, and probably implementing this with an attribute would work really well. Then e.g. once <code>has_zero</code> is defined <code>zero</code> can remember it is always <code>0</code>, and there is no chasing of potential leakage everywhere. Another nice thing would be for <code>vector_space</code> vs <code>module</code>; if the scalar ring is (in <code>expr</code> land) an application of <code>discrete_field.to_ring</code> then print <code>vector_space</code>, else print <code>module</code>, etc.</p>



<a name="169806298"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806298" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806298">(Jul 07 2019 at 10:37)</a>:</h4>
<p>Surprisingly, this modified tactic still leaks (although I can't see why):</p>
<div class="codehilite"><pre><span></span><span class="kn">inductive</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">zero</span> <span class="o">:</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">succ</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>

<span class="c1">-- I want to never see mynat.zero again</span>
<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span><span class="bp">⟩</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_one</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="mi">0</span><span class="bp">⟩</span>

<span class="kn">namespace</span> <span class="n">mynat</span>

<span class="kn">definition</span> <span class="n">add</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">n</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">n</span>
<span class="bp">|</span> <span class="n">n</span> <span class="o">(</span><span class="n">succ</span> <span class="n">p</span><span class="o">)</span> <span class="o">:=</span> <span class="n">succ</span> <span class="o">(</span><span class="n">add</span> <span class="n">n</span> <span class="n">p</span><span class="o">)</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_add</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span>

<span class="kn">end</span> <span class="n">mynat</span>

<span class="kn">namespace</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">open</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span> <span class="n">interactive</span><span class="bp">.</span><span class="n">types</span> <span class="n">expr</span> <span class="n">lean</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span> <span class="n">tactic</span> <span class="n">interactive</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">induction&#39;</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">cases_arg_p</span><span class="o">)</span> <span class="o">(</span><span class="n">ids</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">with_ident_list</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">induction</span> <span class="n">hp</span> <span class="n">none</span> <span class="n">ids</span> <span class="n">none</span><span class="o">,</span>
<span class="n">all_goals</span> <span class="bp">`</span><span class="o">[</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">le</span> <span class="k">with</span> <span class="o">(</span><span class="bp">≤</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="bp">@</span><span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="k">with</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="n">at</span> <span class="bp">*</span><span class="o">}]</span>

<span class="kn">end</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">namespace</span> <span class="n">mynat</span>

<span class="kn">lemma</span> <span class="n">eq_zero_of_add_right_eq_self</span> <span class="o">{{</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">}}</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">→</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">intro</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">induction&#39;</span> <span class="n">a</span> <span class="k">with</span> <span class="n">a</span> <span class="n">ha</span><span class="o">,</span>
  <span class="o">{</span> <span class="c1">-- leakage</span>
    <span class="c1">-- h : zero + b = zero</span>
    <span class="n">sorry</span>
  <span class="o">},</span> <span class="n">sorry</span>
<span class="kn">end</span>

<span class="kn">end</span> <span class="n">mynat</span>
</pre></div>



<a name="169806398"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806398" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806398">(Jul 07 2019 at 10:40)</a>:</h4>
<p>what changed?</p>



<a name="169806405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806405">(Jul 07 2019 at 10:41)</a>:</h4>
<p>the tactic looks the same</p>



<a name="169806409"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806409" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806409">(Jul 07 2019 at 10:41)</a>:</h4>
<p>Oh -- I can see why!</p>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">+</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">))</span> <span class="o">:</span> <span class="n">false</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="c1">-- h : zero + x = x + 0</span>
    <span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="c1">-- h : zero + x = x + 0</span>
    <span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="n">h</span><span class="o">,</span>
  <span class="c1">-- h : 0 + x = x + 0</span>
  <span class="n">sorry</span>
<span class="kn">end</span>
</pre></div>


<p>Is this a bug in <code>change</code> <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> ?</p>



<a name="169806463"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806463" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806463">(Jul 07 2019 at 10:42)</a>:</h4>
<p>[sorry -- by "this modified tactic" I mean "your tactic", not "I modified your tactic"]</p>



<a name="169806468"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806468" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806468">(Jul 07 2019 at 10:43)</a>:</h4>
<p>that's interesting. It looks like a bug (I mean it's definitely not intended behavior)</p>



<a name="169806543"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806543" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806543">(Jul 07 2019 at 10:45)</a>:</h4>
<p><em>sigh</em></p>



<a name="169806547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806547">(Jul 07 2019 at 10:45)</a>:</h4>
<p>We need formally verified tactics</p>



<a name="169806731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806731" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806731">(Jul 07 2019 at 10:51)</a>:</h4>
<p>My workaround:</p>
<div class="codehilite"><pre><span></span>try {rw&#39; (show mynat.zero = (0 : mynat), from rfl) at *},
</pre></div>


<p>where <code>rw'</code> is my modded <code>rw</code> which doesn't try to close goals with <code>rfl</code></p>



<a name="169806733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806733" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806733">(Jul 07 2019 at 10:51)</a>:</h4>
<p>It's written in lean, so you can just fix it</p>



<a name="169806774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806774">(Jul 07 2019 at 10:52)</a>:</h4>
<blockquote>
<p>We need formally verified tactics</p>
</blockquote>
<p>You joke, but...</p>



<a name="169806775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806775">(Jul 07 2019 at 10:52)</a>:</h4>
<p>I can't understand meta code so I can't.</p>
<div class="codehilite"><pre><span></span><span class="c">/-</span><span class="cm">-</span>
<span class="cm">`change u` replaces the target `t` of the main goal to `u` provided that `t` is well formed with respect to the local context of the main goal and `t` and `u` are definitionally equal.</span>

<span class="cm">`change u at h` will change a local hypothesis to `u`.</span>

<span class="cm">`change t with u at h1 h2 ...` will replace `t` with `u` in all the supplied hypotheses (or `*`), or in the goal if no `at` clause is specified, provided that `t` and `u` are definitionally equal.</span>
<span class="cm">-/</span>
<span class="n">meta</span> <span class="n">def</span> <span class="n">change</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">texpr</span><span class="o">)</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">&quot;with&quot;</span> <span class="bp">*&gt;</span> <span class="n">texpr</span><span class="o">)</span><span class="err">?</span> <span class="bp">→</span> <span class="n">parse</span> <span class="n">location</span> <span class="bp">→</span> <span class="n">tactic</span> <span class="n">unit</span>
<span class="bp">|</span> <span class="n">none</span> <span class="o">(</span><span class="n">loc</span><span class="bp">.</span><span class="n">ns</span> <span class="o">[</span><span class="n">none</span><span class="o">])</span> <span class="o">:=</span> <span class="n">do</span> <span class="n">e</span> <span class="err">←</span> <span class="n">i_to_expr</span> <span class="n">q</span><span class="o">,</span> <span class="n">change_core</span> <span class="n">e</span> <span class="n">none</span>
<span class="bp">|</span> <span class="n">none</span> <span class="o">(</span><span class="n">loc</span><span class="bp">.</span><span class="n">ns</span> <span class="o">[</span><span class="n">some</span> <span class="n">h</span><span class="o">])</span> <span class="o">:=</span> <span class="n">do</span> <span class="n">eq</span> <span class="err">←</span> <span class="n">i_to_expr</span> <span class="n">q</span><span class="o">,</span> <span class="n">eh</span> <span class="err">←</span> <span class="n">get_local</span> <span class="n">h</span><span class="o">,</span> <span class="n">change_core</span> <span class="n">eq</span> <span class="o">(</span><span class="n">some</span> <span class="n">eh</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">none</span> <span class="bp">_</span> <span class="o">:=</span> <span class="n">fail</span> <span class="s2">&quot;change-at does not support multiple locations&quot;</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">some</span> <span class="n">w</span><span class="o">)</span> <span class="n">l</span> <span class="o">:=</span>
  <span class="n">do</span> <span class="n">u</span> <span class="err">←</span> <span class="n">mk_meta_univ</span><span class="o">,</span>
     <span class="n">ty</span> <span class="err">←</span> <span class="n">mk_meta_var</span> <span class="o">(</span><span class="n">sort</span> <span class="n">u</span><span class="o">),</span>
     <span class="n">eq</span> <span class="err">←</span> <span class="n">i_to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="err">%%</span><span class="n">q</span> <span class="o">:</span> <span class="err">%%</span><span class="n">ty</span><span class="o">),</span>
     <span class="n">ew</span> <span class="err">←</span> <span class="n">i_to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="err">%%</span><span class="n">w</span> <span class="o">:</span> <span class="err">%%</span><span class="n">ty</span><span class="o">),</span>
     <span class="k">let</span> <span class="n">repl</span> <span class="o">:=</span> <span class="bp">λ</span><span class="n">e</span> <span class="o">:</span> <span class="n">expr</span><span class="o">,</span> <span class="n">e</span><span class="bp">.</span><span class="n">replace</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">n</span><span class="o">,</span> <span class="k">if</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">eq</span> <span class="k">then</span> <span class="n">some</span> <span class="n">ew</span> <span class="k">else</span> <span class="n">none</span><span class="o">),</span>
     <span class="n">l</span><span class="bp">.</span><span class="n">try_apply</span>
       <span class="o">(</span><span class="bp">λ</span><span class="n">h</span><span class="o">,</span> <span class="n">do</span> <span class="n">e</span> <span class="err">←</span> <span class="n">infer_type</span> <span class="n">h</span><span class="o">,</span> <span class="n">change_core</span> <span class="o">(</span><span class="n">repl</span> <span class="n">e</span><span class="o">)</span> <span class="o">(</span><span class="n">some</span> <span class="n">h</span><span class="o">))</span>
       <span class="o">(</span><span class="n">do</span> <span class="n">g</span> <span class="err">←</span> <span class="n">target</span><span class="o">,</span> <span class="n">change_core</span> <span class="o">(</span><span class="n">repl</span> <span class="n">g</span><span class="o">)</span> <span class="n">none</span><span class="o">)</span>
</pre></div>



<a name="169806853"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806853" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806853">(Jul 07 2019 at 10:55)</a>:</h4>
<p>I don't see why <code>at *</code> would fail and <code>at h</code> would succeed. The last three lines are basically executing <code>change ... at x, change ... at h, change ... at |-</code></p>



<a name="169806898"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806898" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806898">(Jul 07 2019 at 10:56)</a>:</h4>
<p>Can you reproduce? My post should be a MWE</p>



<a name="169806900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806900" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806900">(Jul 07 2019 at 10:56)</a>:</h4>
<p>sorry, that's nonsense.</p>



<a name="169806909"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806909" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806909">(Jul 07 2019 at 10:56)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">inductive</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">zero</span> <span class="o">:</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">succ</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>

<span class="c1">-- I want to never see mynat.zero again</span>
<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span><span class="bp">⟩</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_one</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="mi">0</span><span class="bp">⟩</span>

<span class="kn">namespace</span> <span class="n">mynat</span>

<span class="kn">definition</span> <span class="n">add</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">n</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">n</span>
<span class="bp">|</span> <span class="n">n</span> <span class="o">(</span><span class="n">succ</span> <span class="n">p</span><span class="o">)</span> <span class="o">:=</span> <span class="n">succ</span> <span class="o">(</span><span class="n">add</span> <span class="n">n</span> <span class="n">p</span><span class="o">)</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_add</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span>

<span class="kn">end</span> <span class="n">mynat</span>

<span class="kn">namespace</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">open</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span> <span class="n">interactive</span><span class="bp">.</span><span class="n">types</span> <span class="n">expr</span> <span class="n">lean</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span> <span class="n">tactic</span> <span class="n">interactive</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">induction&#39;</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">cases_arg_p</span><span class="o">)</span> <span class="o">(</span><span class="n">ids</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">with_ident_list</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">induction</span> <span class="n">hp</span> <span class="n">none</span> <span class="n">ids</span> <span class="n">none</span><span class="o">,</span>
<span class="n">all_goals</span> <span class="bp">`</span><span class="o">[</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">le</span> <span class="k">with</span> <span class="o">(</span><span class="bp">≤</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">change</span> <span class="bp">@</span><span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="k">with</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="n">at</span> <span class="bp">*</span><span class="o">}]</span>

<span class="kn">end</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">namespace</span> <span class="n">mynat</span>

<span class="kn">lemma</span> <span class="n">eq_zero_of_add_right_eq_self</span> <span class="o">{{</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">}}</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">→</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">intro</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">induction&#39;</span> <span class="n">a</span> <span class="k">with</span> <span class="n">a</span> <span class="n">ha</span><span class="o">,</span>
  <span class="o">{</span> <span class="c1">-- leakage</span>
    <span class="c1">-- h : zero + b = zero</span>
    <span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
    <span class="n">sorry</span>
  <span class="o">},</span> <span class="n">sorry</span>
<span class="kn">end</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">+</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">))</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">+</span> <span class="mi">2</span> <span class="bp">=</span> <span class="mi">4</span><span class="o">)</span> <span class="o">:</span> <span class="n">false</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="c1">-- h : zero + x = x + 0</span>
    <span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="c1">-- h : zero + x = x + 0</span>
    <span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="n">h</span><span class="o">,</span>
  <span class="c1">-- h : 0 + x = x + 0</span>
  <span class="n">sorry</span>
<span class="kn">end</span>

<span class="kn">end</span> <span class="n">mynat</span>
</pre></div>



<a name="169806914"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169806914" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169806914">(Jul 07 2019 at 10:57)</a>:</h4>
<p>That's a WE</p>



<a name="169807690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807690">(Jul 07 2019 at 11:22)</a>:</h4>
<p>Aha, I found the problem. Here's a standalone tactic that does the same thing as the <code>change with</code> line, with irrelevant things removed:</p>
<div class="codehilite"><pre><span></span><span class="kn">open</span> <span class="n">tactic</span> <span class="n">expr</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">+</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">))</span> <span class="o">:</span> <span class="n">false</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="c1">-- h : zero + x = x + 0</span>
  <span class="o">(</span><span class="n">do</span> <span class="k">let</span> <span class="n">repl</span> <span class="o">:=</span> <span class="bp">λ</span><span class="n">e</span> <span class="o">:</span> <span class="n">expr</span><span class="o">,</span> <span class="n">e</span><span class="bp">.</span><span class="n">replace</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">n</span><span class="o">,</span>
      <span class="k">if</span> <span class="n">a</span> <span class="bp">=</span> <span class="bp">`</span><span class="o">(</span><span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span><span class="o">)</span> <span class="k">then</span> <span class="n">some</span> <span class="bp">`</span><span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="k">else</span> <span class="n">none</span><span class="o">),</span>
    <span class="k">let</span> <span class="n">hyp_tac</span> <span class="o">(</span><span class="n">h</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">do</span>
      <span class="n">e</span> <span class="err">←</span> <span class="n">infer_type</span> <span class="n">h</span><span class="o">,</span>
      <span class="n">num_reverted</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="err">←</span> <span class="n">revert</span> <span class="n">h</span><span class="o">,</span>
      <span class="n">expr</span><span class="bp">.</span><span class="n">pi</span> <span class="n">n</span> <span class="n">bi</span> <span class="n">d</span> <span class="n">b</span> <span class="err">←</span> <span class="n">target</span><span class="o">,</span>
      <span class="n">tactic</span><span class="bp">.</span><span class="n">change</span> <span class="err">$</span> <span class="n">expr</span><span class="bp">.</span><span class="n">pi</span> <span class="n">n</span> <span class="n">bi</span> <span class="o">(</span><span class="n">repl</span> <span class="n">e</span><span class="o">)</span> <span class="n">b</span><span class="o">,</span>
      <span class="n">intron</span> <span class="n">num_reverted</span><span class="o">),</span>
    <span class="o">[</span><span class="n">x</span><span class="o">,</span> <span class="n">h</span><span class="o">]</span> <span class="err">←</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">local_context</span><span class="o">,</span>
    <span class="n">tactic</span><span class="bp">.</span><span class="n">try_lst</span> <span class="err">$</span> <span class="o">[</span><span class="n">x</span><span class="o">,</span> <span class="c">/-</span><span class="cm"> &lt;- delete -/</span> <span class="n">h</span><span class="o">]</span><span class="bp">.</span><span class="n">map</span> <span class="n">hyp_tac</span><span class="o">),</span>
<span class="kn">end</span>
</pre></div>



<a name="169807699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807699" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807699">(Jul 07 2019 at 11:22)</a>:</h4>
<p>The tactic fails in this case, but if you remove the <code>x,</code> on the last line then it works</p>



<a name="169807712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807712" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807712">(Jul 07 2019 at 11:23)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">run_cmd</span> <span class="n">mk_simp_attr</span> <span class="bp">`</span><span class="n">leakage</span>

<span class="kn">namespace</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">open</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span> <span class="n">interactive</span><span class="bp">.</span><span class="n">types</span> <span class="n">expr</span> <span class="n">lean</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span> <span class="n">tactic</span> <span class="n">interactive</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">induction&#39;</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">cases_arg_p</span><span class="o">)</span> <span class="o">(</span><span class="n">ids</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">with_ident_list</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">induction</span> <span class="n">hp</span> <span class="n">none</span> <span class="n">ids</span> <span class="n">none</span><span class="o">,</span>
<span class="n">all_goals</span> <span class="bp">`</span><span class="o">[</span><span class="n">try</span> <span class="o">{</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="k">with</span> <span class="n">leakage</span> <span class="n">at</span> <span class="bp">*</span> <span class="o">}]</span>

<span class="kn">end</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>


<span class="kn">inductive</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">zero</span> <span class="o">:</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">succ</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span><span class="bp">⟩</span>
<span class="c1">-- I want to never see mynat.zero again</span>
<span class="bp">@</span><span class="o">[</span><span class="n">leakage</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">mynat_zero_eq_zero</span> <span class="o">:</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_one</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="mi">0</span><span class="bp">⟩</span>

<span class="kn">namespace</span> <span class="n">mynat</span>

<span class="kn">definition</span> <span class="n">add</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">n</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">n</span>
<span class="bp">|</span> <span class="n">n</span> <span class="o">(</span><span class="n">succ</span> <span class="n">p</span><span class="o">)</span> <span class="o">:=</span> <span class="n">succ</span> <span class="o">(</span><span class="n">add</span> <span class="n">n</span> <span class="n">p</span><span class="o">)</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_add</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span>
<span class="c1">-- I want to never see mynat.succ again</span>
<span class="bp">@</span><span class="o">[</span><span class="n">leakage</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">mynat_succ_eq_add_one</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="n">n</span> <span class="bp">=</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">lemma</span> <span class="n">eq_zero_of_add_right_eq_self</span> <span class="o">{{</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">}}</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">→</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">intro</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">induction&#39;</span> <span class="n">a</span> <span class="k">with</span> <span class="n">a</span> <span class="n">ha</span><span class="o">,</span>
  <span class="o">{</span> <span class="c1">-- no leakage</span>
    <span class="c1">-- h : 0 + b = 0</span>
    <span class="n">sorry</span>
  <span class="o">},</span> <span class="n">sorry</span>
<span class="kn">end</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">+</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">))</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">+</span> <span class="mi">2</span> <span class="bp">=</span> <span class="mi">4</span><span class="o">)</span> <span class="o">:</span> <span class="n">false</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="c1">-- h : zero + x = x + 0</span>
    <span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="c1">-- h : zero + x = x + 0</span>
    <span class="n">change</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="k">with</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">)</span> <span class="n">at</span> <span class="n">h</span><span class="o">,</span>
  <span class="c1">-- h : 0 + x = x + 0</span>
  <span class="n">sorry</span>
<span class="kn">end</span>

<span class="kn">end</span> <span class="n">mynat</span>
</pre></div>



<a name="169807763"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807763" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807763">(Jul 07 2019 at 11:24)</a>:</h4>
<p>I like the look of this</p>



<a name="169807817"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807817" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807817">(Jul 07 2019 at 11:26)</a>:</h4>
<blockquote>
<blockquote>
<p>We need formally verified tactics</p>
</blockquote>
<p>You joke, but...</p>
</blockquote>
<p>What makes you think that I'm joking <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="169807834"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807834" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807834">(Jul 07 2019 at 11:27)</a>:</h4>
<p>The reason it fails is because the <code>change ... at x</code>, while not doing anything to the type, changes the internal name of the local variable because it is reverted and re-introduced, and this also changes the variable <code>h</code> so that the old reference is dangling and fails to achieve the desired result</p>



<a name="169807892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807892" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807892">(Jul 07 2019 at 11:29)</a>:</h4>
<p><span class="user-mention" data-user-id="110064">@Kenny Lau</span> can you do me a <code>cases'</code> too?</p>



<a name="169807899"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807899" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807899">(Jul 07 2019 at 11:29)</a>:</h4>
<p>Currently I just cut and paste the cases tactic and then add stuff to the end</p>



<a name="169807903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807903">(Jul 07 2019 at 11:29)</a>:</h4>
<p><code>do tactic.interactive.induction hp none ids none,</code> -- it's that line I need for <code>cases</code></p>



<a name="169807960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807960">(Jul 07 2019 at 11:30)</a>:</h4>
<p>Alternatively, if only the second line is a tactic, then you can write <code>cases foo, unleak</code></p>



<a name="169807963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807963" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807963">(Jul 07 2019 at 11:30)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">run_cmd</span> <span class="n">mk_simp_attr</span> <span class="bp">`</span><span class="n">leakage</span>

<span class="kn">namespace</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">open</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span> <span class="n">interactive</span><span class="bp">.</span><span class="n">types</span> <span class="n">expr</span> <span class="n">lean</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span> <span class="n">tactic</span> <span class="n">interactive</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">induction&#39;</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">cases_arg_p</span><span class="o">)</span> <span class="o">(</span><span class="n">ids</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">with_ident_list</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">induction</span> <span class="n">hp</span> <span class="n">none</span> <span class="n">ids</span> <span class="n">none</span><span class="o">,</span>
<span class="n">all_goals</span> <span class="bp">`</span><span class="o">[</span><span class="n">try</span> <span class="o">{</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="k">with</span> <span class="n">leakage</span> <span class="n">at</span> <span class="bp">*</span> <span class="o">}]</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">cases&#39;</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">cases_arg_p</span><span class="o">)</span> <span class="o">(</span><span class="n">ids</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">with_ident_list</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">cases</span> <span class="n">hp</span> <span class="n">ids</span><span class="o">,</span>
<span class="n">all_goals</span> <span class="bp">`</span><span class="o">[</span><span class="n">try</span> <span class="o">{</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="k">with</span> <span class="n">leakage</span> <span class="n">at</span> <span class="bp">*</span> <span class="o">}]</span>

<span class="kn">end</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>


<span class="kn">inductive</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">zero</span> <span class="o">:</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">succ</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span><span class="bp">⟩</span>
<span class="c1">-- I want to never see mynat.zero again</span>
<span class="bp">@</span><span class="o">[</span><span class="n">leakage</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">mynat_zero_eq_zero</span> <span class="o">:</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_one</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="mi">0</span><span class="bp">⟩</span>

<span class="kn">namespace</span> <span class="n">mynat</span>

<span class="kn">definition</span> <span class="n">add</span> <span class="o">:</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span> <span class="bp">→</span> <span class="n">mynat</span>
<span class="bp">|</span> <span class="n">n</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">n</span>
<span class="bp">|</span> <span class="n">n</span> <span class="o">(</span><span class="n">succ</span> <span class="n">p</span><span class="o">)</span> <span class="o">:=</span> <span class="n">succ</span> <span class="o">(</span><span class="n">add</span> <span class="n">n</span> <span class="n">p</span><span class="o">)</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_add</span> <span class="n">mynat</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">mynat</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span>
<span class="c1">-- I want to never see mynat.succ again</span>
<span class="bp">@</span><span class="o">[</span><span class="n">leakage</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">mynat_succ_eq_add_one</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">mynat</span><span class="bp">.</span><span class="n">succ</span> <span class="n">n</span> <span class="bp">=</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">lemma</span> <span class="n">eq_zero_of_add_right_eq_self</span> <span class="o">{{</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">mynat</span><span class="o">}}</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">→</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">intro</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">cases&#39;</span> <span class="n">a</span> <span class="k">with</span> <span class="n">n</span><span class="o">,</span>
  <span class="o">{</span> <span class="c1">-- no leakage</span>
    <span class="c1">-- h : 0 + b = 0</span>
    <span class="n">sorry</span> <span class="o">},</span>
  <span class="o">{</span> <span class="c1">-- no leakage</span>
    <span class="c1">-- h : n + 1 + b = n + 1</span>
    <span class="n">sorry</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">end</span> <span class="n">mynat</span>
</pre></div>



<a name="169807982"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169807982" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169807982">(Jul 07 2019 at 11:31)</a>:</h4>
<p>I'm not sure I like this "duplicate every tactic" approach</p>



<a name="169808031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169808031" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169808031">(Jul 07 2019 at 11:32)</a>:</h4>
<p>me neither</p>



<a name="169808032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169808032" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169808032">(Jul 07 2019 at 11:32)</a>:</h4>
<p>unleak is good</p>



<a name="169808043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169808043" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169808043">(Jul 07 2019 at 11:32)</a>:</h4>
<blockquote>
<p>Alternatively, if only the second line is a tactic, then you can write <code>cases foo, unleak</code></p>
</blockquote>
<p><code>cases foo; unleak</code></p>



<a name="169808049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169808049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169808049">(Jul 07 2019 at 11:32)</a>:</h4>
<p>your version unleaks everywhere so it's the same</p>



<a name="169808060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169808060" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169808060">(Jul 07 2019 at 11:33)</a>:</h4>
<p>but it's probably more idiomatic to drop the all_goals and use <code>;</code></p>



<a name="169808277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169808277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169808277">(Jul 07 2019 at 11:39)</a>:</h4>
<p>There's an (interactive) <code>change'</code> tactic that's supposted to deal with the naming issue in <code>change</code>. <a href="https://github.com/leanprover-community/mathlib/pull/712" target="_blank" title="https://github.com/leanprover-community/mathlib/pull/712">https://github.com/leanprover-community/mathlib/pull/712</a></p>



<a name="169808278"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169808278" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169808278">(Jul 07 2019 at 11:39)</a>:</h4>
<p>or just write <code>dsimp only with leakage</code></p>



<a name="169808281"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169808281" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169808281">(Jul 07 2019 at 11:40)</a>:</h4>
<p>(accidental promotion of <code>simp</code> attributes)</p>



<a name="169808330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169808330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169808330">(Jul 07 2019 at 11:40)</a>:</h4>
<p>(I've always been adamant about the widespread use of <code>simp</code> attribute)</p>



<a name="169808338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169808338" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Keeley Hoek <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169808338">(Jul 07 2019 at 11:41)</a>:</h4>
<p>Someone could add a little custom tactic hook so <code>unleak</code> gets run between every line when you write <code>begin [unleak] ... end</code></p>



<a name="169809147"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169809147" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrew Ashworth <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169809147">(Jul 07 2019 at 12:06)</a>:</h4>
<p>i haven't tried this but could you get around with <code>pp.notation</code> and custom notation? Is it possible to hack the pretty printer in any way?</p>



<a name="169809315"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169809315" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrew Ashworth <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169809315">(Jul 07 2019 at 12:11)</a>:</h4>
<p>hmm, i wonder if there is a vscode extension that watches tabs and can perform regex find and replace</p>



<a name="169813313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169813313" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169813313">(Jul 07 2019 at 14:06)</a>:</h4>
<blockquote>
<p>I'm not sure I like this "duplicate every tactic" approach</p>
</blockquote>
<p>How do we make Lean more user-friendly for beginners?</p>



<a name="169813324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169813324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169813324">(Jul 07 2019 at 14:07)</a>:</h4>
<blockquote>
<p>i haven't tried this but could you get around with <code>pp.notation</code> and custom notation? Is it possible to hack the pretty printer in any way?</p>
</blockquote>
<p>The problem with this is that if the pretty printer is printing both <code>mynat.zero</code> and <code>has_zero.zero</code> as <code>0</code> then <code>rw</code> will <em>still be failing</em> and the error message will be incomprehensible.</p>



<a name="169814004"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169814004" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169814004">(Jul 07 2019 at 14:32)</a>:</h4>
<p>I would rather fix the original tactics rather than inventing new variations on existing things, which is more stuff for the newcomer to learn. If the set of tactics becomes too large, that itself will present a learning curve penalty</p>



<a name="169814111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169814111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tim Daly <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169814111">(Jul 07 2019 at 14:35)</a>:</h4>
<p>Is there a "stack exchange" list somewhere that demonstrates each tactic? As a beginner it would be useful to see how and why to apply each tactic with a working example.</p>



<a name="169814747"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169814747" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169814747">(Jul 07 2019 at 14:57)</a>:</h4>
<p>Here's something I knocked up very quickly last year, which covers some of the basics.</p>
<p><a href="http://wwwf.imperial.ac.uk/~buzzard/xena/html/source/tactics/tacticindex.html" target="_blank" title="http://wwwf.imperial.ac.uk/~buzzard/xena/html/source/tactics/tacticindex.html">http://wwwf.imperial.ac.uk/~buzzard/xena/html/source/tactics/tacticindex.html</a></p>
<p>This summer I fully intend to make something a lot more professional.</p>
<p>For the more advanced tactics, </p>
<p><a href="https://github.com/leanprover-community/mathlib/blob/master/docs/tactics.md" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/master/docs/tactics.md">https://github.com/leanprover-community/mathlib/blob/master/docs/tactics.md</a></p>
<p>is invaluable.</p>



<a name="169814881"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169814881" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169814881">(Jul 07 2019 at 15:01)</a>:</h4>
<blockquote>
<p>I would rather fix the original tactics rather than inventing new variations on existing things, which is more stuff for the newcomer to learn. If the set of tactics becomes too large, that itself will present a learning curve penalty</p>
</blockquote>
<p>For this notational leakage issue I am making a standalone thing; ultimately I would like <code>induction</code> to actually run <code>induction'</code>. Fixing this sort of issue in general is a different question. I like the idea of a custom recursor written with the canonical notation which gets tagged somehow and then picked up by the tactic in general.</p>
<p>So while I'm here, how can I actually override what happens when a user types <code>induction</code> in tactic mode? Editing core lean is fine. But the problem is that just changing the name of the <code>induction</code> tactic in core Lean will break everything, I would imagine. I'd rather have some other namespace open and with a higher priority.</p>



<a name="169815059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169815059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169815059">(Jul 07 2019 at 15:07)</a>:</h4>
<p>sadly lean interactive tactics don't work like that</p>



<a name="169815065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169815065" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169815065">(Jul 07 2019 at 15:08)</a>:</h4>
<p>for it to get picked up you have to call it <code>tactic.interactive.induction</code>, and there can only be one of that</p>



<a name="169815219"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169815219" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169815219">(Jul 07 2019 at 15:13)</a>:</h4>
<p>There are all sorts of ways I can work around this, e.g. processing user input before feeding it to Lean.</p>



<a name="169815860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169815860" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169815860">(Jul 07 2019 at 15:32)</a>:</h4>
<p>Can't one of <span class="user-mention" data-user-id="110111">@Keeley Hoek</span>'s</p>
<div class="codehilite"><pre><span></span><span class="k">begin</span> <span class="o">[</span><span class="n">ninja</span><span class="bp">-</span><span class="n">mode</span><span class="o">]</span>
  <span class="n">induction</span> <span class="n">n</span><span class="o">,</span>
<span class="kn">end</span>
</pre></div>


<p>make this work?</p>



<a name="169815863"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169815863" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169815863">(Jul 07 2019 at 15:32)</a>:</h4>
<p>yes, but that requires rewriting every tactic</p>



<a name="169817488"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169817488" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169817488">(Jul 07 2019 at 16:27)</a>:</h4>
<p>It should actually be easy to define an alias <code>newtac</code> for <code>tactic</code> and automatically copy every declaration in <code>tactic.interactive</code> to <code>newtac.interactive</code>. Skip the ones you want to change, then use <code>begin [newtac] ... end</code> blocks. Not the prettiest workaround though.</p>



<a name="169817553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169817553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169817553">(Jul 07 2019 at 16:29)</a>:</h4>
<p>It would be great if there was an option or command line flag to set the default environment</p>



<a name="169823969"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169823969" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johannes Hölzl <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169823969">(Jul 07 2019 at 19:49)</a>:</h4>
<p>I would vote for a per-module option (e.g. extend <code>theory</code>, so we can write <code>noncomputable mathlib theory</code> or <code>mathlib theory</code>)</p>



<a name="169855514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169855514" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Keeley Hoek <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169855514">(Jul 08 2019 at 10:00)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Using my addition to lean <code>3.5.0</code> you can at least set the default monad for an interactive block.</p>



<a name="169855530"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169855530" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Keeley Hoek <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169855530">(Jul 08 2019 at 10:01)</a>:</h4>
<p>You create a new <code>executor</code> instance with priority higher than the default.</p>



<a name="169857050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/notational%20leakage/near/169857050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/notational.20leakage.html#169857050">(Jul 08 2019 at 10:28)</a>:</h4>
<p>I am completely open to using 3.5.x with this project. It would be ideal if we could use <code>induction a with d hd</code> rather than <code>induction'</code>. My vision is that the user can only edit the stuff in a textbox within some begin end block (and can't see all the jibberish outside the block).</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>