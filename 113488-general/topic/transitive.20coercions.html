---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/transitive.20coercions.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html">transitive coercions</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="195747861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195747861" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195747861">(Apr 29 2020 at 18:02)</a>:</h4>
<p>Here's the first thing which broke in a nontrivial way when I made <code>coe_fn_trans</code> and <code>coe_sort_trans</code> no longer instances:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">lemma</span> <span class="n">Union_range_eq_sUnion</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">(</span><span class="n">C</span> <span class="o">:</span> <span class="n">set</span> <span class="o">(</span><span class="n">set</span> <span class="n">α</span><span class="o">))</span>
  <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="bp">∀</span><span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">C</span><span class="o">),</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">s</span><span class="o">}</span> <span class="o">(</span><span class="n">hf</span> <span class="o">:</span> <span class="bp">∀</span><span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">C</span><span class="o">),</span> <span class="n">surjective</span> <span class="o">(</span><span class="n">f</span> <span class="n">s</span><span class="o">))</span> <span class="o">:</span>
  <span class="o">(</span><span class="err">⋃</span><span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">range</span> <span class="o">(</span><span class="bp">λ</span><span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">C</span><span class="o">),</span> <span class="o">(</span><span class="n">f</span> <span class="n">s</span> <span class="n">y</span><span class="o">)</span><span class="bp">.</span><span class="n">val</span><span class="o">))</span> <span class="bp">=</span> <span class="err">⋃₀</span> <span class="n">C</span> <span class="o">:=</span>
</code></pre></div>



<a name="195747954"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195747954" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195747954">(Apr 29 2020 at 18:03)</a>:</h4>
<p>(By "nontrivial", I mean something not directly related to transitive coercions. Obviously the fix for this example is still simple.)</p>



<a name="195751341"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195751341" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195751341">(Apr 29 2020 at 18:31)</a>:</h4>
<p>I recommend explicitly putting in multiple type ascriptions whenever we literally want a transitive coercion</p>



<a name="195797044"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195797044" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195797044">(Apr 30 2020 at 04:15)</a>:</h4>
<p>I got distracted from this project, but a second class of issues are ones where we define a new type and a <code>has_coe</code> instance for it to another type that has a coercion to function/sort, and expect the new type to also have a coercion to function/sort. A prototypical example is <code>subgroup G</code> which has a coercion to <code>set G</code>. These are easily addressed by adding an explicit <code>has_coe_to_sort</code> instance.</p>



<a name="195810897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195810897" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195810897">(Apr 30 2020 at 08:32)</a>:</h4>
<p>These need to be fixed anyhow.  Transitive coercion instances are not in simp-normal form.</p>



<a name="195833474"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195833474" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195833474">(Apr 30 2020 at 12:47)</a>:</h4>
<p>If we want to make this change, it might be handy to write a little attribute we can put on <code>has_coe</code> instances to automatically generate <code>has_coe_to_sort</code>/<code>has_coe_to_fun</code> instances--though they're quite easy to write by hand also: I've been using things like</p>
<div class="codehilite"><pre><span></span><code><span class="kn">instance</span> <span class="o">:</span> <span class="n">has_coe_to_sort</span> <span class="o">(</span><span class="n">submodule</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">coe_sort_trans</span> <span class="bp">_</span> <span class="o">(</span><span class="n">set</span> <span class="n">M</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span>
</code></pre></div>


<p>and it seems to be working so far...</p>



<a name="195833586"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195833586" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195833586">(Apr 30 2020 at 12:48)</a>:</h4>
<p>In a fancier system, maybe it would be worth thinking of "an R-submodule of M is a set" as a different kind of thing from "a natural number is an integer"</p>



<a name="195833748"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195833748" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195833748">(Apr 30 2020 at 12:50)</a>:</h4>
<p>Haha, I briefly panicked when a <code>dsimp</code> in the middle of some random proof stopped working, but I just deleted it and all is well <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="195835973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195835973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195835973">(Apr 30 2020 at 13:09)</a>:</h4>
<p>Whoa, it builds <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <br>
<code> 20 files changed, 38 insertions(+), 37 deletions(-)</code></p>



<a name="195836090"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195836090" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195836090">(Apr 30 2020 at 13:10)</a>:</h4>
<p>That's actually a rather small diff</p>



<a name="195836124"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195836124" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195836124">(Apr 30 2020 at 13:10)</a>:</h4>
<p>and a little bit is commenting out things that should just be deleted, so it actually saves a few lines overall</p>



<a name="195836160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195836160" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195836160">(Apr 30 2020 at 13:11)</a>:</h4>
<p>And speeds up the build, I guess</p>



<a name="195836192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195836192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195836192">(Apr 30 2020 at 13:11)</a>:</h4>
<p>But probably not noticable</p>



<a name="195838136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195838136" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195838136">(Apr 30 2020 at 13:28)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/commit/8ef91f54a9c689f2560b8670e573bb3a79d15940" title="https://github.com/leanprover-community/mathlib/commit/8ef91f54a9c689f2560b8670e573bb3a79d15940">Here</a> is the commit if anyone is interested; there are some bits like the <code>has_coe_to_fun_linter</code> which I don't understand yet.</p>



<a name="195838160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195838160" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195838160">(Apr 30 2020 at 13:29)</a>:</h4>
<p>I assume it doesn't build with the current version of Lean, but I suppose it might</p>



<a name="195838361"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195838361" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195838361">(Apr 30 2020 at 13:30)</a>:</h4>
<p>Ah, the CI build failed immediately because of my change to <code>leanpkg.toml</code>--probably for the best <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="195841201"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195841201" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195841201">(Apr 30 2020 at 13:50)</a>:</h4>
<p>The <code>has_coe_to_fun</code> linter is supposed to check for exactly this kind of problem, where a type has a <code>has_coe</code> instance but no <code>has_coe_to_fun</code>.  If the transitive instances are gone, then the linter is no longer necessary.</p>



<a name="195944511"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195944511" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195944511">(May 01 2020 at 09:31)</a>:</h4>
<p>So here's my proposal (<a href="https://github.com/leanprover-community/mathlib/compare/rwbarton-no-trans" title="https://github.com/leanprover-community/mathlib/compare/rwbarton-no-trans">https://github.com/leanprover-community/mathlib/compare/rwbarton-no-trans</a>):</p>
<ol>
<li>Remove <code>coe_fn_trans</code> and <code>coe_sort_trans</code> as instances from core, turning them into <code>@[reducible] def</code>s (so that they can be used as the definitions of instances, and will still be transparent to instance search).</li>
<li>Remove the related simp lemmas (even though I guess we could keep them, they don't seem to be useful any more), library notes, linter in mathlib.</li>
<li>Add back instances <code>instance {α : Sort*} [has_coe_to_fun α] (p : α → Prop) : has_coe_to_fun (subtype p)</code>, <code> instance {α : Sort*} [has_coe_to_sort α] (p : α → Prop) : has_coe_to_sort (subtype p)</code> to core. (Currently they are in my mathlib patch rather than core but that is only out of laziness.) These are Haskell 98-style instances so they should not cause any trouble--there's exactly one way to treat <code>x : subtype p</code> as a function/sort, namely by treating <code>x.val</code> as a function/sort.</li>
<li>Add back <code>has_coe_to_sort</code>/<code>has_coe_to_fun</code> instances for things like <code>lie_subalgebra</code>, <code>M ≃L[R] M₂</code> (whatever this is), etc.--there's a fairly small number of these.</li>
</ol>



<a name="195944601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195944601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195944601">(May 01 2020 at 09:32)</a>:</h4>
<p>Actually I guess in 4, all the <code>has_coe_to_fun</code> instances already existed (thanks to the linter) but I had to reimplement some of them to not rely on the transitive instance.</p>



<a name="195944624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195944624" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195944624">(May 01 2020 at 09:33)</a>:</h4>
<p>Or more precisely: not rely on <code>coe_fn_trans</code> being an instance (now they invoke it by name).</p>



<a name="195944662"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195944662" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195944662">(May 01 2020 at 09:34)</a>:</h4>
<p>Overall, the change seems like a simplification, besides fixing the strange coercion of <code>nat</code> to <code>nat -&gt; real</code> (though I haven't actually tested this).</p>



<a name="195944771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195944771" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195944771">(May 01 2020 at 09:35)</a>:</h4>
<p>The alternative as I see it is to be a lot more judicious with the choice between <code>has_coe</code> and <code>has_coe_t</code>--in principle this seems better as it generalizes what I did for <code>subtype</code> specifically, but I'm not sure whether we can be trusted to choose wisely. Maybe <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span>'s linter from <a href="https://github.com/leanprover-community/mathlib/issues/2573" title="https://github.com/leanprover-community/mathlib/issues/2573">#2573</a> will help with that though?</p>



<a name="195944986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195944986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195944986">(May 01 2020 at 09:38)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/2573" title="https://github.com/leanprover-community/mathlib/issues/2573">#2573</a> moves some coercions (<code>ℕ → α</code>, etc.) to <code>has_coe_t</code>.  These will hence no longer participate in function coercion.  Not sure if this was the problem here.</p>



<a name="195945034"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945034" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945034">(May 01 2020 at 09:39)</a>:</h4>
<p>I think it was <code>int → α</code> that was involved here.</p>



<a name="195945162"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945162" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945162">(May 01 2020 at 09:41)</a>:</h4>
<p>I have mixed feelings about the proposed change here.  I detest transitive coercions as much as everyone here, and would remove them today if it helped.  But I fear that these instances will just come back in a few months.</p>



<a name="195945310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945310">(May 01 2020 at 09:43)</a>:</h4>
<p>By "these instances" do you mean ones like <code>int → α</code>? Or <code>coe_fn_trans</code> as a global instance? Or ones like those I added for <code>subtype</code>?</p>



<a name="195945379"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945379" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945379">(May 01 2020 at 09:44)</a>:</h4>
<p><code>coe_fn_trans</code></p>



<a name="195945405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945405">(May 01 2020 at 09:44)</a>:</h4>
<p>The others are in mathlib, we can remove or change them as much as we want.</p>



<a name="195945436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945436">(May 01 2020 at 09:45)</a>:</h4>
<p>Ohh, you mean in Lean 4.</p>



<a name="195945456"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945456" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945456">(May 01 2020 at 09:45)</a>:</h4>
<p>I thought you meant the feature creep of people adding more and more instances because they look nice, and then it falls apart.</p>



<a name="195945672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945672">(May 01 2020 at 09:48)</a>:</h4>
<p>I am also happy with your approach in <a href="https://github.com/leanprover-community/mathlib/issues/2573" title="https://github.com/leanprover-community/mathlib/issues/2573">#2573</a> as long as we can communicate clearly how to decide whether to use <code>has_coe</code> or <code>has_coe_t</code> and enforce it.</p>



<a name="195945729"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945729" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945729">(May 01 2020 at 09:49)</a>:</h4>
<p>Indeed I already thought when writing those <code>subtype</code> instances that they could be part of a more general system, and then realized the general system already existed but we were not using it correctly.</p>



<a name="195945903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945903">(May 01 2020 at 09:51)</a>:</h4>
<p>We can have linters that see all modules at once, to check for things like cycles, right?</p>



<a name="195945908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195945908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195945908">(May 01 2020 at 09:51)</a>:</h4>
<p>The fixes in <a href="https://github.com/leanprover-community/mathlib/issues/2573" title="https://github.com/leanprover-community/mathlib/issues/2573">#2573</a> are necessary irrespective of whether we remove <code>coe_fn_trans</code> and <code>coe_sort_trans</code> or not.  The issues already pop up with regular coercions.  My one-size-fits-all solution for enforcement and communication is of course a linter, which the PR includes.</p>



<a name="195951331"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195951331" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195951331">(May 01 2020 at 11:12)</a>:</h4>
<p>I think it would be a huge mistake to start refactoring mathlib in a way which is guaranteed to make the Lean 4 migration more painful.</p>



<a name="195951421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195951421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195951421">(May 01 2020 at 11:14)</a>:</h4>
<p>Well, it can't be that huge a mistake because the diff already exists and it is +31 -128 lines of code.</p>



<a name="195951451"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195951451" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195951451">(May 01 2020 at 11:15)</a>:</h4>
<p>This is only an abstract comment based on Gabriel's message</p>



<a name="195951461"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195951461" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195951461">(May 01 2020 at 11:15)</a>:</h4>
<p>I have no clue about the current discussion</p>



<a name="195951796"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195951796" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195951796">(May 01 2020 at 11:20)</a>:</h4>
<p>Sure, I just mean that as it happens we are fortunately not discussing any herculean effort.</p>



<a name="195952111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195952111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195952111">(May 01 2020 at 11:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/113488-general/topic/transitive.20coercions/near/195951331" title="#narrow/stream/113488-general/topic/transitive.20coercions/near/195951331">said</a>:</p>
<blockquote>
<p>I think it would be a huge mistake to start refactoring mathlib in a way which is guaranteed to make the Lean 4 migration more painful.</p>
</blockquote>
<p>I think it would be a huge mistake to take everything in lean 4 as gospel, because that's what lead to the situation where we worked around lean 3 bugs for a year. I think we should try to make the best lean we can, and when lean 4 comes out we will either forward port our changes to lean 4 or fork if necessary. I'm not about to lose progress made in lean 3 on account of the new version.</p>



<a name="195952619"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195952619" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195952619">(May 01 2020 at 11:32)</a>:</h4>
<p>This might be obvious, but I don't think we should move to lean 4 until it is better than lean 3.10 or whatever the latest version is at that time. Ideally that would be better in every way (pareto-dominant), but for every thing that we have to sacrifice it should be a conscious decision based on a cost-benefit tradeoff. That means in particular that all the little tweaks and additions that are going into later lean 3 versions should be mimicked appropriately, and of course all the theorems should be carried over. If that sounds like a long and difficult process, I agree, I think we will be on lean 3 for a while yet.</p>



<a name="195953438"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195953438" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195953438">(May 01 2020 at 11:47)</a>:</h4>
<p>Well... doesn't the CamelCase allready rule out pareto-dominance? <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="195957337"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195957337" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195957337">(May 01 2020 at 12:46)</a>:</h4>
<p>Mario, you know this will not happen. If Lean 4 achieves half of what it promises then it will be much better than Lean 3 and we'll switch. And nobody will have the time, skill and energy to maintain a fork while Lean 4 will continue to change.</p>



<a name="195958227"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195958227" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195958227">(May 01 2020 at 13:00)</a>:</h4>
<p>At the very least, I would want roadmaps and open issues for <em>every</em> feature that we leave behind in our anxiety to ride the next wave</p>



<a name="195958450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195958450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195958450">(May 01 2020 at 13:03)</a>:</h4>
<p>Whether or not a fork is necessary depends on interaction between Leo &amp; co and mathlib &amp; co. So far it's basically nil, and there is some evidence that this is not merely because lean 4 is an separate project from mathlib, so I am not expecting this to change to another governance structure when it matures</p>



<a name="195958743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195958743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195958743">(May 01 2020 at 13:06)</a>:</h4>
<p>Whether there is interactivity in the future will, I should think, depend a lot on whether our community manages to hold back and let Leo and his team deal with issues which are important to them, or whether we just flood the issues page with complaints that it's not like how it was and could they please fix it.</p>



<a name="195958929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195958929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195958929">(May 01 2020 at 13:08)</a>:</h4>
<p>It will be a delicate balancing act.</p>



<a name="195958958"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195958958" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195958958">(May 01 2020 at 13:08)</a>:</h4>
<p>But one thing we do need to remember is that there were a hell of a lot of issues with Lean 3 which we managed to deal with on the mathlib side</p>



<a name="195959161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195959161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195959161">(May 01 2020 at 13:10)</a>:</h4>
<p>I wasn't there at the time, but one impression I got was that Leo does not take kindly to being told that what he did was not as good as doing it some other way, especially when he can see subtle problems with the other way which are not apparent to most.</p>



<a name="195971827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195971827" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195971827">(May 01 2020 at 15:24)</a>:</h4>
<p>Since coercions are a hot topic today, let me ask again about the issue of simp and coercions. In the following code</p>
<div class="codehilite"><pre><span></span><code><span class="kn">variable</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span>

<span class="kn">structure</span> <span class="n">my_equiv</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">to_fun</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_coe_to_fun</span> <span class="o">(</span><span class="n">my_equiv</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">my_equiv</span><span class="bp">.</span><span class="n">to_fun</span><span class="bp">⟩</span>

<span class="n">def</span> <span class="n">my_equiv1</span> <span class="o">:</span> <span class="n">my_equiv</span> <span class="n">α</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="n">id</span> <span class="o">}</span>

<span class="n">def</span> <span class="n">my_equiv2</span> <span class="o">:</span> <span class="n">my_equiv</span> <span class="n">α</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="n">id</span> <span class="o">}</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">one_eq_two</span> <span class="o">:</span> <span class="n">my_equiv1</span> <span class="n">α</span> <span class="bp">=</span> <span class="n">my_equiv2</span> <span class="n">α</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">two_apply</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">my_equiv2</span> <span class="n">α</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">lemma</span> <span class="n">one_apply</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">my_equiv1</span> <span class="n">α</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">simp</span> <span class="c1">-- fails</span>
</code></pre></div>


<p><code>simp</code> fails in the last lemma, because it should simplify in a coercion and it is unable to do this. This is the reason why, in manifolds, I could not use coercions and I used <code>e.to_fun</code> and <code>e.inv_fun</code> all over the place. Is this something that is so deeply buried in C++ that there is no hope to fix it?</p>



<a name="195973249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195973249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195973249">(May 01 2020 at 15:36)</a>:</h4>
<p>I don't think this is something we can easily fix in mathlib.  The core problem is that <code>has_coe_to_fun</code> doesn't necessarily coerce to a function.</p>



<a name="195973292"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195973292" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195973292">(May 01 2020 at 15:37)</a>:</h4>
<p>Doesn't not?</p>



<a name="195973313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195973313" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195973313">(May 01 2020 at 15:37)</a>:</h4>
<p>I am confused either way</p>



<a name="195973771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195973771" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195973771">(May 01 2020 at 15:41)</a>:</h4>
<p>It's confusing.</p>



<a name="195974163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195974163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195974163">(May 01 2020 at 15:45)</a>:</h4>
<p>I guess the problem is <code>my_equiv1 α x</code> means <code>coe_fn (my_equiv1 α) x</code> but <code>coe_fn</code> has a dependent type: <code>coe_fn (my_equiv1 α)</code> has type <code>has_coe_to_fun.F (my_equiv1 α)</code>. That means rewriting <code>my_equiv1 α</code> to  <code>my_equiv2 α</code> might result in a type-incorrect expression.</p>



<a name="195974228"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195974228" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195974228">(May 01 2020 at 15:45)</a>:</h4>
<p>Of course in this case it does not because <code>has_coe_to_fun.F (my_equiv1 α)</code> and <code>has_coe_to_fun.F (my_equiv2 α)</code> are definitionally equal (they are both <code>α -&gt; α</code>).</p>



<a name="195974349"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195974349" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195974349">(May 01 2020 at 15:46)</a>:</h4>
<p>I actually never knew about this issue because I would always abandon coercions earlier when <code>α</code> could not be inferred in <code>my_equiv1 α x</code>.</p>



<a name="195974730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195974730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195974730">(May 01 2020 at 15:50)</a>:</h4>
<p>Do we actually use dependent function coercions?  That is, 1) where <code>coe_fn a : α a → β a</code> depends on <code>a</code>, or 2) where <code>coe_fn a : ∀ x : α, β x</code> is a dependent function?</p>



<a name="195974810"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195974810" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195974810">(May 01 2020 at 15:51)</a>:</h4>
<p>I wouldn't be surprised if <code>dfinsupp</code> is an example of 2</p>



<a name="195974824"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195974824" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195974824">(May 01 2020 at 15:51)</a>:</h4>
<p>But 1 would be more surprising I think...</p>



<a name="195981925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195981925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195981925">(May 01 2020 at 16:55)</a>:</h4>
<p>I would love having two versions of <code>has_coe_to_fun</code>, a non-dependent one where simp would work, and a dependent one <code>has_coe_to_dep_fun</code> where it wouldn't. Because I guess in 99% of the situations we use a non-dependent version...</p>



<a name="195986031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195986031" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195986031">(May 01 2020 at 17:28)</a>:</h4>
<p><a href="https://github.com/leanprover-community/lean/issues/209" title="https://github.com/leanprover-community/lean/issues/209">lean#209</a></p>



<a name="195988630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195988630" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195988630">(May 01 2020 at 17:48)</a>:</h4>
<p>Gabriel, do you understand the Lean 4 answer here? I remember Sebastian pointed out a commit "simplifying coercions to functions"</p>



<a name="195991460"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/195991460" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#195991460">(May 01 2020 at 18:13)</a>:</h4>
<p>As far as Sébastien's problem is concerned, the <code>coeFun</code> function has essentially the same signature: <a href="https://github.com/leanprover/lean4/blob/0c4030137f24f2371db85469de2f627eccbb1703/src/Init/Coe.lean#L59-L60" title="https://github.com/leanprover/lean4/blob/0c4030137f24f2371db85469de2f627eccbb1703/src/Init/Coe.lean#L59-L60">https://github.com/leanprover/lean4/blob/0c4030137f24f2371db85469de2f627eccbb1703/src/Init/Coe.lean#L59-L60</a>  The only difference is that the function space is now an out param.  I don't think there are congruence lemmas yet in Lean 4.</p>



<a name="196038635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/196038635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#196038635">(May 02 2020 at 07:32)</a>:</h4>
<p>Gabriel, will your fix for <code>simp</code> in <code>has_coe_to_fun</code> also fix the <code>congr</code> behavior? I mean</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">basic</span>

<span class="kn">variable</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span>

<span class="kn">structure</span> <span class="n">my_equiv</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">to_fun</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_coe_to_fun</span> <span class="o">(</span><span class="n">my_equiv</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">my_equiv</span><span class="bp">.</span><span class="n">to_fun</span><span class="bp">⟩</span>

<span class="kn">lemma</span> <span class="n">fail</span> <span class="o">(</span><span class="n">e</span> <span class="n">f</span> <span class="o">:</span> <span class="n">my_equiv</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">e</span> <span class="bp">=</span> <span class="n">f</span><span class="o">)</span> <span class="o">:</span> <span class="n">e</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">unfold_coes</span><span class="o">,</span>
  <span class="n">congr</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">h</span>
<span class="kn">end</span>
</code></pre></div>


<p>Without the <code>unfold_coes</code>, <code>congr</code> does not work. I guess it is because it has to identify <code>has_coe_to_fun.F</code> on the left and on the right, but since it has lost the information on the type it is working with, there is no way it can do this. Even <code>congr' 1</code> fails here. I have learnt to always unfold coercions before applying <code>congr</code>, but this can be a tricky one the first time you encounter it.</p>



<a name="196040620"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/196040620" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#196040620">(May 02 2020 at 08:29)</a>:</h4>
<p>Works for me both with and without <code>unfold_coes</code>.</p>



<a name="196040637"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/196040637" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#196040637">(May 02 2020 at 08:29)</a>:</h4>
<p>You mean, on Lean 3.9 or Lean 3.10?</p>



<a name="196040690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/196040690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#196040690">(May 02 2020 at 08:30)</a>:</h4>
<p>Lean 3.10.</p>



<a name="196040696"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/transitive%20coercions/near/196040696" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/transitive.20coercions.html#196040696">(May 02 2020 at 08:31)</a>:</h4>
<p>Great, thanks again!</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>