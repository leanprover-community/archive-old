---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html">algebra.semiring_to_ring breaks semimodule typeclass lookup</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="212582179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212582179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212582179">(Oct 07 2020 at 16:12)</a>:</h4>
<p>Which is consistent with <code>haveI : semimodule ℕ (tensor_algebra R M) := infer_instance,</code> succeeding and <code>haveI : semimodule R (tensor_algebra R M) := infer_instance,</code> failing. I can only assume this failure is very related to <a href="https://github.com/leanprover-community/mathlib/issues/4289">#4289</a>, which is unfortunate, because it means that we can't do subtraction in the tensor / free / clifford /... algebras</p>



<a name="212582547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212582547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212582547">(Oct 07 2020 at 16:15)</a>:</h4>
<p>this is beyond my pay grade <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="212582899"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212582899" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212582899">(Oct 07 2020 at 16:17)</a>:</h4>
<p>Perhaps a better <a href="https://leanprover-community.github.io/mwe.html">#mwe</a>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.tensor_algebra</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">semimodule</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:</span> <span class="n">sorry</span> <span class="o">:=</span> <span class="kd">begin</span>
  <span class="c1">-- this poisons the instance cache somehow and makes the next line fail</span>
  <span class="n">haveI</span> <span class="o">:</span> <span class="n">ring</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">algebra.semiring_to_ring</span> <span class="n">R</span><span class="o">,</span>
  <span class="n">haveI</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">infer_instance</span><span class="o">,</span>
  <span class="n">sorry</span>
<span class="kd">end</span>
</code></pre></div>



<a name="212582947"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212582947" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212582947">(Oct 07 2020 at 16:17)</a>:</h4>
<p>Whose pay grade might this be within? It's certainly well beyond mine...</p>



<a name="212583106"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212583106" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212583106">(Oct 07 2020 at 16:18)</a>:</h4>
<p><code>haveI : ring ...</code> is almost always wrong, should be <code>letI</code> at least</p>



<a name="212583122"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212583122" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212583122">(Oct 07 2020 at 16:18)</a>:</h4>
<p>without any other idea of what is happening here</p>



<a name="212583313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212583313" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212583313">(Oct 07 2020 at 16:20)</a>:</h4>
<p>Behavior is the same either way</p>



<a name="212584556"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212584556" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212584556">(Oct 07 2020 at 16:30)</a>:</h4>
<p>To take <code>tactics</code> out of the equation, this also fails:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.tensor_algebra</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">semimodule</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span>

<span class="c1">-- this poisons the instance cache somehow and makes the next line fail</span>
<span class="kd">instance</span> <span class="o">:</span> <span class="n">ring</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">algebra.semiring_to_ring</span> <span class="n">R</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">infer_instance</span>
</code></pre></div>

<p>Unfortunately I can't ask the author of <a href="https://leanprover-community.github.io/mathlib_docs/find/algebra.semiring_to_ring">docs#algebra.semiring_to_ring</a> what the problem is, as that's me...</p>



<a name="212584757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212584757" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212584757">(Oct 07 2020 at 16:31)</a>:</h4>
<p>what's the error</p>



<a name="212584803"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212584803" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212584803">(Oct 07 2020 at 16:32)</a>:</h4>
<p>Unhelpful:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">failed</span> <span class="n">to</span> <span class="n">synthesize</span> <span class="n">type</span> <span class="kd">class</span> <span class="kd">instance</span> <span class="n">for</span>
<span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_1</span><span class="o">,</span>
<span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_2</span><span class="o">,</span>
<span class="n">_inst_1</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="n">M</span><span class="o">,</span>
<span class="n">_inst_2</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">R</span><span class="o">,</span>
<span class="n">_inst_3</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="n">M</span>
<span class="bp">⊢</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span>
</code></pre></div>



<a name="212585024"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212585024" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212585024">(Oct 07 2020 at 16:33)</a>:</h4>
<p>The tactic state showed by vs-code is identical with and without the poisoned line, the only difference is whether it succeeds or fails</p>



<a name="212585261"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212585261" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212585261">(Oct 07 2020 at 16:35)</a>:</h4>
<p>What happens if in <code>semiring_to_ring</code> you swap the two <code>..</code> lines?</p>



<a name="212585481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212585481" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212585481">(Oct 07 2020 at 16:37)</a>:</h4>
<p>Will try that. FWIW, with verbose printing the difference between good and bad is</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">--- bad</span>
<span class="gi">+++ good</span>
<span class="gu">@@ -7,10 +7,9 @@</span>
R : Type u_1,
M : Type u_2,
_inst_1 : add_comm_group M,
_inst_2 : comm_ring R,
_inst_3 :
  @semimodule R M (@ring.to_semiring R (@comm_ring.to_ring R _inst_2)) (@add_comm_group.to_add_comm_monoid M _inst_1)
 ⊢ @semimodule R
     (@tensor_algebra R (@comm_ring.to_comm_semiring R _inst_2) M (@add_comm_group.to_add_comm_monoid M _inst_1) _inst_3)
     (@ring.to_semiring R (@comm_ring.to_ring R _inst_2))
<span class="gd">-    (@add_comm_group.to_add_comm_monoid</span>
<span class="gi">+    (@semiring.to_add_comm_monoid</span>
        (@tensor_algebra R (@comm_ring.to_comm_semiring R _inst_2) M (@add_comm_group.to_add_comm_monoid M _inst_1)
           _inst_3)
<span class="gd">-       (@ring.to_add_comm_group</span>
<span class="gd">-          (@tensor_algebra R (@comm_ring.to_comm_semiring R _inst_2) M (@add_comm_group.to_add_comm_monoid M _inst_1)</span>
<span class="gd">-             _inst_3)</span>
<span class="gd">-          (@tensor_algebra.ring R M _inst_1 _inst_2 _inst_3)))</span>
<span class="gi">+       (@tensor_algebra.semiring R (@comm_ring.to_comm_semiring R _inst_2) M</span>
<span class="gi">+          (@add_comm_group.to_add_comm_monoid M _inst_1)</span>
<span class="gi">+          _inst_3))</span>
</code></pre></div>



<a name="212585726"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212585726" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212585726">(Oct 07 2020 at 16:39)</a>:</h4>
<p>Currently my theory, which may or may not be possible, is that finding the <code>semimodule R (tensor_algebra R M)</code> instance requires the entire <code>semiring (tensor_algebra R M)</code> instance to match (not just match fieldwise, because of a lack of eta expansion for structures) and that the way that <code>algebra.semiring_to_ring</code> is implemented causes the underlying <code>semiring</code> to be broken up and reassembled rather than preserved as a unit.</p>



<a name="212585930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212585930" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212585930">(Oct 07 2020 at 16:41)</a>:</h4>
<p>Yeah, the idea seems sensible to me</p>



<a name="212586542"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212586542" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212586542">(Oct 07 2020 at 16:46)</a>:</h4>
<p>actually, wait. These are <code>old_structure_cmd</code> structures, right? So the <code>semiring</code> instance is never preserved as a unit</p>



<a name="212586555"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212586555" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212586555">(Oct 07 2020 at 16:46)</a>:</h4>
<p>I'm confused how this doesn't cause more problems in general</p>



<a name="212586617"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212586617" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212586617">(Oct 07 2020 at 16:47)</a>:</h4>
<p>Yes, they are. I don't know what <code>this </code>refers to, but <code>semiring_to_ring</code> is currently used in only one place</p>



<a name="212587122"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212587122" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212587122">(Oct 07 2020 at 16:51)</a>:</h4>
<p>Finallly tested your idea - it made no difference unfortunately</p>



<a name="212587791"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212587791" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212587791">(Oct 07 2020 at 16:56)</a>:</h4>
<p>An even further reduced example without <code>infer_instance</code>, that gives a better error message:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.tensor_algebra</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">semimodule</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span>

<span class="kd">instance</span> <span class="n">working_instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">infer_instance</span>

<span class="c1">-- this poisons the instance cache somehow and makes the next line fail</span>
<span class="kd">instance</span> <span class="o">:</span> <span class="n">ring</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">algebra.semiring_to_ring</span> <span class="n">R</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">working_instance</span> <span class="n">R</span> <span class="n">M</span>
</code></pre></div>

<div class="spoiler-block"><div class="spoiler-header">

<p>Error message</p>
</div><div class="spoiler-content" aria-hidden="true">

<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">type</span> <span class="n">mismatch</span><span class="o">,</span> <span class="n">term</span>
  <span class="n">working_instance</span> <span class="n">R</span> <span class="n">M</span>
<span class="n">has</span> <span class="n">type</span>
  <span class="bp">@</span><span class="n">semimodule</span> <span class="n">R</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="n">_inst_3</span><span class="o">)</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">))</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="bp">@</span><span class="n">semimodule</span> <span class="n">R</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="n">_inst_3</span><span class="o">)</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="n">_inst_3</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.ring</span> <span class="n">R</span> <span class="n">M</span> <span class="n">_inst_1</span> <span class="n">_inst_2</span> <span class="n">_inst_3</span><span class="o">)))</span>
</code></pre></div>

</div></div>



<a name="212588660"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212588660" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212588660">(Oct 07 2020 at 17:02)</a>:</h4>
<p>OK, now I understand why what I was worried about before isn't a problem. Both <code>semiring.to_add_comm_monoid</code> and <code>add_comm_group.to_add_comm_monoid</code> are going to return constructors of the form <code>{ add := ..., zero := ..., ... }</code> so they will be defeq as soon as the <code>add</code> and <code>zero</code> fields are defeq.<br>
So, that suggests that the <code>add</code> and/or <code>zero</code> fields must not be defeq for some reason...</p>



<a name="212589552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212589552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212589552">(Oct 07 2020 at 17:09)</a>:</h4>
<p>I'll have a go at proving the types are equal...</p>



<a name="212590192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212590192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212590192">(Oct 07 2020 at 17:14)</a>:</h4>
<p>I managed to reproduce the error in whatever version of mathlib I have lying around so I no longer have to pester you with things to try.</p>



<a name="212590489"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212590489" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212590489">(Oct 07 2020 at 17:16)</a>:</h4>
<p>Curiously Lean does seem to think both the <code>add</code> and <code>zero</code> fields of those instances are defeq even though the instances are not.<br>
It would be nice to have a <code>#whnf</code> user command...</p>



<a name="212590562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212590562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212590562">(Oct 07 2020 at 17:16)</a>:</h4>
<p>I was at least able to get to the point where the definitions looked almost equal:</p>
<div class="spoiler-block"><div class="spoiler-header">

<p>Long code...</p>
</div><div class="spoiler-content" aria-hidden="true">

<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.tensor_algebra</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">semimodule</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span>

<span class="kd">def</span> <span class="n">old_type</span> <span class="o">:=</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">))</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">ring</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">algebra.semiring_to_ring</span> <span class="n">R</span>

<span class="kd">def</span> <span class="n">new_type</span> <span class="o">:=</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="n">_inst_3</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.ring</span> <span class="n">R</span> <span class="n">M</span> <span class="n">_inst_1</span> <span class="n">_inst_2</span> <span class="n">_inst_3</span><span class="o">)))</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">new_type</span> <span class="n">R</span> <span class="n">M</span> <span class="bp">=</span> <span class="n">old_type</span> <span class="n">R</span> <span class="n">M</span> <span class="o">:=</span> <span class="kd">begin</span>
  <span class="n">unfold</span> <span class="n">new_type</span> <span class="n">old_type</span><span class="o">,</span>
  <span class="n">dunfold</span> <span class="n">add_comm_group.to_add_comm_monoid</span><span class="o">,</span>
  <span class="n">dunfold</span> <span class="n">semiring.to_add_comm_monoid</span><span class="o">,</span>
  <span class="n">dunfold</span> <span class="n">ring.to_add_comm_group</span><span class="o">,</span>
  <span class="n">dunfold</span> <span class="n">tensor_algebra.ring</span><span class="o">,</span>
  <span class="n">dunfold</span> <span class="n">algebra.semiring_to_ring</span><span class="o">,</span>
  <span class="n">dunfold</span> <span class="n">tensor_algebra.semiring</span><span class="o">,</span>
  <span class="n">dunfold</span> <span class="n">semimodule.add_comm_monoid_to_add_comm_group</span><span class="o">,</span>
  <span class="n">dunfold</span> <span class="n">infer_instance</span><span class="o">,</span>
  <span class="n">dunfold</span> <span class="n">semiring.to_add_comm_monoid</span><span class="o">,</span>
  <span class="n">simp</span> <span class="n">only</span><span class="o">,</span>
  <span class="n">refl</span><span class="o">,</span>  <span class="c1">-- fails, but things look the same</span>
<span class="kd">end</span>
</code></pre></div>

</div></div>



<a name="212590965"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212590965" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212590965">(Oct 07 2020 at 17:20)</a>:</h4>
<p>Curiously Lean also thinks both instances reduce to constructors--sorry for atrocious formatting:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#check</span> <span class="o">(</span><span class="n">rfl</span> <span class="o">:</span> <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">))</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">add_comm_monoid.mk</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span>

<span class="k">#check</span> <span class="o">(</span><span class="n">rfl</span> <span class="o">:</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="n">_inst_3</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.ring</span> <span class="n">R</span> <span class="n">M</span> <span class="n">_inst_1</span> <span class="n">_inst_2</span> <span class="n">_inst_3</span><span class="o">)))</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">add_comm_monoid.mk</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span>
</code></pre></div>



<a name="212591487"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212591487" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212591487">(Oct 07 2020 at 17:24)</a>:</h4>
<p>Curiously <code>congr</code> closes your goal that <code>refl</code> can't, and looking at the term is not illuminating...</p>



<a name="212593330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212593330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212593330">(Oct 07 2020 at 17:38)</a>:</h4>
<p>Well this is something, Lean apparently doesn't think the <code>add_assoc</code> fields of these two instance are equal, even though they are proofs of the same proposition. Same for the other proof fields I tested.</p>



<a name="212593885"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212593885" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212593885">(Oct 07 2020 at 17:42)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.tensor_algebra</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">_inst_1</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">_inst_2</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">_inst_3</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span>

<span class="kd">instance</span> <span class="n">working_instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">infer_instance</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">ring</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">algebra.semiring_to_ring</span> <span class="n">R</span>

<span class="kd">def</span> <span class="n">x</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">add_comm_monoid.add_assoc</span> <span class="n">_</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">))</span>
  <span class="bp">=</span>
  <span class="bp">@</span><span class="n">add_comm_monoid.add_assoc</span> <span class="n">_</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="n">_inst_3</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.ring</span> <span class="n">R</span> <span class="n">M</span> <span class="n">_inst_1</span> <span class="n">_inst_2</span> <span class="n">_inst_3</span><span class="o">)))</span> <span class="o">:=</span>
<span class="n">rfl</span>                             <span class="c1">-- doesn't work</span>
<span class="c">/-</span><span class="cm">     -- works</span>
<span class="cm">begin</span>
<span class="cm">  have : ∀ (P : Prop) (p q : P), p = q := λ P p q, rfl,</span>
<span class="cm">  apply this,</span>
<span class="cm">end  -/</span>
</code></pre></div>



<a name="212595043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212595043" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212595043">(Oct 07 2020 at 17:51)</a>:</h4>
<p>Well that's bizarre</p>



<a name="212595703"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212595703" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212595703">(Oct 07 2020 at 17:57)</a>:</h4>
<p><code>attribute [semireducible] tensor_algebra</code> fixes your example, and some but not all of the ones in this thread</p>



<a name="212595739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212595739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212595739">(Oct 07 2020 at 17:57)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="110087">@Scott Morrison</span>, who suggested that it should be irreducible (which without that line it currently is)</p>



<a name="212596326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212596326" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212596326">(Oct 07 2020 at 18:02)</a>:</h4>
<p>OK, well, that makes a tiny bit more sense I guess. The two sides really are defeq but the elaborator thinks they aren't?<br>
It's worth noting that you do have to do some work to see that the two proofs are proofs of the same proposition (because they are about syntactically different <code>+</code>s). I don't see what making the type <code>tensor_algebra</code> not irreducible would have to do with this, though.</p>



<a name="212596759"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212596759" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212596759">(Oct 07 2020 at 18:05)</a>:</h4>
<p>Even with this <code>irreducible</code> business it's still really weird. The elaborator knows the two sides have the same type because there is no type error if you put <code>_</code> as the definition (or indeed the <code>begin...end</code> block in the comment).</p>



<a name="212597119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212597119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212597119">(Oct 07 2020 at 18:08)</a>:</h4>
<p>It also makes me wonder how much work Lean does in general checking that proofs are defeq</p>



<a name="212611421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212611421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212611421">(Oct 07 2020 at 19:58)</a>:</h4>
<p>Oh, the conclusion of this thread is not good at all</p>



<a name="212611471"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212611471" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212611471">(Oct 07 2020 at 19:59)</a>:</h4>
<p>Lean should definitely have an early out checking that proofs are defeq</p>



<a name="212614697"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212614697" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212614697">(Oct 07 2020 at 20:25)</a>:</h4>
<p>I guess it would be good to create a self-contained reproducer.</p>



<a name="212620699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212620699" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212620699">(Oct 07 2020 at 21:18)</a>:</h4>
<p>Without mathlib, you mean?</p>



<a name="212620865"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212620865" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212620865">(Oct 07 2020 at 21:20)</a>:</h4>
<p>Yes.</p>



<a name="212646832"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212646832" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212646832">(Oct 08 2020 at 04:46)</a>:</h4>
<p>Fwiw I experimented with proof reduction a little back when it became known that it can loop in Lean's type theory. It's been a while so I'm very fuzzy on the details, but as far as I remember, there are checks to exit reduction early if the term is a proof since at least for typechecking, irrelevance applies. However life is not so simple, mainly due to unification. It turns out that things sometimes have to be reduced to infer some metas.</p>



<a name="212653400"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212653400" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212653400">(Oct 08 2020 at 07:05)</a>:</h4>
<p>I recall there being a recent crackdown on such unifications in 3.14 or so, it broke a bunch of proofs that were doing just that. Are you sure this is still the case?</p>



<a name="212656698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212656698" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212656698">(Oct 08 2020 at 07:51)</a>:</h4>
<p>We only removed support to unfold theorems (i.e. δ-reduction).  Nothing changed about the unification algorithm otherwise.  Though there is a big "if both sides are proofs and the types are defeq, exit" statement at the top.</p>



<a name="212696878"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/212696878" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#212696878">(Oct 08 2020 at 14:22)</a>:</h4>
<p>Indeed, there is a check, but it's more at the <em><a href="https://github.com/leanprover-community/lean/blob/4be962c167ca442a0ec5e84472d7ff9f5302788f/src/library/type_context.cpp#L3387">bottom</a></em>.</p>



<a name="213143116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213143116" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213143116">(Oct 13 2020 at 11:58)</a>:</h4>
<p>Do we think this can be fixed by just moving that check?</p>



<a name="213287749"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213287749" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Oliver Nash <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213287749">(Oct 14 2020 at 13:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup/near/213143116">said</a>:</p>
<blockquote>
<p>Do we think this can be fixed by just moving that check?</p>
</blockquote>
<p>I doubt it will be that easy (though I'd love to be corrected!). I think the way to make progress here is for us to produce a version of this apparent bug that is independent of Mathlib. I spent a little time on this yesterday evening but could not even eliminate <code>tensor_algebra</code>. I'll try again this evening.</p>



<a name="213788443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213788443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213788443">(Oct 19 2020 at 13:54)</a>:</h4>
<p>I assume you made no progress, <span class="user-mention" data-user-id="240862">@Oliver Nash</span>?</p>



<a name="213788574"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213788574" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Oliver Nash <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213788574">(Oct 19 2020 at 13:55)</a>:</h4>
<p>Correct. About another hour spent on it last week but didn't really get anywhere.</p>



<a name="213788593"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213788593" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Oliver Nash <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213788593">(Oct 19 2020 at 13:55)</a>:</h4>
<p>I think with a sufficiently-big block of time, I could do it.</p>



<a name="213788891"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213788891" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213788891">(Oct 19 2020 at 13:57)</a>:</h4>
<p>There was some related discussion at <a href="#narrow/stream/116395-maths/topic/Can't.20find.20algebra.20instance/near/213566642">https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/Can't.20find.20algebra.20instance/near/213566642</a>, just to keep things connected together.</p>



<a name="213804296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804296" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804296">(Oct 19 2020 at 15:36)</a>:</h4>
<p>I think I've made some progress here, we shouldn't be using <code>algebra.semiring_to_ring</code> for <code>tensor_algebra</code>, as that clashes with <code>ring_quot.ring</code></p>



<a name="213804547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804547">(Oct 19 2020 at 15:38)</a>:</h4>
<p>I think that will at least solve my issues from <a href="https://github.com/leanprover-community/mathlib/tree/tensor_algebra_adjunction">https://github.com/leanprover-community/mathlib/tree/tensor_algebra_adjunction</a></p>



<a name="213804619"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804619" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804619">(Oct 19 2020 at 15:39)</a>:</h4>
<p>I think adding</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">instance</span> <span class="o">{</span><span class="n">S</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">S</span><span class="o">]</span> <span class="o">[</span><span class="n">semimodule</span> <span class="n">S</span> <span class="n">M</span><span class="o">]</span> <span class="o">:</span> <span class="n">ring</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">S</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">ring_quot.ring</span> <span class="o">(</span><span class="n">tensor_algebra.rel</span> <span class="n">S</span> <span class="n">M</span><span class="o">)</span>
</code></pre></div>

<p>is a good start. I'm still struggling to make <code>clifford_algebra</code> happy with a similar definition though.</p>



<a name="213804686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804686" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804686">(Oct 19 2020 at 15:39)</a>:</h4>
<p>But ring_quot.ring is an instance, so why do we need to add it in the first place?</p>



<a name="213804712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804712" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804712">(Oct 19 2020 at 15:40)</a>:</h4>
<p>Because <code>tensor_algebra = ring_quot</code> only while the former is reducible</p>



<a name="213804761"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804761" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804761">(Oct 19 2020 at 15:40)</a>:</h4>
<p>So we need to explictly re-export it</p>



<a name="213804774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804774">(Oct 19 2020 at 15:40)</a>:</h4>
<p>Oh right.</p>



<a name="213804815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804815" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804815">(Oct 19 2020 at 15:40)</a>:</h4>
<p>This would be a lot easier if <code>@derive</code> could handle instances with dependencies</p>



<a name="213804876"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804876" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804876">(Oct 19 2020 at 15:41)</a>:</h4>
<p>But essentially I think we need to copy across all the <code>ring_quot</code> instances (that we care about) in <code>tensor_algebra</code></p>



<a name="213804895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804895" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804895">(Oct 19 2020 at 15:41)</a>:</h4>
<p>Is there a <code>ring</code> instance for <code>free_algebra</code>?</p>



<a name="213804908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804908">(Oct 19 2020 at 15:41)</a>:</h4>
<p>Yes</p>



<a name="213804920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804920" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804920">(Oct 19 2020 at 15:41)</a>:</h4>
<p>Oh, wait</p>



<a name="213804935"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804935" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804935">(Oct 19 2020 at 15:41)</a>:</h4>
<p>Yes, in the PR that this thread started with (<a href="https://github.com/leanprover-community/mathlib/issues/4289">#4289</a>)</p>



<a name="213804963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213804963" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213804963">(Oct 19 2020 at 15:41)</a>:</h4>
<p>Let's check: <a href="https://leanprover-community.github.io/mathlib_docs/find/free_algebra.ring">docs#free_algebra.ring</a></p>



<a name="213805022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213805022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213805022">(Oct 19 2020 at 15:42)</a>:</h4>
<p>Oh ok, so not in mathlib then. I've used <code>algebra.semiring_to_ring</code> for the free_algebra ajunction.</p>



<a name="213805302"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213805302" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213805302">(Oct 19 2020 at 15:44)</a>:</h4>
<p>I'll update the PR shortly if I get this working</p>



<a name="213814069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213814069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213814069">(Oct 19 2020 at 16:51)</a>:</h4>
<p>(I did not get this working)</p>



<a name="213814350"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213814350" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Oliver Nash <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213814350">(Oct 19 2020 at 16:53)</a>:</h4>
<p>I'm _delighted_ to see a possible resolution of this issue but are you sure this is the root cause? I was convinced that there was a serious bug in Lean based on <span class="user-mention" data-user-id="110032">@Reid Barton</span> 's example. Have you tried removing <code>ring_quot.ring</code> and seeing if the problems disappear?</p>



<a name="213815010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213815010" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213815010">(Oct 19 2020 at 16:58)</a>:</h4>
<p>I don't think there is a serious bug in lean (in the sense of anything compromising soundness), just one more elaborator edge case</p>



<a name="213815041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213815041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213815041">(Oct 19 2020 at 16:58)</a>:</h4>
<p>you can probably give that term straight to the kernel and it will work</p>



<a name="213815111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213815111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213815111">(Oct 19 2020 at 16:59)</a>:</h4>
<p>but it should really be minimized to make it appropriate for study</p>



<a name="213815615"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213815615" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Oliver Nash <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213815615">(Oct 19 2020 at 17:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup/near/213815010">said</a>:</p>
<blockquote>
<p>I don't think there is a serious bug in lean (in the sense of anything compromising soundness), just one more elaborator edge case</p>
</blockquote>
<p>Right! Thanks for clearing up my sloppy use of the phrase "serious bug"; indeed I had not intended to suggest there was anything approaching a soundness bug.</p>



<a name="213815690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213815690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Oliver Nash <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213815690">(Oct 19 2020 at 17:03)</a>:</h4>
<p>And minimizing that example is something I'd like to do. It's somewhat unglamorous work but I will try again.</p>



<a name="213819074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213819074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213819074">(Oct 19 2020 at 17:30)</a>:</h4>
<p>I've put up a PR that at least adds the ring instances for <code>free_algebra</code> and <code>tensor_algebra</code> in <a href="https://github.com/leanprover-community/mathlib/issues/4692">#4692</a>. I run into problems trying to extend to <code>clifford_algebra</code> or <code>exterior_algebra</code>, so I've left those until we get a better understanding of what's going on. <span class="user-mention" data-user-id="240862">@Oliver Nash</span>'s <code>universal_enveloping_algebra</code> manages to survive because it isn't marked irreducible!</p>



<a name="213921158"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213921158" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213921158">(Oct 20 2020 at 13:49)</a>:</h4>
<p><code>exterior_algebra</code> I could get with some rewrites in an instance definition: <a href="https://github.com/leanprover-community/mathlib/issues/4714">#4714</a></p>



<a name="213922971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213922971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213922971">(Oct 20 2020 at 14:01)</a>:</h4>
<p>... which upon rebasing, leaves me with a <code>0 = 0</code> goal that <code>refl</code> can't close</p>



<a name="213924895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/213924895" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#213924895">(Oct 20 2020 at 14:13)</a>:</h4>
<p>I get the feeling that most of the difficulty here comes from the fact that <code>ring</code> does not extend <code>semiring</code></p>



<a name="214112417"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214112417" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214112417">(Oct 21 2020 at 20:45)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.tensor_product</span>
<span class="kn">import</span> <span class="n">deprecated.subring</span>

<span class="c1">-- swap these ↑ two imports, and then `foo` will be happy</span>
<span class="c1">-- otherwise, get a timeout</span>

<span class="kn">import</span> <span class="n">algebra.module.submodule</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">M</span> <span class="n">N</span> <span class="n">P</span> <span class="n">Q</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span>
<span class="kd">variables</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span>
<span class="kd">variables</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">N</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="n">R</span> <span class="n">N</span><span class="o">]</span>

<span class="kn">open</span> <span class="n">function</span>

<span class="kd">lemma</span> <span class="n">injective_iff</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">M</span> <span class="bp">→ₗ</span><span class="o">[</span><span class="n">R</span><span class="o">]</span> <span class="n">N</span><span class="o">)</span> <span class="o">:</span> <span class="n">function.injective</span> <span class="n">f</span> <span class="bp">↔</span> <span class="bp">∀</span> <span class="n">m</span><span class="o">,</span> <span class="n">f</span> <span class="n">m</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">→</span> <span class="n">m</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="n">add_monoid_hom.injective_iff</span> <span class="n">f.to_add_monoid_hom</span>

<span class="kd">lemma</span> <span class="n">foo</span> <span class="o">(</span><span class="n">L</span> <span class="o">:</span> <span class="n">submodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">unit</span> <span class="bp">→</span> <span class="n">R</span><span class="o">))</span> <span class="o">:</span>
  <span class="n">injective</span> <span class="o">(</span><span class="n">tensor_product.map</span> <span class="n">L.subtype</span> <span class="n">L.subtype</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">injective_iff</span> <span class="n">_</span><span class="o">)</span><span class="bp">.</span><span class="n">mpr</span> <span class="o">(</span><span class="n">sorry</span><span class="o">)</span>
</code></pre></div>



<a name="214112508"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214112508" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214112508">(Oct 21 2020 at 20:46)</a>:</h4>
<p>(Thanks to Reid for helping me figure this out.)</p>



<a name="214112790"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214112790" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214112790">(Oct 21 2020 at 20:48)</a>:</h4>
<p>which mathlib commit are you on, in case it matters?</p>



<a name="214113160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214113160" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214113160">(Oct 21 2020 at 20:52)</a>:</h4>
<p><code>src/foo.lean</code> on branch <code>crazy</code></p>



<a name="214113198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214113198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214113198">(Oct 21 2020 at 20:53)</a>:</h4>
<p>Which has 1 commit on top of <code>commit df4500242eb6aa6ee20b315b185b0f97a9b359c</code></p>



<a name="214113287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214113287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214113287">(Oct 21 2020 at 20:53)</a>:</h4>
<p>Is this related to the earlier <code>rfl</code> weirdness or is this some all-new weirdness?</p>



<a name="214115481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214115481" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214115481">(Oct 21 2020 at 21:11)</a>:</h4>
<p>Good question!</p>



<a name="214115608"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214115608" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214115608">(Oct 21 2020 at 21:12)</a>:</h4>
<p>I tried to unmathlibify the bad rfl but there was so much stuff which needed to be copy-pasted in :-/</p>



<a name="214129540"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214129540" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214129540">(Oct 21 2020 at 23:59)</a>:</h4>
<p>I don't immediately see the connection to the rest of this thread</p>



<a name="214140226"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214140226" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214140226">(Oct 22 2020 at 03:28)</a>:</h4>
<p>Neither do I, but note that the problem goes away if you remove any of the following three ingredients:</p>
<ul>
<li>change <code>unit -&gt; R</code> to a module like <code>M</code></li>
<li>change <code>L.subtype</code> to some hom <code>f</code></li>
<li>remove the <code>tensor_product.map L.subtype</code>, and just ask for injectivity of <code>L.subtype</code>.</li>
</ul>



<a name="214162025"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214162025" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214162025">(Oct 22 2020 at 09:22)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/4735">#4735</a> fixes this particular problem. Once the oleans are there, I will test if it also solves it in the bigger context that I was working in.</p>



<a name="214162058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214162058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214162058">(Oct 22 2020 at 09:23)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> It would be interesting to test if it also helps in your setting. (I don't expect so, but you never know.)</p>



<a name="214163914"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214163914" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214163914">(Oct 22 2020 at 09:42)</a>:</h4>
<p>I can confirm that on the <code>flat-module</code> branch, the following snippet no longer times out:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">injective_rtensor_aux₁</span> <span class="o">[</span><span class="n">hM</span> <span class="o">:</span> <span class="n">flat</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">(</span><span class="n">L</span> <span class="o">:</span> <span class="n">submodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">fin</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">R</span><span class="o">))</span> <span class="o">:</span>
  <span class="n">injective</span> <span class="o">(</span><span class="n">L.subtype.rtensor</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="c1">-- refine (injective_iff _).mpr _,</span>
  <span class="c1">-- rw [show M = M, from rfl],</span>
  <span class="n">rw</span> <span class="n">injective_iff</span><span class="o">,</span>
  <span class="c1">-- induction n with n IH,</span>
  <span class="o">{</span> <span class="n">sorry</span> <span class="o">},</span>
<span class="kd">end</span>
</code></pre></div>



<a name="214163957"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214163957" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214163957">(Oct 22 2020 at 09:42)</a>:</h4>
<p>However, if I change the <code>(fin n → R)</code> into <code>finsupp</code>s, then it still times out <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span> <span aria-label="cry" class="emoji emoji-1f622" role="img" title="cry">:cry:</span> <span aria-label="angry cat" class="emoji emoji-1f63e" role="img" title="angry cat">:angry_cat:</span></p>



<a name="214165049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214165049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214165049">(Oct 22 2020 at 09:54)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> FYI, the PR <a href="https://github.com/leanprover-community/mathlib/issues/4735">#4735</a> is quasi-related to this thread.</p>



<a name="214166509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214166509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214166509">(Oct 22 2020 at 10:11)</a>:</h4>
<p>Ok, then my preferred solution is just to remove the suspicious group/monoid/etc. instances.  May I push to your branch?</p>



<a name="214166630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214166630" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214166630">(Oct 22 2020 at 10:12)</a>:</h4>
<p>Yes, certainly</p>



<a name="214166655"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214166655" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214166655">(Oct 22 2020 at 10:12)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> Feel free to play around with <code>flat-module</code> as well</p>



<a name="214166667"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214166667" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214166667">(Oct 22 2020 at 10:12)</a>:</h4>
<p>Although there is quite a lot going on there</p>



<a name="214175735"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214175735" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214175735">(Oct 22 2020 at 11:54)</a>:</h4>
<p>Do we have an explanation for why <a href="https://github.com/leanprover-community/mathlib/issues/4735">#4735</a> affects the behavior here at all?</p>



<a name="214176723"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214176723" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214176723">(Oct 22 2020 at 12:05)</a>:</h4>
<p><a href="https://leanprover-community.github.io/mathlib_docs/find/tensor_product.add_comm_group">docs#tensor_product.add_comm_group</a> makes Lean construct a <code>add_comm_group ↥L</code> via <code>is_add_subgroup</code>, while we want <code>submodule.semimodule</code> instead.</p>



<a name="214177220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214177220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214177220">(Oct 22 2020 at 12:10)</a>:</h4>
<p>Oh right. I thought that when Johan and I were minimizing the example it didn't fail with <code>deprecated.subring</code> replaced by <code>deprecated.subgroup</code> though.</p>



<a name="214177534"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214177534" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214177534">(Oct 22 2020 at 12:13)</a>:</h4>
<p>Does this example involve actually non-defeq instances then? The only place I could see there being a problem is with <code>neg</code></p>



<a name="214189753"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214189753" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214189753">(Oct 22 2020 at 13:52)</a>:</h4>
<p>It definitely is about <code>subtype.add_comm_group</code> (you can check with <code>local attribute [-instance]</code>).  I'm also not sure what is going on exactly (the type of <code>linear_map</code> is several lines long....).<br>
My rationale for removing these instances is that we already want to get away from unbundled substructures, so when in doubt remove the already deprecated instances.</p>



<a name="214283069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/214283069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#214283069">(Oct 23 2020 at 07:54)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="2494">@maintainers</span> anyone wants to look at <a href="https://github.com/leanprover-community/mathlib/issues/4735">#4735</a>? Gabriel kindly fix some bad instances, but this is now touching 14 files, so it would be sad to let this bitrot.</p>



<a name="215739271"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/215739271" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#215739271">(Nov 05 2020 at 16:42)</a>:</h4>
<p>I think my plan here is just to remove the <code>irreducible</code> attribute, unless something has changed in master to make this go away - having a nicely isolated "black box" definition seems less important than having a ring instance</p>



<a name="215752770"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/215752770" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#215752770">(Nov 05 2020 at 18:15)</a>:</h4>
<p>Done in <a href="https://github.com/leanprover-community/mathlib/issues/4916">#4916</a> - I've err'd on the side of making all the involved types semireducible, to avoid running into any similar headaches later. I think it's fine to just make "don't directly use the inductive construction of the algebra" something that we check by eye in review, rather than trying to enforce it with <code>attribute</code> and creating unification problems.</p>



<a name="218131618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218131618" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218131618">(Nov 27 2020 at 21:51)</a>:</h4>
<p>Did anyone ever figure out what was going on with this weird elaborator issue (<a href="#narrow/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup/near/212593885">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup/near/212593885</a>)?</p>



<a name="218132988"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218132988" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218132988">(Nov 27 2020 at 22:16)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.tensor_algebra</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">semimodule</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span>

<span class="kd">instance</span> <span class="n">working_instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">infer_instance</span>

<span class="c1">-- this poisons the instance cache somehow and makes the next line fail</span>
<span class="kd">instance</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">ring</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">algebra.semiring_to_ring</span> <span class="n">R</span>

<span class="c1">-- ...except that the issue is that `tensor_algebra` is irreducible</span>
<span class="kn">local</span> <span class="kn">attribute</span> <span class="o">[</span><span class="n">semireducible</span><span class="o">]</span> <span class="n">tensor_algebra</span>

<span class="c1">-- now works</span>
<span class="kd">instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">working_instance</span> <span class="n">R</span> <span class="n">M</span>
</code></pre></div>



<a name="218133116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218133116" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218133116">(Nov 27 2020 at 22:18)</a>:</h4>
<p>Amelia and I were talking about <code>tensor_algebra</code> on Thursday and she was having some crazy problems with things not unifying, and then we discovered that <code>tensor_algebra</code> was marked <code>irreducible</code> (or at least it was in the branch we were working on). Does this explain some stuff?</p>



<a name="218133462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218133462" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218133462">(Nov 27 2020 at 22:25)</a>:</h4>
<p>Oh no... more of this irreducible stuff <span class="user-mention" data-user-id="310045">@Eric Wieser</span></p>



<a name="218133740"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218133740" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218133740">(Nov 27 2020 at 22:30)</a>:</h4>
<p>Now Yury is back with us I must get back to making <code>with_top</code> and <code>with_bot</code> irreducible...</p>



<a name="218133786"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218133786" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218133786">(Nov 27 2020 at 22:31)</a>:</h4>
<p>I think we knew about it being <code>irreducible</code> but the behavior is still really weird</p>



<a name="218133949"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218133949" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218133949">(Nov 27 2020 at 22:34)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.tensor_algebra</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">_inst_1</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">_inst_2</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">_inst_3</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span>

<span class="kd">instance</span> <span class="n">working_instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">infer_instance</span>

<span class="kd">instance</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">ring</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">algebra.semiring_to_ring</span> <span class="n">R</span>

<span class="c1">-- this makes it work</span>
<span class="kn">local</span> <span class="kn">attribute</span> <span class="o">[</span><span class="n">semireducible</span><span class="o">]</span> <span class="n">tensor_algebra</span>


<span class="kd">def</span> <span class="n">x</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">add_comm_monoid.add_assoc</span> <span class="n">_</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">))</span>
  <span class="bp">=</span>
  <span class="bp">@</span><span class="n">add_comm_monoid.add_assoc</span> <span class="n">_</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="n">_inst_3</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">foo</span> <span class="n">R</span> <span class="n">M</span> <span class="n">_inst_1</span> <span class="n">_inst_2</span> <span class="n">_inst_3</span><span class="o">)))</span> <span class="o">:=</span>
          <span class="n">rfl</span> <span class="c1">-- now works</span>
</code></pre></div>



<a name="218133971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218133971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218133971">(Nov 27 2020 at 22:35)</a>:</h4>
<p>(I had to change an instance name presumably because of some recent Lean changes).</p>



<a name="218134019"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218134019" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218134019">(Nov 27 2020 at 22:36)</a>:</h4>
<p>Oh I see, Eric already spotted this. And this doesn't explain everything?</p>



<a name="218134621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218134621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218134621">(Nov 27 2020 at 22:49)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.tensor_algebra</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">_inst_1</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">_inst_2</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">_inst_3</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span>

<span class="kd">instance</span> <span class="n">working_instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">infer_instance</span>

<span class="kd">instance</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">ring</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">algebra.semiring_to_ring</span> <span class="n">R</span>

<span class="c1">--local attribute [semireducible] tensor_algebra</span>

<span class="kd">lemma</span> <span class="n">add_comm_monoid.ext</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">add_comm_monoid</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">@</span><span class="n">add_comm_monoid.add</span> <span class="n">_</span> <span class="n">a</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">add_comm_monoid.add</span> <span class="n">_</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">b</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">tactic.unfreeze_local_instances</span><span class="o">,</span>
  <span class="n">cases</span> <span class="n">a</span><span class="o">,</span>
  <span class="n">cases</span> <span class="n">b</span><span class="o">,</span>
  <span class="n">change</span> <span class="n">a_add</span> <span class="bp">=</span> <span class="n">b_add</span> <span class="n">at</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">congr'</span><span class="o">,</span>
  <span class="c1">-- too lazy to prove zeros coincide</span>
  <span class="n">sorry</span>
<span class="kd">end</span>


<span class="kd">def</span> <span class="n">x</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">add_comm_monoid.add_assoc</span> <span class="n">_</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">))</span>
  <span class="bp">=</span>
  <span class="bp">@</span><span class="n">add_comm_monoid.add_assoc</span> <span class="n">_</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="n">_inst_3</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">foo</span> <span class="n">R</span> <span class="n">M</span> <span class="n">_inst_1</span> <span class="n">_inst_2</span> <span class="n">_inst_3</span><span class="o">)))</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">congr'</span><span class="o">,</span>
  <span class="c">/-</span><span class="cm"></span>
<span class="cm">  ⊢ semiring.to_add_comm_monoid (tensor_algebra R M) =</span>
<span class="cm">    add_comm_group.to_add_comm_monoid (tensor_algebra R M)</span>
<span class="cm">  -/</span>
  <span class="n">apply</span> <span class="n">add_comm_monoid.ext</span><span class="o">,</span>
  <span class="n">refl</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>There's a proof which keeps everything irreducible. Is the answer not just something like "these things are not unfolding because tensor_algebra is irreducible" or something? I don't really understand the problem properly.</p>



<a name="218134696"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218134696" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218134696">(Nov 27 2020 at 22:51)</a>:</h4>
<p>Sorry-free:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.tensor_algebra</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">_inst_1</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">_inst_2</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">_inst_3</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span>

<span class="kd">instance</span> <span class="n">working_instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">R</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">infer_instance</span>

<span class="kd">instance</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">ring</span> <span class="o">(</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span> <span class="n">algebra.semiring_to_ring</span> <span class="n">R</span>

<span class="c1">--local attribute [semireducible] tensor_algebra</span>

<span class="kd">lemma</span> <span class="n">add_comm_monoid.ext</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">add_comm_monoid</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h_add</span> <span class="o">:</span> <span class="bp">@</span><span class="n">add_comm_monoid.add</span> <span class="n">_</span> <span class="n">a</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">add_comm_monoid.add</span> <span class="n">_</span> <span class="n">b</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h_zero</span> <span class="o">:</span> <span class="bp">@</span><span class="n">add_comm_monoid.zero</span> <span class="n">_</span> <span class="n">a</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">add_comm_monoid.zero</span> <span class="n">_</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">b</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">tactic.unfreeze_local_instances</span><span class="o">,</span>
  <span class="n">cases</span> <span class="n">a</span><span class="o">,</span>
  <span class="n">cases</span> <span class="n">b</span><span class="o">,</span>
  <span class="n">congr'</span><span class="o">,</span>
<span class="kd">end</span>


<span class="kd">def</span> <span class="n">x</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">add_comm_monoid.add_assoc</span> <span class="n">_</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra.semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">))</span>
  <span class="bp">=</span>
  <span class="bp">@</span><span class="n">add_comm_monoid.add_assoc</span> <span class="n">_</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="n">_inst_3</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">tensor_algebra</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)</span> <span class="n">M</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">M</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="n">_inst_3</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">foo</span> <span class="n">R</span> <span class="n">M</span> <span class="n">_inst_1</span> <span class="n">_inst_2</span> <span class="n">_inst_3</span><span class="o">)))</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">congr'</span><span class="o">,</span>
  <span class="c">/-</span><span class="cm"></span>
<span class="cm">  ⊢ semiring.to_add_comm_monoid (tensor_algebra R M) =</span>
<span class="cm">    add_comm_group.to_add_comm_monoid (tensor_algebra R M)</span>
<span class="cm">  -/</span>
  <span class="n">apply</span> <span class="n">add_comm_monoid.ext</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">refl</span> <span class="o">}</span>
<span class="kd">end</span>
</code></pre></div>



<a name="218134701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218134701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218134701">(Nov 27 2020 at 22:51)</a>:</h4>
<p>This was exactly the sort of problem Amelia was having.</p>



<a name="218134827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218134827" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218134827">(Nov 27 2020 at 22:54)</a>:</h4>
<p>I see -- the point is that <code>rfl</code> is failing because some part of the system has convinced itself that the types of the proofs are equal, but some other part of the system cannot convince itself of this, because of irreducibility. Is that the issue?</p>



<a name="218135674"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218135674" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218135674">(Nov 27 2020 at 23:13)</a>:</h4>
<p>I thought I removed all the offending <code>irreducibles</code> from mathlib</p>



<a name="218135731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218135731" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218135731">(Nov 27 2020 at 23:14)</a>:</h4>
<p>At least, the ones relating to free algebra</p>



<a name="218135750"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218135750" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218135750">(Nov 27 2020 at 23:15)</a>:</h4>
<p>oh you're right, my mathlib was on some other branch which hadn't been merged with master for a while.</p>



<a name="218135818"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218135818" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218135818">(Nov 27 2020 at 23:16)</a>:</h4>
<p>I made sure to add a test to prevent someone undoing this by accident</p>



<a name="218135819"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218135819" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218135819">(Nov 27 2020 at 23:16)</a>:</h4>
<p>meh. You have to add <code>local attribute [irreducible] tensor_algebra</code> to get my code running.</p>



<a name="218136067"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218136067" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218136067">(Nov 27 2020 at 23:23)</a>:</h4>
<p>Wait, for your code you have to make it _not_ reducible?</p>



<a name="218153236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218153236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218153236">(Nov 28 2020 at 07:47)</a>:</h4>
<p>Otherwise the proof finishes sooner</p>



<a name="218186572"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218186572" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218186572">(Nov 28 2020 at 23:42)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">old_structure_cmd</span> <span class="n">true</span>

<span class="kd">class</span> <span class="n">foo</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">bar</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span>
<span class="o">(</span><span class="n">prop</span> <span class="o">:</span> <span class="n">bar</span> <span class="bp">=</span> <span class="n">bar</span><span class="o">)</span>

<span class="kd">class</span> <span class="n">foo'</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">foo</span> <span class="n">α</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">prop'</span> <span class="o">:</span> <span class="n">bar</span> <span class="bp">=</span> <span class="n">bar</span><span class="o">)</span>

<span class="kd">instance</span> <span class="n">nat.foo</span> <span class="o">:</span> <span class="n">foo</span> <span class="n">ℕ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">bar</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="n">prop</span> <span class="o">:=</span> <span class="n">rfl</span> <span class="o">}</span>

<span class="kd">instance</span> <span class="n">nat.foo'</span> <span class="o">:</span> <span class="n">foo'</span> <span class="n">ℕ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">prop'</span> <span class="o">:=</span> <span class="n">rfl</span><span class="o">,</span>
  <span class="bp">..</span> <span class="n">nat.foo</span> <span class="o">}</span>

<span class="kd">class</span> <span class="n">foo''</span> <span class="o">(</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">foo</span> <span class="n">β</span><span class="o">]</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">bar''</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span>

<span class="kd">instance</span> <span class="n">nat.foo''</span> <span class="o">:</span> <span class="n">foo''</span> <span class="n">ℕ</span> <span class="n">ℕ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">bar''</span> <span class="o">:=</span> <span class="mi">1</span> <span class="o">}</span>

<span class="kd">def</span> <span class="n">foo''.foo_to_foo'</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">foo</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">foo''</span> <span class="n">α</span> <span class="n">β</span><span class="o">]</span> <span class="o">:</span> <span class="n">foo'</span> <span class="n">β</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">prop'</span> <span class="o">:=</span> <span class="n">rfl</span><span class="o">,</span>
  <span class="bp">..</span> <span class="o">(</span><span class="n">infer_instance</span> <span class="o">:</span> <span class="n">foo</span> <span class="n">β</span><span class="o">)</span> <span class="o">}</span>

<span class="kd">def</span> <span class="n">typealias</span> <span class="o">:=</span> <span class="n">ℕ</span>

<span class="kd">instance</span> <span class="n">baz</span> <span class="o">:</span> <span class="n">foo'</span> <span class="n">typealias</span> <span class="o">:=</span> <span class="n">nat.foo'</span>
<span class="kd">instance</span> <span class="n">typealias.foo''</span> <span class="o">:</span> <span class="n">foo''</span> <span class="n">ℕ</span> <span class="n">typealias</span> <span class="o">:=</span> <span class="n">nat.foo''</span>

<span class="kd">def</span> <span class="n">baz'</span> <span class="o">:</span> <span class="n">foo'</span> <span class="n">typealias</span> <span class="o">:=</span> <span class="n">foo''.foo_to_foo'</span> <span class="n">ℕ</span>

<span class="kn">local</span> <span class="kn">attribute</span> <span class="o">[</span><span class="n">irreducible</span><span class="o">]</span> <span class="n">typealias</span>

<span class="kd">example</span> <span class="o">:</span> <span class="bp">@</span><span class="n">foo'.bar</span> <span class="n">_</span> <span class="n">baz</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">foo'.bar</span> <span class="n">_</span> <span class="n">baz'</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="c">/-</span><span class="cm"></span>
<span class="cm">run_cmd tactic.add_decl</span>
<span class="cm">  (declaration.thm `X []  `(@foo'.prop _ baz = @foo'.prop _ baz')</span>
<span class="cm">  (pure `(eq.refl (@foo'.prop _ baz))))</span>

<span class="cm">#print X</span>
<span class="cm">-/</span>

<span class="c1">-- works if `typealias` is not made irreducible</span>
<span class="kd">example</span> <span class="o">:</span> <span class="bp">@</span><span class="n">foo'.prop</span> <span class="n">_</span> <span class="n">baz</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">foo'.prop</span> <span class="n">_</span> <span class="n">baz'</span> <span class="o">:=</span> <span class="n">rfl</span> <span class="c1">-- fails</span>
</code></pre></div>
<p><span class="user-mention" data-user-id="110032">@Reid Barton</span> <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span></p>



<a name="218186579"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218186579" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bhavik Mehta <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218186579">(Nov 28 2020 at 23:42)</a>:</h4>
<p>I feel like it's important to note that <code>proof_irrel _ _</code> works in place of <code>rfl</code></p>



<a name="218186587"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218186587" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218186587">(Nov 28 2020 at 23:43)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">they_are_equal</span> <span class="o">{</span><span class="n">P</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">h1</span> <span class="n">h2</span> <span class="o">:</span> <span class="n">P</span><span class="o">}</span> <span class="o">:</span> <span class="n">h1</span> <span class="bp">=</span> <span class="n">h2</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">example</span> <span class="o">:</span> <span class="bp">@</span><span class="n">foo'.prop</span> <span class="n">_</span> <span class="n">baz</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">foo'.prop</span> <span class="n">_</span> <span class="n">baz'</span> <span class="o">:=</span> <span class="n">they_are_equal</span> <span class="c1">-- works</span>
</code></pre></div>



<a name="218186593"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218186593" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218186593">(Nov 28 2020 at 23:43)</a>:</h4>
<p>The <code>run_cmd</code> (which Chris wrote) also works</p>



<a name="218186657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218186657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218186657">(Nov 28 2020 at 23:45)</a>:</h4>
<p>(ps thanks to Shing, Chris, Kenny and Bhavik for being foolhardy enough to watch the discord livestream and between them helping a lot)</p>



<a name="218186842"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218186842" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218186842">(Nov 28 2020 at 23:50)</a>:</h4>
<p>Title needs to be changed to <code>foo''.foo_to_foo' breaks foo' typeclass lookup</code></p>



<a name="218215493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218215493" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218215493">(Nov 29 2020 at 14:41)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">old_structure_cmd</span> <span class="n">true</span>

<span class="kd">class</span> <span class="n">foo</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">bar</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span>
<span class="o">(</span><span class="n">prop</span> <span class="o">:</span> <span class="n">bar</span> <span class="bp">=</span> <span class="n">bar</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">foo_to_foo</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">foo</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">foo</span> <span class="n">α</span> <span class="o">:=</span>
<span class="o">{</span> <span class="bp">..</span> <span class="o">(</span><span class="n">infer_instance</span> <span class="o">:</span> <span class="n">foo</span> <span class="n">α</span><span class="o">)</span> <span class="o">}</span>

<span class="kd">instance</span> <span class="n">nat.foo</span> <span class="o">:</span> <span class="n">foo</span> <span class="n">ℕ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">bar</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="n">prop</span> <span class="o">:=</span> <span class="n">rfl</span> <span class="o">}</span>

<span class="kd">def</span> <span class="n">typealias</span> <span class="o">:=</span> <span class="n">ℕ</span>

<span class="kd">instance</span> <span class="n">baz</span> <span class="o">:</span> <span class="n">foo</span> <span class="n">typealias</span> <span class="o">:=</span> <span class="n">nat.foo</span>
<span class="kd">instance</span> <span class="n">baz'</span> <span class="o">:</span> <span class="n">foo</span> <span class="n">typealias</span> <span class="o">:=</span> <span class="n">foo_to_foo</span> <span class="n">typealias</span>

<span class="kn">local</span> <span class="kn">attribute</span> <span class="o">[</span><span class="n">irreducible</span><span class="o">]</span> <span class="n">typealias</span>

<span class="kd">example</span> <span class="o">:</span> <span class="bp">@</span><span class="n">foo.bar</span> <span class="n">_</span> <span class="n">baz</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">foo.bar</span> <span class="n">_</span> <span class="n">baz'</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="kd">example</span> <span class="o">:</span> <span class="bp">@</span><span class="n">foo.prop</span> <span class="n">_</span> <span class="n">baz</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">foo.prop</span> <span class="n">_</span> <span class="n">baz'</span> <span class="o">:=</span> <span class="n">rfl</span>
</code></pre></div>



<a name="218215494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218215494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218215494">(Nov 29 2020 at 14:41)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span></p>



<a name="218215620"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218215620" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218215620">(Nov 29 2020 at 14:44)</a>:</h4>
<p>Nice!</p>



<a name="218227960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218227960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218227960">(Nov 29 2020 at 20:04)</a>:</h4>
<p>who do we ping for this? <span class="user-mention" data-user-id="110038">@Kevin Buzzard</span></p>



<a name="218232490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218232490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218232490">(Nov 29 2020 at 21:51)</a>:</h4>
<p>Maybe it's just worth restating what's going on: over the weekend we minimised (in the sense of removing mathlib imports) the issue discovered at the top of this thread. The last line of the code above is a proof that two proofs of a proposition are equal, but <code>rfl</code> fails. If Lean didn't think that it was two proofs of the same proposition, then the term <code>@foo.prop _ baz = @foo.prop _ baz'</code> itself wouldn't typecheck. The term does typecheck, but the proof fails anyway. The example can be proved with <code>they_are_equal</code>, or with the <code>tactic.add_decl</code> trick above.</p>



<a name="218235279"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218235279" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218235279">(Nov 29 2020 at 23:08)</a>:</h4>
<p><code>they_are_equal</code> is in the library under the name <a href="https://leanprover-community.github.io/mathlib_docs/find/proof_irrel">docs#proof_irrel</a>.</p>



<a name="218235329"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218235329" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218235329">(Nov 29 2020 at 23:08)</a>:</h4>
<p>Oh, Bhavik already mentioned that.</p>



<a name="218236443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218236443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218236443">(Nov 29 2020 at 23:39)</a>:</h4>
<p>Oh! I hadn't appreciated that this was what he was saying!</p>



<a name="218236698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.semiring_to_ring%20breaks%20semimodule%20typeclass%20lookup/near/218236698" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup.html#218236698">(Nov 29 2020 at 23:44)</a>:</h4>
<p>Now that we have the reproducer, presumably we can attempt to change the line of C++ code linked up-thread and see if it fixes it</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>