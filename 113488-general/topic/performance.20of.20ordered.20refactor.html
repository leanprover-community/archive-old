---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/performance.20of.20ordered.20refactor.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html">performance of ordered refactor</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="238369011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238369011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238369011">(May 11 2021 at 19:31)</a>:</h4>
<p>There has been a discussion about performance issues with the refactor <a href="https://github.com/leanprover-community/mathlib/issues/7574">#7574</a> .</p>
<p>I'm all in favour for checking this, but I have no idea where to start.  Also, given the option, I would like to test out the alternative approach that I had in mind, which would only introduce 2 typeclasses instead of 16, but each one taking two functions as inputs.</p>
<p>Where can I start to learn about checking these things?  Would simply pushing to the github and monitoring the time CI takes to build the PRs be a good measure?  Would comparing the local build times on my machine be better?  I am really completely a novice in this, so any commentary, however silly it might appear, could be an eye-opener for me!</p>
<p>Thanks!</p>



<a name="238369538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238369538" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238369538">(May 11 2021 at 19:35)</a>:</h4>
<p><code>set_option profiler true</code> can help you time specific proofs</p>



<a name="238369716"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238369716" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238369716">(May 11 2021 at 19:36)</a>:</h4>
<p>Ok, but I get somewhat inconsistent timings when I use it: recompiling the same lemma does not always give the same time.  I have an impression that we are talking about a small discrepancy on average, which might be difficult to spot on a single lemma.  Maybe I am wrong though...</p>



<a name="238370904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238370904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238370904">(May 11 2021 at 19:44)</a>:</h4>
<p>I think compiling the whole library is the only relevant measure here, since it is the addition of a lot of small stuffs. How to get reliable timings when compiling the whole library is outside of my competence domain, though (one-threaded? No heavy task running at the same time?)</p>



<a name="238371005"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238371005" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238371005">(May 11 2021 at 19:45)</a>:</h4>
<p>it may be worth at some point branching the library 5 times or something, and running a full CI suite on it to see what the variance on times are<br>
(obviously at a quiet CI time)</p>



<a name="238371569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238371569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238371569">(May 11 2021 at 19:49)</a>:</h4>
<p>Ok, thanks for the suggestions!  Right now, I am waiting for the first successful build of the first branch.  On my machine it built with no errors, so I am hopeful!</p>



<a name="238371712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238371712" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238371712">(May 11 2021 at 19:50)</a>:</h4>
<p>Later this week, I hope to prepare the "competitor" PR and see how they compare, so there is plenty of time for further suggestions and how to implement them! <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="238386321"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238386321" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238386321">(May 11 2021 at 21:41)</a>:</h4>
<p><span class="user-mention" data-user-id="256311">@Jannis Limperg</span> has (used to have?) a build server that can do these kinds of timings.</p>



<a name="238399231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238399231" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238399231">(May 11 2021 at 23:49)</a>:</h4>
<p>I can make a timing of this branch on the hardware (or rather VM) used for the benchmark bot. It's not amazingly precise, but it'll spot bigger performance regressions. Just give me the relevant commit.</p>



<a name="238419439"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238419439" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238419439">(May 12 2021 at 04:24)</a>:</h4>
<p>Jannis, that would be great!  If you could time commit</p>
<p>df080022c2ba78f1969f15da0975295fd5e384f7</p>
<p>I would be very grateful!  I will be preparing a second PR to compare it with this one, but for the moment, simply seeing how this one compares with the current master would be awesome!</p>
<p>Thanks a lot!  And let me know if you need anything else!</p>



<a name="238425871"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238425871" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238425871">(May 12 2021 at 06:09)</a>:</h4>
<p>For definiteness, I would like to compare these two commits:</p>
<ul>
<li>
<p>current-ish <code>master</code><br>
a7e1696f5b1bd29f1575d99162e9f80141b28e4c</p>
</li>
<li>
<p>first working refactor in <code>adomani_new_order_typeclasses_2</code><br>
df080022c2ba78f1969f15da0975295fd5e384f7</p>
</li>
</ul>



<a name="238426118"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238426118" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238426118">(May 12 2021 at 06:12)</a>:</h4>
<p>Once I have a working alternative refactor, I will post the commit hash as well, so that the three can be compared for relative performance.</p>
<p><span class="user-mention" data-user-id="256311">@Jannis Limperg</span> , let me know if this is asking too much, of course!  I realize that it is not fun to have a computer building stuff just to see what is faster/slower!</p>



<a name="238429493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238429493" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238429493">(May 12 2021 at 06:54)</a>:</h4>
<p>Actually, <span class="user-mention" data-user-id="256311">@Jannis Limperg</span> , if you have not started the timings, it might be better to hold off a little bit.  I just realized that the version of master that I proposed was one where Mario made a change to avoid some timeouts, whereas the version of the commit that I wanted to compare does not have those changes!</p>
<p>So, I am now building two branches with the two proposed refactors, but with the current master.  Once I am sure that they pass all the tests, I will give the commit hashes for these branches so that the three versions can be timed!</p>
<p>Again, thanks a lot for your help!</p>



<a name="238462485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238462485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238462485">(May 12 2021 at 12:07)</a>:</h4>
<p>No worries! All I need to do is log on to the server and type one command, so it's no big deal. Please ping again when you have the relevant commits.</p>



<a name="238470125"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238470125" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238470125">(May 12 2021 at 13:09)</a>:</h4>
<p>Ok, thanks <span class="user-mention" data-user-id="256311">@Jannis Limperg</span> !</p>
<p>Here are the three commits that I would like to test for relative speed (they just finished building):</p>
<ul>
<li>
<p>the version of <code>master</code> out of which the two commits below branched<br>
a7e1696f5b1bd29f1575d99162e9f80141b28e4c</p>
</li>
<li>
<p>the refactor in <code>adomani_new_order_typeclasses_2</code>, with 16 new typeclasses<br>
88d6a72d98b13d5bcae1a4560260cae17f60d309</p>
</li>
<li>
<p>the refactor in <code>adomani_ordered_stuff</code>, with 2 new typeclasses<br>
03b502c386905abef9892d59d09c36220c04a0da</p>
</li>
</ul>
<p>Unless I messed up, I merged the commit of <code>master</code> above into the two branches below, fixed what needed fixing and then I would like to time the three commits.  This should hopefully minimize time unrelated to the specific changes that I am interested in, since they all contain the "same" copy of <code>master</code>.</p>



<a name="238481089"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238481089" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238481089">(May 12 2021 at 14:18)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> The builds are running now. They'll probably take until tomorrow since I'm doing single-threaded builds on weak hardware.</p>



<a name="238481712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238481712" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238481712">(May 12 2021 at 14:22)</a>:</h4>
<p>That's great, thank you very much!</p>
<p>I do not mind if they take long, I am in no rush and I prefer to get more reliable relative timing than "smartest and quickest possible build time"!</p>



<a name="238484912"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238484912" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238484912">(May 12 2021 at 14:40)</a>:</h4>
<p>If it takes longer, then the precision might actually be increased!</p>



<a name="238607594"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238607594" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238607594">(May 13 2021 at 11:06)</a>:</h4>
<p><span class="user-mention" data-user-id="256311">@Jannis Limperg</span> , while I am not in a rush, I am curious to know the outcome of the timing: any results yet? <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="238609226"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238609226" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238609226">(May 13 2021 at 11:29)</a>:</h4>
<ul>
<li><code>a7e1696f5b1bd29f1575d99162e9f80141b28e4c</code>: 2h15m49s/2h16m15s</li>
<li><code>88d6a72d98b13d5bcae1a4560260cae17f60d309</code>: 2h17m16s/2h16m3s</li>
<li><code>03b502c386905abef9892d59d09c36220c04a0da</code>: 2h12m28s</li>
</ul>
<p>I did two runs per commit but the second run for the last commit failed for some strange reason (not related to the code). But I think the picture is clear enough anyway. The build time typically fluctuates +/- 1min, so the difference between the first two commits is probably not significant.</p>



<a name="238611791"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/performance%20of%20ordered%20refactor/near/238611791" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/performance.20of.20ordered.20refactor.html#238611791">(May 13 2021 at 12:00)</a>:</h4>
<p>Ok, great, thank you very much for this!!</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>