---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/speed-up.20project.20returns.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html">speed-up project returns</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="197425746"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197425746" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197425746">(May 13 2020 at 15:05)</a>:</h4>
<p>the current mathlib compile time is 4 hours, so it's time for the speed-up project to return. current statistics:</p>
<div class="codehilite"><pre><span></span><code>645.0 src/analysis/special_functions/trigonometric.lean
472.0 src/data/polynomial.lean
382.0 src/data/multiset.lean
367.0 src/analysis/special_functions/pow.lean
300.0 src/data/mv_polynomial.lean
290.0 src/category_theory/limits/shapes/binary_products.lean
284.0 src/analysis/normed_space/multilinear.lean
270.0 src/topology/metric_space/hausdorff_distance.lean
268.0 src/linear_algebra/basic.lean
254.0 src/data/dfinsupp.lean
240.0 src/analysis/calculus/deriv.lean
234.0 src/geometry/manifold/mfderiv.lean
224.0 src/category_theory/comma.lean
220.0 src/data/complex/exponential.lean
216.0 src/data/finset.lean
212.0 src/linear_algebra/basis.lean
211.0 src/data/padics/padic_numbers.lean
211.0 src/analysis/analytic/basic.lean
208.0 src/ring_theory/power_series.lean
205.0 src/analysis/calculus/times_cont_diff.lean
</code></pre></div>


<p>(<a href="https://gist.github.com/kckennylau/ed020e947bc2501f54d7f944b6bac2b9">raw data</a>, <a href="https://gist.github.com/kckennylau/14c550307b0d9f3ef3f38367038eda0f">sorted</a>)</p>



<a name="197426004"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197426004" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197426004">(May 13 2020 at 15:07)</a>:</h4>
<p>Somewhat related: <a href="https://github.com/leanprover-community/mathlib/issues/2276">#2276</a></p>



<a name="197426165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197426165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197426165">(May 13 2020 at 15:08)</a>:</h4>
<p>I'm certainly in favor of a speed-up project! But just to be sure: you're not actually compiling mathlib for 4 hours, right? There's no reason to take longer than CI.</p>
<p>If you want to build: commit and push to a random branch of mathlib. In under 2 hours, <code>leanproject get-cache</code> should offer you a bunch of fresh oleans.</p>



<a name="197426220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197426220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197426220">(May 13 2020 at 15:08)</a>:</h4>
<p>And it uses almost none of your own cpu. :)</p>



<a name="197427683"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197427683" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197427683">(May 13 2020 at 15:19)</a>:</h4>
<p>I actually compiled mathlib for 4 hours</p>



<a name="197427719"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197427719" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197427719">(May 13 2020 at 15:19)</a>:</h4>
<p>which agrees with the time <a href="#narrow/stream/113538-travis">here</a></p>



<a name="197427742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197427742" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197427742">(May 13 2020 at 15:19)</a>:</h4>
<p>I guess CI uses multithreads</p>



<a name="197428684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197428684" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197428684">(May 13 2020 at 15:24)</a>:</h4>
<p>I have no idea what the build time bot is, I don't read that stream. But the oleans for that commit were available 1:48 after it landed on the staging branch: <a href="https://github.com/leanprover-community/mathlib/runs/669462271">https://github.com/leanprover-community/mathlib/runs/669462271</a></p>



<a name="197428793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197428793" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197428793">(May 13 2020 at 15:25)</a>:</h4>
<p>so CI must use 2 threads!</p>



<a name="197428980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197428980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197428980">(May 13 2020 at 15:26)</a>:</h4>
<p>I was surprised how long the build-time-bot is taking now. (It was offline for a while in february/march, and got much worse when I restarted it.)</p>



<a name="197429033"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197429033" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197429033">(May 13 2020 at 15:26)</a>:</h4>
<p><span class="user-mention" data-user-id="110087">@Scott Morrison</span> oh and how would you feel if I replaced all your <code>by tidy</code> with manual labour?</p>



<a name="197429123"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197429123" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197429123">(May 13 2020 at 15:27)</a>:</h4>
<p>I'm not going to stand in the way of this happening.</p>



<a name="197429131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197429131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197429131">(May 13 2020 at 15:27)</a>:</h4>
<p>But it would make me very sad. :-)</p>



<a name="197429181"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197429181" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197429181">(May 13 2020 at 15:27)</a>:</h4>
<p>Theorem provers future usefulness depends on them being able to carry their own weight.</p>



<a name="197429271"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197429271" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197429271">(May 13 2020 at 15:28)</a>:</h4>
<p>i.e. to handle for themselves a great deal of the tedious plumbing in between the mathematical ideas and the underlying logic.</p>



<a name="197429337"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197429337" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197429337">(May 13 2020 at 15:28)</a>:</h4>
<p>(I said "future usefulness" to emphasise the complete use-less-ness of all current theorem provers!)</p>



<a name="197429373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197429373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197429373">(May 13 2020 at 15:29)</a>:</h4>
<p>I'm not claiming at all that <code>tidy</code> is the answer. It is obviously lame and dumb and slow.</p>



<a name="197429436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197429436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197429436">(May 13 2020 at 15:29)</a>:</h4>
<p>But it makes me sad that we're thinking "how do we avoid using automation", rather than "what do we need to do before this sort of automation is viable"?</p>



<a name="197429640"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197429640" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197429640">(May 13 2020 at 15:31)</a>:</h4>
<p>I'd much prefer that we put effort into making <a href="https://github.com/leanprover-community/mathlib/issues/2300">#2300</a> viable than writing "boilerplate".</p>



<a name="197429944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197429944" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197429944">(May 13 2020 at 15:33)</a>:</h4>
<p>Also --- just making <code>tidy</code> faster is probably low hanging fruit.</p>



<a name="197430040"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197430040" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197430040">(May 13 2020 at 15:34)</a>:</h4>
<p>I suspect that amongst the subsidiary tactics <code>tidy</code> calls, <code>auto_cases</code>, and <code>simp</code> are the killers. But it would be good to know where it spends its time.</p>



<a name="197431224"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197431224" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197431224">(May 13 2020 at 15:40)</a>:</h4>
<p>per byte data:</p>
<div class="codehilite"><pre><span></span><code>0.04807339449541284 src/topology/category/Top/adjunctions.lean
0.020389546351084812 src/category_theory/elements.lean
0.015910462500685795 src/category_theory/limits/shapes/binary_products.lean
0.015718349928876246 src/analysis/normed_space/hahn_banach.lean
0.014868532998419965 src/analysis/special_functions/pow.lean
0.014746689923095219 src/category_theory/limits/over.lean
0.013920285544318858 src/analysis/complex/basic.lean
0.013886572143452876 src/category_theory/limits/shapes/constructions/limits_of_products_and_equalizers.lean
0.013393418570530287 src/measure_theory/probability_mass_function.lean
0.013363333985521423 src/algebra/homology/homology.lean
0.012804698972099854 src/category_theory/graded_object.lean
0.012802926383173296 src/topology/sheaves/presheaf.lean
0.012098366541015976 src/algebra/category/Module/monoidal.lean
0.011772905842098594 src/category_theory/limits/shapes/wide_pullbacks.lean
0.011354838709677418 src/category_theory/adjunction/limits.lean
0.011281224818694601 src/category_theory/pempty.lean
0.010924593658406609 src/topology/metric_space/cau_seq_filter.lean
0.010811648079306072 src/category_theory/currying.lean
0.010690172543135784 src/data/padics/padic_integers.lean
0.010124164278892072 src/algebraic_geometry/stalks.lean
</code></pre></div>


<p>(<a href="https://gist.github.com/kckennylau/cc14edf26842ac3ecd8f54bb26858f4b">full data</a>)</p>



<a name="197431320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197431320" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197431320">(May 13 2020 at 15:41)</a>:</h4>
<p>the most ideal count is per "lemma/def" right</p>



<a name="197431518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197431518" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197431518">(May 13 2020 at 15:42)</a>:</h4>
<p>I don't understand why it matters to <span class="user-mention" data-user-id="110064">@Kenny Lau</span>  that it takes hours to compile.</p>



<a name="197431748"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197431748" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197431748">(May 13 2020 at 15:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110038">Kevin Buzzard</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197431518">said</a>:</p>
<blockquote>
<p>I don't understand why it matters to <span class="user-mention silent" data-user-id="110064">Kenny Lau</span>  that it takes hours to compile.</p>
</blockquote>
<p>I'm not the only one:<br>
<span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/113538-travis/topic/build.20time.20bot/near/197357348">said</a>:</p>
<blockquote>
<p>The links are working again. I have no idea why the build times are so much worse than they used to be. Mathlib grew?</p>
</blockquote>



<a name="197437373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197437373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197437373">(May 13 2020 at 16:19)</a>:</h4>
<p>per declarations:</p>
<div class="codehilite"><pre><span></span><code>38.0 src/number_theory/sum_four_squares.lean
27.8 src/topology/metric_space/completion.lean
26.2 src/topology/category/Top/adjunctions.lean
26.15 src/algebra/category/Group/biproducts.lean
23.0 src/category_theory/products/basic.lean
22.666666666666668 src/data/padics/hensel.lean
22.2 src/category_theory/limits/shapes/constructions/limits_of_products_and_equalizers.lean
22.1 src/analysis/normed_space/hahn_banach.lean
16.7 src/topology/category/TopCommRing.lean
16.54 src/category_theory/elements.lean
15.7 src/measure_theory/simple_func_dense.lean
14.95 src/category_theory/limits/functor_category.lean
14.9 src/category_theory/monad/algebra.lean
14.75 src/data/zsqrtd/basic.lean
12.971428571428572 src/data/matrix/notation.lean
12.725 src/analysis/calculus/extend_deriv.lean
12.4 src/category_theory/limits/over.lean
12.363636363636363 src/geometry/manifold/basic_smooth_bundle.lean
11.95 src/analysis/complex/polynomial.lean
11.7 src/analysis/complex/basic.lean
</code></pre></div>


<p>(<a href="https://gist.github.com/kckennylau/41242df750190f48ce206d43a615e7e7">full data</a>)</p>



<a name="197439386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197439386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197439386">(May 13 2020 at 16:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110064">Kenny Lau</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197427683">said</a>:</p>
<blockquote>
<p>I actually compiled mathlib for 4 hours</p>
</blockquote>
<p>What kind of CPU did you use?<br>
Did anyone tried to compile mathlib using AMD-based ThreadRipper?</p>



<a name="197439704"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197439704" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197439704">(May 13 2020 at 16:35)</a>:</h4>
<p>Kenny has a machine that is very slow for unknown reasons</p>



<a name="197439774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197439774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197439774">(May 13 2020 at 16:36)</a>:</h4>
<p>he consistently measures times that are about double everyone else</p>



<a name="197439961"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197439961" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197439961">(May 13 2020 at 16:37)</a>:</h4>
<p>but I can see why that might incentivize him to speed up things more. I actually think that the move to all-CI and downloaded oleans has decoupled us from the pressures of improving compile times a bit too much. If we aren't careful this will be 6 hours in a few months</p>



<a name="197440009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197440009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197440009">(May 13 2020 at 16:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197439774">said</a>:</p>
<blockquote>
<p>he consistently measures times that are about double everyone else</p>
</blockquote>
<p>so does <a href="#narrow/stream/113538-travis">build time bot</a></p>



<a name="197440257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197440257" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197440257">(May 13 2020 at 16:39)</a>:</h4>
<p>I see nothing in that stream?</p>



<a name="197440294"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197440294" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197440294">(May 13 2020 at 16:40)</a>:</h4>
<p>I thought the build time bot died</p>



<a name="197440414"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197440414" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197440414">(May 13 2020 at 16:40)</a>:</h4>
<p>we are using github actions now for builds, so the timing would have to adapt to that</p>



<a name="197440597"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197440597" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197440597">(May 13 2020 at 16:42)</a>:</h4>
<p>You might have to click "more topics" if you muted some of the spammier topics there.</p>



<a name="197440675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197440675" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197440675">(May 13 2020 at 16:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239718">build time bot</span> <a href="#narrow/stream/113538-travis/topic/build.20time.20bot/near/197408593">said</a>:</p>
<blockquote>
<p>Building master at <a href="https://github.com/leanprover-community/mathlib/commit/51e2b4ccef20e49bc24ef86a6afe6e48196abbcf">https://github.com/leanprover-community/mathlib/commit/51e2b4ccef20e49bc24ef86a6afe6e48196abbcf</a> takes 246m47.805s</p>
<p>--profile output at <a href="https://tqft.net/lean/mathlib/51e2b4ccef20e49bc24ef86a6afe6e48196abbcf.log">https://tqft.net/lean/mathlib/51e2b4ccef20e49bc24ef86a6afe6e48196abbcf.log</a></p>
</blockquote>



<a name="197440896"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197440896" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197440896">(May 13 2020 at 16:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197439961">said</a>:</p>
<blockquote>
<p>but I can see why that might incentivize him to speed up things more. I actually think that the move to all-CI and downloaded oleans has decoupled us from the pressures of improving compile times a bit too much. If we aren't careful this will be 6 hours in a few months</p>
</blockquote>
<p>Is the CI running default/common hardware or custom powerful hardware?</p>



<a name="197440935"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197440935" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197440935">(May 13 2020 at 16:45)</a>:</h4>
<p><a href="https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners#cloud-hosts-for-github-hosted-runners">https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners#cloud-hosts-for-github-hosted-runners</a></p>



<a name="197440970"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197440970" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197440970">(May 13 2020 at 16:45)</a>:</h4>
<p>Okay so that's the default GH Actions hardware</p>



<a name="197441135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441135">(May 13 2020 at 16:46)</a>:</h4>
<p>I have to try to compile mathlib on this <a href="https://www.packet.com/cloud/servers/c3-medium/">https://www.packet.com/cloud/servers/c3-medium/</a> just for reference</p>



<a name="197441238"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441238" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441238">(May 13 2020 at 16:47)</a>:</h4>
<p>CI machines tend to be slower than regular machines because they are time sharing with other CI projects</p>



<a name="197441354"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441354" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441354">(May 13 2020 at 16:48)</a>:</h4>
<p>but they also happen in parallel so it's not that relevant how long it takes unless you want to decrease latency</p>



<a name="197441358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441358" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441358">(May 13 2020 at 16:48)</a>:</h4>
<p>Yes, they're most likely virtualized under some baremetal stuff and some CI projects must steal CPU</p>



<a name="197441428"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441428" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441428">(May 13 2020 at 16:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197441354">said</a>:</p>
<blockquote>
<p>but they also happen in parallel so it's not that relevant how long it takes unless you want to decrease latency</p>
</blockquote>
<p>But like, more cores would decrease the total amount of time, right?</p>



<a name="197441464"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441464" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441464">(May 13 2020 at 16:49)</a>:</h4>
<p>sure</p>



<a name="197441471"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441471" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441471">(May 13 2020 at 16:49)</a>:</h4>
<p>I don't know how much mathlib compilation would benefit of parallelism</p>



<a name="197441490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441490">(May 13 2020 at 16:49)</a>:</h4>
<p>it benefits greatly</p>



<a name="197441507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441507" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441507">(May 13 2020 at 16:49)</a>:</h4>
<p>lean is fully parallel and will use all your cores</p>



<a name="197441641"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441641" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441641">(May 13 2020 at 16:50)</a>:</h4>
<p>So an ThreadRipper 3990X with 64 cores / 128 threads would make Lean very much instant, I guess</p>



<a name="197441705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441705">(May 13 2020 at 16:50)</a>:</h4>
<p>In exchange of the mere amount of 4K EUR…</p>



<a name="197441721"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441721" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441721">(May 13 2020 at 16:50)</a>:</h4>
<p>Does anyone own one of those?</p>



<a name="197441862"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441862" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441862">(May 13 2020 at 16:51)</a>:</h4>
<p>I personally don't, but I know sysadmin people who has one of them and I'm looking to own one for some general work / projects</p>



<a name="197441887"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441887" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441887">(May 13 2020 at 16:51)</a>:</h4>
<p>I know that scott has access to some high quality hardware that he has been using for the build time bot, but apparently something has recently got a lot worse and it's not clear if it's mathlib, the build system, or scott's machine</p>



<a name="197441964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441964">(May 13 2020 at 16:52)</a>:</h4>
<p>Maybe that's something that an university can afford, I guess or you'd found it in HPC clusters but don't know how hard would it be to compile mathlib on those</p>



<a name="197441984"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197441984" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197441984">(May 13 2020 at 16:52)</a>:</h4>
<p>There was some not-so-serious talk at Lean Together about buying one of these things with grant money and setting up a fast compile server.</p>



<a name="197442027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197442027" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197442027">(May 13 2020 at 16:52)</a>:</h4>
<p>But that takes someone with sysadmin experience to keep running correctly.</p>



<a name="197442281"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197442281" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197442281">(May 13 2020 at 16:54)</a>:</h4>
<p>I know that in the cloud/DevOps landscape, CNCF just give out access to a $25K/month account of ressources on <a href="http://Packet.com">Packet.com</a>: <a href="https://www.cncf.io/community/infrastructure-lab/">https://www.cncf.io/community/infrastructure-lab/</a> which everyone can ask for if the demand is sound</p>



<a name="197442472"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197442472" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197442472">(May 13 2020 at 16:55)</a>:</h4>
<p>Also, don't know how much Microsoft would be interested into giving infra for free to mathlib (?), I know that it's a Lean Prover community project, but as it's a big one… (?)</p>



<a name="197445903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197445903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197445903">(May 13 2020 at 17:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="262143">Ryan Lahfa</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197441135">said</a>:</p>
<blockquote>
<p>I have to try to compile mathlib on this <a href="https://www.packet.com/cloud/servers/c3-medium/">https://www.packet.com/cloud/servers/c3-medium/</a> just for reference</p>
</blockquote>
<p>My prediction is somewhere in the vicinity of 30 minutes</p>



<a name="197446026"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197446026" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197446026">(May 13 2020 at 17:17)</a>:</h4>
<p>My ancient hardware manages to compile in about 50 minutes. I have 16 threads.</p>



<a name="197446085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197446085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197446085">(May 13 2020 at 17:17)</a>:</h4>
<p>So I hope modern hardware would be able to get &lt; 20 minutes</p>



<a name="197446501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197446501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197446501">(May 13 2020 at 17:20)</a>:</h4>
<p>25min on my Ryzen 3700X (8 cores, 16 threads). I'm doing some timings with 1 and 8 cores right now to measure the speedup. Still, the usual caveat applies: what scales up to 16 threads does not necessarily scale up to 128 threads. There is no substitute for benchmarks.</p>



<a name="197447021"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447021" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447021">(May 13 2020 at 17:23)</a>:</h4>
<p>It'd be good if someone with more C++ knowledge than me could take a look at <a href="https://github.com/leanprover-community/lean/issues/58">lean#58</a> and other timing output issues so that we could get more accurate per-file / per-declaration timings. Has the profiling situation improved in Lean 4?</p>



<a name="197447184"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447184" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447184">(May 13 2020 at 17:23)</a>:</h4>
<p>Right, I don't think there is any doubt that there is plenty more than 8 available parallelism for most or all of the build.</p>



<a name="197447384"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447384" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447384">(May 13 2020 at 17:24)</a>:</h4>
<p>One interesting test would be to hack lean to skip all proofs, and see how much faster it gets. That should be an upper bound on the parallelism</p>



<a name="197447459"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447459" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447459">(May 13 2020 at 17:25)</a>:</h4>
<p>It doesn't help nearly as much as you might assume.  The definitions take a lot of time as well, and parsing the proofs is surprisingly expensive.</p>



<a name="197447487"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447487" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447487">(May 13 2020 at 17:25)</a>:</h4>
<p>There's still module-parallelism, though, which is controlled by the width of the import structure</p>



<a name="197447702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447702" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447702">(May 13 2020 at 17:27)</a>:</h4>
<p>category theory is almost entirely definitions, at least at top level--I'm not sure how much parallelism is gained by floating out proofs</p>



<a name="197447800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447800">(May 13 2020 at 17:28)</a>:</h4>
<p>Don't Prop parts of definitions get floated out as proofs?</p>



<a name="197447828"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447828" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447828">(May 13 2020 at 17:28)</a>:</h4>
<p>maybe that's not until the tactic is finished running though</p>



<a name="197447842"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447842" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447842">(May 13 2020 at 17:28)</a>:</h4>
<p>I guess I'm not sure at what point that happens <span aria-label="this" class="emoji emoji-1f446" role="img" title="this">:this:</span></p>



<a name="197447889"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447889" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447889">(May 13 2020 at 17:29)</a>:</h4>
<p>It should be possible for <code>tidy</code> to make sure this happens</p>



<a name="197447907"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447907" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447907">(May 13 2020 at 17:29)</a>:</h4>
<p>Like if I have <code>def X : Thing := { str := blah blah, prop := by tidy }</code> how much work gets floated out</p>



<a name="197447934"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447934" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447934">(May 13 2020 at 17:29)</a>:</h4>
<p>Is it possible that the elaboration of <code>str</code> even depends on what happens inside <code>tidy</code>?</p>



<a name="197447948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447948" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447948">(May 13 2020 at 17:29)</a>:</h4>
<p>My impression at one point was that it is possible</p>



<a name="197447967"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447967" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447967">(May 13 2020 at 17:29)</a>:</h4>
<p>You could wrap <code>tidy</code> in <code>prove_goal_async</code>.</p>



<a name="197447983"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197447983" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197447983">(May 13 2020 at 17:29)</a>:</h4>
<p>interesting!</p>



<a name="197448053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448053">(May 13 2020 at 17:30)</a>:</h4>
<p>that is a string that I believe has not appeared on Zulip before</p>



<a name="197448202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448202">(May 13 2020 at 17:31)</a>:</h4>
<p>For example, this works:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic</span>

<span class="kn">structure</span> <span class="n">thing</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span>
<span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">=</span> <span class="mi">3</span><span class="o">)</span>

<span class="n">def</span> <span class="n">my_thing</span> <span class="o">:</span> <span class="n">thing</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">x</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">tidy</span> <span class="o">}</span>
</code></pre></div>



<a name="197448217"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448217" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448217">(May 13 2020 at 17:31)</a>:</h4>
<p>I think it's mostly unfortunate that it works, though</p>



<a name="197448422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448422" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448422">(May 13 2020 at 17:33)</a>:</h4>
<p>You can't float this goal because it is <code>?m = 3</code></p>



<a name="197448446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448446" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448446">(May 13 2020 at 17:33)</a>:</h4>
<p>how would you generalize it?</p>



<a name="197448490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448490">(May 13 2020 at 17:33)</a>:</h4>
<p>I don't want to float it, I want to get an error.</p>



<a name="197448595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448595" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448595">(May 13 2020 at 17:34)</a>:</h4>
<p>but that will break things</p>



<a name="197448609"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448609" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448609">(May 13 2020 at 17:34)</a>:</h4>
<p>because that feature is used for sure</p>



<a name="197448695"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448695" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448695">(May 13 2020 at 17:35)</a>:</h4>
<p>unless you mean that you want <code>tidy</code> specifically to complain when given goals with metavariables</p>



<a name="197448719"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448719" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448719">(May 13 2020 at 17:35)</a>:</h4>
<p>I think those things should be broken.</p>



<a name="197448753"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448753" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448753">(May 13 2020 at 17:35)</a>:</h4>
<p>there are other tactics like <code>refine_struct</code> where this is kind of the point</p>



<a name="197448755"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448755" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448755">(May 13 2020 at 17:35)</a>:</h4>
<p>It actually makes it quite difficult to use interactively when Lean is trying to prove things about your incomplete definition, I found</p>



<a name="197448877"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448877" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448877">(May 13 2020 at 17:36)</a>:</h4>
<p>I guess we want both options (-;</p>



<a name="197448894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448894">(May 13 2020 at 17:36)</a>:</h4>
<p>for example, Lean won't just tell you it can't infer something because what if it somehow magically gets fixed by a proof obligation involving <code>tidy</code></p>



<a name="197448985"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197448985" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197448985">(May 13 2020 at 17:37)</a>:</h4>
<p>I can't remember exactly how this comes up, but I remember being very frustrated by those <code>. obviously</code> annotations</p>



<a name="197449018"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197449018" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197449018">(May 13 2020 at 17:37)</a>:</h4>
<p>to the point where it was easier to just add the missing fields in by hand to get Lean to stop doing annoying things</p>



<a name="197449077"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197449077" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197449077">(May 13 2020 at 17:38)</a>:</h4>
<p>I wonder how much stuff would actually break, though.</p>



<a name="197449117"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197449117" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197449117">(May 13 2020 at 17:38)</a>:</h4>
<p>I can definitely see the issue; if you write <code>{ x := _ }</code> and there is an autoparam on <code>p := by tidy</code> you won't get any message saying what <code>x</code> should be</p>



<a name="197449192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197449192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197449192">(May 13 2020 at 17:39)</a>:</h4>
<p><span class="user-mention" data-user-id="110032">@Reid Barton</span> You don't want to change the behaviour of structures in general, right? Only <code>. obviously</code>?</p>



<a name="197449230"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197449230" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197449230">(May 13 2020 at 17:39)</a>:</h4>
<p>So maybe that should wrap in <code>prove_goal_async</code>?</p>



<a name="197449288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197449288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197449288">(May 13 2020 at 17:40)</a>:</h4>
<p>I confirm that <code>prove_goal_async</code> works as advertised regarding goals with metavariables (which is also apparent from the source):</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">tidy&#39;</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">prove_goal_async</span> <span class="bp">`</span><span class="o">[</span><span class="n">tidy</span><span class="o">]</span>

<span class="kn">structure</span> <span class="n">thing</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span>
<span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">=</span> <span class="mi">3</span><span class="o">)</span>

<span class="n">def</span> <span class="n">my_thing</span> <span class="o">:</span> <span class="n">thing</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">x</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span> <span class="c1">-- don&#39;t know how to synthesize placeholder</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">tidy&#39;</span> <span class="o">}</span>
</code></pre></div>



<a name="197449408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197449408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197449408">(May 13 2020 at 17:41)</a>:</h4>
<p>then an added bonus is you can replace <code>prove_goal_async</code> by <code>def prove_goal_async' : tactic unit -&gt; tactic unit := pure ()</code> <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span></p>



<a name="197449581"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197449581" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197449581">(May 13 2020 at 17:42)</a>:</h4>
<p>Er maybe use sorry or something I meant</p>



<a name="197461933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197461933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jalex Stark <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197461933">(May 13 2020 at 19:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110596">Rob Lewis</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197441984">said</a>:</p>
<blockquote>
<p>There was some not-so-serious talk at Lean Together about buying one of these things with grant money and setting up a fast compile server.</p>
</blockquote>
<p>So is this funding-constrained or sysadmin-constrained or both?</p>



<a name="197462057"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197462057" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197462057">(May 13 2020 at 19:13)</a>:</h4>
<p>I think sysadmin-constrained</p>



<a name="197474875"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197474875" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197474875">(May 13 2020 at 20:41)</a>:</h4>
<p>Results of my parallel compilation 'experiment':</p>
<div class="codehilite"><pre><span></span><code>#threads | time    | speedup
1        | 2:32:15 | 1
8        |   31:54 | 4.77
16       |   25:57 | 5.87
</code></pre></div>


<p>Commands used to produce these number:</p>
<div class="codehilite"><pre><span></span><code>$ cd &lt;mathlib dir&gt;
$ rm **.olean
$ time leanpkg build -- --threads=&lt;N&gt; --memory=16000
</code></pre></div>


<p>Processor: Ryzen 7 3700X (8 cores, 16 threads)</p>
<p>There may be some noise because I was using the computer during those runs (and also I didn't do multiple runs or anything, so major grain of salt).</p>



<a name="197484546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197484546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197484546">(May 13 2020 at 22:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="252300">Jalex Stark</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197461933">said</a>:</p>
<blockquote>
<p>So is this funding-constrained or sysadmin-constrained or both?</p>
</blockquote>
<p>It's clearly sysadmin-constrained, so we didn't even look into the funding details.</p>



<a name="197484948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197484948" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jalex Stark <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197484948">(May 13 2020 at 22:25)</a>:</h4>
<p>seems like the sort of thing where you might be able to turn funding into a sysadmin</p>



<a name="197485195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197485195" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197485195">(May 13 2020 at 22:28)</a>:</h4>
<p>One fast processor could be within a grant budget. It's one trip to one conference, no big deal. Hiring personnel is another story.</p>



<a name="197485227"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197485227" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197485227">(May 13 2020 at 22:28)</a>:</h4>
<p>If you know a sysadmin who will work for pennies, then maybe we could talk!</p>



<a name="197485241"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197485241" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197485241">(May 13 2020 at 22:28)</a>:</h4>
<p>But tomorrow, it's bedtime.</p>



<a name="197485332"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197485332" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jalex Stark <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197485332">(May 13 2020 at 22:30)</a>:</h4>
<p>(I have in fact pinged a few underemployed sysadmin folks, I'll come back here if I get any bites)</p>



<a name="197488791"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197488791" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197488791">(May 13 2020 at 23:11)</a>:</h4>
<p>Do we really need a professional sysadmin to set up a Github Actions runner? I just looked into it and it doesn't seem very complicated at all. If we rent one or two virtual servers (~50Eur/month for 16 virtual cores), I can probably set up the OS and Github runner application myself.</p>
<p>The only snag is that Github doesn't recommend using self-hosted runners with public repos. Apparently you can execute arbitrary code by creating a PR, which is not so great.</p>



<a name="197488939"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197488939" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197488939">(May 13 2020 at 23:12)</a>:</h4>
<p>it's like any maintenance job. You are not needed at all for several months, and then oh god everything is broken and it needs to be fixed now and no one knows how anything works</p>



<a name="197489347"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197489347" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jalex Stark <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197489347">(May 13 2020 at 23:17)</a>:</h4>
<p>if you're volunteering to be the sysadmin that works for pennies, I'm sure people here appreciate the work</p>



<a name="197489362"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197489362" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jalex Stark <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197489362">(May 13 2020 at 23:17)</a>:</h4>
<p>I don't understand half of the things you said, so I certainly couldn't do it</p>



<a name="197489423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197489423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jalex Stark <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197489423">(May 13 2020 at 23:18)</a>:</h4>
<p>I don't know where on the spectrum of skill you draw the line of "professional sysadmin"</p>



<a name="197489439"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197489439" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jalex Stark <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197489439">(May 13 2020 at 23:18)</a>:</h4>
<p>many (most?) of us here are "professional mathematicians" who choose do a bunch of mathematical work for free</p>



<a name="197496325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197496325" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197496325">(May 14 2020 at 00:55)</a>:</h4>
<p>Okay, if someone gets me some money to rent a suitable virtual server, I can set up a Github runner on it. I can also maintain it for the time being; I still have 3.5 years left on my PhD. I've run my own private virtual server for a couple of years (with a way more complex configuration) and it's really not much work for pretty decent uptime. Besides, should the server ever be down for long, Github should just fall back to its own runners.</p>



<a name="197497497"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497497" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497497">(May 14 2020 at 01:14)</a>:</h4>
<p>However, see my message above for security concerns. These apply to any third-party Github runner, regardless of whether that runner is a virtual server or a physical box. One solution would be to restrict PR creation to people who have commit-to-non-master-branch rights (if Github allows this). This would at least prevent complete strangers from hijacking the runner.</p>



<a name="197497520"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497520" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497520">(May 14 2020 at 01:14)</a>:</h4>
<p>For reference, the machine running the <a href="#narrow/stream/113538-travis/topic/build.20time.20bot"><code>build-time-bot</code></a> stream is an 18 core 2.3GHz Xeon W. The build-time-bot runs with <code>-j1</code> for reproducibility.</p>



<a name="197497722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497722" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497722">(May 14 2020 at 01:19)</a>:</h4>
<p>Compiling mathlib on this machine never maxs out the processors. The highest I see watching <code>top</code> is about 1500%. (Which sounds close to maxing out, but with hyperthreading we need to get to 3600% to count as maxing out?)</p>



<a name="197497728"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497728" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497728">(May 14 2020 at 01:19)</a>:</h4>
<p>As far as I can see, nothing changed in how <code>build-time-bot</code> works during the gap that it wasn't running.</p>



<a name="197497800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497800">(May 14 2020 at 01:21)</a>:</h4>
<p>During that gap, the build times appear to have jumped from 86m21.607s to 234m12.034s, which seems pretty worrying.</p>



<a name="197497806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497806" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497806">(May 14 2020 at 01:21)</a>:</h4>
<p>How long a gap was that?</p>



<a name="197497822"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497822" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497822">(May 14 2020 at 01:22)</a>:</h4>
<p>January 23, commit 96ee2a6979b5bd20bee9de497d77fcd7f562ed4f</p>



<a name="197497824"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497824" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497824">(May 14 2020 at 01:22)</a>:</h4>
<p>to</p>



<a name="197497862"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497862" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497862">(May 14 2020 at 01:22)</a>:</h4>
<p>also, is this data recorded somewhere other than in a zulip stream, possibly with graphs?</p>



<a name="197497865"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497865" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497865">(May 14 2020 at 01:22)</a>:</h4>
<p>April 8, commit 732f7109c5cb2ece35481c200faa38fbbb4dc995</p>



<a name="197497867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497867" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497867">(May 14 2020 at 01:22)</a>:</h4>
<p>Sorry!</p>



<a name="197497894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497894">(May 14 2020 at 01:23)</a>:</h4>
<p>My script ends with <code>zulip-send ...</code></p>



<a name="197497970"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497970" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497970">(May 14 2020 at 01:24)</a>:</h4>
<p>(I stopped working on this shortly after getting the bare minimum working, because it seems that day-to-day variation was random enough to not be that helpful identifying bad commits.)</p>



<a name="197497976"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197497976" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197497976">(May 14 2020 at 01:24)</a>:</h4>
<p>I see</p>



<a name="197498057"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197498057" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197498057">(May 14 2020 at 01:26)</a>:</h4>
<p>ok, I'm now keeping a local copy</p>



<a name="197498122"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197498122" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197498122">(May 14 2020 at 01:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197497722">said</a>:</p>
<blockquote>
<p>Compiling mathlib on this machine never maxs out the processors. The highest I see watching <code>top</code> is about 1500%. (Which sounds close to maxing out, but with hyperthreading we need to get to 3600% to count as maxing out?)</p>
</blockquote>
<p>Afaiu, these numbers are pretty meaningless in the first place because you can 'max out' a system by busy-waiting on a lock or queue. For my 8- and 16-core load, I get perfect 8x and 16x system load, but not nearly the same speedup.</p>



<a name="197498126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197498126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197498126">(May 14 2020 at 01:28)</a>:</h4>
<p>The log files are all <a href="https://tqft.net/lean/mathlib/">here</a>, but they're not terribly useful due to the bugs in Lean's profiling output. I was going to suggest pulling the numbers from the HTML of the Zulip archive of the build-time-bot thread, but we're not archiving the travis stream.</p>



<a name="197498154"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197498154" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197498154">(May 14 2020 at 01:30)</a>:</h4>
<p>Interesting, <span class="user-mention" data-user-id="256311">@Jannis Limperg</span>.  I definitely don't get full load. For quite a while at the beginning of building mathlib it sits at about 600%, and then in the later half of building it slowly decays as well.</p>



<a name="197498200"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197498200" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197498200">(May 14 2020 at 01:30)</a>:</h4>
<p>This had made me think that the numbers were pretty good, and were actually reflecting the width of the import graph.</p>



<a name="197498277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197498277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197498277">(May 14 2020 at 01:32)</a>:</h4>
<p>it's okay, I can write a zulip bot to consume the output of Scott's zulip bot</p>



<a name="197498617"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197498617" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197498617">(May 14 2020 at 01:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197498154">said</a>:</p>
<blockquote>
<p>Interesting, <span class="user-mention silent" data-user-id="256311">Jannis Limperg</span>.  I definitely don't get full load. For quite a while at the beginning of building mathlib it sits at about 600%, and then in the later half of building it slowly decays as well.</p>
</blockquote>
<p>That seems broadly consistent with the numbers <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197474875">here</a>.</p>



<a name="197502245"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197502245" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197502245">(May 14 2020 at 03:10)</a>:</h4>
<p><span class="user-mention" data-user-id="110087">@Scott Morrison</span> Can you retrospectively bisect the jump? Was it a gradual increase, or some commit multiplied the build time by a factor of 2?</p>



<a name="197502261"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197502261" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197502261">(May 14 2020 at 03:11)</a>:</h4>
<p>I was thinking about that... I only used <code>git bisect</code> a few times, and it scares me attempting to run it with a multi-hour test!</p>



<a name="197502265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197502265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197502265">(May 14 2020 at 03:11)</a>:</h4>
<p>But I can try by hand.</p>



<a name="197502312"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197502312" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197502312">(May 14 2020 at 03:12)</a>:</h4>
<p>If you don't want to run <code>git bisect</code>, you can just emulate weekly builds.</p>



<a name="197502315"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197502315" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197502315">(May 14 2020 at 03:12)</a>:</h4>
<p>Or daily</p>



<a name="197502342"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197502342" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197502342">(May 14 2020 at 03:13)</a>:</h4>
<p>Using <code>git checkout master@{2020-03-30}</code></p>



<a name="197502815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197502815" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197502815">(May 14 2020 at 03:24)</a>:</h4>
<p>If you can add unix users to this server, you can add a user for me, and I'll run the script.</p>



<a name="197502893"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197502893" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197502893">(May 14 2020 at 03:26)</a>:</h4>
<p>I don't have a good VPS (i.e., with reasonably good CPU&amp;RAM) at hand right now because UoT doesn't issue unix accounts to post-docs.</p>



<a name="197502991"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197502991" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197502991">(May 14 2020 at 03:29)</a>:</h4>
<p>Unfortunately that machine is not easily internet accessible via ssh.</p>



<a name="197503373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503373">(May 14 2020 at 03:39)</a>:</h4>
<p>Hmm, the <code>master@{2020-03-30}</code> trick doesn't work with a fresh clone, making it hard to use in my script.</p>



<a name="197503420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503420">(May 14 2020 at 03:40)</a>:</h4>
<p>What is the command line &amp; the error message?</p>



<a name="197503474"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503474" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503474">(May 14 2020 at 03:42)</a>:</h4>
<p><code>warning: Log for 'master' only goes back to Thu, 14 May 2020 13:38:49 +1000.</code></p>



<a name="197503495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503495">(May 14 2020 at 03:43)</a>:</h4>
<p>How do you <code>git clone</code>?</p>



<a name="197503502"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503502" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503502">(May 14 2020 at 03:43)</a>:</h4>
<p>Probably you have something like <code>--depth</code>.</p>



<a name="197503552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503552">(May 14 2020 at 03:44)</a>:</h4>
<p>Just <code>git clone https://github.com/leanprover-community/mathlib.git</code></p>



<a name="197503564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503564" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503564">(May 14 2020 at 03:44)</a>:</h4>
<p>Try <code>git fetch --unshallow</code></p>



<a name="197503602"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503602" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503602">(May 14 2020 at 03:45)</a>:</h4>
<p>Probably something in <code>git config</code> makes <code>git clone</code> create shallow clones by default.</p>



<a name="197503646"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503646" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503646">(May 14 2020 at 03:46)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="err">$</span> <span class="n">git</span> <span class="n">fetch</span> <span class="c1">--unshallow</span>
<span class="n">fatal</span><span class="o">:</span> <span class="c1">--unshallow on a complete repository does not make sense</span>
</code></pre></div>



<a name="197503650"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503650" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503650">(May 14 2020 at 03:46)</a>:</h4>
<p>I don't think that's the issue. See <a href="https://stackoverflow.com/questions/34799426/git-log-for-master-only-goes-back-to-date-bug">https://stackoverflow.com/questions/34799426/git-log-for-master-only-goes-back-to-date-bug</a></p>



<a name="197503663"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503663" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503663">(May 14 2020 at 03:47)</a>:</h4>
<p>Ah, I'm sorry.</p>



<a name="197503739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503739">(May 14 2020 at 03:48)</a>:</h4>
<p>Another answer suggests <code>git checkout </code>git rev-list -1 --before="Jan 17 2014" master`</p>



<a name="197503762"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503762" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503762">(May 14 2020 at 03:49)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="gp">$</span> git checkout <span class="sb">`</span>git rev-list -1 --before<span class="o">=</span><span class="s2">&quot;2020-01-30&quot;</span> master<span class="sb">`</span>
</code></pre></div>


<p>works for me</p>



<a name="197503879"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197503879" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197503879">(May 14 2020 at 03:52)</a>:</h4>
<p>Ok, I think I've got something working. We should start seeing some messages on the build-time-bot stream about commits in that missing period.</p>



<a name="197505281"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197505281" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197505281">(May 14 2020 at 04:29)</a>:</h4>
<p>I can't find this stream.</p>



<a name="197505377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197505377" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197505377">(May 14 2020 at 04:31)</a>:</h4>
<p>Does <a href="#narrow/stream/113538-travis/topic/build.20time.20bot">this link</a> work?</p>



<a name="197505565"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197505565" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197505565">(May 14 2020 at 04:36)</a>:</h4>
<p>Yes, I was looking for stream name. It's a bit weird to have stream <code>travis</code> with valuable information when we don't use travis anymore.</p>



<a name="197505828"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197505828" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197505828">(May 14 2020 at 04:45)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Could you please rename the stream to "Continuous integration", or simply "CI"?</p>



<a name="197505892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197505892" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197505892">(May 14 2020 at 04:46)</a>:</h4>
<p>Will build-bot still work after rename?</p>



<a name="197505897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197505897" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197505897">(May 14 2020 at 04:46)</a>:</h4>
<p>Oooh, good question</p>



<a name="197520321"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197520321" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197520321">(May 14 2020 at 07:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197503879">said</a>:</p>
<blockquote>
<p>Ok, I think I've got something working. We should start seeing some messages on the build-time-bot stream about commits in that missing period.</p>
</blockquote>
<p>It's maybe worth checking in particular the commits where we bump Lean's version, since these are the most likely to change something in the whole building process.</p>



<a name="197533436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197533436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197533436">(May 14 2020 at 10:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110064">Kenny Lau</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197437373">said</a>:</p>
<blockquote>
<p>per declarations:</p>
<div class="codehilite"><pre><span></span><code>38.0 src/number_theory/sum_four_squares.lean
27.8 src/topology/metric_space/completion.lean
26.2 src/topology/category/Top/adjunctions.lean
26.15 src/algebra/category/Group/biproducts.lean
23.0 src/category_theory/products/basic.lean
22.666666666666668 src/data/padics/hensel.lean
22.2 src/category_theory/limits/shapes/constructions/limits_of_products_and_equalizers.lean
22.1 src/analysis/normed_space/hahn_banach.lean
16.7 src/topology/category/TopCommRing.lean
16.54 src/category_theory/elements.lean
15.7 src/measure_theory/simple_func_dense.lean
14.95 src/category_theory/limits/functor_category.lean
14.9 src/category_theory/monad/algebra.lean
14.75 src/data/zsqrtd/basic.lean
12.971428571428572 src/data/matrix/notation.lean
12.725 src/analysis/calculus/extend_deriv.lean
12.4 src/category_theory/limits/over.lean
12.363636363636363 src/geometry/manifold/basic_smooth_bundle.lean
11.95 src/analysis/complex/polynomial.lean
11.7 src/analysis/complex/basic.lean
</code></pre></div>


<p>(<a href="https://gist.github.com/kckennylau/41242df750190f48ce206d43a615e7e7">full data</a>)</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>elaboration: tactic execution took 107s
num. allocated objects:  31
num. allocated closures: 39
107093ms   100.0%   tactic.step
107093ms   100.0%   scope_trace
107093ms   100.0%   _interaction
107093ms   100.0%   tactic.istep._lambda_1
107093ms   100.0%   tactic.istep
107093ms   100.0%   tactic.seq
107005ms    99.9%   tactic.to_expr
106830ms    99.8%   tactic.interactive.exact
106830ms    99.8%   _private.4130977991.all_goals_core._main._lambda_2
106830ms    99.8%   interaction_monad.monad._lambda_9
106830ms    99.8%   all_goals_core
106830ms    99.8%   tactic.all_goals
  263ms     0.2%   tactic.interactive.haveI
  263ms     0.2%   _interaction._lambda_2
  263ms     0.2%   tactic.interactive.have._lambda_1
   88ms     0.1%   tactic.exact
elaboration of prime_sum_four_squares took 130s
</code></pre></div>



<a name="197534494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197534494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197534494">(May 14 2020 at 10:25)</a>:</h4>
<p><code>prime_sum_four_squares</code> used <code>ring</code> 8 times...</p>



<a name="197534654"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197534654" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197534654">(May 14 2020 at 10:27)</a>:</h4>
<p>According to your profiling output, no time is spent inside <code>ring</code>.</p>



<a name="197534717"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197534717" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197534717">(May 14 2020 at 10:28)</a>:</h4>
<p>that's the result of <code>lean --profile</code></p>



<a name="197534728"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197534728" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197534728">(May 14 2020 at 10:28)</a>:</h4>
<p>I'm afraid if I even add one byte to the file I'll get deterministic timeout</p>



<a name="197534743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197534743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197534743">(May 14 2020 at 10:28)</a>:</h4>
<p>the point is, I don't know which profile result corresponds to which one</p>



<a name="197534759"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197534759" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197534759">(May 14 2020 at 10:28)</a>:</h4>
<p>I'm just saying, it looks like all of the time is spent on term mode elaboration, not on ring.</p>



<a name="197534780"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197534780" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197534780">(May 14 2020 at 10:29)</a>:</h4>
<p>I'm saying, this can't be the corresponding profiling result, because there is no <code>ring</code> there</p>



<a name="197535148"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197535148" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197535148">(May 14 2020 at 10:33)</a>:</h4>
<p>How to hide tactic runtime for beginners: use <code>by exact (by ring)</code> instead of <code>by ring</code>.  Then it shows up as <code>to_expr</code> instead of <code>ring</code>.</p>



<a name="197535246"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197535246" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197535246">(May 14 2020 at 10:34)</a>:</h4>
<p>ok so it might still be because of the <code>ring</code></p>



<a name="197535255"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197535255" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197535255">(May 14 2020 at 10:34)</a>:</h4>
<p>this line:</p>
<div class="codehilite"><pre><span></span><code><span class="k">by</span> <span class="n">haveI</span> <span class="n">hm0</span> <span class="o">:</span> <span class="bp">_</span><span class="n">root_</span><span class="bp">.</span><span class="n">fact</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">m</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">find_spec</span> <span class="n">hm</span><span class="o">)</span><span class="bp">.</span><span class="n">snd</span><span class="bp">.</span><span class="mi">1</span><span class="bp">;</span> <span class="n">exact</span>
</code></pre></div>


<p>hid everything</p>



<a name="197535842"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197535842" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197535842">(May 14 2020 at 10:42)</a>:</h4>
<p>You guys should stop writing such obfuscated term mode proofs... why not simply write <code>begin haveI ... end</code>?</p>



<a name="197544481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197544481" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197544481">(May 14 2020 at 12:22)</a>:</h4>
<p>Then your tools will work better :-)</p>



<a name="197554716"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197554716" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197554716">(May 14 2020 at 13:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110596">Rob Lewis</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197485227">said</a>:</p>
<blockquote>
<p>If you know a sysadmin who will work for pennies, then maybe we could talk!</p>
</blockquote>
<p>Well, here I am :-)</p>



<a name="197555104"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197555104" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197555104">(May 14 2020 at 13:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="252300">Jalex Stark</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197489423">said</a>:</p>
<blockquote>
<p>I don't know where on the spectrum of skill you draw the line of "professional sysadmin"</p>
</blockquote>
<p>mathlib's Lean project is thankfully not a usual software company project, also, we could benefit from help from other communities which also do "reproducibility stuff" like Nix/NixOS and by extension the NLnet/NGI Zero foundations: <a href="https://www.ngi.eu/ngi-projects/ngi-zero/">https://www.ngi.eu/ngi-projects/ngi-zero/</a></p>



<a name="197555314"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197555314" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jalex Stark <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197555314">(May 14 2020 at 13:41)</a>:</h4>
<p>cool! Basically all of our communities' software problems should be already solved in other contexts, learning from such solutions is great</p>



<a name="197558739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197558739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197558739">(May 14 2020 at 14:06)</a>:</h4>
<p>[Quoting…]<br>
That's a good idea. Maybe tomorrow I will look up these commits, but if someone wants to provide me a list that would be great.</p>



<a name="197561003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197561003" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197561003">(May 14 2020 at 14:13)</a>:</h4>
<p><span class="user-mention" data-user-id="110087">@Scott Morrison</span> Voila:</p>
<div class="codehilite"><pre><span></span><code><span class="go">git log --oneline -- leanpkg.toml</span>
<span class="go">81f97bdf chore(*): move to lean-3.11.0 (#2632)</span>
<span class="go">a223bbb6 chore(*): switch to lean 3.10.0 (#2587)</span>
<span class="go">99245b33 chore(*): switch to lean 3.9.0 (#2449)</span>
<span class="go">597704ac chore(*): switch to lean 3.8.0 (#2361)</span>
<span class="go">bc84a205 chore(leanpkg.toml): Lean 3.7.2c (#2203)</span>
<span class="go">e719f8ee chore(*): switch to lean 3.7.1c (#2106)</span>
<span class="go">78ffbae0 chore(*): switch to lean 3.6.1 (#2064)</span>
<span class="go">6845aaa6 chore(*): bump Lean version to 3.5.1c (#1958)</span>
<span class="go">c1e594bc feat(meta, logic, tactic): lean 3.4.2: migrate coinductive_predicates, transfer, relator (#610)</span>
<span class="go">78f19497 refactor(*): move everything into `src` (#583)</span>
<span class="go">bcec475a chore(leanpkg.toml): update version to 3.4.1</span>
<span class="go">78d28c5c fix(*): update to lean</span>
<span class="go">03d5bd97 fix(*): update to lean</span>
<span class="go">22e671c5 fix(travis.yml): fix travis setup for new nightlies</span>
<span class="go">81264ec7 fix(leanpkg.toml): remove lean_version</span>
<span class="go">c87f1e6e fix(*): finish lean update</span>
<span class="go">5717986f fix(*): update to lean</span>
<span class="go">4320c417 chore(*): rename stdlib to mathlib</span>
<span class="go">deb16814 refactor(*): import content from lean/library/data and library_dev</span>
</code></pre></div>



<a name="197658511"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197658511" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197658511">(May 15 2020 at 08:01)</a>:</h4>
<p>May I please draw your attention to: <br>
<a href="https://github.com/leanprover-community/mathlib/pull/2685#issuecomment-629088455">https://github.com/leanprover-community/mathlib/pull/2685#issuecomment-629088455</a><br>
cc: <span class="user-mention" data-user-id="110064">@Kenny Lau</span> <span class="user-mention" data-user-id="256311">@Jannis Limperg</span> <span class="user-mention" data-user-id="262143">@Ryan Lahfa</span> <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> <span class="user-mention" data-user-id="110044">@Chris Hughes</span></p>



<a name="197658546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197658546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197658546">(May 15 2020 at 08:02)</a>:</h4>
<p>Kudos to Mario! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <span aria-label="top hat" class="emoji emoji-1f3a9" role="img" title="top hat">:top_hat:</span> <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span> <span aria-label="cake" class="emoji emoji-1f370" role="img" title="cake">:cake:</span></p>



<a name="197658710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197658710" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197658710">(May 15 2020 at 08:03)</a>:</h4>
<p>I don't understand what your link has to do with this topic and what Mario has to do with your link</p>



<a name="197659004"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197659004" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197659004">(May 15 2020 at 08:06)</a>:</h4>
<p><span class="user-mention" data-user-id="110064">@Kenny Lau</span> Oops, fixed. Sorry.</p>



<a name="197659188"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197659188" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197659188">(May 15 2020 at 08:08)</a>:</h4>
<p>indeed there are ways to solve this issue without removing <code>by tidy</code> from the category theory library</p>



<a name="197659202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197659202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197659202">(May 15 2020 at 08:08)</a>:</h4>
<p>my solutions only dealt with the surface of the problem</p>



<a name="197670785"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197670785" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197670785">(May 15 2020 at 10:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197497800">said</a>:</p>
<blockquote>
<p>During that gap, the build times appear to have jumped from 86m21.607s to 234m12.034s, which seems pretty worrying.</p>
</blockquote>
<p>Did we ever confirm whether the build time really tripled over those 3 months?</p>



<a name="197670792"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197670792" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197670792">(May 15 2020 at 10:05)</a>:</h4>
<p>I can try building on a decent machine too.</p>



<a name="197670835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197670835" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197670835">(May 15 2020 at 10:05)</a>:</h4>
<p>Maybe you can build both commits 3 times?</p>



<a name="197670847"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197670847" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197670847">(May 15 2020 at 10:06)</a>:</h4>
<p>Well I was going to start with once, but okay</p>



<a name="197670848"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197670848" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197670848">(May 15 2020 at 10:06)</a>:</h4>
<p>With -j6 if you have 8 cores</p>



<a name="197670894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197670894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197670894">(May 15 2020 at 10:06)</a>:</h4>
<p>Why 6?</p>



<a name="197670920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197670920" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197670920">(May 15 2020 at 10:06)</a>:</h4>
<p>So that your other process move to the other threads, and hopefully don't influence the timing too much?</p>



<a name="197670922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197670922" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197670922">(May 15 2020 at 10:06)</a>:</h4>
<p>I just wanted to figure out first whether the change was real or caused by some other undiagnosed change</p>



<a name="197670945"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197670945" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197670945">(May 15 2020 at 10:06)</a>:</h4>
<p>Oh, well, I was going to do it on a cloud VM</p>



<a name="197670960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197670960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197670960">(May 15 2020 at 10:07)</a>:</h4>
<p>But it should be reliable enough to test for a 3x difference</p>



<a name="197676234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197676234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197676234">(May 15 2020 at 11:12)</a>:</h4>
<p>It seems the build times did triple over those three months.</p>



<a name="197676260"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197676260" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197676260">(May 15 2020 at 11:12)</a>:</h4>
<p>I've been building a random sample of intermediate commits, and so far it looks like a fairly steady increase. I haven't pinned down any big jumps.</p>



<a name="197685649"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197685649" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197685649">(May 15 2020 at 12:53)</a>:</h4>
<p>If I type <code>import analyis.complex.polynomial</code> and wait for the yellow bars to disappear, then it takes 3 seconds on lean 3.4.2, and 22 seconds on lean 3.11.0 with a full set of oleans. Lean seems to have got slower, I doubt it's mathlib getting slower that fast.</p>



<a name="197685964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197685964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197685964">(May 15 2020 at 12:56)</a>:</h4>
<p>How much did the file change?</p>



<a name="197686009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686009">(May 15 2020 at 12:56)</a>:</h4>
<p>Hard to tell. The file has a lot of dependencies, which may have changed.</p>



<a name="197686045"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686045" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686045">(May 15 2020 at 12:57)</a>:</h4>
<p>Before, Lean used to check the file dates to see if it needed to recompile something. Now, it has to compute the md5 of all the files. Could that make up for the difference?</p>



<a name="197686177"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686177" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686177">(May 15 2020 at 12:58)</a>:</h4>
<p>What Lean version was that change?</p>



<a name="197686193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686193" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686193">(May 15 2020 at 12:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110050">Sebastien Gouezel</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197686045">said</a>:</p>
<blockquote>
<p>Before, Lean used to check the file dates to see if it needed to recompile something. Now, it has to compute the md5 of all the files. Could that make up for the difference?</p>
</blockquote>
<p>Then this kind of difference should disappear on very fast disks I suppose (SSD/NVMe), right?</p>



<a name="197686215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686215" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686215">(May 15 2020 at 12:59)</a>:</h4>
<p>Here are my timings, btw</p>
<div class="codehilite"><pre><span></span><code><span class="err">$</span> <span class="n">cat</span> <span class="n">jan23</span><span class="bp">/</span><span class="n">build</span><span class="bp">.</span><span class="n">log</span> <span class="n">apr8</span><span class="bp">/</span><span class="n">build</span><span class="bp">.</span><span class="n">log</span>
<span class="n">configuring</span> <span class="n">mathlib</span> <span class="mi">0</span><span class="bp">.</span><span class="mi">1</span>
<span class="bp">&gt;</span> <span class="n">lean</span> <span class="c1">--make src</span>
<span class="mi">25449</span><span class="bp">.</span><span class="mi">26</span><span class="n">user</span> <span class="mi">63</span><span class="bp">.</span><span class="mi">32</span><span class="n">system</span> <span class="mi">24</span><span class="o">:</span><span class="mi">14</span><span class="bp">.</span><span class="mi">20</span><span class="n">elapsed</span> <span class="mi">1754</span><span class="err">%</span><span class="n">CPU</span> <span class="o">(</span><span class="mi">0</span><span class="n">avgtext</span><span class="bp">+</span><span class="mi">0</span><span class="n">avgdata</span> <span class="mi">8817328</span><span class="n">maxresident</span><span class="o">)</span><span class="n">k</span>
<span class="mi">3240</span><span class="n">inputs</span><span class="bp">+</span><span class="mi">140592</span><span class="n">outputs</span> <span class="o">(</span><span class="mi">8</span><span class="n">major</span><span class="bp">+</span><span class="mi">8338993</span><span class="n">minor</span><span class="o">)</span><span class="n">pagefaults</span> <span class="mi">0</span><span class="n">swaps</span>
<span class="n">configuring</span> <span class="n">mathlib</span> <span class="mi">0</span><span class="bp">.</span><span class="mi">1</span>
<span class="bp">&gt;</span> <span class="n">lean</span> <span class="c1">--make src</span>
<span class="mi">33719</span><span class="bp">.</span><span class="mi">78</span><span class="n">user</span> <span class="mi">55</span><span class="bp">.</span><span class="mi">97</span><span class="n">system</span> <span class="mi">43</span><span class="o">:</span><span class="mi">36</span><span class="bp">.</span><span class="mi">39</span><span class="n">elapsed</span> <span class="mi">1290</span><span class="err">%</span><span class="n">CPU</span> <span class="o">(</span><span class="mi">0</span><span class="n">avgtext</span><span class="bp">+</span><span class="mi">0</span><span class="n">avgdata</span> <span class="mi">10324836</span><span class="n">maxresident</span><span class="o">)</span><span class="n">k</span>
<span class="mi">0</span><span class="n">inputs</span><span class="bp">+</span><span class="mi">160088</span><span class="n">outputs</span> <span class="o">(</span><span class="mi">0</span><span class="n">major</span><span class="bp">+</span><span class="mi">3256318</span><span class="n">minor</span><span class="o">)</span><span class="n">pagefaults</span> <span class="mi">0</span><span class="n">swaps</span>
</code></pre></div>



<a name="197686287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686287">(May 15 2020 at 12:59)</a>:</h4>
<p>lean-3.5.1 is fifteen seconds, so the jump seems to have been from 3.4 to 3.5</p>



<a name="197686365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686365">(May 15 2020 at 13:00)</a>:</h4>
<p>This is on a VM that claims to have 32 "processors"</p>



<a name="197686464"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686464" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686464">(May 15 2020 at 13:01)</a>:</h4>
<p>and running without any <code>-j</code> flag. The total work did not increase that much: certainly not by 3x...</p>



<a name="197686474"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686474" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686474">(May 15 2020 at 13:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197686365">said</a>:</p>
<blockquote>
<p>This is on a VM that claims to have 32 "processors"</p>
</blockquote>
<p>cat /proc/cpuinfo ?</p>



<a name="197686514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686514" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686514">(May 15 2020 at 13:01)</a>:</h4>
<p>Yes, (do you really want the whole thing?)</p>



<a name="197686546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686546">(May 15 2020 at 13:01)</a>:</h4>
<p>It's 32 approximate copies of</p>
<div class="codehilite"><pre><span></span><code>processor       : 31
vendor_id       : AuthenticAMD
cpu family      : 23
model           : 1
model name      : AMD EPYC 7401P 24-Core Processor
stepping        : 2
microcode       : 0x1000065
cpu MHz         : 1996.248
cache size      : 512 KB
physical id     : 31
siblings        : 1
core id         : 0
cpu cores       : 1
apicid          : 31
initial apicid  : 31
fpu             : yes
fpu_exception   : yes
cpuid level     : 13
wp              : yes
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm rep_good nopl cpuid extd_apicid tsc_known_freq pni pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm cmp_legacy svm cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw topoext perfctr_core ssbd ibpb vmmcall fsgsbase tsc_adjust bmi1 avx2 smep bmi2 rdseed adx smap clflushopt sha_ni xsaveopt xsavec xgetbv1 virt_ssbd arat npt nrip_save arch_capabilities
bugs            : fxsave_leak sysret_ss_attrs null_seg spectre_v1 spectre_v2 spec_store_bypass
bogomips        : 3992.49
TLB size        : 1024 4K pages
clflush size    : 64
cache_alignment : 64
address sizes   : 40 bits physical, 48 bits virtual
power management:
</code></pre></div>



<a name="197686553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686553">(May 15 2020 at 13:01)</a>:</h4>
<p>Just the non-repetitive part</p>



<a name="197686670"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686670" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686670">(May 15 2020 at 13:02)</a>:</h4>
<p>but, obviously an "AMD EPYC 7401P 24-Core Processor" has more than one core per cpu, so some of the numbers must be lies</p>



<a name="197686696"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686696" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686696">(May 15 2020 at 13:02)</a>:</h4>
<p>And this is a virtualized machine?</p>



<a name="197686702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686702" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686702">(May 15 2020 at 13:02)</a>:</h4>
<p>Yep</p>



<a name="197686759"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686759" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686759">(May 15 2020 at 13:03)</a>:</h4>
<p>So, how probable is it that you actually get some CPU shares stolen from noisy neighbors?</p>



<a name="197686763"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686763" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686763">(May 15 2020 at 13:03)</a>:</h4>
<p>I could try building the same commits again to estimate the variance.</p>



<a name="197686771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686771" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686771">(May 15 2020 at 13:03)</a>:</h4>
<p>No idea</p>



<a name="197686950"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197686950" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197686950">(May 15 2020 at 13:04)</a>:</h4>
<p>Also, kind of surprising to have 32 × 24 exposed in a VM :'D, I'm not sure the OS is able to use them properly, except if it's well configured (NUMA stuff, etc. I suppose)</p>



<a name="197687503"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197687503" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197687503">(May 15 2020 at 13:08)</a>:</h4>
<p>No, it's not 32 cpus.</p>



<a name="197687525"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197687525" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197687525">(May 15 2020 at 13:08)</a>:</h4>
<p>It's 32 cores?</p>



<a name="197687533"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197687533" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197687533">(May 15 2020 at 13:08)</a>:</h4>
<p>Weird</p>



<a name="197687558"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197687558" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197687558">(May 15 2020 at 13:08)</a>:</h4>
<p>I assume I get some subset of 32 cores from some physical machine that has a total of 24*N cores for some N.</p>



<a name="197688316"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688316" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688316">(May 15 2020 at 13:14)</a>:</h4>
<p><span class="user-mention" data-user-id="110032">@Reid Barton</span> I have no idea how much a compile costs... but it might be interesting to rebuild those two commits, to get an idea of the variance.</p>



<a name="197688349"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688349" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688349">(May 15 2020 at 13:14)</a>:</h4>
<p>Are we talking about $0.05 or $5.00?</p>



<a name="197688518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688518" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688518">(May 15 2020 at 13:16)</a>:</h4>
<p>Around $0.20 I guess, I don't mind doing more builds.</p>



<a name="197688567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688567" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688567">(May 15 2020 at 13:16)</a>:</h4>
<p>If I had that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>24</mn><mo>×</mo><mn>36</mn></mrow><annotation encoding="application/x-tex">24 \times 36</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">6</span></span></span></span> core server, though... <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="197688640"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688640" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688640">(May 15 2020 at 13:17)</a>:</h4>
<p><a href="https://www.packet.com/cloud/servers/c2-medium-epyc/">https://www.packet.com/cloud/servers/c2-medium-epyc/</a><br>
The EPYC is there, with spot pricing $0.50 per hour, so… depends on the mathlib's times!</p>



<a name="197688648"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688648" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688648">(May 15 2020 at 13:17)</a>:</h4>
<p>I'm surprised... it seems that the Apr8 build takes about as long in the cloud as on my ancient box</p>



<a name="197688665"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688665" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688665">(May 15 2020 at 13:17)</a>:</h4>
<p>But I don't know anything about hardware</p>



<a name="197688675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688675" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrew Ashworth <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688675">(May 15 2020 at 13:17)</a>:</h4>
<p>if you feel ambitious: <a href="http://stanford.edu/~sadjad/gg-paper.pdf">http://stanford.edu/~sadjad/gg-paper.pdf</a></p>



<a name="197688714"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688714" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688714">(May 15 2020 at 13:17)</a>:</h4>
<p>How does</p>
<div class="codehilite"><pre><span></span><code>processor       : 15
vendor_id       : GenuineIntel
cpu family      : 6
model           : 26
model name      : Intel(R) Xeon(R) CPU           E5540  @ 2.53GHz
stepping        : 5
microcode       : 0x1d
cpu MHz         : 2043.367
cache size      : 8192 KB
physical id     : 1
siblings        : 8
core id         : 3
cpu cores       : 4
apicid          : 23
initial apicid  : 23
fpu             : yes
fpu_exception   : yes
cpuid level     : 11
wp              : yes
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ht tm pbe syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni dtes64 monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr pdcm dca sse4_1 sse4_2 popcnt lahf_lm pti ssbd ibrs ibpb stibp tpr_shadow vnmi flexpriority ept vpid dtherm ida flush_l1d
bugs            : cpu_meltdown spectre_v1 spectre_v2 spec_store_bypass l1tf mds swapgs itlb_multihit
bogomips        : 5066.73
clflush size    : 64
cache_alignment : 64
address sizes   : 40 bits physical, 48 bits virtual
power management:
</code></pre></div>


<p>look?</p>



<a name="197688727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688727" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688727">(May 15 2020 at 13:17)</a>:</h4>
<p>Is that reasonable stuff, or as ancient as I think it is?</p>



<a name="197688902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197688902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197688902">(May 15 2020 at 13:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110025">Andrew Ashworth</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197688675">said</a>:</p>
<blockquote>
<p>if you feel ambitious: <a href="http://stanford.edu/~sadjad/gg-paper.pdf">http://stanford.edu/~sadjad/gg-paper.pdf</a></p>
</blockquote>
<p>Wow, I didn't know that was actually feasible to get really cheap stuff on AWS Lambda, my customers get insane bills for stupid workloads so I advise them to move back to 8/16-cores servers</p>



<a name="197689093"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197689093" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197689093">(May 15 2020 at 13:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197688727">said</a>:</p>
<blockquote>
<p>Is that reasonable stuff, or as ancient as I think it is?</p>
</blockquote>
<p>It's 2009 stuff I believe, it's not that bad, it's just old compared to EPYC 7501P which is 2017</p>



<a name="197689127"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197689127" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197689127">(May 15 2020 at 13:21)</a>:</h4>
<p>But I still build mathlib in 50 minutes: w00t!</p>



<a name="197689136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197689136" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197689136">(May 15 2020 at 13:21)</a>:</h4>
<p>But it could be we're not using well the newest hardware too :-)</p>



<a name="197689152"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197689152" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197689152">(May 15 2020 at 13:21)</a>:</h4>
<p>Or we won't benefit from newer hardware which could be also a conclusion</p>



<a name="197689193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197689193" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197689193">(May 15 2020 at 13:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197689127">said</a>:</p>
<blockquote>
<p>But I still build mathlib in 50 minutes: w00t!</p>
</blockquote>
<p>Used server hardware is awesome :-)</p>



<a name="197689736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197689736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197689736">(May 15 2020 at 13:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110025">Andrew Ashworth</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197688675">said</a>:</p>
<blockquote>
<p>if you feel ambitious: <a href="http://stanford.edu/~sadjad/gg-paper.pdf">http://stanford.edu/~sadjad/gg-paper.pdf</a></p>
</blockquote>
<p>Wow, this looks super neat (and knowing Keith Winstein, I assume it really is super neat) and probably fairly well-suited to theorem proving, too.</p>



<a name="197690867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197690867" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197690867">(May 15 2020 at 13:34)</a>:</h4>
<p>here's the latest master, for comparison</p>
<div class="codehilite"><pre><span></span><code><span class="err">$</span> <span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">time</span> <span class="n">leanpkg</span> <span class="n">build</span> <span class="mi">2</span><span class="bp">&gt;&amp;</span><span class="mi">1</span> <span class="bp">|</span> <span class="n">tee</span> <span class="n">build</span><span class="bp">.</span><span class="n">log</span>
<span class="n">configuring</span> <span class="n">mathlib</span> <span class="mi">0</span><span class="bp">.</span><span class="mi">1</span>
<span class="bp">&gt;</span> <span class="n">lean</span> <span class="c1">--make src</span>
<span class="mi">41010</span><span class="bp">.</span><span class="mi">11</span><span class="n">user</span> <span class="mi">69</span><span class="bp">.</span><span class="mi">07</span><span class="n">system</span> <span class="mi">42</span><span class="o">:</span><span class="mi">17</span><span class="bp">.</span><span class="mi">51</span><span class="n">elapsed</span> <span class="mi">1618</span><span class="err">%</span><span class="n">CPU</span> <span class="o">(</span><span class="mi">0</span><span class="n">avgtext</span><span class="bp">+</span><span class="mi">0</span><span class="n">avgdata</span> <span class="mi">12982540</span><span class="n">maxresident</span><span class="o">)</span><span class="n">k</span>
<span class="mi">29432</span><span class="n">inputs</span><span class="bp">+</span><span class="mi">169064</span><span class="n">outputs</span> <span class="o">(</span><span class="mi">0</span><span class="n">major</span><span class="bp">+</span><span class="mi">4857077</span><span class="n">minor</span><span class="o">)</span><span class="n">pagefaults</span> <span class="mi">0</span><span class="n">swaps</span>
</code></pre></div>



<a name="197690976"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197690976" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197690976">(May 15 2020 at 13:35)</a>:</h4>
<p>I'll start another round of builds now</p>



<a name="197692167"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197692167" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrew Ashworth <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197692167">(May 15 2020 at 13:41)</a>:</h4>
<p>Yeah, implementing that paper for a another project I contribute to has been on my TODO list for quite awhile. It takes ~5 hours to build and run all the integration tests, and I'm in love with the idea that maybe I could run it in 5 minutes by paying a few dollars. Of course, I never got around to it because adding a new build system to a project big enough to take 5 hours to build and test... one does not simply walk into Mordor.</p>



<a name="197693622"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197693622" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197693622">(May 15 2020 at 13:50)</a>:</h4>
<p>On a positive note... the witt vector file is now really responsive. And this used to crash and timeout like crazy with <code>lean-3.old</code></p>



<a name="197695101"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197695101" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197695101">(May 15 2020 at 14:01)</a>:</h4>
<p><span class="user-mention" data-user-id="110032">@Reid Barton</span> Could you run my <a href="#narrow/stream/113488-general/topic/Self-hosted.20Github.20runner/near/197597106">benchmark script</a> with a few thread counts (e.g. <code>1 2 4 8 16 32</code>)? That would give us some more comparable data for this particular (virtualised) processor.</p>



<a name="197695313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197695313" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197695313">(May 15 2020 at 14:02)</a>:</h4>
<p>Hmm, it looks like the 1-core build would take 10+ hours and I usually don't leave this machine on overnight.</p>



<a name="197696787"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197696787" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197696787">(May 15 2020 at 14:13)</a>:</h4>
<p>Fair enough. Any data you can get is good data. I'm particularly interested in 4/8/12/16/20 cores. My own experiments seem to indicate that anything above 8 is a waste of time; it would be very helpful if you could test this hypothesis.</p>



<a name="197697351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197697351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197697351">(May 15 2020 at 14:17)</a>:</h4>
<p>Yes, that sounds like a good thing to test.</p>



<a name="197710165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197710165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197710165">(May 15 2020 at 15:38)</a>:</h4>
<p>Regarding the <code>tidy</code> hate on this thread: I just looked at Scott's latest profiling results.  The total mathlib build time is 322 minutes.  Tidy only takes 14 minutes out of that (4.4%).</p>



<a name="197710852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197710852" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197710852">(May 15 2020 at 15:43)</a>:</h4>
<p>Here are the results from both sets of my runs. The numbers appear pretty stable, actually.</p>
<div class="codehilite"><pre><span></span><code>jan23/build.log:configuring mathlib 0.1
jan23/build.log:&gt; lean --make src
jan23/build.log:25449.26user 63.32system 24:14.20elapsed 1754%CPU (0avgtext+0avgdata 8817328maxresident)k
jan23/build.log:3240inputs+140592outputs (8major+8338993minor)pagefaults 0swaps
jan23/build2.log:configuring mathlib 0.1
jan23/build2.log:&gt; lean --make src
jan23/build2.log:25641.07user 55.08system 24:26.19elapsed 1752%CPU (0avgtext+0avgdata 8397940maxresident)k
jan23/build2.log:0inputs+140592outputs (0major+7927068minor)pagefaults 0swaps
apr8/build.log:configuring mathlib 0.1
apr8/build.log:&gt; lean --make src
apr8/build.log:33719.78user 55.97system 43:36.39elapsed 1290%CPU (0avgtext+0avgdata 10324836maxresident)k
apr8/build.log:0inputs+160088outputs (0major+3256318minor)pagefaults 0swaps
apr8/build2.log:configuring mathlib 0.1
apr8/build2.log:&gt; lean --make src
apr8/build2.log:33780.71user 51.32system 43:47.52elapsed 1287%CPU (0avgtext+0avgdata 10402992maxresident)k
apr8/build2.log:0inputs+160064outputs (0major+3603219minor)pagefaults 0swaps
master/build.log:configuring mathlib 0.1
master/build.log:&gt; lean --make src
master/build.log:41010.11user 69.07system 42:17.51elapsed 1618%CPU (0avgtext+0avgdata 12982540maxresident)k
master/build.log:29432inputs+169064outputs (0major+4857077minor)pagefaults 0swaps
master/build2.log:configuring mathlib 0.1
master/build2.log:&gt; lean --make src
master/build2.log:40334.56user 62.32system 42:33.54elapsed 1581%CPU (0avgtext+0avgdata 13151128maxresident)k
master/build2.log:0inputs+169032outputs (0major+4809347minor)pagefaults 0swaps
</code></pre></div>



<a name="197713144"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197713144" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197713144">(May 15 2020 at 16:00)</a>:</h4>
<p>(All the <code>build</code>s preceded all the <code>build2</code>s, so probably there wasn't some adversarial tenant on the same hardware who did work during just the <code>apr8</code> builds.)</p>



<a name="197713915"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197713915" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197713915">(May 15 2020 at 16:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110044">Chris Hughes</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197685649">said</a>:</p>
<blockquote>
<p>If I type <code>import analyis.complex.polynomial</code> and wait for the yellow bars to disappear, then it takes 3 seconds on lean 3.4.2, and 22 seconds on lean 3.11.0 with a full set of oleans. Lean seems to have got slower, I doubt it's mathlib getting slower that fast.</p>
</blockquote>
<p>I think I can reproduce this (I'll let you know when 3.11.0 finishes importing the file)</p>



<a name="197714050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197714050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197714050">(May 15 2020 at 16:06)</a>:</h4>
<p>okay, the difference is not that drastic for me over the versions I have, but still substantial: ~4.5 s / ~8s / ~14.5s for the three versions above</p>



<a name="197714564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197714564" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197714564">(May 15 2020 at 16:10)</a>:</h4>
<p>I tried using <code>lean --export</code> on a file with just this import as a proxy for the size of the part of mathlib reachable from that module, and it increased by less than 20% over that range.</p>



<a name="197714742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197714742" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197714742">(May 15 2020 at 16:12)</a>:</h4>
<p>What work does Lean have to do when importing a module? Also, is that work saved when importing the same module twice during the same <code>lean --make</code> session?</p>



<a name="197714780"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197714780" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197714780">(May 15 2020 at 16:12)</a>:</h4>
<p>Mostly typechecking the contents of the olean files, right? I assume that deserializing them and updating the environment is fast?</p>



<a name="197715082"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197715082" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197715082">(May 15 2020 at 16:15)</a>:</h4>
<p>Is it possible more dependencies were added to <code>analysis.complex.polynomial</code> between these versions? A rough proxy for this is the number of declarations in the environment. <code>run_cmd do e ← tactic.get_env, tactic.trace $ e.fold 0 $ λ _, nat.succ</code></p>



<a name="197715527"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197715527" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197715527">(May 15 2020 at 16:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197714742">said</a>:</p>
<blockquote>
<p>Also, is that work saved when importing the same module twice during the same <code>lean --make</code> session?</p>
</blockquote>
<p>Apparently not! My setup:<br>
<code>tmp.lean</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">analysis</span><span class="bp">.</span><span class="n">complex</span><span class="bp">.</span><span class="n">polynomial</span>
</code></pre></div>


<p><code>tmp2.lean</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="bp">.</span><span class="n">tmp</span>
</code></pre></div>


<p><code>lean --make tmp.lean</code> takes ~15s. Subsequent <code>lean --make tmp2.lean</code> takes ~15s. Removing oleans and a direct <code>lean --make tmp2.lean</code> takes ~30s!</p>



<a name="197715845"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197715845" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197715845">(May 15 2020 at 16:21)</a>:</h4>
<p>In Lean 3.4.2/mathlib jan23 each individual file takes ~4.75s while together they take ~6.75s--not sure what to make of that.</p>



<a name="197716000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197716000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197716000">(May 15 2020 at 16:22)</a>:</h4>
<p>Lean 3.7.2/mathlib apr8 is similar: each file takes ~8s with both taking ~12s</p>



<a name="197716448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197716448" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197716448">(May 15 2020 at 16:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110596">Rob Lewis</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197715082">said</a>:</p>
<blockquote>
<p><code>run_cmd do e ← tactic.get_env, tactic.trace $ e.fold 0 $ λ _, nat.succ</code></p>
</blockquote>
<p>49084 / 52933 / 55112. This is also similar to what I was trying to measure with <code>lean --export</code> (though that one also takes into account the sizes of expressions).</p>



<a name="197716861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197716861" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197716861">(May 15 2020 at 16:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197715527">said</a>:</p>
<blockquote>
<p><code>lean --make tmp.lean</code> takes ~15s. Subsequent <code>lean --make tmp2.lean</code> takes ~15s. Removing oleans and a direct <code>lean --make tmp2.lean</code> takes ~30s!</p>
</blockquote>
<p>This sounds like something that can be fixed <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span> And it might save us some seconds (-;</p>



<a name="197716872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197716872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197716872">(May 15 2020 at 16:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110596">Rob Lewis</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197715082">said</a>:</p>
<blockquote>
<p>Is it possible more dependencies were added to <code>analysis.complex.polynomial</code> between these versions? A rough proxy for this is the number of declarations in the environment. <code>run_cmd do e ← tactic.get_env, tactic.trace $ e.fold 0 $ λ _, nat.succ</code></p>
</blockquote>
<p>I did the same test for <code>computability.halting</code> and got 1 second for 3.4.2, 5 seconds for 3.5.1 and 6 seconds for 3.11.0 I don't think this part of the library has changed that much. It doesn't import much apart from the rest of the computability code.</p>



<a name="197718452"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197718452" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197718452">(May 15 2020 at 16:37)</a>:</h4>
<p>Based on the perf report it really seems to be building the environment that takes most of the time</p>



<a name="197720463"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197720463" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197720463">(May 15 2020 at 16:52)</a>:</h4>
<p>Is there no convenient way to do some basic accounting of calls to malloc?</p>



<a name="197722022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197722022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197722022">(May 15 2020 at 17:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197714742">said</a>:</p>
<blockquote>
<p>What work does Lean have to do when importing a module? Also, is that work saved when importing the same module twice during the same <code>lean --make</code> session?</p>
</blockquote>
<p>Two main things: deserializing the olean files into in-memory data structures (this results in a list of "modifications"), and then applying these modifications in order to produce the environment.  No type checking happens here.  But just all the inserting takes quite a bit of time.</p>



<a name="197722938"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197722938" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197722938">(May 15 2020 at 17:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197722022">said</a>:</p>
<blockquote>
<p>But just all the inserting takes quite a bit of time.</p>
</blockquote>
<p>Yes, I'm seeing that. Do you have a better idea for understanding what changed than modifying these three different versions of Lean to add some profiling output?</p>



<a name="197723499"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197723499" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197723499">(May 15 2020 at 17:15)</a>:</h4>
<p>Is there an easy way to figure out the dependencies?  It would be interesting to see if the olean file size changed.</p>



<a name="197723645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197723645" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197723645">(May 15 2020 at 17:16)</a>:</h4>
<p>The line count of <code>lean --export</code> went up by about 20%</p>



<a name="197723681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197723681" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197723681">(May 15 2020 at 17:17)</a>:</h4>
<p>which as I understand it is essentially the total size of the environment (okay, not including some stuff like attributes maybe?)</p>



<a name="197723788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197723788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197723788">(May 15 2020 at 17:18)</a>:</h4>
<p>Did I read your numbers correctly?  This is the time taken by a file containing just <code>import analysis.complex.polynomial</code>:</p>
<table>
<thead>
<tr>
<th></th>
<th>3.4.2</th>
<th>3.7.2</th>
<th>3.11.0</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>Jan 23</td>
<td>Apr 8</td>
<td>Today</td>
</tr>
<tr>
<td></td>
<td>4.75s</td>
<td>8s</td>
<td>15s</td>
</tr>
</tbody>
</table>



<a name="197723887"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197723887" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197723887">(May 15 2020 at 17:19)</a>:</h4>
<p>| 3.4.2 | 3.7.2 | 3.11.0 |</p>



<a name="197724276"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197724276" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197724276">(May 15 2020 at 17:22)</a>:</h4>
<p>Ooh pretty</p>



<a name="197724302"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197724302" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197724302">(May 15 2020 at 17:22)</a>:</h4>
<p>And it took me just 5 minutes to get the markdown right...</p>



<a name="197724406"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197724406" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197724406">(May 15 2020 at 17:23)</a>:</h4>
<blockquote>
<p>not including some stuff like attributes maybe</p>
</blockquote>
<p>Attributes are a possible explanation, that's why I'm curious.</p>



<a name="197725308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197725308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197725308">(May 15 2020 at 17:30)</a>:</h4>
<p>TIL about <code>openat</code></p>



<a name="197725547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197725547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197725547">(May 15 2020 at 17:32)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ tail -n 1 {jan23,apr8,master}/wc.log
==&gt; jan23/wc.log &lt;==
  156411   602930 43606276 total

==&gt; apr8/wc.log &lt;==
  196482   723773 48700194 total

==&gt; master/wc.log &lt;==
  191842   780908 48442515 total
</code></pre></div>


<p>produced by <code>strace -o strace.log -e trace=openat ~/.elan/toolchains/leanprover-community-lean-3.11.0/bin/lean tmp.lean</code> (or <code>open</code> for previous versions) followed by<br>
<code>wc $(grep ^open strace.log | grep -v ENOENT | cut -d '"' -f 2 | grep '.olean$' | sort | uniq) | tee wc.log</code></p>



<a name="197725883"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197725883" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197725883">(May 15 2020 at 17:35)</a>:</h4>
<p>The part between 3.7.2 and 3.11.0 is worrying.  That's just one month.  I see just one thing that could have an effect on import times: namely string literals in the VM (3.9.0).  This should actually reduce olean size and improve import speed, but who knows.</p>



<a name="197726015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197726015" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197726015">(May 15 2020 at 17:36)</a>:</h4>
<p>I guess I could try bisecting but I'm worried I might just get some numbers between 8 and 15</p>



<a name="197726092"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197726092" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197726092">(May 15 2020 at 17:36)</a>:</h4>
<p>So the olean size stayed the same between 3.7.2 and 3.11.0, but importing now takes twice as long?</p>



<a name="197726135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197726135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197726135">(May 15 2020 at 17:36)</a>:</h4>
<p>So it seems!</p>



<a name="197726172"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197726172" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197726172">(May 15 2020 at 17:37)</a>:</h4>
<p>Do you want to see some <code>perf report</code> output?</p>



<a name="197726186"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197726186" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197726186">(May 15 2020 at 17:37)</a>:</h4>
<p>It's probably not that illuminating beyond what you already know...</p>



<a name="197726200"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197726200" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197726200">(May 15 2020 at 17:37)</a>:</h4>
<p>Please.</p>



<a name="197726280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197726280" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197726280">(May 15 2020 at 17:38)</a>:</h4>
<p>I want to pass it to <code>nvim -d</code>.</p>



<a name="197726529"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197726529" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197726529">(May 15 2020 at 17:40)</a>:</h4>
<p>This is super low tech, but <a href="https://gist.github.com/rwbarton/bebc2b4c48f03feda09664167fc48b0d">https://gist.github.com/rwbarton/bebc2b4c48f03feda09664167fc48b0d</a></p>



<a name="197726632"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197726632" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197726632">(May 15 2020 at 17:41)</a>:</h4>
<p>Hmm, the appearance of <code>memcpy</code> is intriguing</p>



<a name="197727343"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197727343" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197727343">(May 15 2020 at 17:46)</a>:</h4>
<p><code>module_ext::~module_ext</code> is also new.  Did we get new docstrings in the last month?</p>



<a name="197727764"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197727764" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197727764">(May 15 2020 at 17:49)</a>:</h4>
<p>I added the module <code>init.meta.case_tag</code> with a docstring.</p>



<a name="197727781"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197727781" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197727781">(May 15 2020 at 17:49)</a>:</h4>
<p>Surely there are some, e.g., <a href="https://github.com/leanprover-community/mathlib/commit/9f33b7dd6d4beee9f89c815b21e31cafacd3b8c3#diff-7060ca01fd0d49ccfb27ecb48f8fe0f6L9">https://github.com/leanprover-community/mathlib/commit/9f33b7dd6d4beee9f89c815b21e31cafacd3b8c3#diff-7060ca01fd0d49ccfb27ecb48f8fe0f6L9</a></p>



<a name="197727790"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197727790" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197727790">(May 15 2020 at 17:49)</a>:</h4>
<p>Are docstrings slow??</p>



<a name="197727993"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197727993" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197727993">(May 15 2020 at 17:50)</a>:</h4>
<p>That's one thing that has vastly increased in the last couple of months...</p>



<a name="197728636"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197728636" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197728636">(May 15 2020 at 17:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197727790">said</a>:</p>
<blockquote>
<p>Are docstrings slow??</p>
</blockquote>
<p>A docstring is about as slow as a declaration.</p>



<a name="197728922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197728922" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197728922">(May 15 2020 at 17:57)</a>:</h4>
<p>But module doc strings might be much slower.  Did we get new module doc strings?</p>



<a name="197728946"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197728946" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197728946">(May 15 2020 at 17:57)</a>:</h4>
<p>Yes, I linked one above for example</p>



<a name="197728966"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197728966" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197728966">(May 15 2020 at 17:57)</a>:</h4>
<p>I don't know whether we got many of them though</p>



<a name="197729150"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729150" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729150">(May 15 2020 at 17:58)</a>:</h4>
<p>I have a theory.</p>



<a name="197729217"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729217" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729217">(May 15 2020 at 17:59)</a>:</h4>
<p>Also, I see about a 1.5x difference between apr8 and master with Chris's second suggestion <code>computability.halting</code>, which relies on a lot less of mathlib, so it would be a lot easier to bisect with that one</p>



<a name="197729465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729465" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729465">(May 15 2020 at 18:00)</a>:</h4>
<p>Do you see what is wrong with the following definition:</p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span> <span class="nl">module_ext</span> <span class="p">:</span> <span class="k">public</span> <span class="n">environment_extension</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">module_name</span><span class="o">&gt;</span> <span class="n">m_direct_imports</span><span class="p">;</span>
    <span class="n">list</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">modification</span> <span class="k">const</span><span class="o">&gt;&gt;</span> <span class="n">m_modifications</span><span class="p">;</span>
    <span class="n">list</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span>        <span class="n">m_module_univs</span><span class="p">;</span>
    <span class="n">list</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span>        <span class="n">m_module_decls</span><span class="p">;</span>
    <span class="n">name_set</span>          <span class="n">m_module_defs</span><span class="p">;</span>
    <span class="n">name_set</span>          <span class="n">m_imported</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">pos_info</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&gt;&gt;</span> <span class="n">m_module_docs</span><span class="p">;</span>
    <span class="n">name_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span>     <span class="n">m_decl2olean</span><span class="p">;</span>
    <span class="n">name_map</span><span class="o">&lt;</span><span class="n">pos_info</span><span class="o">&gt;</span>        <span class="n">m_decl2pos_info</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>



<a name="197729519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729519">(May 15 2020 at 18:01)</a>:</h4>
<p>It's in C++?</p>



<a name="197729607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729607" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729607">(May 15 2020 at 18:02)</a>:</h4>
<p>What happens when you copy this structure?</p>



<a name="197729657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729657">(May 15 2020 at 18:02)</a>:</h4>
<p>No idea (see above)</p>



<a name="197729661"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729661" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729661">(May 15 2020 at 18:02)</a>:</h4>
<p>modifications are shared?</p>



<a name="197729664"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729664" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729664">(May 15 2020 at 18:02)</a>:</h4>
<p>The field <code>m_module_docs</code> is copied as well, including all module docs.</p>



<a name="197729702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729702" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729702">(May 15 2020 at 18:02)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> No that's good.  That's what we should do with the module docs as well.</p>



<a name="197729733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729733" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729733">(May 15 2020 at 18:02)</a>:</h4>
<p>when does this get copied?</p>



<a name="197729823"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729823" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729823">(May 15 2020 at 18:03)</a>:</h4>
<p>what is the string key of the module doc map?</p>



<a name="197729846"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729846" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729846">(May 15 2020 at 18:03)</a>:</h4>
<p>why isn't it a name key?</p>



<a name="197729971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197729971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197729971">(May 15 2020 at 18:04)</a>:</h4>
<p>The key is the module file name, I removed the comment that explains this.  Lean doesn't know about <code>data.nat</code> when it imports something, it only knows the filename.</p>



<a name="197730062"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730062" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730062">(May 15 2020 at 18:05)</a>:</h4>
<p>It gets copied every time you insert a module doc string, or update any of the other fields.  Every declaration updates the <code>m_decl2pos_info</code> field...</p>



<a name="197730194"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730194" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730194">(May 15 2020 at 18:06)</a>:</h4>
<p>is that because this is the <code>environment</code> object that is functionally updated?</p>



<a name="197730232"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730232" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730232">(May 15 2020 at 18:06)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="197730245"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730245" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730245">(May 15 2020 at 18:06)</a>:</h4>
<p>I thought there would be a lot more sharing than this</p>



<a name="197730298"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730298" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730298">(May 15 2020 at 18:06)</a>:</h4>
<p>this looks more appropriate for a "baked" environment object, once the file is complete</p>



<a name="197730350"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730350" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730350">(May 15 2020 at 18:07)</a>:</h4>
<p>but maybe there isn't any such concept in the C++</p>



<a name="197730353"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730353" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730353">(May 15 2020 at 18:07)</a>:</h4>
<p><code>vector</code> is a reference, not sure about any of the others</p>



<a name="197730378"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730378" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730378">(May 15 2020 at 18:07)</a>:</h4>
<p>wait is it? I don't even know</p>



<a name="197730394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730394" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730394">(May 15 2020 at 18:07)</a>:</h4>
<p>I think it's just owned data</p>



<a name="197730497"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730497" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730497">(May 15 2020 at 18:08)</a>:</h4>
<p>I don't know if the <code>name_set</code>s can be functionally shared</p>



<a name="197730844"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197730844" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197730844">(May 15 2020 at 18:11)</a>:</h4>
<p><code>std::vector</code> and <code>std::unordered_map</code> are owned.  The <code>name_set</code> is fine.</p>



<a name="197731201"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197731201" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197731201">(May 15 2020 at 18:14)</a>:</h4>
<p>How about</p>
<div class="codehilite"><pre><span></span><code><span class="n">persistent_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">pos_info</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&gt;&gt;</span> <span class="n">m_module_docs</span><span class="p">;</span>
</code></pre></div>


<p>then? Not sure what the C++-ism for <code>persistent_map</code> is</p>



<a name="197731267"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197731267" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197731267">(May 15 2020 at 18:15)</a>:</h4>
<p>It would be better if the map contained <code>vector</code> for all files other than the current one and a <code>list</code> for the current file</p>



<a name="197731274"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197731274" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197731274">(May 15 2020 at 18:15)</a>:</h4>
<p>We typically use <code>rb_map</code>.  I'll try to code something up in the next few minutes.</p>



<a name="197731921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197731921" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197731921">(May 15 2020 at 18:20)</a>:</h4>
<p>Is there a specific Lean version bump that it would be useful to benchmark both sides of?</p>



<a name="197732632"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197732632" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197732632">(May 15 2020 at 18:25)</a>:</h4>
<p>Give me a few seconds, then you can benchmark a PR.</p>



<a name="197733396"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197733396" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197733396">(May 15 2020 at 18:31)</a>:</h4>
<p><span class="user-mention" data-user-id="110032">@Reid Barton</span>  <a href="https://github.com/leanprover-community/lean/issues/241">lean#241</a></p>



<a name="197733451"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197733451" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197733451">(May 15 2020 at 18:31)</a>:</h4>
<p>It's on 3.12, will mathlib already build with that? I ignored that discussion</p>



<a name="197733593"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197733593" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197733593">(May 15 2020 at 18:33)</a>:</h4>
<p>alternatively, should it apply to 3.11?</p>



<a name="197733613"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197733613" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197733613">(May 15 2020 at 18:33)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/2681">#2681</a></p>



<a name="197733626"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197733626" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197733626">(May 15 2020 at 18:33)</a>:</h4>
<p>It should also apply to 3.11</p>



<a name="197733658"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197733658" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197733658">(May 15 2020 at 18:33)</a>:</h4>
<p>maybe for benchmarking purposes it is better for me to build it on 3.11 then</p>



<a name="197734553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197734553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197734553">(May 15 2020 at 18:40)</a>:</h4>
<p>Apparently I'm building with some version of g++ that produces a <em>heck</em> of a lot of warnings on the Lean code base</p>



<a name="197737949"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197737949" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197737949">(May 15 2020 at 19:05)</a>:</h4>
<p>oh, I guess I didn't have to go and build all of mathlib, but that's what I'm doing apparently.</p>



<a name="197741550"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197741550" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197741550">(May 15 2020 at 19:23)</a>:</h4>
<div class="codehilite"><pre><span></span><code>39417.19user 56.41system 35:53.47elapsed 1833%CPU (0avgtext+0avgdata 12875252maxresident)k
8inputs+169048outputs (0major+3965789minor)pagefaults 0swaps
</code></pre></div>



<a name="197741613"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197741613" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197741613">(May 15 2020 at 19:24)</a>:</h4>
<p>down from 42:17.51elapsed ... <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="197741675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197741675" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197741675">(May 15 2020 at 19:24)</a>:</h4>
<p>That's a 1/6 improvement!</p>



<a name="197741789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197741789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197741789">(May 15 2020 at 19:25)</a>:</h4>
<p>import <code>analysis.complex.polynomial</code> is down to 6 seconds, which is more or less in line with mathlib growth</p>



<a name="197741974"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197741974" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197741974">(May 15 2020 at 19:27)</a>:</h4>
<p>Does this also include the <code>simp</code> improvements? Or is it only the module-doc fix?</p>



<a name="197742054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197742054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197742054">(May 15 2020 at 19:27)</a>:</h4>
<p>Since you've already compiled mathlib, could you check something for me?  Does <code>module_doc_strings</code> still return the doc strings in the same order.  (Go to some file with multiple module doc strings like <code>data.set.intervals.basic</code> and call the function at the end of the file.)</p>



<a name="197742122"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197742122" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197742122">(May 15 2020 at 19:28)</a>:</h4>
<p>that is just <a href="https://github.com/leanprover-community/lean/issues/241">lean#241</a> cherry-picked to 3.11.0</p>



<a name="197742190"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197742190" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197742190">(May 15 2020 at 19:28)</a>:</h4>
<p>So that's maybe another 25%?  3.13 is going to be a nice release.</p>



<a name="197742233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197742233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197742233">(May 15 2020 at 19:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197742054">said</a>:</p>
<blockquote>
<p>Since you've already compiled mathlib, could you check something for me?  Does <code>module_doc_strings</code> still return the doc strings in the same order.  (Go to some file with multiple module doc strings like <code>data.set.intervals.basic</code> and call the function at the end of the file.)</p>
</blockquote>
<p>How do I call it?</p>



<a name="197742287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197742287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197742287">(May 15 2020 at 19:29)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="bp">#</span><span class="kn">eval</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">module_doc_strings</span> <span class="bp">&gt;&gt;=</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">trace</span>
</code></pre></div>



<a name="197742521"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197742521" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197742521">(May 15 2020 at 19:31)</a>:</h4>
<p>Yes, same output</p>



<a name="197742570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197742570" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197742570">(May 15 2020 at 19:32)</a>:</h4>
<p>Great!</p>



<a name="197750627"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197750627" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197750627">(May 15 2020 at 20:49)</a>:</h4>
<p>I guess the thing to do now is to try to build <a href="https://github.com/leanprover-community/lean/issues/241">lean#241</a> with <a href="https://github.com/leanprover-community/mathlib/issues/2681">#2681</a></p>



<a name="197750631"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197750631" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197750631">(May 15 2020 at 20:49)</a>:</h4>
<p>or vice versa I suppose</p>



<a name="197752012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197752012" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197752012">(May 15 2020 at 21:03)</a>:</h4>
<p>oh, the other speedups are in 3.13 but the recent pr is only for 3.12, I see</p>



<a name="197752159"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197752159" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197752159">(May 15 2020 at 21:04)</a>:</h4>
<p>Wow, 3.13 is really going to be very nice</p>



<a name="197757662"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197757662" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197757662">(May 15 2020 at 22:04)</a>:</h4>
<p>Yeah, no major change in speed for the 3.12 PR.</p>



<a name="197771307"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197771307" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197771307">(May 16 2020 at 02:19)</a>:</h4>
<p>Well done, <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> and <span class="user-mention" data-user-id="110032">@Reid Barton</span>! It's fantastic we've caught and fixed this.</p>



<a name="197771359"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197771359" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197771359">(May 16 2020 at 02:20)</a>:</h4>
<p>I didn't follow the analysis of what had gone wrong in the C++, but it sounds like we were doing something accidentally quadratic (in the number of docstrings)?</p>



<a name="197776249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197776249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197776249">(May 16 2020 at 04:28)</a>:</h4>
<p>When I build current lean master I get the following warning:</p>
<div class="codehilite"><pre><span></span><code>                 from /path/lean/src/util/sexpr/option_declarations.h:11,
                 from /path/lean/src/library/equations_compiler/elim_match.cpp:9:
/path/lean/src/util/name.h: In member function ‘lean::list&lt;lean::elim_match_fn::lemma&gt; lean::elim_match_fn::process(const lean::elim_match_fn::problem&amp;)’:
/path/lean/src/util/name.h:87:40: warning: ‘*((void*)(&amp; fn_name)+8).lean::name::m_ptr’ may be used uninitialized in this function [-Wmaybe-uninitialized]
   87 |     ~name() { if (m_ptr) m_ptr-&gt;dec_ref(); }
      |                          ~~~~~~~~~~~~~~^~
/path/lean/src/library/equations_compiler/elim_match.cpp:520:24: note: ‘*((void*)(&amp; fn_name)+8).lean::name::m_ptr’ was declared here
  520 |         optional&lt;name&gt; fn_name;
      |                        ^~~~~~~
</code></pre></div>


<p>Is this anything I should worry about?</p>



<a name="197777694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197777694" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197777694">(May 16 2020 at 05:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/113488-general/topic/speed-up.20project.20returns/near/197776249">said</a>:</p>
<blockquote>
<p>When I build current lean master I get the following warning:</p>
<div class="codehilite"><pre><span></span><code>                 from /path/lean/src/util/sexpr/option_declarations.h:11,
                 from /path/lean/src/library/equations_compiler/elim_match.cpp:9:
/path/lean/src/util/name.h: In member function ‘lean::list&lt;lean::elim_match_fn::lemma&gt; lean::elim_match_fn::process(const lean::elim_match_fn::problem&amp;)’:
/path/lean/src/util/name.h:87:40: warning: ‘*((void*)(&amp; fn_name)+8).lean::name::m_ptr’ may be used uninitialized in this function [-Wmaybe-uninitialized]
   87 |     ~name() { if (m_ptr) m_ptr-&gt;dec_ref(); }
      |                          ~~~~~~~~~~~~~~^~
/path/lean/src/library/equations_compiler/elim_match.cpp:520:24: note: ‘*((void*)(&amp; fn_name)+8).lean::name::m_ptr’ was declared here
  520 |         optional&lt;name&gt; fn_name;
      |                        ^~~~~~~
</code></pre></div>


<p>Is this anything I should worry about?</p>
</blockquote>
<p>If <code>m_ptr</code> has a garbage value, you might get a null pointer dereferencing at destruction time, that could create a segfault during lifetime of the program, but maybe the compiler is drunk, I didn't read the code</p>



<a name="197862877"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197862877" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197862877">(May 17 2020 at 18:36)</a>:</h4>
<p>So, uh, I just built master and <a href="https://github.com/leanprover-community/mathlib/issues/2697">#2697</a> on my laptop. Very non-scientific comparison: <strong>50%</strong> realtime speedup. That's so big I almost don't believe this was a clean test.</p>



<a name="197863055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197863055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197863055">(May 17 2020 at 18:40)</a>:</h4>
<p>Hooray! Thanks <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> and <span class="user-mention" data-user-id="112680">@Johan Commelin</span>!</p>



<a name="197863784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197863784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197863784">(May 17 2020 at 18:58)</a>:</h4>
<p>I guess it was clean: here's a 56 min Actions build! <a href="https://github.com/leanprover-community/mathlib/runs/683136036">https://github.com/leanprover-community/mathlib/runs/683136036</a></p>



<a name="197863856"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197863856" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197863856">(May 17 2020 at 19:00)</a>:</h4>
<p>Now the linting takes almost as long as the build...</p>



<a name="197864886"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/speed-up%20project%20returns/near/197864886" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/speed-up.20project.20returns.html#197864886">(May 17 2020 at 19:24)</a>:</h4>
<p>And these 56 minutes are with 3000 lines more added by <a href="https://github.com/leanprover-community/mathlib/issues/2697">#2697</a>, i.e., all the algebra that was originally in core!</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>