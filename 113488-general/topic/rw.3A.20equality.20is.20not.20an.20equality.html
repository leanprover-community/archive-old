---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html">rw: equality is not an equality</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="196692155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692155" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692155">(May 06 2020 at 20:25)</a>:</h4>
<p>I've never seen anything like this before. <code>rw h2</code> on line 26 fails because it claims <code>h2</code> is not an equality. But it is, and <code>rw h2.symm.symm</code> works fine. What's going on?</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">fibZ</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℤ</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="bp">|</span> <span class="mi">1</span> <span class="o">:=</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:=</span> <span class="n">fibZ</span> <span class="n">n</span> <span class="bp">+</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">fibZ_0</span> <span class="o">:</span> <span class="n">fibZ</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">fibZ_1</span> <span class="o">:</span> <span class="n">fibZ</span> <span class="mi">1</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">fibZ_succ_succ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">=</span> <span class="n">fibZ</span> <span class="n">n</span> <span class="bp">+</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">lemma</span> <span class="n">induction2</span> <span class="o">(</span><span class="n">P</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h0</span> <span class="o">:</span> <span class="n">P</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="n">P</span> <span class="mi">1</span><span class="o">)</span>
  <span class="o">(</span><span class="n">hind</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">d</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span> <span class="n">P</span> <span class="n">d</span> <span class="bp">→</span> <span class="n">P</span><span class="o">(</span><span class="n">d</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="bp">→</span> <span class="n">P</span><span class="o">(</span><span class="n">d</span><span class="bp">+</span><span class="mi">2</span><span class="o">))</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span> <span class="n">P</span> <span class="n">n</span> <span class="o">:=</span> <span class="n">sorry</span>

<span class="kn">lemma</span> <span class="n">fibZ_m_n</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">fibZ</span><span class="o">(</span><span class="n">m</span><span class="bp">+</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span><span class="bp">=</span><span class="n">fibZ</span><span class="o">(</span><span class="n">m</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span><span class="bp">*</span><span class="n">fibZ</span><span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span><span class="bp">+</span><span class="n">fibZ</span><span class="o">(</span><span class="n">m</span><span class="o">)</span><span class="bp">*</span><span class="n">fibZ</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">induction2</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">n</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">simp</span><span class="o">},</span>
  <span class="o">{</span> <span class="k">show</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">=</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">*</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">fibZ</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">1</span> <span class="o">,</span>
    <span class="n">rw</span> <span class="n">fibZ_succ_succ</span><span class="o">,</span>
    <span class="n">simp</span> <span class="o">[</span><span class="n">add_comm</span><span class="o">]},</span>
  <span class="o">{</span> <span class="c1">-- inductive step</span>
    <span class="n">intros</span> <span class="n">d</span> <span class="n">h1</span> <span class="n">h2</span><span class="o">,</span>
    <span class="k">show</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="o">(</span><span class="n">d</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">=</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">*</span> <span class="n">fibZ</span> <span class="o">((</span><span class="n">d</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">+</span> <span class="n">fibZ</span> <span class="n">m</span> <span class="bp">*</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">d</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">),</span>
    <span class="n">rw</span> <span class="n">fibZ_succ_succ</span> <span class="n">d</span><span class="o">,</span>
    <span class="n">rw</span> <span class="n">fibZ_succ_succ</span> <span class="o">(</span><span class="n">d</span><span class="bp">+</span><span class="mi">1</span><span class="o">),</span>
    <span class="n">rw</span> <span class="n">fibZ_succ_succ</span> <span class="o">(</span><span class="n">m</span><span class="bp">+</span><span class="o">(</span><span class="n">d</span><span class="bp">+</span><span class="mi">1</span><span class="o">)),</span>
  <span class="c1">--  rw h2, -- &quot;lemma is not an equality or iff&quot;    &lt;---- is this a bug?</span>
    <span class="n">rw</span> <span class="n">h2</span><span class="bp">.</span><span class="n">symm</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span> <span class="c1">-- works fine</span>
    <span class="n">rw</span> <span class="o">[</span><span class="err">←</span><span class="n">add_assoc</span> <span class="n">m</span><span class="o">],</span>
    <span class="n">rw</span> <span class="n">h1</span><span class="bp">.</span><span class="n">symm</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
    <span class="n">simp</span> <span class="o">[</span><span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_comm</span><span class="o">,</span> <span class="n">add_comm</span><span class="o">,</span> <span class="n">add_assoc</span><span class="o">,</span> <span class="n">mul_assoc</span><span class="o">],</span>
    <span class="n">ac_refl</span><span class="o">,</span>
  <span class="o">}</span>
<span class="kn">end</span>
</code></pre></div>



<a name="196692251"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692251" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692251">(May 06 2020 at 20:26)</a>:</h4>
<p>it's probably an instantiated metavariable</p>



<a name="196692274"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692274" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692274">(May 06 2020 at 20:26)</a>:</h4>
<p>you mean a variable?</p>



<a name="196692310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692310">(May 06 2020 at 20:26)</a>:</h4>
<p>no</p>



<a name="196692329"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692329" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692329">(May 06 2020 at 20:26)</a>:</h4>
<p>oh</p>



<a name="196692365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692365">(May 06 2020 at 20:26)</a>:</h4>
<p>It has type <code>h2 : ?m</code> where <code>?m := a = b</code> or somesuch</p>



<a name="196692390"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692390" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692390">(May 06 2020 at 20:27)</a>:</h4>
<p>how do I test for this?</p>



<a name="196692424"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692424" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692424">(May 06 2020 at 20:27)</a>:</h4>
<p>this is pretty printed as <code>h2 : a = b</code> but <code>rw</code> is fussy about it in this particular case</p>



<a name="196692478"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692478" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692478">(May 06 2020 at 20:27)</a>:</h4>
<p>but pp.all doesn't show it me, right?</p>



<a name="196692560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692560">(May 06 2020 at 20:28)</a>:</h4>
<p><code>simp at h2</code> before the rewrite fixes it</p>



<a name="196692598"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692598" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692598">(May 06 2020 at 20:28)</a>:</h4>
<p>So did I write bad code to get this situation?</p>



<a name="196692661"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692661" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692661">(May 06 2020 at 20:29)</a>:</h4>
<p>my code looks really innocuous and fine</p>



<a name="196692898"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196692898" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196692898">(May 06 2020 at 20:31)</a>:</h4>
<p>if I change <code>apply induction2 _ _ _ _ n</code> to <code>refine induction2 _ _ _ _ n</code> the problem goes away</p>



<a name="196693133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196693133" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196693133">(May 06 2020 at 20:32)</a>:</h4>
<p>What is an instantiated metavariable?</p>



<a name="196693213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196693213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196693213">(May 06 2020 at 20:33)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">lemma</span> <span class="n">fibZ_m_n</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">fibZ</span><span class="o">(</span><span class="n">m</span><span class="bp">+</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span><span class="bp">=</span><span class="n">fibZ</span><span class="o">(</span><span class="n">m</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span><span class="bp">*</span><span class="n">fibZ</span><span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span><span class="bp">+</span><span class="n">fibZ</span><span class="o">(</span><span class="n">m</span><span class="o">)</span><span class="bp">*</span><span class="n">fibZ</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">induction2</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">n</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">simp</span><span class="o">},</span>
  <span class="o">{</span> <span class="k">show</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">=</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">*</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">fibZ</span> <span class="n">m</span> <span class="bp">*</span> <span class="mi">1</span> <span class="o">,</span>
    <span class="n">rw</span> <span class="n">fibZ_succ_succ</span><span class="o">,</span>
    <span class="n">simp</span> <span class="o">[</span><span class="n">add_comm</span><span class="o">]},</span>
  <span class="o">{</span> <span class="c1">-- inductive step</span>
    <span class="n">intros</span> <span class="n">d</span> <span class="n">h1</span> <span class="n">h2</span><span class="o">,</span>
    <span class="k">show</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="o">(</span><span class="n">d</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">=</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">*</span> <span class="n">fibZ</span> <span class="o">((</span><span class="n">d</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">+</span> <span class="n">fibZ</span> <span class="n">m</span> <span class="bp">*</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">d</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">),</span>
    <span class="n">rw</span> <span class="n">fibZ_succ_succ</span> <span class="n">d</span><span class="o">,</span>
    <span class="n">rw</span> <span class="n">fibZ_succ_succ</span> <span class="o">(</span><span class="n">d</span><span class="bp">+</span><span class="mi">1</span><span class="o">),</span>
    <span class="n">rw</span> <span class="n">fibZ_succ_succ</span> <span class="o">(</span><span class="n">m</span><span class="bp">+</span><span class="o">(</span><span class="n">d</span><span class="bp">+</span><span class="mi">1</span><span class="o">)),</span>
    <span class="o">(</span><span class="n">do</span> <span class="n">t</span> <span class="err">←</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">to_expr</span><span class="bp">```</span><span class="o">(</span><span class="n">h2</span><span class="o">)</span> <span class="bp">&gt;&gt;=</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">infer_type</span><span class="o">,</span>
      <span class="c1">-- t ← tactic.instantiate_mvars t, -- uncomment this line</span>
      <span class="n">tactic</span><span class="bp">.</span><span class="n">trace</span> <span class="o">(</span><span class="n">expr</span><span class="bp">.</span><span class="n">to_raw_fmt</span> <span class="n">t</span><span class="o">)</span>
      <span class="c1">-- (app (mvar _mlocal._fresh.378.4796 _mlocal._fresh.378.4796 (const 2 []))</span>
      <span class="c1">--   (app (app (app (app (const has_add.add [0]) (const nat [])) (const nat.has_add []))</span>
      <span class="c1">--   (local_const 0._fresh.378.6836 d (const 1 []))) (app (app (const has_one.one [0])</span>
      <span class="c1">--   (const nat [])) (const nat.has_one []))))</span>
    <span class="o">),</span>
    <span class="c1">-- rw h2, -- &quot;lemma is not an equality or iff&quot;    &lt;---- is this a bug?</span>
    <span class="n">rw</span> <span class="n">h2</span><span class="bp">.</span><span class="n">symm</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span> <span class="c1">-- works fine</span>
    <span class="n">rw</span> <span class="o">[</span><span class="err">←</span><span class="n">add_assoc</span> <span class="n">m</span><span class="o">],</span>
    <span class="n">rw</span> <span class="n">h1</span><span class="bp">.</span><span class="n">symm</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
    <span class="n">simp</span> <span class="o">[</span><span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_comm</span><span class="o">,</span> <span class="n">add_comm</span><span class="o">,</span> <span class="n">add_assoc</span><span class="o">,</span> <span class="n">mul_assoc</span><span class="o">],</span>
    <span class="n">ac_refl</span><span class="o">,</span>
  <span class="o">}</span>
<span class="kn">end</span>
</code></pre></div>



<a name="196693296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196693296" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196693296">(May 06 2020 at 20:34)</a>:</h4>
<p><code>expr.to_raw_fmt</code> is like the super verbose version of <code>pp.all</code></p>



<a name="196693353"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196693353" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196693353">(May 06 2020 at 20:34)</a>:</h4>
<p>it shows you exactly what constructors of the <code>expr</code> type are being used</p>



<a name="196693399"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196693399" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196693399">(May 06 2020 at 20:35)</a>:</h4>
<p>As you can see, it starts <code>(app (mvar ...</code></p>



<a name="196693416"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196693416" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196693416">(May 06 2020 at 20:35)</a>:</h4>
<p>then where is the information stored that <code>?m_2</code> is <code>eq</code>?</p>



<a name="196693468"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196693468" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196693468">(May 06 2020 at 20:35)</a>:</h4>
<p>in the local context, not somewhere easily accessible to lean except through builtins like <code>instantiate_mvars</code></p>



<a name="196693610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196693610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196693610">(May 06 2020 at 20:36)</a>:</h4>
<p>can we tell <code>intro</code> to instantiate metavariables?</p>



<a name="196693728"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196693728" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196693728">(May 06 2020 at 20:37)</a>:</h4>
<p>I haven't looked at what is causing the problem in the first place in this case</p>



<a name="196693863"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196693863" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196693863">(May 06 2020 at 20:39)</a>:</h4>
<p>The only metavariable that <code>intro</code> instantiates is the goal. It doesn't have to solve any unification problems</p>



<a name="196694323"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196694323" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196694323">(May 06 2020 at 20:42)</a>:</h4>
<p>It might make things clearer to replace the first line with:</p>
<div class="codehilite"><pre><span></span><code>  <span class="k">have</span> <span class="o">:=</span> <span class="n">induction2</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">n</span><span class="o">,</span> <span class="n">apply</span> <span class="n">this</span><span class="o">,</span>
</code></pre></div>


<p>After the have, the state is</p>
<div class="codehilite"><pre><span></span><code><span class="mi">5</span> <span class="n">goals</span>
<span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span>
<span class="n">this</span> <span class="o">:</span> <span class="err">?</span><span class="n">m_1</span> <span class="n">n</span>
<span class="err">⊢</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">=</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">*</span> <span class="n">fibZ</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">+</span> <span class="n">fibZ</span> <span class="n">m</span> <span class="bp">*</span> <span class="n">fibZ</span> <span class="n">n</span>

<span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span>
<span class="err">⊢</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="kt">Prop</span>

<span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span>
<span class="err">⊢</span> <span class="err">?</span><span class="n">m_1</span> <span class="mi">0</span>

<span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span>
<span class="err">⊢</span> <span class="err">?</span><span class="n">m_1</span> <span class="mi">1</span>

<span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span>
<span class="err">⊢</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">d</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="err">?</span><span class="n">m_1</span> <span class="n">d</span> <span class="bp">→</span> <span class="err">?</span><span class="n">m_1</span> <span class="o">(</span><span class="n">d</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">→</span> <span class="err">?</span><span class="n">m_1</span> <span class="o">(</span><span class="n">d</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span>
</code></pre></div>


<p>The thing that will eventually become the type of <code>h2</code> is here <code>?m_1 (d + 1)</code></p>



<a name="196694343"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196694343" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196694343">(May 06 2020 at 20:43)</a>:</h4>
<p>The problem is somehow with the <code>apply</code> on the first line.</p>



<a name="196694365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196694365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196694365">(May 06 2020 at 20:43)</a>:</h4>
<p>yeah, that. <code>refine</code> fixes it.</p>



<a name="196694417"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196694417" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196694417">(May 06 2020 at 20:43)</a>:</h4>
<p>Because <code>refine</code> knows the expected type, and <code>apply</code> doesn't, elaboration happens in a different order here</p>



<a name="196694532"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196694532" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196694532">(May 06 2020 at 20:44)</a>:</h4>
<p><code>apply</code> is doing the above two stage process, while <code>refine</code> never creates <code>?m_1 (d + 1)</code> because it already knows what <code>?m_1</code> is</p>



<a name="196694658"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196694658" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196694658">(May 06 2020 at 20:45)</a>:</h4>
<p>When I saw the underscores I thought about maybe making induction2_on and applying that instead; I don't know if that would have fixed the problem.</p>



<a name="196694682"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196694682" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196694682">(May 06 2020 at 20:45)</a>:</h4>
<p>[this code is for pedagogical purposes]</p>



<a name="196694757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196694757" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196694757">(May 06 2020 at 20:46)</a>:</h4>
<p>Notice that the variable in question is pretty far from <code>apply</code>'s strike zone. It's in a subterm of a different goal</p>



<a name="196694872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196694872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196694872">(May 06 2020 at 20:47)</a>:</h4>
<p>I'm not sure if this is a factor, but there is a performance penalty for <code>instantiate_mvars</code> because it has to traverse the whole term, while most tactics try to keep track of where all the metavariables are so that they don't have to go hunting</p>



<a name="196695114"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196695114" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196695114">(May 06 2020 at 20:49)</a>:</h4>
<p>But the check in <code>rw</code> is just plain broken. It's pattern matching on the expr and assumes that an <code>mvar</code> is not an <code>eq</code>. This is a very common pattern, but it is not safe against rogue terms with instantiated mvars</p>



<a name="196695708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196695708" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196695708">(May 06 2020 at 20:54)</a>:</h4>
<p>Here's another example that often comes up for me:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">example</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">+</span> <span class="n">n</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">≠</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="n">mt</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">hz</span><span class="o">,</span> <span class="bp">_</span><span class="o">)</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">hz</span> <span class="c1">-- rewrite tactic failed, lemma is not an equality nor a iff</span>
<span class="kn">end</span>
</code></pre></div>



<a name="196695844"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196695844" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196695844">(May 06 2020 at 20:55)</a>:</h4>
<p>The type of <code>hz</code> is an instantiated metavariable here because it is unknown when it is created by the lambda and is solved by the <code>h</code> to its right</p>



<a name="196695846"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196695846" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196695846">(May 06 2020 at 20:55)</a>:</h4>
<p>I think you complain periodically about that one. Couldn't you change that in Lean 3.13?</p>



<a name="196695872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196695872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196695872">(May 06 2020 at 20:55)</a>:</h4>
<p>(I lost track of what it the next version)</p>



<a name="196696479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196696479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196696479">(May 06 2020 at 21:00)</a>:</h4>
<p>instantiated mvars or the <code>rw</code> check?</p>



<a name="196696494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196696494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196696494">(May 06 2020 at 21:00)</a>:</h4>
<p>The rw check</p>



<a name="196696552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196696552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196696552">(May 06 2020 at 21:00)</a>:</h4>
<p>I know nothing about the code in question but it shouldn't be hard</p>



<a name="196696607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196696607" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196696607">(May 06 2020 at 21:01)</a>:</h4>
<p>I think you already found the offending line at some point</p>



<a name="196697545"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196697545" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196697545">(May 06 2020 at 21:08)</a>:</h4>
<p>I'm building lean now, if I can remember how to do that</p>



<a name="196699671"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196699671" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bhavik Mehta <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196699671">(May 06 2020 at 21:24)</a>:</h4>
<p>I've seen this a couple of times but only very recently</p>



<a name="196699750"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196699750" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196699750">(May 06 2020 at 21:25)</a>:</h4>
<p><a href="https://github.com/leanprover-community/lean/issues/213" title="https://github.com/leanprover-community/lean/issues/213">lean#213</a></p>



<a name="196706935"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/rw%3A%20equality%20is%20not%20an%20equality/near/196706935" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/rw.3A.20equality.20is.20not.20an.20equality.html#196706935">(May 06 2020 at 22:34)</a>:</h4>
<p>BTW, this "instantiation" is more formally known as <a href="https://stackoverflow.com/questions/31889048/what-does-the-ghc-source-mean-by-zonk" title="https://stackoverflow.com/questions/31889048/what-does-the-ghc-source-mean-by-zonk">zonking</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>