---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/nat.2Epow.20in.20core.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html">nat.pow in core</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="198635576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198635576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198635576">(May 25 2020 at 05:49)</a>:</h4>
<p>I can't find <code>nat.pow</code> in <a href="https://github.com/leanprover-community/lean/tree/master/src/library/vm">https://github.com/leanprover-community/lean/tree/master/src/library/vm</a><br>
Does it mean that <code>nat.pow</code> has no vm override and we can remove it from core?</p>



<a name="198636024"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198636024" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198636024">(May 25 2020 at 06:01)</a>:</h4>
<p>Related: <a href="https://github.com/leanprover-community/lean/issues/128">lean#128</a></p>



<a name="198636930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198636930" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198636930">(May 25 2020 at 06:17)</a>:</h4>
<p>In this discussion <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> says that <code>nat.pow</code> has an efficient vm implementation. I can't find it.</p>



<a name="198637529"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198637529" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198637529">(May 25 2020 at 06:28)</a>:</h4>
<p>Is it done by GMP? cf. <a href="https://github.com/leanprover-community/lean/blob/ec1613aef1eee72e601f192b16740629c6d49690/src/util/numerics/mpz.h">https://github.com/leanprover-community/lean/blob/ec1613aef1eee72e601f192b16740629c6d49690/src/util/numerics/mpz.h</a></p>



<a name="198637688"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198637688" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198637688">(May 25 2020 at 06:32)</a>:</h4>
<p>Where does C++ code register an override?</p>



<a name="198638048"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198638048" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198638048">(May 25 2020 at 06:40)</a>:</h4>
<p>Maybe <a href="https://github.com/leanprover-community/lean/blob/303d31f1f1e4af8727761098b43dbe59d7c67d64/src/library/vm/vm.cpp#L1007">this function</a>? I'm really just guessing though.</p>



<a name="198638211"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198638211" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198638211">(May 25 2020 at 06:42)</a>:</h4>
<p>Do you see <code>pow</code> in this function? I don't. Let's wait for <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> .</p>



<a name="198638374"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198638374" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198638374">(May 25 2020 at 06:45)</a>:</h4>
<p>This is very fuzzy, but my working theory is that <code>pow</code> is overridden by a method for GMP's <code>mpz</code> type in the first file I linked. Somewhere in the second file, Lean <code>nat</code>s are replaced by <code>mpz</code> in the VM.</p>



<a name="198638429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198638429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198638429">(May 25 2020 at 06:46)</a>:</h4>
<p>But yes, let's see what Gabriel says.</p>



<a name="198638459"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198638459" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198638459">(May 25 2020 at 06:47)</a>:</h4>
<p>Many other overrides are explicitly listed <a href="https://github.com/leanprover-community/lean/blob/master/src/library/vm/vm_nat.cpp#L335">here</a></p>



<a name="198640562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198640562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198640562">(May 25 2020 at 07:19)</a>:</h4>
<p>(probably the answer is "<code>nat.pow</code> is not here but should be")</p>



<a name="198640653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198640653" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198640653">(May 25 2020 at 07:20)</a>:</h4>
<p>There are lots of other useful functions from gmp that could be exposed but aren't</p>



<a name="198640806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198640806" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198640806">(May 25 2020 at 07:23)</a>:</h4>
<p>Yeah, I think I was wrong. <code>nat.pow</code> doesn't seem to be overridden after all?</p>
<div class="codehilite"><pre><span></span><code><span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">compiler</span><span class="bp">.</span><span class="n">code_gen</span> <span class="n">true</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="mi">3</span><span class="bp">*</span><span class="mi">3</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">[compiler.code_gen]  _main 0</span>
<span class="cm">0: scnstr #3</span>
<span class="cm">1: scnstr #3</span>
<span class="cm">2: cfun nat.mul -- I guess this means it&#39;s calling a C++ function</span>
<span class="cm">3: cfun nat.repr</span>
<span class="cm">4: ret</span>
<span class="cm">-/</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="mi">3</span><span class="bp">^</span><span class="mi">3</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">[compiler.code_gen]  _main 0</span>
<span class="cm">0: scnstr #3</span>
<span class="cm">1: scnstr #3</span>
<span class="cm">2: ginvoke nat.pow._main -- this is just using the Lean definition?</span>
<span class="cm">3: cfun nat.repr</span>
<span class="cm">4: ret</span>
<span class="cm">-/</span>
</code></pre></div>



<a name="198640828"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198640828" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198640828">(May 25 2020 at 07:23)</a>:</h4>
<p>From <a href="https://gmplib.org/manual/Number-Theoretic-Functions.html#Number-Theoretic-Functions">https://gmplib.org/manual/Number-Theoretic-Functions.html#Number-Theoretic-Functions</a> I see: gcd, lcm, legendre/jacobi/kronecker symbols, fibonacci and lucas numbers, modular inverses, probabilistic primes (dunno if this is useful without a proof of correctness)</p>



<a name="198641733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198641733" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198641733">(May 25 2020 at 07:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="214703">Yury G. Kudryashov</span> <a href="#narrow/stream/113488-general/topic/nat.2Epow.20in.20core/near/198636930">said</a>:</p>
<blockquote>
<p>In this discussion <span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> says that <code>nat.pow</code> has an efficient vm implementation. I can't find it.</p>
</blockquote>
<p>Ooops, no idea what I got that impression from.  Indeed, I can confirm that there is no VM implementation of <code>int.pow</code> or <code>nat.pow</code>.  It's a bit of an odd omission, there are like three different efficient implementations division: right shifts, division by two, a function that returns the pair (division by two, modulo 2).</p>



<a name="198642525"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198642525" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198642525">(May 25 2020 at 07:47)</a>:</h4>
<p>that was me</p>



<a name="198642607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198642607" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198642607">(May 25 2020 at 07:48)</a>:</h4>
<p>Most of my work there was on the lean side, I think there is only basic support from the C++ side</p>



<a name="198642669"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198642669" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198642669">(May 25 2020 at 07:48)</a>:</h4>
<p>But I guess this means that nat.pow is implemented in unary wrt the exponent?</p>



<a name="198642807"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198642807" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198642807">(May 25 2020 at 07:50)</a>:</h4>
<p>Actually I think the support for bitwise stuff is not great, most importantly because <code>bit0</code> is not a left shift</p>



<a name="198643086"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/nat.pow%20in%20core/near/198643086" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/nat.2Epow.20in.20core.html#198643086">(May 25 2020 at 07:54)</a>:</h4>
<p>Another nice GMP function I wish we had is <code>divexact</code>, which is a partial version of integer division that is only defined when the result is representable (i.e. the denominator divides the numerator)</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>