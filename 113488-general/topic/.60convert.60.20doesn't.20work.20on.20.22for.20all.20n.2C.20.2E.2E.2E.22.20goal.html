---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html">`convert` doesn't work on "for all n, ..." goal</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="224862948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224862948" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224862948">(Feb 02 2021 at 12:17)</a>:</h4>
<p>Just ran into this whilst preparing my class for this week:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">data.real.basic</span>

<span class="c1">-- `convert` doesn't work with `∀`?</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">),</span> <span class="n">true</span><span class="o">)</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">),</span> <span class="n">true</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">convert</span> <span class="n">h</span><span class="o">,</span> <span class="c1">-- two goals?</span>
  <span class="c1">-- independent weirdness:</span>
  <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span> <span class="c1">-- no goals?</span>
<span class="kd">end</span>

<span class="c1">-- actual use case:</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">(</span><span class="n">l</span> <span class="n">c</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">(</span><span class="n">N</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span> <span class="bp">≥</span> <span class="n">N</span> <span class="bp">→</span> <span class="n">abs</span> <span class="o">(</span><span class="n">a</span> <span class="n">n</span> <span class="bp">-</span> <span class="n">l</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="n">ε</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span> <span class="bp">≥</span> <span class="n">N</span> <span class="bp">→</span> <span class="n">abs</span> <span class="o">((</span><span class="bp">λ</span> <span class="n">m</span><span class="o">,</span> <span class="n">a</span> <span class="n">m</span> <span class="bp">+</span> <span class="n">c</span><span class="o">)</span> <span class="n">n</span> <span class="bp">-</span> <span class="o">(</span><span class="n">l</span> <span class="bp">+</span> <span class="n">c</span><span class="o">))</span> <span class="bp">&lt;</span> <span class="n">ε</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="c1">-- convert h, -- that random "same goal twice" thing again</span>
  <span class="n">intros</span> <span class="n">n</span> <span class="n">hn</span><span class="o">,</span>
  <span class="n">convert</span> <span class="o">(</span><span class="n">h</span> <span class="n">n</span> <span class="n">hn</span><span class="o">)</span> <span class="n">using</span> <span class="mi">2</span><span class="o">,</span> <span class="c1">-- this works</span>
  <span class="n">ring</span><span class="o">,</span> <span class="n">ring</span><span class="o">,</span> <span class="c1">-- lol (but `simp` works, as does `dsimp, ring`)</span>
<span class="kd">end</span>
</code></pre></div>
<p>Is it expected that the first <code>convert</code> doesn't work? In the actual use case, it's fine after pulling off <code>n</code> and <code>hn</code>.</p>
<p>Independent oddities: (1) I have a vanishing goal in the MWE, which I thought was very odd. Is this a bug?<br>
(2) it's always nice to find goals closed by <code>ring, ring</code> (because I always believe it's idempotent). This time I think <code>ring</code> gives up and then randomly applies beta reduction for some reason, enabling <code>ring</code> to work when called a second time.</p>



<a name="224863423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224863423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224863423">(Feb 02 2021 at 12:22)</a>:</h4>
<p>Sometimes goals vanish if the second is a metavariable that you populated in the first.</p>



<a name="224863466"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224863466" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224863466">(Feb 02 2021 at 12:22)</a>:</h4>
<p>indeed, but that doesn't seem to be the case here.</p>



<a name="224863527"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224863527" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224863527">(Feb 02 2021 at 12:23)</a>:</h4>
<p>oh wooah, I was wondering whether it was some part of the system trying a cheeky <code>rfl</code> but look:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">),</span> <span class="n">false</span><span class="o">)</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">),</span> <span class="n">true</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">convert</span> <span class="n">h</span><span class="o">,</span> <span class="c1">-- two goals?</span>
  <span class="o">{</span> <span class="gr">sorry</span> <span class="o">},</span> <span class="c1">-- no goals?</span>
<span class="kd">end</span>
</code></pre></div>



<a name="224863678"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224863678" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224863678">(Feb 02 2021 at 12:25)</a>:</h4>
<p><code>recover</code> collapses the two goals into one</p>



<a name="224863693"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224863693" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224863693">(Feb 02 2021 at 12:25)</a>:</h4>
<p>So I think this is a bug in a tactic</p>



<a name="224865427"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224865427" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224865427">(Feb 02 2021 at 12:44)</a>:</h4>
<p>Yes it must somehow be literally the same goal being displayed twice. I've never seen <code>recover</code> decrease the number of goals before :-)</p>



<a name="224866348"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224866348" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224866348">(Feb 02 2021 at 12:53)</a>:</h4>
<p>even a <code>let</code> or <code>have</code> coalesces the goals into one</p>



<a name="224867451"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224867451" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224867451">(Feb 02 2021 at 13:03)</a>:</h4>
<p>I remember Reid once remarking that he had no idea why sometimes <code>convert</code> produced two identical goals, so at least this is a partial answer to that question. The rule of thumb I used to use was "if <code>convert</code> does this, it has done nothing useful, so try something else".</p>



<a name="224903900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224903900" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224903900">(Feb 02 2021 at 17:16)</a>:</h4>
<p>So <code>convert</code> just doesn't work with pi types, and there's a bug which makes a goal appear twice? Here's the simplest pi type of all:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">P</span> <span class="n">Q</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">P</span> <span class="bp">→</span> <span class="n">Q</span><span class="o">)</span> <span class="o">:</span> <span class="n">P</span> <span class="bp">→</span> <span class="n">Q</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">convert</span> <span class="n">h</span><span class="o">,</span> <span class="c1">-- two goals</span>
  <span class="gr">sorry</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="224906031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224906031" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224906031">(Feb 02 2021 at 17:29)</a>:</h4>
<p>The issue seems to be here:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">P</span> <span class="n">Q</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">P</span> <span class="bp">→</span> <span class="n">Q</span><span class="o">)</span> <span class="o">:</span> <span class="n">P</span> <span class="bp">→</span> <span class="n">Q</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="k">do</span>
  <span class="n">v</span> <span class="bp">←</span> <span class="n">mk_mvar</span><span class="o">,</span>
  <span class="n">refine</span> <span class="bp">```</span><span class="o">(</span><span class="n">eq.mpr</span> <span class="bp">%%</span><span class="n">v</span> <span class="n">h</span><span class="o">),</span>
  <span class="n">done</span>
</code></pre></div>
<p>The <code>refine</code> call is supposed to leave no subgoals, but for some reason <code>v</code> becomes a goal here</p>



<a name="224906827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224906827" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224906827">(Feb 02 2021 at 17:34)</a>:</h4>
<p>Implications are a red-herring too:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">P</span> <span class="n">Q</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">P</span><span class="o">)</span> <span class="o">:</span> <span class="n">P</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">convert</span> <span class="n">h</span><span class="o">,</span>
  <span class="gr">sorry</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="224906957"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224906957" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224906957">(Feb 02 2021 at 17:35)</a>:</h4>
<blockquote>
<p>The <code>refine</code> call is supposed to leave no subgoals,</p>
</blockquote>
<p>Either this is true and there is a bug in <code>refine</code>, or this is not true and there is a bug in the author who wrote <code>convert</code>'s understanding of how <code>refine</code> works</p>



<a name="224907025"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907025" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907025">(Feb 02 2021 at 17:35)</a>:</h4>
<p>heh I think you can guess who that is :)</p>



<a name="224907065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907065" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907065">(Feb 02 2021 at 17:35)</a>:</h4>
<p><a href="https://leanprover-community.github.io/mathlib_docs/find/tactic.interactive.convert/src">src#tactic.interactive.convert</a> will confirm :)</p>



<a name="224907432"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907432" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907432">(Feb 02 2021 at 17:38)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/1099">#1099</a> introduced the bug I think</p>



<a name="224907479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907479">(Feb 02 2021 at 17:38)</a>:</h4>
<p>There have always been duplicate goals there, but perhaps <code>congr'</code> always cleaned them up?</p>



<a name="224907506"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907506" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907506">(Feb 02 2021 at 17:38)</a>:</h4>
<p>what the heck is that PR</p>



<a name="224907566"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907566" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907566">(Feb 02 2021 at 17:39)</a>:</h4>
<p>Huh, github led me astray</p>



<a name="224907593"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907593" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907593">(Feb 02 2021 at 17:39)</a>:</h4>
<p>I meant <a href="https://github.com/leanprover-community/mathlib/commit/3478f1f65fc0aed5574a7f59316976f1c01522c2">https://github.com/leanprover-community/mathlib/commit/3478f1f65fc0aed5574a7f59316976f1c01522c2</a></p>



<a name="224907606"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907606" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907606">(Feb 02 2021 at 17:39)</a>:</h4>
<p>Which I guess is PR-less</p>



<a name="224907729"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907729" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907729">(Feb 02 2021 at 17:40)</a>:</h4>
<p>I don't think so... there shouldn't be two goals in the first place</p>



<a name="224907776"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907776" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907776">(Feb 02 2021 at 17:41)</a>:</h4>
<p>Without the <code>try</code>, <code>convert</code> would just fail</p>



<a name="224907793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907793" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907793">(Feb 02 2021 at 17:41)</a>:</h4>
<p>which can't be said to ever be correct behavior</p>



<a name="224907996"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224907996" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224907996">(Feb 02 2021 at 17:43)</a>:</h4>
<p>If it fails then the bad <code>set_goals</code> never runs</p>



<a name="224908041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224908041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224908041">(Feb 02 2021 at 17:43)</a>:</h4>
<p>if it fails then <code>convert</code> fails and then everything stops</p>



<a name="224908069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224908069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224908069">(Feb 02 2021 at 17:43)</a>:</h4>
<p>Yes, exactly - so the bug wasn't possible to observe until after that commit</p>



<a name="224908141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224908141" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224908141">(Feb 02 2021 at 17:44)</a>:</h4>
<p>what if congr' doesn't fail though?</p>



<a name="224908233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224908233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224908233">(Feb 02 2021 at 17:44)</a>:</h4>
<p>the set_goals is just restoring the goals that were taken out while <code>congr'</code> is running</p>



<a name="224908262"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224908262" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224908262">(Feb 02 2021 at 17:45)</a>:</h4>
<p>it's the same thing as what <code>focus</code> does, only manually</p>



<a name="224909420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224909420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224909420">(Feb 02 2021 at 17:53)</a>:</h4>
<p>This fixes the extra goal issue:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">convert</span> <span class="o">(</span><span class="n">sym</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">with_desc</span> <span class="s2">"←"</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"&lt;-"</span><span class="o">)</span><span class="bp">?</span><span class="o">))</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">texpr</span><span class="o">)</span>
  <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"using"</span> <span class="bp">*&gt;</span> <span class="n">small_nat</span><span class="o">)</span><span class="bp">?</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="k">do</span> <span class="n">r</span> <span class="bp">←</span> <span class="n">i_to_expr</span> <span class="n">r</span><span class="o">,</span>
  <span class="n">src</span> <span class="bp">←</span> <span class="n">infer_type</span> <span class="n">r</span><span class="o">,</span>
  <span class="n">tgt</span> <span class="bp">←</span> <span class="n">target</span><span class="o">,</span>
  <span class="n">v</span> <span class="bp">←</span> <span class="n">to_expr</span> <span class="o">(</span><span class="k">if</span> <span class="n">sym.is_some</span> <span class="k">then</span> <span class="bp">``</span><span class="o">(</span><span class="bp">%%</span><span class="n">src</span> <span class="bp">=</span> <span class="bp">%%</span><span class="n">tgt</span><span class="o">)</span> <span class="k">else</span> <span class="bp">``</span><span class="o">(</span><span class="bp">%%</span><span class="n">tgt</span> <span class="bp">=</span> <span class="bp">%%</span><span class="n">src</span><span class="o">))</span> <span class="n">tt</span> <span class="n">ff</span> <span class="bp">&gt;&gt;=</span> <span class="n">mk_meta_var</span><span class="o">,</span>
  <span class="o">(</span><span class="k">if</span> <span class="n">sym.is_some</span> <span class="k">then</span> <span class="n">mk_eq_mp</span> <span class="n">v</span> <span class="n">r</span> <span class="k">else</span> <span class="n">mk_eq_mpr</span> <span class="n">v</span> <span class="n">r</span><span class="o">)</span> <span class="bp">&gt;&gt;=</span> <span class="n">tactic.exact</span><span class="o">,</span>
  <span class="n">gs</span> <span class="bp">←</span> <span class="n">get_goals</span><span class="o">,</span>
  <span class="n">set_goals</span> <span class="o">[</span><span class="n">v</span><span class="o">],</span>
  <span class="n">try</span> <span class="o">(</span><span class="n">tactic.congr'</span> <span class="n">n</span><span class="o">),</span>
  <span class="n">gs'</span> <span class="bp">←</span> <span class="n">get_goals</span><span class="o">,</span>
  <span class="n">set_goals</span> <span class="bp">$</span> <span class="n">gs'</span> <span class="bp">++</span> <span class="n">gs</span>
</code></pre></div>
<p>But it doesn't fix that <code>congr'</code> doesn't know how to prove <code>P = P</code></p>



<a name="224909472"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224909472" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224909472">(Feb 02 2021 at 17:53)</a>:</h4>
<p><code>set_goals</code> automatically cleans up duplicate goals in some situations it seems</p>



<a name="224909603"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224909603" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224909603">(Feb 02 2021 at 17:54)</a>:</h4>
<p>I don't think so... It does clean up instantiated metavariables though, and the extra goal here is <code>v</code>, which is being instantiated by the <code>congr'</code> tactic</p>



<a name="224909889"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224909889" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224909889">(Feb 02 2021 at 17:56)</a>:</h4>
<p>... except when <code>congr'</code> fails, in which case you see <code>v</code> twice</p>



<a name="224910032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910032" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910032">(Feb 02 2021 at 17:57)</a>:</h4>
<p>Removing <code>v</code> from <code>gs</code> ought to be enough to fix it, right?</p>



<a name="224910058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910058">(Feb 02 2021 at 17:57)</a>:</h4>
<p>Like I said, the above fixes the goal issue</p>



<a name="224910134"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910134" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910134">(Feb 02 2021 at 17:58)</a>:</h4>
<p>the issue now is that <code>congr'</code> doesn't prove refl goals</p>



<a name="224910164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910164">(Feb 02 2021 at 17:58)</a>:</h4>
<p>even <code>congr' 0</code> should prove refl goals</p>



<a name="224910233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910233">(Feb 02 2021 at 17:59)</a>:</h4>
<p>Right, my pointis that my fix seemed simpler than yours</p>



<a name="224910265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910265">(Feb 02 2021 at 17:59)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">convert2</span> <span class="o">(</span><span class="n">sym</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">with_desc</span> <span class="s2">"←"</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"&lt;-"</span><span class="o">)</span><span class="bp">?</span><span class="o">))</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">texpr</span><span class="o">)</span>
  <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"using"</span> <span class="bp">*&gt;</span> <span class="n">small_nat</span><span class="o">)</span><span class="bp">?</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="k">do</span> <span class="n">v</span> <span class="bp">←</span> <span class="n">mk_mvar</span><span class="o">,</span>
   <span class="k">if</span> <span class="n">sym.is_some</span>
     <span class="k">then</span> <span class="n">refine</span> <span class="bp">``</span><span class="o">(</span><span class="n">eq.mp</span> <span class="bp">%%</span><span class="n">v</span> <span class="bp">%%</span><span class="n">r</span><span class="o">)</span>
     <span class="k">else</span> <span class="n">refine</span> <span class="bp">``</span><span class="o">(</span><span class="n">eq.mpr</span> <span class="bp">%%</span><span class="n">v</span> <span class="bp">%%</span><span class="n">r</span><span class="o">),</span>
   <span class="n">gs</span> <span class="bp">←</span> <span class="n">get_goals</span><span class="o">,</span>
   <span class="k">let</span> <span class="n">gs</span> <span class="o">:=</span> <span class="n">gs.erase</span> <span class="n">v</span><span class="o">,</span>  <span class="c1">-- only this line is new</span>
   <span class="n">set_goals</span> <span class="o">[</span><span class="n">v</span><span class="o">],</span>
   <span class="n">try</span> <span class="o">(</span><span class="n">tactic.congr'</span> <span class="n">n</span><span class="o">),</span>
   <span class="n">gs'</span> <span class="bp">←</span> <span class="n">get_goals</span><span class="o">,</span>
   <span class="n">set_goals</span> <span class="bp">$</span> <span class="n">gs'</span> <span class="bp">++</span> <span class="n">gs</span>
</code></pre></div>



<a name="224910327"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910327" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910327">(Feb 02 2021 at 17:59)</a>:</h4>
<p>I'm pretty sure I remember a zulip thread / github issue / PR about <code>congr</code> trying <code>refl</code></p>



<a name="224910333"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910333" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910333">(Feb 02 2021 at 17:59)</a>:</h4>
<p>That's not necessarily enough in general... this is a symptom of a problem</p>



<a name="224910497"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910497" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910497">(Feb 02 2021 at 18:00)</a>:</h4>
<p>I think the reason for the issue is that when you use <code>%%v</code> to interpolate a metavariable expr into a pexpr, it counts as a <code>_</code> and refine makes it a goal, which I don't want here</p>



<a name="224910527"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910527" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910527">(Feb 02 2021 at 18:00)</a>:</h4>
<p>but I do want goals to be produced from elaborating <code>r</code></p>



<a name="224910583"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910583" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910583">(Feb 02 2021 at 18:01)</a>:</h4>
<p>Right, hence my suggestion to just erase <code>v</code> from the saved goals - we know we are just about to work on it, so it doesn't need to be saved for later.</p>



<a name="224910727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224910727" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224910727">(Feb 02 2021 at 18:02)</a>:</h4>
<p>There are other variables involved, like the implicit arguments in <code>eq.mp</code>. Those shouldn't be goals either</p>



<a name="224911070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224911070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224911070">(Feb 02 2021 at 18:05)</a>:</h4>
<p>This was the thread I was thinking of: <a href="#narrow/stream/239415-metaprogramming-.2F.20tactics/topic/congr'.20is.20slow">https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming-.2F.20tactics/topic/congr'.20is.20slow</a></p>



<a name="224911093"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224911093" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224911093">(Feb 02 2021 at 18:05)</a>:</h4>
<p>And this change might be what broke congr: <a href="https://github.com/leanprover-community/mathlib/pull/4678/files#diff-c33389a201db0e89fc66a4ef17729baccaede3732ec983d35f1a5781ddd92950L65">https://github.com/leanprover-community/mathlib/pull/4678/files#diff-c33389a201db0e89fc66a4ef17729baccaede3732ec983d35f1a5781ddd92950L65</a></p>



<a name="224911749"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224911749" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224911749">(Feb 02 2021 at 18:10)</a>:</h4>
<p>This fixes the congr' issue:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">congr'</span> <span class="o">:</span> <span class="n">option</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">tactic</span> <span class="n">unit</span>
<span class="bp">|</span> <span class="n">o</span> <span class="o">:=</span> <span class="n">focus1</span> <span class="bp">$</span>
  <span class="n">assumption</span> <span class="bp">&lt;|&gt;</span> <span class="n">reflexivity</span> <span class="bp">&lt;|&gt;</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">apply</span> <span class="n">proof_irrel_heq</span><span class="o">]</span> <span class="bp">&lt;|&gt;</span> <span class="bp">`</span><span class="o">[</span><span class="n">apply</span> <span class="n">proof_irrel</span><span class="o">]</span> <span class="bp">&lt;|&gt;</span>
  <span class="o">(</span><span class="n">guard</span> <span class="o">(</span><span class="n">o</span> <span class="bp">≠</span> <span class="n">some</span> <span class="mi">0</span><span class="o">)</span> <span class="bp">&gt;&gt;</span> <span class="n">congr_core'</span> <span class="bp">&gt;&gt;</span>
    <span class="n">all_goals'</span> <span class="o">(</span><span class="n">try</span> <span class="o">(</span><span class="n">congr'</span> <span class="o">(</span><span class="n">nat.pred</span> <span class="bp">&lt;$&gt;</span> <span class="n">o</span><span class="o">))))</span>
</code></pre></div>



<a name="224911805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224911805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224911805">(Feb 02 2021 at 18:10)</a>:</h4>
<p>The problem isn't anything to do with reducible refl, it's the fact that <code>congr' (some 0)</code> is literally defined to be <code>failed</code></p>



<a name="224911879"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224911879" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224911879">(Feb 02 2021 at 18:11)</a>:</h4>
<p>this version moves the order of operations a bit so that it always tries reflexivity even at depth 0</p>



<a name="224913797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224913797" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224913797">(Feb 02 2021 at 18:24)</a>:</h4>
<p>Why is <code>congr' (some 0)</code> being used at all though? Doesn't <code>convert</code> pass <code>none</code> by default?</p>



<a name="224913888"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224913888" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224913888">(Feb 02 2021 at 18:24)</a>:</h4>
<p>Yes, the issue is actually that <code>refl</code> was only being tried in the subgoals of a <code>congr_core'</code> application rather than at the top level</p>



<a name="224916562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224916562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224916562">(Feb 02 2021 at 18:42)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/6011">#6011</a></p>



<a name="224930660"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224930660" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224930660">(Feb 02 2021 at 20:21)</a>:</h4>
<p>Unsurprisingly, that PR doesn't build. I guess there are quite a few places in mathlib that try to counteract this bug.</p>



<a name="224931869"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224931869" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224931869">(Feb 02 2021 at 20:30)</a>:</h4>
<p>yeah, I plan to be pushing fixes for the next few hours</p>



<a name="224932134"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224932134" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224932134">(Feb 02 2021 at 20:31)</a>:</h4>
<p>I think <code>congr</code> is a bit more conservative about definitional reduction now, although I'm not 100% sure what the cause is; the first error has to do with an unreduced beta redex in the term provided to <code>convert</code></p>



<a name="224932502"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224932502" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224932502">(Feb 02 2021 at 20:34)</a>:</h4>
<p>I think it's a good idea for <code>congr</code> to not reduce functions on its own, because it makes it less clear what <code>f</code> and <code>g</code> are when it uses the theorem <code>f = g -&gt; a = b -&gt; f a = g b</code></p>



<a name="224935524"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224935524" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224935524">(Feb 02 2021 at 20:58)</a>:</h4>
<p>What happens to</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">X</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">),</span> <span class="n">true</span><span class="o">)</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">),</span> <span class="n">false</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">convert</span> <span class="n">h</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>now?</p>



<a name="224937021"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224937021" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224937021">(Feb 02 2021 at 21:09)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">⊢</span> <span class="o">(</span><span class="n">X</span> <span class="bp">→</span> <span class="n">false</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">X</span> <span class="bp">→</span> <span class="n">true</span><span class="o">)</span>
</code></pre></div>



<a name="224937271"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224937271" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224937271">(Feb 02 2021 at 21:12)</a>:</h4>
<p>I don't really understand how <code>@[congr]</code> attributes work, since <code>forall_congr</code> is marked as <code>@[congr]</code> so it should be firing in principle</p>



<a name="224937286"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%60convert%60%20doesn%27t%20work%20on%20%22for%20all%20n%2C%20...%22%20goal/near/224937286" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.60convert.60.20doesn't.20work.20on.20.22for.20all.20n.2C.20.2E.2E.2E.22.20goal.html#224937286">(Feb 02 2021 at 21:12)</a>:</h4>
<p>but that's something that has to be fixed in the C++</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>