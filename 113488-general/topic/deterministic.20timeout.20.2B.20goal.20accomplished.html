---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html">deterministic timeout + goal accomplished</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="218432308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218432308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218432308">(Dec 01 2020 at 14:58)</a>:</h4>
<p>I got a "goal accomplished" together with a "deterministic timeout". This appends right at the end of a proof, at the "refl" or "simp" line. I found out that this problem was already encountered one week ago : <br>
<a href="#narrow/stream/240192-Berkeley-Lean.20Seminar/topic/Project.20ideas/near/217690233">https://leanprover.zulipchat.com/#narrow/stream/240192-Berkeley-Lean.20Seminar/topic/Project.20ideas/near/217690233</a><br>
This error message is quite dreadful (you feel so close, but you are so far), and I think it deserves its own topic. In my case, I found a different proof that work, but I still don't understand why my first, more beautiful proof fails. The issue was also solved in the discussion linked above. What I gathered is that : <br>
-the issue is not actually at the "refl" but happens before, some tactic is messing around, corrupting some goal in the background, and when the compiler checks what's the tactic did, it gets lost.<br>
-In the case linked above, replacing a "have" by a "let" in an isomorphism in the proof solved the problem. The isomorphism had to be describe explicitly.<br>
-In my case, I replaced a proof based on a associativity lemmas by a proof with multiple dsimp and some lower level lemmas. I have still no idea where the error comes from, and I am afraid it is just under the carpet, ready to appear again.</p>



<a name="218432839"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218432839" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218432839">(Dec 01 2020 at 15:01)</a>:</h4>
<p>Since I have a functioning proof (for now), this topic aims at documenting the issue rather than solving my problem, but here is the faulty code anyway : </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">compq_quotient_assoc</span> <span class="o">(</span><span class="n">p</span><span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">I</span><span class="o">:</span><span class="n">ideal</span> <span class="bp">$</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
<span class="o">(</span><span class="n">quotient_cast</span> <span class="o">(</span><span class="n">le_of_eq</span> <span class="o">(</span><span class="n">comp_ideal_assoc</span> <span class="n">p</span> <span class="n">q</span> <span class="n">I</span><span class="o">)))</span><span class="bp">.</span><span class="n">comp</span> <span class="o">(</span> <span class="o">(</span><span class="n">compq_quotient</span> <span class="n">q</span> <span class="o">(</span><span class="n">comp_ideal</span> <span class="n">p</span> <span class="n">I</span><span class="o">)</span> <span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="o">(</span><span class="n">compq_quotient</span> <span class="n">p</span> <span class="n">I</span><span class="o">))</span><span class="bp">=</span>
<span class="n">compq_quotient</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">)</span> <span class="n">I</span> <span class="o">:=</span>
<span class="kd">begin</span>
    <span class="n">dsimp</span> <span class="o">[</span><span class="n">compq_quotient</span><span class="o">,</span> <span class="n">quotient_cast</span><span class="o">],</span>
    <span class="n">repeat</span> <span class="o">{</span><span class="n">rw</span> <span class="n">quotient_map_assoc</span><span class="o">},</span>
    <span class="n">congr'</span><span class="o">,</span>
    <span class="n">simp</span><span class="o">,</span>
    <span class="n">rw</span> <span class="n">compq_assoc</span><span class="o">,</span>  <span class="c1">--goal accomplished but deterministic timeout</span>
<span class="kd">end</span>
</code></pre></div>
<p>and the correct proof : </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">compq_quotient_assoc'</span> <span class="o">(</span><span class="n">p</span><span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">I</span><span class="o">:</span><span class="n">ideal</span> <span class="bp">$</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
<span class="o">(</span><span class="n">quotient_cast</span> <span class="o">(</span><span class="n">le_of_eq</span> <span class="o">(</span><span class="n">comp_ideal_assoc</span> <span class="n">p</span> <span class="n">q</span> <span class="n">I</span><span class="o">)))</span><span class="bp">.</span><span class="n">comp</span> <span class="o">(</span> <span class="o">(</span><span class="n">compq_quotient</span> <span class="n">q</span> <span class="o">(</span><span class="n">comp_ideal</span> <span class="n">p</span> <span class="n">I</span><span class="o">)</span> <span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="o">(</span><span class="n">compq_quotient</span> <span class="n">p</span> <span class="n">I</span><span class="o">))</span><span class="bp">=</span>
<span class="n">compq_quotient</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">)</span> <span class="n">I</span> <span class="o">:=</span>
<span class="kd">begin</span>
    <span class="n">apply</span> <span class="n">ring_hom.ext</span><span class="o">,</span> <span class="n">intro</span> <span class="n">aclass</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">ideal.quotient.mk_surjective</span> <span class="n">aclass</span> <span class="k">with</span> <span class="n">a</span> <span class="n">ha</span><span class="o">,</span>
    <span class="n">dsimp</span> <span class="o">[</span><span class="n">quotient_cast</span><span class="o">,</span> <span class="n">compq_quotient</span><span class="o">,</span> <span class="n">comp_ideal</span><span class="o">,</span> <span class="n">ideal.quotient_map</span><span class="o">,</span> <span class="n">ideal.map</span><span class="o">],</span>
    <span class="n">rw</span> <span class="bp">←</span>  <span class="n">ha</span><span class="o">,</span>
    <span class="n">repeat</span> <span class="o">{</span><span class="n">rw</span> <span class="n">ideal.quotient.lift_mk</span><span class="o">},</span>
    <span class="n">simp</span><span class="o">,</span>
    <span class="n">dsimp</span> <span class="o">[</span><span class="n">compq</span><span class="o">],</span>
    <span class="n">rw</span> <span class="n">comp_assoc</span><span class="o">,</span>  <span class="c1">--works fine, but slow</span>
<span class="kd">end</span>
</code></pre></div>
<p>Finally, the full context : </p>
<div class="spoiler-block"><div class="spoiler-header">
</div><div class="spoiler-content" aria-hidden="true">
<p>import ring_theory.adjoin_root ring_theory.ideal.operations <br>
import linear_algebra.basis linear_algebra.matrix algebra.module.basic  algebra.polynomial.group_ring_action<br>
import tactic</p>
<p>noncomputable theory</p>
<p>--We show that 1, (X-l), ... (X-l)^n is a basis for K[X]/(X-l)^(n+1), using the power basis 1, ..., X^n of K[X]/X^(n+1)</p>
<p>namespace adjoin_root_basis</p>
<p>open polynomial --to use X as the polynomial indeterminate</p>
<p>variables {R:Type} [comm_ring R] (I J : ideal $polynomial R) (p q: polynomial R)</p>
<p>--let us define some casting function to take care of the heterogenous equality problem. </p>
<p>lemma trivial_id_inclusion  {I J: ideal R} (ilj:I≤ J) : I ≤ ideal.comap (<a href="http://ring_hom.id">ring_hom.id</a> R) J :=<br>
begin<br>
    intros x xin, simp, exact  ilj xin,<br>
end </p>
<p>def quotient_cast {I J:ideal R} (ilj: I≤ J) :=ideal.quotient_map J (<a href="http://ring_hom.id">ring_hom.id</a> R) (trivial_id_inclusion ilj)</p>
<p>--a few simp-type lemmas for quotient_cast<br>
lemma quotient_cast_id {I : ideal R} (ilj: I≤ I): (quotient_cast ilj)=ring_hom.id I.quotient :=<br>
begin<br>
    dsimp [quotient_cast, ideal.quotient_map],ext, <br>
    cases ideal.quotient.mk_surjective x with a ha,<br>
    rw ← ha,<br>
    rw ideal.quotient.lift_mk ,<br>
    simp,<br>
end</p>
<p>lemma quotient_cast_composition {I J L : ideal R} (ilj : I≤ J) (jll: J≤L) : <br>
(quotient_cast jll)∘ (quotient_cast ilj)= quotient_cast (le_trans ilj jll):=<br>
begin<br>
   dsimp [quotient_cast, ideal.quotient_map], ext,  <br>
   cases ideal.quotient.mk_surjective x with a ha,<br>
    rw ← ha,<br>
    repeat {rw ideal.quotient.lift_mk},<br>
    simp,<br>
end</p>
<p>--this should do for the nondefinitional equality problem<br>
--question : could this "cast" tric be done more generally to any dependent type ? </p>
<p>--another preliminary : the "associativity" of quotient_map. <br>
#check ideal.quotient_map </p>
<p>--first a little lemma to compose inequalities necessary to quotient_map</p>
<p>def comap_ineg_assoc {R1: Type} {R2: Type} {R3:Type} [comm_ring R1] [comm_ring R2] [comm_ring R3] {I: ideal R1} {J: ideal R2} (K:ideal R3)<br>
(f: ring_hom R1 R2) (g: ring_hom R2 R3)  (ilfj: I≤ ideal.comap f J) (jlgk : J≤ ideal.comap g K) :<br>
I≤ ideal.comap (g.comp f) K :=λ x xin,jlgk (ilfj xin)</p>
<p>lemma quotient_map_assoc {R1: Type} {R2: Type} {R3:Type} [comm_ring R1] [comm_ring R2] [comm_ring R3] {I: ideal R1} {J: ideal R2} (K:ideal R3)<br>
(f: ring_hom R1 R2) (g: ring_hom R2 R3) (ilfj: I≤ ideal.comap f J) (jlgk : J≤ ideal.comap g K) :<br>
(ideal.quotient_map K g jlgk).comp (ideal.quotient_map J f ilfj )=ideal.quotient_map K (g.comp f) (comap_ineg_assoc K f g ilfj jlgk):=<br>
begin<br>
    apply ring_hom.ext, intro xclass,<br>
    cases ideal.quotient.mk_surjective xclass with x hx, rw ← hx,<br>
    dsimp [ideal.quotient_map],<br>
    repeat {rw ideal.quotient.lift_mk},simp,<br>
end</p>
<p>--Now we construct some ring homomorphisms between quotients. </p>
<p>def compq (q:polynomial R) : ring_hom (polynomial R) (polynomial R):=<br>
{<br>
to_fun:= λ p, p.comp q, <br>
map_add':=λ p r, begin apply add_comp, end , <br>
map_mul':= λ p r, begin simp, end, <br>
map_one':= begin simp, end,<br>
map_zero':=begin simp, end,<br>
}</p>
<p>lemma compq_assoc (p:polynomial R) (q: polynomial R) : (compq p).comp (compq q) =compq (q.comp p):=<br>
begin<br>
    apply ring_hom.ext, intro x,<br>
    dsimp [compq], <br>
    apply comp_assoc, --Key step<br>
end</p>
<p>def comp_ideal (p: polynomial R) (I: ideal $polynomial R)  :=ideal.map (compq p) I </p>
<p>--a simp lemma describing the composition<br>
lemma comp_ideal_assoc (p q:polynomial R) (I: ideal $ polynomial R)  : comp_ideal q (comp_ideal p I) =comp_ideal (p.comp q) I:=<br>
begin<br>
    dsimp [comp_ideal], <br>
    rw ideal.map_map, --Key step<br>
    congr', <br>
    rw compq_assoc q p,<br>
end</p>
<p>--a simp lemma used to define the quotient map <br>
lemma compq_comp_ideal (p:polynomial R) (I:ideal $ polynomial R) : ∀ (r:polynomial R),<br>
r∈ I → r.comp p ∈ comp_ideal p I :=<br>
begin<br>
    intros r rin,<br>
    apply ideal.subset_span, --key step 1<br>
    dsimp [compq],<br>
    use r,<br>
    split, <br>
    {exact rin,},{simp,},<br>
end</p>
<p>def compq_quotient (p:polynomial R) (I: ideal $polynomial R)  : I.quotient →+* (comp_ideal p I).quotient :=<br>
ideal.quotient_map (comp_ideal p I) (compq p) (compq_comp_ideal p I)</p>
<p>#check compq_quotient p I <br>
#check (compq_quotient q (comp_ideal p I) ).comp (compq_quotient p I)<br>
#check (quotient_cast (le_of_eq (comp_ideal_assoc p q I))).comp ( (compq_quotient q (comp_ideal p I) ).comp (compq_quotient p I))</p>
<p>--the lemma that "trivally" composes the compq_quotient maps. We need the quotient_cast map to <br>
--make the equality between quotients by ideals wich are equal but not equal by def. </p>
<p>lemma compq_quotient_assoc (p: polynomial R) (q : polynomial R) (I:ideal $ polynomial R) :<br>
(quotient_cast (le_of_eq (comp_ideal_assoc p q I))).comp ( (compq_quotient q (comp_ideal p I) ).comp (compq_quotient p I))=<br>
compq_quotient (p.comp q) I :=<br>
begin<br>
    dsimp [compq_quotient, quotient_cast],<br>
    repeat {rw quotient_map_assoc},<br>
    congr',<br>
    simp,<br>
    rw compq_assoc,  --goal accomplished but deterministic timeout<br>
end</p>
<p>lemma compq_quotient_assoc' (p: polynomial R) (q : polynomial R) (I:ideal $ polynomial R) :<br>
(quotient_cast (le_of_eq (comp_ideal_assoc p q I))).comp ( (compq_quotient q (comp_ideal p I) ).comp (compq_quotient p I))=<br>
compq_quotient (p.comp q) I :=<br>
begin<br>
    apply ring_hom.ext, intro aclass, <br>
    cases ideal.quotient.mk_surjective aclass with a ha,<br>
    dsimp [quotient_cast, compq_quotient, comp_ideal, ideal.quotient_map, ideal.map],<br>
    rw ←  ha,<br>
    repeat {rw ideal.quotient.lift_mk},<br>
    simp,<br>
    dsimp [compq],<br>
    rw comp_assoc,  --works fine, but slow<br>
end</p>
</div></div>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>
</code></pre></div>



<a name="218434232"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218434232" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218434232">(Dec 01 2020 at 15:11)</a>:</h4>
<p>The faulty proof uses a lemma quotient_map_assoc on the composition of ideal.quotient_map, maybe a similar lemma already exists but the closest I could find was  ideal.comp_quotient_map_eq_of_comp_eq<br>
The lemma quotient_map_assoc does not return any error, but I fear that it's where the mess happens. It's a shame because it looks useful.</p>



<a name="218436330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218436330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218436330">(Dec 01 2020 at 15:27)</a>:</h4>
<p>The problem with the timing-out proof is <code>congr'</code> (if you put <code>sorry</code> immediately after the <code>congr'</code> you get the timeout).</p>



<a name="218438877"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218438877" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218438877">(Dec 01 2020 at 15:45)</a>:</h4>
<p>Indeed, but there may still be a mess earlier. When I get rid of the congr' and I try to do a rw, I get a "motive is not type correct". With simp_rw, the goal accomplished+timeout is back : </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">begin</span>
    <span class="n">dsimp</span> <span class="o">[</span><span class="n">compq_quotient</span><span class="o">,</span> <span class="n">quotient_cast</span><span class="o">],</span>
    <span class="n">repeat</span> <span class="o">{</span><span class="n">rw</span> <span class="n">quotient_map_assoc</span><span class="o">},</span>
    <span class="n">simp</span><span class="o">,</span>
     <span class="n">simp_rw</span> <span class="n">compq_assoc</span> <span class="n">q</span> <span class="n">p</span><span class="o">,</span>  <span class="c1">-- rw gives a "motive is not type correct" error, so I use simp_rw</span>
    <span class="n">refl</span><span class="o">,</span> <span class="c1">--ga +timeout</span>
<span class="kd">end</span>
</code></pre></div>



<a name="218444943"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218444943" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218444943">(Dec 01 2020 at 16:20)</a>:</h4>
<p>you need four backticks for the spoiler tag if you want to put code in it</p>



<a name="218445390"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218445390" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218445390">(Dec 01 2020 at 16:23)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> thanks, it's done.</p>



<a name="218445686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218445686" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218445686">(Dec 01 2020 at 16:25)</a>:</h4>
<p>There is no coloration though.</p>



<a name="218445734"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218445734" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218445734">(Dec 01 2020 at 16:25)</a>:</h4>
<p>you need <code> ```lean </code> probably</p>



<a name="218445837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218445837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218445837">(Dec 01 2020 at 16:26)</a>:</h4>
<p>it's set as the default language in this zulip instance but I guess it doesn't work under spoiler tags</p>



<a name="218446688"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218446688" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218446688">(Dec 01 2020 at 16:32)</a>:</h4>
<p>Indeed color is back !</p>



<a name="218451271"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218451271" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218451271">(Dec 01 2020 at 17:02)</a>:</h4>
<p>I think I understand the problem a bit more, having tested different things. I think it lies in the argument <code> (hIJ : I ≤ ideal.comap f J)</code> of ideal.quotient_map . In VSCode, this argument is hidden in the current goal during the proof (but I get to see it if I hover on it). I think the rw tactics fails because if it replaces an expression in the first argument of quotient_map but does not modify it in the second argument, the obtained expression makes no sense. I suppose simp_rw and congr' both have a faulty treatment of this second argument. This is why taking a representative with ideal.quotient.mk_surjective and proving things outside of the quotient works in the second proof.</p>



<a name="218452308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218452308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218452308">(Dec 01 2020 at 17:10)</a>:</h4>
<p>So far I've managed to reduce the bad <code>congr'</code> proof to this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">p</span> <span class="n">q</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">I</span> <span class="o">:</span> <span class="n">ideal</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">))</span>
  <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">≤</span> <span class="n">ideal.comap</span>
    <span class="o">((</span><span class="n">ring_hom.id</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">))</span><span class="bp">.</span><span class="n">comp</span> <span class="o">((</span><span class="n">compq</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="o">(</span><span class="n">compq</span> <span class="n">p</span><span class="o">)))</span>
    <span class="o">(</span><span class="n">comp_ideal</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">)</span> <span class="n">I</span><span class="o">))</span>
  <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">≤</span> <span class="n">ideal.comap</span> <span class="o">(</span><span class="n">compq</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">))</span> <span class="o">(</span><span class="n">comp_ideal</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">)</span> <span class="n">I</span><span class="o">))</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">comp_ideal</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">)</span> <span class="n">I</span><span class="o">)</span><span class="bp">.</span><span class="n">quotient_map</span>
    <span class="o">((</span><span class="n">ring_hom.id</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">))</span><span class="bp">.</span><span class="n">comp</span> <span class="o">((</span><span class="n">compq</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="o">(</span><span class="n">compq</span> <span class="n">p</span><span class="o">)))</span> <span class="n">h1</span> <span class="bp">=</span>
  <span class="o">(</span><span class="n">comp_ideal</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">)</span> <span class="n">I</span><span class="o">)</span><span class="bp">.</span><span class="n">quotient_map</span> <span class="o">(</span><span class="n">compq</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">))</span> <span class="n">h2</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="k">have</span> <span class="n">H_congr_lemma</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="n">ideal</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">)}</span> <span class="o">(</span><span class="n">J</span> <span class="o">:</span> <span class="n">ideal</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">))</span>
    <span class="o">(</span><span class="n">f</span> <span class="n">f_1</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span> <span class="bp">→+*</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">e_3</span> <span class="o">:</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">f_1</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hIJ</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">≤</span> <span class="n">ideal.comap</span> <span class="n">f</span> <span class="n">J</span><span class="o">)</span> <span class="o">(</span><span class="n">hIJ_1</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">≤</span> <span class="n">ideal.comap</span> <span class="n">f_1</span> <span class="n">J</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">I</span> <span class="n">J</span> <span class="o">:</span> <span class="n">ideal</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">))</span> <span class="o">(</span><span class="n">f</span> <span class="n">f_1</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span> <span class="bp">→+*</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">e_3</span> <span class="o">:</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">f_1</span><span class="o">)</span>
   <span class="o">(</span><span class="n">hIJ</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">≤</span> <span class="n">ideal.comap</span> <span class="n">f</span> <span class="n">J</span><span class="o">),</span>
     <span class="bp">@</span><span class="n">eq.drec</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span> <span class="bp">→+*</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="n">f</span>
       <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">f_1</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span> <span class="bp">→+*</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">e_3</span> <span class="o">:</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">f_1</span><span class="o">),</span>
          <span class="n">J.quotient_map</span> <span class="n">f</span> <span class="n">hIJ</span> <span class="bp">=</span> <span class="n">J.quotient_map</span> <span class="n">f_1</span>
              <span class="o">(</span><span class="bp">@</span><span class="n">eq.rec</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span> <span class="bp">→+*</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="n">f</span>
                 <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span> <span class="bp">→+*</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">),</span> <span class="n">I</span> <span class="bp">≤</span> <span class="n">ideal.comap</span> <span class="n">f</span> <span class="n">J</span><span class="o">)</span>
                 <span class="n">hIJ</span> <span class="n">f_1</span> <span class="n">e_3</span><span class="o">))</span>
       <span class="n">rfl</span> <span class="n">f_1</span> <span class="n">e_3</span><span class="o">)</span>
    <span class="n">I</span> <span class="n">J</span> <span class="n">f</span> <span class="n">f_1</span> <span class="n">e_3</span> <span class="n">hIJ</span><span class="o">,</span>
  <span class="k">have</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">H_congr_lemma</span> <span class="n">I</span> <span class="o">(</span><span class="n">comp_ideal</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">)</span> <span class="n">I</span><span class="o">)</span>
    <span class="o">((</span><span class="n">ring_hom.id</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">))</span><span class="bp">.</span><span class="n">comp</span> <span class="o">((</span><span class="n">compq</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="o">(</span><span class="n">compq</span> <span class="n">p</span><span class="o">)))</span>
    <span class="o">(</span><span class="n">compq</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">))</span>
    <span class="n">sorry</span>
    <span class="n">h1</span>
    <span class="n">h2</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">this</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="218452405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218452405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218452405">(Dec 01 2020 at 17:10)</a>:</h4>
<p>The theorem statement is the state immediately before <code>congr'</code>. AFAICT it typechecks, so rw is not to blame</p>



<a name="218452644"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218452644" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218452644">(Dec 01 2020 at 17:12)</a>:</h4>
<p>The <code>H_congr_lemma</code> is the proof generated by <code>congr'</code>. It also typechecks, but applying the proof (which is the final <code>have</code> and <code>exact this</code>) fails. I notice that the type of the <code>have</code> is not literally the same as the goal, it produces something other than <code>h2</code> on the rhs</p>



<a name="218454210"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218454210" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218454210">(Dec 01 2020 at 17:24)</a>:</h4>
<p>Nice ! I should learn how to get these generated proofs. I did not mean to say that rw was to blame, I meant that it cannot be applied because of the second argument, and this is why I was cornered into using congr' in the first place.</p>



<a name="218458110"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218458110" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218458110">(Dec 01 2020 at 17:56)</a>:</h4>
<p>I've written a lemma to replace the sorry, in your code, to be sure it was not interfering. The second <code>have</code> produces </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">(</span><span class="n">comp_ideal</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">)</span> <span class="n">I</span><span class="o">)</span><span class="bp">.</span><span class="n">quotient_map</span> <span class="o">((</span><span class="n">ring_hom.id</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">))</span><span class="bp">.</span><span class="n">comp</span> <span class="o">((</span><span class="n">compq</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="o">(</span><span class="n">compq</span> <span class="n">p</span><span class="o">)))</span> <span class="n">h1</span> <span class="bp">=</span>
<span class="o">(</span><span class="n">comp_ideal</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">)</span> <span class="n">I</span><span class="o">)</span><span class="bp">.</span><span class="n">quotient_map</span> <span class="o">(</span><span class="n">compq</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">))</span> <span class="n">_</span>
</code></pre></div>
<p>where _ is of type</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span> <span class="bp">→+*</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">),</span> <span class="n">I</span> <span class="bp">≤</span> <span class="n">ideal.comap</span> <span class="n">f</span> <span class="o">(</span><span class="n">comp_ideal</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">)</span> <span class="n">I</span><span class="o">))</span>  <span class="o">(</span><span class="n">compq</span> <span class="o">(</span><span class="n">p.comp</span> <span class="n">q</span><span class="o">))</span>
</code></pre></div>
<p>Implementing the substitution (i.e. replacing f by (compq (p.comp q) ) in the expression) gives the type of h2. This type is equal to the type of h2, but not definitionally (edit : no, they are defeq) ! This problem, again. Does this mean there is some <code>heq</code> issue in <code>congr'</code> ?</p>



<a name="218458202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218458202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218458202">(Dec 01 2020 at 17:56)</a>:</h4>
<p>are you sure it is not defeq? I tried the same thing and <code>rfl</code> proves they are equal</p>



<a name="218458329"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218458329" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218458329">(Dec 01 2020 at 17:57)</a>:</h4>
<p>Okay, they are defeq. Why is this not <code>h2</code> then ?</p>



<a name="218458407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218458407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218458407">(Dec 01 2020 at 17:58)</a>:</h4>
<p>it is, I'm pretty sure</p>



<a name="218458452"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218458452" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218458452">(Dec 01 2020 at 17:58)</a>:</h4>
<p>but I also have evidence that lean is unfolding lots of things and I'm not sure why yet</p>



<a name="218458495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218458495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218458495">(Dec 01 2020 at 17:58)</a>:</h4>
<p>for example, the error goes away if you make <code>ring_hom.id</code> an axiom</p>



<a name="218462118"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218462118" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218462118">(Dec 01 2020 at 18:26)</a>:</h4>
<p>More minimized:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">data.polynomial.eval</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">p</span> <span class="n">q</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span>
  <span class="o">(</span><span class="n">P</span> <span class="o">:</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="n">P</span> <span class="n">p.comp</span><span class="o">)</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">P</span> <span class="n">q.comp</span><span class="o">)</span> <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="n">p.comp</span> <span class="bp">=</span> <span class="n">q.comp</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">eq.rec</span> <span class="n">h1</span> <span class="n">e</span> <span class="o">:</span> <span class="n">P</span> <span class="n">q.comp</span><span class="o">)</span> <span class="bp">=</span> <span class="n">h2</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="o">{</span><span class="n">change</span> <span class="n">h2</span> <span class="bp">=</span> <span class="n">h2</span><span class="o">,</span> <span class="n">exact</span> <span class="n">rfl</span><span class="o">}</span>
</code></pre></div>



<a name="218462193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218462193" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218462193">(Dec 01 2020 at 18:27)</a>:</h4>
<p>the weird thing is that the <code>change</code> works but the <code>exact</code> doesn't, meaning that the elaborator and kernel disagree about the defeq</p>



<a name="218464685"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218464685" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218464685">(Dec 01 2020 at 18:48)</a>:</h4>
<p>So it is indeed a problem of defeq on the type of h2 ? Very strange indeed.</p>



<a name="218464771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218464771" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218464771">(Dec 01 2020 at 18:49)</a>:</h4>
<p>is anything <code>irreducible</code> today?</p>



<a name="218464799"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218464799" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218464799">(Dec 01 2020 at 18:49)</a>:</h4>
<p><code>polynomial.comp</code> appears to be today's culprit</p>



<a name="218464927"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218464927" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218464927">(Dec 01 2020 at 18:50)</a>:</h4>
<p>it still doesn't make any sense to me that this would be unfolded though</p>



<a name="218464998"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218464998" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218464998">(Dec 01 2020 at 18:50)</a>:</h4>
<p>This looks similar to the other weirdness then</p>



<a name="218465009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218465009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218465009">(Dec 01 2020 at 18:51)</a>:</h4>
<p>amusingly, lean is totally fine with the proof <code>proof_irrel _ _</code></p>



<a name="218465031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218465031" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218465031">(Dec 01 2020 at 18:51)</a>:</h4>
<p>in that, putting everything else aside, <span aria-label="this" class="emoji emoji-1f446" role="img" title="this">:this:</span> both sides of the equality are propositions</p>



<a name="218465236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218465236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218465236">(Dec 01 2020 at 18:53)</a>:</h4>
<p>actually <code>eval₂</code> looks like a better candidate for irreducibility</p>



<a name="218465294"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218465294" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218465294">(Dec 01 2020 at 18:53)</a>:</h4>
<p>also finsupp.sum</p>



<a name="218465310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218465310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218465310">(Dec 01 2020 at 18:53)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/blob/b7649bcd2d4db889ae2651637e2c8969c89f4c1f/src/data/polynomial/eval.lean#L479-L485">https://github.com/leanprover-community/mathlib/blob/b7649bcd2d4db889ae2651637e2c8969c89f4c1f/src/data/polynomial/eval.lean#L479-L485</a></p>



<a name="218465345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218465345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218465345">(Dec 01 2020 at 18:54)</a>:</h4>
<p>or do you mean better than <code>tensor_algebra</code> or whatever it was</p>



<a name="218465410"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218465410" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218465410">(Dec 01 2020 at 18:54)</a>:</h4>
<p>oh curious</p>



<a name="218465727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218465727" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218465727">(Dec 01 2020 at 18:56)</a>:</h4>
<p>(For <span class="user-mention" data-user-id="349646">@Simon Andreys</span> and others, I'm referring to <a href="#narrow/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup/near/218215493">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup/near/218215493</a>)</p>



<a name="218465904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218465904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218465904">(Dec 01 2020 at 18:58)</a>:</h4>
<p>Uh oh:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">data.polynomial.eval</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">p</span> <span class="n">q</span> <span class="n">r</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span>
  <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→+*</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span>
  <span class="o">(</span><span class="n">P</span> <span class="o">:</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="n">P</span> <span class="o">(</span><span class="n">p.eval₂</span> <span class="n">c</span> <span class="n">q</span><span class="o">))</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">P</span> <span class="o">(</span><span class="n">p.eval₂</span> <span class="n">c</span> <span class="n">r</span><span class="o">))</span>
  <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="o">(</span><span class="n">p.eval₂</span> <span class="n">c</span> <span class="n">q</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">p.eval₂</span> <span class="n">c</span> <span class="n">r</span><span class="o">))</span> <span class="o">:</span>
  <span class="n">h2</span> <span class="bp">=</span> <span class="n">eq.rec</span> <span class="n">h1</span> <span class="n">e</span> <span class="o">:=</span> <span class="n">rfl</span> <span class="c1">-- timeout</span>
</code></pre></div>
<p>irreducibility may not be good enough</p>



<a name="218467049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218467049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218467049">(Dec 01 2020 at 19:06)</a>:</h4>
<p>Aha, it's not <code>eval2</code> that's the problem, it's fine if you use <code>eval2</code> over another semiring. It's the <code>polynomial R</code> semiring instance</p>



<a name="218467303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218467303" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218467303">(Dec 01 2020 at 19:09)</a>:</h4>
<p>or at least, it's the combination of the two</p>



<a name="218468150"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218468150" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218468150">(Dec 01 2020 at 19:16)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">data.polynomial.basic</span>

<span class="kd">@[irreducible]</span> <span class="kd">def</span> <span class="n">polynomial.eval₂'</span> <span class="o">{</span><span class="n">R</span> <span class="n">S</span><span class="o">}</span> <span class="o">[</span><span class="n">semiring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">semiring</span> <span class="n">S</span><span class="o">]</span>
  <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">S</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">S</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span> <span class="n">S</span> <span class="o">:=</span>
<span class="n">p.sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">_</span> <span class="n">a</span><span class="o">,</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">x</span><span class="o">)</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">R</span> <span class="n">S</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">semiring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">semiring</span> <span class="n">S</span><span class="o">]</span>
  <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">polynomial</span> <span class="n">S</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">S</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span> <span class="n">q</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span>
  <span class="o">(</span><span class="n">P</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">S</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="n">P</span> <span class="o">(</span><span class="n">p.eval₂'</span> <span class="n">f</span> <span class="n">x</span><span class="o">))</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">P</span> <span class="o">(</span><span class="n">q.eval₂'</span> <span class="n">f</span> <span class="n">x</span><span class="o">))</span>
  <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="o">(</span><span class="n">p.eval₂'</span> <span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">q.eval₂'</span> <span class="n">f</span> <span class="n">x</span><span class="o">))</span> <span class="o">:</span>
  <span class="n">h2</span> <span class="bp">=</span> <span class="n">eq.rec</span> <span class="n">h1</span> <span class="n">e</span> <span class="o">:=</span> <span class="n">rfl</span>
</code></pre></div>
<p>Replacing the definition of <code>eval₂'</code> with <code>sorry</code> makes it work, so clearly lean is reducing the irreducible</p>



<a name="218489736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218489736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218489736">(Dec 01 2020 at 22:13)</a>:</h4>
<p>The issue is quite out of my scope, but what I gather is that the elaborator does reduce some expression while the compilator doesn't (or the other way around ?), and this problem was already raised before and is linked with the irreducible tag. It's reassuring in some way, since I kinda understand what may cause it (some Prop in the parameters of a function is wrongly typed by some tactic), and how to work around (unfold and dsimp, and use low level lemmas, as unpleasant it may be). Better even, the root problem may be solved at some point and the "high" level proof be efficient again.</p>



<a name="218766291"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/deterministic%20timeout%20%2B%20goal%20accomplished/near/218766291" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Andreys <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/deterministic.20timeout.20.2B.20goal.20accomplished.html#218766291">(Dec 03 2020 at 22:52)</a>:</h4>
<p>I was overly optimistic when saying that I knew how to work around the problem : it resurfaced at the next lemma. I will use a less composite approach to construct the isomorphism I want.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>