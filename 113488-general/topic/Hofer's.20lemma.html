---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/Hofer's.20lemma.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html">Hofer's lemma</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="199311266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199311266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199311266">(May 31 2020 at 16:09)</a>:</h4>
<p>Wow so what's the de Bruijn factor here?</p>



<a name="199311476"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199311476" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199311476">(May 31 2020 at 16:16)</a>:</h4>
<p>~ 70/7 = 10 ??</p>



<a name="199311518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199311518" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199311518">(May 31 2020 at 16:17)</a>:</h4>
<p>The gzipped size of Mario's proof is 1764 bytes and the gzipped size of the corresponding LaTeX source is 606 bytes. Based on that the de Bruijn factor is 2.91.</p>
<p>(Here's the bit of the LaTeX I used):</p>
<div class="codehilite"><pre><span></span><code><span class="k">\begin</span><span class="nb">{</span>lemma<span class="nb">}</span>[Hofer]
<span class="k">\label</span><span class="nb">{</span>lemma:Hofer<span class="nb">}</span>
Suppose <span class="s">$</span><span class="o">(</span><span class="nb">X,d</span><span class="o">)</span><span class="s">$</span> is a complete metric space, <span class="s">$</span><span class="nb">g : X </span><span class="nv">\to</span><span class="nb"> </span><span class="o">[</span><span class="m">0</span><span class="nb">,</span><span class="nv">\infty</span><span class="o">)</span><span class="s">$</span> is
continuous, <span class="s">$</span><span class="nb">x_</span><span class="m">0</span><span class="nb"> </span><span class="nv">\in</span><span class="nb"> X</span><span class="s">$</span> and <span class="s">$</span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">0</span><span class="nb"> &gt; </span><span class="m">0</span><span class="s">$</span>.  Then there exist
<span class="s">$</span><span class="nb">x </span><span class="nv">\in</span><span class="nb"> X</span><span class="s">$</span> and <span class="s">$</span><span class="nv">\epsilon</span><span class="nb"> &gt; </span><span class="m">0</span><span class="s">$</span> such that,
<span class="k">\begin</span><span class="nb">{</span>enumerate<span class="nb">}</span>
<span class="k">\renewcommand</span><span class="nb">{</span><span class="k">\labelenumi</span><span class="nb">}{</span>(<span class="k">\alph</span><span class="nb">{</span>enumi<span class="nb">}</span>)<span class="nb">}</span>
<span class="k">\item</span> <span class="s">$</span><span class="nv">\epsilon</span><span class="nb"> </span><span class="nv">\le</span><span class="nb"> </span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">0</span><span class="s">$</span>,
<span class="k">\item</span> <span class="s">$</span><span class="nb">g</span><span class="o">(</span><span class="nb">x</span><span class="o">)</span><span class="nb"> </span><span class="nv">\epsilon</span><span class="nb"> </span><span class="nv">\ge</span><span class="nb"> g</span><span class="o">(</span><span class="nb">x_</span><span class="m">0</span><span class="o">)</span><span class="nb"> </span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">0</span><span class="s">$</span>,
<span class="k">\item</span> <span class="s">$</span><span class="nb">d</span><span class="o">(</span><span class="nb">x,x_</span><span class="m">0</span><span class="o">)</span><span class="nb"> </span><span class="nv">\le</span><span class="nb"> </span><span class="m">2</span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">0</span><span class="s">$</span>, and
<span class="k">\item</span> <span class="s">$</span><span class="nb">g</span><span class="o">(</span><span class="nb">y</span><span class="o">)</span><span class="nb"> </span><span class="nv">\le</span><span class="nb"> </span><span class="m">2</span><span class="nb"> g</span><span class="o">(</span><span class="nb">x</span><span class="o">)</span><span class="s">$</span> for all <span class="s">$</span><span class="nb">y </span><span class="nv">\in</span><span class="nb"> </span><span class="nv">\overline</span><span class="nb">{B_</span><span class="nv">\epsilon</span><span class="o">(</span><span class="nb">x</span><span class="o">)</span><span class="nb">}</span><span class="s">$</span>.
<span class="k">\end</span><span class="nb">{</span>enumerate<span class="nb">}</span>
<span class="k">\end</span><span class="nb">{</span>lemma<span class="nb">}</span>
<span class="k">\begin</span><span class="nb">{</span>proof<span class="nb">}</span>
If there is no <span class="s">$</span><span class="nb">x_</span><span class="m">1</span><span class="nb"> </span><span class="nv">\in</span><span class="nb"> </span><span class="nv">\overline</span><span class="nb">{B_{</span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">0</span><span class="nb">}</span><span class="o">(</span><span class="nb">x_</span><span class="m">0</span><span class="o">)</span><span class="nb">}</span><span class="s">$</span> such that
<span class="s">$</span><span class="nb">g</span><span class="o">(</span><span class="nb">x_</span><span class="m">1</span><span class="o">)</span><span class="nb"> &gt; </span><span class="m">2</span><span class="nb"> g</span><span class="o">(</span><span class="nb">x_</span><span class="m">0</span><span class="o">)</span><span class="s">$</span>, then we can set <span class="s">$</span><span class="nb">x </span><span class="o">=</span><span class="nb"> x_</span><span class="m">0</span><span class="s">$</span> and <span class="s">$</span><span class="nv">\epsilon</span><span class="nb"> </span><span class="o">=</span><span class="nb"> </span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">0</span><span class="s">$</span>
and are done.  If such a point~<span class="s">$</span><span class="nb">x_</span><span class="m">1</span><span class="s">$</span> does exist, then we
set <span class="s">$</span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">1</span><span class="nb"> :</span><span class="o">=</span><span class="nb"> </span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">0</span><span class="nb"> </span><span class="o">/</span><span class="nb"> </span><span class="m">2</span><span class="s">$</span> and repeat the above process for the
pair <span class="s">$</span><span class="o">(</span><span class="nb">x_</span><span class="m">1</span><span class="nb">,</span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">1</span><span class="o">)</span><span class="s">$</span>: that is, if there is no <span class="s">$</span><span class="nb">x_</span><span class="m">2</span><span class="nb"> </span><span class="nv">\in</span><span class="nb"></span>
<span class="nv">\overline</span><span class="nb">{B_{</span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">1</span><span class="nb">}</span><span class="o">(</span><span class="nb">x_</span><span class="m">1</span><span class="o">)</span><span class="nb">}</span><span class="s">$</span> with <span class="s">$</span><span class="nb">g</span><span class="o">(</span><span class="nb">x_</span><span class="m">2</span><span class="o">)</span><span class="nb"> &gt; </span><span class="m">2</span><span class="nb"> g</span><span class="o">(</span><span class="nb">x_</span><span class="m">1</span><span class="o">)</span><span class="s">$</span>, we set
<span class="s">$</span><span class="o">(</span><span class="nb">x,</span><span class="nv">\epsilon</span><span class="o">)</span><span class="nb"> </span><span class="o">=</span><span class="nb"> </span><span class="o">(</span><span class="nb">x_</span><span class="m">1</span><span class="nb">,</span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">1</span><span class="o">)</span><span class="s">$</span> and are finished, and
otherwise define <span class="s">$</span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">2</span><span class="nb"> </span><span class="o">=</span><span class="nb"> </span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">1</span><span class="nb"> </span><span class="o">/</span><span class="nb"> </span><span class="m">2</span><span class="s">$</span> and repeat for
<span class="s">$</span><span class="o">(</span><span class="nb">x_</span><span class="m">2</span><span class="nb">,</span><span class="nv">\epsilon</span><span class="nb">_</span><span class="m">2</span><span class="o">)</span><span class="s">$</span>.  This process must eventually terminate, as otherwise
we obtain a Cauchy sequence <span class="s">$</span><span class="nb">x_n</span><span class="s">$</span> with <span class="s">$</span><span class="nb">g</span><span class="o">(</span><span class="nb">x_n</span><span class="o">)</span><span class="nb"> </span><span class="nv">\to</span><span class="nb"> </span><span class="nv">\infty</span><span class="s">$</span>, which is
impossible if~<span class="s">$</span><span class="nb">X</span><span class="s">$</span> is complete.
<span class="k">\end</span><span class="nb">{</span>proof<span class="nb">}</span>
</code></pre></div>



<a name="199311593"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199311593" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199311593">(May 31 2020 at 16:18)</a>:</h4>
<p>This follows (my interpretation of) <a href="https://www.cs.ru.nl/~freek/factor/">the rules on Freek Wiedijk's page</a>.</p>



<a name="199312008"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199312008" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199312008">(May 31 2020 at 16:31)</a>:</h4>
<p>Oh so it is better than I (and Johan) thought!</p>



<a name="199312010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199312010" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199312010">(May 31 2020 at 16:31)</a>:</h4>
<p>I just counted lines... roughly</p>



<a name="199312016"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199312016" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199312016">(May 31 2020 at 16:31)</a>:</h4>
<p>Right, so did i</p>



<a name="199312712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199312712" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199312712">(May 31 2020 at 16:53)</a>:</h4>
<p>I'm still working on getting a nicer proof. But each time I think I'm almost done, there is something very slightly off.</p>



<a name="199315014"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199315014" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Wärn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199315014">(May 31 2020 at 18:02)</a>:</h4>
<p>For what it's worth, here is an approach that avoids <code>classical.epsilon</code> by using a predicate on <code>X x R</code> which guarantees that we can safely move to the next step.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">topology</span><span class="bp">.</span><span class="n">metric_space</span><span class="bp">.</span><span class="n">basic</span>
<span class="n">open_locale</span> <span class="n">classical</span> <span class="n">topological_space</span>

<span class="kn">lemma</span> <span class="n">hofer</span> <span class="o">{</span><span class="n">X</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">metric_space</span> <span class="n">X</span><span class="o">]</span> <span class="o">[</span><span class="n">complete_space</span> <span class="n">X</span><span class="o">]</span>
  <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">(</span><span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">(</span><span class="n">ε_pos</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">ε</span><span class="o">)</span>
  <span class="o">{</span><span class="n">φ</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">cont</span> <span class="o">:</span> <span class="n">continuous</span> <span class="n">φ</span><span class="o">)</span> <span class="o">(</span><span class="n">nonneg</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="n">x</span><span class="o">)</span> <span class="o">:</span>
<span class="bp">∃</span> <span class="o">(</span><span class="n">ε&#39;</span> <span class="bp">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">x&#39;</span> <span class="o">:</span> <span class="n">X</span><span class="o">),</span> <span class="n">ε&#39;</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">∧</span>
                   <span class="n">dist</span> <span class="n">x&#39;</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span><span class="bp">*</span><span class="n">ε</span> <span class="bp">∧</span>
                   <span class="n">ε</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">ε&#39;</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x&#39;</span> <span class="bp">∧</span>
                   <span class="bp">∀</span> <span class="n">y</span><span class="o">,</span> <span class="n">dist</span> <span class="n">x&#39;</span> <span class="n">y</span> <span class="bp">≤</span> <span class="n">ε&#39;</span> <span class="bp">→</span> <span class="n">φ</span> <span class="n">y</span> <span class="bp">≤</span> <span class="mi">2</span><span class="bp">*</span><span class="n">φ</span> <span class="n">x&#39;</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">by_contra</span> <span class="n">H</span><span class="o">,</span>
  <span class="n">set</span> <span class="n">Y</span> <span class="o">:</span> <span class="n">set</span> <span class="o">(</span><span class="n">X</span> <span class="bp">×</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:=</span>
    <span class="o">{</span> <span class="n">p</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">×</span> <span class="n">ℝ</span> <span class="bp">|</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">p</span><span class="bp">.</span><span class="mi">2</span> <span class="bp">∧</span> <span class="n">p</span><span class="bp">.</span><span class="mi">2</span> <span class="bp">≤</span> <span class="n">ε</span>
                <span class="bp">∧</span> <span class="n">dist</span> <span class="n">p</span><span class="bp">.</span><span class="mi">1</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span> <span class="bp">-</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">p</span><span class="bp">.</span><span class="mi">2</span>
                <span class="bp">∧</span> <span class="n">ε</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">p</span><span class="bp">.</span><span class="mi">2</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">p</span><span class="bp">.</span><span class="mi">1</span> <span class="o">},</span>
  <span class="k">have</span> <span class="n">xε_mem_Y</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">ε</span><span class="o">)</span> <span class="err">∈</span> <span class="n">Y</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">ε_pos</span><span class="o">,</span> <span class="n">le_refl</span> <span class="bp">_</span><span class="o">,</span> <span class="k">by</span> <span class="n">simp</span><span class="o">,</span> <span class="n">le_refl</span> <span class="bp">_⟩</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">dist_le_2ε</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">p</span> <span class="err">∈</span> <span class="n">Y</span><span class="o">),</span> <span class="n">dist</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="mi">1</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">y</span><span class="o">,</span> <span class="n">r</span><span class="bp">⟩</span> <span class="bp">⟨</span><span class="n">r_pos</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">hd</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span>
    <span class="k">calc</span> <span class="n">dist</span> <span class="n">y</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span> <span class="bp">-</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">r</span> <span class="o">:</span> <span class="n">hd</span>
              <span class="bp">...</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span>         <span class="o">:</span> <span class="k">by</span> <span class="n">linarith</span> <span class="o">},</span>
  <span class="k">have</span> <span class="n">key</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">Y</span><span class="o">),</span> <span class="bp">∃</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">Y</span><span class="o">),</span> <span class="n">dist</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">val</span><span class="bp">.</span><span class="mi">1</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="n">q</span><span class="bp">.</span><span class="n">val</span><span class="bp">.</span><span class="mi">1</span> <span class="bp">≤</span> <span class="n">p</span><span class="bp">.</span><span class="n">val</span><span class="bp">.</span><span class="mi">2</span>
                              <span class="bp">∧</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">p</span><span class="bp">.</span><span class="n">val</span><span class="bp">.</span><span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">φ</span> <span class="n">q</span><span class="bp">.</span><span class="n">val</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨⟨</span><span class="n">y</span><span class="o">,</span> <span class="n">r</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">r_pos</span><span class="o">,</span> <span class="n">r_le</span><span class="o">,</span> <span class="n">hd</span><span class="o">,</span> <span class="n">hp</span><span class="bp">⟩</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">hyr</span> <span class="o">:</span> <span class="o">(</span><span class="n">y</span><span class="o">,</span> <span class="n">r</span><span class="o">)</span> <span class="err">∈</span> <span class="n">Y</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">r_pos</span><span class="o">,</span> <span class="n">r_le</span><span class="o">,</span> <span class="n">hd</span><span class="o">,</span> <span class="n">hp</span><span class="bp">⟩</span><span class="o">,</span>
    <span class="n">by_contra</span> <span class="n">N</span><span class="o">,</span>
    <span class="n">apply</span> <span class="n">H</span><span class="o">,</span>
    <span class="n">refine</span> <span class="bp">⟨</span><span class="n">r</span><span class="o">,</span> <span class="n">r_pos</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">r_le</span><span class="o">,</span> <span class="n">dist_le_2ε</span> <span class="bp">_</span> <span class="n">hyr</span><span class="o">,</span> <span class="n">hp</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span>
    <span class="n">intros</span> <span class="n">z</span> <span class="n">hz</span><span class="o">,</span>
    <span class="n">push_neg</span> <span class="n">at</span> <span class="n">N</span><span class="o">,</span>
    <span class="n">by_contra</span> <span class="n">b</span><span class="o">,</span>
    <span class="n">push_neg</span> <span class="n">at</span> <span class="n">b</span><span class="o">,</span>
    <span class="k">have</span> <span class="o">:</span> <span class="o">(</span><span class="n">z</span><span class="o">,</span> <span class="n">r</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span> <span class="err">∈</span> <span class="n">Y</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">refine</span> <span class="bp">⟨</span><span class="n">half_pos</span> <span class="n">r_pos</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span>
      <span class="k">calc</span> <span class="n">r</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">≤</span> <span class="n">r</span> <span class="o">:</span> <span class="k">by</span> <span class="n">linarith</span>
             <span class="bp">...</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="o">:</span> <span class="n">r_le</span><span class="o">,</span>
      <span class="k">calc</span> <span class="n">dist</span> <span class="n">z</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">dist</span> <span class="n">y</span> <span class="n">z</span> <span class="bp">+</span> <span class="n">dist</span> <span class="n">y</span> <span class="n">x</span> <span class="o">:</span> <span class="n">dist_triangle_left</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span>
                <span class="bp">...</span> <span class="bp">≤</span> <span class="n">r</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span> <span class="bp">-</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">r</span><span class="o">)</span> <span class="o">:</span> <span class="n">add_le_add</span> <span class="n">hz</span> <span class="n">hd</span>
                <span class="bp">...</span> <span class="bp">=</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span> <span class="bp">-</span> <span class="mi">2</span> <span class="bp">*</span> <span class="o">(</span><span class="n">r</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:</span> <span class="k">by</span> <span class="n">ring</span><span class="o">,</span>
      <span class="n">apply</span> <span class="n">le_of_lt</span><span class="o">,</span>
      <span class="k">calc</span> <span class="n">ε</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">r</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">y</span>             <span class="o">:</span> <span class="n">hp</span>
               <span class="bp">...</span> <span class="bp">=</span> <span class="o">(</span><span class="n">r</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">*</span> <span class="o">(</span><span class="mi">2</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span> <span class="k">by</span> <span class="n">ring</span>
               <span class="bp">...</span> <span class="bp">&lt;</span> <span class="o">(</span><span class="n">r</span> <span class="bp">/</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">z</span>       <span class="o">:</span> <span class="n">mul_lt_mul_of_pos_left</span> <span class="n">b</span> <span class="o">(</span><span class="n">half_pos</span> <span class="n">r_pos</span><span class="o">),</span> <span class="o">},</span>
    <span class="n">cases</span> <span class="n">N</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">this</span><span class="bp">⟩</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">refine</span> <span class="n">lt_irrefl</span> <span class="n">r</span> <span class="bp">_</span><span class="o">,</span>
      <span class="k">calc</span> <span class="n">r</span> <span class="bp">&lt;</span> <span class="n">dist</span> <span class="n">y</span> <span class="n">z</span> <span class="o">:</span> <span class="n">h</span>
         <span class="bp">...</span> <span class="bp">≤</span> <span class="n">r</span>        <span class="o">:</span> <span class="n">hz</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">refine</span> <span class="n">lt_irrefl</span> <span class="o">(</span><span class="n">φ</span> <span class="n">z</span><span class="o">)</span> <span class="bp">_</span><span class="o">,</span>
      <span class="k">calc</span> <span class="n">φ</span> <span class="n">z</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">y</span> <span class="o">:</span> <span class="n">h</span>
           <span class="bp">...</span> <span class="bp">&lt;</span> <span class="n">φ</span> <span class="n">z</span>     <span class="o">:</span> <span class="n">b</span> <span class="o">},</span> <span class="o">},</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">Y</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="n">classical</span><span class="bp">.</span><span class="n">some</span> <span class="o">(</span><span class="n">key</span> <span class="n">p</span><span class="o">),</span>
  <span class="n">set</span> <span class="n">xi</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">Y</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">f</span><span class="bp">^</span><span class="o">[</span><span class="n">n</span><span class="o">]</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">xε_mem_Y</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="n">sorry</span><span class="o">,</span> <span class="c">/-</span><span class="cm"> TODO: show that `φ (xi n).val.1` grows exponentially, deduce that</span>
<span class="cm">              `(xi n).val.2` decays exponentially, and hence that</span>
<span class="cm">              `dist (xi n).val.1 (xi (n+1)).val.1` decays exponentially, contradiction -/</span>
<span class="kn">end</span>
</code></pre></div>



<a name="199315186"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199315186" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Wärn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199315186">(May 31 2020 at 18:06)</a>:</h4>
<p>Having thought about this a bit, I don't think this is a case for Baire, nor for <a href="https://github.com/leanprover-community/mathlib/issues/2850">#2850</a>.</p>



<a name="199320932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199320932" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199320932">(May 31 2020 at 20:57)</a>:</h4>
<p>I have a version that I find not too bad. It uncovered a lot of small lemmas that are either holes in mathlib or proving I don't know how to search mathlib. I'd be interested to know what's already hidden somewhere.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">analysis</span><span class="bp">.</span><span class="n">specific_limits</span>
<span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">ring_exp</span>

<span class="n">open_locale</span> <span class="n">classical</span> <span class="n">topological_space</span> <span class="n">big_operators</span>
<span class="kn">open</span> <span class="n">filter</span> <span class="n">set</span> <span class="n">classical</span> <span class="n">finset</span>

<span class="n">local</span> <span class="kn">notation</span> <span class="bp">`</span><span class="n">d</span><span class="bp">`</span> <span class="o">:=</span> <span class="n">dist</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span>
<span class="kn">lemma</span> <span class="n">pos_of_div_pow_two</span> <span class="o">{</span><span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">hε</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">ε</span><span class="o">)</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">2</span><span class="bp">^</span><span class="n">k</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">div_pos</span> <span class="n">hε</span><span class="o">,</span>
  <span class="n">exact_mod_cast</span> <span class="n">nat</span><span class="bp">.</span><span class="n">pow_pos</span> <span class="o">(</span><span class="k">by</span> <span class="n">norm_num</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="n">k</span><span class="o">,</span>
<span class="kn">end</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span>
<span class="kn">lemma</span> <span class="n">nonneg_of_div_pow_two</span> <span class="o">{</span><span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">hε</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">ε</span><span class="o">)</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">2</span><span class="bp">^</span><span class="n">k</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">have</span> <span class="o">:=</span> <span class="n">pos_of_div_pow_two</span> <span class="n">hε</span> <span class="n">k</span><span class="o">,</span>
  <span class="n">linarith</span><span class="o">,</span>
<span class="kn">end</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span>
<span class="kn">lemma</span> <span class="kn">help</span> <span class="o">{</span><span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">hε</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">ε</span><span class="o">)</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">2</span><span class="bp">^</span><span class="n">k</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">have</span> <span class="o">:</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="mi">2</span><span class="bp">^</span><span class="n">k</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">apply</span> <span class="n">pow_pos</span><span class="o">,</span>
    <span class="n">norm_num</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="n">div_le_iff</span> <span class="n">this</span><span class="o">,</span>
  <span class="k">calc</span> <span class="n">ε</span> <span class="bp">=</span> <span class="n">ε</span> <span class="bp">*</span><span class="mi">1</span> <span class="o">:</span> <span class="k">by</span> <span class="n">simp</span>
      <span class="bp">...</span>  <span class="bp">≤</span> <span class="n">ε</span><span class="bp">*</span><span class="mi">2</span><span class="bp">^</span><span class="n">k</span> <span class="o">:</span> <span class="k">by</span> <span class="o">{</span><span class="n">rw</span> <span class="n">mul_le_mul_left</span> <span class="bp">_</span><span class="o">,</span> <span class="n">apply</span> <span class="n">one_le_pow_of_one_le</span><span class="o">,</span> <span class="n">norm_num</span><span class="o">,</span> <span class="n">assumption</span><span class="o">},</span>
<span class="kn">end</span>
<span class="kn">open</span> <span class="n">set</span>

<span class="kn">lemma</span> <span class="n">inf_eq_bot_iff</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">filter</span> <span class="n">α</span><span class="o">}</span> <span class="o">:</span>
  <span class="n">f</span> <span class="err">⊓</span> <span class="n">g</span> <span class="bp">=</span> <span class="err">⊥</span> <span class="bp">↔</span> <span class="bp">∃</span> <span class="n">U</span> <span class="n">V</span><span class="o">,</span> <span class="o">(</span><span class="n">U</span> <span class="err">∈</span> <span class="n">f</span><span class="o">)</span> <span class="bp">∧</span> <span class="o">(</span><span class="n">V</span> <span class="err">∈</span> <span class="n">g</span><span class="o">)</span> <span class="bp">∧</span> <span class="n">U</span> <span class="err">∩</span> <span class="n">V</span> <span class="bp">=</span> <span class="err">∅</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="err">←</span> <span class="n">not_iff_not</span><span class="o">,</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">not_exists</span><span class="o">],</span>
  <span class="n">convert</span> <span class="n">inf_ne_bot_iff</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">forall_congr</span><span class="o">,</span>
  <span class="n">intro</span> <span class="n">U</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">forall_congr</span><span class="o">,</span>
  <span class="n">intro</span> <span class="n">V</span><span class="o">,</span>
  <span class="n">rw</span> <span class="err">←</span> <span class="n">ne_empty_iff_nonempty</span> <span class="o">,</span>
  <span class="n">tauto</span><span class="o">,</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">Ioo_mem_nhds</span> <span class="o">{</span><span class="n">r</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">r</span><span class="o">)</span> <span class="o">:</span> <span class="n">Ioo</span> <span class="o">(</span><span class="n">x</span> <span class="bp">-</span> <span class="n">r</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">r</span><span class="o">)</span> <span class="err">∈</span> <span class="err">𝓝</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">simp_rw</span> <span class="o">[</span><span class="n">mem_nhds_iff_exists_Ioo_subset</span><span class="o">,</span> <span class="n">mem_Ioo</span><span class="o">],</span>
  <span class="n">refine</span> <span class="bp">⟨</span><span class="n">x</span><span class="bp">-</span><span class="n">r</span><span class="o">,</span> <span class="n">x</span><span class="bp">+</span><span class="n">r</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">subset</span><span class="bp">.</span><span class="n">refl</span> <span class="bp">_⟩</span><span class="o">,</span>
  <span class="n">split</span> <span class="bp">;</span> <span class="n">linarith</span><span class="o">,</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">Ioi_mem_at_top</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:</span> <span class="n">Ioi</span> <span class="n">x</span> <span class="err">∈</span> <span class="o">(</span><span class="n">at_top</span> <span class="o">:</span> <span class="n">filter</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">mem_sets_of_superset</span> <span class="o">(</span><span class="n">mem_at_top</span> <span class="o">(</span><span class="n">x</span><span class="bp">+</span><span class="mi">1</span><span class="o">)),</span>
  <span class="n">intros</span> <span class="n">y</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">change</span> <span class="n">x</span><span class="bp">+</span><span class="mi">1</span> <span class="bp">≤</span> <span class="n">y</span> <span class="n">at</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">mem_Ioi</span><span class="o">,</span>
  <span class="n">linarith</span><span class="o">,</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">inf_nhds_at_top</span>  <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:</span> <span class="err">𝓝</span> <span class="n">x</span> <span class="err">⊓</span> <span class="n">at_top</span> <span class="bp">=</span> <span class="err">⊥</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="n">inf_eq_bot_iff</span><span class="o">,</span>
  <span class="n">use</span> <span class="o">[</span><span class="n">Ioo</span> <span class="o">(</span><span class="n">x</span><span class="bp">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span><span class="bp">+</span><span class="mi">1</span><span class="o">),</span> <span class="n">Ioi</span> <span class="o">(</span><span class="n">x</span><span class="bp">+</span><span class="mi">2</span><span class="o">),</span> <span class="n">Ioo_mem_nhds</span> <span class="n">x</span> <span class="o">(</span><span class="k">by</span> <span class="n">norm_num</span><span class="o">),</span> <span class="n">Ioi_mem_at_top</span> <span class="bp">_</span><span class="o">],</span>
  <span class="n">ext</span> <span class="n">y</span><span class="o">,</span>
  <span class="n">simp</span><span class="o">,</span>
  <span class="n">intros</span><span class="o">,</span>
  <span class="n">linarith</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">not_tendsto_nhds_of_tendsto_at_top</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">F</span> <span class="o">:</span> <span class="n">filter</span> <span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">hF</span> <span class="o">:</span> <span class="n">F</span> <span class="bp">≠</span> <span class="err">⊥</span><span class="o">)</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">hf</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="n">f</span> <span class="n">F</span> <span class="n">at_top</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:</span>
<span class="bp">¬</span> <span class="n">tendsto</span> <span class="n">f</span> <span class="n">F</span> <span class="o">(</span><span class="err">𝓝</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">intros</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">tendsto</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="k">have</span> <span class="o">:</span> <span class="n">map</span> <span class="n">f</span> <span class="n">F</span> <span class="bp">≤</span> <span class="err">𝓝</span> <span class="n">x</span> <span class="err">⊓</span> <span class="n">at_top</span><span class="o">,</span>
    <span class="k">from</span> <span class="n">le_inf</span> <span class="n">h</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">ne_bot_of_le_ne_bot</span> <span class="o">(</span><span class="n">map_ne_bot</span> <span class="n">hF</span><span class="o">)</span> <span class="n">this</span> <span class="o">(</span><span class="n">inf_nhds_at_top</span> <span class="bp">_</span><span class="o">),</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">not_tendsto_at_top_of_tendsto_nhds</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">F</span> <span class="o">:</span> <span class="n">filter</span> <span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">hF</span> <span class="o">:</span> <span class="n">F</span> <span class="bp">≠</span> <span class="err">⊥</span><span class="o">)</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">}</span>  <span class="o">{</span><span class="n">x</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">hf</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="n">f</span> <span class="n">F</span> <span class="o">(</span><span class="err">𝓝</span> <span class="n">x</span><span class="o">))</span> <span class="o">:</span>
<span class="bp">¬</span> <span class="n">tendsto</span> <span class="n">f</span> <span class="n">F</span> <span class="n">at_top</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">h&#39;</span><span class="o">,</span> <span class="n">not_tendsto_nhds_of_tendsto_at_top</span> <span class="n">hF</span> <span class="n">h&#39;</span> <span class="n">x</span> <span class="n">hf</span>

<span class="c1">-- This is a variation on `nat.case_strong_induction_on` that doesn&#39;t pollute the goal with n.succ</span>
<span class="kn">protected</span> <span class="kn">lemma</span> <span class="n">nat</span><span class="bp">.</span><span class="n">case_strong_induction_on&#39;</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">nat</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
  <span class="o">(</span><span class="n">hz</span> <span class="o">:</span> <span class="n">p</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">(</span><span class="n">hi</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">m</span><span class="o">,</span> <span class="n">m</span> <span class="bp">≤</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">p</span> <span class="n">m</span><span class="o">)</span> <span class="bp">→</span> <span class="n">p</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">:</span> <span class="n">p</span> <span class="n">a</span> <span class="o">:=</span>
<span class="n">nat</span><span class="bp">.</span><span class="n">case_strong_induction_on</span> <span class="bp">_</span> <span class="n">hz</span> <span class="n">hi</span>

<span class="kn">lemma</span> <span class="n">geom_lt</span> <span class="o">{</span><span class="n">u</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">{</span><span class="n">k</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">hk</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">m</span> <span class="bp">≤</span> <span class="n">n</span><span class="o">,</span> <span class="n">k</span><span class="bp">*</span><span class="n">u</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">u</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">:</span>
<span class="n">k</span><span class="bp">^</span><span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">*</span><span class="n">u</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>

 <span class="n">induction</span> <span class="n">n</span> <span class="k">with</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span>
 <span class="n">simp</span><span class="o">,</span>
 <span class="n">exact</span> <span class="n">h</span> <span class="mi">0</span> <span class="o">(</span><span class="n">le_refl</span> <span class="bp">_</span><span class="o">),</span>
 <span class="k">have</span> <span class="o">:</span> <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">m</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">m</span> <span class="bp">≤</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">k</span> <span class="bp">*</span> <span class="n">u</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">u</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)),</span>
   <span class="n">intros</span> <span class="n">m</span> <span class="n">hm</span><span class="o">,</span> <span class="n">apply</span> <span class="n">h</span><span class="o">,</span> <span class="n">exact</span> <span class="n">nat</span><span class="bp">.</span><span class="n">le_succ_of_le</span> <span class="n">hm</span><span class="o">,</span>
 <span class="n">specialize</span> <span class="n">ih</span> <span class="n">this</span><span class="o">,</span>
 <span class="n">change</span> <span class="n">k</span> <span class="bp">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">*</span> <span class="n">u</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">),</span>
 <span class="n">replace</span> <span class="n">h</span> <span class="o">:</span> <span class="n">k</span> <span class="bp">*</span> <span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">le_refl</span> <span class="bp">_</span><span class="o">),</span>
 <span class="k">calc</span> <span class="n">k</span> <span class="bp">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">*</span> <span class="n">u</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">k</span><span class="bp">*</span><span class="o">(</span><span class="n">k</span> <span class="bp">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">*</span> <span class="n">u</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="k">by</span> <span class="n">ring_exp</span>
  <span class="bp">...</span> <span class="bp">&lt;</span> <span class="n">k</span><span class="bp">*</span><span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">:</span> <span class="n">mul_lt_mul_of_pos_left</span> <span class="n">ih</span> <span class="n">hk</span>
  <span class="bp">...</span> <span class="bp">&lt;</span> <span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:</span> <span class="n">h</span><span class="o">,</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_map_mul_right</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semiring</span> <span class="n">β</span><span class="o">]</span> <span class="o">{</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">}</span> <span class="o">{</span><span class="n">s</span> <span class="o">:</span> <span class="n">finset</span> <span class="n">α</span><span class="o">}</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">}</span> <span class="o">:</span>
  <span class="err">∑</span> <span class="n">a</span> <span class="k">in</span> <span class="n">s</span><span class="o">,</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">b</span> <span class="bp">=</span> <span class="o">(</span><span class="err">∑</span> <span class="n">a</span> <span class="k">in</span> <span class="n">s</span><span class="o">,</span> <span class="n">f</span> <span class="n">a</span><span class="o">)</span> <span class="bp">*</span> <span class="n">b</span> <span class="o">:=</span>
<span class="n">multiset</span><span class="bp">.</span><span class="n">sum_map_mul_right</span>

<span class="kn">lemma</span> <span class="n">sum_geometric_two_le</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="err">∑</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="k">in</span> <span class="n">range</span> <span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">/</span> <span class="o">(</span><span class="mi">2</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">))</span> <span class="bp">^</span> <span class="n">i</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">have</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">/</span> <span class="o">(</span><span class="mi">2</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">))</span> <span class="bp">^</span> <span class="n">i</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intro</span> <span class="n">i</span><span class="o">,</span> <span class="n">apply</span> <span class="n">pow_nonneg</span><span class="o">,</span> <span class="n">norm_num</span> <span class="o">},</span>
  <span class="n">convert</span> <span class="n">sum_le_tsum</span> <span class="o">(</span><span class="n">range</span> <span class="err">$</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span> <span class="bp">_</span><span class="o">,</span> <span class="n">this</span> <span class="n">i</span><span class="o">)</span> <span class="n">summable_geometric_two</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">tsum_geometric_two</span><span class="bp">.</span><span class="n">symm</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">dist_le_of_geometric_aux</span> <span class="o">{</span><span class="n">X</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">metric_space</span> <span class="n">X</span><span class="o">]</span> <span class="o">{</span><span class="n">u</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">X</span><span class="o">}</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span>
  <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">m</span> <span class="bp">≤</span> <span class="n">n</span><span class="o">,</span> <span class="n">d</span> <span class="o">(</span><span class="n">u</span> <span class="n">m</span><span class="o">)</span> <span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="n">m</span><span class="bp">+</span><span class="mi">1</span><span class="o">))</span> <span class="bp">≤</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">2</span><span class="bp">^</span><span class="n">m</span><span class="o">)</span> <span class="o">:</span> <span class="n">d</span> <span class="o">(</span><span class="n">u</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span> <span class="o">:=</span>
<span class="k">have</span> <span class="n">hε</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">ε</span><span class="o">,</span>
  <span class="k">from</span> <span class="k">calc</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">d</span> <span class="o">(</span><span class="n">u</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">:</span> <span class="n">dist_nonneg</span>
          <span class="bp">...</span> <span class="bp">≤</span> <span class="bp">_</span> <span class="o">:</span> <span class="k">by</span> <span class="n">simpa</span> <span class="kn">using</span> <span class="n">h</span> <span class="mi">0</span> <span class="o">(</span><span class="n">zero_le</span> <span class="bp">_</span><span class="o">),</span>
<span class="k">let</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">range</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
<span class="k">calc</span>
<span class="n">d</span> <span class="o">(</span><span class="n">u</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span>
    <span class="bp">≤</span> <span class="err">∑</span> <span class="n">i</span> <span class="k">in</span> <span class="n">r</span><span class="o">,</span> <span class="n">d</span> <span class="o">(</span><span class="n">u</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">u</span> <span class="err">$</span> <span class="n">i</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:</span> <span class="n">dist_le_range_sum_dist</span> <span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span>
<span class="bp">...</span> <span class="bp">≤</span> <span class="err">∑</span> <span class="n">i</span> <span class="k">in</span> <span class="n">r</span><span class="o">,</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">2</span><span class="bp">^</span><span class="n">i</span>             <span class="o">:</span> <span class="n">sum_le_sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span> <span class="n">i_in</span><span class="o">,</span> <span class="n">h</span> <span class="n">i</span> <span class="err">$</span>
                                                <span class="n">nat</span><span class="bp">.</span><span class="n">lt_succ_iff</span><span class="bp">.</span><span class="n">mp</span> <span class="err">$</span> <span class="n">finset</span><span class="bp">.</span><span class="n">mem_range</span><span class="bp">.</span><span class="n">mp</span> <span class="n">i_in</span><span class="o">)</span>
<span class="bp">...</span> <span class="bp">=</span> <span class="err">∑</span> <span class="n">i</span> <span class="k">in</span> <span class="n">r</span><span class="o">,</span> <span class="o">(</span><span class="mi">1</span><span class="bp">/</span><span class="mi">2</span><span class="o">)</span><span class="bp">^</span><span class="n">i</span><span class="bp">*</span><span class="n">ε</span>         <span class="o">:</span> <span class="k">by</span> <span class="o">{</span><span class="n">congr</span><span class="o">,</span> <span class="n">ext</span> <span class="n">i</span><span class="o">,</span> <span class="n">field_simp</span> <span class="o">}</span>
<span class="bp">...</span> <span class="bp">=</span> <span class="o">(</span><span class="err">∑</span> <span class="n">i</span> <span class="k">in</span> <span class="n">r</span><span class="o">,</span> <span class="o">(</span><span class="mi">1</span><span class="bp">/</span><span class="mi">2</span><span class="o">)</span><span class="bp">^</span><span class="n">i</span><span class="o">)</span><span class="bp">*</span><span class="n">ε</span>       <span class="o">:</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_map_mul_right</span>
<span class="bp">...</span> <span class="bp">≤</span> <span class="mi">2</span><span class="bp">*</span><span class="n">ε</span>                         <span class="o">:</span> <span class="n">mul_le_mul_of_nonneg_right</span> <span class="o">(</span><span class="n">sum_geometric_two_le</span> <span class="bp">_</span><span class="o">)</span> <span class="n">hε</span>

<span class="kn">lemma</span> <span class="n">tendsto_at_top_of_geom_lt</span> <span class="o">{</span><span class="n">v</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">{</span><span class="n">k</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">h₀</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">v</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">hk</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">k</span><span class="o">)</span>
  <span class="o">(</span><span class="n">hu</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span> <span class="n">k</span><span class="bp">*</span><span class="n">v</span> <span class="n">n</span> <span class="bp">&lt;</span> <span class="n">v</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="n">v</span> <span class="n">at_top</span> <span class="n">at_top</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">tendsto_at_top_mono</span><span class="o">,</span>
  <span class="k">show</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span> <span class="n">k</span><span class="bp">^</span><span class="n">n</span><span class="bp">*</span><span class="n">v</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">v</span> <span class="n">n</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intro</span> <span class="n">n</span><span class="o">,</span>
    <span class="n">induction</span> <span class="n">n</span> <span class="k">with</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span>
    <span class="n">simp</span><span class="o">,</span>
    <span class="k">calc</span> <span class="n">k</span> <span class="bp">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">*</span> <span class="n">v</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">k</span><span class="bp">*</span><span class="o">(</span><span class="n">k</span><span class="bp">^</span><span class="n">n</span><span class="bp">*</span><span class="n">v</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="k">by</span> <span class="n">ring_exp</span>
    <span class="bp">...</span> <span class="bp">≤</span> <span class="n">k</span><span class="bp">*</span><span class="n">v</span> <span class="n">n</span> <span class="o">:</span> <span class="n">mul_le_mul_of_nonneg_left</span> <span class="n">ih</span> <span class="o">(</span><span class="k">by</span> <span class="n">linarith</span><span class="o">)</span>
    <span class="bp">...</span> <span class="bp">≤</span> <span class="n">v</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">:</span> <span class="n">le_of_lt</span> <span class="o">(</span><span class="n">hu</span> <span class="n">n</span><span class="o">)</span> <span class="o">},</span>
  <span class="n">apply</span> <span class="n">tendsto_at_top_mul_right</span> <span class="n">h₀</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">tendsto_pow_at_top_at_top_of_gt_1</span> <span class="n">hk</span><span class="o">,</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">hofer</span> <span class="o">{</span><span class="n">X</span><span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">metric_space</span> <span class="n">X</span><span class="o">]</span> <span class="o">[</span><span class="n">complete_space</span> <span class="n">X</span><span class="o">]</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">(</span><span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">(</span><span class="n">ε_pos</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">ε</span><span class="o">)</span>
  <span class="o">{</span><span class="n">φ</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">cont</span> <span class="o">:</span> <span class="n">continuous</span> <span class="n">φ</span><span class="o">)</span> <span class="o">(</span><span class="n">nonneg</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">y</span><span class="o">,</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
<span class="bp">∃</span> <span class="o">(</span><span class="n">ε&#39;</span> <span class="bp">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">x&#39;</span> <span class="o">:</span> <span class="n">X</span><span class="o">),</span> <span class="n">ε&#39;</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">∧</span>
                   <span class="n">dist</span> <span class="n">x&#39;</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span><span class="bp">*</span><span class="n">ε</span> <span class="bp">∧</span>
                   <span class="n">ε</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">ε&#39;</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x&#39;</span> <span class="bp">∧</span>
                   <span class="bp">∀</span> <span class="n">y</span><span class="o">,</span> <span class="n">dist</span> <span class="n">x&#39;</span> <span class="n">y</span> <span class="bp">≤</span> <span class="n">ε&#39;</span> <span class="bp">→</span> <span class="n">φ</span> <span class="n">y</span> <span class="bp">≤</span> <span class="mi">2</span><span class="bp">*</span><span class="n">φ</span> <span class="n">x&#39;</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">by_contradiction</span> <span class="n">H</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">reformulation</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x&#39;</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">ε</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">^</span> <span class="n">k</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x&#39;</span> <span class="bp">↔</span> <span class="mi">2</span><span class="bp">^</span><span class="n">k</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="n">x&#39;</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">x&#39;</span> <span class="n">k</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">div_mul_eq_mul_div</span><span class="o">,</span> <span class="n">le_div_iff</span><span class="o">,</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="n">mul_le_mul_left</span> <span class="n">ε_pos</span><span class="o">,</span> <span class="n">mul_comm</span><span class="o">],</span>
    <span class="n">exact</span> <span class="n">pow_pos</span> <span class="o">(</span><span class="k">by</span> <span class="n">norm_num</span><span class="o">)</span> <span class="n">k</span><span class="o">,</span> <span class="o">},</span>
  <span class="n">replace</span> <span class="n">H</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">k</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span> <span class="bp">∀</span> <span class="n">x&#39;</span><span class="o">,</span> <span class="bp">∃</span> <span class="n">y</span><span class="o">,</span>
    <span class="n">d</span> <span class="n">x&#39;</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span> <span class="bp">∧</span> <span class="mi">2</span><span class="bp">^</span><span class="n">k</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="n">x&#39;</span> <span class="bp">→</span> <span class="n">d</span> <span class="n">x&#39;</span> <span class="n">y</span> <span class="bp">≤</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">2</span><span class="bp">^</span><span class="n">k</span> <span class="bp">∧</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x&#39;</span> <span class="bp">&lt;</span> <span class="n">φ</span> <span class="n">y</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">k</span> <span class="n">x&#39;</span><span class="o">,</span>
    <span class="n">by_cases</span> <span class="n">h&#39;</span> <span class="o">:</span> <span class="n">d</span> <span class="n">x&#39;</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span> <span class="bp">∧</span> <span class="mi">2</span><span class="bp">^</span><span class="n">k</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="n">x&#39;</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">contrapose</span> <span class="n">H</span><span class="o">,</span>
      <span class="n">rw</span> <span class="n">not_not</span><span class="o">,</span>
      <span class="n">use</span> <span class="n">ε</span><span class="bp">/</span><span class="mi">2</span><span class="bp">^</span><span class="n">k</span><span class="o">,</span>
      <span class="n">simp</span> <span class="o">[</span><span class="n">ε_pos</span><span class="o">],</span>
      <span class="n">use</span> <span class="n">x&#39;</span><span class="o">,</span>
      <span class="n">simpa</span> <span class="o">[</span><span class="n">h&#39;</span><span class="bp">.</span><span class="n">left</span><span class="o">,</span> <span class="n">reformulation</span><span class="o">,</span>  <span class="n">h&#39;</span><span class="bp">.</span><span class="n">right</span><span class="o">,</span> <span class="n">h&#39;</span><span class="o">]</span> <span class="kn">using</span> <span class="n">H</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">use</span> <span class="n">x</span> <span class="o">}</span> <span class="o">},</span>
  <span class="n">clear</span> <span class="n">reformulation</span><span class="o">,</span>
  <span class="n">choose</span> <span class="n">F</span> <span class="n">hF</span> <span class="kn">using</span> <span class="n">H</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">u</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">X</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="n">x</span> <span class="n">F</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">hu</span> <span class="o">:</span>
    <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span>
      <span class="n">d</span> <span class="o">(</span><span class="n">u</span> <span class="n">n</span><span class="o">)</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span> <span class="bp">∧</span> <span class="mi">2</span><span class="bp">^</span><span class="n">n</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="n">n</span><span class="o">)</span> <span class="bp">→</span>
      <span class="n">d</span> <span class="o">(</span><span class="n">u</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">u</span> <span class="err">$</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">^</span> <span class="n">n</span> <span class="bp">∧</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="n">n</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="err">$</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">),</span>
  <span class="o">{</span> <span class="n">intro</span> <span class="n">n</span><span class="o">,</span>
    <span class="n">exact</span> <span class="n">hF</span> <span class="n">n</span> <span class="o">(</span><span class="n">u</span> <span class="n">n</span><span class="o">)</span> <span class="o">},</span>
  <span class="n">clear</span> <span class="n">hF</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">key</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span> <span class="n">d</span> <span class="o">(</span><span class="n">u</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">^</span> <span class="n">n</span> <span class="bp">∧</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="n">n</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)),</span>
  <span class="o">{</span> <span class="n">intro</span> <span class="n">n</span><span class="o">,</span>
    <span class="n">induction</span> <span class="n">n</span> <span class="kn">using</span> <span class="n">nat</span><span class="bp">.</span><span class="n">case_strong_induction_on&#39;</span> <span class="k">with</span> <span class="n">n</span> <span class="n">IH</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">specialize</span> <span class="n">hu</span> <span class="mi">0</span><span class="o">,</span>
      <span class="n">simp</span> <span class="o">[</span><span class="k">show</span> <span class="n">u</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">x</span><span class="o">,</span> <span class="k">from</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">le_refl</span><span class="o">]</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
      <span class="n">exact</span> <span class="n">hu</span> <span class="o">(</span><span class="k">by</span> <span class="n">linarith</span><span class="o">)</span> <span class="o">},</span>
    <span class="k">have</span> <span class="n">A</span> <span class="o">:</span> <span class="n">d</span> <span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">))</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">ε</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">dist_comm</span><span class="o">],</span>
      <span class="n">exact</span> <span class="n">dist_le_of_geometric_aux</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">k</span> <span class="n">hk</span><span class="o">,</span> <span class="o">(</span><span class="n">IH</span> <span class="n">k</span> <span class="n">hk</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">),</span> <span class="o">},</span>
    <span class="k">have</span> <span class="n">B</span> <span class="o">:</span> <span class="mi">2</span><span class="bp">^</span><span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)),</span>
    <span class="o">{</span> <span class="n">apply</span> <span class="n">le_of_lt</span><span class="o">,</span>
      <span class="n">exact</span> <span class="n">geom_lt</span> <span class="o">(</span><span class="k">by</span> <span class="n">norm_num</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span>  <span class="n">m</span> <span class="n">hm</span><span class="o">,</span> <span class="o">(</span><span class="n">IH</span> <span class="bp">_</span> <span class="n">hm</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span><span class="o">),</span> <span class="o">},</span>
    <span class="n">exact</span> <span class="n">hu</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="bp">⟨</span><span class="n">A</span><span class="o">,</span> <span class="n">B</span><span class="bp">⟩</span><span class="o">,</span> <span class="o">},</span>
  <span class="n">cases</span> <span class="n">forall_and_distrib</span><span class="bp">.</span><span class="n">mp</span> <span class="n">key</span> <span class="k">with</span> <span class="n">key₁</span> <span class="n">key₂</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">cauchy_u</span> <span class="o">:</span> <span class="n">cauchy_seq</span> <span class="n">u</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">apply</span> <span class="n">cauchy_seq_of_le_geometric</span> <span class="bp">_</span> <span class="n">ε</span> <span class="o">(</span><span class="k">by</span> <span class="n">norm_num</span> <span class="o">:</span> <span class="mi">1</span><span class="bp">/</span><span class="o">(</span><span class="mi">2</span><span class="o">:</span><span class="n">ℝ</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="mi">1</span><span class="o">),</span>
    <span class="n">intro</span> <span class="n">n</span><span class="o">,</span>
    <span class="n">convert</span> <span class="n">key₁</span> <span class="n">n</span><span class="o">,</span>
    <span class="n">simp</span> <span class="o">},</span>
  <span class="k">obtain</span> <span class="bp">⟨</span><span class="n">y</span><span class="o">,</span> <span class="n">limy</span><span class="bp">⟩</span> <span class="o">:</span> <span class="bp">∃</span> <span class="n">y</span><span class="o">,</span> <span class="n">tendsto</span> <span class="n">u</span> <span class="n">at_top</span> <span class="o">(</span><span class="err">𝓝</span> <span class="n">y</span><span class="o">),</span>
    <span class="k">from</span> <span class="n">complete_space</span><span class="bp">.</span><span class="n">complete</span> <span class="n">cauchy_u</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">lim_top</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="o">(</span><span class="n">φ</span> <span class="err">∘</span> <span class="n">u</span><span class="o">)</span> <span class="n">at_top</span> <span class="n">at_top</span><span class="o">,</span>
  <span class="o">{</span> <span class="k">let</span> <span class="n">v</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="n">φ</span> <span class="err">∘</span> <span class="n">u</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">),</span>
    <span class="n">suffices</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="n">v</span> <span class="n">at_top</span> <span class="n">at_top</span><span class="o">,</span>
      <span class="k">by</span> <span class="n">rwa</span> <span class="n">tendsto_add_at_top_iff_nat</span> <span class="n">at</span> <span class="n">this</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">hv₀</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">v</span> <span class="mi">0</span><span class="o">,</span>
    <span class="o">{</span> <span class="k">have</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:=</span> <span class="n">nonneg</span> <span class="n">x</span><span class="o">,</span>
      <span class="k">calc</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="k">by</span> <span class="n">linarith</span>
      <span class="bp">...</span> <span class="bp">&lt;</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">:</span> <span class="n">key₂</span> <span class="mi">0</span> <span class="o">},</span>
    <span class="n">apply</span> <span class="n">tendsto_at_top_of_geom_lt</span> <span class="n">hv₀</span> <span class="o">(</span><span class="k">by</span> <span class="n">norm_num</span> <span class="o">:</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="mi">2</span><span class="o">),</span>
    <span class="n">exact</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">key₂</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">},</span>
  <span class="k">have</span> <span class="n">lim</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="o">(</span><span class="n">φ</span> <span class="err">∘</span> <span class="n">u</span><span class="o">)</span> <span class="n">at_top</span> <span class="o">(</span><span class="err">𝓝</span> <span class="o">(</span><span class="n">φ</span> <span class="n">y</span><span class="o">)),</span>
    <span class="k">from</span> <span class="n">tendsto</span><span class="bp">.</span><span class="n">comp</span> <span class="n">cont</span><span class="bp">.</span><span class="n">continuous_at</span> <span class="n">limy</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">not_tendsto_at_top_of_tendsto_nhds</span> <span class="n">at_top_ne_bot</span> <span class="n">lim</span> <span class="n">lim_top</span><span class="o">,</span>
<span class="kn">end</span>
</code></pre></div>



<a name="199320973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199320973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199320973">(May 31 2020 at 20:58)</a>:</h4>
<p>Now I'll look at David's version.</p>



<a name="199321703"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199321703" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199321703">(May 31 2020 at 21:22)</a>:</h4>
<p>It's an interesting version, especially since it can be shortened by using <code>linarith</code> in three places. But the coercions to sort, <code>.val</code> and <code>.1</code> are really not pretty. I'd be curious to see what it becomes if you stop pretending in the beginning that you won't use <code>ε/2^k</code>. And of course I'd be also interested to see whether this setup allows to go nicely through the end of the proof.</p>



<a name="199322043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199322043" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199322043">(May 31 2020 at 21:34)</a>:</h4>
<p>I started to try to "fix" this version, but it turns out I'm essentially only rewriting it into my version...</p>



<a name="199323150"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199323150" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199323150">(May 31 2020 at 22:10)</a>:</h4>
<p>I think I had the same problem in my proof. I started out with a sequence similar to the paper proof, but you need to know that the epsilon sequence is <code>ε/2^k</code> or something almost as strong in order to prove that the sequence converges to zero</p>



<a name="199323172"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199323172" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199323172">(May 31 2020 at 22:11)</a>:</h4>
<p>I also haven't really used much of the library around limits and metric spaces so the proof was very low level</p>



<a name="199327019"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Hofer%27s%20lemma/near/199327019" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Hofer's.20lemma.html#199327019">(Jun 01 2020 at 00:08)</a>:</h4>
<p>Here is a <a href="https://gist.github.com/rwbarton/7bd5b3b19d930f577355a596a5ed8b4d">crec</a> version, borrowing some parts of Patrick's proof:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">topology</span><span class="bp">.</span><span class="n">metric_space</span><span class="bp">.</span><span class="n">basic</span>
<span class="kn">import</span> <span class="n">analysis</span><span class="bp">.</span><span class="n">specific_limits</span>
<span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">ring_exp</span>
<span class="kn">import</span> <span class="bp">.</span><span class="n">crec</span>

<span class="kn">open</span> <span class="n">filter</span>
<span class="n">open_locale</span> <span class="n">classical</span> <span class="n">topological_space</span>

<span class="kn">lemma</span> <span class="n">tendsto_at_top_of_geom_lt</span> <span class="o">{</span><span class="n">v</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">{</span><span class="n">k</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">h₀</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">v</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">hk</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">k</span><span class="o">)</span>
  <span class="o">(</span><span class="n">hu</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span> <span class="n">k</span><span class="bp">*</span><span class="n">v</span> <span class="n">n</span> <span class="bp">&lt;</span> <span class="n">v</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="n">v</span> <span class="n">at_top</span> <span class="n">at_top</span> <span class="o">:=</span>
<span class="n">sorry</span> <span class="c1">-- from Patrick&#39;s proof</span>

<span class="kn">lemma</span> <span class="n">not_tendsto_at_top_of_tendsto_nhds</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">F</span> <span class="o">:</span> <span class="n">filter</span> <span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">hF</span> <span class="o">:</span> <span class="n">F</span> <span class="bp">≠</span> <span class="err">⊥</span><span class="o">)</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">}</span>  <span class="o">{</span><span class="n">x</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">hf</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="n">f</span> <span class="n">F</span> <span class="o">(</span><span class="err">𝓝</span> <span class="n">x</span><span class="o">))</span> <span class="o">:</span>
<span class="bp">¬</span> <span class="n">tendsto</span> <span class="n">f</span> <span class="n">F</span> <span class="n">at_top</span> <span class="o">:=</span>
<span class="n">sorry</span> <span class="c1">-- from Patrick&#39;s proof</span>

<span class="kn">lemma</span> <span class="n">div_le_self</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">hα</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">≥</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">hβ</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">/</span> <span class="n">β</span> <span class="bp">≤</span> <span class="n">α</span> <span class="o">:=</span> <span class="n">sorry</span>

<span class="kn">inductive</span> <span class="n">is_succ</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="kt">Prop</span>
<span class="bp">|</span> <span class="n">mk</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">is_succ</span> <span class="n">n</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span>

<span class="kn">lemma</span> <span class="n">wf_is_succ</span> <span class="o">:</span> <span class="n">well_founded</span> <span class="n">is_succ</span> <span class="o">:=</span> <span class="n">sorry</span>

<span class="kn">lemma</span> <span class="n">hofer</span> <span class="o">{</span><span class="n">X</span><span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">metric_space</span> <span class="n">X</span><span class="o">]</span> <span class="o">[</span><span class="n">complete_space</span> <span class="n">X</span><span class="o">]</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">(</span><span class="n">ε</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">(</span><span class="n">ε_pos</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">ε</span><span class="o">)</span>
  <span class="o">{</span><span class="n">φ</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">cont</span> <span class="o">:</span> <span class="n">continuous</span> <span class="n">φ</span><span class="o">)</span> <span class="o">(</span><span class="n">nonneg</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="n">x</span><span class="o">)</span> <span class="o">:</span>
<span class="bp">∃</span> <span class="o">(</span><span class="n">ε&#39;</span> <span class="bp">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">x&#39;</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">ε&#39;</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">∧</span>
       <span class="n">dist</span> <span class="n">x&#39;</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span><span class="bp">*</span><span class="n">ε</span> <span class="bp">∧</span>
       <span class="n">ε</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">ε&#39;</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x&#39;</span><span class="o">),</span>
  <span class="bp">∀</span> <span class="n">y</span><span class="o">,</span> <span class="n">dist</span> <span class="n">x&#39;</span> <span class="n">y</span> <span class="bp">≤</span> <span class="n">ε&#39;</span> <span class="bp">→</span> <span class="n">φ</span> <span class="n">y</span> <span class="bp">≤</span> <span class="mi">2</span><span class="bp">*</span><span class="n">φ</span> <span class="n">x&#39;</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">by_contradiction</span> <span class="n">H</span><span class="o">,</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">not_exists</span><span class="o">,</span> <span class="n">not_forall</span><span class="o">]</span> <span class="n">at</span> <span class="n">H</span><span class="o">,</span>
  <span class="c1">-- conditions imposed at the nth step</span>
  <span class="k">let</span> <span class="n">C</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="kt">Type</span> <span class="o">:=</span>
    <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="o">{</span><span class="n">x&#39;</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">//</span> <span class="n">dist</span> <span class="n">x&#39;</span> <span class="n">x</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">-</span> <span class="mi">1</span> <span class="bp">/</span> <span class="mi">2</span><span class="bp">^</span><span class="n">n</span><span class="o">)</span> <span class="bp">*</span> <span class="n">ε</span> <span class="bp">∧</span> <span class="mi">2</span><span class="bp">^</span><span class="n">n</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="n">x&#39;</span><span class="o">},</span>
  <span class="c1">-- conditions imposed on consecutive steps</span>
  <span class="k">let</span> <span class="n">q</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">n₁</span> <span class="n">n₂</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">is_succ</span> <span class="n">n₁</span> <span class="n">n₂</span><span class="o">)</span> <span class="o">(</span><span class="n">x₁</span> <span class="o">:</span> <span class="n">C</span> <span class="n">n₁</span><span class="o">)</span> <span class="o">(</span><span class="n">x₂</span> <span class="o">:</span> <span class="n">C</span> <span class="n">n₂</span><span class="o">),</span> <span class="kt">Prop</span> <span class="o">:=</span>
    <span class="bp">λ</span> <span class="n">n₁</span> <span class="n">n₂</span> <span class="n">h</span> <span class="n">x₁</span> <span class="n">x₂</span><span class="o">,</span> <span class="n">dist</span> <span class="n">x₁</span><span class="bp">.</span><span class="n">val</span> <span class="n">x₂</span><span class="bp">.</span><span class="n">val</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">2</span><span class="bp">^</span><span class="n">n₁</span> <span class="bp">∧</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x₁</span> <span class="bp">&lt;</span> <span class="n">φ</span> <span class="n">x₂</span><span class="o">,</span>
  <span class="c1">-- construct a sequence satisfying all the conditions</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">C</span> <span class="n">n</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">refine</span> <span class="n">crec</span> <span class="n">wf_is_succ</span> <span class="n">q</span> <span class="bp">_</span><span class="o">,</span>
    <span class="n">intros</span> <span class="n">n</span> <span class="n">IH</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">n</span> <span class="k">with</span> <span class="n">n</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">refine</span> <span class="bp">⟨⟨</span><span class="n">x</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span>
      <span class="o">{</span> <span class="n">simp</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">simp</span> <span class="o">},</span>
      <span class="n">rintros</span> <span class="bp">_</span> <span class="bp">⟨⟩</span> <span class="o">},</span>
    <span class="o">{</span> <span class="k">let</span> <span class="n">x&#39;</span> <span class="o">:=</span> <span class="o">(</span><span class="n">IH</span><span class="bp">.</span><span class="n">val</span> <span class="n">n</span> <span class="o">(</span><span class="n">is_succ</span><span class="bp">.</span><span class="n">mk</span> <span class="n">n</span><span class="o">))</span><span class="bp">.</span><span class="n">val</span><span class="o">,</span>
      <span class="k">obtain</span> <span class="bp">⟨</span><span class="n">hx&#39;₁</span><span class="o">,</span> <span class="n">hx&#39;₂</span><span class="bp">⟩</span> <span class="o">:=</span> <span class="o">(</span><span class="n">IH</span><span class="bp">.</span><span class="n">val</span> <span class="n">n</span> <span class="o">(</span><span class="n">is_succ</span><span class="bp">.</span><span class="n">mk</span> <span class="n">n</span><span class="o">))</span><span class="bp">.</span><span class="n">property</span><span class="o">,</span>
      <span class="k">have</span> <span class="o">:=</span> <span class="n">H</span> <span class="o">(</span><span class="n">ε</span> <span class="bp">/</span> <span class="mi">2</span><span class="bp">^</span><span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">div_pos</span> <span class="n">ε_pos</span> <span class="o">(</span><span class="n">pow_pos</span> <span class="n">two_pos</span> <span class="bp">_</span><span class="o">))</span> <span class="n">x&#39;</span>
        <span class="bp">⟨</span><span class="n">div_le_self</span> <span class="o">(</span><span class="n">le_of_lt</span> <span class="n">ε_pos</span><span class="o">)</span> <span class="o">(</span><span class="n">pow_pos</span> <span class="n">two_pos</span> <span class="bp">_</span><span class="o">),</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span>
      <span class="n">choose</span> <span class="n">y</span> <span class="n">hy₁</span> <span class="n">hy₂</span> <span class="kn">using</span> <span class="n">this</span><span class="o">,</span>
      <span class="n">refine</span> <span class="bp">⟨⟨</span><span class="n">y</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span>
      <span class="o">{</span> <span class="k">have</span> <span class="o">:</span> <span class="n">dist</span> <span class="n">y</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">dist</span> <span class="n">x&#39;</span> <span class="n">y</span> <span class="bp">+</span> <span class="n">dist</span> <span class="n">x&#39;</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">dist_triangle_left</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
        <span class="k">have</span> <span class="o">:</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">2</span><span class="bp">^</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">2</span> <span class="bp">*</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">-</span> <span class="mi">1</span> <span class="bp">/</span> <span class="mi">2</span><span class="bp">^</span><span class="n">n</span><span class="o">)</span> <span class="bp">*</span> <span class="n">ε</span> <span class="bp">=</span> <span class="mi">2</span> <span class="bp">*</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">-</span> <span class="mi">1</span> <span class="bp">/</span> <span class="mi">2</span><span class="bp">^</span><span class="n">n</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span> <span class="bp">*</span> <span class="n">ε</span><span class="o">,</span>
        <span class="o">{</span> <span class="n">change</span> <span class="n">n</span><span class="bp">.</span><span class="n">succ</span> <span class="k">with</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">ring_exp</span><span class="o">,</span> <span class="n">field_simp</span><span class="o">,</span> <span class="n">ring</span> <span class="o">},</span>
        <span class="n">linarith</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">pow_succ</span><span class="o">,</span> <span class="n">mul_assoc</span><span class="o">],</span> <span class="n">linarith</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">rintros</span> <span class="bp">_</span> <span class="bp">⟨⟩</span><span class="o">,</span>
        <span class="n">refine</span> <span class="bp">⟨</span><span class="n">hy₁</span><span class="o">,</span> <span class="n">lt_of_not_ge</span> <span class="n">hy₂</span><span class="bp">⟩</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">refine</span> <span class="n">le_trans</span> <span class="n">hx&#39;₁</span> <span class="bp">_</span><span class="o">,</span>
        <span class="n">rw</span> <span class="o">[</span><span class="n">mul_le_mul_right</span> <span class="n">ε_pos</span><span class="o">,</span> <span class="n">mul_le_iff_le_one_right</span> <span class="n">two_pos</span><span class="o">],</span>
        <span class="n">apply</span> <span class="n">le_of_lt</span><span class="o">,</span>
        <span class="n">apply</span> <span class="n">sub_lt_self</span><span class="o">,</span>
        <span class="n">exact</span> <span class="o">(</span><span class="n">div_pos</span> <span class="n">zero_lt_one</span> <span class="o">(</span><span class="n">pow_pos</span> <span class="n">two_pos</span> <span class="bp">_</span><span class="o">))</span> <span class="o">},</span>
      <span class="o">{</span> <span class="k">calc</span>
          <span class="n">ε</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">^</span> <span class="n">n</span> <span class="bp">*</span> <span class="o">(</span><span class="mi">2</span> <span class="bp">^</span> <span class="n">n</span> <span class="bp">*</span> <span class="n">φ</span> <span class="n">x</span><span class="o">)</span> <span class="o">:</span> <span class="k">by</span> <span class="o">{</span> <span class="n">field_simp</span><span class="o">,</span> <span class="n">ring</span> <span class="o">}</span>
              <span class="bp">...</span> <span class="bp">≤</span> <span class="n">ε</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">^</span> <span class="n">n</span> <span class="bp">*</span> <span class="n">φ</span> <span class="bp">_</span> <span class="o">:</span>
            <span class="k">by</span> <span class="o">{</span> <span class="n">rwa</span> <span class="n">mul_le_mul_left</span> <span class="o">(</span><span class="n">div_pos</span> <span class="n">ε_pos</span> <span class="o">(</span><span class="n">pow_pos</span> <span class="n">two_pos</span> <span class="bp">_</span><span class="o">))</span> <span class="o">}</span> <span class="o">}</span> <span class="o">}</span> <span class="o">},</span>
  <span class="k">have</span> <span class="n">hf</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">q</span> <span class="n">n</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">is_succ</span><span class="bp">.</span><span class="n">mk</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">))</span> <span class="o">:=</span>
    <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">crec_consistent</span> <span class="n">wf_is_succ</span> <span class="n">q</span> <span class="bp">_</span> <span class="n">n</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">is_succ</span><span class="bp">.</span><span class="n">mk</span> <span class="n">n</span><span class="o">),</span>
  <span class="k">let</span> <span class="n">u</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">X</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="n">f</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span>
  <span class="c1">-- rest adapted from Patrick&#39;s proof</span>
  <span class="k">have</span> <span class="n">cauchy_u</span> <span class="o">:</span> <span class="n">cauchy_seq</span> <span class="n">u</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">apply</span> <span class="n">cauchy_seq_of_le_geometric_two</span> <span class="o">(</span><span class="n">ε</span> <span class="bp">*</span> <span class="mi">2</span><span class="o">),</span>
    <span class="n">intro</span> <span class="n">n</span><span class="o">,</span>
    <span class="n">convert</span> <span class="o">(</span><span class="n">hf</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span>
    <span class="n">field_simp</span> <span class="o">},</span>
  <span class="k">obtain</span> <span class="bp">⟨</span><span class="n">y</span><span class="o">,</span> <span class="n">limy</span><span class="bp">⟩</span> <span class="o">:</span> <span class="bp">∃</span> <span class="n">y</span><span class="o">,</span> <span class="n">tendsto</span> <span class="n">u</span> <span class="n">at_top</span> <span class="o">(</span><span class="err">𝓝</span> <span class="n">y</span><span class="o">),</span>
    <span class="k">from</span> <span class="n">complete_space</span><span class="bp">.</span><span class="n">complete</span> <span class="n">cauchy_u</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">lim_top</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="o">(</span><span class="n">φ</span> <span class="err">∘</span> <span class="n">u</span><span class="o">)</span> <span class="n">at_top</span> <span class="n">at_top</span><span class="o">,</span>
  <span class="o">{</span> <span class="k">let</span> <span class="n">v</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="n">φ</span> <span class="err">∘</span> <span class="n">u</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">),</span>
    <span class="n">suffices</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="n">v</span> <span class="n">at_top</span> <span class="n">at_top</span><span class="o">,</span>
      <span class="k">by</span> <span class="n">rwa</span> <span class="n">tendsto_add_at_top_iff_nat</span> <span class="n">at</span> <span class="n">this</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">hv₀</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">v</span> <span class="mi">0</span><span class="o">,</span>
    <span class="o">{</span> <span class="k">have</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:=</span> <span class="n">nonneg</span> <span class="bp">_</span><span class="o">,</span>
      <span class="k">calc</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="k">by</span> <span class="n">linarith</span>
      <span class="bp">...</span> <span class="bp">&lt;</span> <span class="n">φ</span> <span class="o">(</span><span class="n">u</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">:</span> <span class="o">(</span><span class="n">hf</span> <span class="mi">0</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span> <span class="o">},</span>
    <span class="n">apply</span> <span class="n">tendsto_at_top_of_geom_lt</span> <span class="n">hv₀</span> <span class="o">(</span><span class="k">by</span> <span class="n">norm_num</span> <span class="o">:</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="mi">2</span><span class="o">),</span>
    <span class="n">exact</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="n">hf</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">))</span><span class="bp">.</span><span class="mi">2</span> <span class="o">},</span>
  <span class="k">have</span> <span class="n">lim</span> <span class="o">:</span> <span class="n">tendsto</span> <span class="o">(</span><span class="n">φ</span> <span class="err">∘</span> <span class="n">u</span><span class="o">)</span> <span class="n">at_top</span> <span class="o">(</span><span class="err">𝓝</span> <span class="o">(</span><span class="n">φ</span> <span class="n">y</span><span class="o">)),</span>
    <span class="k">from</span> <span class="n">tendsto</span><span class="bp">.</span><span class="n">comp</span> <span class="n">cont</span><span class="bp">.</span><span class="n">continuous_at</span> <span class="n">limy</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">not_tendsto_at_top_of_tendsto_nhds</span> <span class="n">at_top_ne_bot</span> <span class="n">lim</span> <span class="n">lim_top</span><span class="o">,</span>
<span class="kn">end</span>
</code></pre></div>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>