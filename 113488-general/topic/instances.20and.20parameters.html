---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/instances.20and.20parameters.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html">instances and parameters</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="178605349"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178605349" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178605349">(Oct 20 2019 at 18:57)</a>:</h4>
<p>I thought that typeclass inference could use information in the context to fill in parameters to instances. However, I can't get this to work.</p>
<div class="codehilite"><pre><span></span><span class="n">class</span> <span class="n">my_class</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span>

<span class="kn">instance</span> <span class="n">foo</span> <span class="o">{</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">[</span><span class="n">x</span> <span class="bp">&lt;</span> <span class="n">y</span><span class="o">]</span> <span class="o">:</span> <span class="n">my_class</span> <span class="o">(</span><span class="n">Icc</span> <span class="n">x</span> <span class="n">y</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">constructor</span>

<span class="kn">instance</span> <span class="n">bar</span> <span class="o">{</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span> <span class="n">my_class</span> <span class="o">(</span><span class="n">Icc</span> <span class="n">x</span> <span class="n">y</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
</pre></div>


<p><code>bar</code> fails. Is there a way to solve this?</p>



<a name="178605503"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178605503" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178605503">(Oct 20 2019 at 19:01)</a>:</h4>
<p>I don't think it's solvable</p>



<a name="178605518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178605518" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178605518">(Oct 20 2019 at 19:02)</a>:</h4>
<p>Is the issue that x&lt;y isn't a typeclass?</p>



<a name="178605552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178605552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178605552">(Oct 20 2019 at 19:02)</a>:</h4>
<p>Oh I see, this is the point</p>



<a name="178605729"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178605729" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178605729">(Oct 20 2019 at 19:07)</a>:</h4>
<p>So, you mean I should go for</p>
<div class="codehilite"><pre><span></span><span class="n">class</span> <span class="n">my_class</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span>

<span class="n">def</span> <span class="n">le_class</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">y</span>

<span class="n">attribute</span> <span class="o">[</span><span class="n">class</span><span class="o">]</span> <span class="n">le_class</span>

<span class="kn">instance</span> <span class="n">foo</span> <span class="o">{</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">[</span><span class="n">le_class</span> <span class="n">x</span> <span class="n">y</span><span class="o">]</span> <span class="o">:</span> <span class="n">my_class</span> <span class="o">(</span><span class="n">Icc</span> <span class="n">x</span> <span class="n">y</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">constructor</span>

<span class="kn">instance</span> <span class="n">bar</span> <span class="o">{</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">le_class</span> <span class="n">x</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span> <span class="n">my_class</span> <span class="o">(</span><span class="n">Icc</span> <span class="n">x</span> <span class="n">y</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
</pre></div>


<p>This is a little bit sad, but it works...</p>



<a name="178605878"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178605878" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178605878">(Oct 20 2019 at 19:11)</a>:</h4>
<p>Would it be possible in Lean 4 to allow for normal parameters in instances, where instance search would only be allowed to look in the context to fill these parameters, instead of going on with the search?</p>



<a name="178606058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178606058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178606058">(Oct 20 2019 at 19:16)</a>:</h4>
<p>That would be really nice.</p>



<a name="178607359"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178607359" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178607359">(Oct 20 2019 at 19:48)</a>:</h4>
<p>I half-started typing "maybe you could make a wrapper def and make it a class" but then I thought it would probably be so horrible to use in practice that I had better not mention it!</p>



<a name="178609338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609338" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609338">(Oct 20 2019 at 20:44)</a>:</h4>
<p>I learned this week that something much more general is planned for Lean 4: you will be able to invoke tactics from instances using <code>auto_param</code>s, like</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">bar</span> <span class="o">{</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">y</span> <span class="bp">.</span> <span class="n">my_tac</span><span class="o">)</span> <span class="o">:</span> <span class="n">my_class</span> <span class="o">(</span><span class="n">Icc</span> <span class="n">x</span> <span class="n">y</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
</pre></div>


<p>I would guess something along the lines of <code>def my_tac := tactic.linarith &lt;|&gt; tactic.assumption</code> would solve most of your goals automatically, and the rest manually, provided you can stuff the proof you need into the environment somehow.</p>



<a name="178609365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609365">(Oct 20 2019 at 20:45)</a>:</h4>
<p>(I don't think it ever occurred to me to even try this in Lean 3, but I just confirmed that it in fact does not work currently.)</p>



<a name="178609412"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609412" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609412">(Oct 20 2019 at 20:46)</a>:</h4>
<p>Where did you see that in Lean 4?</p>



<a name="178609418"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609418" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609418">(Oct 20 2019 at 20:46)</a>:</h4>
<p>I was at MSR for the past week.</p>



<a name="178609446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609446" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609446">(Oct 20 2019 at 20:47)</a>:</h4>
<p>Did you tell Lean 4 everything you know about IMO problem solving?</p>



<a name="178609488"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609488" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609488">(Oct 20 2019 at 20:48)</a>:</h4>
<p>But this is my favorite tidbit. Also consider the possibility of coercing to a bundled morphism, with a tactic which synthesizes the proof of continuity, or whatever.</p>



<a name="178609568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609568" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609568">(Oct 20 2019 at 20:50)</a>:</h4>
<p>Do they have tests suggesting this won't kill type class search performance?</p>



<a name="178609571"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609571" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609571">(Oct 20 2019 at 20:50)</a>:</h4>
<blockquote>
<p>Did you tell Lean 4 everything you know about IMO problem solving?</p>
</blockquote>
<p>Well, the reason this feature is only planned so far is that there is no mechanism at all to invoke tactics (<code>begin ... end</code>) yet, so it's a bit premature to communicate with Lean 4 directly</p>



<a name="178609630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609630" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609630">(Oct 20 2019 at 20:52)</a>:</h4>
<p>Yeah I know, this (and VScode extension) is why we cannot play with Lean 4 yet.</p>



<a name="178609666"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609666" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609666">(Oct 20 2019 at 20:53)</a>:</h4>
<p>I don't think the problem has ever been about performance. Certainly tactics should be used sparingly and fail fast in such a context, but when I talked about this with leo early in lean 3 his concern was that this will make type class searches nondeterministic (so caching is not necessarily safe anymore)</p>



<a name="178609731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178609731" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178609731">(Oct 20 2019 at 20:55)</a>:</h4>
<blockquote>
<p>Do they have tests suggesting this won't kill type class search performance?</p>
</blockquote>
<p>Of course it will be bad if the tactic itself is expensive, but based on what I understand about the new instance search procedure, I expect the tactic will be invoked at most once per specific goal per query.</p>



<a name="178610012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178610012" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178610012">(Oct 20 2019 at 21:03)</a>:</h4>
<p>it actually might be nice for the typeclass search itself to have the conditions for applicability of the tactic already available. I guess if you want this to work using auto_param instances, you would need a dummy blanket instance like <code>instance (h : continuous f . cont_tac) : continuous f</code></p>



<a name="178623928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178623928" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178623928">(Oct 21 2019 at 03:51)</a>:</h4>
<p>Here is the current plan: when typeclass resolution encounters a precondition in an instance whose head unifies with a goal, it will create a metavariable for the proof and move on as if the precondition had been proved. If typeclass inference eventually succeeds, the elaborator will call any registered tactics to instantiate those metavariables (i.e. to prove the preconditions), and will throw a (good) error message if any of these tactics fail. This plan will not handle cases where different instances are desired depending on whether or not certain preconditions are provable. Interleaving typeclass resolution and tactic invocation would add a lot of complexity and we do not intend to support it. However, we would potentially consider supporting it if there were very valuable uses of typeclasses that require it. If anyone has any such examples, now is the time to share.</p>



<a name="178624342"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178624342" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178624342">(Oct 21 2019 at 04:02)</a>:</h4>
<p>I assume tactics can still call <code>apply_instance</code>?</p>



<a name="178624365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178624365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178624365">(Oct 21 2019 at 04:03)</a>:</h4>
<blockquote>
<p>I assume tactics can still call <code>apply_instance</code>?</p>
</blockquote>
<p>Yes, that direction is fine.</p>



<a name="178624425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178624425" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178624425">(Oct 21 2019 at 04:05)</a>:</h4>
<p>So instances with auto_params always succeed then? A tactic that appears in an auto_param instance must handle the complete problem without failure?</p>



<a name="178624610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178624610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178624610">(Oct 21 2019 at 04:11)</a>:</h4>
<p>One example that comes to mind is Z/pZ. It would be nice if we could infer a field structure on Z/nZ if and only if n is prime</p>



<a name="178624734"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178624734" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178624734">(Oct 21 2019 at 04:15)</a>:</h4>
<p>This plan is effectively going to always assume that the primality check succeeds, but then the question is whether that leads to a bad proof sometimes. For example, maybe I want multiplication on Z/4Z, and the instance search does <code>has_mul Z/4Z &lt;- ring Z/4Z &lt;- field Z/4Z &lt;- defer proof that 4 is prime</code> and "succeeds", then it runs the primality check, fails, and says "sorry, no multiplication found", even though let's say the instance it would have tried right after <code>ring A &lt;- field A</code> was <code>ring Z/nZ</code> with no assumptions</p>



<a name="178624839"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178624839" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178624839">(Oct 21 2019 at 04:18)</a>:</h4>
<blockquote>
<p>So instances with auto_params always succeed then? </p>
</blockquote>
<p>Here is another way to think about it. Typeclass resolution will ignore preconditions and <em>commit</em> to the first instance it can synthesize (ignoring preconditions). Then the elaborator will call the registered tactics to synthesize the preconditions, and fail if they cannot be synthesized.</p>
<blockquote>
<p>A tactic that appears in an auto_param instance must handle the complete problem without failure?</p>
</blockquote>
<p>This is actually a separate issue, but I would suggest that the tactics must succeed completely. The alternative is for the elaborator to return subgoals as in Coq's <code>refine</code>, but I think this leads to unmaintainable code.</p>



<a name="178624869"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178624869" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178624869">(Oct 21 2019 at 04:19)</a>:</h4>
<blockquote>
<p>This plan is effectively going to always assume that the primality check succeeds, but then the question is whether that leads to a bad proof sometimes. For example, maybe I want multiplication on Z/4Z, and the instance search does <code>has_mul Z/4Z &lt;- ring Z/4Z &lt;- field Z/4Z &lt;- defer proof that 4 is prime</code> and "succeeds", then it runs the primality check, fails, and says "sorry, no multiplication found", even though let's say the instance it would have tried right after <code>ring A &lt;- field A</code> was <code>ring Z/nZ</code> with no assumptions</p>
</blockquote>
<p>Thanks, this is a great example of something that will not work reliably with the current plan.</p>



<a name="178625397"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178625397" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178625397">(Oct 21 2019 at 04:34)</a>:</h4>
<p>Workaround: make <code>prime</code> a class, with instances for whatever concrete primes you care about, and take <code>[prime n]</code> as an argument to instances instead of <code>(prime n . &lt;tac&gt;)</code>. The typeclass resolution will also succeed for arbitrary <code>n</code> if <code>prime n</code> is in the context. Note: you only need to use the restricted <code>[prime n]</code> as an argument to instances, and can still use <code>(prime n . &lt;tac&gt;)</code> for non-instances.</p>



<a name="178627759"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178627759" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178627759">(Oct 21 2019 at 05:44)</a>:</h4>
<p>That is what we do today, or rather a slight variant in which <code>Z/pZ</code> is a newtype over <code>Z/nZ</code> with an additional argument with the proof of primality; this way the proof doesn't have to be inferred by type class inference. <code>prime p</code> has since become a class anyway, because of issues like this.</p>



<a name="178630753"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178630753" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178630753">(Oct 21 2019 at 07:03)</a>:</h4>
<p>But at the moment you can't provide an instance of <code>prime 2</code>, because it is not 100% a class, I guess?</p>



<a name="178632943"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178632943" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178632943">(Oct 21 2019 at 07:48)</a>:</h4>
<p><span class="user-mention" data-user-id="230999">@Daniel Selsam</span> did you also see the old discussion at <a href="#narrow/stream/113488-general/topic/cleaning.20iff/near/174233034" title="#narrow/stream/113488-general/topic/cleaning.20iff/near/174233034">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/cleaning.20iff/near/174233034</a>?</p>



<a name="178655959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178655959" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178655959">(Oct 21 2019 at 13:45)</a>:</h4>
<p>The following works on my fork of Lean4, no matter the order of the instance declarations:</p>
<div class="codehilite"><pre><span></span><span class="bp">@</span><span class="o">[</span><span class="n">class</span><span class="o">]</span> <span class="n">def</span> <span class="n">Prime</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span> <span class="n">p</span> <span class="bp">&gt;</span> <span class="mi">2</span> <span class="c1">-- skipping the rest</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">instance</span><span class="o">]</span> <span class="kn">axiom</span> <span class="n">p2</span> <span class="o">:</span> <span class="n">Prime</span> <span class="mi">2</span>
<span class="bp">@</span><span class="o">[</span><span class="kn">instance</span><span class="o">]</span> <span class="kn">axiom</span> <span class="n">p3</span> <span class="o">:</span> <span class="n">Prime</span> <span class="mi">3</span>

<span class="bp">@</span><span class="o">[</span><span class="n">class</span><span class="o">]</span> <span class="kn">axiom</span> <span class="n">Field</span> <span class="o">:</span> <span class="kt">Type</span> <span class="bp">→</span> <span class="kt">Type</span>
<span class="bp">@</span><span class="o">[</span><span class="n">class</span><span class="o">]</span> <span class="kn">axiom</span> <span class="n">Ring</span> <span class="o">:</span> <span class="kt">Type</span> <span class="bp">→</span> <span class="kt">Type</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">instance</span><span class="o">]</span> <span class="kn">axiom</span> <span class="n">FieldToHasDiv</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">Field</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">HasDiv</span> <span class="n">α</span>
<span class="bp">@</span><span class="o">[</span><span class="kn">instance</span><span class="o">]</span> <span class="kn">axiom</span> <span class="n">FieldToHasMul</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">Field</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">HasMul</span> <span class="n">α</span>
<span class="bp">@</span><span class="o">[</span><span class="kn">instance</span><span class="o">]</span> <span class="kn">axiom</span> <span class="n">RingToHasMul</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">Ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">HasMul</span> <span class="n">α</span>

<span class="kn">axiom</span> <span class="n">mkType</span> <span class="o">:</span> <span class="n">Nat</span> <span class="bp">→</span> <span class="kt">Type</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">instance</span><span class="o">]</span> <span class="kn">axiom</span> <span class="n">PrimeField</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">[</span><span class="n">Prime</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">Field</span> <span class="o">(</span><span class="n">mkType</span> <span class="n">n</span><span class="o">)</span>
<span class="bp">@</span><span class="o">[</span><span class="kn">instance</span><span class="o">]</span> <span class="kn">axiom</span> <span class="n">NonPrimeRing</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">Ring</span> <span class="o">(</span><span class="n">mkType</span> <span class="n">n</span><span class="o">)</span>

<span class="kn">axiom</span> <span class="n">fooCP2R</span> <span class="o">(</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="n">mkType</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">*</span> <span class="n">β</span> <span class="bp">=</span> <span class="n">β</span> <span class="bp">*</span> <span class="n">α</span>
<span class="kn">axiom</span> <span class="n">fooCP2F</span> <span class="o">(</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="n">mkType</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">/</span> <span class="n">β</span> <span class="bp">=</span> <span class="n">β</span> <span class="bp">/</span> <span class="n">α</span>
<span class="kn">axiom</span> <span class="n">fooCN2R</span> <span class="o">(</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="n">mkType</span> <span class="mi">4</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">*</span> <span class="n">β</span> <span class="bp">=</span> <span class="n">β</span> <span class="bp">*</span> <span class="n">α</span>
<span class="kn">axiom</span> <span class="n">fooAN2R</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">(</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="n">mkType</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">*</span> <span class="n">β</span> <span class="bp">=</span> <span class="n">β</span> <span class="bp">*</span> <span class="n">α</span>
<span class="kn">axiom</span> <span class="n">fooAP2R</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">(</span><span class="n">nPrime</span> <span class="o">:</span> <span class="n">Prime</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="n">mkType</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">*</span> <span class="n">β</span> <span class="bp">=</span> <span class="n">β</span> <span class="bp">*</span> <span class="n">α</span>
<span class="kn">axiom</span> <span class="n">fooAP2F</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">(</span><span class="n">nPrime</span> <span class="o">:</span> <span class="n">Prime</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="n">mkType</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">/</span> <span class="n">β</span> <span class="bp">=</span> <span class="n">β</span> <span class="bp">/</span> <span class="n">α</span>
</pre></div>


<p>Also, it should already work on Lean4::master and presumably Lean3 if you make <code>Prime</code> an explicit class:</p>
<div class="codehilite"><pre><span></span><span class="n">class</span> <span class="n">Prime</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span> <span class="o">(</span><span class="n">spec</span> <span class="o">:</span> <span class="bp">...</span><span class="o">)</span>
</pre></div>



<a name="178656549"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178656549" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178656549">(Oct 21 2019 at 13:52)</a>:</h4>
<blockquote>
<p>Workaround: make <code>prime</code> a class ...</p>
</blockquote>
<p>I called this a "workaround" last night but I now think it is actually a good solution. Suppose you tried to write <code>(x y : Z/&lt;huge concrete number&gt;Z)</code> and then wrote <code>x / y</code>. Would you really want <code>/</code> to do primality testing behind the scenes?</p>



<a name="178657234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178657234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178657234">(Oct 21 2019 at 13:58)</a>:</h4>
<p>Primality testing is much easier than prime factorization, but it's still a valid point.</p>



<a name="178658038"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178658038" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178658038">(Oct 21 2019 at 14:06)</a>:</h4>
<p>Doesn't it cache instance searches?</p>



<a name="178658701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178658701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178658701">(Oct 21 2019 at 14:13)</a>:</h4>
<blockquote>
<p>Primality testing is much easier than prime factorization, but it's still a valid point.</p>
</blockquote>
<p>(updated)</p>



<a name="178659273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178659273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178659273">(Oct 21 2019 at 14:19)</a>:</h4>
<blockquote>
<p>Doesn't it cache instance searches?</p>
</blockquote>
<p>We don't know yet when and whether to cache typeclass resolution results in Lean4. We may not need to cache at all, since the resolution itself will be so much faster than in Lean3, but we'll see. Either way, it is bad style to depend on caching policies for reasonable performance when there exists a simple, reliable solution: <code>instance : Prime &lt;huge concrete number&gt; := by primality_test</code>.</p>



<a name="178663324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178663324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178663324">(Oct 21 2019 at 15:00)</a>:</h4>
<p>Daniel, among all those wonders of type class resolution, could you also try to improve error reporting? When Lean 3 fails to infer an instance then most of the time we don't even know which instance it was trying to infer.</p>



<a name="178664411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178664411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178664411">(Oct 21 2019 at 15:09)</a>:</h4>
<blockquote>
<p>Daniel, among all those wonders of type class resolution, could you also try to improve error reporting? When Lean 3 fails to infer an instance then most of the time we don't even know which instance it was trying to infer.</p>
</blockquote>
<p>Thanks for pointing this out. There is low-hanging fruit in improving these messages, but reliable debugging probably requires more than just better error messages, e.g. much better tracing. We still don't have a plan for tracing in general but we are actively discussing it.</p>



<a name="178665054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/instances%20and%20parameters/near/178665054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/instances.20and.20parameters.html#178665054">(Oct 21 2019 at 15:15)</a>:</h4>
<p>By low-hanging fruit, I mean improvements that can be made relatively locally, independent of any major refactor such as tracing. And yes, we will make those improvements no matter what we decide about tracing.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>