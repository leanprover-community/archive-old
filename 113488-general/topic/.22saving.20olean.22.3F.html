---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/.22saving.20olean.22.3F.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html">"saving olean"?</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="289038417"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289038417" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289038417">(Jul 09 2022 at 12:13)</a>:</h4>
<p>On <code>flt_regular</code>, when I try <code>lean --make src/number_theory/cyclotomic/Unit_lemmas.lean</code>, half the build time is taken up by this step:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">/</span><span class="n">flt_regular</span><span class="bp">/</span><span class="n">_target</span><span class="bp">/</span><span class="n">src</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/</span><span class="n">algebra</span><span class="bp">/</span><span class="n">order</span><span class="bp">/</span><span class="n">field.lean</span><span class="o">:</span> <span class="n">saving</span> <span class="n">olean</span>
</code></pre></div>
<p>This is very confusing to me - why does Lean have to resave an <code>olean</code> for a file it should already have compiled? (note this is a mathlib file). What does this message mean?</p>



<a name="289039340"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289039340" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289039340">(Jul 09 2022 at 12:36)</a>:</h4>
<p>Is it possible that we have bad cache? I saw <code>lean --make</code> recompile <code>algebra.order.field</code> after <code>leanproject get-cache</code>. I'm in an airport right now, so can't test.</p>



<a name="289041935"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289041935" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289041935">(Jul 09 2022 at 13:35)</a>:</h4>
<p>I've seen that behavior a lot recently, I think the cache is somehow invalid for that file</p>



<a name="289042024"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289042024" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289042024">(Jul 09 2022 at 13:36)</a>:</h4>
<p>Maybe we need a third <code>lean --make</code> in our build script, on top of the existing two</p>



<a name="289042548"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289042548" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289042548">(Jul 09 2022 at 13:46)</a>:</h4>
<p>why do we run two?!</p>



<a name="289051750"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289051750" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289051750">(Jul 09 2022 at 16:58)</a>:</h4>
<p>Because the cache isn't always valid after the first run</p>



<a name="289133500"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289133500" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289133500">(Jul 11 2022 at 01:18)</a>:</h4>
<p>Why the cache can be invalid after the first run? Or we don't know the reason, just use a workaround?</p>



<a name="289141855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289141855" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289141855">(Jul 11 2022 at 04:21)</a>:</h4>
<p>I've just checked: <code>src/algebra/order/field.olean</code> is an empty file.</p>



<a name="289143260"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289143260" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289143260">(Jul 11 2022 at 04:46)</a>:</h4>
<p>Does CI use the same olean cache?</p>



<a name="289201435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289201435" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289201435">(Jul 11 2022 at 14:49)</a>:</h4>
<p><code>lean -T100000 --make src/algebra/order/field.lean</code> generates an empty <code>olean</code>, <code>lean --make src/algebra/order/field.lean</code> generates a non-empty <code>olean</code>.</p>



<a name="289201479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289201479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289201479">(Jul 11 2022 at 14:49)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Any ideas?</p>



<a name="289204367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289204367" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289204367">(Jul 11 2022 at 15:06)</a>:</h4>
<p>Is there a <code>-T</code> vaule that succeeds?</p>



<a name="289208161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289208161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289208161">(Jul 11 2022 at 15:31)</a>:</h4>
<p><code>-T130000</code> seems to be enough</p>



<a name="289214500"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289214500" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289214500">(Jul 11 2022 at 16:11)</a>:</h4>
<p>I guess it hits the timeout somehow partway through serialization?</p>



<a name="289215465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289215465" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289215465">(Jul 11 2022 at 16:19)</a>:</h4>
<p><a href="https://tqft.net/mathlib/algebra/order/field">file#algebra/order/field</a> for reference</p>



<a name="289217374"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289217374" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289217374">(Jul 11 2022 at 16:34)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/pull/15251">#15251</a> increases the timeout pending an actual fix</p>



<a name="289217398"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289217398" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289217398">(Jul 11 2022 at 16:34)</a>:</h4>
<p>The issue is with one of the class definitions: you can remove the rest of the file and still hit the timeout.</p>



<a name="289218760"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289218760" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289218760">(Jul 11 2022 at 16:45)</a>:</h4>
<p>Is it the one on line 35?</p>



<a name="289218857"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289218857" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289218857">(Jul 11 2022 at 16:46)</a>:</h4>
<p><span class="user-mention" data-user-id="321696">@Julian Berman</span> reported seeing an assertion failure there with a custom build of lean</p>



<a name="289218901"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289218901" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289218901">(Jul 11 2022 at 16:46)</a>:</h4>
<p>This is the full message in case it's helpful:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">/</span><span class="n">data</span><span class="bp">/</span><span class="n">data</span><span class="bp">/</span><span class="n">com.termux</span><span class="bp">/</span><span class="n">files</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">Development</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/</span><span class="n">src</span><span class="bp">/</span><span class="n">algebra</span><span class="bp">/</span><span class="n">order</span><span class="bp">/</span><span class="n">field.lean</span><span class="o">:</span> <span class="n">parsing</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">35</span><span class="n">LEAN</span> <span class="n">ASSERTION</span> <span class="n">VIOLATION</span>
<span class="n">File</span><span class="o">:</span> <span class="bp">/</span><span class="n">data</span><span class="bp">/</span><span class="n">data</span><span class="bp">/</span><span class="n">com.termux</span><span class="bp">/</span><span class="n">files</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">Development</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">src</span><span class="bp">/</span><span class="n">frontends</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">local_context_adapter.cpp</span>
<span class="n">Line</span><span class="o">:</span> <span class="mi">59</span>
<span class="n">Task</span><span class="o">:</span>
<span class="bp">/</span><span class="n">data</span><span class="bp">/</span><span class="n">data</span><span class="bp">/</span><span class="n">com.termux</span><span class="bp">/</span><span class="n">files</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">Development</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/</span><span class="n">src</span><span class="bp">/</span><span class="n">algebra</span><span class="bp">/</span><span class="n">order</span><span class="bp">/</span><span class="n">field.lean</span><span class="o">:</span>
<span class="n">parsing</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">35</span>
<span class="bp">!</span><span class="n">has_regular_local</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
<span class="o">(</span><span class="n">C</span><span class="o">)</span><span class="n">ontinue</span><span class="o">,</span> <span class="o">(</span><span class="n">A</span><span class="o">)</span><span class="n">bort</span><span class="bp">/</span><span class="n">exit</span><span class="o">,</span> <span class="o">(</span><span class="n">S</span><span class="o">)</span><span class="n">top</span><span class="bp">/</span><span class="n">trap</span>
</code></pre></div>



<a name="289221884"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289221884" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289221884">(Jul 11 2022 at 17:10)</a>:</h4>
<p>Is this a debug build of lean?</p>



<a name="289230123"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289230123" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289230123">(Jul 11 2022 at 18:18)</a>:</h4>
<p>Here's a MWE:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.field.basic</span>
<span class="kn">import</span> <span class="n">algebra.order.ring</span>

<span class="kd">set_option</span> <span class="n">old_structure_cmd</span> <span class="n">true</span>

<span class="kd">class</span> <span class="n">linear_ordered_semifield</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span>
  <span class="kd">extends</span> <span class="n">linear_ordered_semiring</span> <span class="n">α</span><span class="o">,</span> <span class="n">semifield</span> <span class="n">α</span>

<span class="kd">class</span> <span class="n">linear_ordered_field</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">linear_ordered_comm_ring</span> <span class="n">α</span><span class="o">,</span> <span class="n">field</span> <span class="n">α</span>
</code></pre></div>
<p><code>lean --make -T100000 test.lean</code> causes a 0 byte <code>test.olean</code> file to be produced</p>



<a name="289275332"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289275332" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289275332">(Jul 12 2022 at 03:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/.22saving.20olean.22.3F/near/289221884">said</a>:</p>
<blockquote>
<p>Is this a debug build of lean?</p>
</blockquote>
<p>No just a regular one.</p>



<a name="289278243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289278243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Violeta Hernández <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289278243">(Jul 12 2022 at 04:38)</a>:</h4>
<p>How does this bug affect people not working on this file?</p>



<a name="289278249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289278249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Violeta Hernández <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289278249">(Jul 12 2022 at 04:38)</a>:</h4>
<p>Does CI still work?</p>



<a name="289286215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289286215" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289286215">(Jul 12 2022 at 07:03)</a>:</h4>
<p>Whoops, I guess I caused this!</p>



<a name="289328538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289328538" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289328538">(Jul 12 2022 at 14:04)</a>:</h4>
<p>Can we bump the timeout with a <code>set_option</code> command in this file somehow?</p>



<a name="289328604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289328604" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289328604">(Jul 12 2022 at 14:05)</a>:</h4>
<p>Because I think right now the lean server reparses this file every time its restarted, which makes the orange bars slower to disappear</p>



<a name="289409725"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289409725" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289409725">(Jul 13 2022 at 02:37)</a>:</h4>
<p>Did you merge master?</p>



<a name="289409777"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/289409777" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#289409777">(Jul 13 2022 at 02:38)</a>:</h4>
<p>I mean, after <a href="https://github.com/leanprover-community/mathlib/pull/15251">#15251</a></p>



<a name="290171657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290171657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290171657">(Jul 19 2022 at 22:52)</a>:</h4>
<p><span class="user-group-mention" data-user-group-id="2494">@maintainers</span> I've just got an invalid cache again in <a href="https://github.com/leanprover-community/mathlib/pull/15490">#15490</a> (didn't test on <code>master</code> yet). New empty file : <code>algebra.order.complete_field</code> (a leaf in the import tree). It looks like <code>topology.algebra.module.basic</code> is invalid too but it is not empty.</p>



<a name="290171703"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290171703" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290171703">(Jul 19 2022 at 22:53)</a>:</h4>
<p>I'll try to pack <code>npow</code>/<code>zpow</code> into a structures as <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> suggested.</p>



<a name="290171814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290171814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290171814">(Jul 19 2022 at 22:54)</a>:</h4>
<p>Also, <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> , will it help if we extend <code>has_*</code> before <code>semigroup</code> etc so that Lean doesn't need to construct ad-hoc instances for axioms?</p>



<a name="290171858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290171858" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290171858">(Jul 19 2022 at 22:55)</a>:</h4>
<p>Does saving oleans allocate memory? If so, does that count towards the heartbeat limit? If so, should it?</p>



<a name="290171975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290171975" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290171975">(Jul 19 2022 at 22:56)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> may know</p>



<a name="290237379"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290237379" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290237379">(Jul 20 2022 at 13:52)</a>:</h4>
<p>I get an empty <code>algebra.order.field</code> olean again.</p>



<a name="290243684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290243684" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290243684">(Jul 20 2022 at 14:36)</a>:</h4>
<p>Is it worth splitting out the def to another file temporarily?</p>



<a name="290243708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290243708" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290243708">(Jul 20 2022 at 14:36)</a>:</h4>
<p>That way there's less non-existent olean</p>



<a name="290266584"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290266584" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290266584">(Jul 20 2022 at 17:13)</a>:</h4>
<p>This has already been mentioned by <span class="user-mention" data-user-id="321696">@Julian Berman</span> above, but I get the following error on your branch:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="bp">~/</span><span class="n">lean</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">lean</span> <span class="bp">-</span><span class="n">T150000</span> <span class="c1">--make src/algebra/order/field.lean</span>
<span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">collares</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/</span><span class="n">src</span><span class="bp">/</span><span class="n">order</span><span class="bp">/</span><span class="n">monotone.lean</span><span class="o">:</span> <span class="n">strict_mono.ite'LEAN</span> <span class="n">ASSERTION</span> <span class="n">VIOLATION</span>
<span class="n">File</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">collares</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">src</span><span class="bp">/</span><span class="n">frontends</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">local_context_adapter.cpp</span>
<span class="n">Line</span><span class="o">:</span> <span class="mi">59</span>
<span class="n">Task</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">collares</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/</span><span class="n">src</span><span class="bp">/</span><span class="n">data</span><span class="bp">/</span><span class="n">nat</span><span class="bp">/</span><span class="n">cast</span><span class="bp">/</span><span class="n">defs.lean</span><span class="o">:</span> <span class="n">parsing</span> <span class="n">at</span> <span class="n">line</span> <span class="mi">38</span>
<span class="bp">!</span><span class="n">has_regular_local</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
<span class="o">(</span><span class="n">C</span><span class="o">)</span><span class="n">ontinue</span><span class="o">,</span> <span class="o">(</span><span class="n">A</span><span class="o">)</span><span class="n">bort</span><span class="bp">/</span><span class="n">exit</span><span class="o">,</span> <span class="o">(</span><span class="n">S</span><span class="o">)</span><span class="n">top</span><span class="bp">/</span><span class="n">trap</span>
</code></pre></div>



<a name="290266800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290266800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290266800">(Jul 20 2022 at 17:15)</a>:</h4>
<p><a href="https://github.com/leanprover-community/lean/blob/65ad4ffdb3abac75be748554e3cbe990fb1c6500/src/frontends/lean/local_context_adapter.cpp#L59">https://github.com/leanprover-community/lean/blob/65ad4ffdb3abac75be748554e3cbe990fb1c6500/src/frontends/lean/local_context_adapter.cpp#L59</a>, for reference</p>



<a name="290267532"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290267532" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290267532">(Jul 20 2022 at 17:20)</a>:</h4>
<p>It is reproducible with <code>~/lean/bin/lean -T150000 --make src/data/int/cast/defs.lean</code> too. Running it under gdb says the call comes from <code>parser::elaborate</code> (<a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/frontends/lean/parser.cpp#L873">https://github.com/leanprover-community/lean/blob/v3.45.0/src/frontends/lean/parser.cpp#L873</a>), and</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">(</span><span class="n">gdb</span><span class="o">)</span> <span class="n">p</span> <span class="n">print</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
<span class="n">typed_expr</span> <span class="kt">Sort</span><span class="bp">.</span><span class="o">{</span><span class="mi">4</span><span class="bp">.</span><span class="n">_.17</span><span class="o">}</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="n">as_is</span> <span class="kt">Type</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">})</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">has_int_cast.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span><span class="o">))</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">add_group.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span><span class="o">))</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">add_monoid_with_one.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span><span class="o">))</span> <span class="o">(</span><span class="n">add</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">R</span> <span class="bp">-&gt;</span> <span class="n">R</span> <span class="bp">-&gt;</span> <span class="n">R</span><span class="o">))</span> <span class="o">(</span><span class="n">add_assoc</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_add.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span><span class="o">)</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_add.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="n">c</span><span class="o">)</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_add.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_add.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span><span class="o">)</span> <span class="n">b</span> <span class="n">c</span><span class="o">)))))</span> <span class="o">(</span><span class="n">zero</span> <span class="o">:</span> <span class="n">as_is</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">zero_add</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_add.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span><span class="o">)</span> <span class="o">(</span><span class="n">has_zero.zero.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_zero.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">zero</span><span class="o">))</span> <span class="n">a</span><span class="o">)</span> <span class="n">a</span><span class="o">)))</span> <span class="o">(</span><span class="n">add_zero</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_add.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">has_zero.zero.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_zero.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">zero</span><span class="o">)))</span> <span class="n">a</span><span class="o">))),</span> <span class="o">(</span><span class="k">let</span> <span class="n">nsmul</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">R</span> <span class="bp">-&gt;</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_group.nsmul._default</span><span class="o">)</span> <span class="mi">4</span><span class="bp">.</span><span class="n">_.11</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">zero</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">zero_add</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_zero</span><span class="o">)</span> <span class="k">in</span> <span class="k">Pi</span> <span class="o">(</span><span class="n">nsmul_zero'</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">auto_param.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="o">(</span><span class="n">has_zero.zero.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat.has_zero</span><span class="o">)</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">has_zero.zero.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.to_has_zero.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">zero</span> <span class="n">add</span> <span class="n">zero_add</span> <span class="n">add_zero</span><span class="o">)))))</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"try_refl_tac"</span> <span class="n">name.anonymous</span><span class="o">)))</span> <span class="o">(</span><span class="n">nsmul_succ'</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">auto_param.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="o">(</span><span class="n">nat.succ</span> <span class="n">n</span><span class="o">)</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.to_has_add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">zero</span> <span class="n">add</span> <span class="n">zero_add</span> <span class="n">add_zero</span><span class="o">))</span> <span class="n">x</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="n">n</span> <span class="n">x</span><span class="o">))))</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"try_refl_tac"</span> <span class="n">name.anonymous</span><span class="o">)))</span> <span class="o">(</span><span class="n">neg</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">R</span> <span class="bp">-&gt;</span> <span class="n">R</span><span class="o">)),</span> <span class="o">(</span><span class="k">let</span> <span class="n">sub</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">R</span> <span class="bp">-&gt;</span> <span class="n">R</span> <span class="bp">-&gt;</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_group.sub._default</span><span class="o">)</span> <span class="mi">4</span><span class="bp">.</span><span class="n">_.12</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_assoc</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">zero</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">zero_add</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_zero</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="bp">#</span><span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">nsmul_zero'</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">nsmul_succ'</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">neg</span><span class="o">)</span> <span class="k">in</span> <span class="k">Pi</span> <span class="o">(</span><span class="n">sub_eq_add_neg</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">auto_param.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_sub.sub.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_sub.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="bp">#</span><span class="mi">0</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.to_has_add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.to_add_zero_class.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span> <span class="n">add_assoc</span> <span class="n">zero</span> <span class="n">zero_add</span> <span class="n">add_zero</span> <span class="bp">#</span><span class="mi">1</span> <span class="n">nsmul_zero'</span> <span class="n">nsmul_succ'</span><span class="o">)))</span> <span class="n">a</span> <span class="o">(</span><span class="n">has_neg.neg.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_neg.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">neg</span><span class="o">)</span> <span class="n">b</span><span class="o">))))</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"try_refl_tac"</span> <span class="n">name.anonymous</span><span class="o">))),</span> <span class="o">(</span><span class="k">let</span> <span class="n">zsmul</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">int</span> <span class="bp">-&gt;</span> <span class="n">R</span> <span class="bp">-&gt;</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_group.zsmul._default</span><span class="o">)</span> <span class="mi">4</span><span class="bp">.</span><span class="n">_.13</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_assoc</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">zero</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">zero_add</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_zero</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="bp">#</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">nsmul_zero'</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">nsmul_succ'</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">neg</span><span class="o">)</span> <span class="k">in</span> <span class="k">Pi</span> <span class="o">(</span><span class="n">zsmul_zero'</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">auto_param.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="o">(</span><span class="n">has_zero.zero.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span> <span class="n">int.has_zero</span><span class="o">)</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">has_zero.zero.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.to_has_zero.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.to_add_zero_class.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span> <span class="n">add_assoc</span> <span class="n">zero</span> <span class="n">zero_add</span> <span class="n">add_zero</span> <span class="bp">#</span><span class="mi">2</span> <span class="n">nsmul_zero'</span> <span class="n">nsmul_succ'</span><span class="o">))))))</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"try_refl_tac"</span> <span class="n">name.anonymous</span><span class="o">)))</span> <span class="o">(</span><span class="n">zsmul_succ'</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">auto_param.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="o">(</span><span class="n">int.of_nat</span> <span class="o">(</span><span class="n">nat.succ</span> <span class="n">n</span><span class="o">))</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.to_has_add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.to_add_zero_class.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span> <span class="n">add_assoc</span> <span class="n">zero</span> <span class="n">zero_add</span> <span class="n">add_zero</span> <span class="bp">#</span><span class="mi">2</span> <span class="n">nsmul_zero'</span> <span class="n">nsmul_succ'</span><span class="o">)))</span> <span class="n">a</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="o">(</span><span class="n">int.of_nat</span> <span class="n">n</span><span class="o">)</span> <span class="n">a</span><span class="o">))))</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"try_refl_tac"</span> <span class="n">name.anonymous</span><span class="o">)))</span> <span class="o">(</span><span class="n">zsmul_neg'</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">auto_param.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="o">(</span><span class="n">int.neg_succ_of_nat</span> <span class="n">n</span><span class="o">)</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">has_neg.neg.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_neg.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">neg</span><span class="o">)</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="o">(</span><span class="n">coe.</span><span class="o">{</span><span class="mi">1</span> <span class="mi">1</span><span class="o">}</span> <span class="n">nat</span> <span class="n">int</span> <span class="o">(</span><span class="n">coe_to_lift.</span><span class="o">{</span><span class="mi">1</span> <span class="mi">1</span><span class="o">}</span> <span class="n">nat</span> <span class="n">int</span> <span class="o">(</span><span class="n">coe_base.</span><span class="o">{</span><span class="mi">1</span> <span class="mi">1</span><span class="o">}</span> <span class="n">nat</span> <span class="n">int</span> <span class="n">int.has_coe</span><span class="o">))</span> <span class="o">(</span><span class="n">nat.succ</span> <span class="n">n</span><span class="o">))</span> <span class="n">a</span><span class="o">))))</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"try_refl_tac"</span> <span class="n">name.anonymous</span><span class="o">)))</span> <span class="o">(</span><span class="n">add_left_neg</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.to_has_add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.to_add_zero_class.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">sub_neg_monoid.to_add_monoid.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">sub_neg_monoid.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span> <span class="n">add_assoc</span> <span class="n">zero</span> <span class="n">zero_add</span> <span class="n">add_zero</span> <span class="bp">#</span><span class="mi">2</span> <span class="n">nsmul_zero'</span> <span class="n">nsmul_succ'</span> <span class="n">neg</span> <span class="bp">#</span><span class="mi">1</span> <span class="n">sub_eq_add_neg</span> <span class="bp">#</span><span class="mi">0</span> <span class="n">zsmul_zero'</span> <span class="n">zsmul_succ'</span> <span class="n">zsmul_neg'</span><span class="o">))))</span> <span class="o">(</span><span class="n">has_neg.neg.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">sub_neg_monoid.to_has_neg.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">sub_neg_monoid.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span> <span class="n">add_assoc</span> <span class="n">zero</span> <span class="n">zero_add</span> <span class="n">add_zero</span> <span class="bp">#</span><span class="mi">2</span> <span class="n">nsmul_zero'</span> <span class="n">nsmul_succ'</span> <span class="n">neg</span> <span class="bp">#</span><span class="mi">1</span> <span class="n">sub_eq_add_neg</span> <span class="bp">#</span><span class="mi">0</span> <span class="n">zsmul_zero'</span> <span class="n">zsmul_succ'</span> <span class="n">zsmul_neg'</span><span class="o">))</span> <span class="n">a</span><span class="o">)</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">has_zero.zero.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.to_has_zero.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.to_add_zero_class.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">sub_neg_monoid.to_add_monoid.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">sub_neg_monoid.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span> <span class="n">add_assoc</span> <span class="n">zero</span> <span class="n">zero_add</span> <span class="n">add_zero</span> <span class="bp">#</span><span class="mi">2</span> <span class="n">nsmul_zero'</span> <span class="n">nsmul_succ'</span> <span class="n">neg</span> <span class="bp">#</span><span class="mi">1</span> <span class="n">sub_eq_add_neg</span> <span class="bp">#</span><span class="mi">0</span> <span class="n">zsmul_zero'</span> <span class="n">zsmul_succ'</span> <span class="n">zsmul_neg'</span><span class="o">)))))))),</span> <span class="o">(</span><span class="k">let</span> <span class="n">nat_cast</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_monoid_with_one.nat_cast._default</span><span class="o">)</span> <span class="mi">4</span><span class="bp">.</span><span class="n">_.14</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">one</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_assoc</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">zero</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">zero_add</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">add_zero</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="bp">#</span><span class="mi">2</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">nsmul_zero'</span><span class="o">)</span> <span class="o">(</span><span class="bp">«@»</span> <span class="n">nsmul_succ'</span><span class="o">)</span> <span class="k">in</span> <span class="k">Pi</span> <span class="o">(</span><span class="n">one</span> <span class="o">:</span> <span class="n">as_is</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">nat_cast_zero</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">auto_param.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="o">(</span><span class="n">has_zero.zero.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat.has_zero</span><span class="o">))</span> <span class="o">(</span><span class="n">has_zero.zero.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.to_has_zero.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.to_add_zero_class.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span> <span class="n">add_assoc</span> <span class="n">zero</span> <span class="n">zero_add</span> <span class="n">add_zero</span> <span class="bp">#</span><span class="mi">3</span> <span class="n">nsmul_zero'</span> <span class="n">nsmul_succ'</span><span class="o">)))))</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"control_laws_tac"</span> <span class="n">name.anonymous</span><span class="o">)))</span> <span class="o">(</span><span class="n">nat_cast_succ</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">auto_param.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">nat</span><span class="o">),</span> <span class="o">(</span><span class="n">eq.</span><span class="o">{</span><span class="n">succ</span> <span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat.has_add</span> <span class="n">n</span> <span class="o">(</span><span class="n">has_one.one.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat.has_one</span><span class="o">)))</span> <span class="o">(</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_zero_class.to_has_add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.to_add_zero_class.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">add_monoid.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">add</span> <span class="n">add_assoc</span> <span class="n">zero</span> <span class="n">zero_add</span> <span class="n">add_zero</span> <span class="bp">#</span><span class="mi">3</span> <span class="n">nsmul_zero'</span> <span class="n">nsmul_succ'</span><span class="o">)))</span> <span class="o">(</span><span class="bp">#</span><span class="mi">0</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">has_one.one.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="o">(</span><span class="n">has_one.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span> <span class="n">one</span><span class="o">)))))</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"control_laws_tac"</span> <span class="n">name.anonymous</span><span class="o">)))</span> <span class="o">(</span><span class="n">int_cast_of_nat</span> <span class="o">:</span> <span class="n">auto_param</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">nat</span><span class="o">),</span> <span class="o">(</span><span class="n">eq</span> <span class="o">(</span><span class="n">int_cast</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">typed_expr</span> <span class="n">R</span> <span class="n">n</span><span class="o">)))</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"control_laws_tac"</span> <span class="n">name.anonymous</span><span class="o">))</span> <span class="o">(</span><span class="n">int_cast_neg_succ_of_nat</span> <span class="o">:</span> <span class="n">auto_param</span> <span class="o">(</span><span class="k">Pi</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">nat</span><span class="o">),</span> <span class="o">(</span><span class="n">eq</span> <span class="o">(</span><span class="n">int_cast</span> <span class="o">(</span><span class="n">has_neg.neg</span> <span class="o">(</span><span class="n">typed_expr</span> <span class="n">nat</span> <span class="o">(</span><span class="n">has_add.add</span> <span class="n">n</span> <span class="mi">1</span><span class="o">))))</span> <span class="o">(</span><span class="n">has_neg.neg</span> <span class="o">(</span><span class="n">typed_expr</span> <span class="n">R</span> <span class="o">(</span><span class="n">typed_expr</span> <span class="n">nat</span> <span class="o">(</span><span class="n">has_add.add</span> <span class="n">n</span> <span class="mi">1</span><span class="o">))))))</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"control_laws_tac"</span> <span class="n">name.anonymous</span><span class="o">)),</span> <span class="o">(</span><span class="k">let</span> <span class="n">_ffresh.0</span> <span class="o">:</span> <span class="n">as_is</span> <span class="o">(</span><span class="n">int</span> <span class="bp">-&gt;</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="n">int.cast_def</span> <span class="k">in</span> <span class="kt">Prop</span><span class="o">))))))</span>
</code></pre></div>



<a name="290267746"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290267746" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290267746">(Jul 20 2022 at 17:22)</a>:</h4>
<p>Let me check if the same assertion failure happens on master.</p>



<a name="290268560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290268560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290268560">(Jul 20 2022 at 17:28)</a>:</h4>
<p>Yes, it happens on master too. So this might be a red herring, who knows.</p>



<a name="290270657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290270657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290270657">(Jul 20 2022 at 17:42)</a>:</h4>
<p><span class="user-mention" data-user-id="325367">@Mauricio Collares</span>, I assume this is a debug build?</p>



<a name="290270681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290270681" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290270681">(Jul 20 2022 at 17:42)</a>:</h4>
<p>Which would explain why you get that error but we don't in CI</p>



<a name="290273055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290273055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290273055">(Jul 20 2022 at 17:59)</a>:</h4>
<p>how many errors do you get if you just continue all of them?</p>



<a name="290273067"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290273067" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290273067">(Jul 20 2022 at 17:59)</a>:</h4>
<p>because this is just the first assertion error</p>



<a name="290275693"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290275693" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290275693">(Jul 20 2022 at 18:16)</a>:</h4>
<p>Lean doesn't like that <a href="https://gist.github.com/collares/aff41ec149685438f54f28c9087c8efe">a particular expression obtained when elaborating <code>add_monoid_with_one</code></a> contains the following non-<code>decl_ref</code> (whatever this is) local after the <code>replace_locals</code> call in <a href="https://github.com/leanprover-community/lean/blob/65ad4ffdb3abac75be748554e3cbe990fb1c6500/src/frontends/lean/local_context_adapter.cpp#L58">https://github.com/leanprover-community/lean/blob/65ad4ffdb3abac75be748554e3cbe990fb1c6500/src/frontends/lean/local_context_adapter.cpp#L58</a> (in fact, the <code>replace_locals</code> call seems to be a no-op in this case):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">lean</span><span class="o">::</span><span class="n">expr</span><span class="o">[</span><span class="n">Local</span><span class="o">]</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_pp_name</span> <span class="bp">=</span> <span class="bp">'</span><span class="n">nat_cast'</span><span class="o">,</span> <span class="n">m_name</span> <span class="bp">=</span> <span class="bp">'</span><span class="n">nat_cast'</span><span class="o">,</span> <span class="n">m_bi</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m_strict_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m_inst_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m_rec</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">},</span> <span class="n">m_type</span> <span class="bp">=</span> <span class="n">lean</span><span class="o">::</span><span class="n">expr</span><span class="o">[</span><span class="n">Macro</span><span class="o">]</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_definition</span> <span class="bp">=</span> <span class="o">{</span>
    <span class="n">m_ptr</span> <span class="bp">=</span> <span class="mi">0x1841e80</span><span class="o">},</span> <span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="bp">=</span> <span class="n">lean</span><span class="o">::</span><span class="n">expr</span><span class="o">[</span><span class="k">Pi</span><span class="o">]</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_binder</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_name</span> <span class="bp">=</span> <span class="sc">'ᾰ'</span><span class="o">,</span> <span class="n">m_type</span> <span class="bp">=</span> <span class="n">lean</span><span class="o">::</span><span class="n">expr</span><span class="o">[</span><span class="n">Constant</span><span class="o">]</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_name</span> <span class="bp">=</span> <span class="bp">'</span><span class="n">nat'</span><span class="o">,</span> <span class="n">m_levels</span> <span class="bp">=</span> <span class="n">lean</span><span class="o">::</span><span class="n">levels</span><span class="o">},</span> <span class="n">m_info</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m_strict_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
          <span class="n">m_inst_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m_rec</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">}},</span> <span class="n">m_body</span> <span class="bp">=</span> <span class="n">lean</span><span class="o">::</span><span class="n">expr</span><span class="o">[</span><span class="n">Var</span><span class="o">]</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_vidx</span> <span class="bp">=</span> <span class="mi">13</span><span class="o">}}}}</span>
</code></pre></div>
<p>This started happening immediately after <a href="https://github.com/leanprover-community/mathlib/pull/12182">#12182</a>.</p>



<a name="290278306"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290278306" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290278306">(Jul 20 2022 at 18:33)</a>:</h4>
<p>On <code>src/data/nat/cast/defs.lean</code>, the only assertion failures are <code>!has_regular_local(e)</code> and <code>!has_regular_local(r)</code> (from <code>local_context_adapter.cpp</code>. The same errors happen in <code>src/data/int/cast/defs.lean:{40,51}</code> and <code>src/algebra/ring/basic.lean:{754,866}</code> (so basically anything that uses <code>add_monoid_with_one</code>).</p>



<a name="290286516"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290286516" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290286516">(Jul 20 2022 at 19:29)</a>:</h4>
<p>Minimized:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">old_structure_cmd</span> <span class="n">true</span>

<span class="kd">class</span> <span class="n">has_nat_cast</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">nat_cast</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span>

<span class="kd">class</span> <span class="n">add_monoid_with_one</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">has_nat_cast</span> <span class="n">R</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">nat_cast</span> <span class="o">:=</span> <span class="gr">sorry</span><span class="o">)</span>
<span class="o">(</span><span class="n">nat_cast_zero</span> <span class="o">:</span> <span class="n">R</span> <span class="o">:=</span> <span class="n">nat_cast</span> <span class="mi">0</span><span class="o">)</span>
</code></pre></div>



<a name="290318371"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290318371" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290318371">(Jul 21 2022 at 00:34)</a>:</h4>
<p>Coming back to the original problem: Lean seems to spend a lot of time doing equality checking in <code>expr_eq_fn.cpp</code> (perhaps because the equality cache is too small?) and throws a heartbeat exception (as is expected from the fact that it works without <code>-T150000</code>). However, tasks killed by uncaught exceptions just die silently, as can be verified by blocking the olean creation process by removing write permissions from the file.</p>



<a name="290622450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290622450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290622450">(Jul 23 2022 at 16:45)</a>:</h4>
<p>I must be missing something, but I don't see how <code>eq_cache</code> at <a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/kernel/expr_eq_fn.cpp#L70">https://github.com/leanprover-community/lean/blob/v3.45.0/src/kernel/expr_eq_fn.cpp#L70</a> works. It only seems to cache equality of exprs by identity (equal values of <code>raw()</code>), and it does not seem to save the value of the equality check after an expensive comparison. One may think that <a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/kernel/expr.cpp#L401">the <code>expr_cache</code></a> would cause each expr to have few copies in memory, but <code>elaborate</code> <a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/frontends/lean/elaborator.cpp#L4043">calls <code>finalize</code></a>, which <a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/frontends/lean/elaborator.cpp#L3982">flushes the expr cache</a>. </p>
<p>When running <code>lean --make -T150000 src/algebra/order/field.lean</code>, there are 65 (!) objects with hash <code>0xfe0560ec</code>, and I assume most of them are true copies of each other. Serializing those objects <a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/util/object_serializer.h#L26">involves a lot of comparisons</a> which <a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/kernel/expr_eq_fn.cpp#L63">increment the heartbeat counter</a>.</p>



<a name="290623360"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290623360" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290623360">(Jul 23 2022 at 17:04)</a>:</h4>
<p>Wait, I read <code>eq_cache</code> wrong before but I am now even more confused. It seems that (up to hash collisions) it caches whether <code>apply()</code> was called for two given inputs. If it does, next calls to <code>apply()</code> always return true?!</p>



<a name="290624704"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290624704" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290624704">(Jul 23 2022 at 17:31)</a>:</h4>
<p>I just checked and my assumption that most of them are copies of each other was plain wrong. There are 59158 comparisons between two exprs <code>a</code> and <code>b</code> with <code>a.hash() == 0xfe0560ec</code>, <code>b.hash() == 0xfe0560ec</code> and <code>a.raw() != b.raw()</code>, and they all return false.</p>



<a name="290624807"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290624807" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290624807">(Jul 23 2022 at 17:33)</a>:</h4>
<p>Some pairs of pointers are compared up to 32 times (this might be because the cache is thread-local, or just because <code>expr_eq_fn</code>'s destructor clears the cache).</p>



<a name="290624980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290624980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ben Toner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290624980">(Jul 23 2022 at 17:36)</a>:</h4>
<p>A low effort way to fix this in CI would be to build with a high <code>-T</code> timeout (or no timeout) the second time around, i.e.,</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>lean --json -T100000 --make src <span class="p">|</span> python3 scripts/detect_errors.py
lean --json -T400000 --make src <span class="p">|</span> python3 scripts/detect_errors.py
</code></pre></div>



<a name="290626312"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290626312" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290626312">(Jul 23 2022 at 18:11)</a>:</h4>
<p>So, to summarize: the problem here that the equality cache is flushed often because it is not meant to speed up the case of hash collisions. It might be worth checking if it's a hashing bug in the presence of <code>old_structure_cmd</code>, but it might just be an unfortunate hash collision, in which case it might be worth just waiting for Lean 4.</p>
<p>Since this only shows up when saving oleans, I think Ben's suggestion has fantastic cost/benefit. The second command should execute only if the first one succeeds, though; the exit code is 0 even when the generated olean is empty, so the idea still works. This could be done internally by increasing the heartbeat limit during olean generation, but I don't think it's worth it.</p>



<a name="290626356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290626356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290626356">(Jul 23 2022 at 18:12)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> had a similar problem before, maybe it's the same problem after all.</p>



<a name="290627493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290627493" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290627493">(Jul 23 2022 at 18:41)</a>:</h4>
<p>Something that seems suspicious is that the hash collisions all happen as a result of calling <a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/kernel/expr_eq_fn.cpp#L132"><code>is_bi_equal</code></a>, but the hash for exprs <a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/kernel/expr.cpp#L249">does not take binder_info into account</a> (there's a special <a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/kernel/expr.cpp#L890"><code>hash_bi</code></a> function for computing a hash which uses this extra information). Maybe this is particularly relevant for <code>old_structure_cmd</code>, or maybe this is particularly relevant for serialization because <a href="https://github.com/leanprover-community/lean/blob/v3.45.0/src/library/kernel_serializer.cpp#L135">the serializer is one of the few things that uses <code>is_bi_equal_proc</code></a>.</p>



<a name="290628425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/290628425" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#290628425">(Jul 23 2022 at 19:03)</a>:</h4>
<p>The obvious fix for the above would be something like</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/src/kernel/expr_eq_fn.cpp b/src/kernel/expr_eq_fn.cpp</span><span class="w"></span>
<span class="gh">index 50c1420dd..19ec72adc 100644</span><span class="w"></span>
<span class="gd">--- a/src/kernel/expr_eq_fn.cpp</span><span class="w"></span>
<span class="gi">+++ b/src/kernel/expr_eq_fn.cpp</span><span class="w"></span>
<span class="gu">@@ -69,6 +69,8 @@ class expr_eq_fn {</span><span class="w"></span>
<span class="w"> </span>        if (is_var(a))             return var_idx(a) == var_idx(b);<span class="w"></span>
<span class="w"> </span>        if (m_cache.check(a, b))<span class="w"></span>
<span class="w"> </span>            return true;<span class="w"></span>
<span class="gi">+        if (CompareBinderInfo &amp;&amp; hash_bi(a) != hash_bi(b))</span><span class="w"></span>
<span class="gi">+            return false;</span><span class="w"></span>
<span class="w"> </span>        switch (a.kind()) {<span class="w"></span>
<span class="w"> </span>        case expr_kind::Var:<span class="w"></span>
<span class="w"> </span>            lean_unreachable(); // LCOV_EXCL_LINE<span class="w"></span>
</code></pre></div>
<p>but this is super slow because <code>hash_bi</code> is not cached. By the way, I noticed that binder_info was simplified in Lean 4's kernel and <code>hash_bi</code> no longer exists.</p>



<a name="291311212"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291311212" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291311212">(Jul 29 2022 at 11:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="325367">Mauricio Collares</span> <a href="#narrow/stream/113488-general/topic/.22saving.20olean.22.3F/near/290318371">said</a>:</p>
<blockquote>
<p>However, tasks killed by uncaught exceptions just die silently, as can be verified by blocking the olean creation process by removing write permissions from the file.</p>
</blockquote>
<p>This feels like a major bug to me, but I can't track down where this is happening</p>



<a name="291311280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291311280" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291311280">(Jul 29 2022 at 11:48)</a>:</h4>
<p>A quick glance at the task infrastructure suggests it is capturing and rethrowing exceptions</p>



<a name="291311449"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291311449" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291311449">(Jul 29 2022 at 11:50)</a>:</h4>
<blockquote>
<p>but it might just be an unfortunate hash collision, in which case it might be worth just waiting for Lean 4.</p>
</blockquote>
<p>My undergraduates are getting orange bar hell and I'm not sure they want to wait for Lean 4, their internships finish next month. Can we implement Ben's solution or are there reasons against doing so? In particular are we still bug hunting?</p>



<a name="291312021"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291312021" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291312021">(Jul 29 2022 at 11:58)</a>:</h4>
<p><span class="user-mention" data-user-id="325367">@Mauricio Collares</span>: Do you think a <code>scope_max_heartbeat scope(0);</code> in <code>expr_serializer::write_core</code> would help here?</p>



<a name="291312043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291312043" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291312043">(Jul 29 2022 at 11:58)</a>:</h4>
<p>With the hope that that would disable deterministic timeouts from ever occurring during writing oleans.</p>



<a name="291312805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291312805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291312805">(Jul 29 2022 at 12:07)</a>:</h4>
<p>I think implementing Ben's suggestion would be great!</p>



<a name="291313038"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291313038" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291313038">(Jul 29 2022 at 12:10)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> That sounds reasonable, but I don't have any experience with this code so it's hard for me to tell.</p>



<a name="291313391"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291313391" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291313391">(Jul 29 2022 at 12:14)</a>:</h4>
<p>I created an issue to track the assertion failure, <a href="https://github.com/leanprover-community/lean/issues/748">https://github.com/leanprover-community/lean/issues/748</a></p>



<a name="291313773"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291313773" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291313773">(Jul 29 2022 at 12:18)</a>:</h4>
<p>Thank you! I now think that the assertion failure is either unrelated or has the same root cause (BinderInfo-unaware hash being used somewhere that cares about BinderInfo). I will file this other issue so it can be referenced with Ben's workaround.</p>



<a name="291313985"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291313985" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291313985">(Jul 29 2022 at 12:21)</a>:</h4>
<p>An issue about the silent write permission failure is also worth filing</p>



<a name="291316288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291316288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291316288">(Jul 29 2022 at 12:48)</a>:</h4>
<p>Filed <a href="https://github.com/leanprover-community/lean/pull/749">lean#749</a> and <a href="https://github.com/leanprover-community/lean/pull/750">lean#750</a></p>



<a name="291316668"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291316668" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291316668">(Jul 29 2022 at 12:52)</a>:</h4>
<p>I had a brief go at debugging, but for some reason I can't get gdb (via VScode) to actually use the pretty printers, so it's pretty much impossible</p>



<a name="291347465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291347465" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291347465">(Jul 29 2022 at 16:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="325367">Mauricio Collares</span> <a href="#narrow/stream/113488-general/topic/.22saving.20olean.22.3F/near/290275693">said</a>:</p>
<blockquote>
<p>Lean doesn't like that <a href="https://gist.github.com/collares/aff41ec149685438f54f28c9087c8efe">a particular expression obtained when elaborating <code>add_monoid_with_one</code></a> contains the following non-<code>decl_ref</code> (whatever this is) local after the <code>replace_locals</code> call in <a href="https://github.com/leanprover-community/lean/blob/65ad4ffdb3abac75be748554e3cbe990fb1c6500/src/frontends/lean/local_context_adapter.cpp#L58">https://github.com/leanprover-community/lean/blob/65ad4ffdb3abac75be748554e3cbe990fb1c6500/src/frontends/lean/local_context_adapter.cpp#L58</a> (in fact, the <code>replace_locals</code> call seems to be a no-op in this case):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">lean</span><span class="o">::</span><span class="n">expr</span><span class="o">[</span><span class="n">Local</span><span class="o">]</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_pp_name</span> <span class="bp">=</span> <span class="bp">'</span><span class="n">nat_cast'</span><span class="o">,</span> <span class="n">m_name</span> <span class="bp">=</span> <span class="bp">'</span><span class="n">nat_cast'</span><span class="o">,</span> <span class="n">m_bi</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m_strict_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m_inst_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m_rec</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">},</span> <span class="n">m_type</span> <span class="bp">=</span> <span class="n">lean</span><span class="o">::</span><span class="n">expr</span><span class="o">[</span><span class="n">Macro</span><span class="o">]</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_definition</span> <span class="bp">=</span> <span class="o">{</span>
      <span class="n">m_ptr</span> <span class="bp">=</span> <span class="mi">0x1841f00</span><span class="o">},</span> <span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="bp">=</span> <span class="n">lean</span><span class="o">::</span><span class="n">expr</span><span class="o">[</span><span class="k">Pi</span><span class="o">]</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_binder</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_name</span> <span class="bp">=</span> <span class="sc">'ᾰ'</span><span class="o">,</span> <span class="n">m_type</span> <span class="bp">=</span> <span class="n">lean</span><span class="o">::</span><span class="n">expr</span><span class="o">[</span><span class="n">Constant</span><span class="o">]</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_name</span> <span class="bp">=</span> <span class="bp">'</span><span class="n">nat'</span><span class="o">,</span> <span class="n">m_levels</span> <span class="bp">=</span> <span class="n">lean</span><span class="o">::</span><span class="n">levels</span><span class="o">},</span> <span class="n">m_info</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m_strict_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
          <span class="n">m_inst_implicit</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">m_rec</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">}},</span> <span class="n">m_body</span> <span class="bp">=</span> <span class="n">lean</span><span class="o">::</span><span class="n">expr</span><span class="o">[</span><span class="n">Var</span><span class="o">]</span> <span class="bp">=</span> <span class="o">{</span><span class="n">m_vidx</span> <span class="bp">=</span> <span class="mi">13</span><span class="o">}}}}</span>
</code></pre></div>
<p>This started happening immediately after <a href="https://github.com/leanprover-community/mathlib/pull/12182">#12182</a>.</p>
</blockquote>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> gdb works here and the above message has some pretty-printed output (it's for <code>data/nat/cast/defs.lean</code>, though). Let me know if I can provide any relevant information!</p>



<a name="291347627"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291347627" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291347627">(Jul 29 2022 at 16:20)</a>:</h4>
<p>(Is it worth splitting the assertion discussion into another thread?)</p>



<a name="291347714"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291347714" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291347714">(Jul 29 2022 at 16:20)</a>:</h4>
<p>See my comment on the issue, I worked out a workaround in the end. I think the vscode/gdb integration is to blame.</p>
<p>The assertion fails due to an occurrence of <code>nat_cast</code> in <code>r</code>, after substituting an empty list of assigned local variables</p>



<a name="291347806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291347806" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291347806">(Jul 29 2022 at 16:21)</a>:</h4>
<p>I suppose it's possible the assertion is just nonsense</p>



<a name="291513403"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291513403" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291513403">(Jul 31 2022 at 21:26)</a>:</h4>
<p>we seem to be no closer to a fix to this issue, so I propose the following stopgap: <a href="https://github.com/leanprover-community/mathlib/pull/15783">#15783</a>. It moves the definitions away from the rest of the file, so that at least we get a lot less olean to recompile.</p>



<a name="291516810"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291516810" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291516810">(Jul 31 2022 at 22:48)</a>:</h4>
<p>I can submit a PR with Ben's workaround (increase the timeout on the second lean run to 400000) if no one's opposed. This does not increase the effective timeout because the first time will error out, but due to the "olean generation errors are not reported" this should allow oleans to be created.</p>



<a name="291517035"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517035" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517035">(Jul 31 2022 at 22:55)</a>:</h4>
<p>I think it's worth submitting the PR and running with it. Maybe even a no-time-limit second run</p>



<a name="291517356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517356">(Jul 31 2022 at 23:03)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/pull/15784">#15784</a></p>



<a name="291517429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517429">(Jul 31 2022 at 23:05)</a>:</h4>
<p>no-timeout is bad, that will cause silly stuff to ddos our servers</p>



<a name="291517472"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517472" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517472">(Jul 31 2022 at 23:06)</a>:</h4>
<p>OK, will re-add the longer timeout</p>



<a name="291517548"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517548" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517548">(Jul 31 2022 at 23:08)</a>:</h4>
<p>how could we be DDoSed? shouldn't the first run stop it?</p>



<a name="291517553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517553">(Jul 31 2022 at 23:08)</a>:</h4>
<p>Silly stuff can already ddos our servers by changing the timeout anyway</p>



<a name="291517560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517560">(Jul 31 2022 at 23:09)</a>:</h4>
<p>usually people don't change the timeout deliberately though</p>



<a name="291517563"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517563" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517563">(Jul 31 2022 at 23:09)</a>:</h4>
<p>I guess you mean accidental ddos-ing</p>



<a name="291517568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517568" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517568">(Jul 31 2022 at 23:09)</a>:</h4>
<p>like someone finds a new and interesting way to make the lean kernel compute the ackermann function</p>



<a name="291517569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517569">(Jul 31 2022 at 23:09)</a>:</h4>
<p>If olean generation starts consuming a lot more heartbeats, I guess it's good to be informed of it</p>



<a name="291517624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517624" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517624">(Jul 31 2022 at 23:10)</a>:</h4>
<p>Because then we can add fix <a href="https://github.com/leanprover-community/lean/pull/749">lean#749</a> properly by adding a second hash</p>



<a name="291517653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517653" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517653">(Jul 31 2022 at 23:11)</a>:</h4>
<p>Perhaps we should test going back to the previous 100000 timeout for the first run. Is there any easy way to tell CI to generate everything from scratch, other than touching an important file or switching to a new Lean version?</p>



<a name="291517902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291517902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291517902">(Jul 31 2022 at 23:18)</a>:</h4>
<p>Hmm, the generated olean is still empty, even though running locally with the same timeout generates a valid olean</p>



<a name="291518249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291518249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291518249">(Jul 31 2022 at 23:29)</a>:</h4>
<p>Ah, never mind, I think my post-commit hook cached a bad olean locally. The remote olean is fine.</p>



<a name="291638823"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291638823" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291638823">(Aug 01 2022 at 21:57)</a>:</h4>
<p>I posted this in <a href="https://github.com/leanprover-community/mathlib/pull/15784">#15784</a>, but perhaps I should have posted it here instead: I compiled eae7a80 from scratch with -T100000 to see if the temporary increase of <a href="https://github.com/leanprover-community/mathlib/pull/15251">#15251</a> can be reverted. Turns out it can't, because src/number_theory/cyclotomic/primitive_roots.lean:134 (<code>embeddings_equiv_primitive_roots</code>) times out.</p>



<a name="291640137"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291640137" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291640137">(Aug 01 2022 at 22:10)</a>:</h4>
<p>I'll try fix that</p>



<a name="291651328"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291651328" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291651328">(Aug 02 2022 at 00:35)</a>:</h4>
<p>okay, so the main issue is the <code>simps</code></p>



<a name="291651335"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291651335" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291651335">(Aug 02 2022 at 00:35)</a>:</h4>
<p>I restated the one useful direction</p>



<a name="291651381"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291651381" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291651381">(Aug 02 2022 at 00:36)</a>:</h4>
<p>and the other ends is <a href="https://leanprover-community.github.io/mathlib_docs/find/is_primitive_root.embeddings_equiv_primitive_roots_symm_apply_apply">docs#is_primitive_root.embeddings_equiv_primitive_roots_symm_apply_apply</a>  which is not a pleasing lemma</p>



<a name="291651395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291651395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291651395">(Aug 02 2022 at 00:36)</a>:</h4>
<p>and I think that if you need something like this you should be unfolding yourself up to <code>power_basis.lift</code> (which can't be done in a nice lemma as it takes some humongous proof term that's basically inlined)</p>



<a name="291651411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291651411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291651411">(Aug 02 2022 at 00:37)</a>:</h4>
<p>so I will  just leave it be</p>



<a name="291652915"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/291652915" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#291652915">(Aug 02 2022 at 01:04)</a>:</h4>
<p>Thanks!</p>



<a name="292563239"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/292563239" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#292563239">(Aug 09 2022 at 11:48)</a>:</h4>
<p>current status: <a href="https://github.com/leanprover-community/mathlib/pull/15783">#15783</a> and <a href="https://github.com/leanprover-community/mathlib/pull/15784">#15784</a> are two different proposals to help with this problem (both fairly small and easy to understand), and <a href="https://github.com/leanprover-community/mathlib/pull/15804">#15804</a> is a speedup that would help with <a href="https://github.com/leanprover-community/mathlib/pull/15784">#15784</a>.</p>



<a name="292563255"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/292563255" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#292563255">(Aug 09 2022 at 11:48)</a>:</h4>
<p>I think merging one or both of these and dealing with the further issues later would be prudent</p>



<a name="294279856"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/294279856" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#294279856">(Aug 19 2022 at 14:39)</a>:</h4>
<p>this problem has now spread to <a href="https://tqft.net/mathlib/algebra/order/complete_field">file#algebra/order/complete_field</a> <a href="/user_uploads/3121/yEjOlFLumvavloEQNgja0rvq/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/yEjOlFLumvavloEQNgja0rvq/image.png" title="image.png"><img src="/user_uploads/3121/yEjOlFLumvavloEQNgja0rvq/image.png"></a></div>



<a name="294407551"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/294407551" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#294407551">(Aug 20 2022 at 08:19)</a>:</h4>
<p>This happened a while ago right? It's still causing problems for my students.</p>



<a name="294407738"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/294407738" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#294407738">(Aug 20 2022 at 08:20)</a>:</h4>
<p>Once again, it's a file I touched <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span></p>



<a name="296240470"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/296240470" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bhavik Mehta <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#296240470">(Aug 31 2022 at 00:28)</a>:</h4>
<p>Can confirm this is still causing problems for me, on a mathlib from yesterday</p>



<a name="296241042"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/296241042" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#296241042">(Aug 31 2022 at 00:37)</a>:</h4>
<p>I still think <a href="https://github.com/leanprover-community/mathlib/pull/15784">#15784</a> is an acceptable stopgap, but if people disagree I can prototype adding a second hash for exprs</p>



<a name="296247456"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/296247456" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#296247456">(Aug 31 2022 at 02:12)</a>:</h4>
<p>I missed this discussion until now but the issue seems serious and <a href="https://github.com/leanprover-community/mathlib/pull/15784">#15784</a> was simple, so I've put it on the queue. If the caches are being polluted with bad / empty oleans that's definitely something that should be addressed with urgency, IMO.</p>



<a name="296685772"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/296685772" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#296685772">(Sep 01 2022 at 19:27)</a>:</h4>
<p>I tested whether we now can decrease the timeout for the first run back to 100000 (which is fine for oleans, since the second run uses <code>-T400000</code> and takes care of them). Eric fixed a timeout a few weeks ago, but recently <code>category_theory/monad/basic.lean:138</code> started timing out too (<a href="https://github.com/leanprover-community/mathlib/runs/8142625879?check_suite_focus=true">https://github.com/leanprover-community/mathlib/runs/8142625879?check_suite_focus=true</a>). That's this instance:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">instance</span> <span class="o">:</span> <span class="n">category</span> <span class="o">(</span><span class="n">monad</span> <span class="n">C</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">hom</span> <span class="o">:=</span> <span class="n">monad_hom</span><span class="o">,</span>
  <span class="n">id</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">M</span><span class="o">,</span> <span class="o">{</span> <span class="n">to_nat_trans</span> <span class="o">:=</span> <span class="mi">𝟙</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="n">C</span> <span class="bp">⥤</span> <span class="n">C</span><span class="o">)</span> <span class="o">},</span>
  <span class="n">comp</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">to_nat_trans</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">app</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">X</span><span class="o">,</span> <span class="n">f.app</span> <span class="n">X</span> <span class="bp">≫</span> <span class="n">g.app</span> <span class="n">X</span> <span class="o">}</span> <span class="o">}</span> <span class="o">}</span>
</code></pre></div>
<p>The profiler says that "elaboration of monad.category took 13.1s".</p>



<a name="296687385"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/296687385" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#296687385">(Sep 01 2022 at 19:38)</a>:</h4>
<p>Feel free to use <a href="https://github.com/leanprover-community/mathlib/tree/decrease-timeout">branch#decrease-timeout</a> to test this, since its olean cache only contains files generated with <code>-T100000</code>. <code>category_theory/limits/cones.lean:713</code> (<code>def cocone_equivalence_op_cone_op : cocone F ≌ (cone F.op)ᵒᵖ</code>) also times out, by the way.</p>



<a name="296693801"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/296693801" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#296693801">(Sep 01 2022 at 20:22)</a>:</h4>
<p>Annoyingly, those deterministic timeouts aren't deterministic. Rerunning lean on <code>category_theory/monad/basic.lean</code> succeeds, even with <code>-T100000</code>.</p>



<a name="296694084"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/296694084" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#296694084">(Sep 01 2022 at 20:24)</a>:</h4>
<p>By the way, could there be some correlation between the timeout increase (originally done in <a href="https://github.com/leanprover-community/mathlib/pull/15251">#15251</a> to work around the olean issue) and the Freiburg runner failures? Increased memory demands, say.</p>



<a name="296706103"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/296706103" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#296706103">(Sep 01 2022 at 21:55)</a>:</h4>
<p>This should be fast enough (3.93s locally):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">instance</span> <span class="o">:</span> <span class="n">category</span> <span class="o">(</span><span class="n">monad</span> <span class="n">C</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">hom</span> <span class="o">:=</span> <span class="n">monad_hom</span><span class="o">,</span>
  <span class="n">id</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">M</span><span class="o">,</span> <span class="o">{</span> <span class="n">to_nat_trans</span> <span class="o">:=</span> <span class="mi">𝟙</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="n">C</span> <span class="bp">⥤</span> <span class="n">C</span><span class="o">)</span> <span class="o">},</span>
  <span class="n">comp</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">to_nat_trans</span> <span class="o">:=</span>
    <span class="o">{</span> <span class="n">app</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">X</span><span class="o">,</span> <span class="n">f.app</span> <span class="n">X</span> <span class="bp">≫</span> <span class="n">g.app</span> <span class="n">X</span><span class="o">,</span>
      <span class="n">naturality'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">X</span> <span class="n">Y</span> <span class="n">h</span><span class="o">,</span> <span class="kd">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">assoc</span><span class="o">,</span> <span class="n">f.1.naturality_assoc</span><span class="o">,</span> <span class="n">g.1.naturality</span><span class="o">]</span> <span class="o">}</span> <span class="o">},</span>
  <span class="n">id_comp'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span> <span class="kd">by</span> <span class="o">{</span><span class="n">ext</span><span class="o">,</span> <span class="n">apply</span> <span class="n">id_comp</span><span class="o">},</span>
  <span class="n">comp_id'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span> <span class="kd">by</span> <span class="o">{</span><span class="n">ext</span><span class="o">,</span> <span class="n">apply</span> <span class="n">comp_id</span><span class="o">},</span>
  <span class="n">assoc'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span> <span class="kd">by</span> <span class="o">{</span><span class="n">ext</span><span class="o">,</span> <span class="n">apply</span> <span class="n">assoc</span><span class="o">}</span> <span class="o">}</span>
</code></pre></div>
<p>However <a href="https://leanprover-community.github.io/mathlib_docs/find/category_theory.limits.cocone_equivalence_op_cone_op/src">src#category_theory.limits.cocone_equivalence_op_cone_op</a> is now also timing out.</p>



<a name="296861484"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/296861484" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#296861484">(Sep 02 2022 at 17:09)</a>:</h4>
<p>Thanks! I created <a href="https://github.com/leanprover-community/mathlib/pull/16356">#16356</a> to track going back to a <code>-T100000</code> timeout.</p>



<a name="296897833"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/296897833" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#296897833">(Sep 02 2022 at 21:27)</a>:</h4>
<p>Looks like it builds now! I've merged master, let's see if linting and tests succeed too.</p>



<a name="308509350"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%22saving%20olean%22%3F/near/308509350" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.22saving.20olean.22.3F.html#308509350">(Nov 08 2022 at 02:45)</a>:</h4>
<p>The issue comes back: I'm getting empty algebra/order/field/defs.olean and algebra/order/ring/basic.olean at commit bd87106843 in <a href="https://github.com/leanprover-community/mathlib/pull/17401">#17401</a>.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>