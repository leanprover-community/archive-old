---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html">Not finding typeclass in hypotheses</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="224305130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224305130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224305130">(Jan 28 2021 at 09:59)</a>:</h4>
<p>What's going on in this gist?</p>
<p><a href="https://gist.github.com/eric-wieser/66022bcfd708091799bc86e80404b504">https://gist.github.com/eric-wieser/66022bcfd708091799bc86e80404b504</a></p>
<p>Line 106 fails with:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">failed</span> <span class="n">to</span> <span class="n">synthesize</span> <span class="n">type</span> <span class="kd">class</span> <span class="kd">instance</span> <span class="n">for</span>
<span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_1</span><span class="o">,</span>
<span class="n">_inst_1</span> <span class="o">:</span> <span class="n">semiring</span> <span class="n">A</span><span class="o">,</span>
<span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_2</span><span class="o">,</span>
<span class="n">_inst_2</span> <span class="o">:</span> <span class="n">add_comm_monoid</span> <span class="n">ι</span><span class="o">,</span>
<span class="n">_inst_3</span> <span class="o">:</span> <span class="n">decidable_eq</span> <span class="n">ι</span><span class="o">,</span>
<span class="n">carriers</span> <span class="o">:</span> <span class="n">ι</span> <span class="bp">→</span> <span class="n">add_submonoid</span> <span class="n">A</span><span class="o">,</span>
<span class="n">_inst_4</span> <span class="o">:</span> <span class="n">semiring_add_gradation</span> <span class="n">carriers</span><span class="o">,</span>
<span class="n">x</span> <span class="o">:</span> <span class="bp">⨁</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">ι</span><span class="o">),</span> <span class="bp">↥</span><span class="o">(</span><span class="n">carriers</span> <span class="n">i</span><span class="o">),</span>
<span class="n">_inst</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">ι</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">ι</span><span class="o">),</span> <span class="bp">↥</span><span class="o">(</span><span class="n">carriers</span> <span class="n">i</span><span class="o">))</span> <span class="n">i</span><span class="o">),</span> <span class="n">decidable</span> <span class="o">(</span><span class="n">x</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span>
<span class="bp">⊢</span>       <span class="bp">Π</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">ι</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">ι</span><span class="o">),</span> <span class="bp">↥</span><span class="o">(</span><span class="n">carriers</span> <span class="n">i</span><span class="o">))</span> <span class="n">i</span><span class="o">),</span> <span class="n">decidable</span> <span class="o">(</span><span class="n">x</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span>
</code></pre></div>
<p>Why is it failing to synthesize an instance that is right there in the context?</p>



<a name="224306305"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224306305" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224306305">(Jan 28 2021 at 10:10)</a>:</h4>
<p>I got an error with <code>simp</code> in the line before -- invalid simp lemma. My mathlib is a couple of weeks old though. Is it a pp.all thing?</p>



<a name="224306338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224306338" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224306338">(Jan 28 2021 at 10:10)</a>:</h4>
<p>My first thoughts are to diff the <code>pp.all</code> output, or to use <code>letI</code> instead of <code>haveI</code>.</p>



<a name="224306497"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224306497" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224306497">(Jan 28 2021 at 10:12)</a>:</h4>
<p>For some reason this <code>rw</code> line works:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">rw</span> <span class="bp">@</span><span class="n">add_monoid_hom.coe_dfinsupp_sum</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span> <span class="n">x'</span><span class="o">,</span> <span class="n">_inst</span> <span class="n">i</span> <span class="n">x'</span><span class="o">)</span> <span class="n">x</span><span class="o">,</span>
</code></pre></div>



<a name="224306572"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224306572" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224306572">(Jan 28 2021 at 10:13)</a>:</h4>
<p>but not <code>_inst</code> or <code>(λ i, _inst i)</code></p>



<a name="224306681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224306681" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224306681">(Jan 28 2021 at 10:14)</a>:</h4>
<p>Oh yes, presumably decidable isn't a prop so it's letI</p>



<a name="224306851"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224306851" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224306851">(Jan 28 2021 at 10:15)</a>:</h4>
<p><code>letI</code> doesn't change seem to help here</p>



<a name="224307288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224307288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224307288">(Jan 28 2021 at 10:20)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span>, <a href="https://leanprover-community.github.io/mathlib_docs/find/add_monoid_hom.coe_dfinsupp_sum">docs#add_monoid_hom.coe_dfinsupp_sum</a> is very new</p>



<a name="224307367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224307367" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224307367">(Jan 28 2021 at 10:21)</a>:</h4>
<p>I wonder if changing the lemma to use {} instead of [] for that argument helps</p>



<a name="224307386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224307386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224307386">(Jan 28 2021 at 10:21)</a>:</h4>
<p>Since the instance in question is already in the goal statement anyway</p>



<a name="224307642"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224307642" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224307642">(Jan 28 2021 at 10:24)</a>:</h4>
<p><span class="user-mention" data-user-id="238446">@Anne Baanen</span>, <code>pp.all</code> and <code>pp.notation</code> continue to show a hypothesis that matches the goal</p>



<a name="224307840"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224307840" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224307840">(Jan 28 2021 at 10:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses/near/224307367">said</a>:</p>
<blockquote>
<p>I wonder if changing the lemma to use {} instead of [] for that argument helps</p>
</blockquote>
<p>That could be the solution. if there's some synthesised versus unified conflict going on, that <code>decidable</code> is prone to.</p>



<a name="224308352"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224308352" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224308352">(Jan 28 2021 at 10:32)</a>:</h4>
<p>Why have you even got that un-whatever-its-called-reduced (beta-reduced?) lambda-term in inst? Can you dsimp everything away?</p>



<a name="224308408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224308408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224308408">(Jan 28 2021 at 10:33)</a>:</h4>
<p>To try and help it pattern match <code>β</code>. Reducing it to <code>Π (i : ι) (x : carriers i), decidable (x ≠ 0)</code> doesn't help, and it makes the goal and hypothesis mismatch in a visible way.</p>



<a name="224308531"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224308531" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224308531">(Jan 28 2021 at 10:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="238446">Anne Baanen</span> <a href="#narrow/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses/near/224307840">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses/near/224307367">said</a>:</p>
<blockquote>
<p>I wonder if changing the lemma to use {} instead of [] for that argument helps</p>
</blockquote>
<p>That could be the solution. if there's some synthesised versus unified conflict going on, that <code>decidable</code> is prone to.</p>
</blockquote>
<p>This fixes the problem</p>



<a name="224308600"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224308600" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224308600">(Jan 28 2021 at 10:35)</a>:</h4>
<p>But it feels like a bug that I have to do that</p>



<a name="224308894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224308894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224308894">(Jan 28 2021 at 10:38)</a>:</h4>
<p>For the failing version, <code>set_option trace.class_instances true</code> gives</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">class_instances</span><span class="o">]</span>  <span class="kd">class</span><span class="bp">-</span><span class="kd">instance</span> <span class="n">resolution</span> <span class="n">trace</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="bp">?</span><span class="n">x_0</span> <span class="n">i</span> <span class="n">x</span> <span class="o">:</span> <span class="n">decidable</span> <span class="o">(</span><span class="n">x</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:=</span> <span class="n">_inst</span> <span class="o">(</span><span class="bp">?</span><span class="n">x_3</span> <span class="n">i</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="bp">?</span><span class="n">x_4</span> <span class="n">i</span> <span class="n">x</span><span class="o">)</span>
<span class="n">failed</span> <span class="n">is_def_eq</span>
<span class="bp">...</span>
</code></pre></div>
<p>But I don't know how to learn more about the metavariables</p>



<a name="224309632"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224309632" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224309632">(Jan 28 2021 at 10:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses/near/224307642">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="238446">Anne Baanen</span>, <code>pp.all</code> and <code>pp.notation</code> continue to show a hypothesis that matches the goal</p>
</blockquote>
<p>Wait, this was a lie. I used <code>set_option pp.all</code> without the trailing <code>true</code>. There is a difference.</p>



<a name="224310115"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224310115" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224310115">(Jan 28 2021 at 10:52)</a>:</h4>
<p>For the zero, the goal uses</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>            <span class="o">(</span><span class="bp">@</span><span class="n">add_monoid.to_has_zero</span>
               <span class="o">((</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">ι</span><span class="o">),</span>
                   <span class="bp">@</span><span class="n">coe_sort</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">add_submonoid</span> <span class="n">A</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="n">A</span> <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span> <span class="n">A</span> <span class="n">_inst_1</span><span class="o">)))</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">add_submonoid.has_coe_to_sort</span> <span class="n">A</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="n">A</span> <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span> <span class="n">A</span> <span class="n">_inst_1</span><span class="o">)))</span>
                     <span class="o">(</span><span class="n">carriers</span> <span class="n">i</span><span class="o">))</span>
                  <span class="n">i</span><span class="o">)</span>
               <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span>
                  <span class="o">((</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">ι</span><span class="o">),</span>
                      <span class="bp">@</span><span class="n">coe_sort</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">add_submonoid</span> <span class="n">A</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="n">A</span> <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span> <span class="n">A</span> <span class="n">_inst_1</span><span class="o">)))</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">add_submonoid.has_coe_to_sort</span> <span class="n">A</span>
                           <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="n">A</span> <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span> <span class="n">A</span> <span class="n">_inst_1</span><span class="o">)))</span>
                        <span class="o">(</span><span class="n">carriers</span> <span class="n">i</span><span class="o">))</span>
                     <span class="n">i</span><span class="o">)</span>
                  <span class="o">((</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">ι</span><span class="o">),</span>
                      <span class="bp">@</span><span class="n">add_submonoid.to_add_comm_monoid</span> <span class="n">A</span> <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span> <span class="n">A</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="o">(</span><span class="n">carriers</span> <span class="n">i</span><span class="o">))</span>
                     <span class="n">i</span><span class="o">)))))</span>
</code></pre></div>
<p>While the hypothesis uses</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>            <span class="o">(</span><span class="bp">@</span><span class="n">add_submonoid.has_zero</span> <span class="n">A</span> <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="n">A</span> <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_add_comm_monoid</span> <span class="n">A</span> <span class="n">_inst_1</span><span class="o">))</span>
               <span class="o">(</span><span class="n">carriers</span> <span class="n">i</span><span class="o">))))</span>
</code></pre></div>



<a name="224311693"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224311693" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224311693">(Jan 28 2021 at 11:09)</a>:</h4>
<p>Oh, I screwed up the typeclasses on <a href="https://leanprover-community.github.io/mathlib_docs/find/add_monoid_hom.coe_dfinsupp_sum">docs#add_monoid_hom.coe_dfinsupp_sum</a>... Maybe relaxing those will fix it</p>



<a name="224311727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224311727" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224311727">(Jan 28 2021 at 11:09)</a>:</h4>
<p><span class="user-mention" data-user-id="127136">@Alex J. Best</span>, how far from prime-time is your "typeclass assumptions are too strict" linter?</p>



<a name="224394039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/224394039" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#224394039">(Jan 28 2021 at 21:18)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> not too far, maybe a week or so from prime time, I have some changes to make but I think I at least know the right algorithm now <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="248961366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/248961366" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#248961366">(Aug 10 2021 at 10:15)</a>:</h4>
<p>Another "the typeclass is right there" situation:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.module.pi</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">apply_instance</span>  <span class="c1">-- fail</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">pi.is_scalar_tower'</span>  <span class="c1">-- fail</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">let</span> <span class="n">i</span> <span class="o">:</span> <span class="n">ι</span> <span class="bp">→</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="n">α</span> <span class="n">α</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="kd">by</span> <span class="n">apply_instance</span> <span class="k">in</span> <span class="kd">by</span> <span class="n">exactI</span>
<span class="n">pi.is_scalar_tower'</span>  <span class="c1">-- fail, does not find `i` which exactly matches the goal state</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">let</span> <span class="n">i</span> <span class="o">:</span> <span class="n">ι</span> <span class="bp">→</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="n">α</span> <span class="n">α</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="kd">by</span> <span class="n">apply_instance</span> <span class="k">in</span> <span class="kd">by</span> <span class="n">exactI</span>
<span class="bp">@</span><span class="n">pi.is_scalar_tower'</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">i</span>  <span class="c1">-- works</span>
</code></pre></div>
<p>Why can't lean find the <code>i</code> instance?</p>



<a name="248965778"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/248965778" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#248965778">(Aug 10 2021 at 11:16)</a>:</h4>
<p>Adding a non-dependent version of the instance seems to fix it:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">instance</span> <span class="n">pi.is_scalar_tower_again</span> <span class="o">{</span><span class="n">ι</span> <span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">has_scalar</span> <span class="n">α</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">has_scalar</span> <span class="n">β</span> <span class="n">γ</span><span class="o">]</span> <span class="o">[</span><span class="n">has_scalar</span> <span class="n">α</span> <span class="n">γ</span><span class="o">]</span>
  <span class="o">[</span><span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="n">β</span> <span class="n">γ</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">pi.is_scalar_tower'</span>
</code></pre></div>
<p>I wonder if we need to do this for all instance on pi types</p>



<a name="248966278"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/248966278" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#248966278">(Aug 10 2021 at 11:22)</a>:</h4>
<p>I have the feeling that we're running into this problem relatively often, and it's freaking me out a bit because the issue seems to be deep in the unifier and I don't really understand.  It would really help if we had a small mathlib-free MWE.  (We can also post the MWE on the Lean 4 bug tracker...)</p>



<a name="248967798"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/248967798" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#248967798">(Aug 10 2021 at 11:43)</a>:</h4>
<p>Some more data (the missing instance is <a href="https://github.com/leanprover-community/mathlib/issues/8604">#8604</a>):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.module.pi</span>

<span class="c1">-- oops, this instance is missing</span>
<span class="kd">instance</span> <span class="n">semigroup.to_is_scalar_tower</span> <span class="o">{</span><span class="n">α</span><span class="o">}</span> <span class="o">[</span><span class="n">semigroup</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="n">α</span> <span class="n">α</span> <span class="o">:=</span> <span class="o">⟨</span><span class="n">mul_assoc</span><span class="o">⟩</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">apply_instance</span>  <span class="c1">-- fail</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semigroup</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">apply_instance</span>  <span class="c1">-- ok</span>
</code></pre></div>



<a name="248968719"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/248968719" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#248968719">(Aug 10 2021 at 11:55)</a>:</h4>
<p>Here's the version without mathlib:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">old_structure_cmd</span> <span class="n">true</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">f</span>  <span class="o">:</span> <span class="n">I</span> <span class="bp">→</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>

<span class="kn">section</span> <span class="n">has_scalar</span>

<span class="kd">class</span> <span class="n">has_scalar</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">smul</span> <span class="o">:</span> <span class="n">M</span> <span class="bp">→</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>

<span class="kd">infixr</span> <span class="bp">`</span> <span class="bp">•</span> <span class="bp">`</span><span class="o">:</span><span class="mi">73</span> <span class="o">:=</span> <span class="n">has_scalar.smul</span>

<span class="kd">instance</span> <span class="n">has_mul.to_has_scalar</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">has_mul</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_scalar</span> <span class="n">α</span> <span class="n">α</span> <span class="o">:=</span> <span class="o">⟨(</span><span class="bp">*</span><span class="o">)⟩</span>

<span class="kd">instance</span> <span class="n">pi.has_scalar</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_scalar</span> <span class="n">α</span> <span class="bp">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span>
  <span class="n">has_scalar</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">⟨</span><span class="bp">λ</span> <span class="n">s</span> <span class="n">x</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">s</span> <span class="bp">•</span> <span class="o">(</span><span class="n">x</span> <span class="n">i</span><span class="o">)⟩</span>

<span class="kd">instance</span> <span class="n">pi.has_scalar'</span> <span class="o">{</span><span class="n">g</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">→</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_scalar</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span>
  <span class="n">has_scalar</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">g</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">⟨</span><span class="bp">λ</span> <span class="n">s</span> <span class="n">x</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">s</span> <span class="n">i</span><span class="o">)</span> <span class="bp">•</span> <span class="o">(</span><span class="n">x</span> <span class="n">i</span><span class="o">)⟩</span>

<span class="kd">end</span> <span class="n">has_scalar</span>

<span class="kn">section</span> <span class="n">is_scalar_tower</span>

<span class="kd">class</span> <span class="n">is_scalar_tower</span> <span class="o">(</span><span class="n">M</span> <span class="n">N</span> <span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">has_scalar</span> <span class="n">M</span> <span class="n">N</span><span class="o">]</span> <span class="o">[</span><span class="n">has_scalar</span> <span class="n">N</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">has_scalar</span> <span class="n">M</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">smul_assoc</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">N</span><span class="o">)</span> <span class="o">(</span><span class="n">z</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="o">(</span><span class="n">x</span> <span class="bp">•</span> <span class="n">y</span><span class="o">)</span> <span class="bp">•</span> <span class="n">z</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">•</span> <span class="o">(</span><span class="n">y</span> <span class="bp">•</span> <span class="n">z</span><span class="o">))</span>

<span class="kd">class</span> <span class="n">semigroup</span> <span class="o">(</span><span class="n">G</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">has_mul</span> <span class="n">G</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">mul_assoc</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">G</span><span class="o">,</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">*</span> <span class="o">(</span><span class="n">b</span> <span class="bp">*</span> <span class="n">c</span><span class="o">))</span>

<span class="kd">class</span> <span class="n">mul_one_class</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">has_one</span> <span class="n">M</span><span class="o">,</span> <span class="n">has_mul</span> <span class="n">M</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">one_mul</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">M</span><span class="o">),</span> <span class="mi">1</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a</span><span class="o">)</span>
<span class="o">(</span><span class="n">mul_one</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">M</span><span class="o">),</span> <span class="n">a</span> <span class="bp">*</span> <span class="mi">1</span> <span class="bp">=</span> <span class="n">a</span><span class="o">)</span>

<span class="kd">class</span> <span class="n">monoid</span> <span class="o">(</span><span class="n">G</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">semigroup</span> <span class="n">G</span><span class="o">,</span> <span class="n">mul_one_class</span> <span class="n">G</span>

<span class="kd">end</span> <span class="n">is_scalar_tower</span>

<span class="kn">export</span> <span class="n">is_scalar_tower</span> <span class="o">(</span><span class="n">smul_assoc</span><span class="o">)</span> <span class="n">semigroup</span> <span class="o">(</span><span class="n">mul_assoc</span><span class="o">)</span>

<span class="kd">instance</span> <span class="n">semigroup.to_is_scalar_tower</span> <span class="o">{</span><span class="n">α</span><span class="o">}</span> <span class="o">[</span><span class="n">semigroup</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="n">α</span> <span class="n">α</span> <span class="o">:=</span> <span class="o">⟨</span><span class="n">mul_assoc</span><span class="o">⟩</span>

<span class="kd">instance</span> <span class="n">pi.is_scalar_tower'</span> <span class="o">{</span><span class="n">g</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">→</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>
  <span class="o">[</span><span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_scalar</span> <span class="n">α</span> <span class="bp">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">[</span><span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_scalar</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="n">i</span><span class="o">)]</span> <span class="o">[</span><span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_scalar</span> <span class="n">α</span> <span class="bp">$</span> <span class="n">g</span> <span class="n">i</span><span class="o">]</span>
  <span class="o">[</span><span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">g</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">⟨</span><span class="bp">λ</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span><span class="o">,</span> <span class="n">funext</span> <span class="bp">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">smul_assoc</span> <span class="n">x</span> <span class="o">(</span><span class="n">y</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">z</span> <span class="n">i</span><span class="o">)⟩</span>

<span class="c1">-- change `monoid` to `semigroup` and the below work</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">apply_instance</span>  <span class="c1">-- fail</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">pi.is_scalar_tower'</span>  <span class="c1">-- fail</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">let</span> <span class="n">i</span> <span class="o">:</span> <span class="n">ι</span> <span class="bp">→</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="n">α</span> <span class="n">α</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="kd">by</span> <span class="n">apply_instance</span> <span class="k">in</span> <span class="kd">begin</span>
  <span class="n">tactic.unfreeze_local_instances</span><span class="o">,</span>
  <span class="n">tactic.freeze_local_instances</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">pi.is_scalar_tower'</span>  <span class="c1">-- fail, does not find `i` which exactly matches the goal state</span>
<span class="kd">end</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">ι</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">let</span> <span class="n">i</span> <span class="o">:</span> <span class="n">ι</span> <span class="bp">→</span> <span class="n">is_scalar_tower</span> <span class="n">α</span> <span class="n">α</span> <span class="n">α</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="kd">by</span> <span class="n">apply_instance</span> <span class="k">in</span> <span class="kd">by</span> <span class="n">exact</span>
<span class="bp">@</span><span class="n">pi.is_scalar_tower'</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">i</span>  <span class="c1">-- works</span>
</code></pre></div>



<a name="248971277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/248971277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#248971277">(Aug 10 2021 at 12:23)</a>:</h4>
<p>Good news: in the straightforward Lean 4 translation of this MWE, all examples work!</p>



<a name="248982985"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/248982985" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#248982985">(Aug 10 2021 at 14:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses/near/248971277">said</a>:</p>
<blockquote>
<p>Good news: in the straightforward Lean 4 translation of this MWE, all examples work!</p>
</blockquote>
<p>They do now :) Please consider PRing your translation as a "run" test so they always do.</p>



<a name="248985782"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/248985782" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#248985782">(Aug 10 2021 at 14:22)</a>:</h4>
<p>Isn't it <a href="https://github.com/leanprover/lean4/issues/509">https://github.com/leanprover/lean4/issues/509</a> ? (I think it was said at the time that it was possible to backport this in Lean 3)</p>



<a name="248986122"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Not%20finding%20typeclass%20in%20hypotheses/near/248986122" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Not.20finding.20typeclass.20in.20hypotheses.html#248986122">(Aug 10 2021 at 14:24)</a>:</h4>
<p><a href="#narrow/stream/270676-lean4/topic/typeclass.20failure/near/242412905">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/typeclass.20failure/near/242412905</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>