---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html">TC hell in FLT-regular</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="266120670"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266120670" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266120670">(Dec 26 2021 at 18:19)</a>:</h4>
<p>in <a href="https://github.com/leanprover-community/flt-regular/blob/94d42b688da75450b99517fe4f5be6db0ee5bf32/src/number_theory/cyclotomic/cyclotomic_units.lean#L226">here</a>, I seem to be running into a lot of problems with typeclasses; the thing seems to work, if pushed, but you really have to tell Lean exactly everything for it to work, and I don't know why. Do I have to re-derive the <code>no_zero_smul_divisors</code> instance for <code>ring_of_integers</code>? Is there an algebra diamond? There's some comments around there that are helpful, and I've got a 250K line output ot <code>trace_instances</code> saved if it helps debugging. I really have no clue where to start looking.</p>



<a name="266136188"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266136188" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266136188">(Dec 27 2021 at 00:42)</a>:</h4>
<p>There's a problem even outside of your <code>ring_of_integers</code> usage: this doesn't typecheck</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">ring_theory.roots_of_unity</span>

<span class="k">#check</span> <span class="bp">@</span><span class="n">is_primitive_root.of_map_of_injective</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span>
  <span class="o">(</span><span class="n">no_zero_smul_divisors.algebra_map_injective</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="n">_</span>
</code></pre></div>



<a name="266136331"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266136331" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266136331">(Dec 27 2021 at 00:46)</a>:</h4>
<p>I had to do the following to get it to be happy</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">ring_theory.roots_of_unity</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">S</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">S</span><span class="o">]</span> <span class="o">[</span><span class="n">nontrivial</span> <span class="n">S</span><span class="o">]</span> <span class="o">[</span><span class="n">algebra</span> <span class="n">R</span> <span class="n">S</span><span class="o">]</span>
  <span class="o">[</span><span class="n">no_zero_smul_divisors</span> <span class="n">R</span> <span class="n">S</span><span class="o">]</span>

<span class="k">#check</span> <span class="n">is_primitive_root.of_map_of_injective</span>
  <span class="o">(</span><span class="n">no_zero_smul_divisors.algebra_map_injective</span> <span class="n">R</span> <span class="n">S</span><span class="o">)</span> <span class="n">_</span>
</code></pre></div>



<a name="266137030"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266137030" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266137030">(Dec 27 2021 at 01:03)</a>:</h4>
<p>Here's your proof restated to show more explicitly the TC issue you've identified:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">zeta_primitive_root</span> <span class="o">:</span>
  <span class="n">is_primitive_root</span> <span class="o">(</span><span class="n">zeta</span> <span class="n">n</span> <span class="n">K</span> <span class="o">:</span> <span class="n">ring_of_integers</span> <span class="o">(</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">))</span> <span class="n">n</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="k">suffices</span> <span class="o">:</span> <span class="n">is_primitive_root</span>
    <span class="o">(</span><span class="n">algebra_map</span> <span class="o">(</span><span class="n">ring_of_integers</span> <span class="bp">$</span> <span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">)</span> <span class="o">(</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">)</span>
      <span class="o">((</span><span class="n">zeta</span> <span class="n">n</span> <span class="n">K</span><span class="o">)</span> <span class="o">:</span> <span class="n">ring_of_integers</span> <span class="bp">$</span> <span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">))</span> <span class="n">n</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">refine</span> <span class="n">this.of_map_of_injective</span> <span class="n">_</span><span class="o">,</span>
    <span class="n">apply</span> <span class="bp">@</span><span class="n">no_zero_smul_divisors.algebra_map_injective</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="c1">-- nontrivial (cyclotomic_field n K)</span>
      <span class="n">apply_instance</span> <span class="c1">-- fast</span>
    <span class="o">},</span>
    <span class="o">{</span>
      <span class="c1">-- no_zero_smul_divisors ↥(ring_of_integers (cyclotomic_field n K)) (cyclotomic_field n K)</span>
      <span class="n">apply_instance</span> <span class="c1">-- slow</span>
    <span class="o">},</span>
  <span class="o">},</span>
  <span class="n">exact</span> <span class="n">zeta'_primitive_root</span> <span class="n">n</span> <span class="n">_</span> <span class="n">_</span>
<span class="kd">end</span>
</code></pre></div>



<a name="266137579"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266137579" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266137579">(Dec 27 2021 at 01:14)</a>:</h4>
<p>I get ~63 seconds for the second <code>apply_instance</code> in this case:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elaboration</span><span class="o">:</span> <span class="n">tactic</span> <span class="n">execution</span> <span class="n">took</span> <span class="mi">63</span><span class="bp">.</span><span class="mi">8</span><span class="n">s</span>
<span class="n">num.</span> <span class="n">allocated</span> <span class="n">objects</span><span class="o">:</span>  <span class="mi">487</span>
<span class="n">num.</span> <span class="n">allocated</span> <span class="n">closures</span><span class="o">:</span> <span class="mi">1446</span>
<span class="mi">63763</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.istep</span>
<span class="mi">63763</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.step</span>
<span class="mi">63763</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.with_ast</span>
<span class="mi">63763</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">_interaction</span>
<span class="mi">63763</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.istep._lambda_1</span>
<span class="mi">63763</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">_interaction._lambda_2</span>
<span class="mi">63763</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">scope_trace</span>
<span class="mi">63602</span><span class="n">ms</span>    <span class="mi">99</span><span class="bp">.</span><span class="mi">7</span><span class="bp">%</span>   <span class="n">tactic.solve1</span>
<span class="mi">63602</span><span class="n">ms</span>    <span class="mi">99</span><span class="bp">.</span><span class="mi">7</span><span class="bp">%</span>   <span class="n">_interaction._lambda_5</span>
<span class="mi">63518</span><span class="n">ms</span>    <span class="mi">99</span><span class="bp">.</span><span class="mi">6</span><span class="bp">%</span>   <span class="n">tactic.apply_instance</span>
<span class="mi">63518</span><span class="n">ms</span>    <span class="mi">99</span><span class="bp">.</span><span class="mi">6</span><span class="bp">%</span>   <span class="n">_interaction._lambda_4</span>
<span class="mi">63499</span><span class="n">ms</span>    <span class="mi">99</span><span class="bp">.</span><span class="mi">6</span><span class="bp">%</span>   <span class="n">tactic.mk_instance</span>
  <span class="mi">190</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">3</span><span class="bp">%</span>   <span class="n">tactic.to_expr</span>
  <span class="mi">124</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">2</span><span class="bp">%</span>   <span class="n">tactic.interactive.suffices</span>
  <span class="mi">124</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">2</span><span class="bp">%</span>   <span class="n">tactic.interactive.have._lambda_1</span>
   <span class="mi">54</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">1</span><span class="bp">%</span>   <span class="n">tactic.interactive.apply._lambda_1</span>
   <span class="mi">54</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">1</span><span class="bp">%</span>   <span class="n">interaction_monad.monad._lambda_9</span>
   <span class="mi">54</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">1</span><span class="bp">%</span>   <span class="n">tactic.interactive.concat_tags._lambda_5</span>
   <span class="mi">53</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">1</span><span class="bp">%</span>   <span class="n">tactic.apply</span>
   <span class="mi">53</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">1</span><span class="bp">%</span>   <span class="n">tactic.apply_core</span>
   <span class="mi">37</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">1</span><span class="bp">%</span>   <span class="n">tactic.interactive.exact</span>
   <span class="mi">29</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.refine</span>
   <span class="mi">20</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.exact</span>
    <span class="mi">1</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.i_to_expr_for_apply</span>
    <span class="mi">1</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.get_goals</span>
</code></pre></div>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">zeta_primitive_root</span> <span class="o">:</span>
  <span class="n">is_primitive_root</span> <span class="o">(</span><span class="n">zeta</span> <span class="n">n</span> <span class="n">K</span> <span class="o">:</span> <span class="n">ring_of_integers</span> <span class="o">(</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">))</span> <span class="n">n</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="k">suffices</span> <span class="o">:</span> <span class="n">is_primitive_root</span>
    <span class="o">(</span><span class="n">algebra_map</span> <span class="o">(</span><span class="n">ring_of_integers</span> <span class="bp">$</span> <span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">)</span> <span class="o">(</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">)</span>
      <span class="o">((</span><span class="n">zeta</span> <span class="n">n</span> <span class="n">K</span><span class="o">)</span> <span class="o">:</span> <span class="n">ring_of_integers</span> <span class="bp">$</span> <span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">))</span> <span class="n">n</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">refine</span> <span class="n">this.of_map_of_injective</span> <span class="n">_</span><span class="o">,</span>
    <span class="n">apply</span> <span class="bp">@</span><span class="n">no_zero_smul_divisors.algebra_map_injective</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="c1">-- nontrivial (cyclotomic_field n K)</span>
      <span class="n">exact</span> <span class="n">local_ring.to_nontrivial</span>
    <span class="o">},</span>
    <span class="o">{</span>
      <span class="c1">-- no_zero_smul_divisors ↥(ring_of_integers (cyclotomic_field n K)) (cyclotomic_field n K)</span>
      <span class="n">apply_instance</span> <span class="c1">-- slow</span>
    <span class="o">},</span>
  <span class="o">},</span>
  <span class="n">exact</span> <span class="n">zeta'_primitive_root</span> <span class="n">n</span> <span class="n">_</span> <span class="n">_</span>
<span class="kd">end</span>
</code></pre></div>



<a name="266137653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266137653" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266137653">(Dec 27 2021 at 01:16)</a>:</h4>
<p>However, on a naked goal that is seemingly the same, it takes &lt;1s:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="bp">+</span><span class="o">)</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span>
  <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span>
  <span class="o">[</span><span class="n">fact</span> <span class="o">(((</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">K</span><span class="o">)</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)]</span> <span class="o">:</span>
  <span class="n">no_zero_smul_divisors</span> <span class="bp">↥</span><span class="o">(</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">))</span>
    <span class="o">(</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">apply_instance</span>
<span class="kd">end</span>
</code></pre></div>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elaboration</span><span class="o">:</span> <span class="n">tactic</span> <span class="n">execution</span> <span class="n">took</span> <span class="mi">542</span><span class="n">ms</span>
<span class="n">num.</span> <span class="n">allocated</span> <span class="n">objects</span><span class="o">:</span>  <span class="mi">24</span>
<span class="n">num.</span> <span class="n">allocated</span> <span class="n">closures</span><span class="o">:</span> <span class="mi">65</span>
  <span class="mi">542</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">_interaction._lambda_2</span>
  <span class="mi">542</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.step</span>
  <span class="mi">542</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">_interaction</span>
  <span class="mi">542</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.istep</span>
  <span class="mi">542</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.with_ast</span>
  <span class="mi">542</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.istep._lambda_1</span>
  <span class="mi">542</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">tactic.apply_instance</span>
  <span class="mi">542</span><span class="n">ms</span>   <span class="mi">100</span><span class="bp">.</span><span class="mi">0</span><span class="bp">%</span>   <span class="n">scope_trace</span>
  <span class="mi">541</span><span class="n">ms</span>    <span class="mi">99</span><span class="bp">.</span><span class="mi">8</span><span class="bp">%</span>   <span class="n">tactic.mk_instance</span>
    <span class="mi">1</span><span class="n">ms</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">2</span><span class="bp">%</span>   <span class="n">tactic.exact</span>
</code></pre></div>



<a name="266137659"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266137659" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266137659">(Dec 27 2021 at 01:16)</a>:</h4>
<p>So maybe there's something hidden in the <code>pp.all</code>, I'll check that.</p>



<a name="266138736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266138736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266138736">(Dec 27 2021 at 01:41)</a>:</h4>
<p>Here is the difference that makes it slower. This part makes it fast:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>             <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">module_left</span><span class="o">)))</span> <span class="o">:=</span>
</code></pre></div>
<p>but this one makes it slow:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>             <span class="o">(</span><span class="bp">@</span><span class="n">algebra.to_module</span>
                <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span>
                   <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_algebra</span><span class="o">))))</span> <span class="o">:=</span>
</code></pre></div>



<a name="266138793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266138793" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266138793">(Dec 27 2021 at 01:43)</a>:</h4>
<p>inside <code>smul_with_zero.to_has_scalar</code></p>



<a name="266139351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266139351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266139351">(Dec 27 2021 at 01:58)</a>:</h4>
<p>So I don't know why that particular module definition makes it slow, but that's the smallest quantum of difference I could find that led to the slowdown.</p>



<a name="266139366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266139366" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266139366">(Dec 27 2021 at 01:59)</a>:</h4>
<div class="spoiler-block"><div class="spoiler-header">
<p>-- fast</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">ring_theory.roots_of_unity</span>
<span class="kn">import</span> <span class="n">number_theory.number_field</span>
<span class="kn">import</span> <span class="n">ready_for_mathlib.cyclotomic.basic</span>

<span class="kd">universe</span> <span class="n">u</span>

<span class="kd">noncomputable theory</span>

<span class="kn">open</span> <span class="n">number_field</span>

<span class="kd">set_option</span> <span class="n">profiler</span> <span class="n">true</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="bp">+</span><span class="o">)</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span>
  <span class="o">[</span><span class="n">_inst_4</span> <span class="o">:</span> <span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">no_zero_smul_divisors</span>
    <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_class.to_has_zero</span>
       <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
            <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_mul_zero_class</span>
          <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span>
             <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span>
                <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span>
                   <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span>
                      <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                           <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span>
                            <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">))))))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_class.to_has_zero</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_mul_zero_class</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))))))))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">smul_with_zero.to_has_scalar</span>
       <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
            <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_class.to_has_zero</span>
          <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_one_class.to_mul_zero_class</span>
             <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">monoid_with_zero.to_mul_zero_one_class</span>
                <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_monoid_with_zero</span>
                   <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring.to_semiring</span>
                      <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                           <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span>
                         <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                              <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                            <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span>
                               <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">))))))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">add_zero_class.to_has_zero</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_monoid.to_add_zero_class</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                            <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span>
                               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                               <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span>
                                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))))))))))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">mul_action_with_zero.to_smul_with_zero</span>
          <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_monoid_with_zero</span>
             <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring.to_semiring</span>
                <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span>
                   <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">)))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_zero_class.to_has_zero</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">add_monoid.to_add_zero_class</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span>
                            <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                            <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                               <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span>
                                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                                  <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span>
                                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span>
                                        <span class="n">_inst_4</span><span class="o">))))))))))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">module.to_mul_action_with_zero</span>
             <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring.to_semiring</span>
                <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span>
                   <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                            <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span>
                               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)))))))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">module_left</span><span class="o">)))</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">apply_instance</span>
<span class="kd">end</span>
</code></pre></div>
</div></div>



<a name="266139434"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266139434" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266139434">(Dec 27 2021 at 02:00)</a>:</h4>
<div class="spoiler-block"><div class="spoiler-header">
<p>--slow</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">ring_theory.roots_of_unity</span>
<span class="kn">import</span> <span class="n">number_theory.number_field</span>
<span class="kn">import</span> <span class="n">ready_for_mathlib.cyclotomic.basic</span>

<span class="kd">universe</span> <span class="n">u</span>

<span class="kd">noncomputable theory</span>

<span class="kn">open</span> <span class="n">number_field</span>

<span class="kd">set_option</span> <span class="n">profiler</span> <span class="n">true</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="bp">+</span><span class="o">)</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span>
  <span class="o">[</span><span class="n">_inst_4</span> <span class="o">:</span> <span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">no_zero_smul_divisors</span>
    <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_class.to_has_zero</span>
       <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
            <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_mul_zero_class</span>
          <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span>
             <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span>
                <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span>
                   <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span>
                      <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                           <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span>
                            <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">))))))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_class.to_has_zero</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_mul_zero_class</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))))))))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">smul_with_zero.to_has_scalar</span>
       <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
            <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_class.to_has_zero</span>
          <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_one_class.to_mul_zero_class</span>
             <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">monoid_with_zero.to_mul_zero_one_class</span>
                <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_monoid_with_zero</span>
                   <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring.to_semiring</span>
                      <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                           <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span>
                         <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                              <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                            <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span>
                               <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">))))))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">add_zero_class.to_has_zero</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_monoid.to_add_zero_class</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                            <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span>
                               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                               <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span>
                                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))))))))))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">mul_action_with_zero.to_smul_with_zero</span>
          <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_monoid_with_zero</span>
             <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring.to_semiring</span>
                <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span>
                   <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">)))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_zero_class.to_has_zero</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">add_monoid.to_add_zero_class</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span>
                            <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                            <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                               <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span>
                                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                                  <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span>
                                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span>
                                        <span class="n">_inst_4</span><span class="o">))))))))))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">module.to_mul_action_with_zero</span>
             <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                  <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring.to_semiring</span>
                <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span>
                   <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                            <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span>
                               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                               <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)))))))</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">algebra.to_module</span>
                <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                     <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span>
                   <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                        <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                         <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))))</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_algebra</span><span class="o">))))</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="c1">-- apply_instance</span>
<span class="kd">end</span>
</code></pre></div>
</div></div>



<a name="266145627"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266145627" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266145627">(Dec 27 2021 at 04:38)</a>:</h4>
<p>The lack of typechecking originally is worrying, but I think in unrelated to my problem; if we specialize <code>of_map_of_injective</code> to <code>comm_ring \to field</code> (like what's used in the lemma) it still typechecks, but the proof fails:</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>code</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">is_primitive_root.of_map_of_injective'</span> <span class="o">{</span><span class="n">R</span> <span class="n">S</span><span class="o">}</span> <span class="o">{</span><span class="n">k</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">field</span> <span class="n">S</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→+*</span> <span class="n">S</span><span class="o">}</span> <span class="o">{</span><span class="n">ζ</span> <span class="o">:</span> <span class="n">R</span><span class="o">}</span>
<span class="o">:</span> <span class="n">function.injective</span> <span class="n">f</span> <span class="bp">→</span> <span class="n">is_primitive_root</span> <span class="o">(</span><span class="n">f</span> <span class="n">ζ</span><span class="o">)</span> <span class="n">k</span> <span class="bp">→</span> <span class="n">is_primitive_root</span> <span class="n">ζ</span> <span class="n">k</span> <span class="o">:=</span> <span class="n">is_primitive_root.of_map_of_injective</span>

<span class="k">#check</span> <span class="bp">@</span><span class="n">is_primitive_root.of_map_of_injective'</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span>
  <span class="o">(</span><span class="n">no_zero_smul_divisors.algebra_map_injective</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="n">_</span> <span class="c1">-- works</span>

  <span class="n">is_primitive_root</span> <span class="o">(</span><span class="n">zeta</span> <span class="n">n</span> <span class="n">K</span> <span class="o">:</span> <span class="n">ring_of_integers</span> <span class="o">(</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">))</span> <span class="n">n</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">apply</span> <span class="n">is_primitive_root.of_map_of_injective'</span> <span class="o">(</span><span class="n">no_zero_smul_divisors.algebra_map_injective</span> <span class="o">(</span><span class="n">ring_of_integers</span> <span class="bp">$</span> <span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">)</span> <span class="o">(</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span><span class="o">)),</span> <span class="c1">--times out</span>
  <span class="n">exact</span> <span class="n">zeta'_primitive_root</span> <span class="n">n</span> <span class="n">_</span> <span class="n">_</span>
<span class="kd">end</span>
</code></pre></div>
</div></div>
<p>the reason it doesn't typecheck seems to be something weird about <code>ring.to_semiring</code>; I'm not too sure what it is but that seems to be the only diff obvious to a difftool.</p>



<a name="266145704"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266145704" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266145704">(Dec 27 2021 at 04:41)</a>:</h4>
<p>also, if you <code>exact</code> the right instance, it doesn't seem to take too long on the second one, so it's not some sort of heavy <code>refl</code></p>



<a name="266146112"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266146112" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266146112">(Dec 27 2021 at 04:52)</a>:</h4>
<p>the <code>trace.class_instances</code> log for the slow example seems to consist of mainly lines looking like this (~240K of them):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="n">cached</span> <span class="n">failure</span> <span class="n">for</span> <span class="bp">@</span><span class="n">algebra</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span> <span class="n">K</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span>
     <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">cyclotomic_field.field</span> <span class="n">n</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">))</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="n">K</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">K</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">K</span> <span class="n">_inst_4</span><span class="o">)))</span>
</code></pre></div>
<p>Weirdly, none of these say <code>failed is_def_eq</code>, which is the usual error message I see for these sorts of traces the few times I've seen them, except at the very, very end of the repetition. The fact that it looped for so long and yet terminated... mysteries of computers. Then it fails a couple more times and only then it finds the right instance.</p>



<a name="266146120"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266146120" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266146120">(Dec 27 2021 at 04:52)</a>:</h4>
<p>Thanks so much for looking at this, Yakov. I'm going to sleep on it and hopefully some idea as to what's going on appears, because this is mysterious...</p>



<a name="266160921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/TC%20hell%20in%20FLT-regular/near/266160921" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/TC.20hell.20in.20FLT-regular.html#266160921">(Dec 27 2021 at 10:04)</a>:</h4>
<p>The repeated inference of the same(?) instance looks like this issue: <a href="#narrow/stream/113488-general/topic/odd.20repeated.20type.20class.20search">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/odd.20repeated.20type.20class.20search</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>