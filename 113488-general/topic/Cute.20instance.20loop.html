---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/Cute.20instance.20loop.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html">Cute instance loop</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="180118035"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180118035" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180118035">(Nov 07 2019 at 10:14)</a>:</h4>
<p>I just ran into a cute instance loop. A : if <code>K</code> is a field, it is a (finite-dimensional) vector space over itself. B : if <code>K</code> is a complete normed field, then any finite dimensional vector space over <code>K</code> is complete (I have just completed the proof of this fact). Combining these two, to prove the completeness of a normed field <code>K</code>, Lean will try to use the completeness of <code>K</code>, and loop.</p>
<p>My problem is that these two instances are natural and useful, and I would like to keep both of them. In Lean 3, if I understand correctly, I can't, and I should not register B as an instance. <span class="user-mention" data-user-id="230999">@Daniel Selsam</span>, can you confirm that this will not be a problem in Lean 4? (Another problem with this instance in Lean 3, by the way, is that to prove the completeness of <code>E</code> Lean will start to look for an instance of <code>vector_space ?m1 E</code> for whatever <code>?m1</code>, and then it will try all the fields it knows about, and there are tons of them -- will this also be OK in Lean 4?)</p>



<a name="180118932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180118932" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180118932">(Nov 07 2019 at 10:29)</a>:</h4>
<p>Wait... so given a <code>normed_field K</code> that is <code>complete K</code>, you ask Lean to prove <code>complete K</code>, and it is like... yeah I know that <code>K</code> is a fin.dim vector space over this field <code>K</code>. So I can prove that <code>K</code> is complete, if this field <code>K</code> is a complete normed field. Hmmm... it's clear that <code>K</code> is a normed field, because the instance is <em>staring me right in the face</em>. Now let's see if I can prove that <code>K</code> is complete. Ooh, I know that <code>K</code> is a fin.dim vector space over... ... ...</p>



<a name="180119653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180119653" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180119653">(Nov 07 2019 at 10:38)</a>:</h4>
<p>Can't instances in the local context have some sort of infinite priority over instances coming from the library?</p>



<a name="180119715"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180119715" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180119715">(Nov 07 2019 at 10:39)</a>:</h4>
<p>Oooh... never mind. It's more complicated.<br>
If you <em>don't</em> have <code>complete K</code> in your context, and you still want to infer <code>complete K</code> for some reason (maybe it is a finite field extension of something complete)... then you can still run into this loop.</p>



<a name="180119788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180119788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180119788">(Nov 07 2019 at 10:40)</a>:</h4>
<p>So somehow <code>complete_of_fin_dim_over_complete</code> should never be tried for vector space = base field.</p>



<a name="180119960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180119960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180119960">(Nov 07 2019 at 10:43)</a>:</h4>
<p>So we need <code>@[inference_hint := assert (¬ (E = K))]</code></p>



<a name="180120335"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180120335" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180120335">(Nov 07 2019 at 10:48)</a>:</h4>
<p>Yes, this is very funny. For instance, asking <code>complete_space ℚ</code> loops forever (or rather, it hits <code>instance_max_depth</code> quickly). Of course, I will never ask Lean to prove that <code>ℚ</code> is complete, but this might show up in some instance search if Lean is trying the wrong path.</p>



<a name="180122054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180122054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180122054">(Nov 07 2019 at 11:14)</a>:</h4>
<p>Could you show the types of these instances?</p>



<a name="180122148"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180122148" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180122148">(Nov 07 2019 at 11:15)</a>:</h4>
<p>Whichever instance involves looking for a field metavariable sounds like it shouldn't be an instance</p>



<a name="180122224"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180122224" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180122224">(Nov 07 2019 at 11:17)</a>:</h4>
<p>I don't think lean should always have every true relation between classes as an instance. It's not capitulation to say that some of them should be invoked explicitly</p>



<a name="180122358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180122358" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180122358">(Nov 07 2019 at 11:19)</a>:</h4>
<p>If I understand correctly, instance A is <code>vector_space K K &lt;- field K</code>, which seems fine, and B is <code>complete V &lt;- complete_normed_field K, vector_space K V</code> which does not look fine because the <code>K</code> is free</p>



<a name="180122417"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180122417" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180122417">(Nov 07 2019 at 11:20)</a>:</h4>
<p>If B was <code>complete_vector_space K V</code> it wouldn't be a problem</p>



<a name="180122747"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180122747" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180122747">(Nov 07 2019 at 11:24)</a>:</h4>
<p>But given that completeness is a property only of <code>V</code> (and its metric structure), you should already "know" that it is complete without having to do proof search to find out. That is, I would expect instances of the form <code>complete V</code> for every concrete <code>V</code> (like <code>real</code>), or it should be in the context. Perhaps we want to prove that <code>real</code> is a complete space by proving that it is a vector space over another complete field, in which case we would apply that lemma (and supply the choice of <code>K</code>), but it's not a search lean should be doing on its own</p>



<a name="180124149"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180124149" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180124149">(Nov 07 2019 at 11:47)</a>:</h4>
<p>Hmmm... you've told us this fact many times by now. For some reason it catches me by surprise time and again. I wonder when I will finitely learn this principle.</p>



<a name="180126478"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180126478" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180126478">(Nov 07 2019 at 12:22)</a>:</h4>
<p>I know, this is why I did not register it as an instance. But I find this a little bit sad, as this is an important, useful and nontrivial way to prove that a space is complete. Here is the type of the theorem</p>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">finite_dimensional</span><span class="bp">.</span><span class="n">complete</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="err">𝕜</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="bp">_</span><span class="n">inst_1</span> <span class="o">:</span> <span class="n">nondiscrete_normed_field</span> <span class="err">𝕜</span><span class="o">]</span> <span class="o">{</span><span class="n">E</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="bp">_</span><span class="n">inst_2</span> <span class="o">:</span> <span class="n">normed_group</span> <span class="n">E</span><span class="o">]</span>
<span class="o">[</span><span class="bp">_</span><span class="n">inst_3</span> <span class="o">:</span> <span class="n">normed_space</span> <span class="err">𝕜</span> <span class="n">E</span><span class="o">]</span> <span class="o">[</span><span class="bp">_</span><span class="n">inst_6</span> <span class="o">:</span> <span class="n">complete_space</span> <span class="err">𝕜</span><span class="o">]</span> <span class="o">[</span><span class="bp">_</span><span class="n">inst_7</span> <span class="o">:</span> <span class="n">finite_dimensional</span> <span class="err">𝕜</span> <span class="n">E</span><span class="o">],</span> <span class="n">complete_space</span> <span class="n">E</span>
</pre></div>



<a name="180126597"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180126597" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180126597">(Nov 07 2019 at 12:23)</a>:</h4>
<p>A way out could be to define a class <code>complete_nondiscrete_normed_field</code> extending both <code>nondiscrete_normed_field</code> and <code>complete_space</code>, and use it in the assumption. What do you think of this approach?</p>



<a name="180126953"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180126953" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180126953">(Nov 07 2019 at 12:29)</a>:</h4>
<blockquote>
<p>But I find this a little bit sad, as this is an important, useful and nontrivial way to prove that a space is complete</p>
</blockquote>
<p>This is the sentiment I hope to combat by saying "it's not capitulation". Just because it's true doesn't mean it's a good way <em>for lean to find out</em> that a space is complete</p>



<a name="180126973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180126973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180126973">(Nov 07 2019 at 12:29)</a>:</h4>
<p>Are there any examples where this is the desired way to prove completeness of a space?</p>



<a name="180127133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127133" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127133">(Nov 07 2019 at 12:32)</a>:</h4>
<p>I think this is a nice theorem, and the mere fact that it is entirely about typeclasses doesn't qualify it as an instance. There are plenty of other nice theorems which are not instances, it's not a second class status</p>



<a name="180127248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127248">(Nov 07 2019 at 12:34)</a>:</h4>
<p><code>complete_nondiscrete_normed_field</code> doesn't solve the problem, since it is only merging two assumptions on <code>K</code> without addressing the fact that <code>K</code> doesn't appear in the consequent <code>complete_space E</code></p>



<a name="180127377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127377" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127377">(Nov 07 2019 at 12:36)</a>:</h4>
<p>This is definitely used to prove completeness. For instance, if you want to check completeness of euclidean space, you can either make a messy computation with a clever blend of epsilons and Cauchy-Schwarz, or apply directly the theorem. More importantly, I want to write theorems with an assumption <code>[finite_dimensional R E]</code> and be able to use the completeness of <code>E</code> in the proof. Of course, I can put <code>haveI : complete_space E := ...</code> at the beginning of each such proof, but it will be tedious to say the least.</p>



<a name="180127402"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127402" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127402">(Nov 07 2019 at 12:37)</a>:</h4>
<p><code>complete_nondiscrete_normed_field</code> solves the looping problem, but I agree it does not solve the fact that there would be a metavariable in instance search.</p>



<a name="180127421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127421">(Nov 07 2019 at 12:37)</a>:</h4>
<p>Is <code>R</code> the reals?</p>



<a name="180127456"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127456" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127456">(Nov 07 2019 at 12:37)</a>:</h4>
<p>I would solve that by having a class <code>euclidean_space E</code> that implies <code>finite_dimensional R E</code> and <code>complete_space E</code></p>



<a name="180127513"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127513" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127513">(Nov 07 2019 at 12:38)</a>:</h4>
<p>Yes, sorry for the lack of unicode. Complex numbers and p-adics are also good examples.</p>



<a name="180127529"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127529" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127529">(Nov 07 2019 at 12:38)</a>:</h4>
<p>For those, you just prove <code>complete_space C</code> and <code>complete_space Q_[p]</code></p>



<a name="180127532"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127532" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127532">(Nov 07 2019 at 12:38)</a>:</h4>
<p>Yes, but this looks like a useless class as it is exactly equivalent to <code>finite_dimensional R E</code>.</p>



<a name="180127554"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127554" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127554">(Nov 07 2019 at 12:39)</a>:</h4>
<p>What I mean is that I will want to use completeness of finite-dimensional spaces over <code>C</code> and <code>Q_p</code>.</p>



<a name="180127575"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127575" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127575">(Nov 07 2019 at 12:39)</a>:</h4>
<p>you could also take it as an assumption, of course</p>



<a name="180127633"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127633" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127633">(Nov 07 2019 at 12:40)</a>:</h4>
<p>this would be the obviously correct way to do it if <code>complete_space</code> had data</p>



<a name="180127692"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127692" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127692">(Nov 07 2019 at 12:41)</a>:</h4>
<p>What about <code>complete_fd K E</code>?</p>



<a name="180127761"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127761" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127761">(Nov 07 2019 at 12:42)</a>:</h4>
<p>seems like this isn't much different from having a class <code>vector_space</code> (which is completely useless since it means the same as <code>module</code>)</p>



<a name="180127778"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127778" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127778">(Nov 07 2019 at 12:42)</a>:</h4>
<p>You mean, two typeclass assumptions <code>finite_dimensional K E</code> and <code>complete_space E</code>, while the second one is implied by the first one? This looks like a hackish workaround instead of a real solution, but I agree it would work fine. I think I would rather go for the explicit instance at the beginning of each proof.</p>



<a name="180127803"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127803" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127803">(Nov 07 2019 at 12:42)</a>:</h4>
<p><code>complete_fd</code> is the conjunction of those classes</p>



<a name="180127830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127830">(Nov 07 2019 at 12:43)</a>:</h4>
<p>Yes, and therefore completely equivalent to <code>finite_dimensional K E</code>!</p>



<a name="180127840"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127840" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127840">(Nov 07 2019 at 12:43)</a>:</h4>
<p>These have data, though, don't they?</p>



<a name="180127852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127852" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127852">(Nov 07 2019 at 12:43)</a>:</h4>
<p><code>complete_space E</code> has to have a metric and stuff</p>



<a name="180127858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127858" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127858">(Nov 07 2019 at 12:43)</a>:</h4>
<p>The difference with <code>vector_space</code> is that this class is just here to make mathematicians comfortable.</p>



<a name="180127911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127911" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127911">(Nov 07 2019 at 12:44)</a>:</h4>
<p>No, <code>complete_space</code> is a mixin over <code>metric_space</code>, without data.</p>



<a name="180127925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127925">(Nov 07 2019 at 12:44)</a>:</h4>
<p>hm, maybe fix that then</p>



<a name="180127946"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180127946" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180127946">(Nov 07 2019 at 12:44)</a>:</h4>
<p>it's not mixin very well</p>



<a name="180128001"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128001" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128001">(Nov 07 2019 at 12:45)</a>:</h4>
<p>The topological hierarchy has a spine <code>topological_space &lt;- uniform_space &lt;- metric_space</code>, and additional mixins specifying zillions of properties. It seems to work pretty well!</p>



<a name="180128046"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128046" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128046">(Nov 07 2019 at 12:46)</a>:</h4>
<p>If you want to build stuff on top of a mixin though, it needs to be merged in</p>



<a name="180128135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128135">(Nov 07 2019 at 12:47)</a>:</h4>
<p>I don't get it. We have a lot of theorems with assumptions <code>[topological_space \alpha] [t1_space \alpha]</code> or <code>[metric_space \alpha] [second_countable \alpha] [complete_space \alpha]</code>. There are so many possibilitiesof combination of the mixins that I don't see how we could merge anything.</p>



<a name="180128220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128220">(Nov 07 2019 at 12:49)</a>:</h4>
<p>Those are all over one type though. it's not like <code>[complete_space A -&gt; complete_space B]</code> is a class</p>



<a name="180128237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128237" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128237">(Nov 07 2019 at 12:49)</a>:</h4>
<p>but that's basically what <code>finite_dimensional A B</code> is doing here</p>



<a name="180128443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128443">(Nov 07 2019 at 12:52)</a>:</h4>
<p>What I get from this discussion is the confirmation that my theorem <code>finite_dimensional.complete</code> should not be an instance, because of the metavariable in the search, and that I should rather instantiate it explicitly when I need it. Is that reasonable?</p>



<a name="180128508"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128508" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128508">(Nov 07 2019 at 12:53)</a>:</h4>
<p>Yes, that should work</p>



<a name="180128510"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128510" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128510">(Nov 07 2019 at 12:53)</a>:</h4>
<p>Why are these even typeclasses? They look like hypotheses to me</p>



<a name="180128637"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128637" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128637">(Nov 07 2019 at 12:55)</a>:</h4>
<p>You mean, <code>finite_dimensional K E</code>? It is a typeclass in the current linear algebra framework. This seems reasonable as then it can be derived automatically for products, for function types over a fintype, for <code>K</code> itself, and so on.</p>



<a name="180128647"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128647" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128647">(Nov 07 2019 at 12:55)</a>:</h4>
<p>I love that a mathematician and a computer scientist are having a chat about a completely basic theorem but the chat actually has some content. Why hasn't this question been solved 20 years ago? Is there an analogous question for this theorem in Coq and Isabelle, and if so, then do the answers just not help at all? Or did they not get as far as this theorem yet?</p>



<a name="180128726"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128726" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128726">(Nov 07 2019 at 12:56)</a>:</h4>
<p>When we start on local fields, which we'll have to do at some point, the first thing we'll need is that a finite dimensional field extension of the p-adic numbers is complete.</p>



<a name="180128754"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128754" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128754">(Nov 07 2019 at 12:57)</a>:</h4>
<p>I mean <code>topological_property A</code></p>



<a name="180128842"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128842" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128842">(Nov 07 2019 at 12:58)</a>:</h4>
<p>They aren't being used to define anything, and they are rather more like mathematical assumptions than structures</p>



<a name="180128908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128908">(Nov 07 2019 at 12:59)</a>:</h4>
<p>You know, this is not really a trivial theorem. I am sure it is not in Isabelle. I don't think it is in Coq either, as they don't have a lot of topology. The proof over real numbers is in the undergraduate cursus, and easy by compactness, but the proof for complete fields is really harder, by induction on the dimension. By the way, for the proof to compile in reasonable time, I had to add</p>
<div class="codehilite"><pre><span></span><span class="n">local</span> <span class="n">attribute</span> <span class="o">[</span><span class="kn">instance</span><span class="o">,</span> <span class="n">priority</span> <span class="mi">10000</span><span class="o">]</span> <span class="n">pi</span><span class="bp">.</span><span class="n">module</span> <span class="n">normed_space</span><span class="bp">.</span><span class="n">to_vector_space</span>
  <span class="n">vector_space</span><span class="bp">.</span><span class="n">to_module</span> <span class="n">submodule</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">submodule</span><span class="bp">.</span><span class="n">module</span>
  <span class="n">linear_map</span><span class="bp">.</span><span class="n">finite_dimensional_range</span> <span class="k">Pi</span><span class="bp">.</span><span class="n">complete</span> <span class="n">nondiscrete_normed_field</span><span class="bp">.</span><span class="n">to_normed_field</span>
</pre></div>


<p>to help Lean a little bit!</p>



<a name="180128954"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180128954" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180128954">(Nov 07 2019 at 12:59)</a>:</h4>
<p>see, I don't want lean to choke on this instance</p>



<a name="180129040"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129040" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129040">(Nov 07 2019 at 13:00)</a>:</h4>
<p>For <code>topological_property A</code>, it is the same: these properties are typically derived automatically for products, function spaces, and so on.</p>



<a name="180129119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129119">(Nov 07 2019 at 13:01)</a>:</h4>
<p>If this theorem were recast as a structural rule it would be unproblematic. Something like <code>complete_space K -&gt; complete_space (K^n)</code></p>



<a name="180129208"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129208" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129208">(Nov 07 2019 at 13:02)</a>:</h4>
<p>I guess this also has to do with the earlier move away from modules having a unique base field</p>



<a name="180129227"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129227" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129227">(Nov 07 2019 at 13:02)</a>:</h4>
<p><code>K^n</code> comes with some metric (the sup metric), for which completeness is true and easy. The point of the theorem (and what makes it nontrivial) is that you get completeness whatever the metric.</p>



<a name="180129304"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129304" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129304">(Nov 07 2019 at 13:03)</a>:</h4>
<p>sounds like a search to me</p>



<a name="180129394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129394" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129394">(Nov 07 2019 at 13:04)</a>:</h4>
<blockquote>
<p>You know, this is not really a trivial theorem.</p>
</blockquote>
<p>I totally agree -- by "basic" I mean everyone knows it and assumes it.</p>



<a name="180129396"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129396" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129396">(Nov 07 2019 at 13:04)</a>:</h4>
<p>I would be very interested to read the thoughts of <span class="user-mention" data-user-id="230999">@Daniel Selsam</span> about how we should do this in Lean 4.</p>



<a name="180129411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129411">(Nov 07 2019 at 13:04)</a>:</h4>
<p>I mean, if you really want lean to do the search, I think you can do so, but you need a bunch more typeclasses to guide the search better</p>



<a name="180129540"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129540" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129540">(Nov 07 2019 at 13:06)</a>:</h4>
<p>I don't know what the best in-principle solution is, since I don't really know what you expect it to do here</p>



<a name="180129577"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129577" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129577">(Nov 07 2019 at 13:06)</a>:</h4>
<p>do you want every <code>complete_space</code> to search for a vector space instance, a field and all that? <code>complete_space</code>s don't even have to be algebraic</p>



<a name="180129693"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129693" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129693">(Nov 07 2019 at 13:08)</a>:</h4>
<p>If we are just reasoning forward from the context then this seems like a good forward reasoning rule</p>



<a name="180129717"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129717" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129717">(Nov 07 2019 at 13:08)</a>:</h4>
<p>I don't know if lean 4 supports that but I would really like to see forward reasoning in typeclass search</p>



<a name="180129794"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129794" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129794">(Nov 07 2019 at 13:09)</a>:</h4>
<p>If Lean is quick enough to do the silly  search in all cases, realize very quickly if my space is not algebraic, and go on a better path if needed, yes, I would be very happy. If this is not possible, I can live with it and give the instance myself :)</p>



<a name="180129894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129894">(Nov 07 2019 at 13:10)</a>:</h4>
<p>Unfortunately I think that the lean 4 algorithm won't help here, because the failing search really is infinite</p>



<a name="180129990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129990" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129990">(Nov 07 2019 at 13:12)</a>:</h4>
<p>There are an infinite number of fields, and an infinite number of failing assumptions <code>finite_dimensional (real x real x ... x real) E</code></p>



<a name="180129993"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180129993" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180129993">(Nov 07 2019 at 13:12)</a>:</h4>
<p>actually those aren't fields, but I can't be bothered to think of an actual field constructor</p>



<a name="180130074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180130074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180130074">(Nov 07 2019 at 13:13)</a>:</h4>
<p><code>algebraic_closure (algebraic_closure (... algebraic_closure (C)))))</code></p>



<a name="180130179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180130179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180130179">(Nov 07 2019 at 13:14)</a>:</h4>
<p>The algorithm that I think would actually work would be to see that <code>complete_space R</code> and <code>finite_dimensional R E</code> are in the context, and derive <code>complete_space E</code>; then search for <code>complete_space E</code> and find it in the context</p>



<a name="180130294"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180130294" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180130294">(Nov 07 2019 at 13:16)</a>:</h4>
<p>Yes, such a forward search would be very useful!</p>



<a name="180130339"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180130339" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180130339">(Nov 07 2019 at 13:17)</a>:</h4>
<p>Forward reasoning also works really well for "parent" instances, like if I want <code>has_add G</code> I can start from <code>add_group G</code> and populate the context with all subinstances of it (<code>add_monoid G</code>, <code>has_add G</code>, <code>has_zero G</code>) followed by the usual backward search</p>



<a name="180130356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180130356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180130356">(Nov 07 2019 at 13:17)</a>:</h4>
<p>rather than trawling the entire algebraic hierarchy</p>



<a name="180138503"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180138503" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180138503">(Nov 07 2019 at 14:45)</a>:</h4>
<blockquote>
<p>I would be very interested to read the thoughts of <span class="user-mention silent" data-user-id="230999">Daniel Selsam</span> about how we should do this in Lean 4.</p>
</blockquote>
<p><span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span> Can you please share a minimal, self-contained example that loops? For this purpose, you can just make the classes empty as in <a href="https://github.com/leanprover/lean4/blob/master/tests/elabissues/typeclass_triggers_typeclass.lean" target="_blank" title="https://github.com/leanprover/lean4/blob/master/tests/elabissues/typeclass_triggers_typeclass.lean">https://github.com/leanprover/lean4/blob/master/tests/elabissues/typeclass_triggers_typeclass.lean</a></p>
<p>In general, the rule in Lean 4 is as follows:</p>
<p>- If you literally reach the same goal twice (upto alpha equivalence), Lean4 will detect and do the right thing.<br>
- You can still cause typeclass resolution to run forever in some cases, but to do this the generated goals must be getting bigger and bigger.</p>



<a name="180140798"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180140798" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180140798">(Nov 07 2019 at 15:08)</a>:</h4>
<p>Here is the minimal example:</p>
<div class="codehilite"><pre><span></span><span class="n">class</span> <span class="n">Field</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span>

<span class="n">class</span> <span class="n">VectorSpace</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">Field</span> <span class="n">K</span><span class="o">]</span> <span class="o">(</span><span class="n">E</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span>

<span class="kn">instance</span> <span class="n">VectorSpaceSelf</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">Field</span> <span class="n">K</span><span class="o">]</span> <span class="o">:</span> <span class="n">VectorSpace</span> <span class="n">K</span> <span class="n">K</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">constructor</span>

<span class="n">class</span> <span class="n">CompleteSpace</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span>

<span class="kn">instance</span> <span class="n">bad</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">Field</span> <span class="n">K</span><span class="o">]</span> <span class="o">(</span><span class="n">E</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">VectorSpace</span> <span class="n">K</span> <span class="n">E</span><span class="o">]</span> <span class="o">[</span><span class="n">CompleteSpace</span> <span class="n">K</span><span class="o">]</span> <span class="o">:</span> <span class="n">CompleteSpace</span> <span class="n">E</span> <span class="o">:=</span>
  <span class="k">by</span> <span class="n">constructor</span>

<span class="kn">instance</span> <span class="n">loops</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">Field</span> <span class="n">K</span><span class="o">]</span> <span class="o">:</span> <span class="n">CompleteSpace</span> <span class="n">K</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
</pre></div>


<p><code>loops</code> should fail as there is no way to get completeness out of thin air, but Lean 3 will loop on it. It will try to apply the instance <code>bad</code> (as it sees <code>K</code> as a vector space over itself), and for this it will need the completeness of <code>K</code>, and therefore it loops.  From what you say, your Lean 4 algorithm should succeed on that one, which is very nice.</p>
<p>Then, there is a second potential issue. When applying the instance <code>bad</code>, Lean knows the vector space <code>E</code> (from the type of the desired conclusion), but it does not know which field to choose, so it will try every field it has at its disposal. In this example, it can not go wild. But what happens if one adds, say,</p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">AlgebraicClosure</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">Field</span> <span class="n">K</span><span class="o">]</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span> <span class="o">:=</span> <span class="n">K</span>

<span class="kn">instance</span> <span class="n">AlgebraicClosure</span><span class="bp">.</span><span class="n">Field</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">Field</span> <span class="n">K</span><span class="o">]</span> <span class="o">:</span> <span class="n">Field</span> <span class="o">(</span><span class="n">AlgebraicClosure</span> <span class="n">K</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">constructor</span>

<span class="kn">instance</span> <span class="n">loops_even_more</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">Field</span> <span class="n">K</span><span class="o">]</span> <span class="o">:</span> <span class="n">CompleteSpace</span> <span class="n">K</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
</pre></div>


<p>Here, I guess <code>loops_even_more</code> will also fail in Lean 4 as it will try to apply <code>bad</code> to more and more complicated fields, constructed by iterated algebraic closure. Is that indeed the case?</p>



<a name="180142205"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180142205" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180142205">(Nov 07 2019 at 15:22)</a>:</h4>
<p>Thanks. The first example will fail quickly in Lean4 since it is the same goals being solved over and over again, and Lean4 will detect this and do the right thing.</p>



<a name="180142501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180142501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180142501">(Nov 07 2019 at 15:25)</a>:</h4>
<p>I hope that there is also a cheap heuristic that gives the loop in the second example a very low priority</p>



<a name="180143039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180143039" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180143039">(Nov 07 2019 at 15:30)</a>:</h4>
<p>Sometimes you need to alternate some constructions several times in a row, but it isn't very common. One example is:</p>
<ul>
<li>Take the field Q. this field is not algebraically closed, and not complete</li>
<li>complete for the p-adic valuation to get Q_p. this field is not algebraically closed, it is complete</li>
<li>take the algebraic closure to get Q_p-bar. this field is algebraically closed, it is not complete</li>
<li>take the completion, to get C_p. this field is algebraically closed and it is complete.</li>
</ul>
<p>However, I certainly don't expect the typeclass system to figure out such things for me. So in general, I would like the type class system to be very hesitant to apply such constructors multiple times.</p>



<a name="180143420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180143420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180143420">(Nov 07 2019 at 15:34)</a>:</h4>
<p>(deleted)</p>



<a name="180144484"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180144484" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180144484">(Nov 07 2019 at 15:44)</a>:</h4>
<p>(deleted)</p>



<a name="180144570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180144570" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180144570">(Nov 07 2019 at 15:45)</a>:</h4>
<p>(deleted)</p>



<a name="180144679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180144679" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180144679">(Nov 07 2019 at 15:46)</a>:</h4>
<p>Great! I was afraid it would do the following: try to apply <code>bad ?K K</code> where <code>?K</code> is an unknown complete field over which one would like <code>K</code> to have a vector space structure. Since it doesn't know which field to use, what does Lean4 do to fill the meta-variable <code>?K</code>? Does it try all the fields it knows about, like <code>AlgebraicClosure K</code>, or is it more clever?</p>



<a name="180145204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180145204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180145204">(Nov 07 2019 at 15:51)</a>:</h4>
<p>For instance, in Lean 3,</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">works_fine</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">Field</span> <span class="n">K</span><span class="o">]</span> <span class="o">[</span><span class="n">CompleteSpace</span> <span class="o">(</span><span class="n">AlgebraicClosure</span> <span class="n">K</span><span class="o">)]</span>
  <span class="o">(</span><span class="n">E</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">VectorSpace</span> <span class="o">(</span><span class="n">AlgebraicClosure</span> <span class="n">K</span><span class="o">)</span> <span class="n">E</span><span class="o">]</span> <span class="o">:</span> <span class="n">CompleteSpace</span> <span class="n">E</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
</pre></div>


<p>works fine, so Lean3 is clever enough to try to fill the metavariable with <code>AlgebraicClosure K</code> (probably using what it sees in the context?)</p>



<a name="180147614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180147614" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180147614">(Nov 07 2019 at 16:14)</a>:</h4>
<p>What I wrote before was wrong. Lean4 will indeed still loop in your second example. I apologize for the confusion.</p>



<a name="180154276"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180154276" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180154276">(Nov 07 2019 at 17:26)</a>:</h4>
<p>Would it be reasonable to change the behavior to the following one: if one encounters an instance in which there are Type variables which can not be inferred directly, then</p>
<ul>
<li>either there is something in the context which matches the instance, then use it </li>
<li>or fail</li>
</ul>
<p>This would prevent the search from getting completely crazy, and still it would allow instances with Type metavariables, which can be handy in situations like the one discussed in the above thread. Are there situations where this is obviously wrong? (Or, as a middle ground, could one have an attribute on instances to say that they should follow this behavior -- all this is for Lean4, of course).</p>



<a name="180155319"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180155319" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180155319">(Nov 07 2019 at 17:39)</a>:</h4>
<p>Or an attribute <code>instance_search.restricted</code> or whatever, that one could set to choose the behavior between the current one and the less recursive one?</p>



<a name="180155853"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180155853" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180155853">(Nov 07 2019 at 17:46)</a>:</h4>
<p>How about just having a <code>maxGoalSize</code> flag, and refusing to consider any intermediate goals beyond that size? This works for your second example, and fails quickly even when set very high. Con: it would not work well if there were a combinatorial number of pretty-big-but-not-too-big undesired goals.</p>



<a name="180156244"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180156244" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180156244">(Nov 07 2019 at 17:49)</a>:</h4>
<p>Otherwise typeclass resolution might still run forever when it is e.g. bigger <code>Nat</code>s that are being created, as opposed to bigger types.</p>



<a name="180158025"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180158025" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180158025">(Nov 07 2019 at 18:09)</a>:</h4>
<p>Or even max recursion size. Currently, when the maximal recursion depth is reached, instance search fails with an error message. It could instead fail on the branch it is, and resume the search on the next branch. I am still afraid that this or your <code>maxGoalSize</code> could lead to a combinatorial explosion. </p>
<p>In Lean3, we avoid completely instances with Type metavariables because of this risk of combinatorial explosion. I think only allowing them when one can solve them from the context would solve most of our use cases.</p>



<a name="180190118"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180190118" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180190118">(Nov 07 2019 at 23:57)</a>:</h4>
<p><span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span> See <a href="https://github.com/leanprover/lean4/blob/9a7354633a18ce73039549cfb4a019fe74e7d09f/tests/elabissues/typeclass_nested_validate.lean" target="_blank" title="https://github.com/leanprover/lean4/blob/9a7354633a18ce73039549cfb4a019fe74e7d09f/tests/elabissues/typeclass_nested_validate.lean">https://github.com/leanprover/lean4/blob/9a7354633a18ce73039549cfb4a019fe74e7d09f/tests/elabissues/typeclass_nested_validate.lean</a> for more analysis, suggested workaround, and tentative plan for Lean4.</p>



<a name="180207357"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180207357" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180207357">(Nov 08 2019 at 07:01)</a>:</h4>
<p>That's extremely clever!</p>



<a name="180213064"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Cute%20instance%20loop/near/180213064" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Cute.20instance.20loop.html#180213064">(Nov 08 2019 at 09:09)</a>:</h4>
<p><span class="user-mention" data-user-id="230999">@Daniel Selsam</span> That's a really nice idea. And if I understand correctly, we can even try to use this already in Lean 3. That's cool.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>