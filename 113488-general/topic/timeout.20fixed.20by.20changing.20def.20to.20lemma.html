---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html">timeout fixed by changing def to lemma</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="264300684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264300684" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264300684">(Dec 09 2021 at 13:30)</a>:</h4>
<p>For the third time this month someone at Imperial (this time Jujian Zhang) has a situation where a construction seems to work fine but the kernel goes into a loop when trying to accept it. In all cases this happens in a <code>def</code>, and if the <code>def</code> is changed to <code>lemma</code> or <code>example</code> then the loop does not occur (but of course this is not a workaround because it needs to be a def). <span class="user-mention" data-user-id="310045">@Eric Wieser</span> expressed some surprise the first time he saw this phenomenon. One hypothesis is that Lean is getting stuck working out whether something is noncomputable or not. Is this a feasible hypothesis? What are other possibilities which might cause this issue? Jujian hasn't minimised his example yet; the other two examples are <a href="#narrow/stream/113488-general/topic/another.20really.20horrible.20timeout/near/263780183">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/another.20really.20horrible.20timeout/near/263780183</a> and <a href="#narrow/stream/113488-general/topic/crazy.20time-out/near/263470182">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/crazy.20time-out/near/263470182</a> .</p>



<a name="264302495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264302495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264302495">(Dec 09 2021 at 13:44)</a>:</h4>
<p>Is this only while writing the decl, or also after you are completely done?</p>



<a name="264305929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264305929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264305929">(Dec 09 2021 at 14:08)</a>:</h4>
<p>I'm pretty convinced of that hypothesis, because wrapping the function in something known-noncomputable makes the problem go away, but wrapping it in something known-computable does not</p>



<a name="264306894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264306894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264306894">(Dec 09 2021 at 14:15)</a>:</h4>
<p>The noncomputability checker tries to reduce terms iirc, so I can see how that could cause timeouts.  Unfortunately I don't think we have any trace options to see what whnf is doing, so debugging this might be hard.  I would expect that the issue could be solved by strategically making some definitions irreducible.</p>



<a name="264307070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264307070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264307070">(Dec 09 2021 at 14:16)</a>:</h4>
<p>we could also just add a patch to lean3 that makes something like <code>noncomputable!</code> which doesn't try to check if you're wrong</p>



<a name="264307109"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264307109" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264307109">(Dec 09 2021 at 14:16)</a>:</h4>
<p>i'm not sure if that will carry over well on synport, however...</p>



<a name="264309220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264309220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264309220">(Dec 09 2021 at 14:31)</a>:</h4>
<p>Johan if you want to see it with your own eyes then Amelia's example is the simplest:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">field_theory.is_alg_closed.algebraic_closure</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">(</span><span class="bp">Γ₀</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span>
  <span class="o">[</span><span class="n">linear_ordered_comm_monoid_with_zero</span> <span class="bp">Γ₀</span><span class="o">]</span>

<span class="kd">def</span> <span class="n">hmm</span> <span class="o">:</span> <span class="n">valuation</span> <span class="o">(</span><span class="n">algebraic_closure</span> <span class="n">K</span><span class="o">)</span> <span class="bp">Γ₀</span> <span class="o">:=</span> <span class="gr">sorry</span> <span class="c1">-- times out</span>
</code></pre></div>



<a name="264309252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264309252" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264309252">(Dec 09 2021 at 14:32)</a>:</h4>
<p>Change the def to a lemma and it's fine.</p>



<a name="264309692"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264309692" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264309692">(Dec 09 2021 at 14:34)</a>:</h4>
<p>Yes, you have a <code>sorry</code> right there.</p>



<a name="264309707"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264309707" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264309707">(Dec 09 2021 at 14:35)</a>:</h4>
<p>I think that's a known bug.</p>



<a name="264309743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264309743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264309743">(Dec 09 2021 at 14:35)</a>:</h4>
<p>Write the def as a <code>lemma</code>, and change it to <code>def</code> when you are done. I had to do that 50x in LTE.</p>



<a name="264309792"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264309792" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264309792">(Dec 09 2021 at 14:35)</a>:</h4>
<p>No, this is worse.</p>



<a name="264309897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264309897" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264309897">(Dec 09 2021 at 14:36)</a>:</h4>
<p>Take a look at Maria's example above -- I link to it. You get timeouts even if you complete the definition.</p>



<a name="264310271"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264310271" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264310271">(Dec 09 2021 at 14:39)</a>:</h4>
<p>Aha, that's bad.</p>



<a name="264335559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264335559" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264335559">(Dec 09 2021 at 17:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="284160">Eric Rodriguez</span> <a href="#narrow/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma/near/264307109">said</a>:</p>
<blockquote>
<p>we could also just add a patch to lean3 that makes something like <code>noncomputable!</code> which doesn't try to check if you're wrong</p>
<p>i'm not sure if that will carry over well on synport, however...</p>
</blockquote>
<p>I don't see why not. We can handle pretty much anything lean 3 wants to do, we just have to have a reasonable lean 4 equivalent. In this case, that might either mean stripping the <code>!</code> in the lean 4 version, or adding support for it to lean 4 if the same issue manifests in lean 4.</p>



<a name="264344568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264344568" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264344568">(Dec 09 2021 at 18:24)</a>:</h4>
<p>Kevin, does it actually say "deterministic timeout" on your machine or does it just never load?</p>



<a name="264345980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264345980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264345980">(Dec 09 2021 at 18:32)</a>:</h4>
<p><a href="/user_uploads/3121/bNu_b8HcQPsRkHi9SsNpuMOE/image.png">image.png</a> this issue is weird....</p>
<div class="message_inline_image"><a href="/user_uploads/3121/bNu_b8HcQPsRkHi9SsNpuMOE/image.png" title="image.png"><img src="/user_uploads/3121/bNu_b8HcQPsRkHi9SsNpuMOE/image.png"></a></div>



<a name="264349725"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264349725" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264349725">(Dec 09 2021 at 18:58)</a>:</h4>
<p>ok, this is way beyond my knowledge of Lean's codebase.... it doesn't seem to be solely the <code>noncomputableness</code>, it seems to be stuck within the <code>compiler_step_visitor</code>; but at some point the memory stops climbing, so there's no actual timeout because there's not enough memory allocations</p>



<a name="264349968"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264349968" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264349968">(Dec 09 2021 at 19:00)</a>:</h4>
<p>trying to find exactly where this leak/infinite loop is happening is hopeless manually because I don't have access to a profiler, and it only happens after a truly enormous amount of memory has been guzzled (+, the code is super slow at failing...)</p>



<a name="264678282"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264678282" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264678282">(Dec 13 2021 at 09:05)</a>:</h4>
<blockquote>
<p>we could also just add a patch to lean3 that makes something like noncomputable! which doesn't try to check if you're wrong</p>
</blockquote>
<blockquote>
<p>i'm not sure if that will carry over well on synport, however...</p>
</blockquote>
<p>We don't even have <code>noncomputable theory</code> in Lean 4.  The Lean 4 <code>noncomputable</code> works like the <code>noncomputable!</code> you describe:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">x</span> <span class="o">:=</span> <span class="mi">42</span>
</code></pre></div>



<a name="264679283"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264679283" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264679283">(Dec 13 2021 at 09:15)</a>:</h4>
<p>Does that emit any diagnostics?</p>



<a name="264679382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264679382" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264679382">(Dec 13 2021 at 09:16)</a>:</h4>
<p>It would be a shame for lean not to remind you that something no longer needs to be <code>noncomputable</code> after you computablize its dependencies.</p>



<a name="264680505"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264680505" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264680505">(Dec 13 2021 at 09:29)</a>:</h4>
<p>No warnings or errors.</p>



<a name="264691362"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264691362" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264691362">(Dec 13 2021 at 11:11)</a>:</h4>
<p>By the way, in Amelia's example </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">field_theory.is_alg_closed.algebraic_closure</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">(</span><span class="bp">Γ₀</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span>
  <span class="o">[</span><span class="n">linear_ordered_comm_monoid_with_zero</span> <span class="bp">Γ₀</span><span class="o">]</span>

<span class="kd">def</span> <span class="n">hmm</span> <span class="o">:</span> <span class="n">valuation</span> <span class="o">(</span><span class="n">algebraic_closure</span> <span class="n">K</span><span class="o">)</span> <span class="bp">Γ₀</span> <span class="o">:=</span> <span class="gr">sorry</span> <span class="c1">-- times out</span>
</code></pre></div>
<p>this can be fixed by changing <code>def</code> to <code>lemma</code>, then generating the skeleton for the structure under construction, then filling in the non-Prop fields, sorrying the Prop fields, and then changing the <code>lemma</code> back to <code>def</code>. This was a trick Johan told me, he said he'd used it a ton in LTE. Maria's example (the subtype.val example) is nastier (and doesn't quite compile with mathlib master: the line <code>noncomputable instance : field (K_v K v) := @field_completion K _ (us' v) (tdr' v) _ (ug' v) _</code> needs to have the last <code>_</code> removed nowadays) because all definitions are there (and the variant she had had no sorrys at all IIRC). The timeout is extremely brittle -- Gabriel suggests fixing it by making things irreducible and I can't get this to work, but you can just add more things (e.g. making a new declaration P so that the subtype is {x // P x} "fixes" it). What scares me a bit about the latter approach is that the timeout might reappear the moment P is unfolded. But I've not seen this happening in practice.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">...</span>
<span class="c1">-- name the killer predicate</span>
<span class="kd">def</span> <span class="n">P</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">K_hat</span> <span class="n">R</span> <span class="n">K</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">∃</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">maximal_spectrum</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">x</span> <span class="n">v</span><span class="o">)</span><span class="bp">⁻¹</span> <span class="bp">=</span> <span class="mi">37</span>

<span class="c1">-- safe subtype</span>
<span class="kd">def</span> <span class="n">foo1</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">x</span> <span class="o">:</span> <span class="n">K_hat</span> <span class="n">R</span> <span class="n">K</span> <span class="bp">//</span> <span class="n">P</span> <span class="n">R</span> <span class="n">K</span> <span class="n">x</span> <span class="o">}</span>

<span class="c1">-- bad subtype</span>
<span class="kd">def</span> <span class="n">foo2</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">x</span> <span class="o">:</span> <span class="n">K_hat</span> <span class="n">R</span> <span class="n">K</span> <span class="bp">//</span> <span class="bp">∃</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">maximal_spectrum</span> <span class="n">R</span><span class="o">),</span> <span class="o">(</span><span class="n">x</span> <span class="n">v</span><span class="o">)</span><span class="bp">⁻¹</span> <span class="bp">=</span> <span class="mi">37</span> <span class="o">}</span>

<span class="kd">example</span> <span class="o">:</span> <span class="bp">@</span><span class="n">foo1</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">foo2</span> <span class="o">:=</span> <span class="n">rfl</span> <span class="c1">-- fine</span>

<span class="kd">def</span> <span class="n">bar1</span> <span class="o">:</span> <span class="n">foo1</span> <span class="n">R</span> <span class="n">K</span> <span class="bp">→</span> <span class="n">K_hat</span> <span class="n">R</span> <span class="n">K</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">x.1</span> <span class="c1">-- fine</span>

<span class="kd">def</span> <span class="n">bar2</span> <span class="o">:</span> <span class="n">foo2</span> <span class="n">R</span> <span class="n">K</span> <span class="bp">→</span> <span class="n">K_hat</span> <span class="n">R</span> <span class="n">K</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">x.1</span> <span class="c1">-- times out</span>
</code></pre></div>



<a name="264692084"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264692084" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264692084">(Dec 13 2021 at 11:18)</a>:</h4>
<p>Minimising (i.e. removing all mathlib imports) would be a bunch of work because I would have to set up a chunk of the algebra hierarchy and also there is a bunch of topology happening (completion of a topological field is a topological field) which seems to be important. Even extremely innocuous changes such as changing <code>∃</code> to <code>∀</code> in <code>foo2</code> make the problem go away, so it's not even clear that I would succeed; furthermore Gabriel has suggested that even if I did succeed then it might be very hard to figure out the problem, so I am minded to leave this for now. Initially I was worried that doing things like defining <code>P</code> above were just postponing the problem (i.e. that it would blow up in our face at the next definition), but perhaps they really should be regarded as a solution.</p>



<a name="264695049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264695049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264695049">(Dec 13 2021 at 11:48)</a>:</h4>
<p>Sorry, my theory turned out to be wrong.  It's not the noncomputable check that's timing out, but the VM compilation (in case you ever wanted to execute your <code>hmm</code> function).</p>
<p>I don't think there's any way to disable VM compilation in Lean 3 except for marking things as noncomputable.  So this works as a workaround:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">field_theory.is_alg_closed.algebraic_closure</span>

<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">force_noncomputable</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Sort</span><span class="bp">*</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="o">:=</span>
  <span class="n">function.const</span> <span class="n">_</span> <span class="n">a</span> <span class="o">(</span><span class="n">classical.choice</span> <span class="o">⟨</span><span class="n">a</span><span class="o">⟩)</span>

<span class="kd">@[simp]</span>
<span class="kd">lemma</span> <span class="n">force_noncomputable_def</span> <span class="o">{</span><span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">force_noncomputable</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">(</span><span class="bp">Γ₀</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span>
  <span class="o">[</span><span class="n">linear_ordered_comm_monoid_with_zero</span> <span class="bp">Γ₀</span><span class="o">]</span>

<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">hmm</span> <span class="o">:</span> <span class="n">valuation</span> <span class="o">(</span><span class="n">algebraic_closure</span> <span class="n">K</span><span class="o">)</span> <span class="bp">Γ₀</span> <span class="o">:=</span>
  <span class="n">force_noncomputable</span> <span class="gr">sorry</span>  <span class="c1">-- no longer times out</span>
</code></pre></div>



<a name="264698824"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264698824" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264698824">(Dec 13 2021 at 12:29)</a>:</h4>
<p><span class="user-mention" data-user-id="252627">@Jujian Zhang</span> can you get your code working with this? I've checked and it seems to solve both Amelia and Maria's problems. But with your sheaf I get</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c1">-- still (deterministic) timeout</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">X</span> <span class="o">:</span> <span class="n">Top</span><span class="o">)</span> <span class="o">(</span><span class="n">ℱ</span> <span class="o">:</span> <span class="bp">@</span><span class="n">presheaf</span> <span class="n">BundledModule</span> <span class="n">BundledModule.is_cat</span> <span class="n">X</span><span class="o">)</span> <span class="o">[</span><span class="n">PresheafOfModules2</span> <span class="n">ℱ</span><span class="o">]:</span>
<span class="n">PresheafOfModules1</span> <span class="n">X</span> <span class="o">:=</span>
<span class="n">force_noncomputable</span> <span class="o">{</span> <span class="bp">𝒪</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span><span class="o">,</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">U</span><span class="o">)</span><span class="bp">.</span><span class="n">R</span><span class="o">,</span>
         <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">h</span><span class="o">,</span> <span class="o">(</span><span class="n">ℱ.map</span> <span class="n">h</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span> <span class="o">},</span>
  <span class="n">ℱ</span> <span class="o">:=</span>
    <span class="n">force_noncomputable</span> <span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span><span class="o">,</span> <span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">U</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">,</span>
      <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span><span class="o">,</span> <span class="n">force_noncomputable</span> <span class="o">(</span><span class="bp">@</span><span class="n">AddCommGroup.of_hom</span> <span class="o">(</span><span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">U</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">V</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">)</span> <span class="n">_</span> <span class="n">_</span>
        <span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="n">force_noncomputable</span> <span class="o">(</span><span class="n">ℱ.map</span> <span class="n">h</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span>
          <span class="n">map_zero'</span> <span class="o">:=</span>  <span class="n">linear_map.map_zero</span> <span class="n">_</span><span class="o">,</span>
          <span class="n">map_add'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span> <span class="n">m'</span><span class="o">,</span> <span class="kd">begin</span>
            <span class="n">simp</span><span class="o">,</span>
          <span class="kd">end</span><span class="o">,</span> <span class="o">}),</span> <span class="o">},</span>
  <span class="n">is_module</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span><span class="o">,</span> <span class="kd">begin</span>
    <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[</span><span class="n">AddCommGroup.coe_of</span><span class="o">],</span> <span class="n">apply_instance</span><span class="o">,</span>
  <span class="kd">end</span><span class="o">,</span>
  <span class="n">res_compatible</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span> <span class="n">r</span> <span class="n">m</span><span class="o">,</span> <span class="kd">begin</span>
    <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[</span><span class="n">AddCommGroup.coe_of</span><span class="o">,</span> <span class="n">linear_map.map_zero</span><span class="o">,</span> <span class="n">functor.map_comp</span><span class="o">,</span> <span class="n">functor.map_id</span><span class="o">]</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
    <span class="n">erw</span> <span class="n">PresheafOfModules2.res_compatible</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span> <span class="n">r</span> <span class="n">m</span><span class="o">,</span>
    <span class="n">erw</span> <span class="o">[</span><span class="n">smul_def'</span><span class="o">],</span>
  <span class="kd">end</span><span class="o">}</span>
</code></pre></div>
<p>As you can see I just threw in <code>force_noncomputable</code> here there and everywhere and it didn't fix it (unless now it's actually timing out because the proof was already slow). But I know that you refactored the code after you showed it me. If you're interested in following this up can you create an example which depends only on mathlib rather than on your sheaf of modules work? I would be very interested to see if Gabriel's approach can be used to avoid your timeout!</p>



<a name="264703950"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264703950" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jujian Zhang <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264703950">(Dec 13 2021 at 13:18)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">force_noncomputable</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Sort</span><span class="bp">*</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="o">:=</span>
  <span class="n">function.const</span> <span class="n">_</span> <span class="n">a</span> <span class="o">(</span><span class="n">classical.choice</span> <span class="o">⟨</span><span class="n">a</span><span class="o">⟩)</span>

<span class="kd">@[simp]</span>
<span class="kd">lemma</span> <span class="n">force_noncomputable_def</span> <span class="o">{</span><span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">force_noncomputable</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">set_option</span> <span class="n">pp.implicit</span> <span class="n">true</span>

<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">test</span> <span class="o">(</span><span class="n">X</span> <span class="o">:</span> <span class="n">Top</span><span class="o">)</span> <span class="o">(</span><span class="n">ℱ</span> <span class="o">:</span> <span class="bp">@</span><span class="n">presheaf</span> <span class="n">BundledModule</span> <span class="n">BundledModule.is_cat</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">AddCommGroup</span> <span class="n">X</span> <span class="o">:=</span>
<span class="n">force_noncomputable</span>
<span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span><span class="o">,</span> <span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">U</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">,</span>
  <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span><span class="o">,</span> <span class="bp">@</span><span class="n">AddCommGroup.of_hom</span> <span class="o">(</span><span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">U</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">V</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">)</span> <span class="n">_</span> <span class="n">_</span>
        <span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="o">(</span><span class="n">ℱ.map</span> <span class="n">h</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span>
          <span class="n">map_zero'</span> <span class="o">:=</span>  <span class="n">linear_map.map_zero</span> <span class="n">_</span><span class="o">,</span>
          <span class="n">map_add'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span> <span class="n">m'</span><span class="o">,</span> <span class="kd">begin</span>
            <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map.map_add</span><span class="o">],</span>
            <span class="gr">sorry</span>
          <span class="kd">end</span><span class="o">,</span> <span class="o">},</span> <span class="o">}</span>
</code></pre></div>
<p>Unfortunately, it still gives me a timeout.</p>



<a name="264704049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264704049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jujian Zhang <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264704049">(Dec 13 2021 at 13:19)</a>:</h4>
<p>This <code>sorry</code> will still make lean complain that there is no more goals, but removing it gives a time out.</p>



<a name="264704289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264704289" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jujian Zhang <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264704289">(Dec 13 2021 at 13:21)</a>:</h4>
<p>The strange thing is that for <code>map_zero'</code>, <code>rw linear_map.map_zero</code> works, but <code>linear_map.map_add</code> doesn't work for map_add'</p>



<a name="264704330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264704330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264704330">(Dec 13 2021 at 13:21)</a>:</h4>
<p>Can you post a <a href="https://leanprover-community.github.io/mwe.html">#mwe</a> (i.e., with imports, etc.) please?</p>



<a name="264705272"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264705272" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jujian Zhang <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264705272">(Dec 13 2021 at 13:29)</a>:</h4>
<p>I am sorry about this. The context is that I am trying to work out if <code>(opens X)\op \functor BundledModule</code> is a sensible definition for sheaf of modules. So I had to define the category of bundled modules first. So the <a href="https://leanprover-community.github.io/mwe.html">#mwe</a> is really not minimal at all:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.category.CommRing</span>
<span class="kn">import</span> <span class="n">algebra.category.Module.basic</span>
<span class="kn">import</span> <span class="n">topology.sheaves.sheaf</span>
<span class="kn">import</span> <span class="n">topology.category.Top.opens</span>

<span class="kn">open</span> <span class="n">category_theory</span> <span class="n">Top</span> <span class="n">topological_space</span> <span class="n">opposite</span>

<span class="kd">instance</span> <span class="n">restriction_of_scalar.has_scalar</span> <span class="o">{</span><span class="n">R</span> <span class="n">S</span> <span class="o">:</span> <span class="n">CommRing.</span><span class="o">{</span><span class="mi">0</span><span class="o">}}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">⟶</span> <span class="n">S</span><span class="o">)</span> <span class="o">(</span><span class="n">N</span> <span class="o">:</span> <span class="n">Module.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">S</span><span class="o">)</span> <span class="o">:</span>
   <span class="n">has_scalar</span> <span class="n">R</span> <span class="n">N</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span> <span class="n">m</span><span class="o">,</span> <span class="n">f</span> <span class="n">r</span> <span class="bp">•</span> <span class="n">m</span> <span class="o">}</span>

<span class="kd">@[reducible]</span> <span class="kd">def</span> <span class="n">restriction_of_scalar.restrict</span> <span class="o">{</span><span class="n">R</span> <span class="n">S</span> <span class="o">:</span> <span class="n">CommRing.</span><span class="o">{</span><span class="mi">0</span><span class="o">}}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">⟶</span> <span class="n">S</span><span class="o">)</span> <span class="o">(</span><span class="n">N</span> <span class="o">:</span> <span class="n">Module.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">S</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">Module</span> <span class="n">R</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">carrier</span> <span class="o">:=</span> <span class="n">N</span><span class="o">,</span>
  <span class="n">is_module</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="n">one_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="kd">begin</span>
      <span class="n">unfold</span> <span class="n">has_scalar.smul</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">ring_hom.map_one</span><span class="o">,</span> <span class="n">one_smul</span><span class="o">],</span>
    <span class="kd">end</span><span class="o">,</span>
    <span class="n">mul_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span> <span class="kd">begin</span>
      <span class="n">unfold</span> <span class="n">has_scalar.smul</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">ring_hom.map_mul</span><span class="o">,</span> <span class="n">mul_smul</span><span class="o">],</span>
    <span class="kd">end</span><span class="o">,</span>
    <span class="n">smul_add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span><span class="kd">by</span> <span class="o">{</span> <span class="n">unfold</span> <span class="n">has_scalar.smul</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">smul_add</span><span class="o">]</span> <span class="o">},</span>
    <span class="n">smul_zero</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span><span class="o">,</span> <span class="kd">by</span> <span class="o">{</span> <span class="n">unfold</span> <span class="n">has_scalar.smul</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">smul_zero</span><span class="o">]</span> <span class="o">},</span>
    <span class="n">add_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span> <span class="kd">begin</span>
      <span class="n">unfold</span> <span class="n">has_scalar.smul</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">ring_hom.map_add</span><span class="o">,</span> <span class="n">add_smul</span><span class="o">],</span>
    <span class="kd">end</span><span class="o">,</span>
    <span class="n">zero_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span><span class="o">,</span> <span class="kd">begin</span>
      <span class="n">unfold</span> <span class="n">has_scalar.smul</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">ring_hom.map_zero</span><span class="o">,</span> <span class="n">zero_smul</span><span class="o">],</span>
    <span class="kd">end</span><span class="o">,</span>
    <span class="bp">..</span><span class="o">(</span><span class="n">restriction_of_scalar.has_scalar</span> <span class="n">f</span> <span class="n">N</span><span class="o">)</span> <span class="o">}</span> <span class="o">}</span>

<span class="kd">instance</span> <span class="n">restriction_of_scalar.has_scalar'</span> <span class="o">{</span><span class="n">R</span> <span class="n">S</span> <span class="o">:</span> <span class="n">CommRing.</span><span class="o">{</span><span class="mi">0</span><span class="o">}}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">⟶</span> <span class="n">S</span><span class="o">)</span> <span class="o">(</span><span class="n">N</span> <span class="o">:</span> <span class="n">Module.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">S</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">has_scalar</span> <span class="n">S</span> <span class="o">(</span><span class="n">restriction_of_scalar.restrict</span> <span class="n">f</span> <span class="n">N</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span> <span class="n">n</span><span class="o">,</span> <span class="n">r</span> <span class="bp">•</span> <span class="n">n</span> <span class="o">}</span>

<span class="kn">open</span> <span class="n">restriction_of_scalar</span>

<span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">restriction_of_scalar.smul_def'</span> <span class="o">{</span><span class="n">R</span> <span class="n">S</span> <span class="o">:</span> <span class="n">CommRing.</span><span class="o">{</span><span class="mi">0</span><span class="o">}}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">⟶</span> <span class="n">S</span><span class="o">)</span>
  <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">N</span> <span class="o">:</span> <span class="n">Module.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">S</span><span class="o">)</span>
  <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">restriction_of_scalar.restrict</span> <span class="n">f</span> <span class="n">N</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">r</span> <span class="bp">•</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">f</span> <span class="n">r</span> <span class="bp">•</span> <span class="n">n</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">def</span> <span class="n">restriction_of_scalar.functor</span>
  <span class="o">{</span><span class="n">R</span> <span class="n">S</span> <span class="o">:</span> <span class="n">CommRing.</span><span class="o">{</span><span class="mi">0</span><span class="o">}}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">⟶</span> <span class="n">S</span><span class="o">)</span> <span class="o">:</span> <span class="n">Module.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">S</span> <span class="bp">⥤</span> <span class="n">Module.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">R</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span><span class="o">,</span> <span class="n">restriction_of_scalar.restrict</span> <span class="n">f</span> <span class="n">m</span><span class="o">,</span>
  <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m1</span> <span class="n">m2</span> <span class="n">l</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="n">l</span><span class="o">,</span>
      <span class="n">map_add'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="kd">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map.map_add</span><span class="o">],</span>
      <span class="n">map_smul'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span> <span class="n">y</span><span class="o">,</span> <span class="kd">begin</span>
        <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">restriction_of_scalar.smul_def'</span><span class="o">,</span> <span class="n">ring_hom.id_apply</span><span class="o">],</span>
        <span class="n">convert</span> <span class="n">linear_map.map_smul</span> <span class="n">l</span> <span class="o">(</span><span class="n">f</span> <span class="n">r</span><span class="o">)</span> <span class="n">y</span><span class="o">,</span>
      <span class="kd">end</span> <span class="o">}</span> <span class="o">}</span>

<span class="kd">structure</span> <span class="n">BundledModule</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="n">CommRing.</span><span class="o">{</span><span class="mi">0</span><span class="o">})</span>
<span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="n">Module.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">R</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">restriction_of_scalar</span> <span class="o">{</span><span class="n">M1</span> <span class="n">M2</span> <span class="o">:</span> <span class="n">BundledModule</span><span class="o">}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">M1.R</span> <span class="bp">⟶</span> <span class="n">M2.R</span><span class="o">)</span> <span class="o">:</span> <span class="n">BundledModule</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">R</span> <span class="o">:=</span> <span class="n">M1.R</span><span class="o">,</span>
  <span class="n">M</span> <span class="o">:=</span> <span class="n">restriction_of_scalar.restrict</span> <span class="n">f</span> <span class="n">M2.M</span> <span class="o">}</span>

<span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">restriction_of_scalar.R</span> <span class="o">{</span><span class="n">M1</span> <span class="n">M2</span> <span class="o">:</span> <span class="n">BundledModule</span><span class="o">}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">M1.R</span> <span class="bp">⟶</span> <span class="n">M2.R</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">restriction_of_scalar</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">R</span> <span class="bp">=</span> <span class="n">M1.R</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">restriction_of_scalar.M</span> <span class="o">{</span><span class="n">M1</span> <span class="n">M2</span> <span class="o">:</span> <span class="n">BundledModule</span><span class="o">}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">M1.R</span> <span class="bp">⟶</span> <span class="n">M2.R</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">restriction_of_scalar</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span> <span class="bp">=</span> <span class="n">restriction_of_scalar.restrict</span> <span class="n">f</span> <span class="n">M2.M</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">def</span> <span class="n">bundledMap</span> <span class="o">(</span><span class="n">M1</span> <span class="n">M2</span> <span class="o">:</span> <span class="n">BundledModule</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="bp">Σ</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">M1.R</span> <span class="bp">⟶</span> <span class="n">M2.R</span><span class="o">),</span> <span class="n">M1.M</span> <span class="bp">⟶</span> <span class="o">(</span><span class="n">restriction_of_scalar</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span>

<span class="kd">instance</span> <span class="n">BundledModule.is_cat</span> <span class="o">:</span> <span class="n">category</span> <span class="n">BundledModule</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">hom</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">M1</span> <span class="n">M2</span><span class="o">,</span> <span class="n">bundledMap</span> <span class="n">M1</span> <span class="n">M2</span><span class="o">,</span>
  <span class="n">id</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">M</span><span class="o">,</span> <span class="o">⟨</span><span class="mi">𝟙</span> <span class="n">M.R</span><span class="o">,</span> <span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span>
                       <span class="n">map_add'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span> <span class="n">rfl</span><span class="o">,</span>
                       <span class="n">map_smul'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span> <span class="n">rfl</span> <span class="o">}⟩,</span>
  <span class="n">comp</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">M1</span> <span class="n">M2</span> <span class="n">M3</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span>
    <span class="o">⟨</span><span class="n">f.1</span> <span class="bp">≫</span> <span class="n">g.1</span><span class="o">,</span>
     <span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span><span class="o">,</span> <span class="n">g.2</span> <span class="o">(</span><span class="n">f.2</span> <span class="n">m</span><span class="o">),</span>
       <span class="n">map_add'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m1</span> <span class="n">m2</span><span class="o">,</span> <span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">linear_map.map_add</span><span class="o">],</span>
       <span class="n">map_smul'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span> <span class="n">m</span><span class="o">,</span> <span class="kd">begin</span>
        <span class="n">rcases</span> <span class="n">f</span> <span class="k">with</span> <span class="o">⟨</span><span class="n">f</span><span class="o">,</span> <span class="n">f'</span><span class="o">⟩,</span>
        <span class="n">rcases</span> <span class="n">g</span> <span class="k">with</span> <span class="o">⟨</span><span class="n">g</span><span class="o">,</span> <span class="n">g'</span><span class="o">⟩,</span>
        <span class="n">dsimp</span> <span class="n">only</span><span class="o">,</span>
        <span class="n">rw</span> <span class="o">[</span><span class="n">ring_hom.id_apply</span><span class="o">,</span> <span class="n">linear_map.map_smulₛₗ</span><span class="o">,</span> <span class="n">ring_hom.id_apply</span><span class="o">,</span>
          <span class="n">restriction_of_scalar.smul_def'</span><span class="o">,</span> <span class="n">restriction_of_scalar.smul_def'</span><span class="o">,</span> <span class="n">comp_apply</span><span class="o">],</span>
        <span class="n">convert</span> <span class="n">linear_map.map_smul</span> <span class="n">g'</span> <span class="o">(</span><span class="n">f</span> <span class="n">r</span><span class="o">)</span> <span class="o">(</span><span class="n">f'</span> <span class="n">m</span><span class="o">),</span>
      <span class="kd">end</span> <span class="o">}⟩,</span>
  <span class="n">comp_id'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">M1</span> <span class="n">M2</span> <span class="n">f</span><span class="o">,</span> <span class="kd">begin</span>
    <span class="n">ext</span><span class="o">,</span> <span class="n">refl</span><span class="o">,</span> <span class="n">rw</span> <span class="n">heq_iff_eq</span><span class="o">,</span> <span class="n">ext</span><span class="o">,</span> <span class="n">refl</span><span class="o">,</span>
  <span class="kd">end</span><span class="o">,</span>
  <span class="n">id_comp'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">M1</span> <span class="n">M2</span> <span class="n">f</span><span class="o">,</span> <span class="kd">begin</span>
    <span class="n">ext</span><span class="o">,</span> <span class="n">refl</span><span class="o">,</span> <span class="n">rw</span> <span class="n">heq_iff_eq</span><span class="o">,</span> <span class="n">ext</span><span class="o">,</span> <span class="n">refl</span><span class="o">,</span>
  <span class="kd">end</span> <span class="o">}</span>


<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">force_noncomputable</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Sort</span><span class="bp">*</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="o">:=</span>
  <span class="n">function.const</span> <span class="n">_</span> <span class="n">a</span> <span class="o">(</span><span class="n">classical.choice</span> <span class="o">⟨</span><span class="n">a</span><span class="o">⟩)</span>

<span class="kd">@[simp]</span>
<span class="kd">lemma</span> <span class="n">force_noncomputable_def</span> <span class="o">{</span><span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">force_noncomputable</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">noncomputable</span> <span class="kd">example</span> <span class="o">(</span><span class="n">X</span> <span class="o">:</span> <span class="n">Top.</span><span class="o">{</span><span class="mi">0</span><span class="o">})</span> <span class="o">(</span><span class="n">ℱ</span> <span class="o">:</span> <span class="bp">@</span><span class="n">presheaf</span> <span class="n">BundledModule</span> <span class="n">BundledModule.is_cat</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">AddCommGroup.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">X</span> <span class="o">:=</span>
<span class="n">force_noncomputable</span>
<span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span><span class="o">,</span> <span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">U</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">,</span>
  <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span><span class="o">,</span> <span class="bp">@</span><span class="n">AddCommGroup.of_hom</span> <span class="o">(</span><span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">U</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">V</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">)</span> <span class="n">_</span> <span class="n">_</span>
        <span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="o">(</span><span class="n">ℱ.map</span> <span class="n">h</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span>
          <span class="n">map_zero'</span> <span class="o">:=</span>  <span class="n">linear_map.map_zero</span> <span class="n">_</span><span class="o">,</span>
          <span class="n">map_add'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span> <span class="n">m'</span><span class="o">,</span> <span class="kd">begin</span>
            <span class="c1">-- the goal is :</span>
            <span class="c1">-- ⇑((ℱ.map h).snd) (m + m') = ⇑((ℱ.map h).snd) m + ⇑((ℱ.map h).snd) m'</span>
            <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map.map_add</span><span class="o">],</span>
            <span class="c1">-- sorry</span>
          <span class="kd">end</span><span class="o">,</span> <span class="o">},</span> <span class="o">}</span>
</code></pre></div>



<a name="264705410"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264705410" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jujian Zhang <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264705410">(Dec 13 2021 at 13:30)</a>:</h4>
<p>I was trying to see if I can write down a sheaf of modules like in textbook (a sheaf of abelian groups that are modules).</p>



<a name="264705843"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264705843" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jujian Zhang <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264705843">(Dec 13 2021 at 13:34)</a>:</h4>
<p>I though that maybe <code>AddCommGroup.of_hom</code> is causing trouble, but</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">noncomputable</span> <span class="kd">example</span> <span class="o">(</span><span class="n">X</span> <span class="o">:</span> <span class="n">Top.</span><span class="o">{</span><span class="mi">0</span><span class="o">})</span> <span class="o">(</span><span class="n">ℱ</span> <span class="o">:</span> <span class="bp">@</span><span class="n">presheaf</span> <span class="n">BundledModule</span> <span class="n">BundledModule.is_cat</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">AddCommGroup.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">X</span> <span class="o">:=</span>
<span class="n">force_noncomputable</span>
<span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span><span class="o">,</span> <span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">U</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">,</span>
  <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span><span class="o">,</span> <span class="o">(</span><span class="n">ℱ.map</span> <span class="n">h</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span> <span class="n">m</span><span class="o">,</span>
      <span class="n">map_zero'</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">rw</span> <span class="n">linear_map.map_zero</span><span class="o">,</span>
      <span class="n">map_add'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span> <span class="n">m'</span><span class="o">,</span> <span class="kd">begin</span>
        <span class="n">rw</span> <span class="n">linear_map.map_add</span><span class="o">,</span>
        <span class="gr">sorry</span>
      <span class="kd">end</span> <span class="o">}</span> <span class="o">}</span>
</code></pre></div>



<a name="264705853"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264705853" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jujian Zhang <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264705853">(Dec 13 2021 at 13:34)</a>:</h4>
<p>this has exactly the same problem</p>



<a name="264706541"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264706541" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264706541">(Dec 13 2021 at 13:40)</a>:</h4>
<p>Note that there are prop goals there which are being proved by <code>. obviously</code>, this is probably what makes it slow.</p>



<a name="264706775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264706775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264706775">(Dec 13 2021 at 13:42)</a>:</h4>
<p>In fact this works:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">noncomputable</span> <span class="kd">example</span> <span class="o">(</span><span class="n">X</span> <span class="o">:</span> <span class="n">Top.</span><span class="o">{</span><span class="mi">0</span><span class="o">})</span> <span class="o">(</span><span class="n">ℱ</span> <span class="o">:</span> <span class="bp">@</span><span class="n">presheaf</span> <span class="n">BundledModule</span> <span class="n">BundledModule.is_cat</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">AddCommGroup.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">X</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span><span class="o">,</span> <span class="n">AddCommGroup.of</span> <span class="o">(</span><span class="n">ℱ.obj</span> <span class="n">U</span><span class="o">)</span><span class="bp">.</span><span class="n">M</span><span class="o">,</span>
  <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span><span class="o">,</span> <span class="o">(</span><span class="n">ℱ.map</span> <span class="n">h</span><span class="o">)</span><span class="bp">.</span><span class="mi">2</span> <span class="n">m</span><span class="o">,</span>
      <span class="n">map_zero'</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">rw</span> <span class="n">linear_map.map_zero</span><span class="o">,</span>
      <span class="n">map_add'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span> <span class="n">m'</span><span class="o">,</span> <span class="kd">begin</span>
        <span class="n">rw</span> <span class="n">linear_map.map_add</span><span class="o">,</span>
      <span class="kd">end</span> <span class="o">},</span>
  <span class="n">map_id'</span> <span class="o">:=</span> <span class="gr">sorry</span><span class="o">,</span>
  <span class="n">map_comp'</span> <span class="o">:=</span> <span class="gr">sorry</span>
   <span class="o">}</span>
</code></pre></div>
<p>I claim that this timeout might be being caused by an unrelated issue. Hence I claim that Gabriel has solved all our problems! Thank you Gabriel!</p>



<a name="264708705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264708705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jujian Zhang <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264708705">(Dec 13 2021 at 13:57)</a>:</h4>
<p>I filled the <code>sorries</code> and it worked! Thank you!</p>



<a name="264718546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/264718546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#264718546">(Dec 13 2021 at 15:02)</a>:</h4>
<p>I think <code>force_noncomputable</code> (maybe with another name like <code>forbid_evaluation</code> or <code>classicalize</code>) probably belongs in mathlib somewhere</p>



<a name="265730566"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/265730566" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#265730566">(Dec 21 2021 at 20:27)</a>:</h4>
<p>Boom! And a 4th person at Imperial (<span class="user-mention" data-user-id="460212">@Sebastian Monnet</span> , a Lean learner trying to do Galois theory of infinite extensions) just ran into the same issue. It's happening all the time with people doing algebra.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic</span>
<span class="kn">import</span> <span class="n">field_theory.galois</span>

<span class="n">open_locale</span> <span class="n">classical</span>

<span class="c1">-- Adjoin roots</span>
<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">root_finset</span> <span class="o">{</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">K</span><span class="o">)</span> <span class="o">(</span><span class="n">L</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">field</span> <span class="n">L</span><span class="o">]</span>
  <span class="o">[</span><span class="n">algebra</span> <span class="n">K</span> <span class="n">L</span><span class="o">]</span> <span class="o">:</span> <span class="n">finset</span> <span class="n">L</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">p.map</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">K</span> <span class="n">L</span><span class="o">))</span><span class="bp">.</span><span class="n">roots.to_finset</span>


<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">min_polys</span> <span class="o">{</span><span class="n">K</span> <span class="n">E</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">[</span><span class="n">field</span> <span class="n">E</span><span class="o">]</span> <span class="o">[</span><span class="n">algebra</span> <span class="n">K</span> <span class="n">E</span><span class="o">]</span>
<span class="o">(</span><span class="n">h_findim</span> <span class="o">:</span> <span class="n">finite_dimensional</span> <span class="n">K</span> <span class="n">E</span><span class="o">)</span> <span class="o">:</span> <span class="n">finset</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">K</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">finset.univ.image</span> <span class="o">(</span><span class="n">minpoly</span> <span class="n">K</span> <span class="bp">∘</span> <span class="o">(</span><span class="n">finite_dimensional.fin_basis</span> <span class="n">K</span> <span class="n">E</span><span class="o">))</span>

<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">prod_min_polys</span> <span class="o">{</span><span class="n">K</span> <span class="n">E</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">[</span><span class="n">field</span> <span class="n">E</span><span class="o">]</span> <span class="o">[</span><span class="n">algebra</span> <span class="n">K</span> <span class="n">E</span><span class="o">]</span>
<span class="o">(</span><span class="n">h_findim</span> <span class="o">:</span> <span class="n">finite_dimensional</span> <span class="n">K</span> <span class="n">E</span><span class="o">)</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">K</span> <span class="o">:=</span>
<span class="n">finset.prod</span> <span class="o">(</span><span class="n">min_polys</span> <span class="n">h_findim</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="n">p</span><span class="o">)</span>

<span class="c1">--noncomputable def force_noncomputable {α : Sort*} (a : α) : α :=</span>
<span class="c1">--  function.const _ a (classical.choice ⟨a⟩)</span>

<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">adj_roots</span> <span class="o">{</span><span class="n">K</span> <span class="n">L</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">[</span><span class="n">field</span> <span class="n">L</span><span class="o">]</span> <span class="o">[</span><span class="n">algebra</span> <span class="n">K</span> <span class="n">L</span><span class="o">]</span>
<span class="o">{</span><span class="n">E</span> <span class="o">:</span> <span class="n">intermediate_field</span> <span class="n">K</span> <span class="n">L</span><span class="o">}</span> <span class="o">(</span><span class="n">h_findim</span> <span class="o">:</span> <span class="n">finite_dimensional</span> <span class="n">K</span> <span class="n">E</span><span class="o">)</span> <span class="o">:</span>
<span class="n">intermediate_field</span> <span class="n">K</span> <span class="n">L</span> <span class="o">:=</span>
<span class="c1">--force_noncomputable</span>
<span class="n">intermediate_field.adjoin</span> <span class="n">K</span> <span class="o">(</span><span class="n">coe</span> <span class="o">(</span><span class="n">root_finset</span> <span class="o">(</span><span class="n">prod_min_polys</span> <span class="n">h_findim</span><span class="o">)</span> <span class="n">L</span><span class="o">)</span> <span class="o">:</span> <span class="n">set</span> <span class="n">L</span><span class="o">)</span>
</code></pre></div>
<p>Completely random deterministic timeout on perfectly type-correct code which can be fixed by uncommenting <code>force_noncomputable</code>. <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> thank you so much for this fix. Will someone PR it to mathlib? It's genuinely fast becoming an essential trick for people working in the kind of algebraic number theory we're trying to do at Imperial.</p>



<a name="265730598"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/265730598" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#265730598">(Dec 21 2021 at 20:27)</a>:</h4>
<p>I can do it if someone tells me where the heck to put it -- I have no idea.</p>



<a name="265731732"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/265731732" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#265731732">(Dec 21 2021 at 20:38)</a>:</h4>
<p>I think everyone is importing <code>field_theory.tower</code> so probably it can go there ;-)</p>



<a name="265731843"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/265731843" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#265731843">(Dec 21 2021 at 20:40)</a>:</h4>
<p>It sounds like it should go under <code>logic.</code>, as those are the basic files. <code>logic.basic</code>, maybe?</p>



<a name="265732144"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/265732144" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#265732144">(Dec 21 2021 at 20:43)</a>:</h4>
<p>Stranding it in a random file towards what you're using it for seems like the safest way to forget about it.</p>



<a name="265735025"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/265735025" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#265735025">(Dec 21 2021 at 21:15)</a>:</h4>
<p>I think we should make it its own file &amp; some simp lemmas just to simplify working with it</p>



<a name="265735165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/265735165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#265735165">(Dec 21 2021 at 21:16)</a>:</h4>
<p>Gabriel wrote a simp lemma above</p>



<a name="271821128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/271821128" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> María Inés de Frutos Fernández <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#271821128">(Feb 14 2022 at 12:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma/near/264718546">said</a>:</p>
<blockquote>
<p>I think <code>force_noncomputable</code> (maybe with another name like <code>forbid_evaluation</code> or <code>classicalize</code>) probably belongs in mathlib somewhere</p>
</blockquote>
<p>Did <code>force_noncomputable</code> make it into <code>mathlib</code>? I haven't found it under any of these names.</p>



<a name="275043469"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/275043469" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#275043469">(Mar 11 2022 at 22:30)</a>:</h4>
<p><span class="user-mention" data-user-id="306601">@Kyle Miller</span> (moving <a href="#narrow/stream/116290-rss/topic/Recent.20Commits.20to.20lean.3Amaster/near/275032967">this conversation</a> from <a class="stream" data-stream-id="116290" href="/#narrow/stream/116290-rss">#rss</a> ) above are some examples of timeouts fixed by <code>force_noncomputable</code>. The other issue I saw (some code of Ashvni's) was a definition where Lean complained whether or not you marked it <code>noncomputable</code>, so you couldn't get it make it un-noisy. I think <span class="user-mention" data-user-id="308899">@Yakov Pechersky</span> had a mathlib-free example of this?</p>



<a name="275044364"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/275044364" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#275044364">(Mar 11 2022 at 22:40)</a>:</h4>
<p>Issue <a href="https://github.com/leanprover-community/lean/pull/451">lean#451</a> has an example of a function that's neither computable nor noncomputable. If Ashvni's issue is "rec_fn_macro only allowed in meta definitions", then doing both <code>noncomputable theory</code> and <code>noncomputable</code> might be a workaround. If I understand it right, the first command tells lean to not complain that you put <code>noncomputable</code> on a definition it thinks is computable, and the second command will cause Lean to compile recursive definitions using a different strategy, so you might luck out.</p>



<a name="281970855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/281970855" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#281970855">(May 11 2022 at 14:09)</a>:</h4>
<p>Another example of a mysterious timeout fixed by <code>noncomputable!</code>: <a href="https://github.com/leanprover-community/mathlib/pull/14071">#14071</a></p>



<a name="281971062"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/281971062" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#281971062">(May 11 2022 at 14:10)</a>:</h4>
<p>I came across this in the subobject refactor <a href="https://github.com/leanprover-community/mathlib/pull/11759">#11759</a>, even though this declaration should have absolutely nothing to do with subobjects...</p>



<a name="282013845"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/timeout%20fixed%20by%20changing%20def%20to%20lemma/near/282013845" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/timeout.20fixed.20by.20changing.20def.20to.20lemma.html#282013845">(May 11 2022 at 19:08)</a>:</h4>
<p>My (limited) understanding is that the vm compiler starts with some very aggressive whnf calculations, which I believe has exponential behavior when typeclasses are many and deep. I don't know if that applies here.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>