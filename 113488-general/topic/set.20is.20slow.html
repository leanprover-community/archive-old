---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/set.20is.20slow.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html">set is slow</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="193429944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193429944" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193429944">(Apr 09 2020 at 10:08)</a>:</h4>
<p>the tactic <code>set</code> takes a long time to parse and elaborate:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span>

<span class="kn">set_option</span> <span class="n">profiler</span> <span class="n">true</span>
<span class="c1">-- parsing took 399ms</span>
<span class="c1">-- elaboration of test_let took 139ms</span>
<span class="kn">theorem</span> <span class="n">test_let</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span>
  <span class="n">trivial</span>
<span class="kn">end</span>

<span class="c1">-- parsing took 1.38s</span>
<span class="c1">-- elaboration of test_set took 687ms</span>
<span class="kn">theorem</span> <span class="n">test_set</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">set</span> <span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">trivial</span>
<span class="kn">end</span>
</pre></div>



<a name="193430509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193430509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193430509">(Apr 09 2020 at 10:14)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">meta</span> <span class="n">def</span> <span class="err">«</span><span class="k">let</span><span class="err">»</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">ident</span><span class="err">?</span><span class="o">)</span> <span class="o">(</span><span class="n">q₁</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">&quot;:&quot;</span> <span class="bp">*&gt;</span> <span class="n">texpr</span><span class="o">)</span><span class="err">?</span><span class="o">)</span> <span class="o">(</span><span class="n">q₂</span> <span class="o">:</span> <span class="n">parse</span> <span class="err">$</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">&quot;:=&quot;</span> <span class="bp">*&gt;</span> <span class="n">texpr</span><span class="o">)</span><span class="err">?</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="k">let</span> <span class="n">h</span> <span class="o">:=</span> <span class="n">h</span><span class="bp">.</span><span class="n">get_or_else</span> <span class="bp">`</span><span class="n">this</span> <span class="k">in</span>
<span class="k">match</span> <span class="n">q₁</span><span class="o">,</span> <span class="n">q₂</span> <span class="k">with</span>
<span class="bp">|</span> <span class="n">some</span> <span class="n">e</span><span class="o">,</span> <span class="n">some</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">do</span>
  <span class="n">t</span> <span class="err">←</span> <span class="n">i_to_expr</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">v</span> <span class="err">←</span> <span class="n">i_to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="err">%%</span><span class="n">p</span> <span class="o">:</span> <span class="err">%%</span><span class="n">t</span><span class="o">),</span>
  <span class="n">tactic</span><span class="bp">.</span><span class="n">definev</span> <span class="n">h</span> <span class="n">t</span> <span class="n">v</span>
<span class="bp">|</span> <span class="n">none</span><span class="o">,</span> <span class="n">some</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">do</span>
  <span class="n">p</span> <span class="err">←</span> <span class="n">i_to_expr</span> <span class="n">p</span><span class="o">,</span>
  <span class="n">tactic</span><span class="bp">.</span><span class="n">pose</span> <span class="n">h</span> <span class="n">none</span> <span class="n">p</span>
<span class="bp">|</span> <span class="n">some</span> <span class="n">e</span><span class="o">,</span> <span class="n">none</span> <span class="o">:=</span> <span class="n">i_to_expr</span> <span class="n">e</span> <span class="bp">&gt;&gt;=</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">define</span> <span class="n">h</span>
<span class="bp">|</span> <span class="n">none</span><span class="o">,</span> <span class="n">none</span> <span class="o">:=</span> <span class="n">do</span>
  <span class="n">u</span> <span class="err">←</span> <span class="n">mk_meta_univ</span><span class="o">,</span>
  <span class="n">e</span> <span class="err">←</span> <span class="n">mk_meta_var</span> <span class="o">(</span><span class="n">sort</span> <span class="n">u</span><span class="o">),</span>
  <span class="n">tactic</span><span class="bp">.</span><span class="n">define</span> <span class="n">h</span> <span class="n">e</span>
<span class="kn">end</span> <span class="bp">&gt;&gt;</span> <span class="n">skip</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">set</span> <span class="o">(</span><span class="n">h_simp</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">&quot;!&quot;</span><span class="o">)</span><span class="err">?</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">ident</span><span class="o">)</span> <span class="o">(</span><span class="n">tp</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">((</span><span class="n">tk</span> <span class="s2">&quot;:&quot;</span><span class="o">)</span> <span class="bp">&gt;&gt;</span> <span class="n">texpr</span><span class="o">)</span><span class="err">?</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">_</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">&quot;:=&quot;</span><span class="o">))</span> <span class="o">(</span><span class="n">pv</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">texpr</span><span class="o">)</span>
  <span class="o">(</span><span class="n">rev_name</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">opt_dir_with</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">do</span> <span class="k">let</span> <span class="n">vt</span> <span class="o">:=</span> <span class="k">match</span> <span class="n">tp</span> <span class="k">with</span> <span class="bp">|</span> <span class="n">some</span> <span class="n">t</span> <span class="o">:=</span> <span class="n">t</span> <span class="bp">|</span> <span class="n">none</span> <span class="o">:=</span> <span class="n">pexpr</span><span class="bp">.</span><span class="n">mk_placeholder</span> <span class="kn">end</span><span class="o">,</span>
   <span class="k">let</span> <span class="n">pv</span> <span class="o">:=</span> <span class="bp">``</span><span class="o">(</span><span class="err">%%</span><span class="n">pv</span> <span class="o">:</span> <span class="err">%%</span><span class="n">vt</span><span class="o">),</span>
   <span class="n">v</span> <span class="err">←</span> <span class="n">to_expr</span> <span class="n">pv</span><span class="o">,</span>
   <span class="n">tp</span> <span class="err">←</span> <span class="n">infer_type</span> <span class="n">v</span><span class="o">,</span>
   <span class="n">definev</span> <span class="n">a</span> <span class="n">tp</span> <span class="n">v</span><span class="o">,</span>
   <span class="n">when</span> <span class="n">h_simp</span><span class="bp">.</span><span class="n">is_none</span> <span class="err">$</span> <span class="n">change&#39;</span> <span class="n">pv</span> <span class="o">(</span><span class="n">some</span> <span class="o">(</span><span class="n">expr</span><span class="bp">.</span><span class="n">const</span> <span class="n">a</span> <span class="o">[]))</span> <span class="n">loc</span><span class="bp">.</span><span class="n">wildcard</span><span class="o">,</span>
   <span class="k">match</span> <span class="n">rev_name</span> <span class="k">with</span>
   <span class="bp">|</span> <span class="n">some</span> <span class="o">(</span><span class="n">flip</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span> <span class="o">:=</span>
     <span class="n">do</span> <span class="n">nv</span> <span class="err">←</span> <span class="n">get_local</span> <span class="n">a</span><span class="o">,</span>
        <span class="n">pf</span> <span class="err">←</span> <span class="n">to_expr</span> <span class="o">(</span><span class="n">cond</span> <span class="n">flip</span> <span class="bp">``</span><span class="o">(</span><span class="err">%%</span><span class="n">pv</span> <span class="bp">=</span> <span class="err">%%</span><span class="n">nv</span><span class="o">)</span> <span class="bp">``</span><span class="o">(</span><span class="err">%%</span><span class="n">nv</span> <span class="bp">=</span> <span class="err">%%</span><span class="n">pv</span><span class="o">))</span> <span class="bp">&gt;&gt;=</span> <span class="n">assert</span> <span class="n">id</span><span class="o">,</span>
        <span class="n">reflexivity</span>
   <span class="bp">|</span> <span class="n">none</span> <span class="o">:=</span> <span class="n">skip</span>
   <span class="kn">end</span>
</pre></div>



<a name="193430588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193430588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193430588">(Apr 09 2020 at 10:15)</a>:</h4>
<p>so by elimination <code>parse opt_dir_with</code> should be the problem?</p>



<a name="193430602"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193430602" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193430602">(Apr 09 2020 at 10:15)</a>:</h4>
<p>There are some things that can be cleaned up there, like using <code>mk_eq</code> instead of elaborating pre-expressions</p>



<a name="193430657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193430657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193430657">(Apr 09 2020 at 10:16)</a>:</h4>
<p>there is also <code>change'</code></p>



<a name="193430867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193430867" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193430867">(Apr 09 2020 at 10:18)</a>:</h4>
<p>the <code>reflexivity</code> also looks suspicious</p>



<a name="193431053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431053">(Apr 09 2020 at 10:20)</a>:</h4>
<p>what's the difference between <code>set a : b := c with d</code> and <code>let a : b := c, have d : a = c := rfl</code>?</p>



<a name="193431228"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431228" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431228">(Apr 09 2020 at 10:22)</a>:</h4>
<p>nothing</p>



<a name="193431266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431266">(Apr 09 2020 at 10:23)</a>:</h4>
<p>actually not nothing, <code>set</code> also replaces occurrences of <code>c</code> with <code>a</code> in the hypotheses and goal if you use <code>!</code>, I think</p>



<a name="193431284"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431284" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431284">(Apr 09 2020 at 10:23)</a>:</h4>
<p>or if you don't use <code>!</code>?</p>



<a name="193431309"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431309" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431309">(Apr 09 2020 at 10:24)</a>:</h4>
<p>from looking at the code it seems it's the other way around</p>



<a name="193431534"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431534" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431534">(Apr 09 2020 at 10:26)</a>:</h4>
<p>I should mention that I'm seeing some significantly different profile results</p>
<div class="codehilite"><pre><span></span><span class="c1">-- parsing took 95.4ms</span>
<span class="c1">-- elaboration of test_let took 25ms</span>
<span class="kn">theorem</span> <span class="n">test_let</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="bp">...</span>

<span class="c1">-- parsing took 264ms</span>
<span class="c1">-- elaboration of test_set took 60.9ms</span>
<span class="kn">theorem</span> <span class="n">test_set</span> <span class="o">:</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">...</span>
</pre></div>



<a name="193431565"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431565" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431565">(Apr 09 2020 at 10:26)</a>:</h4>
<p>are you using a chromebook or some similar low power device?</p>



<a name="193431623"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431623" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431623">(Apr 09 2020 at 10:27)</a>:</h4>
<p>I think my computer is 4x slower than others here</p>



<a name="193431635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431635">(Apr 09 2020 at 10:27)</a>:</h4>
<p>which, if you factor that in, seems accurate</p>



<a name="193431641"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431641" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431641">(Apr 09 2020 at 10:27)</a>:</h4>
<p>the difference is more like 10x here though</p>



<a name="193431757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431757" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431757">(Apr 09 2020 at 10:28)</a>:</h4>
<p>399 ~ 95.4 x 4<br>
139 ~ 25 x 4<br>
1380 ~ 264 x 4<br>
687 ~ 60 x 10??</p>



<a name="193431763"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431763" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431763">(Apr 09 2020 at 10:28)</a>:</h4>
<p>yeah, about 4 times</p>



<a name="193431804"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431804" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431804">(Apr 09 2020 at 10:29)</a>:</h4>
<p>okay, I'll just make the test 4x longer</p>



<a name="193431821"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431821" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431821">(Apr 09 2020 at 10:29)</a>:</h4>
<p>Intel(R) Core(TM) i5-7300U CPU @ 2.60 GHz 2.71 GHz 8.00 GB</p>



<a name="193431988"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193431988" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193431988">(Apr 09 2020 at 10:31)</a>:</h4>
<p>That seems like a reasonable CPU.  Are you running a debug build of Lean?</p>



<a name="193432082"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432082" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432082">(Apr 09 2020 at 10:32)</a>:</h4>
<p>why does it seem like I have only 4GB of RAM available?</p>



<a name="193432104"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432104" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432104">(Apr 09 2020 at 10:32)</a>:</h4>
<p>when I open the task manager, it says I'm using ~3000 MB and that is ~80%</p>



<a name="193432148"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432148" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432148">(Apr 09 2020 at 10:33)</a>:</h4>
<p>hmm, if I go to the performance tab the it says I'm using 6.6 GB</p>



<a name="193432161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432161">(Apr 09 2020 at 10:33)</a>:</h4>
<p>are you on windows?</p>



<a name="193432171"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432171" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432171">(Apr 09 2020 at 10:33)</a>:</h4>
<p>yeah</p>



<a name="193432177"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432177" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432177">(Apr 09 2020 at 10:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/113488-general/topic/set.20is.20slow/near/193431988" title="#narrow/stream/113488-general/topic/set.20is.20slow/near/193431988">said</a>:</p>
<blockquote>
<p>That seems like a reasonable CPU.  Are you running a debug build of Lean?</p>
</blockquote>
<p>what does this mean?</p>



<a name="193432179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432179">(Apr 09 2020 at 10:33)</a>:</h4>
<p>windows does heap compression</p>



<a name="193432248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432248">(Apr 09 2020 at 10:34)</a>:</h4>
<p>also I only have 2 cores and I think you guys have like 8 cores</p>



<a name="193432263"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432263" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432263">(Apr 09 2020 at 10:34)</a>:</h4>
<p>I have 2 cores and 4 threads</p>



<a name="193432266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432266">(Apr 09 2020 at 10:34)</a>:</h4>
<p>Did you compile lean yourself?</p>



<a name="193432276"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432276" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432276">(Apr 09 2020 at 10:34)</a>:</h4>
<p>no, I used elan</p>



<a name="193432287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193432287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193432287">(Apr 09 2020 at 10:34)</a>:</h4>
<p>I don't think individual proofs are multithreaded though</p>



<a name="193433234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433234">(Apr 09 2020 at 10:44)</a>:</h4>
<p>the parsing is surprisingly expensive here, and playing around with things it seems like <code>prod.mk</code> is more expensive than I would have guessed</p>



<a name="193433264"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433264" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433264">(Apr 09 2020 at 10:44)</a>:</h4>
<p>why would <code>prod.mk</code> be expensive at all?</p>



<a name="193433328"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433328" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433328">(Apr 09 2020 at 10:45)</a>:</h4>
<p>As I've posted in a private chat:<br>
Did you know how the syntax for the tactic arguments is implemented?  When an interactive tactic has an argument of type <code>parse foo : α</code>, then <code>foo : parser α</code> is a metaprogram that is executed in the VM to parse the argument.  So you can make parsing as slow as you want by running arbitrary programs at parse time!</p>



<a name="193433407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433407">(Apr 09 2020 at 10:46)</a>:</h4>
<p>To make matters even worse, the VM compiler is run for every argument, every time you parse an interactive tactic.</p>



<a name="193433411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433411">(Apr 09 2020 at 10:46)</a>:</h4>
<p>also parsing seems to be in general slower than the last time I was here</p>



<a name="193433450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433450">(Apr 09 2020 at 10:46)</a>:</h4>
<p>even though I didn't use any new tactics</p>



<a name="193433456"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433456" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433456">(Apr 09 2020 at 10:46)</a>:</h4>
<p>(partly because I don't know them)</p>



<a name="193433744"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433744" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433744">(Apr 09 2020 at 10:50)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">open</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span>
<span class="n">local</span> <span class="kn">postfix</span> <span class="bp">`</span><span class="err">?</span><span class="bp">`</span><span class="o">:</span><span class="mi">9001</span> <span class="o">:=</span> <span class="n">optional</span>
<span class="kn">namespace</span> <span class="n">tactic</span>
<span class="kn">namespace</span> <span class="n">interactive</span>
<span class="kn">open</span> <span class="n">interactive</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">rev_name</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">do</span>
  <span class="n">tk</span> <span class="s2">&quot;with&quot;</span><span class="o">,</span>
  <span class="n">a</span> <span class="err">←</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">&quot;&lt;-&quot;</span><span class="o">)</span><span class="err">?</span><span class="o">,</span>
  <span class="n">b</span> <span class="err">←</span> <span class="n">ident</span><span class="o">,</span>
  <span class="n">return</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">))</span><span class="err">?</span><span class="o">)</span> <span class="o">:=</span> <span class="n">skip</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">bar</span> <span class="o">(</span><span class="n">rev_name</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">do</span>
  <span class="n">tk</span> <span class="s2">&quot;with&quot;</span><span class="o">,</span>
  <span class="n">a</span> <span class="err">←</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">&quot;&lt;-&quot;</span><span class="o">)</span><span class="err">?</span><span class="o">,</span>
  <span class="n">b</span> <span class="err">←</span> <span class="n">ident</span><span class="o">,</span>
  <span class="n">return</span> <span class="o">(</span><span class="n">b</span><span class="o">))</span><span class="err">?</span><span class="o">)</span> <span class="o">:=</span> <span class="n">skip</span>

<span class="kn">end</span> <span class="n">interactive</span>
<span class="kn">end</span> <span class="n">tactic</span>

<span class="kn">set_option</span> <span class="n">profiler</span> <span class="n">true</span>

<span class="c1">-- parsing took 950ms - 1.5s</span>
<span class="kn">theorem</span> <span class="n">test_foo</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">foo</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">foo</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="c1">-- ×40</span>
  <span class="n">trivial</span>
<span class="kn">end</span>

<span class="c1">-- parsing took 161ms - 207ms</span>
<span class="kn">theorem</span> <span class="n">test_bar</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">bar</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="n">bar</span> <span class="k">with</span> <span class="n">hf</span><span class="o">,</span>
  <span class="c1">-- ×40</span>
  <span class="n">trivial</span>
<span class="kn">end</span>
</pre></div>



<a name="193433813"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433813" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433813">(Apr 09 2020 at 10:51)</a>:</h4>
<p>note that <code>foo</code> and <code>bar</code> accept the <em>same</em> grammar</p>



<a name="193433830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433830">(Apr 09 2020 at 10:51)</a>:</h4>
<p>Is there a typo in <code>test_bar</code>?  It should be <code>bar with</code> instead of <code>foo with</code>, right?</p>



<a name="193433838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433838" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433838">(Apr 09 2020 at 10:51)</a>:</h4>
<p>yes</p>



<a name="193433844"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433844" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433844">(Apr 09 2020 at 10:51)</a>:</h4>
<p>Indeed, it looks like there are two independent slowdowns, the parsing and the replacing. Mario seems to have a handle on the parsing. Using <code>set!</code> instead of <code>set</code> makes the elaboration times about the same for me. So <code>change'</code> is slow.</p>



<a name="193433926"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433926" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433926">(Apr 09 2020 at 10:52)</a>:</h4>
<p>oh no</p>



<a name="193433931"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433931" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433931">(Apr 09 2020 at 10:52)</a>:</h4>
<p>what's the story here? <code>change'</code> is fixing something in <code>change with</code>?</p>



<a name="193433998"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193433998" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193433998">(Apr 09 2020 at 10:53)</a>:</h4>
<p><code>change with</code> gets things wrong when there are dependencies.</p>



<a name="193434058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434058">(Apr 09 2020 at 10:54)</a>:</h4>
<p>do you have an example?</p>



<a name="193434092"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434092" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434092">(Apr 09 2020 at 10:54)</a>:</h4>
<p>I would have assumed that since everything is defeq there are no problems with dependencies</p>



<a name="193434257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434257" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434257">(Apr 09 2020 at 10:56)</a>:</h4>
<p>The example in the old PR is </p>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">change</span> <span class="n">a</span> <span class="k">with</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
<span class="kn">end</span>
</pre></div>



<a name="193434268"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434268" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434268">(Apr 09 2020 at 10:57)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/pull/712" title="https://github.com/leanprover-community/mathlib/pull/712">https://github.com/leanprover-community/mathlib/pull/712</a></p>



<a name="193434389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434389">(Apr 09 2020 at 10:58)</a>:</h4>
<p>I don't remember the details.</p>



<a name="193434405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434405">(Apr 09 2020 at 10:58)</a>:</h4>
<p>is it just <code>at *</code> that has the problem? I tried <code>at h</code> and <code>at h |-</code> and <code>at a h |-</code> and they all work fine</p>



<a name="193434485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434485">(Apr 09 2020 at 10:59)</a>:</h4>
<p><code>at h a</code> doesn't work.</p>



<a name="193434718"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434718" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434718">(Apr 09 2020 at 11:01)</a>:</h4>
<p>hm. well to some extent I would expect <code>set</code> to be asymptotically slower than <code>let</code> because it has to examine the whole context on each new line, so an O(n^2) operation</p>



<a name="193434855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434855" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434855">(Apr 09 2020 at 11:02)</a>:</h4>
<p>the parsing on the other hand is completely baffling</p>



<a name="193434868"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434868" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434868">(Apr 09 2020 at 11:03)</a>:</h4>
<p>On my machine the parsing makes a way bigger difference than the change.</p>



<a name="193434913"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434913" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434913">(Apr 09 2020 at 11:03)</a>:</h4>
<p>inlining the parser helps some</p>



<a name="193434930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193434930" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193434930">(Apr 09 2020 at 11:03)</a>:</h4>
<p>I tried <code>@[inline]</code> but it doesn't seem to work</p>



<a name="193436334"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193436334" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193436334">(Apr 09 2020 at 11:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/113488-general/topic/set.20is.20slow/near/193433407" title="#narrow/stream/113488-general/topic/set.20is.20slow/near/193433407">said</a>:</p>
<blockquote>
<p>To make matters even worse, the VM compiler is run for every argument, every time you parse an interactive tactic.</p>
</blockquote>
<p>Whoever came up with that <span aria-label="information desk person" class="emoji emoji-1f481" role="img" title="information desk person">:information_desk_person:</span></p>



<a name="193436517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193436517" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193436517">(Apr 09 2020 at 11:21)</a>:</h4>
<p>The compilation overhead seems to be negligible, at least in Mario's example.  I've tried factoring out the parsers into separate definitions, it's not faster, and I still see the performance difference:</p>
<div class="codehilite"><pre><span></span><span class="kn">open</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span>
<span class="n">local</span> <span class="kn">postfix</span> <span class="bp">`</span><span class="err">?</span><span class="bp">`</span><span class="o">:</span><span class="mi">9001</span> <span class="o">:=</span> <span class="n">optional</span>
<span class="kn">namespace</span> <span class="n">tactic</span>
<span class="kn">namespace</span> <span class="n">interactive</span>
<span class="kn">open</span> <span class="n">interactive</span>

<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">compiler</span><span class="bp">.</span><span class="n">optimize_bytecode</span> <span class="n">true</span>
<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">compiler</span><span class="bp">.</span><span class="n">preprocess</span> <span class="n">true</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">foo_core</span> <span class="o">:=</span> <span class="o">(</span><span class="n">do</span>
<span class="n">tk</span> <span class="s2">&quot;with&quot;</span><span class="o">,</span>
<span class="n">a</span> <span class="err">←</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">&quot;&lt;-&quot;</span><span class="o">)</span><span class="err">?</span><span class="o">,</span>
<span class="n">b</span> <span class="err">←</span> <span class="n">ident</span><span class="o">,</span>
<span class="n">return</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">))</span><span class="err">?</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">bar_core</span> <span class="o">:=</span> <span class="o">(</span><span class="n">do</span>
<span class="n">tk</span> <span class="s2">&quot;with&quot;</span><span class="o">,</span>
<span class="n">a</span> <span class="err">←</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">&quot;&lt;-&quot;</span><span class="o">)</span><span class="err">?</span><span class="o">,</span>
<span class="n">b</span> <span class="err">←</span> <span class="n">ident</span><span class="o">,</span>
<span class="n">return</span> <span class="o">(</span><span class="n">b</span><span class="o">))</span><span class="err">?</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">rev_name</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">bar_core</span><span class="o">)</span> <span class="o">:=</span> <span class="n">skip</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">bar</span> <span class="o">(</span><span class="n">rev_name</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">foo_core</span><span class="o">)</span> <span class="o">:=</span> <span class="n">skip</span>
</pre></div>



<a name="193436550"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193436550" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193436550">(Apr 09 2020 at 11:21)</a>:</h4>
<p>Weirdly enough, <code>foo_core</code> and <code>bar_core</code> only differ in two bytecode instructions...</p>



<a name="193437048"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193437048" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193437048">(Apr 09 2020 at 11:27)</a>:</h4>
<p>Oh, no.. I think I know what is going on.  After the parser is finished, the result (for foo this is a value of type <code>option (option unit × string)</code>) is converted into an <code>expr</code> by calling <code>reflect</code>.  It's not <code>prod.mk</code> that is slow, but reflecting the product.</p>



<a name="193437139"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193437139" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193437139">(Apr 09 2020 at 11:28)</a>:</h4>
<p>I saw the <code>reflectable</code> thing but I'm not exactly sure how it is implemented</p>



<a name="193437195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193437195" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193437195">(Apr 09 2020 at 11:29)</a>:</h4>
<p>or what it's for. Is it like <code>decidable p</code> where the reflectable instance is the "real" parser and everything else is just window dressing?</p>



<a name="193437296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193437296" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193437296">(Apr 09 2020 at 11:30)</a>:</h4>
<p>This is from <a href="https://github.com/leanprover-community/lean/issues/19" title="https://github.com/leanprover-community/lean/issues/19">lean#19</a> which was merged into 3.5...</p>



<a name="193437349"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193437349" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193437349">(Apr 09 2020 at 11:30)</a>:</h4>
<p>so Kenny's claims about a performance regression are true?</p>



<a name="193437372"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193437372" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193437372">(Apr 09 2020 at 11:31)</a>:</h4>
<p>At least they're plausible.</p>



<a name="193437410"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193437410" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193437410">(Apr 09 2020 at 11:31)</a>:</h4>
<p>Could someone eli5?</p>



<a name="193442186"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193442186" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193442186">(Apr 09 2020 at 12:23)</a>:</h4>
<p><a href="https://github.com/leanprover-community/lean/issues/180" title="https://github.com/leanprover-community/lean/issues/180">lean#180</a></p>



<a name="193443227"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/set%20is%20slow/near/193443227" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/set.20is.20slow.html#193443227">(Apr 09 2020 at 12:34)</a>:</h4>
<p>thanks</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>