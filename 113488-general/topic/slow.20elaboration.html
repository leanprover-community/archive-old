---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/slow.20elaboration.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html">slow elaboration</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="198648425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198648425" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198648425">(May 25 2020 at 09:05)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">group_ring_action</span> <span class="n">linear_algebra</span><span class="bp">.</span><span class="n">basis</span> <span class="n">field_theory</span><span class="bp">.</span><span class="n">subfield</span>

<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span>

<span class="kn">variables</span> <span class="o">(</span><span class="n">G</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">group</span> <span class="n">G</span><span class="o">]</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">)</span> <span class="o">[</span><span class="n">field</span> <span class="n">F</span><span class="o">]</span> <span class="o">[</span><span class="n">mul_semiring_action</span> <span class="n">G</span> <span class="n">F</span><span class="o">]</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">G</span><span class="o">)</span>

<span class="n">def</span> <span class="n">fixed</span> <span class="o">:</span> <span class="n">set</span> <span class="n">F</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">x</span> <span class="bp">|</span> <span class="bp">∀</span> <span class="n">g</span> <span class="o">:</span> <span class="n">G</span><span class="o">,</span> <span class="n">g</span> <span class="err">•</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">is_subfield</span> <span class="o">(</span><span class="n">fixed</span> <span class="n">G</span> <span class="n">F</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">sorry</span>

<span class="c">/-</span><span class="cm">- Embedding induced by action. -/</span>
<span class="n">def</span> <span class="n">mul_action</span><span class="bp">.</span><span class="n">to_fun</span> <span class="o">:</span> <span class="n">F</span> <span class="err">↪</span> <span class="o">(</span><span class="n">G</span> <span class="bp">→</span> <span class="n">F</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">⟨λ</span> <span class="n">x</span> <span class="n">m</span><span class="o">,</span> <span class="n">m</span> <span class="err">•</span> <span class="n">x</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">y</span> <span class="n">H</span><span class="o">,</span> <span class="n">one_smul</span> <span class="n">G</span> <span class="n">x</span> <span class="bp">▸</span> <span class="n">one_smul</span> <span class="n">G</span> <span class="n">y</span> <span class="bp">▸</span> <span class="k">by</span> <span class="n">convert</span> <span class="n">congr_fun</span> <span class="n">H</span> <span class="mi">1</span><span class="bp">⟩</span>

<span class="kn">theorem</span> <span class="n">linear_independent_smul_of_linear_independent</span> <span class="o">{</span><span class="n">s</span> <span class="o">:</span> <span class="n">finset</span> <span class="n">F</span><span class="o">}</span>
  <span class="o">(</span><span class="n">hs</span> <span class="o">:</span> <span class="n">linear_independent</span> <span class="o">(</span><span class="n">fixed</span> <span class="n">G</span> <span class="n">F</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span> <span class="o">:</span> <span class="o">(</span><span class="err">↑</span><span class="n">s</span> <span class="o">:</span> <span class="n">set</span> <span class="n">F</span><span class="o">),</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">F</span><span class="o">)))</span> <span class="o">:</span>
  <span class="n">linear_independent</span> <span class="n">F</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span> <span class="o">:</span> <span class="o">(</span><span class="err">↑</span><span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="n">mul_action</span><span class="bp">.</span><span class="n">to_fun</span> <span class="n">G</span> <span class="n">F</span><span class="o">)</span> <span class="o">:</span> <span class="n">set</span> <span class="o">(</span><span class="n">G</span> <span class="bp">→</span> <span class="n">F</span><span class="o">)),</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">G</span> <span class="bp">→</span> <span class="n">F</span><span class="o">))</span> <span class="o">:=</span>
<span class="n">sorry</span>
</code></pre></div>



<a name="198648431"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198648431" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198648431">(May 25 2020 at 09:05)</a>:</h4>
<p>the statement of the theorem is slow to elaborate</p>



<a name="198648475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198648475" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198648475">(May 25 2020 at 09:06)</a>:</h4>
<p>but <code>profiler</code> doesn't show any abnormality</p>



<a name="198648505"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198648505" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198648505">(May 25 2020 at 09:06)</a>:</h4>
<p>if I use <code>trace.class_instances</code> there is this mysterious search for:</p>
<div class="codehilite"><pre><span></span><code><span class="n">has_coe_to_fun</span> <span class="err">↥↑</span><span class="o">(</span><span class="bp">@</span><span class="n">finset</span><span class="bp">.</span><span class="n">map</span> <span class="n">F</span> <span class="o">(</span><span class="n">G</span> <span class="bp">→</span> <span class="n">F</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">mul_action</span><span class="bp">.</span><span class="n">to_fun</span> <span class="n">G</span> <span class="bp">_</span><span class="n">inst_1</span> <span class="n">F</span> <span class="bp">_</span><span class="n">inst_2</span> <span class="bp">_</span><span class="n">inst_3</span><span class="o">)</span> <span class="n">s</span><span class="o">)</span>
</code></pre></div>



<a name="198648513"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198648513" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198648513">(May 25 2020 at 09:07)</a>:</h4>
<p>which I cannot find in the <code>pp.all</code> <code>#print</code></p>



<a name="198648525"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198648525" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198648525">(May 25 2020 at 09:07)</a>:</h4>
<p>is there anyway to somehow track the elaboration?</p>



<a name="198649085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649085">(May 25 2020 at 09:15)</a>:</h4>
<p>Does </p>
<div class="codehilite"><pre><span></span><code><span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq</span> <span class="n">true</span>
<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span> <span class="n">true</span>
</code></pre></div>


<p>help?</p>



<a name="198649162"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649162" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649162">(May 25 2020 at 09:16)</a>:</h4>
<p>Wait, what version of Lean are you on? Everything is instant for me on 3.13.2</p>



<a name="198649248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649248">(May 25 2020 at 09:17)</a>:</h4>
<p><code>(3, (14, 0))</code></p>



<a name="198649319"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649319" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649319">(May 25 2020 at 09:18)</a>:</h4>
<p>I do have some crazy search for the coercion though:</p>
<div class="codehilite"><pre><span></span><code>[class_instances] (2) ?x_104 : has_coe ↥↑(@finset.map F (G → F) (@mul_action.to_fun G _inst_1 F _inst_2 _inst_3) s) ?x_101 := @list.bin_tree_to_list ?x_205
failed is_def_eq
[class_instances] (2) ?x_104 : has_coe ↥↑(@finset.map F (G → F) (@mul_action.to_fun G _inst_1 F _inst_2 _inst_3) s) ?x_101 := smt_tactic.has_coe ?x_206
failed is_def_eq
[class_instances] (2) ?x_104 : has_coe ↥↑(@finset.map F (G → F) (@mul_action.to_fun G _inst_1 F _inst_2 _inst_3) s) ?x_101 := @lean.parser.has_coe ?x_207
failed is_def_eq
[class_instances] (2) ?x_104 : has_coe ↥↑(@finset.map F (G → F) (@mul_action.to_fun G _inst_1 F _inst_2 _inst_3) s) ?x_101 := @tactic.ex_to_tac ?x_208
failed is_def_eq
[class_instances] (2) ?x_104 : has_coe ↥↑(@finset.map F (G → F) (@mul_action.to_fun G _inst_1 F _inst_2 _inst_3) s) ?x_101 := @tactic.opt_to_tac ?x_209
failed is_def_eq
[class_instances] (2) ?x_104 : has_coe ↥↑(@finset.map F (G → F) (@mul_action.to_fun G _inst_1 F _inst_2 _inst_3) s) ?x_101 := @expr.has_coe ?x_210 ?x_211
failed is_def_eq
[class_instances] (2) ?x_104 : has_coe ↥↑(@finset.map F (G → F) (@mul_action.to_fun G _inst_1 F _inst_2 _inst_3) s) ?x_101 := string_to_format
failed is_def_eq
[class_instances] (2) ?x_104 : has_coe ↥↑(@finset.map F (G → F) (@mul_action.to_fun G _inst_1 F _inst_2 _inst_3) s) ?x_101 := nat_to_format
failed is_def_eq
[class_instances] (2) ?x_104 : has_coe ↥↑(@finset.map F (G → F) (@mul_action.to_fun G _inst_1 F _inst_2 _inst_3) s) ?x_101 := string_to_name
failed is_def_eq
</code></pre></div>


<p>etc</p>



<a name="198649376"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649376" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649376">(May 25 2020 at 09:19)</a>:</h4>
<p>I've never used those so I don't know what to look for</p>



<a name="198649394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649394" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649394">(May 25 2020 at 09:19)</a>:</h4>
<div class="codehilite"><pre><span></span><code>elaboration of linear_independent_smul_of_linear_independent took 0.0389ms
</code></pre></div>



<a name="198649443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649443">(May 25 2020 at 09:20)</a>:</h4>
<p>yeah <code>profiler</code> shows nothing</p>



<a name="198649458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649458">(May 25 2020 at 09:20)</a>:</h4>
<p>but I can see the orange bar</p>



<a name="198649479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649479">(May 25 2020 at 09:20)</a>:</h4>
<p>takes about 4 seconds for the orange bar to disappear</p>



<a name="198649483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649483">(May 25 2020 at 09:20)</a>:</h4>
<p>so maybe 1 second for you</p>



<a name="198649504"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649504" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649504">(May 25 2020 at 09:21)</a>:</h4>
<p>It takes well under a second for mine to disappear. I'll upgrade to 3.14.</p>



<a name="198649666"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649666" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649666">(May 25 2020 at 09:23)</a>:</h4>
<p>The trace output was huge though</p>



<a name="198649815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198649815" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198649815">(May 25 2020 at 09:25)</a>:</h4>
<p>Still fast for me</p>



<a name="198650535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198650535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198650535">(May 25 2020 at 09:34)</a>:</h4>
<p>I upgraded mathlib and now it only takes 2 seconds for the orange bar to disappear</p>



<a name="198650542"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198650542" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198650542">(May 25 2020 at 09:35)</a>:</h4>
<p>so this should be 0.5 seconds for you</p>



<a name="198650586"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198650586" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198650586">(May 25 2020 at 09:35)</a>:</h4>
<p>which I guess would still be visible</p>



<a name="198652529"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/198652529" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#198652529">(May 25 2020 at 10:00)</a>:</h4>
<p>Oh I see it, I can believe it's about a third of a second</p>



<a name="199156980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199156980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199156980">(May 29 2020 at 13:54)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">group_ring_action</span> <span class="n">field_theory</span><span class="bp">.</span><span class="n">subfield</span> <span class="n">ring_theory</span><span class="bp">.</span><span class="n">polynomial</span>
<span class="kn">import</span> <span class="n">field_theory</span><span class="bp">.</span><span class="n">minimal_polynomial</span> <span class="n">field_theory</span><span class="bp">.</span><span class="n">splitting_field</span>

<span class="n">local</span> <span class="n">attribute</span> <span class="o">[</span><span class="kn">instance</span><span class="o">]</span> <span class="n">classical</span><span class="bp">.</span><span class="n">dec</span>

<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span>

<span class="kn">variables</span> <span class="o">(</span><span class="n">G</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">group</span> <span class="n">G</span><span class="o">]</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">)</span> <span class="o">[</span><span class="n">field</span> <span class="n">F</span><span class="o">]</span> <span class="o">[</span><span class="n">mul_semiring_action</span> <span class="n">G</span> <span class="n">F</span><span class="o">]</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">G</span><span class="o">)</span>

<span class="n">def</span> <span class="n">fixed</span> <span class="o">:</span> <span class="n">set</span> <span class="n">F</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">x</span> <span class="bp">|</span> <span class="bp">∀</span> <span class="n">g</span> <span class="o">:</span> <span class="n">G</span><span class="o">,</span> <span class="n">g</span> <span class="err">•</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="n">fixed</span><span class="bp">.</span><span class="n">is_subfield</span> <span class="o">:</span> <span class="n">is_subfield</span> <span class="o">(</span><span class="n">fixed</span> <span class="n">G</span> <span class="n">F</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">sorry</span>

<span class="bp">#</span><span class="kn">check</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="o">(</span><span class="n">fixed</span> <span class="n">G</span> <span class="n">F</span><span class="o">))</span>
</code></pre></div>



<a name="199156992"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199156992" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199156992">(May 29 2020 at 13:55)</a>:</h4>
<p>the <code>check</code> takes 3 to 4 seconds</p>



<a name="199157002"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199157002" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199157002">(May 29 2020 at 13:55)</a>:</h4>
<p>I can't do anything if I can't even talk about <code>1</code></p>



<a name="199533741"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199533741" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199533741">(Jun 02 2020 at 18:29)</a>:</h4>
<p>Elaboration of the <code>inhabited</code> instance in <a href="https://github.com/leanprover-community/mathlib/issues/2897">#2897</a> takes ~10s with <code>lean -j1</code> on my laptop. It's more than the rest of the file.</p>



<a name="199536171"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536171" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536171">(Jun 02 2020 at 18:48)</a>:</h4>
<p>What happened to our <span aria-label="racecar" class="emoji emoji-1f3ce" role="img" title="racecar">:racecar:</span> fast lean?</p>



<a name="199536249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536249">(Jun 02 2020 at 18:49)</a>:</h4>
<p>I took a quick look.  The following reduces the runtime from 8.5s to 2s on my laptop:</p>
<div class="codehilite"><pre><span></span><code><span class="n">local</span> <span class="n">attribute</span> <span class="o">[</span><span class="kn">instance</span><span class="o">,</span> <span class="n">priority</span> <span class="mi">1001</span><span class="o">]</span> <span class="n">classical</span><span class="bp">.</span><span class="n">prop_decidable</span>
</code></pre></div>



<a name="199536353"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536353" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536353">(Jun 02 2020 at 18:50)</a>:</h4>
<p>The reason is that <code>split_if</code> uses <code>by_cases</code>, which uses <code>decidable</code> even if the goal is a prop.</p>



<a name="199536490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536490">(Jun 02 2020 at 18:51)</a>:</h4>
<p>Aah, so would <code>open_locale classical</code> have avoided this problem?</p>



<a name="199536620"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536620" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536620">(Jun 02 2020 at 18:52)</a>:</h4>
<p>There is already an <code>open_locale classical</code>.</p>



<a name="199536625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536625" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536625">(Jun 02 2020 at 18:52)</a>:</h4>
<p>I have <code>open_locale classical</code> but it adds <code>classical.prop_decidable</code> as a low prio instance.</p>



<a name="199536680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536680" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536680">(Jun 02 2020 at 18:52)</a>:</h4>
<p>Gabriel explains that I need to make it a high priority instance.</p>



<a name="199536688"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536688" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536688">(Jun 02 2020 at 18:52)</a>:</h4>
<p>priorities are hard</p>



<a name="199536704"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536704" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536704">(Jun 02 2020 at 18:52)</a>:</h4>
<p>And/or fix <code>by_cases</code>.</p>



<a name="199536740"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536740" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536740">(Jun 02 2020 at 18:53)</a>:</h4>
<p>Ooh... I was still looking at Kenny's code</p>



<a name="199536762"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536762" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536762">(Jun 02 2020 at 18:53)</a>:</h4>
<p>Is it the same problem?</p>



<a name="199536783"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199536783" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199536783">(Jun 02 2020 at 18:53)</a>:</h4>
<p>I somehow assumed that Yury's post was a semireply to Kenny</p>



<a name="199542063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199542063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199542063">(Jun 02 2020 at 19:35)</a>:</h4>
<p>I have a good one. The beginning of the file <code>analysis/specific_functions/pow.lean</code> (after imports) is</p>
<div class="codehilite"><pre><span></span><code><span class="n">open_locale</span> <span class="n">classical</span> <span class="n">real</span> <span class="n">topological_space</span>

<span class="kn">namespace</span> <span class="n">complex</span>

<span class="c">/-</span><span class="cm">- The complex power function `x^y`, given by `x^y = exp(y log x)` (where `log` is the principal</span>
<span class="cm">determination of the logarithm), unless `x = 0` where one sets `0^0 = 1` and `0^y = 0` for</span>
<span class="cm">`y ≠ 0`. -/</span>
<span class="n">noncomputable</span> <span class="n">def</span> <span class="n">cpow</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">ℂ</span><span class="o">)</span> <span class="o">:</span> <span class="n">ℂ</span> <span class="o">:=</span>
<span class="k">if</span> <span class="n">x</span> <span class="bp">=</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="k">if</span> <span class="n">y</span> <span class="bp">=</span> <span class="mi">0</span>
    <span class="k">then</span> <span class="mi">1</span>
    <span class="k">else</span> <span class="mi">0</span>
  <span class="k">else</span> <span class="n">exp</span> <span class="o">(</span><span class="n">log</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">)</span>

<span class="n">noncomputable</span> <span class="kn">instance</span> <span class="o">:</span> <span class="n">has_pow</span> <span class="n">ℂ</span> <span class="n">ℂ</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">cpow</span><span class="bp">⟩</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">cpow_eq_pow</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">ℂ</span><span class="o">)</span> <span class="o">:</span> <span class="n">cpow</span> <span class="n">x</span> <span class="n">y</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">^</span> <span class="n">y</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">lemma</span> <span class="n">cpow_def</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">ℂ</span><span class="o">)</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">^</span> <span class="n">y</span> <span class="bp">=</span>
  <span class="k">if</span> <span class="n">x</span> <span class="bp">=</span> <span class="mi">0</span>
    <span class="k">then</span> <span class="k">if</span> <span class="n">y</span> <span class="bp">=</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="mi">1</span>
      <span class="k">else</span> <span class="mi">0</span>
    <span class="k">else</span> <span class="n">exp</span> <span class="o">(</span><span class="n">log</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span>
</code></pre></div>


<p>With <code>profiler</code> on, I get 17.3s to elaborate <code>cpow</code> (and my computer is pretty fast, so I guess Kenny couldn't even open this file). Then, for <code>cpow_def</code>, the profiler tells me that it is less than one second, but the bar stays orange also for roughly 20s, so something is hidden here.</p>



<a name="199543059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543059">(Jun 02 2020 at 19:44)</a>:</h4>
<p>What on earth is so hard about <code>cpow</code>?</p>



<a name="199543224"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543224" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543224">(Jun 02 2020 at 19:45)</a>:</h4>
<p>Probably it tries many <code>decidable</code> instances before using <code>classical</code> fallback.</p>



<a name="199543336"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543336" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543336">(Jun 02 2020 at 19:46)</a>:</h4>
<p><span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span> Did you try to make <code>classical</code> a high priority instance?</p>



<a name="199543339"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543339" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543339">(Jun 02 2020 at 19:46)</a>:</h4>
<p>Exactly. If you set <code>local attribute [instance, priority 1001] classical.prop_decidable</code>, everything becomes instant.</p>



<a name="199543499"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543499" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543499">(Jun 02 2020 at 19:48)</a>:</h4>
<p>This also makes it instant:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">instance</span> <span class="o">:</span> <span class="n">decidable_eq</span> <span class="n">ℂ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="n">classical</span><span class="bp">.</span><span class="n">prop_decidable</span> <span class="bp">_</span>
</code></pre></div>



<a name="199543518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543518" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543518">(Jun 02 2020 at 19:48)</a>:</h4>
<p>That's crazy...</p>



<a name="199543579"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543579" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543579">(Jun 02 2020 at 19:48)</a>:</h4>
<p><span class="user-mention" data-user-id="110064">@Kenny Lau</span> Does this also fix your problems in this thread?</p>



<a name="199543589"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543589" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543589">(Jun 02 2020 at 19:49)</a>:</h4>
<p>Should we add these instance for real and complex numbers?</p>



<a name="199543723"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543723" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543723">(Jun 02 2020 at 19:50)</a>:</h4>
<p>Wow, this is also instant:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">instance</span> <span class="o">:</span> <span class="n">decidable_eq</span> <span class="n">ℂ</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
</code></pre></div>



<a name="199543977"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543977" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543977">(Jun 02 2020 at 19:52)</a>:</h4>
<p>Don't look at the instance trace, it is definitely not for kids. with things like</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">4</span><span class="o">)</span> <span class="err">?</span><span class="n">x_33</span> <span class="o">:</span> <span class="n">nonneg_ring</span> <span class="n">ℂ</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">linear_nonneg_ring</span><span class="bp">.</span><span class="n">to_nonneg_ring</span> <span class="err">?</span><span class="n">x_34</span> <span class="err">?</span><span class="n">x_35</span>
</code></pre></div>


<p>What's a <code>nonneg_ring</code>?!</p>



<a name="199543997"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199543997" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199543997">(Jun 02 2020 at 19:52)</a>:</h4>
<p>The cause for this decidable tarpit is the <code>eq.decidable</code> instance, which derives <code>decidable_eq α</code> from <code>decidable_linear_order α</code>.  And this searches through half of the tc hierarchy.</p>



<a name="199544413"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199544413" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199544413">(Jun 02 2020 at 19:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/113488-general/topic/slow.20elaboration/near/199543997">said</a>:</p>
<blockquote>
<p>The cause for this decidable tarpit is the <code>eq.decidable</code> instance, which derives <code>decidable_eq α</code> from <code>decidable_linear_order α</code>.  And this searches through half of the tc hierarchy.</p>
</blockquote>
<p>oh!</p>



<a name="199544837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199544837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199544837">(Jun 02 2020 at 19:59)</a>:</h4>
<p>Should we downgrade its priority to 90 and put <code>classical</code> at 95?</p>



<a name="199544840"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199544840" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199544840">(Jun 02 2020 at 19:59)</a>:</h4>
<p>What would happen if we completely unbundle all <code>decidable</code> stuff? So you only have <code>decidable_{eq,prop}</code> and <code>linear_order</code>, but not <code>decidable_linear_order</code>.</p>



<a name="199544995"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199544995" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199544995">(Jun 02 2020 at 20:00)</a>:</h4>
<p>For a long time, I have wanted to kill <code>decidable_linear_order</code>, but this in core, alas. Oh, wait :)</p>



<a name="199545096"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199545096" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199545096">(Jun 02 2020 at 20:01)</a>:</h4>
<blockquote>
<p>Oh, wait :)</p>
</blockquote>
<p>Is that a promise?</p>



<a name="199549947"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199549947" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199549947">(Jun 02 2020 at 20:37)</a>:</h4>
<p><code>nonneg_ring</code> should not be a class, that was a mistake</p>



<a name="199550052"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199550052" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199550052">(Jun 02 2020 at 20:38)</a>:</h4>
<p>and <code>eq.decidable</code> should be a local instance</p>



<a name="199563344"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199563344" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199563344">(Jun 02 2020 at 22:54)</a>:</h4>
<p>I'm just catching up on this now. Is there a PR for this (in progress)? If not, can someone summarize what needs to be done?</p>



<a name="199580184"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/199580184" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#199580184">(Jun 03 2020 at 05:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/113488-general/topic/slow.20elaboration/near/199544840">said</a>:</p>
<blockquote>
<p>What would happen if we completely unbundle all <code>decidable</code> stuff? So you only have <code>decidable_{eq,prop}</code> and <code>linear_order</code>, but not <code>decidable_linear_order</code>.</p>
</blockquote>
<p>I really have no idea if this is feasable. But <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> gave a <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span>, so I think we can/should try this.</p>



<a name="200228178"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200228178" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200228178">(Jun 09 2020 at 13:39)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">monoid_algebra</span>
<span class="kn">import</span> <span class="n">ring_theory</span><span class="bp">.</span><span class="n">algebra</span>
<span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">invertible</span>
<span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">char_p</span>
<span class="kn">import</span> <span class="n">linear_algebra</span><span class="bp">.</span><span class="n">basis</span>

<span class="n">universes</span> <span class="n">u</span>

<span class="n">noncomputable</span> <span class="n">theory</span>
<span class="kn">open</span> <span class="n">module</span>
<span class="kn">open</span> <span class="n">monoid_algebra</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">k</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">k</span><span class="o">]</span> <span class="o">{</span><span class="n">G</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">group</span> <span class="n">G</span><span class="o">]</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">V</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">V</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">V</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">W</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">W</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">W</span><span class="o">]</span>

<span class="bp">#</span><span class="kn">check</span> <span class="o">(</span><span class="k">by</span> <span class="n">apply_instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">k</span> <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">W</span><span class="o">))</span>
<span class="bp">#</span><span class="kn">check</span> <span class="bp">@</span><span class="n">linear_map</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span> <span class="n">u</span> <span class="n">u</span><span class="o">}</span> <span class="n">k</span> <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">W</span><span class="o">)</span> <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">V</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span>
<span class="c">/-</span><span class="cm"> restrict_scalars k (monoid_algebra k G) W →ₗ[k] restrict_scalars k (monoid_algebra k G) V :</span>
<span class="cm">  Π [_inst_4 : semimodule k (restrict_scalars k (monoid_algebra k G) W)]</span>
<span class="cm">  [_inst_5 : semimodule k (restrict_scalars k (monoid_algebra k G) V)], Type u</span>
</code></pre></div>



<a name="200228187"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200228187" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200228187">(Jun 09 2020 at 13:39)</a>:</h4>
<p>Hi everyone, it's Kenny "Slow Elaboration" Lau again</p>



<a name="200228237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200228237" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200228237">(Jun 09 2020 at 13:39)</a>:</h4>
<p>the elaboration speed is ok here</p>



<a name="200228305"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200228305" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200228305">(Jun 09 2020 at 13:40)</a>:</h4>
<p>until one puts two more underscores at the end to tell Lean to find the remaining instances</p>



<a name="200228333"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200228333" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200228333">(Jun 09 2020 at 13:40)</a>:</h4>
<p>note how the first check tells you that Lean can find the instance in "normal" speed</p>



<a name="200228377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200228377" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200228377">(Jun 09 2020 at 13:40)</a>:</h4>
<p>but for some reason Lean is slow if I put the underscore at the end</p>



<a name="200228462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200228462" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200228462">(Jun 09 2020 at 13:41)</a>:</h4>
<p>so I cannot seem to isolate the problem</p>



<a name="200234595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200234595" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200234595">(Jun 09 2020 at 14:19)</a>:</h4>
<p>both <code>#check</code>s are near instant for me</p>



<a name="200234735"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200234735" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200234735">(Jun 09 2020 at 14:20)</a>:</h4>
<p>that's on a slightly older version of mathlib though, maybe something changed recently</p>



<a name="200235521"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200235521" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200235521">(Jun 09 2020 at 14:25)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> even when you add two underscores at the end?</p>



<a name="200235668"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200235668" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200235668">(Jun 09 2020 at 14:26)</a>:</h4>
<p>oh I misunderstood</p>



<a name="200236204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200236204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200236204">(Jun 09 2020 at 14:29)</a>:</h4>
<p>Okay I can replicate.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- fast</span>
<span class="bp">#</span><span class="kn">check</span> <span class="bp">@</span><span class="n">linear_map</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span> <span class="n">u</span> <span class="n">u</span><span class="o">}</span> <span class="n">k</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">W</span><span class="o">)</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">V</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span>
  <span class="o">(</span><span class="k">by</span> <span class="n">apply_instance</span><span class="o">)</span> <span class="o">(</span><span class="k">by</span> <span class="n">apply_instance</span><span class="o">)</span>

<span class="c1">-- slow</span>
<span class="bp">#</span><span class="kn">check</span> <span class="bp">@</span><span class="n">linear_map</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span> <span class="n">u</span> <span class="n">u</span><span class="o">}</span> <span class="n">k</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">W</span><span class="o">)</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">V</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span>
  <span class="bp">_</span> <span class="bp">_</span>
</code></pre></div>



<a name="200236340"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200236340" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200236340">(Jun 09 2020 at 14:30)</a>:</h4>
<p>that's just fascinating</p>



<a name="200236345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200236345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200236345">(Jun 09 2020 at 14:30)</a>:</h4>
<p>what's happening?</p>



<a name="200236653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200236653" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200236653">(Jun 09 2020 at 14:32)</a>:</h4>
<p>This looks like it will require a C++ deep dive. I don't know what could make this happen besides elaboration order shenanigans as a result of using <code>by</code></p>



<a name="200236808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200236808" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200236808">(Jun 09 2020 at 14:33)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- fast</span>
<span class="bp">#</span><span class="kn">check</span> <span class="bp">@</span><span class="n">linear_map</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span> <span class="n">u</span> <span class="n">u</span><span class="o">}</span> <span class="n">k</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">W</span><span class="o">)</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">V</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span>
  <span class="o">(</span><span class="k">by</span> <span class="n">apply_instance</span><span class="o">)</span>

<span class="c1">-- slow</span>
<span class="bp">#</span><span class="kn">check</span> <span class="bp">@</span><span class="n">linear_map</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span> <span class="n">u</span> <span class="n">u</span><span class="o">}</span> <span class="n">k</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">W</span><span class="o">)</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">V</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span>
  <span class="n">infer_instance</span>
</code></pre></div>



<a name="200237342"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200237342" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200237342">(Jun 09 2020 at 14:36)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- fast</span>
<span class="kn">example</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">linear_map</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span> <span class="n">u</span> <span class="n">u</span><span class="o">}</span> <span class="n">k</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">W</span><span class="o">)</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">V</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span>

<span class="c1">-- slow</span>
<span class="bp">#</span><span class="kn">check</span> <span class="bp">@</span><span class="n">linear_map</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span> <span class="n">u</span> <span class="n">u</span><span class="o">}</span> <span class="n">k</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">W</span><span class="o">)</span>
  <span class="o">(</span><span class="n">restrict_scalars</span> <span class="n">k</span> <span class="o">(</span><span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="n">V</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span>
</code></pre></div>



<a name="200237442"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200237442" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200237442">(Jun 09 2020 at 14:37)</a>:</h4>
<p>what :o</p>



<a name="200237601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200237601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200237601">(Jun 09 2020 at 14:38)</a>:</h4>
<p>interesting</p>



<a name="200238295"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200238295" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200238295">(Jun 09 2020 at 14:42)</a>:</h4>
<p>what if you make the <code>example</code> a <code>def</code>, and <code>#check</code> it?</p>



<a name="200252178"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200252178" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200252178">(Jun 09 2020 at 16:05)</a>:</h4>
<p>changing the example to a def makes it slow, in Mario's example. Kenny's last example freaks me out a bit more</p>



<a name="200266839"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/200266839" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#200266839">(Jun 09 2020 at 17:55)</a>:</h4>
<p>kenny's version makes sense to me only in the sense that it's testing the same thing as my example before that. There is something about switching to tactic mode here using <code>by</code> that makes it work out</p>



<a name="201938346"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/201938346" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#201938346">(Jun 25 2020 at 07:14)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">char_p</span> <span class="n">data</span><span class="bp">.</span><span class="n">polynomial</span>

<span class="kn">universe</span> <span class="n">u</span>

<span class="kn">namespace</span> <span class="n">polynomial</span>

<span class="kn">theorem</span> <span class="n">C_nat_cast</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_semiring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">C</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="bp">=</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">ring_hom</span><span class="bp">.</span><span class="n">map_nat_cast</span> <span class="n">C</span><span class="bp">.</span><span class="n">to_ring_hom</span> <span class="n">n</span>

<span class="kn">instance</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_semiring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">[</span><span class="n">h</span> <span class="o">:</span> <span class="n">char_p</span> <span class="n">R</span> <span class="n">p</span><span class="o">]</span> <span class="o">:</span> <span class="n">char_p</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="n">p</span> <span class="o">:=</span>
<span class="k">let</span> <span class="bp">⟨</span><span class="n">h</span><span class="bp">⟩</span> <span class="o">:=</span> <span class="n">h</span> <span class="k">in</span> <span class="bp">⟨λ</span> <span class="n">n</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="err">←</span> <span class="n">C_nat_cast</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_0</span><span class="o">,</span> <span class="n">C_inj</span><span class="o">,</span> <span class="n">h</span><span class="o">]</span><span class="bp">⟩</span>

<span class="c1">-- fast</span>
<span class="kn">theorem</span> <span class="n">frobenius_eq</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">[</span><span class="n">fact</span> <span class="n">p</span><span class="bp">.</span><span class="n">prime</span><span class="o">]</span> <span class="o">[</span><span class="n">char_p</span> <span class="n">R</span> <span class="n">p</span><span class="o">]</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">frobenius</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="bp">_</span> <span class="n">p</span> <span class="bp">_</span> <span class="o">(</span><span class="n">polynomial</span><span class="bp">.</span><span class="n">char_p</span> <span class="n">p</span><span class="o">)</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">f</span><span class="bp">.</span><span class="n">eval₂</span> <span class="n">C</span> <span class="o">(</span><span class="n">X</span> <span class="bp">^</span> <span class="n">p</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">sorry</span>

<span class="c1">-- slow</span>
<span class="kn">theorem</span> <span class="n">frobenius_eq</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">[</span><span class="n">fact</span> <span class="n">p</span><span class="bp">.</span><span class="n">prime</span><span class="o">]</span> <span class="o">[</span><span class="n">char_p</span> <span class="n">R</span> <span class="n">p</span><span class="o">]</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">frobenius</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="bp">_</span> <span class="n">p</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">f</span><span class="bp">.</span><span class="n">eval₂</span> <span class="n">C</span> <span class="o">(</span><span class="n">X</span> <span class="bp">^</span> <span class="n">p</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">sorry</span>

<span class="c1">-- fast</span>
<span class="kn">theorem</span> <span class="n">frobenius_eq&#39;&#39;</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">[</span><span class="n">fact</span> <span class="n">p</span><span class="bp">.</span><span class="n">prime</span><span class="o">]</span> <span class="o">[</span><span class="n">char_p</span> <span class="n">R</span> <span class="n">p</span><span class="o">]</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
  <span class="k">by</span> <span class="n">exact</span> <span class="bp">@</span><span class="n">frobenius</span> <span class="o">(</span><span class="n">polynomial</span> <span class="n">R</span><span class="o">)</span> <span class="bp">_</span> <span class="n">p</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">f</span><span class="bp">.</span><span class="n">eval₂</span> <span class="n">C</span> <span class="o">(</span><span class="n">X</span> <span class="bp">^</span> <span class="n">p</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">sorry</span>

<span class="kn">end</span> <span class="n">polynomial</span>
</code></pre></div>



<a name="201938348"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/201938348" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#201938348">(Jun 25 2020 at 07:14)</a>:</h4>
<p>is this the same bug?</p>



<a name="201938354"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/201938354" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#201938354">(Jun 25 2020 at 07:14)</a>:</h4>
<p>(btw the theorem is false)</p>



<a name="201938456"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/201938456" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#201938456">(Jun 25 2020 at 07:16)</a>:</h4>
<p>(edit: I guess I found the workaround)</p>



<a name="201938506"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/201938506" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#201938506">(Jun 25 2020 at 07:17)</a>:</h4>
<p>What's going on with <code>C_nat_cast</code>? Shouldn't there be <code>alg_hom.nat_cast</code> instead?</p>



<a name="201938607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/slow%20elaboration/near/201938607" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/slow.20elaboration.html#201938607">(Jun 25 2020 at 07:19)</a>:</h4>
<p>right</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>