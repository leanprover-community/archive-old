---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/get-mathlib-at-commit.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html">get-mathlib-at-commit</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="208729247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/208729247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#208729247">(Sep 01 2020 at 18:39)</a>:</h4>
<p>We've had a lot of messages recently about people wanting to point their mathlib dep at a certain branch or commit. The directions have sometimes been: descend into the mathlib dep repo, git checkout the commit, make sure the toml points to that commit, leanproject get-m, possibly other steps. Should there be a <code>leanproject get-m-at ...</code> that can take a branch name, PR #, or commit hash? It would also fetch the built oleans. I'm starting to take a look at the git python library to see how leanproject currently does HEAD fetching.</p>



<a name="208733252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/208733252" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#208733252">(Sep 01 2020 at 19:07)</a>:</h4>
<p>I have a related request: in the <code>mathlib</code> directory, I often want to do <code>leanproject get-cache</code> at a certain commit. My current workflow is the following, but I would also like something like <code>leanproject get-cache origin/foo</code> or something. (This typically happens when I have a few commits on top of a branch <code>origin/foo</code>.)</p>
<div class="codehilite"><pre><span></span><code><span class="n">git</span> <span class="n">checkout</span> <span class="n">origin</span><span class="bp">/</span><span class="n">foo</span>
<span class="n">leanproject</span> <span class="n">get</span><span class="bp">-</span><span class="n">cache</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="bp">&lt;</span><span class="n">previous</span><span class="bp">-</span><span class="n">branch</span><span class="bp">&gt;</span>
</code></pre></div>



<a name="208734170"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/208734170" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#208734170">(Sep 01 2020 at 19:14)</a>:</h4>
<p>It would be great if <code>get-cache</code> could default to <code>HEAD</code> and try any of the last 10 commits.</p>



<a name="208736941"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/208736941" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#208736941">(Sep 01 2020 at 19:37)</a>:</h4>
<p>Please open issues (or PRs!). I'll try to find some leanproject time soonish.</p>



<a name="208737975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/208737975" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#208737975">(Sep 01 2020 at 19:46)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib-tools/issues/77">https://github.com/leanprover-community/mathlib-tools/issues/77</a></p>



<a name="208738097"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/208738097" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#208738097">(Sep 01 2020 at 19:47)</a>:</h4>
<p>I've been trying to understand how <code>get-mathlib-cache</code> works currently, there's some implicit reliance on <code>HEAD</code> that I've been trying to understand how to modify. No PR yet, unfortunately.</p>



<a name="212921707"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212921707" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212921707">(Oct 10 2020 at 15:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/208734170">said</a>:</p>
<blockquote>
<p>It would be great if <code>get-cache</code> could default to <code>HEAD</code> and try any of the last 10 commits.</p>
</blockquote>
<p>I've found some time to work on <code>leanproject</code> today. Earlier I cleanup a bit the list of open PRs and issues, and now I'm turning to feature requests. I'd like to work on that one, but I find it too poorly specified. What do you want if the current commit has several parents?</p>



<a name="212921898"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212921898" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212921898">(Oct 10 2020 at 15:56)</a>:</h4>
<p>Note that this feature request is also dangerous if files are deleted. If leanproject is asked for cache and don't find it, then checks out an old commit, get oleans and checks out the head commit again then you'll get zombie oleans for any files that was deleted in the mean time. We could probably call <code>delete-zombies</code> as an intermediate step.</p>



<a name="212921927"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212921927" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212921927">(Oct 10 2020 at 15:57)</a>:</h4>
<p>In fact I would probably need more explanations about the kind of workflow that triggers this need. I'm doing blind thinking here because I never see this need (neither when working on mathlib nor when working on the sphere eversion project that depends on mathlib).</p>



<a name="212921970"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212921970" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212921970">(Oct 10 2020 at 15:58)</a>:</h4>
<blockquote>
<p>What do you want if the current commit has several parents?</p>
</blockquote>
<p>You could stop with an error, listing the possibilities (then the user has to specify the hash when calling <code>leanproject</code> again). Or you could even prompt the user to choose from the list of options.</p>



<a name="212922057"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922057" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922057">(Oct 10 2020 at 16:00)</a>:</h4>
<blockquote>
<p>In fact I would probably need more explanations about the kind of workflow that triggers this need.</p>
</blockquote>
<p>I'm less sure about trying previous commits by default, but for getting the cache at a specific commit, see e.g. <a href="#narrow/stream/113488-general/topic/Refresh.20mathlib.20in.20local.20branch/near/212683837">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Refresh.20mathlib.20in.20local.20branch/near/212683837</a></p>



<a name="212922141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922141" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922141">(Oct 10 2020 at 16:03)</a>:</h4>
<p>Being forced to choose between the multiple parents sounds like the right choice to me.</p>



<a name="212922220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922220">(Oct 10 2020 at 16:05)</a>:</h4>
<p>Do I understand correctly that all those scenarios involve working on mathlib itself?</p>



<a name="212922320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922320" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922320">(Oct 10 2020 at 16:08)</a>:</h4>
<p>Yes, at least in my experience.</p>



<a name="212922535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922535">(Oct 10 2020 at 16:12)</a>:</h4>
<p>There are infinitely many ways to mess up with git, and we cannot turn <code>leanproject</code> into a full git frontend (and this would probably make things more complicated). But I think we could add the following two commands:</p>



<a name="212922554"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922554" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922554">(Oct 10 2020 at 16:13)</a>:</h4>
<p>For people who want to start on some new contribution, <code>leanproject pr my_branch</code> would do:</p>
<ul>
<li>check repo is clean</li>
<li>git checkout master                     </li>
<li>git pull</li>
<li>leanproject get-cache   </li>
<li>git checkout -b my_branch</li>
</ul>



<a name="212922634"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922634" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922634">(Oct 10 2020 at 16:15)</a>:</h4>
<p>For people who started work on some contribution on branch <code>my_branch</code> (or got it from <code>leanproject get</code>) but want to incorporate changes from master, <code>leanproject rebase</code> would do:</p>
<ul>
<li>get name of current branch my_branch, check it's not master</li>
<li>check repo is clean                                 </li>
<li>git checkout master                                 </li>
<li>git pull                                            </li>
<li>leanproject get-cache                               </li>
<li>git checkout my_branch   </li>
<li>git rebase master</li>
</ul>
<p>Note how <code>git rebase</code> is the last command so hopefully any <code>git</code> mess can be sorted out without <code>leanproject</code>-added difficulty.</p>



<a name="212922639"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922639" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922639">(Oct 10 2020 at 16:15)</a>:</h4>
<p>How does that sound?</p>



<a name="212922806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922806" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922806">(Oct 10 2020 at 16:19)</a>:</h4>
<p>And for more fine-tuned dangerous stunts, I can add an optional argument to <code>leanproject get-mathlib-cache</code> and <code>leanproject get-cache</code> that is a git sha, try to unpack the corresponding archive and run <code>delete-zombie</code>.</p>



<a name="212922896"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922896" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922896">(Oct 10 2020 at 16:20)</a>:</h4>
<p>Are multiple local caches supported at the moment? Or is only the most recent kept locally?</p>



<a name="212922978"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212922978" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212922978">(Oct 10 2020 at 16:22)</a>:</h4>
<p>Yes, they're all saved in <code>.mathlib/</code>. (Which reminds me, I should probably clean it up on my computer.)</p>



<a name="212923057"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212923057" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212923057">(Oct 10 2020 at 16:24)</a>:</h4>
<p>If so, then the behavior that makes the most sense for me for <code>get-cache</code> is:</p>
<p><code>get-cache &lt;commitish=HEAD&gt;</code>: find and download all caches that are the first in each line of ancestors from the current commit. If this is exactly one cache, activate it. If not, print out all the downloaded sha1s and ask the user to run the command again.</p>



<a name="212923086"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212923086" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212923086">(Oct 10 2020 at 16:25)</a>:</h4>
<p>We could also check at each <code>get-cache</code> how many files there are in the cache and propose to delete the oldest when there are more that 50 or something. But we would need to find a way not to keep asking if people want to keep their cache.</p>



<a name="212933824"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212933824" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212933824">(Oct 10 2020 at 20:45)</a>:</h4>
<p>I pushed these three new features, but there are not well tested at all. It would be nice if people who asked for this could test before release (it means you need to clone the repository and <code>pip install</code> from there). <span class="user-mention" data-user-id="310045">@Eric Wieser</span>  <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> <span class="user-mention" data-user-id="111080">@Floris van Doorn</span> <span class="user-mention" data-user-id="308899">@Yakov Pechersky</span></p>



<a name="212933880"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212933880" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212933880">(Oct 10 2020 at 20:46)</a>:</h4>
<p>See <code>leanproject pr --help</code>, <code>leanproject rebase --help</code> and <code>leanproject get-cache --help</code>.</p>



<a name="212933939"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212933939" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212933939">(Oct 10 2020 at 20:48)</a>:</h4>
<p>And let me repeat that using the <code>--rev</code> option of <code>get-cache</code> (and <code>get-mathlib-cache</code>) is at your own risk. I very much prefer workflows (as in <code>pr</code> and <code>rebase</code>) rather than hacking around randomly.</p>



<a name="212933949"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212933949" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212933949">(Oct 10 2020 at 20:48)</a>:</h4>
<p>Thanks for the <code>--rev</code> command, I'll certainly be using that</p>



<a name="212933960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212933960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212933960">(Oct 10 2020 at 20:49)</a>:</h4>
<p>I'm still interested in reading the <em>workflow</em> that makes you need that option.</p>



<a name="212934034"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212934034" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212934034">(Oct 10 2020 at 20:50)</a>:</h4>
<p>My workflow is typically jumping between different branches, and wanting to get a cache copy of mathlib from either: a) the head or head~n commit of that branch, or b) the last copy of origin/master I merged into that branch</p>



<a name="212934043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212934043" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212934043">(Oct 10 2020 at 20:51)</a>:</h4>
<p>Where the choice between a) and b) depends how deep within mathlib my change is</p>



<a name="212934090"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212934090" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212934090">(Oct 10 2020 at 20:52)</a>:</h4>
<p>When do you want to do that and <code>leanproject pr</code> or <code>leanproject rebase</code> wouldn't suffice?</p>



<a name="212934270"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212934270" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212934270">(Oct 10 2020 at 20:58)</a>:</h4>
<p>I don't really like to let other scripts touch my working tree through git, and prefer to be in control of that myself - it makes it easier for me to recover from things like forgetting to switch branch before editing</p>



<a name="212934353"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212934353" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212934353">(Oct 10 2020 at 21:01)</a>:</h4>
<p><code>leanproject</code> is already doing that anyway. But your answer is enough for me, it means you want something hackish/low level, and hopefully you now have it.</p>



<a name="212934423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212934423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212934423">(Oct 10 2020 at 21:02)</a>:</h4>
<p>In what sense is it doing it already? I suppose I've only run <code>get-cache</code> and <code>delete-zombies</code> in the last few weeks...</p>



<a name="212934502"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212934502" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212934502">(Oct 10 2020 at 21:04)</a>:</h4>
<p><code>get-cache</code> is overwriting your lean files.</p>



<a name="212935360"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212935360" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212935360">(Oct 10 2020 at 21:29)</a>:</h4>
<p>It is? I thought it only overwrote olean files. (I'm using it mainly in mathlib)</p>



<a name="212935412"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212935412" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212935412">(Oct 10 2020 at 21:30)</a>:</h4>
<p>I think caches did contain <code>.lean</code> files until a few months ago (<a href="https://github.com/leanprover-community/mathlib/issues/3616">#3616</a>), but caches generated since then don't.</p>



<a name="212935560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212935560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212935560">(Oct 10 2020 at 21:34)</a>:</h4>
<p>I remember <span class="user-mention" data-user-id="110596">@Rob Lewis</span>  talking about possibly changing <code>leanproject</code> to only extract <code>.olean</code> files from the archive, and that seemed like a good idea to me.</p>



<a name="212935729"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212935729" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212935729">(Oct 10 2020 at 21:39)</a>:</h4>
<p>This is independent, <code>get-mathlib-cache</code> still does <code>git reset --hard</code> in the <code>_target</code> folder.</p>



<a name="212951569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212951569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212951569">(Oct 11 2020 at 06:29)</a>:</h4>
<p>The target folder is git-ignored though, so morally doesn't feel like part of the working tree</p>



<a name="212965740"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212965740" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212965740">(Oct 11 2020 at 13:32)</a>:</h4>
<p>I can confirm that <code>--rev</code> worked for me - thanks for adding that!</p>
<p>It would be great if it could resolve commitish objects for me; so I could write</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>leanproject get-cache --rev eric-wieser/monoid_algebra-reorder
</code></pre></div>

<p>instead of</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>leanproject get-cache --rev <span class="k">$(</span>git rev-parse eric-wieser/monoid_algebra-reorder<span class="k">)</span>
</code></pre></div>



<a name="212967857"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212967857" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212967857">(Oct 11 2020 at 14:39)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> can you try with current master?</p>



<a name="212968623"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212968623" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212968623">(Oct 11 2020 at 15:03)</a>:</h4>
<p>Patch looks good to me, thanks! Will try it later or tomorrow.</p>



<a name="212987032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212987032" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#212987032">(Oct 11 2020 at 23:41)</a>:</h4>
<p>I will try out these new features tomorrow. They are indeed exactly what I need for my workflow (which is indeed when working on mathlib itself), and they look great! My use cases will be:</p>
<ul>
<li><code>leanproject pr</code> to make a new branch</li>
<li><code>leanproject rebase</code> to update my branch to the newest mathlib, while getting the best available olean files.</li>
<li><code>leanproject get-cache --rev HEAD~n</code> or <code>leanproject get-cache --rev origin/master</code>: I'm a couple commits ahead in my branch than <code>origin</code> and I need to get the best available olean files (either because I switched between branches or I messed something up). This will also be quicker than <code>leanproject rebase</code> because it usually doesn't require downloading new files.</li>
</ul>



<a name="213010027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213010027" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213010027">(Oct 12 2020 at 08:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212921707">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/208734170">said</a>:</p>
<blockquote>
<p>It would be great if <code>get-cache</code> could default to <code>HEAD</code> and try any of the last 10 commits.</p>
</blockquote>
<p>[..] I find it too poorly specified. What do you want if the current commit has several parents?</p>
</blockquote>
<p>It should ask both of the parents (and grandparents, etc.) for oleans.  My usecase is that I clone a PR branch from github where the author has just merged master, and I'd like leanproject to find a "close" commit with oleans.  It doesn't matter if it's the previous commit on the branch, or on master.  In this case, really anything is better than nothing.</p>



<a name="213010123"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213010123" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213010123">(Oct 12 2020 at 08:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/212921898">said</a>:</p>
<blockquote>
<p>Note that this feature request is also dangerous if files are deleted. If leanproject is asked for cache and don't find it, then checks out an old commit, get oleans and checks out the head commit again then you'll get zombie oleans for any files that was deleted in the mean time.</p>
</blockquote>
<p>Indeed, this seems really dangerous.  I would have expected that leanproject just unpacks the olean tarball <em>without</em> checking out different commits.</p>



<a name="213010869"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213010869" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213010869">(Oct 12 2020 at 08:33)</a>:</h4>
<p>My understanding was that with the <code>--rev</code> argument, <code>leanproject</code> does no "checking out" at all</p>



<a name="213010904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213010904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213010904">(Oct 12 2020 at 08:33)</a>:</h4>
<p>Maybe to illustrate my workflow issue, I just wanted to check out Eric's branch:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>$ leanproject get mathlib:eric-wieser/monoid_algebra-tweaks
... Failed to download ...
$ cd mathlib_eric-wieser/monoid_algebra-tweaks/
$ leanproject get-mathlib-cache --rev=HEAD^
... Found mathlib oleans ...
</code></pre></div>

<p>Ideally, <code>leanproject get</code> would have tried a few commits so that I don't have to guess <code>HEAD^</code>.  But <code>--rev</code> is already a big improvement.</p>



<a name="213010990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213010990" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213010990">(Oct 12 2020 at 08:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213010869">said</a>:</p>
<blockquote>
<p>My understanding was that with the <code>--rev</code> argument, <code>leanproject</code> does no "checking out" at all</p>
</blockquote>
<p>The current implementation seems to be more sensible than the description I responded to, yes.</p>



<a name="213011635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213011635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213011635">(Oct 12 2020 at 08:42)</a>:</h4>
<p>I think the algorithm for finding caches ought to be something like:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="k">def</span> <span class="nf">find_parents</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="c1"># breadth first search to find parents</span>
    <span class="n">found</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">}</span>
    <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
        <span class="n">new_queue</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">visited</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">commit</span> <span class="ow">in</span> <span class="n">queue</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">found</span><span class="p">[</span><span class="n">commit</span><span class="p">]</span> <span class="o">=</span> <span class="n">download</span><span class="p">(</span><span class="n">commit</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
                <span class="n">new_queue</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span> <span class="o">-</span> <span class="n">visited</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">new_queue</span>

    <span class="c1"># Prune ancestors - if a build is found for C and A, then we always prefer C</span>
    <span class="c1">#</span>
    <span class="c1"># A -- B -- D -- E</span>
    <span class="c1">#  \       /</span>
    <span class="c1">#   C------</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">commit</span><span class="p">:</span> <span class="n">cache</span>
        <span class="k">for</span> <span class="n">commit</span><span class="p">,</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">found</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span> <span class="p">(</span><span class="n">commit</span><span class="o">.</span><span class="n">is_ancestor_of</span><span class="p">(</span><span class="n">commit_2</span><span class="p">)</span> <span class="k">for</span> <span class="n">commit_2</span> <span class="ow">in</span> <span class="n">found</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div>



<a name="213014652"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213014652" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213014652">(Oct 12 2020 at 09:16)</a>:</h4>
<p>There's also the super-simple version in <code>fetch_olean_cache.sh</code> used for CI.  It runs <code>git log -20</code> (last 20 commits) and picks the first commit which has oleans.</p>



<a name="213078624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213078624" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213078624">(Oct 12 2020 at 19:40)</a>:</h4>
<p>On Windows. What am I doing wrong?</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>Floris@MSI MINGW64 /d/projects/mathlib-tools (master)
$ python3 -m pip uninstall mathlibtools
Found existing installation: mathlibtools 0.0.5
Uninstalling mathlibtools-0.0.5:
  Would remove:
    c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\mathlibtools-0.0.5.dist-info\*
    c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\mathlibtools\*
    c:\users\floris\appdata\local\programs\python\python37-32\scripts\leanproject.exe
Proceed (y/n)? y
  Successfully uninstalled mathlibtools-0.0.5

Floris@MSI MINGW64 /d/projects/mathlib-tools (master)
$ python3 -m pip install mathlibtools
Collecting mathlibtools
  Downloading mathlibtools-0.0.10-py3-none-any.whl (21 kB)
Requirement already satisfied: certifi in c:\users\floris\appdata\roaming\python\python37\site-packages (from mathlibtools) (2019.6.16)
Requirement already satisfied: PyGithub in c:\users\floris\appdata\roaming\python\python37\site-packages (from mathlibtools) (1.43.7)
Requirement already satisfied: toml&gt;=0.10.0 in c:\users\floris\appdata\roaming\python\python37\site-packages (from mathlibtools) (0.10.0)
Requirement already satisfied: PyYAML&gt;=3.13 in c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages (from mathlibtools) (5.1.2)
Requirement already satisfied: pydot in c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages (from mathlibtools) (1.4.1)
Requirement already satisfied: requests in c:\users\floris\appdata\roaming\python\python37\site-packages (from mathlibtools) (2.22.0)
Requirement already satisfied: gitpython&gt;=2.1.11 in c:\users\floris\appdata\roaming\python\python37\site-packages (from mathlibtools) (2.1.11)
Requirement already satisfied: Click in c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages (from mathlibtools) (7.1.1)
Requirement already satisfied: networkx in c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages (from mathlibtools) (2.3)
Requirement already satisfied: tqdm in c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages (from mathlibtools) (4.45.0)
Requirement already satisfied: deprecated in c:\users\floris\appdata\roaming\python\python37\site-packages (from PyGithub-&gt;mathlibtools) (1.2.5)
Requirement already satisfied: pyjwt in c:\users\floris\appdata\roaming\python\python37\site-packages (from PyGithub-&gt;mathlibtools) (1.7.1)
Requirement already satisfied: pyparsing&gt;=2.1.4 in c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages (from pydot-&gt;mathlibtools) (2.4.7)
Requirement already satisfied: idna&lt;2.9,&gt;=2.5 in c:\users\floris\appdata\roaming\python\python37\site-packages (from requests-&gt;mathlibtools) (2.8)
Requirement already satisfied: chardet&lt;3.1.0,&gt;=3.0.2 in c:\users\floris\appdata\roaming\python\python37\site-packages (from requests-&gt;mathlibtools) (3.0.4)
Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,&lt;1.26,&gt;=1.21.1 in c:\users\floris\appdata\roaming\python\python37\site-packages (from requests-&gt;mathlibtools) (1.25.3)
Requirement already satisfied: gitdb2&gt;=2.0.0 in c:\users\floris\appdata\roaming\python\python37\site-packages (from gitpython&gt;=2.1.11-&gt;mathlibtools) (2.0.5)
Requirement already satisfied: decorator&gt;=4.3.0 in c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages (from networkx-&gt;mathlibtools) (4.4.0)
Requirement already satisfied: wrapt&lt;2,&gt;=1 in c:\users\floris\appdata\roaming\python\python37\site-packages (from deprecated-&gt;PyGithub-&gt;mathlibtools) (1.11.2)
Requirement already satisfied: smmap2&gt;=2.0.0 in c:\users\floris\appdata\roaming\python\python37\site-packages (from gitdb2&gt;=2.0.0-&gt;gitpython&gt;=2.1.11-&gt;mathlibtools) (2.0.5)
Installing collected packages: mathlibtools
Successfully installed mathlibtools-0.0.10

Floris@MSI MINGW64 /d/projects/mathlib-tools (master)
$ leanproject --version
leanproject, version 0.0.10

Floris@MSI MINGW64 /d/projects/mathlib-tools (master)
$ leanproject get-cache -h
Usage: leanproject get-cache [OPTIONS]

  Restore cached olean files.

Options:
  --force     Get cache even if the repository is dirty.
  -h, --help  Show this message and exit.

Floris@MSI MINGW64 /d/projects/mathlib-tools (master)
$ leanproject rebase -h
Usage: leanproject [OPTIONS] COMMAND [ARGS]...
Try 'leanproject -h' for help.

Error: No such command 'rebase'.

Floris@MSI MINGW64 /d/projects/mathlib-tools (master)
$ leanproject pr --help
Usage: leanproject [OPTIONS] COMMAND [ARGS]...
Try 'leanproject -h' for help.

Error: No such command 'pr'.

Floris@MSI MINGW64 /d/projects/mathlib-tools (master)
$ leanproject -h
Usage: leanproject [OPTIONS] COMMAND [ARGS]...

  Command line client to manage Lean projects depending on mathlib. Use
  leanproject COMMAND --help to get more help on any specific command.

Options:
  -u, --from-url TEXT   Override base url for olean cache.
  -f, --force-download  Download olean cache without looking for a local
                        version.

  --no-lean-upgrade     Do not upgrade Lean version when upgrading mathlib.
  --debug               Display python tracebacks in case of error.
  --version             Show the version and exit.
  -h, --help            Show this message and exit.

Commands:
  add-mathlib        Add mathlib to the current project.
  build              Build the current project.
  check              Check mathlib oleans are more recent than their sources
  clean              Delete all olean files
  decls              List declarations seen from this project If no file...
  delete-zombies     Delete zombie oleans, .olean files with no matching...
  get                Clone a project from a GitHub name or git url.
  get-cache          Restore cached olean files.
  get-mathlib-cache  If mathlib is a dependency, upgrade mathlib lean and...
  global-install     Install mathlib user-wide.
  global-upgrade     Upgrade user-wide mathlib
  hooks              Setup git hooks for the current project.
  import-graph       Write an import graph for this project.
  mk-all             Creates all.lean importing everything from the project.
  mk-cache           Cache olean files.
  new                Create a new Lean project and prepare mathlib.
  set-url            Set the default url where oleans should be fetched.
  upgrade-mathlib    Upgrade mathlib (as a dependency or as the main...

Floris@MSI MINGW64 /d/projects/mathlib-tools (master)
$ leanproject --version
leanproject, version 0.0.10

Floris@MSI MINGW64 /d/projects/mathlib-tools (master)
$ cd ../mathlib
leanproject pr
Floris@MSI MINGW64 /d/projects/mathlib ((665cc13c0...))
$ leanproject pr foo
Usage: leanproject [OPTIONS] COMMAND [ARGS]...
Try 'leanproject -h' for help.

Error: No such command 'pr'.

Floris@MSI MINGW64 /d/projects/mathlib ((665cc13c0...))
$
</code></pre></div>



<a name="213079457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213079457" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213079457">(Oct 12 2020 at 19:51)</a>:</h4>
<p>My impression from the README from <a href="https://github.com/leanprover-community/mathlib-tools">https://github.com/leanprover-community/mathlib-tools</a> was that if I ran </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code> <span class="n">python3</span> <span class="bp">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">mathlibtools</span>
</code></pre></div>

<p>in the directory of <code>/mathlib-tools</code> I magically got the version from my repo. If that is false, how do I actually use the <code>leanproject</code> from the cloned repository?</p>



<a name="213079743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213079743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213079743">(Oct 12 2020 at 19:54)</a>:</h4>
<p>Ok, I fixed the above issue. The incantation is</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Floris</span><span class="bp">@</span><span class="n">MSI</span> <span class="n">MINGW64</span> <span class="bp">/</span><span class="n">d</span><span class="bp">/</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">-</span><span class="n">tools</span> <span class="o">(</span><span class="n">master</span><span class="o">)</span>
<span class="bp">$</span> <span class="n">pip3</span> <span class="n">install</span> <span class="bp">.</span>
</code></pre></div>

<p>That should probably be mentioned in the <code>README</code>.</p>



<a name="213079901"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213079901" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213079901">(Oct 12 2020 at 19:56)</a>:</h4>
<p>Oh, I see now: that is the last sentence of the README.</p>



<a name="213081295"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213081295" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213081295">(Oct 12 2020 at 20:12)</a>:</h4>
<p>Some comments:</p>
<ul>
<li>Both <code>leanproject rebase</code> and <code>leanproject pr</code> work fine in the default case.</li>
<li>They could print trace messages saying what it's doing (<code>Checking out master...</code>). Now they are just silent while they are pulling mathlib. They are also silent when the repo is dirty.</li>
<li>Both of the following give an error</li>
</ul>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>$ leanproject pr foo --debug
$ leanproject pr --debug foo
</code></pre></div>

<ul>
<li>Non-graceful error if branch <code>foo</code> already exists:</li>
</ul>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>Floris@MSI MINGW64 /d/projects/mathlib (foo)
$ leanproject --debug pr foo
Looking for local mathlib oleans
Looking for remote mathlib oleans
Trying to download https://oleanstorage.azureedge.net/mathlib/9379050719fa9f2605289bd85a0fb29100084eb3.tar.xz\xa0to C:\Users\Floris\.mathlib\9379050719fa9f2605289bd85a0fb29100084eb3.tar.xz
100%|##########| 30.1M/30.1M [00:06&lt;00:00, 4.67MiB/s]
Found mathlib oleans at https://oleanstorage.azureedge.net/mathlib/
Traceback (most recent call last):
  File "C:\Users\Floris\AppData\Local\Programs\Python\Python37-32\Scripts\leanproject-script.py", line 11, in &lt;module&gt;
    load_entry_point('mathlibtools==0.0.10', 'console_scripts', 'leanproject')()
  File "c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\mathlibtools\leanproject.py", line 359, in safe_cli
    handle_exception(err, str(err))
  File "c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\mathlibtools\leanproject.py", line 63, in handle_exception
    raise exc
  File "c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\mathlibtools\leanproject.py", line 357, in safe_cli
    cli() # pylint: disable=no-value-for-parameter
  File "c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\click\core.py", line 829, in __call__
    return self.main(*args, **kwargs)
  File "c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\click\core.py", line 782, in main
    rv = self.invoke(ctx)
  File "c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\click\core.py", line 1259, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\click\core.py", line 1066, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\click\core.py", line 610, in invoke
    return callback(*args, **kwargs)
  File "c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\mathlibtools\leanproject.py", line 342, in pr
    proj().pr(branch_name, force)
  File "c:\users\floris\appdata\local\programs\python\python37-32\lib\site-packages\mathlibtools\lib.py", line 759, in pr
    self.repo.git.checkout('-b', branch_name)
  File "C:\Users\Floris\AppData\Roaming\Python\Python37\site-packages\git\cmd.py", line 548, in &lt;lambda&gt;
    return lambda *args, **kwargs: self._call_process(name, *args, **kwargs)
  File "C:\Users\Floris\AppData\Roaming\Python\Python37\site-packages\git\cmd.py", line 1014, in _call_process
    return self.execute(call, **exec_kwargs)
  File "C:\Users\Floris\AppData\Roaming\Python\Python37\site-packages\git\cmd.py", line 825, in execute
    raise GitCommandError(command, status, stderr_value, stdout_value)
git.exc.GitCommandError: Cmd('git') failed due to: exit code(128)
  cmdline: git checkout -b foo
  stderr: 'fatal: A branch named 'foo' already exists.'
</code></pre></div>

<ul>
<li><code>leanproject rebase</code> errors on merge conflicts (the expected behavior is just that it succeeds, since rebasing is the last step anyway).</li>
</ul>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>Floris@MSI MINGW64 /d/projects/mathlib3 (stupid)
$ leanproject rebase
Looking for local mathlib oleans
Found local mathlib oleans
Cmd('git') failed due to: exit code(1)
  cmdline: git rebase master
  stdout: 'First, rewinding head to replay your work on top of it...
Applying: uglify
Using index info to reconstruct a base tree...
M       src/measure_theory/borel_space.lean
Falling back to patching base and 3-way merge...
Auto-merging src/measure_theory/borel_space.lean
CONFLICT (content): Merge conflict in src/measure_theory/borel_space.lean
Patch failed at 0001 uglify
Resolve all conflicts manually, mark them as resolved with
"git add/rm &lt;conflicted_files&gt;", then run "git rebase --continue".
You can instead skip this commit: run "git rebase --skip".
To abort and get back to the state before "git rebase", run "git rebase --abort".'
  stderr: 'error: Failed to merge in the changes.
hint: Use 'git am --show-current-patch' to see the failed patch'
</code></pre></div>



<a name="213081604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/213081604" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#213081604">(Oct 12 2020 at 20:15)</a>:</h4>
<p><code>leanproject get-cache --rev</code> seems to work well.</p>



<a name="215196353"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/215196353" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#215196353">(Oct 31 2020 at 15:23)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> I'm trying to empty my leanproject backlog, but I don't understand you last complain when rebasing with conflicts. What do you expect? The output you pasted is exactly the intended one. You need to see the git error message in order to take appropriate action, right?</p>



<a name="215196404"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/get-mathlib-at-commit/near/215196404" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/get-mathlib-at-commit.html#215196404">(Oct 31 2020 at 15:24)</a>:</h4>
<p>Also I don't think I'm going to "fix" your issue with <code>--debug</code>. This is a global option of <code>leanproject</code>, it goes before typing a command. I don't see how duplicating it as an option to all commands would help.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>