---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html">#eval and #reduce give contradictory results</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="226969950"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226969950" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226969950">(Feb 19 2021 at 14:27)</a>:</h4>
<p>Can this be used to prove false?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#reduce</span> <span class="n">json.object</span> <span class="o">[]</span>  <span class="c1">-- null</span>
<span class="k">#eval</span> <span class="n">json.object</span> <span class="o">[]</span>  <span class="c1">-- json.object list.nil</span>
</code></pre></div>



<a name="226971351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226971351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226971351">(Feb 19 2021 at 14:36)</a>:</h4>
<p>Nevermind, this is just a bug in <code>has_repr</code></p>



<a name="226978322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226978322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226978322">(Feb 19 2021 at 15:25)</a>:</h4>
<p>I don't think <code>#eval</code> can be used to prove anything.</p>



<a name="226983088"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226983088" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226983088">(Feb 19 2021 at 15:55)</a>:</h4>
<p>Wasn't there a lean4 bug where the vm implementation of a nat operation diverged from the non vm-one, and it caused a proof of false?</p>



<a name="226991985"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226991985" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris B <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226991985">(Feb 19 2021 at 16:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results/near/226983088">said</a>:</p>
<blockquote>
<p>Wasn't there a lean4 bug where the vm implementation of a nat operation diverged from the non vm-one, and it caused a proof of false?</p>
</blockquote>
<p><a href="#narrow/stream/270676-lean4/topic/Contradiction.3F/near/224625352">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Contradiction.3F/near/224625352</a></p>
<p>You can (or eventually you'll be able to) opt out of the native nat/bool reduction thing. I'm not sure if the people in the thread figured out the trust-level invocation, but third party checkers presumably would have caught this since they don't implement that feature. It would be neat if big libraries set up their CI so that external checkers take a look once in a while.</p>



<a name="226992621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226992621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Marc Huisinga <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226992621">(Feb 19 2021 at 16:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results/near/226983088">said</a>:</p>
<blockquote>
<p>Wasn't there a lean4 bug where the vm implementation of a nat operation diverged from the non vm-one, and it caused a proof of false?</p>
</blockquote>
<p>Efficient nat reduction of closed terms is part of the kernel in Lean 4, so there was a mismatch between <code>rfl</code>and whatever the Lean definition of <code>mod</code> over <code>Nat</code> is. With this, both GMP and the glue code between Lean and GMP become part of the trusted codebase, and the bug in question occured in the edge case handling in the glue code.</p>



<a name="226993100"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226993100" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226993100">(Feb 19 2021 at 16:55)</a>:</h4>
<p>I guess in lean3 it's not part of the kernel, so couldn't cause a problem?</p>



<a name="226993603"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226993603" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris B <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226993603">(Feb 19 2021 at 16:58)</a>:</h4>
<p>Yeah, those native reduction functions aren't in the lean3 kernel.</p>



<a name="226993760"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226993760" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Marc Huisinga <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226993760">(Feb 19 2021 at 16:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="228466">Chris B</span> <a href="#narrow/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results/near/226991985">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results/near/226983088">said</a>:</p>
<blockquote>
<p>Wasn't there a lean4 bug where the vm implementation of a nat operation diverged from the non vm-one, and it caused a proof of false?</p>
</blockquote>
<p><a href="#narrow/stream/270676-lean4/topic/Contradiction.3F/near/224625352">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Contradiction.3F/near/224625352</a></p>
<p>You can (or eventually you'll be able to) opt out of the native nat/bool reduction thing. I'm not sure if the people in the thread figured out the trust-level invocation, but third party checkers presumably would have caught this since they don't implement that feature. It would be neat if big libraries set up their CI so that external checkers take a look once in a while.</p>
</blockquote>
<p>If the code in question relies on the reduction being fast, won't external checkers just get stuck reducing?</p>



<a name="226994304"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226994304" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Marc Huisinga <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226994304">(Feb 19 2021 at 17:02)</a>:</h4>
<p>(For the record: I think that this feature is very useful for verifying Lean 4 programs, where you already trust the unsafe implementations since that is what you will run your code with :))</p>



<a name="226995483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226995483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris B <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226995483">(Feb 19 2021 at 17:09)</a>:</h4>
<p><span class="user-mention" data-user-id="221921">@Marc Huisinga</span> </p>
<p>The bad proof found in the other thread was <code>1 != 0</code> so that one's safe, but yeah if you're using really large numbers you can choke verifiers using a naive reduction strategy. I haven't looked at the numbers in a while, but IIRC there were some large-ish closed terms in mathlib when I was doing more testing and they work ok.</p>



<a name="226996602"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/226996602" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris B <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#226996602">(Feb 19 2021 at 17:17)</a>:</h4>
<p>IIRC these are numerical proofs, but I don't know what they look like inside. They take a few hundred milliseconds in the rust verifier:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="mi">346</span> <span class="o">:</span> <span class="n">real.pi_lt_3141593</span>
<span class="mi">233</span> <span class="o">:</span> <span class="n">real.pi_gt_3141592</span>
<span class="mi">213</span> <span class="o">:</span> <span class="n">real.pi_lt_31416</span>
</code></pre></div>



<a name="227051614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/227051614" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#227051614">(Feb 20 2021 at 00:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="228466">Chris B</span> <a href="#narrow/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results/near/226991985">said</a>:</p>
<blockquote>
<p>I'm not sure if the people in the thread figured out the trust-level invocation, </p>
</blockquote>
<p>For the record, I'm pretty sure that <code>-t 0</code> is the correct way to set trust level in lean 4 (I checked the source), it was just that the bug was also present at trust 0 in that case because it was in the kernel code</p>



<a name="227052320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/227052320" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#227052320">(Feb 20 2021 at 00:49)</a>:</h4>
<p>BTW here's another <code>#eval</code>/<code>#reduce</code> mismatch that has been unresolved for many years:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">is_max</span> <span class="o">:</span> <span class="n">level</span> <span class="bp">→</span> <span class="n">bool</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">level.max</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="n">tt</span>
<span class="bp">|</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">ff</span>
<span class="k">#reduce</span> <span class="n">is_max</span> <span class="o">(</span><span class="n">level.max</span> <span class="n">level.zero</span> <span class="n">level.zero</span><span class="o">)</span> <span class="c1">-- tt</span>
<span class="k">#eval</span> <span class="n">is_max</span> <span class="o">(</span><span class="n">level.max</span> <span class="n">level.zero</span> <span class="n">level.zero</span><span class="o">)</span> <span class="c1">-- ff</span>
</code></pre></div>



<a name="227052400"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/%23eval%20and%20%23reduce%20give%20contradictory%20results/near/227052400" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/.23eval.20and.20.23reduce.20give.20contradictory.20results.html#227052400">(Feb 20 2021 at 00:50)</a>:</h4>
<p>I think part of the rationale here is that since these are <code>meta inductive</code>s they don't promise correctness, but I think this could be handled better</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>