---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/Type.20class.20trouble.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html">Type class trouble</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="283194582"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283194582" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283194582">(May 21 2022 at 21:43)</a>:</h4>
<p>I am having trouble with the following.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.basic</span>
<span class="kn">import</span> <span class="n">field_theory.finite.basic</span>
<span class="kn">import</span> <span class="n">ring_theory.trace</span>

<span class="kd">def</span> <span class="n">finite_field.trace_to_zmod</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">field</span> <span class="n">F</span><span class="o">]</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">F</span><span class="o">]</span> <span class="o">:</span> <span class="n">F</span> <span class="bp">→ₗ</span><span class="o">[</span><span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">)]</span> <span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">haveI</span> <span class="o">:=</span> <span class="n">ring_char.char_p</span> <span class="n">F</span><span class="o">,</span>
  <span class="n">haveI</span> <span class="o">:=</span> <span class="n">zmod.algebra</span> <span class="n">F</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">),</span>
  <span class="k">let</span> <span class="n">tr</span> <span class="o">:=</span> <span class="n">algebra.trace</span> <span class="o">(</span><span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">))</span> <span class="n">F</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">tr</span><span class="o">,</span> <span class="c1">-- invalid type ascription ...</span>
<span class="kd">end</span>
</code></pre></div>
<p>Before <code>exact tr</code>, the state looks like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">F</span><span class="o">:</span> <span class="kt">Type</span> <span class="bp">?</span>
<span class="n">_inst_1</span><span class="o">:</span> <span class="n">field</span> <span class="n">F</span>
<span class="n">_inst_2</span><span class="o">:</span> <span class="n">fintype</span> <span class="n">F</span>
<span class="n">_inst</span><span class="o">:</span> <span class="n">char_p</span> <span class="n">F</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">)</span>
<span class="n">_inst_3</span><span class="o">:</span> <span class="n">algebra</span> <span class="o">(</span><span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">))</span> <span class="n">F</span>
<span class="n">tr</span><span class="o">:</span> <span class="n">F</span> <span class="bp">→ₗ</span><span class="o">[</span><span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">)]</span> <span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">)</span> <span class="o">:=</span> <span class="n">algebra.trace</span> <span class="o">(</span><span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">))</span> <span class="n">F</span>
<span class="bp">⊢</span> <span class="n">F</span> <span class="bp">→ₗ</span><span class="o">[</span><span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">)]</span> <span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">)</span>
</code></pre></div>
<p>Clicking on the type of <code>tr</code> in the infoview shows exactly the same information as clicking on the type of the goal:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">linear_map</span>
<span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">)</span>
<span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">)</span>
<span class="n">ring.to_semiring</span>
<span class="n">ring.to_semiring</span>
<span class="n">ring_hom.id</span> <span class="o">(</span><span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">))</span>
<span class="n">F</span>
<span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">)</span>
<span class="n">add_comm_group.to_add_comm_monoid</span> <span class="n">F</span>
<span class="n">add_comm_group.to_add_comm_monoid</span> <span class="o">(</span><span class="n">zmod</span> <span class="o">(</span><span class="n">ring_char</span> <span class="n">F</span><span class="o">))</span>
<span class="n">algebra.to_module</span>
<span class="n">semiring.to_module</span>
</code></pre></div>
<p>The mismatching types in the error message differ in the following places:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span> <span class="n">F</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">F</span> <span class="n">_inst_1</span><span class="o">)))))</span>
</code></pre></div>
<p>vs.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">F</span> <span class="n">_inst_1</span><span class="o">))))</span>
</code></pre></div>
<p>and</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="n">F</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">F</span> <span class="n">_inst_1</span><span class="o">))))</span>
       <span class="n">_inst_3</span><span class="o">)</span>
</code></pre></div>
<p>vs.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">F</span> <span class="n">_inst_1</span><span class="o">)))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">zmod.algebra</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">F</span> <span class="n">_inst_1</span><span class="o">))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">ring_char</span> <span class="n">F</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_ring.to_non_assoc_semiring</span> <span class="n">F</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_non_assoc_ring</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">F</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">F</span> <span class="n">_inst_1</span><span class="o">)))))</span>
          <span class="n">_</span><span class="o">))</span>
</code></pre></div>
<p>It looks like part of the problem is that two differing paths are used to get from <code>field</code> to <code>ring</code>. I have no idea how to avoid this...</p>



<a name="283194791"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283194791" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283194791">(May 21 2022 at 21:49)</a>:</h4>
<p>What does<code>convert tr</code> leave as a goal?</p>



<a name="283194858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283194858" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283194858">(May 21 2022 at 21:50)</a>:</h4>
<p>Does changing the second <code>haveI</code> to a <code>letI</code> help?</p>



<a name="283194944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283194944" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283194944">(May 21 2022 at 21:53)</a>:</h4>
<p>I think that's your problem; lean is saying "you told me to forget what <code>_inst_3</code> is, so I can't unfold it any further to check it's equal to the other instance"</p>



<a name="283195112"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283195112" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283195112">(May 21 2022 at 21:57)</a>:</h4>
<p>Thanks! I was forgetting that <code>algebra ...</code> is data.</p>



<a name="283195180"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283195180" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283195180">(May 21 2022 at 21:59)</a>:</h4>
<p>A more helpful error message would go a long way...</p>



<a name="283195430"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283195430" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283195430">(May 21 2022 at 22:05)</a>:</h4>
<p>We could make <code>haveI</code> detect this error</p>



<a name="283195436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283195436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283195436">(May 21 2022 at 22:05)</a>:</h4>
<p>Do you even need the haveI there though?</p>



<a name="283195806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283195806" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283195806">(May 21 2022 at 22:15)</a>:</h4>
<p>Actually, no.</p>



<a name="283195871"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283195871" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283195871">(May 21 2022 at 22:16)</a>:</h4>
<p>What made you think you did?</p>



<a name="283195885"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283195885" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283195885">(May 21 2022 at 22:16)</a>:</h4>
<p>(that is, do we need to improve documentation somewhere?)</p>



<a name="283195951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283195951" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283195951">(May 21 2022 at 22:18)</a>:</h4>
<p>I think I thought I needed <code>[char_p F (ring_char F)]</code> for something. But it is possible that as the proof evolved, that changed.</p>



<a name="283196028"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283196028" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283196028">(May 21 2022 at 22:20)</a>:</h4>
<p><del>Ah right,</del> <a href="https://leanprover-community.github.io/mathlib_docs/find/ring_char.char_p">docs#ring_char.char_p</a> is <del>not</del> an instance</p>



<a name="283196060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283196060" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283196060">(May 21 2022 at 22:21)</a>:</h4>
<p>So you have that automatically with no need for a haveI</p>



<a name="283196195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283196195" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283196195">(May 21 2022 at 22:24)</a>:</h4>
<p>Ah, I hadn't realized that. Good to know...</p>



<a name="283196326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283196326" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283196326">(May 21 2022 at 22:28)</a>:</h4>
<p>Having said that, the strategy of adding letI lines is a good one when lean can't find the instance through a long chain and you can't work out what condition you're missing</p>



<a name="283196389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283196389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283196389">(May 21 2022 at 22:30)</a>:</h4>
<p>For instance, if it can't find addition on a product type, you add <code>letI : has_add (X × Y) := prod.has_add</code> and then your error message will tell you where the left or right half is missing addition</p>



<a name="283232311"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283232311" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283232311">(May 22 2022 at 13:29)</a>:</h4>
<p>Thanks for the tip! I'll try to remember it.</p>



<a name="283236312"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283236312" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283236312">(May 22 2022 at 15:01)</a>:</h4>
<p>Another question: I'm having trouble with something like the following.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.basic</span>
<span class="kn">import</span> <span class="n">field_theory.finite.basic</span>

<span class="kd">structure</span> <span class="n">test</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">A</span><span class="o">]</span> <span class="o">:=</span> <span class="o">(</span><span class="n">A'</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">B</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">A'</span><span class="o">)</span> <span class="o">(</span><span class="n">C</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">→+</span> <span class="n">A'</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">test1</span> <span class="o">:</span> <span class="n">test</span> <span class="n">ℤ</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">A'</span> <span class="o">:=</span> <span class="n">ℤ</span><span class="o">,</span> <span class="n">B</span> <span class="o">:=</span> <span class="n">_</span><span class="o">,</span> <span class="n">C</span> <span class="o">:=</span> <span class="n">add_monoid_hom.id</span> <span class="n">ℤ</span> <span class="o">}</span>

<span class="kd">def</span> <span class="n">test2</span> <span class="o">:</span> <span class="n">test</span> <span class="n">ℤ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">A'</span> <span class="o">:=</span> <span class="n">test1.A'</span><span class="o">,</span> <span class="n">B</span> <span class="o">:=</span> <span class="n">test1.B</span><span class="o">,</span>
  <span class="n">C</span> <span class="o">:=</span> <span class="n">test1.C.comp</span> <span class="o">(</span><span class="n">add_monoid_hom.id</span> <span class="n">_</span><span class="o">)</span> <span class="o">}</span>
<span class="c1">-- failed to synthesize type class instance for</span>
<span class="c1">-- ⊢ add_zero_class test1.A'</span>

<span class="kd">def</span> <span class="n">test3</span> <span class="o">:</span> <span class="n">test</span> <span class="n">ℤ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">A'</span> <span class="o">:=</span> <span class="n">test1.A'</span><span class="o">,</span> <span class="n">B</span> <span class="o">:=</span> <span class="n">test1.B</span><span class="o">,</span>
  <span class="n">C</span> <span class="o">:=</span> <span class="kd">begin</span> <span class="n">haveI</span> <span class="o">:=</span> <span class="n">test1.B</span><span class="o">,</span> <span class="n">exact</span> <span class="n">test1.C.comp</span> <span class="o">(</span><span class="n">add_monoid_hom.id</span> <span class="n">_</span><span class="o">)</span> <span class="kd">end</span> <span class="o">}</span>
<span class="c1">-- synthesized type class instance is not definitionally equal to expression inferred by typing rules, synthesized</span>
<span class="c1">--  add_monoid.to_add_zero_class test1.A'</span>
<span class="c1">-- inferred</span>
<span class="c1">--  add_monoid.to_add_zero_class test1.A'</span>
</code></pre></div>
<p>How do I get the correct instance(s) into the context when filling the fields of the structure?</p>



<a name="283236371"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283236371" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283236371">(May 22 2022 at 15:02)</a>:</h4>
<p>What about</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">test</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">A</span><span class="o">]</span> <span class="o">:=</span> <span class="o">(</span><span class="n">A'</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">B</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">A'</span><span class="o">]</span> <span class="o">(</span><span class="n">C</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">→+</span> <span class="n">A'</span><span class="o">)</span>
</code></pre></div>



<a name="283236492"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283236492" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283236492">(May 22 2022 at 15:05)</a>:</h4>
<p>Still gives the same error for <code>test2</code> (and <code>test3</code>).</p>



<a name="283236544"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283236544" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283236544">(May 22 2022 at 15:06)</a>:</h4>
<p>In fact, <code>test2</code> gives now the additional message</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">synthesized</span> <span class="n">type</span> <span class="kd">class</span> <span class="kd">instance</span> <span class="n">is</span> <span class="n">not</span> <span class="n">definitionally</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">expression</span> <span class="n">inferred</span> <span class="kd">by</span> <span class="n">typing</span> <span class="n">rules</span><span class="o">,</span> <span class="n">synthesized</span>
  <span class="bp">⁇</span>
<span class="n">inferred</span>
  <span class="n">add_monoid.to_add_zero_class</span> <span class="n">test1.A'</span>
</code></pre></div>



<a name="283237550"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283237550" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283237550">(May 22 2022 at 15:31)</a>:</h4>
<p>replacing <code>comm_ring</code> by <code>add_zero_class</code> to exclude possible problems from chaining of instances doesn't help. Instead of <code>add_monoid.to_add_zero_class test1.A'</code>the error messages now refer to <code>test1.B</code>, but they are still there:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.basic</span>
<span class="kn">import</span> <span class="n">data.int.basic</span>

<span class="kd">structure</span> <span class="n">test</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">add_zero_class</span> <span class="n">A</span><span class="o">]</span> <span class="o">:=</span> <span class="o">(</span><span class="n">A'</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">B</span> <span class="o">:</span> <span class="n">add_zero_class</span> <span class="n">A'</span><span class="o">]</span> <span class="o">(</span><span class="n">C</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">→+</span> <span class="n">A'</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">test1</span> <span class="o">:</span> <span class="n">test</span> <span class="n">ℤ</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">A'</span> <span class="o">:=</span> <span class="n">ℤ</span><span class="o">,</span> <span class="n">B</span> <span class="o">:=</span> <span class="n">_</span><span class="o">,</span> <span class="n">C</span> <span class="o">:=</span> <span class="n">add_monoid_hom.id</span> <span class="n">ℤ</span> <span class="o">}</span>

<span class="kd">def</span> <span class="n">test2</span> <span class="o">:</span> <span class="n">test</span> <span class="n">ℤ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">A'</span> <span class="o">:=</span> <span class="n">test1.A'</span><span class="o">,</span> <span class="n">B</span> <span class="o">:=</span> <span class="n">_</span><span class="o">,</span>
  <span class="n">C</span> <span class="o">:=</span> <span class="n">test1.C.comp</span> <span class="o">(</span><span class="n">add_monoid_hom.id</span> <span class="n">_</span><span class="o">)</span> <span class="o">}</span>
<span class="c1">-- failed to synthesize type class instance for</span>
<span class="c1">-- ⊢ add_zero_class test1.A'</span>
<span class="c1">--</span>
<span class="c1">-- synthesized type class instance is not definitionally equal to expression inferred by typing rules, synthesized</span>
<span class="c1">--   ⁇</span>
<span class="c1">-- inferred</span>
<span class="c1">--   test1.B</span>

<span class="kd">def</span> <span class="n">test3</span> <span class="o">:</span> <span class="n">test</span> <span class="n">ℤ</span> <span class="o">:=</span>
<span class="kd">begin</span> <span class="n">haveI</span> <span class="o">:=</span> <span class="n">test1.B</span><span class="o">,</span> <span class="n">exact</span>
<span class="o">{</span> <span class="n">A'</span> <span class="o">:=</span> <span class="n">test1.A'</span><span class="o">,</span> <span class="n">B</span> <span class="o">:=</span> <span class="n">_</span><span class="o">,</span>
  <span class="n">C</span> <span class="o">:=</span> <span class="n">test1.C.comp</span> <span class="o">(</span><span class="n">add_monoid_hom.id</span> <span class="n">_</span><span class="o">)</span> <span class="o">}</span>
<span class="kd">end</span>
<span class="c1">-- synthesized type class instance is not definitionally equal to expression inferred by typing rules, synthesized</span>
<span class="c1">--   _inst</span>
<span class="c1">-- inferred</span>
<span class="c1">--   test1.B</span>
</code></pre></div>



<a name="283237635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283237635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283237635">(May 22 2022 at 15:33)</a>:</h4>
<p>The red squiggly line is below <code>C</code>(in <code>test1.C.comp</code>) in <code>test2</code>, but below <code>test1</code> in <code>test3</code>.</p>



<a name="283238202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283238202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283238202">(May 22 2022 at 15:49)</a>:</h4>
<p>I do not know how to analyze this, but maybe this is useful:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.basic</span>
<span class="kn">import</span> <span class="n">data.int.basic</span>

<span class="c1">--  B is now implicit, rather than typeclass</span>
<span class="kd">structure</span> <span class="n">test</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">add_zero_class</span> <span class="n">A</span><span class="o">]</span> <span class="o">:=</span> <span class="o">(</span><span class="n">A'</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">{</span><span class="n">B</span> <span class="o">:</span> <span class="n">add_zero_class</span> <span class="n">A'</span><span class="o">}</span> <span class="o">(</span><span class="n">C</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">→+</span> <span class="n">A'</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">test1</span> <span class="o">:</span> <span class="n">test</span> <span class="n">ℤ</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">A'</span> <span class="o">:=</span> <span class="n">ℤ</span><span class="o">,</span> <span class="n">B</span> <span class="o">:=</span> <span class="n">_</span><span class="o">,</span> <span class="n">C</span> <span class="o">:=</span> <span class="n">add_monoid_hom.id</span> <span class="n">ℤ</span> <span class="o">}</span>

<span class="kd">def</span> <span class="n">test2</span> <span class="o">:</span> <span class="n">test</span> <span class="n">ℤ</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">A'</span> <span class="o">:=</span> <span class="n">test1.A'</span><span class="o">,</span> <span class="n">B</span> <span class="o">:=</span> <span class="n">_</span><span class="o">,</span>
<span class="c1">--  use @, ugh, and the ℤ is important!</span>
  <span class="n">C</span> <span class="o">:=</span>  <span class="bp">@</span><span class="n">add_monoid_hom.comp</span> <span class="n">_</span> <span class="n">_</span> <span class="n">ℤ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">test1.C</span> <span class="o">(</span><span class="n">add_monoid_hom.id</span> <span class="n">_</span><span class="o">)</span> <span class="o">}</span>
</code></pre></div>



<a name="283238845"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283238845" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283238845">(May 22 2022 at 15:59)</a>:</h4>
<p>Add <code>attribute [instance] test.B</code> after the definition of <code>test</code>, and get rid of the <code>haveI</code> tactic stuff in <code>test3</code> (it creates a variable instance with no local definition)</p>



<a name="283241838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283241838" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283241838">(May 22 2022 at 17:08)</a>:</h4>
<p>Thanks, Reid.<br>
Can you also explain why this is necessary?</p>



<a name="283241987"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283241987" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283241987">(May 22 2022 at 17:12)</a>:</h4>
<p>When you write:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">test</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">add_zero_class</span> <span class="n">A</span><span class="o">]</span> <span class="o">:=</span> <span class="o">(</span><span class="n">A'</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">B</span> <span class="o">:</span> <span class="n">add_zero_class</span> <span class="n">A'</span><span class="o">]</span> <span class="o">(</span><span class="n">C</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">→+</span> <span class="n">A'</span><span class="o">)</span>
</code></pre></div>
<p>this means "make <code>B</code> a typeclass argument to <code>test.mk</code>"</p>



<a name="283241992"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283241992" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283241992">(May 22 2022 at 17:12)</a>:</h4>
<p>It does not mean "use <code>B</code> when performing instance search"</p>



<a name="283242003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283242003" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283242003">(May 22 2022 at 17:12)</a>:</h4>
<p>To say that, you need to add the <code>[instance]</code> attribute; it helps if you remember that <code>instance</code> is roughly <code>@[instance] def</code></p>



<a name="283242023"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283242023" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283242023">(May 22 2022 at 17:13)</a>:</h4>
<p>OK. And why did the <code>haveI ...</code> version not work? The error message was quite confusing, claiming that two things are not defeq that look exactly the same.</p>



<a name="283242202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283242202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283242202">(May 22 2022 at 17:16)</a>:</h4>
<p>It is the usual <code>letI</code> vs <code>haveI</code> issue</p>



<a name="283242218"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Type%20class%20trouble/near/283242218" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Michael Stoll <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Type.20class.20trouble.html#283242218">(May 22 2022 at 17:17)</a>:</h4>
<p>Again! <span aria-label="oh no" class="emoji emoji-1f615" role="img" title="oh no">:oh_no:</span></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>