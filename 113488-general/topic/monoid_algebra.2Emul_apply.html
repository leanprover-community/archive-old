---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/monoid_algebra.2Emul_apply.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html">monoid_algebra.mul_apply</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="199530486"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199530486" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199530486">(Jun 02 2020 at 18:05)</a>:</h4>
<p>For some reason the statement of <code>monoid_algebra.mul_apply</code> (<code>data/monoid_algebra</code>, line 77) takes about 4 seconds to elaborate. (I commented out the proof.)<br>
What's the reason for this?</p>



<a name="199535997"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199535997" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199535997">(Jun 02 2020 at 18:47)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="n">monoid_algebra</span><span class="bp">.</span><span class="n">lean</span><span class="o">:</span><span class="mi">79</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span> <span class="n">information</span>
<span class="n">parsing</span> <span class="n">took</span> <span class="mi">0</span><span class="bp">.</span><span class="mi">508</span><span class="n">ms</span>
<span class="n">monoid_algebra</span><span class="bp">.</span><span class="n">lean</span><span class="o">:</span><span class="mi">79</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span> <span class="n">information</span>
<span class="n">type</span> <span class="n">checking</span> <span class="n">of</span> <span class="n">mul_apply</span> <span class="n">took</span> <span class="mi">0</span><span class="bp">.</span><span class="mi">503</span><span class="n">ms</span>
<span class="n">monoid_algebra</span><span class="bp">.</span><span class="n">lean</span><span class="o">:</span><span class="mi">79</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span> <span class="n">information</span>
<span class="n">decl</span> <span class="n">post</span><span class="bp">-</span><span class="n">processing</span> <span class="n">of</span> <span class="n">mul_apply</span> <span class="n">took</span> <span class="mi">0</span><span class="bp">.</span><span class="mi">0135</span><span class="n">ms</span>
<span class="n">monoid_algebra</span><span class="bp">.</span><span class="n">lean</span><span class="o">:</span><span class="mi">79</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span> <span class="n">information</span>
<span class="n">elaboration</span> <span class="n">of</span> <span class="n">mul_apply</span> <span class="n">took</span> <span class="mi">22</span><span class="bp">.</span><span class="mi">9</span><span class="n">ms</span>
</code></pre></div>


<p>But it certainly takes a lot more than 1s when I watch the orange bars. So there is some secret time sink here.</p>



<a name="199593928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199593928" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199593928">(Jun 03 2020 at 08:49)</a>:</h4>
<p><span class="user-mention" data-user-id="110087">@Scott Morrison</span> Any idea what's going on here?</p>



<a name="199593950"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199593950" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199593950">(Jun 03 2020 at 08:49)</a>:</h4>
<p>Nope! :-(</p>



<a name="199593979"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199593979" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199593979">(Jun 03 2020 at 08:49)</a>:</h4>
<p>Was it snappy when you wrote it? If so, lean got worse at this part of the game...</p>



<a name="199594788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199594788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199594788">(Jun 03 2020 at 08:58)</a>:</h4>
<p>I'm starting to see a pattern...</p>
<div class="codehilite"><pre><span></span><code><span class="n">local</span> <span class="n">attribute</span> <span class="o">[</span><span class="kn">instance</span><span class="o">,</span> <span class="n">priority</span> <span class="mi">1001</span><span class="o">]</span> <span class="n">classical</span><span class="bp">.</span><span class="n">prop_decidable</span>
</code></pre></div>



<a name="199595027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199595027" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199595027">(Jun 03 2020 at 09:00)</a>:</h4>
<p>Is this priority simply the better one for <code>open_locale classical</code>?</p>



<a name="199595235"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199595235" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199595235">(Jun 03 2020 at 09:02)</a>:</h4>
<p>The priority is dangerous in general: <code>if 1 = 2 then 3 else 4</code> is elaborated to a definitionally not equal term if you change the priority:</p>
<div class="codehilite"><pre><span></span><code><span class="n">noncomputable</span> <span class="n">theory</span>
<span class="n">def</span> <span class="n">A</span> <span class="o">:=</span> <span class="k">if</span> <span class="mi">1</span> <span class="bp">=</span> <span class="mi">2</span> <span class="k">then</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">4</span>
<span class="n">local</span> <span class="n">attribute</span> <span class="o">[</span><span class="kn">instance</span><span class="o">,</span> <span class="n">priority</span> <span class="mi">1001</span><span class="o">]</span> <span class="n">classical</span><span class="bp">.</span><span class="n">prop_decidable</span>
<span class="n">def</span> <span class="n">B</span> <span class="o">:=</span> <span class="k">if</span> <span class="mi">1</span> <span class="bp">=</span> <span class="mi">2</span> <span class="k">then</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">4</span>
<span class="kn">example</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">=</span> <span class="n">B</span> <span class="o">:=</span> <span class="n">rfl</span> <span class="c1">-- fails</span>
</code></pre></div>



<a name="199595324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199595324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199595324">(Jun 03 2020 at 09:03)</a>:</h4>
<p>Ouch</p>



<a name="199595458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199595458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199595458">(Jun 03 2020 at 09:04)</a>:</h4>
<p>It <em>might</em> also be a good idea to add explicit <code>decidable_eq</code> assumptions to lemmas with if-then-else:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">lemma</span> <span class="n">mul_apply</span> <span class="o">(</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">monoid_algebra</span> <span class="n">k</span> <span class="n">G</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">G</span><span class="o">)</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">G</span><span class="o">]</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">f</span> <span class="bp">*</span> <span class="n">g</span><span class="o">)</span> <span class="n">x</span> <span class="bp">=</span> <span class="o">(</span><span class="n">f</span><span class="bp">.</span><span class="n">sum</span> <span class="err">$</span> <span class="bp">λ</span><span class="n">a₁</span> <span class="n">b₁</span><span class="o">,</span> <span class="n">g</span><span class="bp">.</span><span class="n">sum</span> <span class="err">$</span> <span class="bp">λ</span><span class="n">a₂</span> <span class="n">b₂</span><span class="o">,</span> <span class="k">if</span> <span class="n">a₁</span> <span class="bp">*</span> <span class="n">a₂</span> <span class="bp">=</span> <span class="n">x</span> <span class="k">then</span> <span class="n">b₁</span> <span class="bp">*</span> <span class="n">b₂</span> <span class="k">else</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:=</span>
<span class="c1">-- also fast, but proof&#39;s broken</span>
</code></pre></div>



<a name="199595622"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199595622" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199595622">(Jun 03 2020 at 09:06)</a>:</h4>
<p>I have no idea if you ever want to apply results about monoid algebras to things like natural numbers.  But if you do, you'll quickly run into multiple different decidability instances and you won't be able to (directly) apply <code>mul_apply</code> to an if-then-else.</p>



<a name="199595932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199595932" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199595932">(Jun 03 2020 at 09:10)</a>:</h4>
<p>Would it be reasonable if <code>open_locale classical</code> also set</p>
<div class="codehilite"><pre><span></span><code><span class="n">local</span> <span class="n">attribute</span> <span class="o">[</span><span class="kn">instance</span><span class="o">,</span> <span class="n">priority</span> <span class="mi">8</span><span class="o">]</span> <span class="n">eq</span><span class="bp">.</span><span class="n">decidable</span> <span class="n">decidable_eq_of_decidable_le</span>
</code></pre></div>


<p>? These seem to be the problematic instances that make Lean search through all the algebraic hierarchy whenever it wants to solve any decidability problem.</p>



<a name="199596048"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199596048" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199596048">(Jun 03 2020 at 09:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/113488-general/topic/monoid_algebra.2Emul_apply/near/199595622">said</a>:</p>
<blockquote>
<p>I have no idea if you ever want to apply results about monoid algebras to things like natural numbers.  But if you do, you'll quickly run into multiple different decidability instances and you won't be able to (directly) apply <code>mul_apply</code> to an if-then-else.</p>
</blockquote>
<p>I think that occasionally we will want to do that (or with <code>int</code> or <code>zmod n</code>). Same is true for polynomials.</p>



<a name="199596184"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199596184" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199596184">(Jun 03 2020 at 09:14)</a>:</h4>
<p><span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span> This seems like a reasonable change.</p>



<a name="199597402"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/monoid_algebra.mul_apply/near/199597402" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/monoid_algebra.2Emul_apply.html#199597402">(Jun 03 2020 at 09:28)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/2932">#2932</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>