---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/acyclic.20datastrucure.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html">acyclic datastrucure</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="217765757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217765757" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Matthew Weingarten <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217765757">(Nov 24 2020 at 15:07)</a>:</h4>
<p><span class="user-mention" data-user-id="112857">@Leonardo de Moura</span> <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span>  <br>
Hi in the paper counting immutable beans you mention that lean and lambdapure do not allow for cyclic data structures. Does this follow from the type system used in Lean? Also how much does this limit the semantics of lean, like representing cyclic graphs?</p>



<a name="217765990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217765990" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217765990">(Nov 24 2020 at 15:09)</a>:</h4>
<p>I think Leo is quite busy now with Lean 4 and prefers not to be bothered, but you might be lucky with Sebastian :-)</p>



<a name="217767367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217767367" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217767367">(Nov 24 2020 at 15:18)</a>:</h4>
<p>Inhabitants of the inductive data types of Lean (and similar systems) are trees of finite height, so they are acyclic. This is probably what the statement refers to. You can still represent cyclic data structures, e.g. by giving a tree and a list of 'back edges' or an adjacency matrix; the representation is just not very direct.</p>



<a name="217768142"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217768142" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217768142">(Nov 24 2020 at 15:24)</a>:</h4>
<p>Isn't it also possible to represent cyclic data structures as quotients of inductive types?</p>



<a name="217768478"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217768478" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217768478">(Nov 24 2020 at 15:27)</a>:</h4>
<p>E.g. </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">foo</span>
<span class="bp">|</span> <span class="n">root</span> <span class="o">:</span> <span class="n">foo</span>
<span class="bp">|</span> <span class="n">left</span> <span class="o">:</span> <span class="n">foo</span> <span class="bp">→</span> <span class="n">foo</span>
<span class="bp">|</span> <span class="n">right</span> <span class="o">:</span> <span class="n">foo</span> <span class="bp">→</span> <span class="n">foo</span>

<span class="kn">open</span> <span class="n">foo</span>

<span class="kd">inductive</span> <span class="n">rel</span> <span class="o">:</span> <span class="n">foo</span> <span class="bp">→</span> <span class="n">foo</span> <span class="bp">→</span> <span class="kt">Prop</span>
<span class="bp">|</span> <span class="n">glue</span> <span class="o">:</span> <span class="n">rel</span> <span class="o">(</span><span class="n">left</span> <span class="o">(</span><span class="n">right</span> <span class="n">root</span><span class="o">))</span> <span class="o">(</span><span class="n">right</span> <span class="o">(</span><span class="n">left</span> <span class="n">root</span><span class="o">))</span>

<span class="kd">def</span> <span class="n">cyclic_thing</span> <span class="o">:=</span> <span class="n">quot</span> <span class="n">rel</span>
</code></pre></div>



<a name="217776800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217776800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217776800">(Nov 24 2020 at 16:20)</a>:</h4>
<p>Regarding the dynamic semantics, cycles are also ruled out by the combination of strictness and immutability. At least as long you don't add a specific special case like OCaml(?) does.</p>



<a name="217776944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217776944" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217776944">(Nov 24 2020 at 16:21)</a>:</h4>
<p>how's that memoization work coming? :)</p>



<a name="217777234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217777234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217777234">(Nov 24 2020 at 16:23)</a>:</h4>
<p>I see many works but none of them start with memoization</p>



<a name="217777423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217777423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217777423">(Nov 24 2020 at 16:24)</a>:</h4>
<p>I spoke with simon a couple months ago about support for internal mutability, what I called <code>cached</code> in my original proposal</p>



<a name="217777528"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217777528" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217777528">(Nov 24 2020 at 16:25)</a>:</h4>
<p>parts of that made it into the paper about pointer based optimization but I think proper internal mutability is still in the air</p>



<a name="217777571"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217777571" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217777571">(Nov 24 2020 at 16:25)</a>:</h4>
<p>and I have a stack of FP algorithms that need it for efficiency</p>



<a name="217777653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217777653" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217777653">(Nov 24 2020 at 16:26)</a>:</h4>
<p>I like the approach, it's just not something we currently need for implementing Lean itself</p>



<a name="217777757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217777757" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217777757">(Nov 24 2020 at 16:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271913">Matthew Weingarten</span> <a href="#narrow/stream/113488-general/topic/acyclic.20datastrucure/near/217765757">said</a>:</p>
<blockquote>
<p>Also how much does this limit the semantics of lean, like representing cyclic graphs?</p>
</blockquote>
<p>How useful is a cyclic graph anyway if it is completely immutable? Yes, there are a few instances of "tying the knot" in GHC, but it's still a pretty obscure technique I'd say.</p>



<a name="217777925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217777925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217777925">(Nov 24 2020 at 16:28)</a>:</h4>
<p>cyclic data structures in haskell are actually not good for representing explicit sharing, because the representation is not observable</p>



<a name="217777973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217777973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217777973">(Nov 24 2020 at 16:28)</a>:</h4>
<p>that's part of what the pointer based optimization paper is about</p>



<a name="217778191"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217778191" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217778191">(Nov 24 2020 at 16:30)</a>:</h4>
<p>I did something like that in the haskell version of MM0 and regretted it, because you have to resort to some unsafe hackery to get at the pointers if you want to reify a cyclic (or acyclic but highly shared) data structure as an actual graph with nodes</p>



<a name="217804273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217804273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217804273">(Nov 24 2020 at 19:44)</a>:</h4>
<p>Btw, is there any way to do memoization in lean 3? I guess there could be a <code>memoize</code> monad? afaik there is nothing atm, right?</p>



<a name="217808472"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217808472" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217808472">(Nov 24 2020 at 20:20)</a>:</h4>
<p>You can use <code>ref</code> in the tactic monad but that's it</p>



<a name="217808509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217808509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217808509">(Nov 24 2020 at 20:21)</a>:</h4>
<p>the best alternative is to throw everything in a hashtable or rbmap</p>



<a name="217809280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217809280" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217809280">(Nov 24 2020 at 20:29)</a>:</h4>
<p>And then explicitly pass that rbmap around?</p>



<a name="217813341"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/217813341" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#217813341">(Nov 24 2020 at 21:05)</a>:</h4>
<p>Yeah</p>



<a name="218565496"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/218565496" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Matthew Weingarten <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#218565496">(Dec 02 2020 at 14:44)</a>:</h4>
<p>Thanks guys for the responses!</p>



<a name="219475913"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219475913" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jason Rute <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219475913">(Dec 10 2020 at 14:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/113488-general/topic/acyclic.20datastrucure/near/217804273">said</a>:</p>
<blockquote>
<p>Btw, is there any way to do memoization in lean 3? I guess there could be a <code>memoize</code> monad? afaik there is nothing atm, right?</p>
</blockquote>
<p>In some sense the State monad is a <code>memoize</code> monad if you use a <code>rb_map</code> or structure containing an <code>rb_map</code> as the state.  The cache is invalidated after you leave the monad, but that is sufficient for dynamic programming application which is where I often see memoized functions.  I coded up a <a href="https://gist.github.com/jasonrute/dfc817b1a3e175bd51b3acaaf7cf9613">Fibonacci example in Lean 4</a> just because I was having fun trying out Lean 4, but the same idea should work in Lean 3.</p>



<a name="219476373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219476373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219476373">(Dec 10 2020 at 14:12)</a>:</h4>
<p>fun fact, you can't prove that this computes the naive fib function</p>



<a name="219476940"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219476940" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jason Rute <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219476940">(Dec 10 2020 at 14:16)</a>:</h4>
<p>Yeah, I assume the need for memoization is mostly on the meta-programming side, but maybe I'm mistaken on that.</p>



<a name="219481477"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219481477" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219481477">(Dec 10 2020 at 14:47)</a>:</h4>
<p>I guess for more global versions where the cache persists after leaving the monad, you would quickly start using databases, right?</p>



<a name="219481610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219481610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219481610">(Dec 10 2020 at 14:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113488-general/topic/acyclic.20datastrucure/near/219476373">said</a>:</p>
<blockquote>
<p>fun fact, you can't prove that this computes the naive fib function</p>
</blockquote>
<p>This is a bummer. Because it limits to what extent we can use <code>lean</code> as a CAS in some nice future.</p>



<a name="219481733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219481733" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219481733">(Dec 10 2020 at 14:49)</a>:</h4>
<p>I maintain that the <code>partial</code> keyword was a mistake</p>



<a name="219481773"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219481773" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219481773">(Dec 10 2020 at 14:49)</a>:</h4>
<p>As in, you can still write these functions, but you can't tie them back to the proven correct things. So we would have <code>def elliptic_curve</code> and <code>meta def fast_elliptic_curve</code> and we can compute with the latter, but can't show that it has any relation to the <code>elliptic_curve</code> that you prove things about.</p>



<a name="219481948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219481948" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219481948">(Dec 10 2020 at 14:50)</a>:</h4>
<p>well, lean 4 does have <code>implementedBy</code> or whatever it's called, so you can do this if you want to, by cheating</p>



<a name="219482139"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219482139" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ruben Van de Velde <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219482139">(Dec 10 2020 at 14:52)</a>:</h4>
<p>What's making it impossible to prove? (If it wouldn't take too long to explain)</p>



<a name="219482258"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219482258" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219482258">(Dec 10 2020 at 14:53)</a>:</h4>
<p>it makes use of a <code>constant fuel : nat := 0</code></p>



<a name="219482446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219482446" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219482446">(Dec 10 2020 at 14:54)</a>:</h4>
<p>this constant is effectively infinity in the VM, meaning that we have an omega-inconsistent model</p>



<a name="219482739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219482739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219482739">(Dec 10 2020 at 14:56)</a>:</h4>
<p>but in pure code you can't prove that it is any particular value, so it is consistent that every <code>partial</code> function fails to compute what it was supposed to</p>



<a name="219484573"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219484573" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219484573">(Dec 10 2020 at 15:09)</a>:</h4>
<p>You shouldn't need <code>partial</code> here</p>



<a name="219485047"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219485047" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jason Rute <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219485047">(Dec 10 2020 at 15:12)</a>:</h4>
<p>I only added it because I got some message about the equation compiler and didn't want to deal with it <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="219485474"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219485474" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219485474">(Dec 10 2020 at 15:15)</a>:</h4>
<p>Another fun fact: absent sufficient inlining (which in this particular example should not be an issue), you might be copying the whole HashMap array on each mutation, because you're not using it linearly (<code>get</code> isn't linear).</p>



<a name="219489478"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219489478" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jason Rute <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219489478">(Dec 10 2020 at 15:40)</a>:</h4>
<p>Fixed.  No more partial or <code>get...set</code>.</p>



<a name="219489559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219489559" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219489559">(Dec 10 2020 at 15:41)</a>:</h4>
<p>So without partial one can prove that this computes the usual fib right? (just checking I'm understanding everyones comments)</p>



<a name="219490758"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219490758" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219490758">(Dec 10 2020 at 15:49)</a>:</h4>
<p>For official information about how <code>partial</code> works, see <br>
<a href="http://leanprover.github.io/talks/LeanPLDI.pdf">http://leanprover.github.io/talks/LeanPLDI.pdf</a> (slide 15) and<br>
<a href="https://leanprover.github.io/lean4/doc/lean3changes.html">https://leanprover.github.io/lean4/doc/lean3changes.html</a> (<code>the meta keyword</code> section).</p>



<a name="219492428"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219492428" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219492428">(Dec 10 2020 at 16:00)</a>:</h4>
<p>Does lean 4 let us track and maybe ban uses of the <code>fuel</code> constant? In lean 3 <code>meta</code> was viral but it seems that <code>partial</code> isn't, so it's not clear how to make sure it's not getting used</p>



<a name="219493771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219493771" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219493771">(Dec 10 2020 at 16:09)</a>:</h4>
<p>See links above. There is no <code>fuel</code>.</p>



<a name="219503747"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219503747" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219503747">(Dec 10 2020 at 17:13)</a>:</h4>
<p>in lean 4 will there be / is there a way to enforce that an object is never copied? like the ref count should always only be 1,  a buffer where you only want to mutate it efficiently</p>



<a name="219504884"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219504884" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219504884">(Dec 10 2020 at 17:22)</a>:</h4>
<p><span class="user-mention" data-user-id="112857">@Leonardo de Moura</span> I thought that <code>fuel</code> appeared in the compilation for <code>partial</code> definitions? What happens if I <code>#print foo</code> where <code>foo</code> is a <code>partial def</code>? Can I even still do that like in lean 3 to inspect the result of the equation compiler? The provided links mention that the compilation uses unsafe + implementedBy but don't say what the pure version (the "reference model") is. Is the entire function just a constant with trivial witness?</p>



<a name="219505214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219505214" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219505214">(Dec 10 2020 at 17:25)</a>:</h4>
<blockquote>
<p>When the partial keyword is used, Lean generates an auxiliary unsafe definition that uses general recursion, and then defines an opaque constant that is implemented by this auxiliary definition. This is very simple, efficient, and is sufficient for users that want to use Lean as a regular programming language. A partial definition cannot use unsafe features such as unsafeCast and ptrAddrUnsafe, and it can only be used to implement types we already known to be inhabited. Finally, since we "seal" the auxiliary definition using an opaque constant, we cannot reason about partial definitions.</p>
</blockquote>



<a name="219505459"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219505459" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219505459">(Dec 10 2020 at 17:27)</a>:</h4>
<p>So this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">partial</span> <span class="kd">def</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">Nat</span> <span class="bp">-&gt;</span> <span class="n">Nat</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="bp">=&gt;</span> <span class="mi">0</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">foo</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span>
</code></pre></div>
<p>is compiled to this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">unsafe</span> <span class="kd">def</span> <span class="n">foo.impl</span> <span class="o">:</span> <span class="n">Nat</span> <span class="bp">-&gt;</span> <span class="n">Nat</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="bp">=&gt;</span> <span class="mi">0</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">foo.impl</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span>

<span class="kd">@[implementedBy "foo.impl"]</span>
<span class="kd">constant</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">Nat</span> <span class="bp">-&gt;</span> <span class="n">Nat</span> <span class="o">:=</span> <span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="mi">0</span>
</code></pre></div>



<a name="219505788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219505788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219505788">(Dec 10 2020 at 17:29)</a>:</h4>
<p>So I guess my earlier question about tracking uses of the <code>fuel</code> constant should be extended to tracking all <code>partial</code> constants</p>



<a name="219506008"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219506008" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219506008">(Dec 10 2020 at 17:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="238605">Kevin Lacker</span> <a href="#narrow/stream/113488-general/topic/acyclic.20datastrucure/near/219503747">said</a>:</p>
<blockquote>
<p>in lean 4 will there be / is there a way to enforce that an object is never copied? like the ref count should always only be 1,  a buffer where you only want to mutate it efficiently</p>
</blockquote>
<p>I don't think this can be done without an actual linear type system</p>



<a name="219506116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219506116" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219506116">(Dec 10 2020 at 17:31)</a>:</h4>
<p>I mean you could maybe set the runtime to crash if the refcount goes above 1, but to check at compile time? You would need to be rust</p>



<a name="219506576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219506576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219506576">(Dec 10 2020 at 17:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113488-general/topic/acyclic.20datastrucure/near/219505788">said</a>:</p>
<blockquote>
<p>So I guess my earlier question about tracking uses of the <code>fuel</code> constant should be extended to tracking all <code>partial</code> constants</p>
</blockquote>
<p>Users can track whatever they want.  They can <code>import Lean</code>, and access everything, write their own commands, and traverse all internal datastructures.</p>



<a name="219506952"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219506952" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219506952">(Dec 10 2020 at 17:36)</a>:</h4>
<p>What's the point of such a tracking? The kernel won't accept proofs based on unsafe stuff, right?</p>



<a name="219508492"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219508492" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219508492">(Dec 10 2020 at 17:49)</a>:</h4>
<p>This stuff isn't unsafe</p>



<a name="219508505"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219508505" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219508505">(Dec 10 2020 at 17:49)</a>:</h4>
<p>that's the problem</p>



<a name="219508580"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219508580" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219508580">(Dec 10 2020 at 17:49)</a>:</h4>
<p>but you also can't prove anything about it</p>



<a name="219508661"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219508661" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219508661">(Dec 10 2020 at 17:50)</a>:</h4>
<p>that's not entirely true, you can prove it's a function for example</p>



<a name="219508713"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219508713" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219508713">(Dec 10 2020 at 17:50)</a>:</h4>
<p>(which, obvious as it may sound, need not be true for unsafe things)</p>



<a name="219508716"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219508716" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219508716">(Dec 10 2020 at 17:50)</a>:</h4>
<p>I don't understand what the problem is though</p>



<a name="219508730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219508730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219508730">(Dec 10 2020 at 17:50)</a>:</h4>
<p>I'm not worried at all.</p>



<a name="219508805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219508805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219508805">(Dec 10 2020 at 17:51)</a>:</h4>
<p>it doesn't compromise the logical integrity of the system, but it does compromise the relationship between the logical representation and the compiler</p>



<a name="219509448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219509448" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jason Rute <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219509448">(Dec 10 2020 at 17:56)</a>:</h4>
<p>Then I think your issue is more with implementedby, than unsafe, no?</p>



<a name="219509571"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219509571" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219509571">(Dec 10 2020 at 17:56)</a>:</h4>
<p>I do think it would be weird to the point of rejection in code review if any <code>partial</code> def was involved in (the transitive closure of) the definition of some pure mathlib concept like <code>list.sort</code> or <code>comm_ring</code></p>



<a name="219509690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219509690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219509690">(Dec 10 2020 at 17:57)</a>:</h4>
<p>yes, this is about <code>implementedBy</code></p>



<a name="219509838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219509838" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219509838">(Dec 10 2020 at 17:58)</a>:</h4>
<p>I am okay with adding <code>implementedBy</code> annotations when we can prove at the meta level that the definition is faithfully represented in the executable version</p>



<a name="219509959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219509959" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219509959">(Dec 10 2020 at 17:59)</a>:</h4>
<p>but to maintain this property we have to carefully consider each <code>implementedBy</code> location. It's basically like <code>unsafe</code> blocks in rust</p>



<a name="219509993"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219509993" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219509993">(Dec 10 2020 at 17:59)</a>:</h4>
<p><code>unsafe</code> code itself is fine, it makes no claims about anything</p>



<a name="219510016"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219510016" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219510016">(Dec 10 2020 at 17:59)</a>:</h4>
<p>I don't see any reason to use <code>partial</code> over <code>unsafe</code></p>



<a name="219511531"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219511531" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219511531">(Dec 10 2020 at 18:11)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c1">-- Error `foo1` uses unsafe declaration `unsafeCast`</span>
<span class="n">partial</span> <span class="kd">def</span> <span class="n">foo1</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">String</span> <span class="o">:=</span>
  <span class="n">unsafeCast</span> <span class="n">x</span>

<span class="c1">-- Ok</span>
<span class="n">unsafe</span> <span class="kd">def</span> <span class="n">foo2</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">String</span> <span class="o">:=</span>
  <span class="n">unsafeCast</span> <span class="n">x</span>
</code></pre></div>



<a name="219511933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219511933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219511933">(Dec 10 2020 at 18:14)</a>:</h4>
<p>So the main function is to catch you from doing bad things? I get that, that's useful. But <code>unsafe</code> is already in the name of that function, and <code>meta</code> has been like this in lean 3 and it hasn't ever really been an issue</p>



<a name="219512007"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512007" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512007">(Dec 10 2020 at 18:15)</a>:</h4>
<p>that is, if 90% of the elaborator was written as <code>unsafe</code> instead of <code>partial</code>, would it have caused significant maintenance problems?</p>



<a name="219512159"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512159" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512159">(Dec 10 2020 at 18:16)</a>:</h4>
<p>Presumably it would be more like 90% was <code>unsafe</code> versus 20% was <code>partial</code></p>



<a name="219512225"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512225" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512225">(Dec 10 2020 at 18:17)</a>:</h4>
<p>That's only because <code>partial</code> is not viral even though it should be</p>



<a name="219512261"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512261" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512261">(Dec 10 2020 at 18:17)</a>:</h4>
<p>if <code>partial</code> is meant in the sense "not total", then it should absolutely be viral</p>



<a name="219512350"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512350" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512350">(Dec 10 2020 at 18:18)</a>:</h4>
<p>I have no idea what you're arguing really</p>



<a name="219512458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512458">(Dec 10 2020 at 18:18)</a>:</h4>
<p>but for a programming language it's not a great look if you have to write <code>partial def</code> or <code>unsafe def</code> to define basically every function</p>



<a name="219512465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512465" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512465">(Dec 10 2020 at 18:18)</a>:</h4>
<p>and for mathlib it doesn't seem to matter anyways</p>



<a name="219512634"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512634" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512634">(Dec 10 2020 at 18:20)</a>:</h4>
<p>I think this is just a clash of traditions regarding what safety means in regular programming languages vs formal logics</p>



<a name="219512697"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512697" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512697">(Dec 10 2020 at 18:20)</a>:</h4>
<p>no it's not a good look to be saying that literally everything is unsafe, but it's kind of the truth</p>



<a name="219512773"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512773" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512773">(Dec 10 2020 at 18:21)</a>:</h4>
<p>it's just that most programming languages don't make a big fuss about it</p>



<a name="219512849"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219512849" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219512849">(Dec 10 2020 at 18:21)</a>:</h4>
<p>and maybe lean 4 shouldn't either, after all it's more like haskell now than lean 3</p>



<a name="219513383"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219513383" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219513383">(Dec 10 2020 at 18:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/113488-general/topic/acyclic.20datastrucure/near/219512458">said</a>:</p>
<blockquote>
<p>but for a programming language it's not a great look if you have to write <code>partial def</code> or <code>unsafe def</code> to define basically every function</p>
</blockquote>
<p>If that's just because it costs you 7 or 8 extra chars before the <code>def</code>, then I could imagine having <code>pdef</code> and <code>udef</code>.</p>



<a name="219513526"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219513526" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219513526">(Dec 10 2020 at 18:26)</a>:</h4>
<p>I'm pretty sure that the reason Reid says that is that for most programmers, <code>unsafe</code> is supposed to sound the warning klaxons, and it loses its strength if it is used constantly</p>



<a name="219514090"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219514090" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219514090">(Dec 10 2020 at 18:30)</a>:</h4>
<p>In lean 3, this signal was dampened by using a more neutral word <code>meta</code>, even though it's just as dangerous as lean 4's <code>unsafe</code>. I think that having all this <code>unsafe</code>/<code>meta</code>/ whatever sounding the alarm bells isn't necessarily a bad thing since it motivates people to chip away at it, making more interfaces safe/provable. Lean 4 solves the problem by using the non-viral <code>partial</code>, which silences the klaxons without improving the situation</p>



<a name="219514223"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219514223" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219514223">(Dec 10 2020 at 18:31)</a>:</h4>
<p>Some clarifications:</p>
<ul>
<li>Logical integrity is preserved. You will not be able to prove <code>theorem unsound : False</code> because of <code>partial</code> or <code>unsafe</code>. </li>
<li>You can only use <code>partial</code> if the type is inhabited.</li>
<li>We type check <code>partial</code> functions, and they cannot use <code>unsafe</code> functions that may crash your program (e.g., <code>unsafeCast</code>), use unsafe inductive types, etc. So, you only gain the ability to perform "general recursion".</li>
<li>You can write a non-partial function <code>f</code> that uses a <code>partial</code> function <code>p</code> and still prove many things about it <span class="user-mention" data-user-id="112680">@Johan Commelin</span> . <code>f</code> will not be opaque. Of course, you will not be able to rely on the actual implementation of <code>p</code>.</li>
<li>Similarly, you can prove things about a function <code>f</code> that uses an opaque constant <code>g</code> tagged with <code>[extern]</code> (i.e., a foreign function).</li>
</ul>



<a name="219514535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219514535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219514535">(Dec 10 2020 at 18:33)</a>:</h4>
<ul>
<li><code>unsafe</code> can be used even when the type is not inhabited. <code>partial</code> cannot.</li>
</ul>



<a name="219514641"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219514641" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219514641">(Dec 10 2020 at 18:34)</a>:</h4>
<p>Also to clarify: I'm not arguing for any change on the part of the lean team, but when it eventually comes out one of the things I will be looking into is an improvement to the equation compiler to compile <code>partial def</code> into a representation that you can prove things about</p>



<a name="219514917"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219514917" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219514917">(Dec 10 2020 at 18:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112857">Leonardo de Moura</span> <a href="#narrow/stream/113488-general/topic/acyclic.20datastrucure/near/219514223">said</a>:</p>
<blockquote>
<ul>
<li>You can write a non-partial function <code>f</code> that uses a <code>partial</code> function <code>p</code> and still prove many things about it <span class="user-mention silent" data-user-id="112680">Johan Commelin</span> . <code>f</code> will not be opaque. Of course, you will not be able to rely on the actual implementation of <code>p</code>.</li>
</ul>
</blockquote>
<p>Cool! Thanks for the clarification!</p>



<a name="219515158"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219515158" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219515158">(Dec 10 2020 at 18:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113488-general/topic/acyclic.20datastrucure/near/219514641">said</a>:</p>
<blockquote>
<p>Also to clarify: I'm not arguing for any change on the part of the lean team, but when it eventually comes out one of the things I will be looking into is an improvement to the equation compiler to compile <code>partial def</code> into a representation that you can prove things about</p>
</blockquote>
<p>This is fine. Isabelle is a good reference for this. <br>
I just want to make sure users understand how <code>partial</code> works and avoid misinformation being spread about it.</p>



<a name="219515269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/acyclic%20datastrucure/near/219515269" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/acyclic.20datastrucure.html#219515269">(Dec 10 2020 at 18:39)</a>:</h4>
<p>Yes, sorry for the one-sided portrayal. I agree with everything you said</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>