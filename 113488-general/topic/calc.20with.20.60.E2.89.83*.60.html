---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html">calc with `≃*`</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="276030920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276030920" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joachim Breitner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276030920">(Mar 21 2022 at 10:35)</a>:</h4>
<p>I’d really like to do something like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">group</span> <span class="n">a</span><span class="o">]</span> <span class="o">[</span><span class="n">group</span> <span class="n">b</span><span class="o">]</span> <span class="o">[</span><span class="n">group</span> <span class="n">c</span><span class="o">]</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">≃*</span> <span class="n">c</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="k">calc</span> <span class="n">a</span> <span class="bp">≃*</span> <span class="n">b</span> <span class="o">:</span> <span class="gr">sorry</span>
     <span class="bp">...</span> <span class="bp">≃*</span> <span class="n">c</span> <span class="o">:</span> <span class="gr">sorry</span>
<span class="kd">end</span>
</code></pre></div>
<p>but I get</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">type</span> <span class="n">mismatch</span> <span class="n">at</span> <span class="n">application</span>
  <span class="n">mul_equiv.trans</span>
<span class="n">term</span>
  <span class="n">a</span>
<span class="n">has</span> <span class="n">type</span>
  <span class="kt">Type</span> <span class="bp">?</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">(</span><span class="bp">?+</span><span class="mi">1</span><span class="o">)</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="n">has_mul</span> <span class="bp">?</span><span class="n">m_1</span> <span class="o">:</span> <span class="kt">Type</span> <span class="bp">?</span>
<span class="n">state</span><span class="o">:</span>
<span class="n">a</span> <span class="o">:</span> <span class="kt">Type</span> <span class="bp">?</span><span class="o">,</span>
<span class="n">b</span> <span class="o">:</span> <span class="kt">Type</span> <span class="bp">?</span><span class="o">,</span>
<span class="n">c</span> <span class="o">:</span> <span class="kt">Type</span> <span class="bp">?</span><span class="o">,</span>
<span class="n">_inst_1</span> <span class="o">:</span> <span class="n">group</span> <span class="n">a</span><span class="o">,</span>
<span class="n">_inst_2</span> <span class="o">:</span> <span class="n">group</span> <span class="n">b</span><span class="o">,</span>
<span class="n">_inst_3</span> <span class="o">:</span> <span class="n">group</span> <span class="n">c</span>
<span class="bp">⊢</span> <span class="n">a</span> <span class="bp">≃*</span> <span class="n">c</span>
</code></pre></div>
<p>Is there a way to have calculations with <code>≃*</code>?</p>



<a name="276031250"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276031250" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276031250">(Mar 21 2022 at 10:38)</a>:</h4>
<p>Have a look through the <a href="https://leanprover-community.github.io/mathlib_docs/find/mul_equiv">docs#mul_equiv</a> API to see whether the relevant definitions have been marked <code>@[trans]</code>, although it looks like the error is elsewhere</p>



<a name="276031480"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276031480" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276031480">(Mar 21 2022 at 10:40)</a>:</h4>
<p>Indeed, <a href="https://leanprover-community.github.io/mathlib_docs/find/mul_equiv.trans">docs#mul_equiv.trans</a> is marked <code>@[trans]</code> (although it's not written in the docs, cc <span class="user-mention" data-user-id="123965">@Bryan Gin-ge Chen</span>), so I suspect it's a bug in <code>calc</code> or in <code>trans</code> that turn instance arguments into explicit ones, or something of this vein.</p>



<a name="276031622"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276031622" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276031622">(Mar 21 2022 at 10:41)</a>:</h4>
<p>There is a known issue with <code>calc</code> not working when the "relation" (here <code>≃*</code>) has more arguments than <code>=</code> would have--here those pesky <code>has_mul</code> arguments.</p>



<a name="276031779"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276031779" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276031779">(Mar 21 2022 at 10:42)</a>:</h4>
<p>e.g. <a href="#narrow/stream/113488-general/topic/calc.20for.20linear.20equivs/near/240337990">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc.20for.20linear.20equivs/near/240337990</a></p>



<a name="276031862"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276031862" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276031862">(Mar 21 2022 at 10:43)</a>:</h4>
<p><a href="#narrow/stream/113488-general/topic/homeomorph.2Etrans.20and.20calc/near/199225731">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/homeomorph.2Etrans.20and.20calc/near/199225731</a></p>



<a name="276050279"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276050279" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276050279">(Mar 21 2022 at 13:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276031480">said</a>:</p>
<blockquote>
<p>Indeed, <a href="https://leanprover-community.github.io/mathlib_docs/find/mul_equiv.trans">docs#mul_equiv.trans</a> is marked <code>@[trans]</code> (although it's not written in the docs, cc <span class="user-mention silent" data-user-id="123965">Bryan Gin-ge Chen</span>), ...</p>
</blockquote>
<p>Regarding <code>trans</code> not showing up in the docs, <code>doc-gen</code> only includes attributes from <a href="https://github.com/leanprover-community/doc-gen/blob/318f3c66ccd571ebe0712a5ac6e918ee4b5fc9a0/src/export_json.lean#L239">a hard-coded list</a>. I'm not sure what the criteria are for inclusion, but maybe a PR adding more would be accepted? cc: <span class="user-mention" data-user-id="110596">@Rob Lewis</span></p>



<a name="276051470"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276051470" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276051470">(Mar 21 2022 at 13:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276031622">said</a>:</p>
<blockquote>
<p>There is a known issue with <code>calc</code> not working when the "relation" (here <code>≃*</code>) has more arguments than <code>=</code> would have--here those pesky <code>has_mul</code> arguments.</p>
</blockquote>
<p>That's interesting, because I've definitely got <code>calc</code> to work with the relation <a href="https://leanprover-community.github.io/mathlib_docs/find/int.modeq">docs#int.modeq</a>.  Eg <a href="https://github.com/leanprover-community/mathlib/blob/135c57421dd1423d5044e4e467f09489e3062759/archive/imo/imo2005_q4.lean#L44">here</a></p>



<a name="276051664"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276051664" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276051664">(Mar 21 2022 at 13:41)</a>:</h4>
<p>It's not so much the number of arguments, but what the last <em>five</em> arguments are.  For <code>calc</code>, these need to be <code>a</code>, <code>b</code>, <code>c</code>, <code>h₁ : a ≃ b</code>, <code>h₂ : b ≼ c</code>, in that order.</p>



<a name="276051971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276051971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276051971">(Mar 21 2022 at 13:43)</a>:</h4>
<p>Ah... but that's not very workable when there are type class constraints on <code>a</code> <code>b</code> <code>c</code></p>



<a name="276052673"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276052673" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276052673">(Mar 21 2022 at 13:48)</a>:</h4>
<p>is that the behaviour in Lean4?</p>



<a name="276053565"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276053565" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276053565">(Mar 21 2022 at 13:54)</a>:</h4>
<p>Oooh, so that's why <code>trans</code> sometimes outputs "not enough arguments".</p>



<a name="276057248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276057248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276057248">(Mar 21 2022 at 14:21)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> is this similarly the case for <code>@[symm]</code> and <code>@[refl]</code>? I'm currently preparing a PR to make the most of what's possible, and I'm wondering if I should fix those at the same time anyways</p>



<a name="276057420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276057420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276057420">(Mar 21 2022 at 14:22)</a>:</h4>
<p>calc only uses trans, so this specific problem won't happen with symm or refl.</p>



<a name="276064951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276064951" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276064951">(Mar 21 2022 at 15:09)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/pull/12860">#12860</a></p>



<a name="276065261"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276065261" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276065261">(Mar 21 2022 at 15:11)</a>:</h4>
<p>Could we make <code>calc</code> more robust instead?</p>



<a name="276065398"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276065398" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276065398">(Mar 21 2022 at 15:12)</a>:</h4>
<p>for sure, that's the ideal solution, but this is a nice stop-gap</p>



<a name="276067073"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276067073" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joachim Breitner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276067073">(Mar 21 2022 at 15:21)</a>:</h4>
<p>What would be ways to fix that? An (optional) attribute to <code>trans</code> that indicates which argument positions correspond to the expected 5 arguments maybe? (Blunt, I agree)</p>
<p>Or make the command ignore type class arguments?</p>
<p>Or is <code>calc</code> too low level to cater for such specific whims?</p>



<a name="276069154"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276069154" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276069154">(Mar 21 2022 at 15:33)</a>:</h4>
<p>I would hope that ignoring type-class arguments would work, but who knows...</p>



<a name="276069288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276069288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276069288">(Mar 21 2022 at 15:34)</a>:</h4>
<p>Why can't <code>calc</code> infer <code>a</code>, <code>b</code>, <code>c</code> from <code>a ≃ b</code>, <code>b ≼ c</code>?</p>



<a name="276071277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276071277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276071277">(Mar 21 2022 at 15:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="284160">Eric Rodriguez</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276052673">said</a>:</p>
<blockquote>
<p>is that the behaviour in Lean4?</p>
</blockquote>
<p>Lean 4 uses a typeclass <code>Trans</code> instead of an attribute, so this issue should not apply</p>



<a name="276084926"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276084926" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276084926">(Mar 21 2022 at 17:14)</a>:</h4>
<p>Elaborating on @Yael's comment, I'd hope calc could work it out from lemmas of the shape<code>... (hab : type_one ... a b) (hbc : type_two ... b c) : type_three ... a c</code>, and unify  to work out <code>a</code>, <code>b</code>, and <code>c</code>.</p>



<a name="276085126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276085126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276085126">(Mar 21 2022 at 17:15)</a>:</h4>
<p>I suspect the answer is that some <code>trans</code> lemmas are rather <code>... (hab : type_one ... a b ...) (hbc : type_two ... b c ...) : type_three ... a c ...</code></p>



<a name="276085192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276085192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276085192">(Mar 21 2022 at 17:15)</a>:</h4>
<p>Do we actually have any of those that can't be reordered, and are currently supported by calc today?</p>



<a name="276085293"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276085293" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276085293">(Mar 21 2022 at 17:16)</a>:</h4>
<p>My guess would be that there are far fewer of those than the type that we're asking for in this thread.</p>



<a name="276085421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276085421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276085421">(Mar 21 2022 at 17:17)</a>:</h4>
<p>there's a lottt of different forms, some of the ones I rememeber were <code>≪ᵥ</code>, some of the model ones, and equality_mod_filters</p>



<a name="276087863"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276087863" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276087863">(Mar 21 2022 at 17:36)</a>:</h4>
<p>ok, now I'm confused: why doesn't this work on the branch above?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">analysis.asymptotics.asymptotic_equivalent</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="n">δ</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>

<span class="kn">section</span> <span class="n">is_equivalent</span>

<span class="n">open_locale</span> <span class="n">asymptotics</span>

<span class="k">#check</span> <span class="bp">@</span><span class="n">asymptotics.is_equivalent.trans</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">l</span> <span class="o">:</span> <span class="n">filter</span> <span class="n">α</span><span class="o">}</span> <span class="o">{</span><span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">}</span> <span class="o">[</span><span class="n">normed_group</span> <span class="n">β</span><span class="o">]</span>
  <span class="o">(</span><span class="n">huv</span> <span class="o">:</span> <span class="n">u</span> <span class="bp">~</span><span class="o">[</span><span class="n">l</span><span class="o">]</span> <span class="n">v</span><span class="o">)</span> <span class="o">(</span><span class="n">hvw</span> <span class="o">:</span> <span class="n">v</span> <span class="bp">~</span><span class="o">[</span><span class="n">l</span><span class="o">]</span> <span class="n">w</span><span class="o">)</span> <span class="o">:</span> <span class="n">u</span> <span class="bp">~</span><span class="o">[</span><span class="n">l</span><span class="o">]</span> <span class="n">w</span> <span class="o">:=</span>
<span class="k">calc</span> <span class="n">u</span> <span class="bp">~</span><span class="o">[</span><span class="n">l</span><span class="o">]</span> <span class="n">v</span> <span class="o">:</span> <span class="n">huv</span>
   <span class="bp">...</span> <span class="bp">~</span><span class="o">[</span><span class="n">l</span><span class="o">]</span> <span class="n">w</span> <span class="o">:</span> <span class="n">hvw</span>

<span class="kd">end</span> <span class="n">is_equivalent</span>
</code></pre></div>



<a name="276087872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276087872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276087872">(Mar 21 2022 at 17:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="470149">Joachim Breitner</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276067073">said</a>:</p>
<blockquote>
<p>An (optional) attribute to <code>trans</code> that indicates which argument positions correspond to the expected 5 arguments maybe?</p>
</blockquote>
<p>I wonder if we can get away with giving <code>trans</code> a single optional numeric argument corresponding to the position of  "<code>b</code>". Example:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#check</span> <span class="bp">@</span><span class="n">mul_equiv.trans</span>
<span class="c1">-- Π {M : Type u_2} {N : Type u_3} {P : Type u_4}</span>
<span class="c1">--   [_inst_1 : has_mul M] [_inst_2 : has_mul N] [_inst_3 : has_mul P],</span>
<span class="c1">--   M ≃* N → N ≃* P → M ≃* P</span>

<span class="n">set_attribute</span> <span class="o">[</span><span class="n">trans</span> <span class="mi">2</span><span class="o">]</span> <span class="n">mul_equiv.trans</span>
</code></pre></div>
<p>I haven't looked at the actual underlying code to see if this would work though.</p>



<a name="276185070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276185070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joachim Breitner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276185070">(Mar 22 2022 at 13:05)</a>:</h4>
<p>I'm curious: why would just <code>b</code> be needed?</p>



<a name="276185288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276185288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276185288">(Mar 22 2022 at 13:07)</a>:</h4>
<p>That's because <code>a</code> appears in the first hypothesis where <code>b</code> appears in the second,  and <code>c</code> appears in the second hypothesis where <code>b</code> appears in the first.</p>



<a name="276185371"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276185371" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276185371">(Mar 22 2022 at 13:07)</a>:</h4>
<p>Oh wait, I am completely off.</p>



<a name="276187305"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276187305" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joachim Breitner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276187305">(Mar 22 2022 at 13:23)</a>:</h4>
<p>Why does calc when have to instantiate these arguments (a, b, c) explicitly? Doesn't it always have the type of <code>h1</code> and <code>h2</code> explicitly given in the <code>calc</code> syntax, and can pass that as a type annotation?</p>



<a name="276187453"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276187453" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276187453">(Mar 22 2022 at 13:24)</a>:</h4>
<p>But how do you figure out <code>a</code>, <code>b</code>, <code>c</code> from the hypotheses? In simple cases, it's straightforward. In others, I don't really know.</p>



<a name="276187585"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276187585" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276187585">(Mar 22 2022 at 13:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="470149">Joachim Breitner</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276187305">said</a>:</p>
<blockquote>
<p>Why does calc when have to instantiate these arguments (a, b, c) explicitly? Doesn't it always have the type of <code>h1</code> and <code>h2</code> explicitly given in the <code>calc</code> syntax, and can pass that as a type annotation?</p>
</blockquote>
<p>This was my thought, too; the current pproach doesn't even work for some interesting types /cf my mwe)</p>



<a name="276189133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276189133" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276189133">(Mar 22 2022 at 13:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276187453">said</a>:</p>
<blockquote>
<p>But how do you figure out <code>a</code>, <code>b</code>, <code>c</code> from the hypotheses? In simple cases, it's straightforward. In others, I don't really know.</p>
</blockquote>
<p>Can't we require that the type of <code>hab : a ~ b</code> end in the arguments <code>a b</code> (eg be <code>some_rel _ _ _  a b</code>)? Are there any examples where this isn't possible?</p>



<a name="276189248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276189248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276189248">(Mar 22 2022 at 13:37)</a>:</h4>
<p>I agree that this sounds like a reasonable restriction but I'm sure people can come up with counterexamples.</p>



<a name="276189293"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276189293" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276189293">(Mar 22 2022 at 13:37)</a>:</h4>
<p>ring_equivs</p>



<a name="276189476"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276189476" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276189476">(Mar 22 2022 at 13:38)</a>:</h4>
<p>Oh, whoops</p>



<a name="276195161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276195161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276195161">(Mar 22 2022 at 14:19)</a>:</h4>
<p>I haven't read through this thread in detail, but if the problem is that <code>calc</code> can't reliably figure out the relation, perhaps users could just give it explicitly: <code>calc[R] x R y : p ...</code>.</p>



<a name="276196249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276196249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276196249">(Mar 22 2022 at 14:26)</a>:</h4>
<p>but the whole point of calc is that you can mix relations, for example if you wanted x ∈ A ∪ B you can currently write:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">field_theory.abel_ruffini</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">A</span> <span class="n">B</span> <span class="o">:</span> <span class="n">set</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">∈</span> <span class="n">A</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">∈</span> <span class="n">A</span> <span class="bp">∪</span> <span class="n">B</span> <span class="o">:=</span>
<span class="k">calc</span> <span class="n">a</span> <span class="bp">∈</span> <span class="n">A</span> <span class="o">:</span> <span class="n">h</span>
   <span class="bp">...</span> <span class="bp">⊆</span> <span class="n">A</span> <span class="bp">∪</span> <span class="n">B</span> <span class="o">:</span> <span class="kd">by</span> <span class="n">simp</span>
</code></pre></div>



<a name="276221574"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276221574" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276221574">(Mar 22 2022 at 17:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="470149">Joachim Breitner</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276185070">said</a>:</p>
<blockquote>
<p>I'm curious: why would just <code>b</code> be needed?</p>
</blockquote>
<p>I'd made a wrong guess about how it worked based on the existence of <a href="https://leanprover-community.github.io/mathlib_docs/tactics.html#transitivity">tactic#transitivity</a></p>
<p>Here's actually how the <code>transitivity foo</code> tactic works:</p>
<ol>
<li>Look at the target, get the head of the application (e.g., for <code>eq a b</code> that'd be <code>eq</code>), require that it be a constant.</li>
<li>Look for a <code>trans</code> lemma in the environment for that constant.</li>
<li>Basically <code>apply</code> that lemma using the <code>new_goals.non_dep_only</code> strategy.</li>
<li>Use <a href="https://leanprover-community.github.io/mathlib_docs/find/environment.relation_info">docs#environment.relation_info</a> to get the arity of the relation and the indices into the arguments list for the "lhs" and "rhs" of the relation.</li>
<li>For the first goal produced by applying the <code>trans</code> lemma, unify the "rhs" of it with <code>foo</code>.</li>
</ol>
<p>The docstring for <code>relation_info</code> says something about things being "marked as relations." Haven't dug into that yet.</p>



<a name="276223800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276223800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276223800">(Mar 22 2022 at 17:18)</a>:</h4>
<p>It looks like the "lhs" and "rhs" of a relation are always the last two explicit arguments, and the last two arguments to a <code>trans</code> lemma must be relation-like (they don't seem to be involved in the relation registration system -- not sure if that's a bug). <a href="https://github.com/leanprover-community/lean/blob/65ad4ffdb3abac75be748554e3cbe990fb1c6500/src/library/relation_manager.cpp#L132">relation_manager.cpp</a></p>
<p>Side question: what is a <code>subst</code> lemma? It doesn't seem like it has any use -- was this meant to be a way to implement relation-based rewriting?</p>



<a name="276225255"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276225255" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276225255">(Mar 22 2022 at 17:28)</a>:</h4>
<p><a href="https://github.com/leanprover-community/lean/blob/65ad4ffdb3abac75be748554e3cbe990fb1c6500/src/frontends/lean/calc.cpp#L96">Here's</a> where how <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> said <code>calc</code> works actually happens.</p>
<p>It takes the two relations being chained together and looks in the <code>trans</code> database for that pair to find a relevant <code>trans </code> lemma (note: there are two ways this database is queried: <code>transitivity</code> uses the relation constructed by the <code>trans</code> lemma, but <code>calc</code> uses the last two arguments to the <code>trans</code> lemma). If there is such a lemma, then <code>trans_it</code> in the linked code is truthy. Then the last five arguments to the <code>trans</code> lemma are filled in exactly as <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> said: <code>a</code>, <code>b</code>, <code>c</code>, proof of first relation involving <code>a</code> and <code>b</code>, proof of second relation involving <code>b</code> and <code>c</code>.</p>



<a name="276226753"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276226753" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276226753">(Mar 22 2022 at 17:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="470149">Joachim Breitner</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276187305">said</a>:</p>
<blockquote>
<p>Why does calc when have to instantiate these arguments (a, b, c) explicitly? Doesn't it always have the type of <code>h1</code> and <code>h2</code> explicitly given in the <code>calc</code> syntax, and can pass that as a type annotation?</p>
</blockquote>
<p>Given that the relation manager knows what the "lhs" and "rhs" of each relation involved is, it seems plausible to me that <code>a</code>, <code>b</code>, and <code>c</code> can be set indirectly through the types of <code>h1</code> and <code>h2</code>.</p>
<p>(I haven't looked at <span class="user-mention" data-user-id="284160">@Eric Rodriguez</span>'s MWE yet, or what it's an MWE of -- is it that you'd expect <code>calc</code> to work given that it seemingly meets the constraints?)</p>



<a name="276226900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276226900" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276226900">(Mar 22 2022 at 17:39)</a>:</h4>
<p>yeah, pretty much, but it errops out. I assume because it's a relation of the sort <code>a =[f] b</code></p>



<a name="276227834"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276227834" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276227834">(Mar 22 2022 at 17:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="284160">Eric Rodriguez</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276196249">said</a>:</p>
<blockquote>
<p>but the whole point of calc is that you can mix relations</p>
</blockquote>
<p>Then the annotation could be used as a hint:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">calc</span><span class="o">[</span><span class="n">R</span><span class="o">]</span> <span class="n">x</span> <span class="n">R</span> <span class="n">y</span> <span class="o">:</span> <span class="bp">...</span>
      <span class="bp">...</span> <span class="n">S</span> <span class="n">z</span> <span class="o">:</span> <span class="bp">...</span>
</code></pre></div>
<p>Lean could look at the <code>R</code> in square brackets to figure out which arguments are considered the left and right element, while using the current heuristic for <code>S</code>. Not sure whether this is a good idea, but it seems possible to me.</p>



<a name="276228172"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276228172" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276228172">(Mar 22 2022 at 17:49)</a>:</h4>
<p>Btw, how does <code>calc</code> handle <code>≥</code>? Does it literally use <a href="https://leanprover-community.github.io/mathlib_docs/find/ge_trans">docs#ge_trans</a> or is there special support?</p>



<a name="276229550"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276229550" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276229550">(Mar 22 2022 at 17:57)</a>:</h4>
<p>I would imagine it uses that, yes</p>



<a name="276237234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276237234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276237234">(Mar 22 2022 at 18:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="260507">Heather Macbeth</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276051470">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276031622">said</a>:</p>
<blockquote>
<p>There is a known issue with <code>calc</code> not working when the "relation" (here <code>≃*</code>) has more arguments than <code>=</code> would have--here those pesky <code>has_mul</code> arguments.</p>
</blockquote>
<p>That's interesting, because I've definitely got <code>calc</code> to work with the relation <a href="https://leanprover-community.github.io/mathlib_docs/find/int.modeq">docs#int.modeq</a>.  Eg <a href="https://github.com/leanprover-community/mathlib/blob/135c57421dd1423d5044e4e467f09489e3062759/archive/imo/imo2005_q4.lean#L44">here</a></p>
</blockquote>
<p>but but but... <a href="#narrow/stream/113488-general/topic/calc.20ZMOD.20bug/near/272408274">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc.20ZMOD.20bug/near/272408274</a> I think you got lucky because you never used consecutive ZMODs ?</p>



<a name="276245719"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276245719" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276245719">(Mar 22 2022 at 19:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276228172">said</a>:</p>
<blockquote>
<p>Btw, how does <code>calc</code> handle <code>≥</code>? Does it literally use <a href="https://leanprover-community.github.io/mathlib_docs/find/ge_trans">docs#ge_trans</a> or is there special support?</p>
</blockquote>
<p>The only special support for anything that <code>calc</code> seems to have is for <code>eq</code> (saving us from having to write a bunch of silly <code>trans</code> lemmas).</p>
<p>The way <code>calc</code> appears to work is that it takes pairs of consecutive relations in the <code>calc</code> (say <code>≥</code> and <code>≥</code>, or <code>≥ </code> and <code>&gt;</code>, or what have you) then looks for a <code>trans</code> lemma that takes that pair of relations. Whichever <code>trans</code> lemma matches then determines what the resulting composite relation is -- for example <a href="https://leanprover-community.github.io/mathlib_docs/find/ge_trans">docs#ge_trans</a> results in the <code>≥</code> relation.</p>



<a name="276246126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276246126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276246126">(Mar 22 2022 at 19:59)</a>:</h4>
<p><span class="user-mention" data-user-id="284160">@Eric Rodriguez</span> It looks like the problem with your example is that the relation isn't following the correct specification. The related terms have to be the last two explicit arguments, but the filter is coming last: <a href="https://github.com/leanprover-community/mathlib/blob/d586195418d55d8d56c2d412c35bffd9a516a3c5/src/analysis/asymptotics/asymptotic_equivalent.lean#L63">https://github.com/leanprover-community/mathlib/blob/d586195418d55d8d56c2d412c35bffd9a516a3c5/src/analysis/asymptotics/asymptotic_equivalent.lean#L63</a></p>



<a name="276246925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276246925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276246925">(Mar 22 2022 at 20:04)</a>:</h4>
<p><code>ZMOD</code> seems to work fine because the underlying relation is <code>modeq n a b</code>, that is, <code>a</code> and <code>b</code> come last.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">foo</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">n</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">≡</span> <span class="n">b</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">])</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">≡</span> <span class="n">c</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">])</span> <span class="o">(</span><span class="n">h3</span> <span class="o">:</span> <span class="n">c</span> <span class="bp">≡</span> <span class="n">d</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">])</span> <span class="o">:</span>
  <span class="n">a</span> <span class="bp">≡</span> <span class="n">d</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">]</span> <span class="o">:=</span>
<span class="k">calc</span> <span class="n">a</span> <span class="bp">≡</span> <span class="n">b</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">h1</span>
   <span class="bp">...</span> <span class="bp">≡</span> <span class="n">c</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">h2</span>
   <span class="bp">...</span> <span class="bp">≡</span> <span class="n">d</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">h3</span>
</code></pre></div>
<p>(Not sure what's going on with the metavariable problem in <span class="user-mention" data-user-id="110038">@Kevin Buzzard</span>'s examples.)</p>



<a name="276247179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276247179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276247179">(Mar 22 2022 at 20:06)</a>:</h4>
<p>I'm going to hazard a guess that <code>calc</code> just isn't unifying anything but the last two arguments of the relation.</p>



<a name="276247233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276247233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276247233">(Mar 22 2022 at 20:06)</a>:</h4>
<p>Oh, yep, that's it:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">foo</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">n</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">≡</span> <span class="n">b</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">])</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">≡</span> <span class="n">c</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">])</span> <span class="o">(</span><span class="n">h3</span> <span class="o">:</span> <span class="n">c</span> <span class="bp">≡</span> <span class="n">d</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">])</span> <span class="o">:</span>
  <span class="n">a</span> <span class="bp">≡</span> <span class="n">d</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="n">n</span><span class="o">]</span> <span class="o">:=</span>
<span class="k">calc</span> <span class="n">a</span> <span class="bp">≡</span> <span class="n">b</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="mi">37</span><span class="o">]</span> <span class="o">:</span> <span class="n">h1</span>
   <span class="bp">...</span> <span class="bp">≡</span> <span class="n">c</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="mi">22</span><span class="o">]</span> <span class="o">:</span> <span class="n">h2</span>
   <span class="bp">...</span> <span class="bp">≡</span> <span class="n">d</span> <span class="o">[</span><span class="n">ZMOD</span> <span class="mi">482</span><span class="o">]</span> <span class="o">:</span> <span class="n">h3</span>
</code></pre></div>



<a name="276247352"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276247352" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276247352">(Mar 22 2022 at 20:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="306601">Kyle Miller</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276246126">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="284160">Eric Rodriguez</span> It looks like the problem with your example is that the relation isn't following the correct specification. The related terms have to be the last two explicit arguments, but the filter is coming last: <a href="https://github.com/leanprover-community/mathlib/blob/d586195418d55d8d56c2d412c35bffd9a516a3c5/src/analysis/asymptotics/asymptotic_equivalent.lean#L63">https://github.com/leanprover-community/mathlib/blob/d586195418d55d8d56c2d412c35bffd9a516a3c5/src/analysis/asymptotics/asymptotic_equivalent.lean#L63</a></p>
</blockquote>
<p>On my branch it does</p>



<a name="276249173"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276249173" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276249173">(Mar 22 2022 at 20:22)</a>:</h4>
<p><span class="user-mention" data-user-id="284160">@Eric Rodriguez</span> I don't have a very good Lean environment on the computer I have with me -- what's the specific error you're seeing?</p>



<a name="276250071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276250071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276250071">(Mar 22 2022 at 20:31)</a>:</h4>
<p>(My guess is "failed to synthesize type class instance for normed_group ?m_1")</p>



<a name="276263373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276263373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276263373">(Mar 22 2022 at 22:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="306601">Kyle Miller</span> <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276250071">said</a>:</p>
<blockquote>
<p>(My guess is "failed to synthesize type class instance for normed_group ?m_1")</p>
</blockquote>
<p>nope:</p>
<p><a href="/user_uploads/3121/6L62lZuRza_wvvYnHA55Y2q6/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/6L62lZuRza_wvvYnHA55Y2q6/image.png" title="image.png"><img src="/user_uploads/3121/6L62lZuRza_wvvYnHA55Y2q6/image.png"></a></div>



<a name="276263397"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276263397" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276263397">(Mar 22 2022 at 22:29)</a>:</h4>
<p>i'll push that to the branch so everyone can see</p>



<a name="276313484"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276313484" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276313484">(Mar 23 2022 at 10:36)</a>:</h4>
<p>OK, so I changed things to fully work properly. There are some <code>@[trans]</code> tagged relations that don't follow the rules and I didn't want to change for argument order - if anyone has strong opinions on these, let me know:</p>
<ul>
<li><a href="https://leanprover-community.github.io/mathlib_docs/find/turing.evals_to_in_time">docs#turing.evals_to_in_time</a> - the spelling is really nice, but I don't know the TM side of mathlib at all. I left a note to those who do do it there.</li>
<li><a href="https://leanprover-community.github.io/mathlib_docs/find/set.eq_on">docs#set.eq_on</a> (this one I kind of wanted to change, as <code>s.eq_on</code> seems like a reasonable spelling to me! but I feel like the nicest spelling would be <code>f.eq g on s</code>, and that's not possible (I don't think?)</li>
<li><a href="https://leanprover-community.github.io/mathlib_docs/find/continuous_map.homotopic_with">docs#continuous_map.homotopic_with</a>, <a href="https://leanprover-community.github.io/mathlib_docs/find/continuous_map.homotopic_rel">docs#continuous_map.homotopic_rel</a>: I'm torn on these.</li>
</ul>



<a name="276314805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276314805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joachim Breitner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276314805">(Mar 23 2022 at 10:47)</a>:</h4>
<p>To avoid confusion: what works fully now? calc with <code>≃*</code>?</p>



<a name="276315179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276315179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276315179">(Mar 23 2022 at 10:50)</a>:</h4>
<p>nope, that's still prevented by the issue with needing <code>[]</code>s. there's currently two requirements on calc:</p>
<ul>
<li>the relation type's two last _explicit_ arguments must be the two things being related (that's what I'm talking about above): for example, the issue I had above is that <code>a =[f] b</code> used to be a type of the form <code>@filter_eq a b f</code> or whatever.</li>
<li>the last 5 arguments (<strong>not</strong> only explicit) of the <code>@[trans]</code> method must be equal to <code>a, b, c, R a b, R b c</code>. This is what's holding up <code>≃*</code>, and requires a change to core.</li>
</ul>



<a name="276367824"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276367824" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276367824">(Mar 23 2022 at 17:06)</a>:</h4>
<p>That "last two explicit argument" rule for relations seems to be shared by everything that uses the relation manager, so <code>refl</code>, <code>symm</code>, <code>trans</code>, the corresponding tactics, and <code>calc</code>. So, Eric's work on hammering out argument order for relations at least improves all these tactics.</p>
<p><code>calc</code> needs to be fixed (as <a href="#narrow/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60/near/276247233">this example</a> shows). There's a subtle issue that, for applications such as <code>mul_equiv</code>, we want to make sure <code>a</code>, <code>b</code>, and <code>c</code> get unified soon enough that typeclass inference involving them is able to succeed. Maybe all it needs to do is fill in the last three <em>explicit</em> arguments before the last two arguments, rather than the last three such.</p>



<a name="276374032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276374032" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276374032">(Mar 23 2022 at 17:49)</a>:</h4>
<p>is this true? this example compiles, and it's one of the examples above that explicitly haven't had their arg order changed:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">computability.tm_computable</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">turing.evals_to_in_time</span> <span class="o">(</span><span class="bp">@</span><span class="n">some</span> <span class="n">ℕ</span><span class="o">)</span> <span class="mi">0</span> <span class="bp">↑</span><span class="mi">0</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">refl</span>
<span class="kd">end</span>
</code></pre></div>



<a name="276374069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276374069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276374069">(Mar 23 2022 at 17:49)</a>:</h4>
<p><code>symmetry</code> does fail, though</p>



<a name="276374094"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276374094" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276374094">(Mar 23 2022 at 17:49)</a>:</h4>
<p>oh wait, that's not a symmetric relation <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="276374355"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276374355" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276374355">(Mar 23 2022 at 17:51)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">topology.homotopy.basic</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">X</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">{</span><span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">topological_space</span> <span class="n">X</span><span class="o">]</span> <span class="o">[</span><span class="n">topological_space</span> <span class="n">Y</span><span class="o">]</span> <span class="o">(</span><span class="n">f₀</span> <span class="n">f₁</span> <span class="o">:</span> <span class="n">C</span><span class="o">(</span><span class="n">X</span><span class="o">,</span> <span class="n">Y</span><span class="o">))</span>
        <span class="o">(</span><span class="n">P</span> <span class="o">:</span> <span class="n">C</span><span class="o">(</span><span class="n">X</span><span class="o">,</span> <span class="n">Y</span><span class="o">)</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">:</span> <span class="n">f₀.homotopic_with</span> <span class="n">f₁</span> <span class="n">P</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">symmetry</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="276374367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/calc%20with%20%60%E2%89%83%2A%60/near/276374367" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/calc.20with.20.60.E2.89.83*.60.html#276374367">(Mar 23 2022 at 17:51)</a>:</h4>
<p>this one does work, though</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>