---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html">diamond for monoid instance on ideals</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="269574250"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/269574250" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#269574250">(Jan 27 2022 at 13:52)</a>:</h4>
<p><span class="user-mention" data-user-id="406490">@María Inés de Frutos Fernández</span> seems to have found a diamond in recent mathlib; she bumped her adeles project and some of her code stopped working; mathlib is finding two instances of a monoid structure on ideals of the integers of a number field. </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">number_theory.number_field</span>
<span class="kn">import</span> <span class="n">ring_theory.dedekind_domain</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">[</span><span class="n">number_field</span> <span class="n">K</span><span class="o">]</span>

<span class="kn">open</span> <span class="n">number_field</span>

<span class="c1">-- X and Y both have type `monoid (ideal ↥(ring_of_integers K))`</span>

<span class="kd">def</span> <span class="n">X</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">monoid_with_zero.to_monoid</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">ideal</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">)))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_monoid_with_zero</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ideal</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">)))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">submodule.semiring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span><span class="bp">.</span><span class="n">to_comm_semiring</span>
          <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span><span class="bp">.</span><span class="n">to_semiring</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">number_field.ring_of_integers_algebra</span> <span class="n">K</span> <span class="n">K</span> <span class="n">_inst_1</span> <span class="n">_inst_1</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">algebra.id</span> <span class="n">K</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_comm_semiring</span> <span class="n">K</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">K</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)))))))</span>

<span class="c1">-- depends on `ideal.cancel_comm_monoid_with_zero` so noncomputable</span>
<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">Y</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">monoid_with_zero.to_monoid</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">ideal</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">)))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">comm_monoid_with_zero.to_monoid_with_zero</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ideal</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">)))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">cancel_comm_monoid_with_zero.to_comm_monoid_with_zero</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">ideal</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_semiring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span><span class="bp">.</span><span class="n">to_comm_ring</span><span class="o">)))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">ideal.cancel_comm_monoid_with_zero</span> <span class="bp">↥</span><span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">ring_of_integers</span> <span class="n">K</span> <span class="n">_inst_1</span><span class="o">)</span><span class="bp">.</span><span class="n">to_comm_ring</span>
             <span class="n">_</span>
             <span class="n">_</span><span class="o">)))</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">=</span> <span class="n">Y</span> <span class="o">:=</span> <span class="n">rfl</span> <span class="c1">-- fails</span>
</code></pre></div>
<p>One is computable, the other isn't. She's worked around the issue with some cunning priority-setting but because the code used to work this is probably a consequence of a relatively recent commit.<br>
The fix was</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">local</span> <span class="kn">attribute</span> <span class="o">[</span><span class="kd">instance</span><span class="o">,</span> <span class="n">priority</span> <span class="mi">10000</span><span class="o">]</span> <span class="n">comm_monoid_with_zero.to_monoid_with_zero</span>
</code></pre></div>



<a name="269574894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/269574894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#269574894">(Jan 27 2022 at 13:57)</a>:</h4>
<p>I wonder if this is due to my ring of integers algebra instance? (<a href="https://leanprover-community.github.io/mathlib_docs/find/number_field.ring_of_integers_algebra">docs#number_field.ring_of_integers_algebra</a>). what happens if she turns it off?</p>



<a name="269574964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/269574964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#269574964">(Jan 27 2022 at 13:57)</a>:</h4>
<p>(also, it seems the pretty-printing bug from the widget has spread to the docs website :()</p>



<a name="269607642"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/269607642" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> María Inés de Frutos Fernández <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#269607642">(Jan 27 2022 at 17:30)</a>:</h4>
<p>Thanks, <span class="user-mention" data-user-id="284160">@Eric Rodriguez</span> . Yes, it seems it was caused by the <code>ring_of_integers_algebra</code> instance; I commented it out and the error went away (Is this what you meant by "turning it off"?).</p>



<a name="269608173"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/269608173" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#269608173">(Jan 27 2022 at 17:34)</a>:</h4>
<p>You can also do <code>local attribute [-instance] ring_of_integers_algebra</code> within a file or section to turn an instance of locally but still have it availiable elsewhere</p>



<a name="269608192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/269608192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#269608192">(Jan 27 2022 at 17:34)</a>:</h4>
<p>you should able to just do <code>attribute [-instance] ring_of_integers_algebra</code>. I added it for a reason I later realised was mathematically wrong, so if it's causing diamonds I think we should definitely consider either fully removing it or just making a <code>def</code>.</p>



<a name="269608465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/269608465" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#269608465">(Jan 27 2022 at 17:36)</a>:</h4>
<p>How exactly is the diamond related to that algebra instance?</p>



<a name="269608708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/269608708" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#269608708">(Jan 27 2022 at 17:38)</a>:</h4>
<p><code>algebra K K</code> inducing <code>algebra O K O K</code>, it seems</p>



<a name="269608862"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/269608862" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> María Inés de Frutos Fernández <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#269608862">(Jan 27 2022 at 17:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="284160">Eric Rodriguez</span> <a href="#narrow/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals/near/269608192">said</a>:</p>
<blockquote>
<p>you should able to just do <code>attribute [-instance] ring_of_integers_algebra</code>. </p>
</blockquote>
<p>Thanks! I didn't know about this.</p>



<a name="273414112"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/273414112" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#273414112">(Feb 27 2022 at 17:06)</a>:</h4>
<p>I think this diamond with <a href="https://leanprover-community.github.io/mathlib_docs/find/subalgebra.algebra'">docs#subalgebra.algebra'</a> is fundamentally the same problem:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.algebra.subalgebra</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_semiring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_semiring</span> <span class="n">A</span><span class="o">]</span> <span class="o">[</span><span class="n">algebra</span> <span class="n">R</span> <span class="n">A</span><span class="o">]</span> <span class="o">(</span><span class="n">S</span> <span class="o">:</span> <span class="n">subalgebra</span> <span class="n">A</span> <span class="n">A</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">algebra.id</span> <span class="n">S</span><span class="o">)</span> <span class="bp">=</span> <span class="n">subalgebra.algebra'</span> <span class="n">_</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">change</span> <span class="n">algebra.mk</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="bp">=</span> <span class="n">algebra.mk</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span>
  <span class="n">congr'</span> <span class="mi">1</span><span class="o">,</span>
  <span class="n">ext</span> <span class="o">:</span> <span class="mi">1</span><span class="o">,</span>
  <span class="n">change</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">subtype.mk</span> <span class="n">x</span> <span class="n">_</span><span class="o">,</span>
  <span class="n">refl</span><span class="o">,</span> <span class="c1">-- fails</span>
<span class="kd">end</span>
</code></pre></div>
<p>which is the fact that <a href="https://leanprover-community.github.io/mathlib_docs/find/subtype.coe_eta">docs#subtype.coe_eta</a> is not true definitionally (until Lean 4).</p>



<a name="273414255"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/273414255" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#273414255">(Feb 27 2022 at 17:09)</a>:</h4>
<p>can we hack definitional eta into Lean3 whilst we wait for mathport? or is this just ridiculous?</p>



<a name="273416482"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/diamond%20for%20monoid%20instance%20on%20ideals/near/273416482" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/diamond.20for.20monoid.20instance.20on.20ideals.html#273416482">(Feb 27 2022 at 17:57)</a>:</h4>
<p>This seems to be caused by <a href="#narrow/stream/113488-general/topic/instance.20diamond.20in.20algebra.2Eid.20for.20subtypes/near/273414112">a diamond in subtypes with<code>algebra.id</code></a> (moved out of this thread)</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>