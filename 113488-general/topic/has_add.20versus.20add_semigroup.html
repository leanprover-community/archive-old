---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/has_add.20versus.20add_semigroup.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html">has_add versus add_semigroup</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="267124647"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267124647" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Martin Dvořák <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267124647">(Jan 06 2022 at 22:35)</a>:</h4>
<p>In my PR <a href="https://github.com/leanprover-community/mathlib/pull/11181">https://github.com/leanprover-community/mathlib/pull/11181</a> we ran into a weird behavior that we don't understand. I attempted to make a MWE from it.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.algebra.basic</span>
<span class="kn">import</span> <span class="n">data.matrix.notation</span>
<span class="kn">import</span> <span class="n">linear_algebra.bilinear_map</span>


<span class="kd">variable</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>

<span class="kd">lemma</span> <span class="n">vec3_eq</span> <span class="o">{</span><span class="n">a₀</span> <span class="n">a₁</span> <span class="n">a₂</span> <span class="n">b₀</span> <span class="n">b₁</span> <span class="n">b₂</span> <span class="o">:</span> <span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">h₀</span> <span class="o">:</span> <span class="n">a₀</span> <span class="bp">=</span> <span class="n">b₀</span><span class="o">)</span> <span class="o">(</span><span class="n">h₁</span> <span class="o">:</span> <span class="n">a₁</span> <span class="bp">=</span> <span class="n">b₁</span><span class="o">)</span> <span class="o">(</span><span class="n">h₂</span> <span class="o">:</span> <span class="n">a₂</span> <span class="bp">=</span> <span class="n">b₂</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span><span class="o">,</span> <span class="n">a₁</span><span class="o">,</span> <span class="n">a₂</span><span class="o">]</span> <span class="bp">=</span> <span class="bp">!</span><span class="o">[</span><span class="n">b₀</span><span class="o">,</span> <span class="n">b₁</span><span class="o">,</span> <span class="n">b₂</span><span class="o">]</span> <span class="o">:=</span> <span class="gr">sorry</span>

<span class="c1">--variable [has_add α]</span>
<span class="kd">variable</span> <span class="o">[</span><span class="n">add_semigroup</span> <span class="n">α</span><span class="o">]</span>

<span class="kd">lemma</span> <span class="n">vec3_add</span> <span class="o">{</span><span class="n">a₀</span> <span class="n">a₁</span> <span class="n">a₂</span> <span class="n">b₀</span> <span class="n">b₁</span> <span class="n">b₂</span> <span class="o">:</span> <span class="n">α</span><span class="o">}</span> <span class="o">:</span>
  <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span><span class="o">,</span> <span class="n">a₁</span><span class="o">,</span> <span class="n">a₂</span><span class="o">]</span> <span class="bp">+</span> <span class="bp">!</span><span class="o">[</span><span class="n">b₀</span><span class="o">,</span> <span class="n">b₁</span><span class="o">,</span> <span class="n">b₂</span><span class="o">]</span> <span class="bp">=</span> <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span> <span class="bp">+</span> <span class="n">b₀</span><span class="o">,</span> <span class="n">a₁</span> <span class="bp">+</span> <span class="n">b₁</span><span class="o">,</span> <span class="n">a₂</span> <span class="bp">+</span> <span class="n">b₂</span><span class="o">]</span> <span class="o">:=</span> <span class="gr">sorry</span>


<span class="kd">variables</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span>

<span class="kd">def</span> <span class="n">cross_product</span> <span class="o">:</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span> <span class="bp">→ₗ</span><span class="o">[</span><span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span> <span class="bp">→ₗ</span><span class="o">[</span><span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">apply</span> <span class="n">linear_map.mk₂</span> <span class="n">R</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">),</span>
    <span class="bp">!</span><span class="o">[</span><span class="n">a</span> <span class="mi">1</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">2</span> <span class="bp">-</span> <span class="n">a</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">a</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">0</span> <span class="bp">-</span> <span class="n">a</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">2</span><span class="o">,</span>
      <span class="n">a</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">1</span> <span class="bp">-</span> <span class="n">a</span> <span class="mi">1</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">0</span><span class="o">]),</span>
  <span class="o">{</span> <span class="n">intros</span><span class="o">,</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">pi.add_apply</span><span class="o">],</span>
    <span class="n">rw</span> <span class="n">vec3_add</span><span class="o">,</span>     <span class="c1">-- this fails when [has_add α] is used</span>
    <span class="n">apply</span> <span class="n">vec3_eq</span><span class="bp">;</span>
    <span class="n">ring</span><span class="o">,</span>
   <span class="o">},</span> <span class="gr">sorry</span><span class="o">,</span> <span class="gr">sorry</span><span class="o">,</span> <span class="gr">sorry</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>The application of the lemma <code>vec3_add</code> requires associativity. The problem is that it depends on the instance for <code>α</code>. It isn't sufficient to provide a correct instance of <code>R</code>. If we replace <code>[add_semigroup α]</code> by <code>[has_add α]</code> then it fails in the place of application of  <code>vec3_add</code>. The proof of  <code>vec3_add</code> is all right either way.</p>
<p>Any idea why it happens?</p>



<a name="267125289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267125289" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Martin Dvořák <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267125289">(Jan 06 2022 at 22:42)</a>:</h4>
<p>It is also worth noting that the bug does not appear when we do the same proof in the following way (separate definition of cross product and lemma for linearity in the first argument).</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.algebra.basic</span>
<span class="kn">import</span> <span class="n">data.matrix.notation</span>
<span class="kn">import</span> <span class="n">linear_algebra.bilinear_map</span>


<span class="kd">variable</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>

<span class="kd">lemma</span> <span class="n">vec3_eq</span> <span class="o">{</span><span class="n">a₀</span> <span class="n">a₁</span> <span class="n">a₂</span> <span class="n">b₀</span> <span class="n">b₁</span> <span class="n">b₂</span> <span class="o">:</span> <span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">h₀</span> <span class="o">:</span> <span class="n">a₀</span> <span class="bp">=</span> <span class="n">b₀</span><span class="o">)</span> <span class="o">(</span><span class="n">h₁</span> <span class="o">:</span> <span class="n">a₁</span> <span class="bp">=</span> <span class="n">b₁</span><span class="o">)</span> <span class="o">(</span><span class="n">h₂</span> <span class="o">:</span> <span class="n">a₂</span> <span class="bp">=</span> <span class="n">b₂</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span><span class="o">,</span> <span class="n">a₁</span><span class="o">,</span> <span class="n">a₂</span><span class="o">]</span> <span class="bp">=</span> <span class="bp">!</span><span class="o">[</span><span class="n">b₀</span><span class="o">,</span> <span class="n">b₁</span><span class="o">,</span> <span class="n">b₂</span><span class="o">]</span> <span class="o">:=</span> <span class="gr">sorry</span>

<span class="kd">variable</span> <span class="o">[</span><span class="n">has_add</span> <span class="n">α</span><span class="o">]</span>
<span class="c1">--variable [add_semigroup α]</span>

<span class="kd">lemma</span> <span class="n">vec3_add</span> <span class="o">{</span><span class="n">a₀</span> <span class="n">a₁</span> <span class="n">a₂</span> <span class="n">b₀</span> <span class="n">b₁</span> <span class="n">b₂</span> <span class="o">:</span> <span class="n">α</span><span class="o">}</span> <span class="o">:</span>
  <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span><span class="o">,</span> <span class="n">a₁</span><span class="o">,</span> <span class="n">a₂</span><span class="o">]</span> <span class="bp">+</span> <span class="bp">!</span><span class="o">[</span><span class="n">b₀</span><span class="o">,</span> <span class="n">b₁</span><span class="o">,</span> <span class="n">b₂</span><span class="o">]</span> <span class="bp">=</span> <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span> <span class="bp">+</span> <span class="n">b₀</span><span class="o">,</span> <span class="n">a₁</span> <span class="bp">+</span> <span class="n">b₁</span><span class="o">,</span> <span class="n">a₂</span> <span class="bp">+</span> <span class="n">b₂</span><span class="o">]</span> <span class="o">:=</span> <span class="gr">sorry</span>


<span class="kd">variables</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span>

<span class="kd">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span>
    <span class="bp">!</span><span class="o">[</span><span class="n">a</span> <span class="mi">1</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">2</span> <span class="bp">-</span> <span class="n">a</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">a</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">0</span> <span class="bp">-</span> <span class="n">a</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">2</span><span class="o">,</span>
      <span class="n">a</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">1</span> <span class="bp">-</span> <span class="n">a</span> <span class="mi">1</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">0</span><span class="o">]</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">a₁</span> <span class="n">a₂</span> <span class="n">b</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span> <span class="n">foo</span> <span class="o">(</span><span class="n">a₁</span> <span class="bp">+</span> <span class="n">a₂</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">foo</span> <span class="n">a₁</span> <span class="n">b</span> <span class="bp">+</span> <span class="n">foo</span> <span class="n">a₂</span> <span class="n">b</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">unfold</span> <span class="n">foo</span><span class="o">,</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">pi.add_apply</span><span class="o">],</span>
  <span class="n">rw</span> <span class="n">vec3_add</span><span class="o">,</span>     <span class="c1">-- this works either way</span>
  <span class="n">apply</span> <span class="n">vec3_eq</span><span class="bp">;</span>
  <span class="n">ring</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="267126247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267126247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267126247">(Jan 06 2022 at 22:51)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">variable</span> <span class="o">[</span><span class="n">has_add</span> <span class="n">α</span><span class="o">]</span>
<span class="kd">variable</span> <span class="o">[</span><span class="n">add_semigroup</span> <span class="n">α</span><span class="o">]</span>
</code></pre></div>
<p>is wrong. It means "assume alpha is an additive semigroup and assume on top of this that alpha has a completely unrelated addition on it which satisfies no axioms". Once you do this then you have no control over what <code>a + b</code> means if <code>a b : alpha</code>; Lean will pick up a random one of the two additions and you don't know which one it is. </p>
<p><code>add_semigroup</code> <em>extends</em> <code>has_add</code>, which means that you should not put a <code>has_add alpha</code> assumption in if you have an <code>add_semigroup alpha</code> in.</p>



<a name="267126340"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267126340" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Martin Dvořák <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267126340">(Jan 06 2022 at 22:52)</a>:</h4>
<p>We always use only one of them. The bug appears when we comment out one and uncomment the other.</p>



<a name="267126586"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267126586" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267126586">(Jan 06 2022 at 22:55)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">variable</span> <span class="o">[</span><span class="n">has_add</span> <span class="n">α</span><span class="o">]</span>
<span class="c1">--variable [add_semigroup α]</span>

<span class="kd">lemma</span> <span class="n">vec3_add</span> <span class="o">{</span><span class="n">a₀</span> <span class="n">a₁</span> <span class="n">a₂</span> <span class="n">b₀</span> <span class="n">b₁</span> <span class="n">b₂</span> <span class="o">:</span> <span class="n">α</span><span class="o">}</span> <span class="o">:</span>
  <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span><span class="o">,</span> <span class="n">a₁</span><span class="o">,</span> <span class="n">a₂</span><span class="o">]</span> <span class="bp">+</span> <span class="bp">!</span><span class="o">[</span><span class="n">b₀</span><span class="o">,</span> <span class="n">b₁</span><span class="o">,</span> <span class="n">b₂</span><span class="o">]</span> <span class="bp">=</span> <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span> <span class="bp">+</span> <span class="n">b₀</span><span class="o">,</span> <span class="n">a₁</span> <span class="bp">+</span> <span class="n">b₁</span><span class="o">,</span> <span class="n">a₂</span> <span class="bp">+</span> <span class="n">b₂</span><span class="o">]</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">ext</span> <span class="n">x</span><span class="o">,</span>
  <span class="n">fin_cases</span> <span class="n">x</span><span class="bp">;</span>
  <span class="n">refl</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>btw</p>



<a name="267126742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267126742" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Martin Dvořák <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267126742">(Jan 06 2022 at 22:57)</a>:</h4>
<p>Why did you add a proof of the lemma? Proving the lemma was not an issue; using the lemma was.</p>



<a name="267126964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267126964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267126964">(Jan 06 2022 at 23:00)</a>:</h4>
<p>because I wondered whether that would change things. Sometimes sorrys can confuse Lean.</p>



<a name="267127095"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267127095" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267127095">(Jan 06 2022 at 23:01)</a>:</h4>
<p>This works:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">cross_product</span> <span class="o">:</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span> <span class="bp">→ₗ</span><span class="o">[</span><span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span> <span class="bp">→ₗ</span><span class="o">[</span><span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">apply</span> <span class="n">linear_map.mk₂</span> <span class="n">R</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">3</span> <span class="bp">→</span> <span class="n">R</span><span class="o">),</span>
    <span class="bp">!</span><span class="o">[</span><span class="n">a</span> <span class="mi">1</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">2</span> <span class="bp">-</span> <span class="n">a</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">a</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">0</span> <span class="bp">-</span> <span class="n">a</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">2</span><span class="o">,</span>
      <span class="n">a</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">1</span> <span class="bp">-</span> <span class="n">a</span> <span class="mi">1</span> <span class="bp">*</span> <span class="n">b</span> <span class="mi">0</span><span class="o">]),</span>
  <span class="o">{</span> <span class="n">intros</span><span class="o">,</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">pi.add_apply</span><span class="o">],</span>
    <span class="n">symmetry</span><span class="o">,</span>
    <span class="n">convert</span> <span class="bp">@</span><span class="n">vec3_add</span> <span class="n">R</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="bp">;</span>
    <span class="n">ring</span><span class="o">,</span>
   <span class="o">},</span> <span class="gr">sorry</span><span class="o">,</span> <span class="gr">sorry</span><span class="o">,</span> <span class="gr">sorry</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="267127286"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267127286" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Martin Dvořák <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267127286">(Jan 06 2022 at 23:03)</a>:</h4>
<p>In the full file, we have proofs. I omitted them for the sake of MWE.</p>



<a name="267127306"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267127306" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Martin Dvořák <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267127306">(Jan 06 2022 at 23:03)</a>:</h4>
<p>But it seems you eliminated the use of <code>vec3_eq</code> altogether, thanks!</p>



<a name="267127641"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267127641" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267127641">(Jan 06 2022 at 23:07)</a>:</h4>
<p>More minimal:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">data.matrix.notation</span>

<span class="kd">variable</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>

<span class="kd">lemma</span> <span class="n">vec2_add</span> <span class="o">[</span><span class="n">has_add</span> <span class="n">α</span><span class="o">]</span> <span class="o">{</span><span class="n">a₀</span> <span class="n">a₁</span> <span class="n">b₀</span> <span class="n">b₁</span> <span class="o">:</span> <span class="n">α</span><span class="o">}</span> <span class="o">:</span>
  <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span><span class="o">,</span> <span class="n">a₁</span><span class="o">]</span> <span class="bp">+</span> <span class="bp">!</span><span class="o">[</span><span class="n">b₀</span><span class="o">,</span> <span class="n">b₁</span><span class="o">]</span> <span class="bp">=</span> <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span> <span class="bp">+</span> <span class="n">b₀</span><span class="o">,</span> <span class="n">a₁</span> <span class="bp">+</span> <span class="n">b₁</span><span class="o">]</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">simp</span>

<span class="kd">lemma</span> <span class="n">vec2_add'</span> <span class="o">[</span><span class="n">add_semigroup</span> <span class="n">α</span><span class="o">]</span> <span class="o">{</span><span class="n">a₀</span> <span class="n">a₁</span> <span class="n">b₀</span> <span class="n">b₁</span> <span class="o">:</span> <span class="n">α</span><span class="o">}</span> <span class="o">:</span>
  <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span><span class="o">,</span> <span class="n">a₁</span><span class="o">]</span> <span class="bp">+</span> <span class="bp">!</span><span class="o">[</span><span class="n">b₀</span><span class="o">,</span> <span class="n">b₁</span><span class="o">]</span> <span class="bp">=</span> <span class="bp">!</span><span class="o">[</span><span class="n">a₀</span> <span class="bp">+</span> <span class="n">b₀</span><span class="o">,</span> <span class="n">a₁</span> <span class="bp">+</span> <span class="n">b₁</span><span class="o">]</span> <span class="o">:=</span> <span class="n">vec2_add</span>

<span class="kd">def</span> <span class="n">vec2_id</span> <span class="o">[</span><span class="n">add_monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">2</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="bp">→+</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">2</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="bp">!</span><span class="o">[</span><span class="n">a</span> <span class="mi">0</span><span class="o">,</span> <span class="n">a</span> <span class="mi">1</span><span class="o">],</span>
  <span class="n">map_zero'</span> <span class="o">:=</span> <span class="gr">sorry</span><span class="o">,</span>
  <span class="n">map_add'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span>
  <span class="kd">begin</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">pi.add_apply</span><span class="o">],</span>
    <span class="n">rw</span> <span class="n">vec2_add</span><span class="o">,</span>    <span class="c1">-- this fails</span>
    <span class="c1">-- rw vec2_add',     -- this works</span>
  <span class="kd">end</span> <span class="o">}</span>
</code></pre></div>



<a name="267127819"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267127819" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Martin Dvořák <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267127819">(Jan 06 2022 at 23:08)</a>:</h4>
<p>I will use Kevin's suggestion; nevertheless, I would still like to know why it failed as it was.</p>



<a name="267127904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267127904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267127904">(Jan 06 2022 at 23:09)</a>:</h4>
<p>Yes, I think it's worth understanding what's going wrong here</p>



<a name="267128003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267128003" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267128003">(Jan 06 2022 at 23:10)</a>:</h4>
<p>I might be wrong but looking at the (absolutely huge!) terms generated by pp.all I'm wondering whether the issue is that ![a,b,c] generates a 3 which is a different kind of 3 to the 3 in <code>fin 3</code>.</p>



<a name="267128216"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267128216" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267128216">(Jan 06 2022 at 23:12)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">rewrite</span> <span class="n">tactic</span> <span class="n">failed</span><span class="o">,</span> <span class="n">did</span> <span class="n">not</span> <span class="n">find</span> <span class="kd">instance</span> <span class="n">of</span> <span class="n">the</span> <span class="n">pattern</span> <span class="k">in</span> <span class="n">the</span> <span class="n">target</span> <span class="n">expression</span>
  <span class="bp">@</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="o">(</span><span class="n">fin</span> <span class="o">(</span><span class="n">nat.succ</span> <span class="o">(</span><span class="n">nat.succ</span> <span class="o">(</span><span class="n">nat.succ</span> <span class="o">(</span><span class="bp">@</span><span class="n">has_zero.zero.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat.has_zero</span><span class="o">))))</span> <span class="bp">→</span> <span class="n">R</span><span class="o">)</span>
<span class="bp">...</span>
<span class="o">(</span><span class="bp">@</span><span class="n">has_add.add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">add_zero_class.to_has_add.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span>
                   <span class="o">((</span><span class="bp">λ</span> <span class="o">(</span><span class="n">ᾰ</span> <span class="o">:</span> <span class="n">fin</span> <span class="o">(</span><span class="bp">@</span><span class="n">bit1.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat.has_one</span> <span class="n">nat.has_add</span> <span class="o">(</span><span class="bp">@</span><span class="n">has_one.one.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat.has_one</span><span class="o">))),</span> <span class="n">R</span><span class="o">)</span>
                      <span class="o">(</span><span class="bp">@</span><span class="n">has_one.one.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="n">fin</span> <span class="o">(</span><span class="bp">@</span><span class="n">bit1.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat.has_one</span> <span class="n">nat.has_add</span> <span class="o">(</span><span class="bp">@</span><span class="n">has_one.one.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat.has_one</span><span class="o">)))</span>
</code></pre></div>
<p>but I might be wrong, maybe <code>rw</code> would be expected to unify <code>fin (bit1 1)</code> and <code>fin (succ succ succ 0)</code>.</p>



<a name="267128398"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267128398" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267128398">(Jan 06 2022 at 23:14)</a>:</h4>
<p>That's not it</p>



<a name="267128406"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267128406" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267128406">(Jan 06 2022 at 23:14)</a>:</h4>
<p>It's a dependent type problem again</p>



<a name="267128455"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267128455" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267128455">(Jan 06 2022 at 23:15)</a>:</h4>
<p>In my example,</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">pp.implicit</span> <span class="n">true</span>
<span class="kd">set_option</span> <span class="n">pp.notation</span> <span class="n">false</span>

<span class="kd">def</span> <span class="n">vec2_id</span> <span class="o">[</span><span class="n">add_monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="n">fin</span> <span class="o">(</span><span class="n">succ</span> <span class="o">(</span><span class="n">succ</span> <span class="mi">0</span><span class="o">))</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="bp">→+</span> <span class="o">(</span><span class="n">fin</span> <span class="o">(</span><span class="n">succ</span> <span class="o">(</span><span class="n">succ</span> <span class="mi">0</span><span class="o">))</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="bp">!</span><span class="o">[</span><span class="n">a</span> <span class="mi">0</span><span class="o">,</span> <span class="n">a</span> <span class="mi">1</span><span class="o">],</span>
  <span class="n">map_zero'</span> <span class="o">:=</span> <span class="gr">sorry</span><span class="o">,</span>
  <span class="n">map_add'</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span>
  <span class="kd">begin</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">pi.add_apply</span><span class="o">],</span>
    <span class="n">rw</span> <span class="n">vec2_add</span><span class="o">,</span>    <span class="c1">-- this fails</span>
    <span class="c1">-- rw vec2_add',     -- this works</span>
  <span class="kd">end</span> <span class="o">}</span>
</code></pre></div>
<p>gives:</p>
<div class="spoiler-block"><div class="spoiler-header">
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">rewrite</span> <span class="n">tactic</span> <span class="n">failed</span><span class="o">,</span> <span class="n">did</span> <span class="n">not</span> <span class="n">find</span> <span class="kd">instance</span> <span class="n">of</span> <span class="n">the</span> <span class="n">pattern</span> <span class="k">in</span> <span class="n">the</span> <span class="n">target</span> <span class="n">expression</span>
  <span class="bp">@</span><span class="n">has_add.add</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span> <span class="bp">→</span> <span class="bp">?</span><span class="n">m_1</span><span class="o">)</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">pi.has_add</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">ᾰ</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span><span class="o">),</span> <span class="bp">?</span><span class="n">m_1</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span><span class="o">),</span> <span class="bp">?</span><span class="n">m_2</span><span class="o">))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_cons</span> <span class="bp">?</span><span class="n">m_1</span> <span class="mi">1</span> <span class="bp">?</span><span class="n">m_3</span> <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_cons</span> <span class="bp">?</span><span class="n">m_1</span> <span class="mi">0</span> <span class="bp">?</span><span class="n">m_4</span> <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_empty</span> <span class="bp">?</span><span class="n">m_1</span><span class="o">)))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_cons</span> <span class="bp">?</span><span class="n">m_1</span> <span class="mi">1</span> <span class="bp">?</span><span class="n">m_5</span> <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_cons</span> <span class="bp">?</span><span class="n">m_1</span> <span class="mi">0</span> <span class="bp">?</span><span class="n">m_6</span> <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_empty</span> <span class="bp">?</span><span class="n">m_1</span><span class="o">)))</span>
<span class="n">state</span><span class="o">:</span>
<span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_1</span><span class="o">,</span>
<span class="n">_inst_1</span> <span class="o">:</span> <span class="n">add_monoid</span> <span class="n">α</span><span class="o">,</span>
<span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span> <span class="bp">→</span> <span class="n">α</span>
<span class="bp">⊢</span> <span class="bp">@</span><span class="n">eq</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_cons</span> <span class="n">α</span> <span class="mi">1</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">has_add.add</span> <span class="n">α</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">add_zero_class.to_has_add</span> <span class="o">((</span><span class="bp">λ</span> <span class="o">(</span><span class="n">ᾰ</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="mi">0</span><span class="o">)</span>
             <span class="o">((</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span><span class="o">),</span> <span class="bp">@</span><span class="n">add_monoid.to_add_zero_class</span> <span class="n">α</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="mi">0</span><span class="o">))</span>
          <span class="o">(</span><span class="n">a</span> <span class="mi">0</span><span class="o">)</span>
          <span class="o">(</span><span class="n">b</span> <span class="mi">0</span><span class="o">))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_cons</span> <span class="n">α</span> <span class="mi">0</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">has_add.add</span> <span class="n">α</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">add_zero_class.to_has_add</span> <span class="o">((</span><span class="bp">λ</span> <span class="o">(</span><span class="n">ᾰ</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="mi">0</span><span class="o">)</span>
                <span class="o">((</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span><span class="o">),</span> <span class="bp">@</span><span class="n">add_monoid.to_add_zero_class</span> <span class="n">α</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="mi">0</span><span class="o">))</span>
             <span class="o">(</span><span class="n">a</span> <span class="mi">1</span><span class="o">)</span>
             <span class="o">(</span><span class="n">b</span> <span class="mi">1</span><span class="o">))</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_empty</span> <span class="n">α</span><span class="o">)))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">has_add.add</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">add_zero_class.to_has_add</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">pi.add_zero_class</span> <span class="o">(</span><span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">ᾰ</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
             <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">1</span><span class="bp">.</span><span class="n">succ</span><span class="o">),</span> <span class="bp">@</span><span class="n">add_monoid.to_add_zero_class</span> <span class="n">α</span> <span class="n">_inst_1</span><span class="o">)))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_cons</span> <span class="n">α</span> <span class="mi">1</span> <span class="o">(</span><span class="n">a</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_cons</span> <span class="n">α</span> <span class="mi">0</span> <span class="o">(</span><span class="n">a</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_empty</span> <span class="n">α</span><span class="o">)))</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_cons</span> <span class="n">α</span> <span class="mi">1</span> <span class="o">(</span><span class="n">b</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_cons</span> <span class="n">α</span> <span class="mi">0</span> <span class="o">(</span><span class="n">b</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">matrix.vec_empty</span> <span class="n">α</span><span class="o">))))</span>
</code></pre></div>
</div></div>
<p>It can't unify <code>pi.add_zero_class.to_has_add</code> with <code>pi.has_add</code></p>



<a name="267128664"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267128664" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267128664">(Jan 06 2022 at 23:17)</a>:</h4>
<p><code>rw vec2_add (_ : α)</code> works, if you make the arguments to <code>vec2_add</code> explicit (which they should be anyway)</p>



<a name="267129536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267129536" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Martin Dvořák <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267129536">(Jan 06 2022 at 23:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110038">Kevin Buzzard</span> <a href="#narrow/stream/113488-general/topic/has_add.20versus.20add_semigroup/near/267126964">said</a>:</p>
<blockquote>
<p>because I wondered whether that would change things. Sometimes sorrys can confuse Lean.</p>
</blockquote>
<p>Does <code>sorry</code> in a proof of a lemma have a capacity to change how the lemma works when it is applied??</p>



<a name="267129605"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267129605" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267129605">(Jan 06 2022 at 23:29)</a>:</h4>
<p>I don't think it can in a <code>lemma</code>, but it <em>can</em> in a <code>def</code> or <code>example</code>, because lean doesn't commit to the type of a def until it's seen the whole thing (which is why <code>def x := 1</code> is allowed even though it doesn't specify the type, but <code>lemma foo := rfl</code> is not)</p>



<a name="267130722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267130722" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267130722">(Jan 06 2022 at 23:43)</a>:</h4>
<p>Since that <code>noncomputable</code> weirdness that Gabriel fixed with <code>force_noncomputable</code> I've been a lot more paranoid about filling in sorries when I see unexpected errors</p>



<a name="267130878"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267130878" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267130878">(Jan 06 2022 at 23:44)</a>:</h4>
<p>I can't think of too many, but here's a slightly niche example of where sorrying a lemma makes it behave differently:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">constant</span> <span class="n">X</span> <span class="o">:</span> <span class="kt">Type</span>
<span class="kd">def</span> <span class="n">f</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">X</span> <span class="o">:=</span> <span class="n">id</span>
<span class="kd">@[simp]</span>
<span class="kd">lemma</span> <span class="n">a</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">:=</span> <span class="gr">sorry</span><span class="c1">--rfl</span>
<span class="kd">lemma</span> <span class="n">b</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">dsimp</span><span class="o">,</span>
  <span class="n">refl</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="267130907"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267130907" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267130907">(Jan 06 2022 at 23:45)</a>:</h4>
<p>When you prove something by <code>rfl</code> Lean tags it with an attribute which makes <code>dsimp</code> try to use it.</p>



<a name="267130921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267130921" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267130921">(Jan 06 2022 at 23:45)</a>:</h4>
<p>But yeah most of the time sorrying lemmas for MWEs is fine if the proof is long</p>



<a name="267171070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267171070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267171070">(Jan 07 2022 at 10:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/has_add.20versus.20add_semigroup/near/267128664">said</a>:</p>
<blockquote>
<p><code>rw vec2_add (_ : α)</code> works, if you make the arguments to <code>vec2_add</code> explicit (which they should be anyway)</p>
</blockquote>
<p>More details: normally a unification problem along the lines of <code>has_add.add α ?m_1 =?= add_semigroup.add α ?m_3</code> will trigger the instances <code>?m_1</code> and <code>?m_3</code> to be inferred, and then unfolding the definitions should result in equality. Here however, the goal looks like <code>has_add.add α ?m_1 =?= add_semigroup.add ?m_2 ?m_3</code>, so the right-hand side can't be inferred, and unification fails.</p>
<p>This kind of issue also broke a few proofs in <a href="https://github.com/leanprover-community/mathlib/pull/11238">#11238</a>, due to an inheritance path that used to result in unifying <code>linear_order.le α ?m_1 =?= linear_order.le ?m_2 ?m_3</code> (head is the same, so unify <code>α =?= ?m_2</code>, now <code>?m_3</code> is inferrable/unifiable, done) to be instead <code>linear_order.le α ?m_1 =?= ordered_ring.le ?m_2 ?m_3</code>.</p>



<a name="267171402"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267171402" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267171402">(Jan 07 2022 at 10:08)</a>:</h4>
<p>So why can't we just use the types of <code>has_add.add</code> and <code>add_semigroup.add</code> to determine <code>α =?= ?m_2</code>? Perhaps because the types might depend on other fields of the class and you get the same problem recursively?</p>



<a name="267173966"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/has_add%20versus%20add_semigroup/near/267173966" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/has_add.20versus.20add_semigroup.html#267173966">(Jan 07 2022 at 10:34)</a>:</h4>
<p>My guess is that it gets stuck on unifying the dependent types in <a href="https://leanprover-community.github.io/mathlib_docs/find/pi.has_add">docs#pi.has_add</a>, and that if we had a separate <code>function.has_add</code> instance without the dependent types then the problem would go away. I can't test that theory because my internet doesn't seem fast enough to support gitpod right now</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>