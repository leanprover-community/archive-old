---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html">Need help with class instance resolution</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="192421345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192421345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192421345">(Mar 31 2020 at 17:20)</a>:</h4>
<p>Hi, I'm trying to make <code>algebra</code> work with semirings and semimodules, see <a href="https://github.com/leanprover-community/mathlib/issues/2303" title="https://github.com/leanprover-community/mathlib/issues/2303">#2303</a>. Lean fails to find an instance of <code>algebra R (matrix n R)</code> in <code>lie_algebra.lean</code>. I've enables <code>trace.class_instances</code>, see <a href="https://github.com/leanprover-community/mathlib/pull/2303/checks?check_run_id=549397958" title="https://github.com/leanprover-community/mathlib/pull/2303/checks?check_run_id=549397958">build log</a>. It seems that <code>matrix_algebra</code> fails <code>defeq</code>. Why could this happen?</p>



<a name="192421563"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192421563" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192421563">(Mar 31 2020 at 17:22)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">lie_algebra</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">algebra</span> <span class="n">R</span> <span class="o">(</span><span class="n">matrix</span> <span class="o">(</span><span class="n">fin</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">fin</span> <span class="n">n</span><span class="o">)</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- works</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span>
  <span class="n">algebra</span> <span class="n">R</span> <span class="o">(</span><span class="n">matrix</span> <span class="n">n</span> <span class="n">n</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- fails</span>
</pre></div>


<p>What definition of matrix are you using? (what you posted doesn't typecheck for me)</p>



<a name="192421987"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192421987" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192421987">(Mar 31 2020 at 17:26)</a>:</h4>
<p>I'm talking about the bottom of <a href="https://github.com/leanprover-community/mathlib/blob/algebra-bundled/src/algebra/lie_algebra.lean#L441" title="https://github.com/leanprover-community/mathlib/blob/algebra-bundled/src/algebra/lie_algebra.lean#L441">lie_algebra.lean</a></p>



<a name="192422070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192422070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192422070">(Mar 31 2020 at 17:27)</a>:</h4>
<p><code>matrix n n R</code></p>



<a name="192422109"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192422109" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192422109">(Mar 31 2020 at 17:27)</a>:</h4>
<p>It compiles with <code>master</code> but fails in my branch, probably because of some <code>semiring</code> vs <code>ring</code> or <code>semimodule</code> vs <code>module</code> issues.</p>



<a name="192422216"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192422216" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192422216">(Mar 31 2020 at 17:28)</a>:</h4>
<p>In the build log you can see that it tries to apply <code>matrix_algebra</code> but fails.</p>



<a name="192422455"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192422455" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192422455">(Mar 31 2020 at 17:30)</a>:</h4>
<p>The above doesn't compile for me on master:</p>
<div class="codehilite"><pre><span></span>failed to synthesize type class instance for
R : Type,
_inst_1 : comm_ring R,
n : Type,
_inst_2 : fintype n
⊢ ring (matrix n n R)
</pre></div>



<a name="192422638"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192422638" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192422638">(Mar 31 2020 at 17:31)</a>:</h4>
<p>That's interesting.</p>



<a name="192422854"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192422854" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192422854">(Mar 31 2020 at 17:32)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">lie_algebra</span>

<span class="n">def</span> <span class="n">X</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="mi">3</span>

<span class="n">open_locale</span> <span class="n">classical</span>

<span class="n">noncomputable</span> <span class="kn">example</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span>
  <span class="n">algebra</span> <span class="n">R</span> <span class="o">(</span><span class="n">matrix</span> <span class="n">n</span> <span class="n">n</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
</pre></div>



<a name="192422868"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192422868" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192422868">(Mar 31 2020 at 17:32)</a>:</h4>
<p>Need decidable equality on n</p>



<a name="192422933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192422933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192422933">(Mar 31 2020 at 17:33)</a>:</h4>
<p>(the def to work around open_locale bug)</p>



<a name="192423068"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192423068" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192423068">(Mar 31 2020 at 17:34)</a>:</h4>
<p>Don't we have a decidable equality on <code>fin n</code>? And we have it at the bottom of <code>lie_algebra</code></p>



<a name="192423233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192423233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192423233">(Mar 31 2020 at 17:35)</a>:</h4>
<p>You've posted code snippet with <code>fin n</code>, then error for <code>{n : Type*} [fintype n]</code></p>



<a name="192424429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192424429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192424429">(Mar 31 2020 at 17:44)</a>:</h4>
<p>Yes, I was confused by n. I'll fix. Thanks.</p>



<a name="192426294"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192426294" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192426294">(Mar 31 2020 at 17:57)</a>:</h4>
<p>And this doesn't help with the original question: why <code>lie_algebra</code> fails to compile in my branch?</p>



<a name="192428591"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192428591" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192428591">(Mar 31 2020 at 18:14)</a>:</h4>
<p>Probably this issue is similar to what <span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span> had when he tried to make <code>linear_map</code>s work with <code>semimodule</code>s</p>



<a name="192437494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192437494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192437494">(Mar 31 2020 at 19:24)</a>:</h4>
<p>Ping here...</p>



<a name="192442720"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192442720" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192442720">(Mar 31 2020 at 20:07)</a>:</h4>
<p><span class="user-mention" data-user-id="110032">@Reid Barton</span> I'd prefer some hint...</p>



<a name="192687775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192687775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192687775">(Apr 02 2020 at 15:58)</a>:</h4>
<p>I have tried (again) to refactor things to replace <code>module</code> by <code>semimodule</code> everywhere, hoping that Lean 3.7 would help. I run into issues I don't understand (mostly with product types), with class instance resolution as usual. I have tracked down the source of my problem to the following example. Open current mathlib master, and put the following lines at Line 85 in <code>algebra/pi_instances.lean</code> (after the semimodule instance, but before the module instance)</p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">ok</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">semimodule</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span>  <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- ok</span>

<span class="kn">lemma</span> <span class="n">not_ok</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">semimodule</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- fails</span>

<span class="kn">lemma</span> <span class="n">but_same</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">semimodule</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span>
  <span class="bp">=</span>
  <span class="bp">@</span><span class="n">semimodule</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span> <span class="n">rfl</span>
</pre></div>


<p>In <code>ok</code> and <code>not_ok</code>, I am asking if the same type, but presented in two different ways, is a semimodule. The first one works, the second one fails. The last lemma in the snippet is to show that the types are really the same. In current master, the following module instance saves the day, because it can then be used to show that <code>not_ok</code> is a semimodule, so when this class instance question appears later on it is solved. In my refactoring, I remove modules, so I remove the <code>pi_instance</code> for modules, and now this instance fails. Of course, I could add it back (with semimodules), but it doesn't feel like a real solution. Do you understand what is going on, and what I should do here?</p>



<a name="192700393"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192700393" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192700393">(Apr 02 2020 at 17:34)</a>:</h4>
<p>Anyone on this typeclass issue? Maybe I should try to bring <span class="user-mention" data-user-id="230999">@Daniel Selsam</span> here.</p>



<a name="192701210"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192701210" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192701210">(Apr 02 2020 at 17:41)</a>:</h4>
<div class="codehilite"><pre><span></span>(@add_comm_group.to_add_comm_monoid.{0} (β → α)
  (@pi.add_comm_group.{0 0} β (λ (a : β), α)
  (λ (i : β), @ring.to_add_comm_group.{0} α _inst_1)))
</pre></div>


<p>has type <code>add_comm_monoid (β → α)</code>, whereas</p>
<div class="codehilite"><pre><span></span>(@pi.add_comm_monoid.{0 0} β (λ (a : β), α)
  (λ (i : β), @semiring.to_add_comm_monoid.{0} α (@ring.to_semiring.{0} α _inst_1)))
</pre></div>


<p>has type <code>add_comm_monoid (Π (i : β), (λ (a : β), α) i)</code></p>



<a name="192701365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192701365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192701365">(Apr 02 2020 at 17:42)</a>:</h4>
<p>And these are the same thing, right?</p>



<a name="192701382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192701382" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192701382">(Apr 02 2020 at 17:42)</a>:</h4>
<p>Maybe not to the unifier</p>



<a name="192701701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192701701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192701701">(Apr 02 2020 at 17:45)</a>:</h4>
<p>At least some parts of Lean know it is the same thing:</p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">foo</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">:</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="bp">Π</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span>
</pre></div>



<a name="192701743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192701743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192701743">(Apr 02 2020 at 17:45)</a>:</h4>
<p>For sure, but you know that <code>rw</code> doesn't think they're the same thing</p>



<a name="192701837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192701837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192701837">(Apr 02 2020 at 17:46)</a>:</h4>
<p>I don't know the answer, I've just taken to looking at the output of </p>
<div class="codehilite"><pre><span></span>set_option trace.type_context.is_def_eq true
set_option trace.type_context.is_def_eq_detail true
</pre></div>


<p>recently.</p>



<a name="192702267"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192702267" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192702267">(Apr 02 2020 at 17:49)</a>:</h4>
<p><code>foo</code> is iota reduction or eta expansion or whatever it is called by the CS people, and that's part of <code>rfl</code> but maybe not part of the unifier. But also it might be nothing to do with the problem :-(</p>



<a name="192702477"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192702477" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192702477">(Apr 02 2020 at 17:51)</a>:</h4>
<p>Actually rw seems to work fine too</p>



<a name="192702512"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192702512" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192702512">(Apr 02 2020 at 17:51)</a>:</h4>
<p>I don't know how to check to see if two terms are syntactically equal in Lean</p>



<a name="192702553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192702553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192702553">(Apr 02 2020 at 17:51)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">α</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">:</span> <span class="o">(</span><span class="bp">Π</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="n">i</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="bp">Π</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">h</span><span class="o">,</span> <span class="c1">-- works</span>
  <span class="n">sorry</span>
<span class="kn">end</span>
</pre></div>



<a name="192702637"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192702637" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192702637">(Apr 02 2020 at 17:52)</a>:</h4>
<p>This is the kind of problem where I feel completely helpless. When even with <code>pp.all</code> I can't see anything bad, I just need to call for help...</p>



<a name="192702789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192702789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192702789">(Apr 02 2020 at 17:53)</a>:</h4>
<p>Yeah I am interested in learning how to debug these issues. <code>mv_polynomial</code> is defined to be some <code>finsupp</code> after some unfolding, and I saw an mv_polynomial zero and a finsupp zero which <code>add_zero</code> got upset about because of some unification issue but <code>refl</code> worked fine.</p>



<a name="192703240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192703240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192703240">(Apr 02 2020 at 17:57)</a>:</h4>
<p><code>pp.all</code> just shows these defeq terms. The question is what the type class inference algorithm is I guess.</p>



<a name="192704149"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192704149" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192704149">(Apr 02 2020 at 18:03)</a>:</h4>
<p>With <code>set_option trace.class_instances true</code>, the success</p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">ok</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">semimodule</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span>  <span class="o">:=</span> <span class="k">begin</span> <span class="n">apply_instance</span> <span class="kn">end</span> <span class="c1">-- ok</span>
</pre></div>


<p>has log</p>
<div class="codehilite"><pre><span></span>[class_instances] (0) ?x_0 : @semimodule α (β → α) (@ring.to_semiring α _inst_1)
  (@pi.add_comm_monoid β (λ (a : β), α)
     (λ (i : β), @semiring.to_add_comm_monoid α (@ring.to_semiring α _inst_1))) := @pi.semimodule ?x_1 ?x_2 ?x_3 ?x_4 ?x_5 ?x_6

[class_instances] (1) ?x_6 i : @semimodule α α (@ring.to_semiring α _inst_1) (@semiring.to_add_comm_monoid α (@ring.to_semiring α _inst_1)) := @semiring.to_semimodule (?x_15 i) (?x_16 i)
</pre></div>



<a name="192704461"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192704461" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192704461">(Apr 02 2020 at 18:05)</a>:</h4>
<p>(I skipped a couple of steps and just showed the successful route to the success) and the failure has a <a href="https://gist.github.com/kbuzzard/a6188cf5b37c683d10fb3a1f64de0690" title="https://gist.github.com/kbuzzard/a6188cf5b37c683d10fb3a1f64de0690">longer log</a>.</p>



<a name="192704838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192704838" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192704838">(Apr 02 2020 at 18:08)</a>:</h4>
<p>The very first line of the gist is</p>
<div class="codehilite"><pre><span></span>[class_instances] (0) ?x_0 : @semimodule α (β → α) (@ring.to_semiring α _inst_1)
  (@add_comm_group.to_add_comm_monoid (β → α)
     (@pi.add_comm_group β (λ (a : β), α) (λ (i : β), @ring.to_add_comm_group α _inst_1))) := @pi.semimodule ?x_1 ?x_2 ?x_3 ?x_4 ?x_5 ?x_6
failed is_def_eq
</pre></div>


<p>so it tries to use <code>pi.semimodule</code> but here it fails.</p>



<a name="192704894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192704894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192704894">(Apr 02 2020 at 18:09)</a>:</h4>
<p>I think this is the precise point where the typeclass algorithm decides to go in two different ways for your two different questions.</p>



<a name="192705324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192705324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192705324">(Apr 02 2020 at 18:13)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">variables</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span>

<span class="n">def</span> <span class="n">ok&#39;</span> <span class="o">:</span> <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">semimodule</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="c1">-- Proof complete!</span>
<span class="kn">end</span>

<span class="n">def</span> <span class="n">not_ok&#39;</span> <span class="o">:</span> <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">semimodule</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="c1">-- fails</span>
  <span class="c">/-</span><span class="cm"></span>
<span class="cm">  invalid type ascription, term has type</span>
<span class="cm">  semimodule ?m_1 (Π (i : ?m_2), ?m_3 i) : Type (max ? ? ?)</span>
<span class="cm">but is expected to have type</span>
<span class="cm">  semimodule α (β → α) : Type</span>
<span class="cm">  -/</span>
<span class="kn">end</span>
</pre></div>



<a name="192705395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192705395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192705395">(Apr 02 2020 at 18:13)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="110032">@Reid Barton</span> and <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> were talking about this kind of unification issue quite recently.</p>



<a name="192705708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192705708" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192705708">(Apr 02 2020 at 18:16)</a>:</h4>
<p>The types of <code>ok'</code> and <code>not_ok'</code> are defeq.</p>



<a name="192705860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192705860" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192705860">(Apr 02 2020 at 18:18)</a>:</h4>
<p>Of course I am in no position to be able to tell you what to do about it, I'm just observing that with <code>set_option trace.class_instances true</code> you can diagnose what is going on even if you know as little about computers as me.</p>



<a name="192706435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192706435" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192706435">(Apr 02 2020 at 18:22)</a>:</h4>
<p>The first difference in the <code>trace.type_context.is_def_eq true</code> logs is that in the OK case, we have</p>
<div class="codehilite"><pre><span></span>[type_context.is_def_eq] semimodule ?m_1 (Π (i : ?m_2), ?m_3 i) =?= semimodule α (β → α) ... success  (approximate mode)
</pre></div>


<p>and in the not OK case, we have</p>
<div class="codehilite"><pre><span></span>[type_context.is_def_eq] semimodule ?m_1 (Π (i : ?m_2), ?m_3 i) =?= semimodule α (β → α) ... failed  (approximate mode)
</pre></div>


<p>So that is a diagnosis of the failure, which might help someone else to tell you how to fix it.</p>



<a name="192706483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192706483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192706483">(Apr 02 2020 at 18:23)</a>:</h4>
<p>These lines are the same up to <code>success/failed</code>, right?</p>



<a name="192706509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192706509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192706509">(Apr 02 2020 at 18:23)</a>:</h4>
<p>Yes, but I didn't have the detailed version on</p>



<a name="192706619"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192706619" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192706619">(Apr 02 2020 at 18:24)</a>:</h4>
<p>are these logs with pp.all? is that what you mean?</p>



<a name="192706667"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192706667" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192706667">(Apr 02 2020 at 18:24)</a>:</h4>
<p>oh no, i have pp.all off</p>



<a name="192706908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192706908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192706908">(Apr 02 2020 at 18:26)</a>:</h4>
<p>I meant I didn't have <code>trace.type_context.is_def_eq_detail</code> on</p>



<a name="192706909"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192706909" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192706909">(Apr 02 2020 at 18:26)</a>:</h4>
<p>Well, I imagine/hope there must be some difference between the pp.all versions.</p>



<a name="192706917"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192706917" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192706917">(Apr 02 2020 at 18:26)</a>:</h4>
<p>Ah.</p>



<a name="192707148"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192707148" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192707148">(Apr 02 2020 at 18:28)</a>:</h4>
<p>Here is the pp.all unification failure:</p>
<div class="codehilite"><pre><span></span>[type_context.is_def_eq] @semimodule.{?l_1 (max ?l_2 ?l_3)} ?m_4 (Π (i : ?m_5), ?m_6 i) ?m_7
  (@pi.add_comm_monoid.{?l_2 ?l_3} ?m_5 (λ (i : ?m_5), ?m_6 i) (λ (i : ?m_5), ?m_8 i)) =?= @semimodule.{0 0} α (β → α) (@ring.to_semiring.{0} α _inst_1)
  (@add_comm_group.to_add_comm_monoid.{0} (β → α)
     (@pi.add_comm_group.{0 0} β (λ (a : β), α) (λ (i : β), @ring.to_add_comm_group.{0} α _inst_1))) ... failed  (approximate mode)
</pre></div>


<p>and here is the success:</p>
<div class="codehilite"><pre><span></span>[type_context.is_def_eq] @semimodule.{?l_1 (max ?l_2 ?l_3)} ?m_4 (Π (i : ?m_5), ?m_6 i) ?m_7
  (@pi.add_comm_monoid.{?l_2 ?l_3} ?m_5 (λ (i : ?m_5), ?m_6 i) (λ (i : ?m_5), ?m_8 i)) =?= @semimodule.{0 0} α (β → α) (@ring.to_semiring.{0} α _inst_1)
  (@pi.add_comm_monoid.{0 0} β (λ (a : β), α)
     (λ (i : β), @semiring.to_add_comm_monoid.{0} α (@ring.to_semiring.{0} α _inst_1))) ... success  (approximate mode)
</pre></div>



<a name="192707257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192707257" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192707257">(Apr 02 2020 at 18:29)</a>:</h4>
<p>So now you can all play the unification game at home</p>



<a name="192707376"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192707376" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192707376">(Apr 02 2020 at 18:30)</a>:</h4>
<p>Okay so there is a diamond here, when putting an add_comm_monoid structure on a product of rings.</p>



<a name="192707443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192707443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192707443">(Apr 02 2020 at 18:31)</a>:</h4>
<p>we could (1) forget from ring to add_comm_group, (2) use the pi instance, (3) forget from add_comm_group to add_comm_monoid.<br>
Or (1) forget from ring to semiring, (2) forget from ring to add_comm_monoid, (3) use the pi instance.</p>



<a name="192707450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192707450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192707450">(Apr 02 2020 at 18:31)</a>:</h4>
<p>question 1: are these defeq?</p>



<a name="192707502"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192707502" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192707502">(Apr 02 2020 at 18:31)</a>:</h4>
<p>I'm pretty sure the answer will be yes</p>



<a name="192707652"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192707652" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192707652">(Apr 02 2020 at 18:33)</a>:</h4>
<p>question 2: are they defeq using "instance transparency", that is, only looking into the definitions of things which are either <code>reducible</code> or <code>instance</code>s (and not, for example, the definition of <code>id</code>)</p>



<a name="192707685"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192707685" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192707685">(Apr 02 2020 at 18:33)</a>:</h4>
<p>I imagine the answer will be no, otherwise both should succeed (or fail).</p>



<a name="192708356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708356">(Apr 02 2020 at 18:39)</a>:</h4>
<p>I see from <code>#print pi.add_comm_monoid</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="n">a_1</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">),</span> <span class="n">f</span> <span class="n">i</span><span class="o">),</span> <span class="n">id</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">),</span> <span class="n">add_comm_monoid</span><span class="bp">.</span><span class="n">add</span> <span class="o">(</span><span class="n">a</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">a_1</span> <span class="n">i</span><span class="o">)),</span>
</pre></div>



<a name="192708442"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708442" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708442">(Apr 02 2020 at 18:40)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="c1">-- the full semimodule instance</span>
<span class="kn">example</span> <span class="o">:</span> <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="bp">=</span>
  <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="n">rfl</span> <span class="c1">-- succeeds</span>

<span class="c1">-- instance transparency version for the full semimodule instance</span>
<span class="kn">example</span> <span class="o">:</span> <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="bp">=</span>
  <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">reflexivity</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">transparency</span><span class="bp">.</span><span class="kn">reducible</span> <span class="c1">-- succeeds</span>

<span class="c1">-- But now let&#39;s look at the subterms giving the add_comm_monoid structure</span>
<span class="kn">example</span> <span class="o">:</span> <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="bp">=</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="n">rfl</span> <span class="c1">-- succeeds</span>

<span class="kn">example</span> <span class="o">:</span> <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="bp">=</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">reflexivity</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">transparency</span><span class="bp">.</span><span class="kn">reducible</span> <span class="c1">-- fails!</span>
</pre></div>



<a name="192708499"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708499" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708499">(Apr 02 2020 at 18:40)</a>:</h4>
<p>oh, actually that field is probably not a problem, since <code>pi.add_comm_group</code>'s <code>add</code> has <code>id</code> in the same place.</p>



<a name="192708522"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708522" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708522">(Apr 02 2020 at 18:41)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">zero</span> <span class="o">:=</span> <span class="n">eq</span><span class="bp">.</span><span class="n">mpr</span> <span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span><span class="bp">._</span><span class="n">proof_2</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="bp">_</span><span class="n">x</span> <span class="o">:</span> <span class="n">I</span><span class="o">),</span> <span class="n">add_comm_group</span><span class="bp">.</span><span class="n">zero</span> <span class="o">(</span><span class="n">f</span> <span class="bp">_</span><span class="n">x</span><span class="o">)),</span>
</pre></div>


<p>This certainly looks silly</p>



<a name="192708690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708690">(Apr 02 2020 at 18:43)</a>:</h4>
<p>Reid I think my snippet shows that the semimodule terms are defeq even using instance transparency, but they have defeq subterms which are not defeq using instance transparency. I am pretty much at the boundary of my understanding here, I am just posting stuff like <code>by tactic.reflexivity tactic.transparency.reducible</code> copying from posts Gabriel made earlier this week and am not even 100% sure that I am checking what you are asking.</p>



<a name="192708719"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708719" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708719">(Apr 02 2020 at 18:43)</a>:</h4>
<p>I think you want <code>tactic.transparency.instances</code> not <code>reducible</code></p>



<a name="192708801"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708801" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708801">(Apr 02 2020 at 18:44)</a>:</h4>
<p>Eveything succeeds if I change <code>reducible</code> to <code>instances</code></p>



<a name="192708815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708815" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708815">(Apr 02 2020 at 18:44)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> help</p>



<a name="192708837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708837">(Apr 02 2020 at 18:44)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">:</span> <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="bp">=</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">reflexivity</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">transparency</span><span class="bp">.</span><span class="n">instances</span> <span class="c1">-- works</span>
</pre></div>



<a name="192708860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708860" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708860">(Apr 02 2020 at 18:44)</a>:</h4>
<p><span class="user-mention" data-user-id="110032">@Reid Barton</span> MWE please.</p>



<a name="192708880"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192708880" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192708880">(Apr 02 2020 at 18:45)</a>:</h4>
<p>I'll do it</p>



<a name="192709294"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192709294" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192709294">(Apr 02 2020 at 18:48)</a>:</h4>
<p>I'm really confused about your 2nd and 4th examples. Isn't <code>semimodule</code> just a constant? How can adding it turn a failing unification problem into one which succeeds?</p>



<a name="192709618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192709618" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192709618">(Apr 02 2020 at 18:51)</a>:</h4>
<p>Actually these examples are "easier" than the original failing instance search problem, because here we gave Lean both sides</p>



<a name="192709831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192709831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192709831">(Apr 02 2020 at 18:53)</a>:</h4>
<p>Not to sound like a broken record, but life would be simpler if we didn't allow diamonds and <code>add_comm_group.to_add_comm_monoid</code> wasn't an instance.</p>



<a name="192709953"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192709953" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192709953">(Apr 02 2020 at 18:55)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">pi_instances</span>

<span class="kn">variables</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span>

<span class="n">def</span> <span class="n">ok&#39;</span> <span class="o">:</span> <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- succeeds</span>

<span class="n">def</span> <span class="n">not_ok&#39;</span> <span class="o">:</span> <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="n">sorry</span>
<span class="c1">--by apply_instance -- fails</span>

<span class="kn">example</span> <span class="o">:</span> <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="bp">=</span>
     <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span>
     <span class="o">:=</span> <span class="k">by</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">reflexivity</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">transparency</span><span class="bp">.</span><span class="kn">reducible</span> <span class="c1">-- succeeds</span>
</pre></div>



<a name="192710095"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192710095" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192710095">(Apr 02 2020 at 18:56)</a>:</h4>
<p>The second <code>apply_instance</code> works for me.</p>



<a name="192710128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192710128" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192710128">(Apr 02 2020 at 18:56)</a>:</h4>
<p>curses, I might be using some modified mathlib</p>



<a name="192710185"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192710185" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192710185">(Apr 02 2020 at 18:56)</a>:</h4>
<p>oh yeah, you need to add an <code>#exit</code> in <code>algebra.pi_instances</code> :-/</p>



<a name="192710239"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192710239" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192710239">(Apr 02 2020 at 18:57)</a>:</h4>
<p>Is this meant seriously?  Where should I put it?</p>



<a name="192710279"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192710279" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192710279">(Apr 02 2020 at 18:58)</a>:</h4>
<p>How about</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">order</span><span class="bp">.</span><span class="n">basic</span>
<span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">group</span><span class="bp">.</span><span class="n">prod</span>
<span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">module</span>
<span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">finset</span>
<span class="kn">import</span> <span class="n">ring_theory</span><span class="bp">.</span><span class="n">subring</span>
<span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">pi_instances</span>

<span class="kn">namespace</span> <span class="n">pi</span>
<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span>
<span class="kn">variable</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span>     <span class="c1">-- The indexing type</span>
<span class="kn">variable</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">→</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="c1">-- The family of types already equipped with instances</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">)</span>

<span class="kn">instance</span> <span class="n">has_zero</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_zero</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">i</span><span class="o">,</span> <span class="mi">0</span><span class="bp">⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">zero_apply</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_zero</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">instance</span> <span class="n">has_one</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_one</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_one</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">i</span><span class="o">,</span> <span class="mi">1</span><span class="bp">⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">one_apply</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_one</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="n">attribute</span> <span class="o">[</span><span class="n">to_additive</span><span class="o">]</span> <span class="n">pi</span><span class="bp">.</span><span class="n">has_one</span>
<span class="n">attribute</span> <span class="o">[</span><span class="n">to_additive</span><span class="o">]</span> <span class="n">pi</span><span class="bp">.</span><span class="n">one_apply</span>

<span class="kn">instance</span> <span class="n">has_add</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_add</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_add</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">x</span> <span class="n">i</span> <span class="bp">+</span> <span class="n">y</span> <span class="n">i</span><span class="bp">⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">add_apply</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_add</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">x</span> <span class="n">i</span> <span class="bp">+</span> <span class="n">y</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">instance</span> <span class="n">has_mul</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_mul</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_mul</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">x</span> <span class="n">i</span> <span class="bp">*</span> <span class="n">y</span> <span class="n">i</span><span class="bp">⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">mul_apply</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_mul</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">)</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">x</span> <span class="n">i</span> <span class="bp">*</span> <span class="n">y</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="n">attribute</span> <span class="o">[</span><span class="n">to_additive</span><span class="o">]</span> <span class="n">pi</span><span class="bp">.</span><span class="n">has_mul</span>
<span class="n">attribute</span> <span class="o">[</span><span class="n">to_additive</span><span class="o">]</span> <span class="n">pi</span><span class="bp">.</span><span class="n">mul_apply</span>

<span class="kn">instance</span> <span class="n">has_inv</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_inv</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_inv</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">x</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">x</span> <span class="n">i</span><span class="o">)</span><span class="bp">⁻¹⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">inv_apply</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_inv</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">x</span><span class="bp">⁻¹</span> <span class="n">i</span> <span class="bp">=</span> <span class="o">(</span><span class="n">x</span> <span class="n">i</span><span class="o">)</span><span class="bp">⁻¹</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">instance</span> <span class="n">has_neg</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_neg</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_neg</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">x</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="bp">-</span><span class="o">(</span><span class="n">x</span> <span class="n">i</span><span class="o">)</span><span class="bp">⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">neg_apply</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_neg</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="bp">-</span><span class="n">x</span><span class="o">)</span> <span class="n">i</span> <span class="bp">=</span> <span class="bp">-</span><span class="n">x</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="n">attribute</span> <span class="o">[</span><span class="n">to_additive</span><span class="o">]</span> <span class="n">pi</span><span class="bp">.</span><span class="n">has_inv</span>
<span class="n">attribute</span> <span class="o">[</span><span class="n">to_additive</span><span class="o">]</span> <span class="n">pi</span><span class="bp">.</span><span class="n">inv_apply</span>

<span class="kn">instance</span> <span class="n">has_scalar</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_scalar</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_scalar</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">s</span> <span class="n">x</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">s</span> <span class="err">•</span> <span class="o">(</span><span class="n">x</span> <span class="n">i</span><span class="o">)</span><span class="bp">⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">smul_apply</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_scalar</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">s</span> <span class="err">•</span> <span class="n">x</span><span class="o">)</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">s</span> <span class="err">•</span> <span class="n">x</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">instance</span> <span class="n">semigroup</span>          <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">semigroup</span>          <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">semigroup</span>          <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">comm_semigroup</span>     <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">comm_semigroup</span>     <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">comm_semigroup</span>     <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">monoid</span>             <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">monoid</span>             <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">monoid</span>             <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">comm_monoid</span>        <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">comm_monoid</span>        <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">comm_monoid</span>        <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">group</span>              <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">group</span>              <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">group</span>              <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">comm_group</span>         <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">comm_group</span>         <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">comm_group</span>         <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">add_semigroup</span>      <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_semigroup</span>      <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_semigroup</span>      <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">add_comm_semigroup</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_comm_semigroup</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_comm_semigroup</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">add_monoid</span>         <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_monoid</span>         <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_monoid</span>         <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">add_comm_monoid</span>    <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_comm_monoid</span>    <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_comm_monoid</span>    <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">add_group</span>          <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_group</span>          <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_group</span>          <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">add_comm_group</span>     <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_comm_group</span>     <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_comm_group</span>     <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">semiring</span>           <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">semiring</span>           <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">semiring</span>           <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">ring</span>               <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">ring</span>               <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">ring</span>               <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>
<span class="kn">instance</span> <span class="n">comm_ring</span>          <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">comm_ring</span>          <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">comm_ring</span>          <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">pi_instance</span>

<span class="kn">instance</span> <span class="n">mul_action</span>     <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">m</span> <span class="o">:</span> <span class="n">monoid</span> <span class="n">α</span><span class="o">}</span>                                      <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">mul_action</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span>     <span class="o">:</span> <span class="n">mul_action</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">c</span> <span class="n">f</span> <span class="n">i</span><span class="o">,</span> <span class="n">c</span> <span class="err">•</span> <span class="n">f</span> <span class="n">i</span><span class="o">,</span>
  <span class="n">mul_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span> <span class="n">s</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">mul_smul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">one_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">one_smul</span> <span class="n">α</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="n">distrib_mul_action</span> <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">m</span> <span class="o">:</span> <span class="n">monoid</span> <span class="n">α</span><span class="o">}</span>         <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_monoid</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span>      <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">distrib_mul_action</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">distrib_mul_action</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">smul_zero</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">c</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">smul_zero</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">smul_add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">c</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">smul_add</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">pi</span><span class="bp">.</span><span class="n">mul_action</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="n">semimodule</span>     <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">r</span> <span class="o">:</span> <span class="n">semiring</span> <span class="n">α</span><span class="o">}</span>       <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_comm_monoid</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">semimodule</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span>     <span class="o">:</span> <span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">add_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">c</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_smul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">zero_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">zero_smul</span> <span class="n">α</span> <span class="bp">_</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">pi</span><span class="bp">.</span><span class="n">distrib_mul_action</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">variables</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span>

<span class="n">def</span> <span class="n">ok&#39;</span> <span class="o">:</span> <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- succeeds</span>

<span class="n">def</span> <span class="n">not_ok&#39;</span> <span class="o">:</span> <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span>
<span class="n">sorry</span>
<span class="c1">--by apply_instance -- fails</span>

<span class="kn">example</span> <span class="o">:</span> <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="bp">=</span>
     <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span>
     <span class="o">:=</span> <span class="k">by</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">reflexivity</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">transparency</span><span class="bp">.</span><span class="kn">reducible</span> <span class="c1">-- succeeds</span>
</pre></div>



<a name="192710386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192710386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192710386">(Apr 02 2020 at 18:58)</a>:</h4>
<p>That is like the first third of algebra.pi_instances</p>



<a name="192710620"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192710620" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192710620">(Apr 02 2020 at 19:00)</a>:</h4>
<p>Ok, fails for me now.</p>



<a name="192710717"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192710717" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192710717">(Apr 02 2020 at 19:01)</a>:</h4>
<p>I stop just before the line</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">module</span>         <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">r</span> <span class="o">:</span> <span class="n">ring</span> <span class="n">α</span><span class="o">}</span>           <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_comm_group</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span>  <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">module</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span>         <span class="o">:</span> <span class="n">module</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span>       <span class="o">:=</span> <span class="o">{</span><span class="bp">..</span><span class="n">pi</span><span class="bp">.</span><span class="n">semimodule</span> <span class="n">I</span> <span class="n">f</span> <span class="n">α</span><span class="o">}</span>
</pre></div>



<a name="192710734"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192710734" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192710734">(Apr 02 2020 at 19:01)</a>:</h4>
<p>In the first message of the thread, I said to put it just before the module instance.</p>



<a name="192710824"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192710824" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192710824">(Apr 02 2020 at 19:02)</a>:</h4>
<p>The reason I stop here is that Sebastien is trying to remove <code>module</code> from this part of the story and use only <code>semimodule</code>.</p>



<a name="192721933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192721933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192721933">(Apr 02 2020 at 20:30)</a>:</h4>
<p>Why is there an <code>eq.mpr</code> in the 0 in <code>pi.add_comm_monoid</code>?</p>
<div class="codehilite"><pre><span></span><span class="bp">@</span><span class="o">[</span><span class="kn">instance</span><span class="o">]</span>
<span class="kn">protected</span> <span class="n">def</span> <span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">→</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="bp">_</span><span class="n">inst_1</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">),</span> <span class="n">add_comm_monoid</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)],</span> <span class="n">add_comm_monoid</span> <span class="o">(</span><span class="bp">Π</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">),</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">→</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="bp">_</span><span class="n">inst_1</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">),</span> <span class="n">add_comm_monoid</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)],</span>
  <span class="o">{</span><span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="n">a_1</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">),</span> <span class="n">f</span> <span class="n">i</span><span class="o">),</span> <span class="n">id</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">),</span> <span class="n">add_comm_monoid</span><span class="bp">.</span><span class="n">add</span> <span class="o">(</span><span class="n">a</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">a_1</span> <span class="n">i</span><span class="o">)),</span>
   <span class="n">add_assoc</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
   <span class="n">zero</span> <span class="o">:=</span> <span class="n">eq</span><span class="bp">.</span><span class="n">mpr</span> <span class="n">add_comm_monoid</span><span class="bp">._</span><span class="n">proof_2</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="bp">_</span><span class="n">x</span> <span class="o">:</span> <span class="n">I</span><span class="o">),</span> <span class="n">add_comm_monoid</span><span class="bp">.</span><span class="n">zero</span> <span class="o">(</span><span class="n">f</span> <span class="bp">_</span><span class="n">x</span><span class="o">)),</span>
   <span class="n">zero_add</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
   <span class="n">add_zero</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
   <span class="n">add_comm</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">}</span>
</pre></div>



<a name="192722802"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192722802" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192722802">(Apr 02 2020 at 20:37)</a>:</h4>
<p>With this modifications, the <code>not_ok'</code> works for me:</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">add_comm_monoid</span>    <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_comm_monoid</span>    <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_comm_monoid</span>    <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span> <span class="n">i</span><span class="o">,</span> <span class="n">a</span> <span class="n">i</span> <span class="bp">+</span> <span class="n">b</span> <span class="n">i</span><span class="o">,</span>
  <span class="n">zero</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
  <span class="n">add_assoc</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">simp</span><span class="o">,</span>
  <span class="n">add_comm</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">intros</span> <span class="n">a</span> <span class="n">b</span><span class="bp">;</span> <span class="n">ext</span><span class="bp">;</span> <span class="n">simp</span><span class="bp">;</span> <span class="n">cc</span><span class="o">,</span>
  <span class="n">zero_add</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">intro</span> <span class="n">a</span><span class="bp">;</span> <span class="n">ext</span><span class="bp">;</span> <span class="n">simp</span><span class="o">,</span>
  <span class="n">add_zero</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">intro</span> <span class="n">a</span><span class="bp">;</span> <span class="n">ext</span><span class="bp">;</span> <span class="n">simp</span><span class="o">,</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="n">semimodule</span>
    <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">r</span> <span class="o">:</span> <span class="n">semiring</span> <span class="n">α</span><span class="o">}</span>
           <span class="o">[</span><span class="n">m</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_comm_monoid</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span>
           <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">semimodule</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span>     <span class="o">:</span>
           <span class="bp">@</span><span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="n">r</span> <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span> <span class="n">I</span> <span class="n">f</span> <span class="n">m</span><span class="o">)</span>
            <span class="o">:=</span>
<span class="o">{</span> <span class="n">add_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">c</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_smul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">zero_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">zero_smul</span> <span class="n">α</span> <span class="bp">_</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">pi</span><span class="bp">.</span><span class="n">distrib_mul_action</span> <span class="bp">_</span> <span class="o">}</span>
</pre></div>



<a name="192723017"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192723017" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192723017">(Apr 02 2020 at 20:39)</a>:</h4>
<p>Previously, there was an <code>eq.mpr</code> in the 0 of <code>pi.add_comm_monoid</code> (this is bad for unification, don't do that).  There were also the η-expansions <code>λ i, f i</code> and <code>λ i, m i</code> in <code>pi.semimodule</code>, try to avoid those as well.</p>



<a name="192723467"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192723467" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192723467">(Apr 02 2020 at 20:43)</a>:</h4>
<p>I'm not sure what in <code>pi_instance</code> is causing that. Would  <code>apply</code> insert <code>id</code> terms in the goal?</p>



<a name="192732846"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192732846" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192732846">(Apr 02 2020 at 22:03)</a>:</h4>
<p>I tried to understand the magic in <code>by pi_instance</code> some time ago, and failed.</p>



<a name="192732955"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192732955" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192732955">(Apr 02 2020 at 22:04)</a>:</h4>
<p>Could someone explain me what happens in <code>derive_field</code> in <code>tactic/pi_instances</code> (the "else" branch)?</p>



<a name="192733014"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192733014" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192733014">(Apr 02 2020 at 22:04)</a>:</h4>
<p>BTW, the following fails (tried to write this instead of the current instance):</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">add_comm_group</span>     <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_comm_group</span>     <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_comm_group</span>     <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="bp">..</span> <span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span><span class="o">,</span> <span class="bp">..</span> <span class="k">show</span> <span class="n">add_comm_group</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">),</span> <span class="k">by</span> <span class="n">pi_instance</span> <span class="o">}</span>
</pre></div>



<a name="192733479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192733479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192733479">(Apr 02 2020 at 22:08)</a>:</h4>
<p>Here is the code of the <code>else</code> branch:</p>
<div class="codehilite"><pre><span></span>     <span class="n">field</span> <span class="err">←</span> <span class="n">get_current_field</span><span class="o">,</span>
     <span class="n">e</span> <span class="err">←</span> <span class="n">mk_const</span> <span class="n">field</span><span class="o">,</span>
     <span class="n">expl_arity</span> <span class="err">←</span> <span class="n">get_expl_arity</span> <span class="n">e</span><span class="o">,</span>
     <span class="n">xs</span> <span class="err">←</span> <span class="o">(</span><span class="n">iota</span> <span class="n">expl_arity</span><span class="o">)</span><span class="bp">.</span><span class="n">mmap</span> <span class="err">$</span> <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="n">intro1</span><span class="o">,</span>
     <span class="n">x</span> <span class="err">←</span> <span class="n">intro1</span><span class="o">,</span>
     <span class="n">applyc</span> <span class="n">field</span><span class="o">,</span>
     <span class="n">xs</span><span class="bp">.</span><span class="n">mmap&#39;</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">h</span><span class="o">,</span> <span class="n">try</span> <span class="err">$</span>
      <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">apply</span> <span class="o">(</span><span class="n">h</span> <span class="n">x</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span> <span class="n">apply</span> <span class="n">h</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
      <span class="n">refine</span> <span class="bp">``</span><span class="o">(</span><span class="n">set</span><span class="bp">.</span><span class="n">image</span> <span class="o">(</span><span class="err">$</span> <span class="err">%%</span><span class="n">x</span><span class="o">)</span> <span class="err">%%</span><span class="n">h</span><span class="o">))</span> <span class="bp">&lt;|&gt;</span> <span class="n">fail</span> <span class="s2">&quot;args&quot;</span><span class="o">,</span>
     <span class="n">return</span> <span class="o">()</span>
</pre></div>



<a name="192735395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192735395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192735395">(Apr 02 2020 at 22:26)</a>:</h4>
<p>Rewriting <code>pi</code>-instances by hand doesn't help.</p>



<a name="192735476"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192735476" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192735476">(Apr 02 2020 at 22:27)</a>:</h4>
<p>I tried the following:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">order</span><span class="bp">.</span><span class="n">basic</span>
<span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">group</span><span class="bp">.</span><span class="n">prod</span>
<span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">module</span>
<span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">finset</span>
<span class="kn">import</span> <span class="n">ring_theory</span><span class="bp">.</span><span class="n">subring</span>
<span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">pi_instances</span>

<span class="kn">namespace</span> <span class="n">pi</span>
<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span>
<span class="kn">variable</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span>     <span class="c1">-- The indexing type</span>
<span class="kn">variable</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">→</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="c1">-- The family of types already equipped with instances</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">)</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span><span class="o">]</span>
<span class="kn">instance</span> <span class="n">has_one</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_one</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_one</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">i</span><span class="o">,</span> <span class="mi">1</span><span class="bp">⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span><span class="o">,</span> <span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">one_apply</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_one</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span><span class="o">]</span> <span class="kn">instance</span> <span class="n">has_mul</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_mul</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_mul</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">⟨λ</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">x</span> <span class="n">i</span> <span class="bp">*</span> <span class="n">y</span> <span class="n">i</span><span class="bp">⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">,</span> <span class="n">to_additive</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">mul_apply</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_mul</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">)</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">x</span> <span class="n">i</span> <span class="bp">*</span> <span class="n">y</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span><span class="o">]</span> <span class="kn">instance</span> <span class="n">has_inv</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_inv</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_inv</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">x</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">x</span> <span class="n">i</span><span class="o">)</span><span class="bp">⁻¹⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">,</span> <span class="n">to_additive</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">inv_apply</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_inv</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">x</span><span class="bp">⁻¹</span> <span class="n">i</span> <span class="bp">=</span> <span class="o">(</span><span class="n">x</span> <span class="n">i</span><span class="o">)</span><span class="bp">⁻¹</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">instance</span> <span class="n">has_scalar</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_scalar</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_scalar</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">⟨λ</span> <span class="n">s</span> <span class="n">x</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">s</span> <span class="err">•</span> <span class="o">(</span><span class="n">x</span> <span class="n">i</span><span class="o">)</span><span class="bp">⟩</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">smul_apply</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_scalar</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">s</span> <span class="err">•</span> <span class="n">x</span><span class="o">)</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">s</span> <span class="err">•</span> <span class="n">x</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span> <span class="n">add_semigroup</span><span class="o">]</span>
<span class="kn">instance</span> <span class="n">semigroup</span>          <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">semigroup</span>          <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">semigroup</span>          <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="n">mul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">*</span><span class="o">)</span> <span class="o">}</span><span class="bp">;</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">derive_field</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span> <span class="n">add_comm_semigroup</span><span class="o">]</span>
<span class="kn">instance</span> <span class="n">comm_semigroup</span>     <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">comm_semigroup</span>     <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">comm_semigroup</span>     <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="n">mul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">*</span><span class="o">)</span> <span class="o">}</span><span class="bp">;</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">derive_field</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span> <span class="n">add_monoid</span><span class="o">]</span>
<span class="kn">instance</span> <span class="n">monoid</span>             <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">monoid</span>             <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">monoid</span>             <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="n">one</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">),</span> <span class="n">mul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">*</span><span class="o">)</span> <span class="o">}</span><span class="bp">;</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">derive_field</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span> <span class="n">add_comm_monoid</span><span class="o">]</span>
<span class="kn">instance</span> <span class="n">comm_monoid</span>        <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">comm_monoid</span>        <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">comm_monoid</span>        <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="n">one</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">),</span> <span class="n">mul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">*</span><span class="o">)</span> <span class="o">}</span><span class="bp">;</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">derive_field</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span> <span class="n">add_group</span><span class="o">]</span>
<span class="kn">instance</span> <span class="n">group</span>              <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">group</span>              <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">group</span>              <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="n">inv</span> <span class="o">:=</span> <span class="n">has_inv</span><span class="bp">.</span><span class="n">inv</span><span class="o">,</span> <span class="n">one</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">),</span> <span class="n">mul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">*</span><span class="o">)</span> <span class="o">}</span><span class="bp">;</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">derive_field</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span> <span class="n">add_comm_group</span><span class="o">]</span>
<span class="kn">instance</span> <span class="n">comm_group</span>         <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">comm_group</span>         <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">comm_group</span>         <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="n">inv</span> <span class="o">:=</span> <span class="n">has_inv</span><span class="bp">.</span><span class="n">inv</span><span class="o">,</span> <span class="n">one</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">),</span> <span class="n">mul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">*</span><span class="o">)</span> <span class="o">}</span><span class="bp">;</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">derive_field</span>

<span class="kn">instance</span> <span class="n">semiring</span>           <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">semiring</span>           <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">semiring</span>           <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="n">zero</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">),</span> <span class="n">one</span> <span class="o">:=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">add</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">+</span><span class="o">),</span> <span class="n">mul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">*</span><span class="o">)</span> <span class="o">}</span><span class="bp">;</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">derive_field</span>

<span class="kn">instance</span> <span class="n">ring</span>               <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">ring</span>               <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">ring</span>               <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="n">zero</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">),</span> <span class="n">one</span> <span class="o">:=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">add</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">+</span><span class="o">),</span> <span class="n">mul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">*</span><span class="o">),</span> <span class="n">neg</span> <span class="o">:=</span> <span class="n">has_neg</span><span class="bp">.</span><span class="n">neg</span> <span class="o">}</span><span class="bp">;</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">derive_field</span>

<span class="kn">instance</span> <span class="n">comm_ring</span>          <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">comm_ring</span>          <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">comm_ring</span>          <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="n">zero</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">),</span> <span class="n">one</span> <span class="o">:=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">add</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">+</span><span class="o">),</span> <span class="n">mul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">*</span><span class="o">),</span> <span class="n">neg</span> <span class="o">:=</span> <span class="n">has_neg</span><span class="bp">.</span><span class="n">neg</span> <span class="o">}</span><span class="bp">;</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">derive_field</span>

<span class="kn">instance</span> <span class="n">mul_action</span>     <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">m</span> <span class="o">:</span> <span class="n">monoid</span> <span class="n">α</span><span class="o">}</span>                                      <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">mul_action</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span>     <span class="o">:</span> <span class="n">mul_action</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">c</span> <span class="n">f</span> <span class="n">i</span><span class="o">,</span> <span class="n">c</span> <span class="err">•</span> <span class="n">f</span> <span class="n">i</span><span class="o">,</span>
  <span class="n">mul_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span> <span class="n">s</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">mul_smul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">one_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">one_smul</span> <span class="n">α</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="n">distrib_mul_action</span> <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">m</span> <span class="o">:</span> <span class="n">monoid</span> <span class="n">α</span><span class="o">}</span>         <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_monoid</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span>      <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">distrib_mul_action</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">distrib_mul_action</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">smul_zero</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">c</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">smul_zero</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">smul_add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">c</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">smul_add</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">pi</span><span class="bp">.</span><span class="n">mul_action</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">variables</span> <span class="o">(</span><span class="n">I</span> <span class="n">f</span><span class="o">)</span>

<span class="kn">instance</span> <span class="n">semimodule</span>     <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">r</span> <span class="o">:</span> <span class="n">semiring</span> <span class="n">α</span><span class="o">}</span>       <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_comm_monoid</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">semimodule</span> <span class="n">α</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span>     <span class="o">:</span> <span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">add_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">c</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">add_smul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">zero_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">zero_smul</span> <span class="n">α</span> <span class="bp">_</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">pi</span><span class="bp">.</span><span class="n">distrib_mul_action</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">I</span> <span class="n">f</span><span class="o">}</span>

<span class="kn">lemma</span> <span class="n">ok</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">semimodule</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span>  <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- ok</span>

<span class="kn">lemma</span> <span class="n">not_ok</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">semimodule</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="n">to_add_comm_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="o">(</span><span class="n">β</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">pi</span><span class="bp">.</span><span class="n">add_comm_group</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">β</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">β</span><span class="o">),</span> <span class="bp">@</span><span class="n">ring</span><span class="bp">.</span><span class="n">to_add_comm_group</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">α</span> <span class="bp">_</span><span class="n">inst_1</span><span class="o">)))</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- fails</span>
<span class="kn">end</span> <span class="n">pi</span>
</pre></div>



<a name="192735706"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192735706" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192735706">(Apr 02 2020 at 22:29)</a>:</h4>
<p>And I don't see the difference between my instances and <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> 's</p>



<a name="192736828"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192736828" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192736828">(Apr 02 2020 at 22:42)</a>:</h4>
<p>Ah, I didn't apply his patch to <code>semimodule</code>.</p>



<a name="192738305"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192738305" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192738305">(Apr 02 2020 at 22:57)</a>:</h4>
<p>Regarding this <code>eq.mpr</code> ---- I put a lot of effort in the <code>transport</code> tactic to ensure none of these turned up in <code>transport</code>ed structures.</p>



<a name="192738369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192738369" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192738369">(Apr 02 2020 at 22:58)</a>:</h4>
<p>I haven't looked at this case, but we should ping <span class="user-mention" data-user-id="110026">@Simon Hudon</span> to ask about <code>pi_instances</code>, I think.</p>



<a name="192738401"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192738401" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192738401">(Apr 02 2020 at 22:58)</a>:</h4>
<p>When writing <code>transport</code>, I found that often the <code>eq.mpr</code>s (and even the<code>eq.rec</code>s) that were being produced were actually trivial:</p>



<a name="192738514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192738514" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192738514">(Apr 02 2020 at 23:00)</a>:</h4>
<p>when you looked at the equality you were running <code>eq.mpr</code> along, it was in fact <code>refl</code>, and <code>eq_mpr_refl</code> (only recently in<code>master</code>) would reduce it.</p>



<a name="192738672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192738672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192738672">(Apr 02 2020 at 23:01)</a>:</h4>
<p>Sometimes it was very hard to avoid the <code>eq.mpr</code> being generated, and you had to intercept it after the fact with the <a href="https://github.com/leanprover-community/mathlib/pull/2251/files#diff-952457174394a10d62a503823cccc3bbR349" title="https://github.com/leanprover-community/mathlib/pull/2251/files#diff-952457174394a10d62a503823cccc3bbR349"><code>simp_result</code> tactic</a> introduced in <a href="https://github.com/leanprover-community/mathlib/issues/2251" title="https://github.com/leanprover-community/mathlib/issues/2251">#2251</a>.</p>



<a name="192738929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192738929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192738929">(Apr 02 2020 at 23:03)</a>:</h4>
<p>I haven't spent much time looking at <code>eq.mp</code>. <span class="user-mention" data-user-id="110087">@Scott Morrison</span> I think you know more than me on the topic</p>



<a name="192739580"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192739580" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192739580">(Apr 02 2020 at 23:11)</a>:</h4>
<p>How do I add debug output to a tactic script? Do we have something more convenient than <code>trace</code>?</p>



<a name="192739635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192739635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192739635">(Apr 02 2020 at 23:11)</a>:</h4>
<p>I just want to prepend string labels to output strings.</p>



<a name="192741977"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192741977" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192741977">(Apr 02 2020 at 23:41)</a>:</h4>
<p>You could write your own that does:</p>
<div class="codehilite"><pre><span></span><span class="n">meta</span> <span class="n">def</span> <span class="n">my_trace</span> <span class="o">(</span><span class="n">msg</span> <span class="o">:</span> <span class="n">string</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span> <span class="n">trace</span> <span class="o">(</span><span class="s2">&quot;prefix: &quot;</span> <span class="bp">++</span> <span class="n">msg</span><span class="o">)</span>
</pre></div>



<a name="192742258"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192742258" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192742258">(Apr 02 2020 at 23:45)</a>:</h4>
<p>Ok, so wrapping <code>pi_instance</code> in <code>simp_result</code> does make the <code>eq.mpr</code> in <code>#print pi.add_comm_monoid </code> go away.</p>



<a name="192742656"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192742656" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192742656">(Apr 02 2020 at 23:50)</a>:</h4>
<p>So I think this counts as a fix to <span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span>'s original problem?</p>



<a name="192742668"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192742668" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192742668">(Apr 02 2020 at 23:50)</a>:</h4>
<p>How should we implement it?</p>



<a name="192742689"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192742689" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192742689">(Apr 02 2020 at 23:50)</a>:</h4>
<p>I can make a PR that just patches <code>pi_instances</code> to use <code>simp_result</code>. (Presumably I will play with <code>squeeze_simp</code> to identify exactly which simp lemmas <code>simp_result</code> actually needs.</p>



<a name="192742712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192742712" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192742712">(Apr 02 2020 at 23:51)</a>:</h4>
<p>And then <span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span> can continue his branch on top of that?</p>



<a name="192742981"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192742981" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192742981">(Apr 02 2020 at 23:54)</a>:</h4>
<p>Sounds like a good idea.</p>



<a name="192743068"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192743068" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192743068">(Apr 02 2020 at 23:55)</a>:</h4>
<p>We will need to remember to make <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span>'s patch to the <code>semimodule</code> instance in <code>pi_instances</code>, but I think this can be done in <span class="user-mention" data-user-id="110050">@Sebastien Gouezel</span>'s branch, as this is a separate issue from the automation problem.</p>



<a name="192743463"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192743463" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192743463">(Apr 03 2020 at 00:01)</a>:</h4>
<p>This seems super hacky. Couldn't we just build the correct term in the first place using structural recursion on the shape of the operation we want to define?</p>



<a name="192743878"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192743878" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192743878">(Apr 03 2020 at 00:06)</a>:</h4>
<p>Can you do this? It seems that either <code>applyc</code> or <code>apply</code> generates this <code>eq.mpr</code>.</p>



<a name="192744659"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192744659" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192744659">(Apr 03 2020 at 00:16)</a>:</h4>
<p>No, for <code>one</code> somehow <code>intro1</code> closes the goal.</p>



<a name="192744665"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192744665" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192744665">(Apr 03 2020 at 00:16)</a>:</h4>
<p>And generates <code>eq.mpr</code>.</p>



<a name="192744808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192744808" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192744808">(Apr 03 2020 at 00:19)</a>:</h4>
<p><code>intro_core</code> does the same.</p>



<a name="192744855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192744855" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192744855">(Apr 03 2020 at 00:20)</a>:</h4>
<p>How do I print debug current proof state (i.e., what Lean normally prints in "goals" in the tactic proof mode)?</p>



<a name="192744950"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192744950" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192744950">(Apr 03 2020 at 00:21)</a>:</h4>
<p>Dumb <code>eq.mpr</code>s seem hard to avoid. :-(</p>



<a name="192744955"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192744955" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192744955">(Apr 03 2020 at 00:21)</a>:</h4>
<p>But maybe we can go into the C++?</p>



<a name="192745560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192745560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192745560">(Apr 03 2020 at 00:29)</a>:</h4>
<p>I found out the difference between <code>1</code> and <code>mul</code>.</p>



<a name="192745624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192745624" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192745624">(Apr 03 2020 at 00:30)</a>:</h4>
<p>For <code>mul</code>, <code>expl_arity = 2</code>, and after two <code>intro1</code>, the goal is <code>Π i, f i</code></p>



<a name="192745657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192745657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192745657">(Apr 03 2020 at 00:30)</a>:</h4>
<p>For <code>one</code>, <code>expl_arity = 1</code>, and after one <code>intro1</code>, the goal is <code>f i</code>.</p>



<a name="192745700"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192745700" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192745700">(Apr 03 2020 at 00:31)</a>:</h4>
<p>What I had in mind was to just build the required <code>expr</code> directly from the constructors.</p>



<a name="192745793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192745793" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192745793">(Apr 03 2020 at 00:32)</a>:</h4>
<p>My tactic programming skills are, let's say, far from being good.</p>



<a name="192745803"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192745803" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192745803">(Apr 03 2020 at 00:32)</a>:</h4>
<p>exactly, don't use tactics!</p>



<a name="192745816"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192745816" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192745816">(Apr 03 2020 at 00:33)</a>:</h4>
<p>What do you propose?</p>



<a name="192745828"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192745828" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192745828">(Apr 03 2020 at 00:33)</a>:</h4>
<p>Should we have <code>pi_instance</code> tactic or not?</p>



<a name="192745957"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192745957" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192745957">(Apr 03 2020 at 00:35)</a>:</h4>
<p>Of course, we can leave only <code>Prop</code> branch, and use <code>:= by refine_struct { one := (1 : Π i, f i) }; pi_props</code></p>



<a name="192745983"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192745983" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192745983">(Apr 03 2020 at 00:35)</a>:</h4>
<p>This will give us all the required defeq's.</p>



<a name="192746076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746076">(Apr 03 2020 at 00:36)</a>:</h4>
<p>But if we want to generate all fields automatically, then we need some meta code analyzing the target.</p>



<a name="192746099"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746099" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746099">(Apr 03 2020 at 00:36)</a>:</h4>
<p>The current code works well for unary and binary operations but fails for constants.</p>



<a name="192746231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746231" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746231">(Apr 03 2020 at 00:38)</a>:</h4>
<p>The </p>
<div class="codehilite"><pre><span></span><span class="n">xs</span><span class="bp">.</span><span class="n">mmap&#39;</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">h</span><span class="o">,</span> <span class="n">try</span> <span class="err">$</span>
      <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">apply</span> <span class="o">(</span><span class="n">h</span> <span class="n">x</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span> <span class="n">apply</span> <span class="n">h</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
      <span class="n">refine</span> <span class="bp">``</span><span class="o">(</span><span class="n">set</span><span class="bp">.</span><span class="n">image</span> <span class="o">(</span><span class="err">$</span> <span class="err">%%</span><span class="n">x</span><span class="o">)</span> <span class="err">%%</span><span class="n">h</span><span class="o">))</span> <span class="bp">&lt;|&gt;</span> <span class="n">fail</span> <span class="s2">&quot;args&quot;</span><span class="o">,</span>
</pre></div>


<p>block deserves some documentation. :-)</p>



<a name="192746264"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746264" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746264">(Apr 03 2020 at 00:39)</a>:</h4>
<p>(but I think is unrelated to what we're seeing at the moment)</p>



<a name="192746395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746395">(Apr 03 2020 at 00:41)</a>:</h4>
<p><span class="user-mention" data-user-id="110087">@Scott Morrison</span> I added some <code>trace</code>s, and the goal <code>one</code> is closed by <code>x ← intro1</code></p>



<a name="192746483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746483">(Apr 03 2020 at 00:42)</a>:</h4>
<p>how does the rest of the tactic not fail, then?</p>



<a name="192746489"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746489" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746489">(Apr 03 2020 at 00:42)</a>:</h4>
<p>doesn't <code>applyc</code> choke when there's no goal?</p>



<a name="192746492"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746492" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746492">(Apr 03 2020 at 00:42)</a>:</h4>
<p>I'm confused</p>



<a name="192746509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746509">(Apr 03 2020 at 00:43)</a>:</h4>
<p>It just exits. At least <code>trace</code> doesn't print anything.</p>



<a name="192746651"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746651" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746651">(Apr 03 2020 at 00:45)</a>:</h4>
<p>It seems easy to get the target type and appropriate bits of the context and compute by a pure function the term which we should produce.</p>



<a name="192746659"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746659" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746659">(Apr 03 2020 at 00:45)</a>:</h4>
<p>I can't try right now because I need to prepare a seminar for tomorrow</p>



<a name="192746722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746722" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746722">(Apr 03 2020 at 00:46)</a>:</h4>
<p>I don't understand how this manages to define <code>pi.monoid</code>:</p>
<div class="codehilite"><pre><span></span><span class="kn">namespace</span> <span class="n">tactic</span>

<span class="kn">open</span> <span class="n">interactive</span> <span class="n">interactive</span><span class="bp">.</span><span class="n">types</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span> <span class="n">expr</span>
<span class="kn">open</span> <span class="n">functor</span> <span class="n">has_seq</span> <span class="n">list</span> <span class="n">nat</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">set_option</span> <span class="n">pp</span><span class="bp">.</span><span class="n">all</span> <span class="n">true</span>
<span class="n">meta</span> <span class="n">def</span> <span class="n">derive_field&#39;</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">b</span> <span class="err">←</span> <span class="n">target</span> <span class="bp">&gt;&gt;=</span> <span class="n">is_prop</span><span class="o">,</span>
   <span class="n">field</span> <span class="err">←</span> <span class="n">get_current_field</span><span class="o">,</span>
   <span class="k">if</span> <span class="n">b</span> <span class="k">then</span> <span class="n">do</span>
     <span class="n">field</span> <span class="err">←</span> <span class="n">get_current_field</span><span class="o">,</span>
     <span class="n">vs</span> <span class="err">←</span> <span class="n">introv</span> <span class="o">[]</span> <span class="bp">&lt;|&gt;</span> <span class="n">pure</span> <span class="o">[],</span>
     <span class="n">hs</span> <span class="err">←</span> <span class="n">intros</span> <span class="bp">&lt;|&gt;</span> <span class="n">pure</span> <span class="o">[],</span>
     <span class="n">resetI</span><span class="o">,</span>
     <span class="n">x</span> <span class="err">←</span> <span class="n">get_unused_name</span><span class="o">,</span>
     <span class="n">try</span> <span class="o">(()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="n">ext1</span> <span class="o">[</span><span class="n">rcases_patt</span><span class="bp">.</span><span class="n">one</span> <span class="n">x</span><span class="o">]</span> <span class="bp">&lt;|&gt;</span> <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="n">intro</span> <span class="n">x</span><span class="o">),</span>
     <span class="n">x&#39;</span> <span class="err">←</span> <span class="n">try_core</span> <span class="o">(</span><span class="n">get_local</span> <span class="n">x</span><span class="o">),</span>
     <span class="n">applyc</span> <span class="n">field</span><span class="o">,</span>
     <span class="n">hs</span><span class="bp">.</span><span class="n">mmap</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">h</span><span class="o">,</span> <span class="n">try</span> <span class="err">$</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="n">congr_fun</span> <span class="err">%%</span><span class="n">h</span> <span class="err">%%</span><span class="o">(</span><span class="n">x&#39;</span><span class="bp">.</span><span class="n">iget</span><span class="o">))</span> <span class="bp">&gt;&gt;=</span> <span class="n">apply</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="n">apply</span> <span class="o">(</span><span class="n">h</span> <span class="n">x&#39;</span><span class="bp">.</span><span class="n">iget</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="n">set</span><span class="bp">.</span><span class="n">mem_image_of_mem</span> <span class="bp">_</span> <span class="err">%%</span><span class="n">h</span><span class="o">)</span> <span class="bp">&gt;&gt;=</span> <span class="n">apply</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">solve_by_elim</span><span class="o">)</span> <span class="o">),</span>
     <span class="n">return</span> <span class="o">()</span>
   <span class="k">else</span> <span class="n">focus1</span> <span class="err">$</span> <span class="n">do</span>
     <span class="n">field</span> <span class="err">←</span> <span class="n">get_current_field</span><span class="o">,</span>
     <span class="n">e</span> <span class="err">←</span> <span class="n">mk_const</span> <span class="n">field</span><span class="o">,</span>
     <span class="n">expl_arity</span> <span class="err">←</span> <span class="n">get_expl_arity</span> <span class="n">e</span><span class="o">,</span>
     <span class="n">xs</span> <span class="err">←</span> <span class="o">(</span><span class="n">iota</span> <span class="n">expl_arity</span><span class="o">)</span><span class="bp">.</span><span class="n">mmap</span> <span class="err">$</span> <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="n">intro1</span><span class="o">,</span>
     <span class="n">t</span> <span class="err">←</span> <span class="n">target</span> <span class="bp">&gt;&gt;=</span> <span class="n">whnf</span><span class="o">,</span>
     <span class="k">if</span> <span class="n">expr</span><span class="bp">.</span><span class="n">is_pi</span> <span class="n">t</span> <span class="k">then</span> <span class="n">do</span>
       <span class="n">trace</span> <span class="n">field</span><span class="o">,</span>
       <span class="n">x</span> <span class="err">←</span> <span class="n">intro1</span><span class="o">,</span>
       <span class="n">applyc</span> <span class="n">field</span><span class="o">,</span>
       <span class="n">xs</span><span class="bp">.</span><span class="n">mmap&#39;</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">h</span><span class="o">,</span> <span class="n">apply</span> <span class="o">(</span><span class="n">h</span> <span class="n">x</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span> <span class="n">apply</span> <span class="n">h</span><span class="o">),</span>
       <span class="n">return</span> <span class="o">()</span>
     <span class="k">else</span> <span class="n">return</span> <span class="o">()</span>

<span class="c">/-</span><span class="cm">-</span>
<span class="cm">`pi_instance` constructs an instance of `my_class (Π i : I, f i)`</span>
<span class="cm">where we know `Π i, my_class (f i)`. If an order relation is required,</span>
<span class="cm">it defaults to `pi.partial_order`. Any field of the instance that</span>
<span class="cm">`pi_instance` cannot construct is left untouched and generated as a new goal.</span>
<span class="cm">-/</span>
<span class="n">meta</span> <span class="n">def</span> <span class="n">pi_instance&#39;</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">refine_struct</span> <span class="bp">``</span><span class="o">(</span> <span class="o">{</span>  <span class="bp">..</span><span class="n">pi</span><span class="bp">.</span><span class="n">partial_order</span><span class="o">,</span> <span class="bp">..</span> <span class="o">}</span> <span class="o">)</span><span class="bp">;</span>
  <span class="n">propagate_tags</span> <span class="o">(</span><span class="n">try</span> <span class="o">(</span><span class="n">derive_field&#39;</span> <span class="bp">;</span> <span class="n">done</span><span class="o">))</span>

<span class="n">run_cmd</span> <span class="n">add_interactive</span> <span class="o">[</span><span class="bp">`</span><span class="n">pi_instance&#39;</span><span class="o">]</span>

<span class="kn">end</span> <span class="n">tactic</span>
</pre></div>



<a name="192746797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746797" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746797">(Apr 03 2020 at 00:47)</a>:</h4>
<p>(I put this at the top of <code>algebra/pi_instances.lean</code> to avoid compiling other files)</p>



<a name="192746868"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746868" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746868">(Apr 03 2020 at 00:48)</a>:</h4>
<p><span class="user-mention" data-user-id="110032">@Reid Barton</span> May I open an issue and assign it to you?</p>



<a name="192746874"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746874" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746874">(Apr 03 2020 at 00:48)</a>:</h4>
<p>oh ....</p>



<a name="192746886"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746886" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746886">(Apr 03 2020 at 00:49)</a>:</h4>
<p>I think what is going on is that <code>derive_field</code> is actually _failing_ on <code>one</code>.</p>



<a name="192746896"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746896" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746896">(Apr 03 2020 at 00:49)</a>:</h4>
<p>Which by itself is fine, it's wrapped in <code>try</code>.</p>



<a name="192746900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746900" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746900">(Apr 03 2020 at 00:49)</a>:</h4>
<p>However we then plough on trying to <code>derive_field</code> the axioms as well.</p>



<a name="192746906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746906" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746906">(Apr 03 2020 at 00:49)</a>:</h4>
<p>And somehow <code>one</code> is solved by unification at a later step.</p>



<a name="192746964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746964">(Apr 03 2020 at 00:50)</a>:</h4>
<p>But we mess up and introduce the bad answer there?</p>



<a name="192746983"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746983" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746983">(Apr 03 2020 at 00:50)</a>:</h4>
<p>Indeed!</p>



<a name="192746988"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192746988" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192746988">(Apr 03 2020 at 00:50)</a>:</h4>
<p>Removed <code>try</code>, and now it fails.</p>



<a name="192747082"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747082" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747082">(Apr 03 2020 at 00:52)</a>:</h4>
<p>Yes, look at this, from <code>trace_state</code> at the beginning of solving <code>zero_add</code>:</p>
<div class="codehilite"><pre><span></span>(@has_zero.zero.{(max u v)} (Π (i : I), f i)
            (@has_zero.mk.{(max u v)} (Π (i : I), f i)
               (@eq.mpr.{(max (u+1) (v+1))} (Π (i : I), f i) (Π (i : I), f i)
                  (@id.{0} (@eq.{(max (u+1) (v+1))+1} (Type (max u v)) (Π (i : I), f i) (Π (i : I), f i))
                     (@eq.refl.{(max (u+1) (v+1))+1} (Type (max u v)) (Π (i : I), f i)))
                  ?m_1)))
         a)
</pre></div>


<p>We've just got a metavariable for <code>zero</code>!</p>



<a name="192747099"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747099" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747099">(Apr 03 2020 at 00:52)</a>:</h4>
<p>Until you turn <code>pp.all</code> on, you can't even see this. It just happily prints as <code>0</code>...</p>



<a name="192747126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747126">(Apr 03 2020 at 00:53)</a>:</h4>
<p>Kind of scary that this was working at all. :-)</p>



<a name="192747225"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747225" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747225">(Apr 03 2020 at 00:54)</a>:</h4>
<p>Haha...</p>



<a name="192747228"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747228" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747228">(Apr 03 2020 at 00:54)</a>:</h4>
<p>it turns out we've already fixed this issue</p>



<a name="192747247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747247">(Apr 03 2020 at 00:55)</a>:</h4>
<p><a href="https://github.com/leanprover-community/lean/pull/169" title="https://github.com/leanprover-community/lean/pull/169">https://github.com/leanprover-community/lean/pull/169</a></p>



<a name="192747251"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747251" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747251">(Apr 03 2020 at 00:55)</a>:</h4>
<p>This is the reason why we're seeing arity = 1 on <code>zero</code> and <code>one</code>.</p>



<a name="192747308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747308">(Apr 03 2020 at 00:56)</a>:</h4>
<p>I suspect that when this gets merged, and we move to Lean 3.8, <code>derive_field</code> will no longer fail, the <code>eq.mpr</code> will disappear, and we'll all be happy.</p>



<a name="192747345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747345">(Apr 03 2020 at 00:57)</a>:</h4>
<p>I don't think so. The target is <code>Π i, f i</code>, so it actually has arity = 1</p>



<a name="192747429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747429">(Apr 03 2020 at 00:58)</a>:</h4>
<p>oh, hrm.</p>



<a name="192747540"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747540" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747540">(Apr 03 2020 at 01:00)</a>:</h4>
<p>BTW, now I'm testing on <code>has_zero</code> instead of <code>monoid</code>.</p>



<a name="192747551"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747551" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747551">(Apr 03 2020 at 01:00)</a>:</h4>
<p>I don't think that's what <code>expl_arity</code> is meant to mean. Notice that it is 2 for <code>add</code>, and 1 for <code>zero</code>.</p>



<a name="192747562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747562">(Apr 03 2020 at 01:00)</a>:</h4>
<p>It should be 2 for <code>add</code>, and 0 for <code>zero</code>.</p>



<a name="192747586"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747586" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747586">(Apr 03 2020 at 01:01)</a>:</h4>
<p>With <code>has_zero</code> we'll just see it fail at the <code>x &lt;- intro1</code> line.</p>



<a name="192747699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747699" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747699">(Apr 03 2020 at 01:02)</a>:</h4>
<p>This works for <code>has_zero</code> but gives <code>eq.mpr</code> in the result:</p>
<div class="codehilite"><pre><span></span><span class="kn">namespace</span> <span class="n">tactic</span>

<span class="kn">open</span> <span class="n">interactive</span> <span class="n">interactive</span><span class="bp">.</span><span class="n">types</span> <span class="n">lean</span><span class="bp">.</span><span class="n">parser</span> <span class="n">expr</span>
<span class="kn">open</span> <span class="n">functor</span> <span class="n">has_seq</span> <span class="n">list</span> <span class="n">nat</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="n">meta</span> <span class="n">def</span> <span class="n">derive_field&#39;</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">b</span> <span class="err">←</span> <span class="n">target</span> <span class="bp">&gt;&gt;=</span> <span class="n">is_prop</span><span class="o">,</span>
   <span class="n">field</span> <span class="err">←</span> <span class="n">get_current_field</span><span class="o">,</span>
   <span class="k">if</span> <span class="n">b</span> <span class="k">then</span> <span class="n">do</span>
     <span class="n">field</span> <span class="err">←</span> <span class="n">get_current_field</span><span class="o">,</span>
     <span class="n">vs</span> <span class="err">←</span> <span class="n">introv</span> <span class="o">[]</span> <span class="bp">&lt;|&gt;</span> <span class="n">pure</span> <span class="o">[],</span>
     <span class="n">hs</span> <span class="err">←</span> <span class="n">intros</span> <span class="bp">&lt;|&gt;</span> <span class="n">pure</span> <span class="o">[],</span>
     <span class="n">resetI</span><span class="o">,</span>
     <span class="n">x</span> <span class="err">←</span> <span class="n">get_unused_name</span><span class="o">,</span>
     <span class="n">try</span> <span class="o">(()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="n">ext1</span> <span class="o">[</span><span class="n">rcases_patt</span><span class="bp">.</span><span class="n">one</span> <span class="n">x</span><span class="o">]</span> <span class="bp">&lt;|&gt;</span> <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="n">intro</span> <span class="n">x</span><span class="o">),</span>
     <span class="n">x&#39;</span> <span class="err">←</span> <span class="n">try_core</span> <span class="o">(</span><span class="n">get_local</span> <span class="n">x</span><span class="o">),</span>
     <span class="n">applyc</span> <span class="n">field</span><span class="o">,</span>
     <span class="n">hs</span><span class="bp">.</span><span class="n">mmap</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">h</span><span class="o">,</span> <span class="n">try</span> <span class="err">$</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="n">congr_fun</span> <span class="err">%%</span><span class="n">h</span> <span class="err">%%</span><span class="o">(</span><span class="n">x&#39;</span><span class="bp">.</span><span class="n">iget</span><span class="o">))</span> <span class="bp">&gt;&gt;=</span> <span class="n">apply</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="n">apply</span> <span class="o">(</span><span class="n">h</span> <span class="n">x&#39;</span><span class="bp">.</span><span class="n">iget</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="n">set</span><span class="bp">.</span><span class="n">mem_image_of_mem</span> <span class="bp">_</span> <span class="err">%%</span><span class="n">h</span><span class="o">)</span> <span class="bp">&gt;&gt;=</span> <span class="n">apply</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">solve_by_elim</span><span class="o">)</span> <span class="o">),</span>
     <span class="n">return</span> <span class="o">()</span>
   <span class="k">else</span> <span class="n">focus1</span> <span class="err">$</span> <span class="n">do</span>
     <span class="n">field</span> <span class="err">←</span> <span class="n">get_current_field</span><span class="o">,</span>
     <span class="n">e</span> <span class="err">←</span> <span class="n">mk_const</span> <span class="n">field</span><span class="o">,</span>
     <span class="n">expl_arity</span> <span class="err">←</span> <span class="n">get_expl_arity</span> <span class="n">e</span><span class="o">,</span>
     <span class="n">xs</span> <span class="err">←</span> <span class="o">(</span><span class="n">iota</span> <span class="n">expl_arity</span><span class="o">)</span><span class="bp">.</span><span class="n">mmap</span> <span class="err">$</span> <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="n">intro1</span><span class="o">,</span>
     <span class="n">t</span> <span class="err">←</span> <span class="n">target</span> <span class="bp">&gt;&gt;=</span> <span class="n">whnf</span><span class="o">,</span>
     <span class="k">if</span> <span class="n">expr</span><span class="bp">.</span><span class="n">is_pi</span> <span class="n">t</span> <span class="k">then</span> <span class="n">do</span>
       <span class="n">x</span> <span class="err">←</span> <span class="n">intro1</span><span class="o">,</span>
       <span class="n">applyc</span> <span class="n">field</span><span class="o">,</span>
       <span class="n">xs</span><span class="bp">.</span><span class="n">mmap&#39;</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">h</span><span class="o">,</span> <span class="n">apply</span> <span class="o">(</span><span class="n">h</span> <span class="n">x</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span> <span class="n">apply</span> <span class="n">h</span><span class="o">),</span>
       <span class="n">return</span> <span class="o">()</span>
     <span class="k">else</span>
       <span class="n">applyc</span> <span class="n">field</span><span class="o">,</span>
       <span class="n">return</span> <span class="o">()</span>

<span class="c">/-</span><span class="cm">-</span>
<span class="cm">`pi_instance` constructs an instance of `my_class (Π i : I, f i)`</span>
<span class="cm">where we know `Π i, my_class (f i)`. If an order relation is required,</span>
<span class="cm">it defaults to `pi.partial_order`. Any field of the instance that</span>
<span class="cm">`pi_instance` cannot construct is left untouched and generated as a new goal.</span>
<span class="cm">-/</span>
<span class="n">meta</span> <span class="n">def</span> <span class="n">pi_instance&#39;</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">refine_struct</span> <span class="bp">``</span><span class="o">(</span> <span class="o">{</span>  <span class="bp">..</span><span class="n">pi</span><span class="bp">.</span><span class="n">partial_order</span><span class="o">,</span> <span class="bp">..</span> <span class="o">}</span> <span class="o">)</span><span class="bp">;</span>
  <span class="n">propagate_tags</span> <span class="o">(</span><span class="n">derive_field&#39;</span> <span class="bp">;</span> <span class="n">done</span><span class="o">)</span>

<span class="n">run_cmd</span> <span class="n">add_interactive</span> <span class="o">[</span><span class="bp">`</span><span class="n">pi_instance&#39;</span><span class="o">]</span>

<span class="kn">end</span> <span class="n">tactic</span>
</pre></div>



<a name="192747800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747800">(Apr 03 2020 at 01:04)</a>:</h4>
<p>I see. You're saying that the <code>applyc</code> call introduces an <code>eq.mpr</code> all by itself?</p>



<a name="192747814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192747814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192747814">(Apr 03 2020 at 01:04)</a>:</h4>
<p>Can we reproduce that in a standalone tactic block, independent of using <code>pi_instance</code>?</p>



<a name="192748176"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748176" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748176">(Apr 03 2020 at 01:10)</a>:</h4>
<p>How do I try to close the goal using <code>apply e</code>, and do something else if it fails?</p>



<a name="192748179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748179">(Apr 03 2020 at 01:10)</a>:</h4>
<p>I mean, inside <code>do</code> block</p>



<a name="192748234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748234">(Apr 03 2020 at 01:12)</a>:</h4>
<p><code>&lt;|&gt;</code></p>



<a name="192748289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748289" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748289">(Apr 03 2020 at 01:12)</a>:</h4>
<p>I'm remaining pretty sure the problem is the <code>expl_arity</code> being reported for <code>one</code> is wrong.</p>



<a name="192748295"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748295" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748295">(Apr 03 2020 at 01:12)</a>:</h4>
<p>Your last update to <code>derive_field</code> doesn't make sense.</p>



<a name="192748315"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748315" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748315">(Apr 03 2020 at 01:13)</a>:</h4>
<p>The <code>else</code> branch of </p>
<div class="codehilite"><pre><span></span>if expr.is_pi t then do
       x ← intro1,
       applyc field,
       xs.mmap&#39; (λ h, apply (h x) &lt;|&gt; apply h),
       return ()
     else
       applyc field,
       return ()
</pre></div>


<p>really needs to have a <code>x ← intro1</code> to consume the argument of the Pi type</p>



<a name="192748338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748338" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748338">(Apr 03 2020 at 01:13)</a>:</h4>
<p>Your code is working without it because <code>expl_arity</code> is wrong for <code>zero</code>/<code>one</code> because of the explicit argument in <code>has_zero</code>/<code>has_one</code> that is fixed in that PR I linked above.</p>



<a name="192748391"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748391" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748391">(Apr 03 2020 at 01:14)</a>:</h4>
<p>Try to add <code>trace target</code> before <code>expl_arity</code>.</p>



<a name="192748494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748494">(Apr 03 2020 at 01:16)</a>:</h4>
<p>Sorry, you're right.</p>



<a name="192748497"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748497" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748497">(Apr 03 2020 at 01:16)</a>:</h4>
<p><code>e</code> is <code>has_one.one</code>.</p>



<a name="192748538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748538" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748538">(Apr 03 2020 at 01:17)</a>:</h4>
<p>Actually, while I remain convinced <code>expl_arity</code> is being calculated incorrectly, I no longer believe it's because of this implicit/explict argument in<code>has_one</code>.</p>



<a name="192748571"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748571" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748571">(Apr 03 2020 at 01:18)</a>:</h4>
<p>The target before <code>expl_arity</code> in <code>has_add</code> is</p>
<div class="codehilite"><pre><span></span>(Π (i : I), f i) → (Π (i : I), f i) → Π (i : I), f i
</pre></div>


<p>and we get told <code>2</code></p>



<a name="192748603"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748603" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748603">(Apr 03 2020 at 01:18)</a>:</h4>
<p>The target before <code>expl_arity</code> in <code>has_zero</code> is </p>
<div class="codehilite"><pre><span></span>Π (i : I), f i
</pre></div>


<p>and we get told <code>1</code></p>



<a name="192748606"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748606" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748606">(Apr 03 2020 at 01:18)</a>:</h4>
<p>These are not consistent.</p>



<a name="192748630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748630" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748630">(Apr 03 2020 at 01:19)</a>:</h4>
<p>I think in the <code>has_add</code> case it should be <code>3</code>?</p>



<a name="192748706"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748706" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748706">(Apr 03 2020 at 01:20)</a>:</h4>
<p>oh, no, it is the PR I was talking about</p>



<a name="192748707"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748707" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748707">(Apr 03 2020 at 01:20)</a>:</h4>
<p>That's why we have <code>x</code> and <code>xs</code>.<br>
P.S.: Please use syntax highlighting.</p>



<a name="192748711"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748711" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748711">(Apr 03 2020 at 01:21)</a>:</h4>
<p>it's not the <code>target</code> that matters, it is <code>e</code> that matters.</p>



<a name="192748732"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748732" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748732">(Apr 03 2020 at 01:21)</a>:</h4>
<p>and the <code>expl_arity</code> of <code>add_comm_monoid.add.{?l_1}</code> is (correctly) 2</p>



<a name="192748733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748733" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748733">(Apr 03 2020 at 01:21)</a>:</h4>
<p>This defines <code>pi.has_one</code> but still produces <code>eq.mpr</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">meta</span> <span class="n">def</span> <span class="n">derive_field&#39;</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">do</span> <span class="n">b</span> <span class="err">←</span> <span class="n">target</span> <span class="bp">&gt;&gt;=</span> <span class="n">is_prop</span><span class="o">,</span>
   <span class="n">field</span> <span class="err">←</span> <span class="n">get_current_field</span><span class="o">,</span>
   <span class="k">if</span> <span class="n">b</span> <span class="k">then</span> <span class="n">do</span>
     <span class="n">field</span> <span class="err">←</span> <span class="n">get_current_field</span><span class="o">,</span>
     <span class="n">vs</span> <span class="err">←</span> <span class="n">introv</span> <span class="o">[]</span> <span class="bp">&lt;|&gt;</span> <span class="n">pure</span> <span class="o">[],</span>
     <span class="n">hs</span> <span class="err">←</span> <span class="n">intros</span> <span class="bp">&lt;|&gt;</span> <span class="n">pure</span> <span class="o">[],</span>
     <span class="n">resetI</span><span class="o">,</span>
     <span class="n">x</span> <span class="err">←</span> <span class="n">get_unused_name</span><span class="o">,</span>
     <span class="n">try</span> <span class="o">(()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="n">ext1</span> <span class="o">[</span><span class="n">rcases_patt</span><span class="bp">.</span><span class="n">one</span> <span class="n">x</span><span class="o">]</span> <span class="bp">&lt;|&gt;</span> <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="n">intro</span> <span class="n">x</span><span class="o">),</span>
     <span class="n">x&#39;</span> <span class="err">←</span> <span class="n">try_core</span> <span class="o">(</span><span class="n">get_local</span> <span class="n">x</span><span class="o">),</span>
     <span class="n">applyc</span> <span class="n">field</span><span class="o">,</span>
     <span class="n">hs</span><span class="bp">.</span><span class="n">mmap</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">h</span><span class="o">,</span> <span class="n">try</span> <span class="err">$</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="n">congr_fun</span> <span class="err">%%</span><span class="n">h</span> <span class="err">%%</span><span class="o">(</span><span class="n">x&#39;</span><span class="bp">.</span><span class="n">iget</span><span class="o">))</span> <span class="bp">&gt;&gt;=</span> <span class="n">apply</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="n">apply</span> <span class="o">(</span><span class="n">h</span> <span class="n">x&#39;</span><span class="bp">.</span><span class="n">iget</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="n">set</span><span class="bp">.</span><span class="n">mem_image_of_mem</span> <span class="bp">_</span> <span class="err">%%</span><span class="n">h</span><span class="o">)</span> <span class="bp">&gt;&gt;=</span> <span class="n">apply</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
       <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">solve_by_elim</span><span class="o">)</span> <span class="o">),</span>
     <span class="n">return</span> <span class="o">()</span>
   <span class="k">else</span> <span class="n">focus1</span> <span class="err">$</span> <span class="n">do</span>
     <span class="n">field</span> <span class="err">←</span> <span class="n">get_current_field</span><span class="o">,</span>
     <span class="n">e</span> <span class="err">←</span> <span class="n">mk_const</span> <span class="n">field</span><span class="o">,</span>
     <span class="n">expl_arity</span> <span class="err">←</span> <span class="k">if</span> <span class="n">field</span> <span class="bp">=</span> <span class="bp">`</span><span class="n">has_one</span><span class="bp">.</span><span class="n">one</span> <span class="k">then</span> <span class="n">return</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">get_expl_arity</span> <span class="n">e</span><span class="o">,</span>
     <span class="n">xs</span> <span class="err">←</span> <span class="o">(</span><span class="n">iota</span> <span class="n">expl_arity</span><span class="o">)</span><span class="bp">.</span><span class="n">mmap</span> <span class="err">$</span> <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="n">intro1</span><span class="o">,</span>
     <span class="n">x</span> <span class="err">←</span> <span class="n">intro_core</span> <span class="bp">`_</span><span class="o">,</span>
     <span class="n">applyc</span> <span class="n">field</span><span class="o">,</span>
     <span class="n">xs</span><span class="bp">.</span><span class="n">mmap&#39;</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">h</span><span class="o">,</span> <span class="n">try</span> <span class="err">$</span>
      <span class="o">()</span> <span class="bp">&lt;</span><span class="err">$</span> <span class="o">(</span><span class="n">apply</span> <span class="o">(</span><span class="n">h</span> <span class="n">x</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span> <span class="n">apply</span> <span class="n">h</span><span class="o">)</span> <span class="bp">&lt;|&gt;</span>
      <span class="n">refine</span> <span class="bp">``</span><span class="o">(</span><span class="n">set</span><span class="bp">.</span><span class="n">image</span> <span class="o">(</span><span class="err">$</span> <span class="err">%%</span><span class="n">x</span><span class="o">)</span> <span class="err">%%</span><span class="n">h</span><span class="o">))</span> <span class="bp">&lt;|&gt;</span> <span class="n">fail</span> <span class="s2">&quot;args&quot;</span><span class="o">,</span>
     <span class="n">return</span> <span class="o">()</span>
</pre></div>



<a name="192748749"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748749" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748749">(Apr 03 2020 at 01:21)</a>:</h4>
<p>and the <code>expl_arity</code> of <code>has_zero.zero.{?l_1}</code> is (suprisingly) 1</p>



<a name="192748801"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748801" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748801">(Apr 03 2020 at 01:22)</a>:</h4>
<p>Interesting, let me try that</p>



<a name="192748956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192748956" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192748956">(Apr 03 2020 at 01:25)</a>:</h4>
<p>Okay, I agree that is sensible code, and still produces an <code>eq.mpr</code>.</p>



<a name="192749005"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749005" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749005">(Apr 03 2020 at 01:26)</a>:</h4>
<p>Here is an MWE:</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">has_zero</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_zero</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="bp">..</span> <span class="o">}</span><span class="bp">;</span> <span class="n">intros</span><span class="bp">;</span> <span class="n">apply</span> <span class="n">has_zero</span><span class="bp">.</span><span class="n">zero</span>

<span class="bp">#</span><span class="kn">print</span> <span class="n">pi</span><span class="bp">.</span><span class="n">has_zero</span>
</pre></div>



<a name="192749098"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749098" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749098">(Apr 03 2020 at 01:28)</a>:</h4>
<p>So it is a bug in <code>refine_struct</code>.</p>



<a name="192749101"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749101" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749101">(Apr 03 2020 at 01:28)</a>:</h4>
<p>It works with <code>refine</code>.</p>



<a name="192749114"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749114" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749114">(Apr 03 2020 at 01:29)</a>:</h4>
<p>And a completely standalone example:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">namespace</span> <span class="n">pi</span>
<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span>
<span class="kn">variable</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span>     <span class="c1">-- The indexing type</span>
<span class="kn">variable</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">→</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="c1">-- The family of types already equipped with instances</span>

<span class="kn">instance</span> <span class="n">has_zero</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_zero</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="bp">..</span> <span class="o">}</span><span class="bp">;</span> <span class="n">propagate_tags</span> <span class="o">(</span><span class="n">do</span>
  <span class="n">tactic</span><span class="bp">.</span><span class="n">intro1</span><span class="o">,</span>
  <span class="n">tactic</span><span class="bp">.</span><span class="n">applyc</span> <span class="bp">`</span><span class="n">has_zero</span><span class="bp">.</span><span class="n">zero</span><span class="o">)</span>

<span class="kn">set_option</span> <span class="n">pp</span><span class="bp">.</span><span class="n">all</span> <span class="n">true</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">pi</span><span class="bp">.</span><span class="n">has_zero</span>

<span class="kn">end</span> <span class="n">pi</span>
</pre></div>



<a name="192749168"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749168" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749168">(Apr 03 2020 at 01:30)</a>:</h4>
<p><code>refine_struct</code> produces an <code>eq.mpr</code>, <code>refine</code> doesn't.</p>



<a name="192749185"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749185" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749185">(Apr 03 2020 at 01:31)</a>:</h4>
<p>And <code>refine_struct</code> is too long for me to understand and catch the bug.</p>



<a name="192749259"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749259" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749259">(Apr 03 2020 at 01:33)</a>:</h4>
<p>Yeah, I'm looking through it now. Hopefully <span class="user-mention" data-user-id="110026">@Simon Hudon</span> will stop by sometime. :-)</p>



<a name="192749423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749423">(Apr 03 2020 at 01:36)</a>:</h4>
<p>I'm worried it falls all the way down to <code>meta constant pexpr.mk_structure_instance : structure_instance_info → pexpr</code>.</p>



<a name="192749486"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749486" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749486">(Apr 03 2020 at 01:38)</a>:</h4>
<p>no, that makes no sense, it is just producing something with metavariables:  <code>@has_zero.mk.{?l_1} ?m_2 ?m_3</code></p>



<a name="192749589"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749589" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749589">(Apr 03 2020 at 01:41)</a>:</h4>
<p>In</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">namespace</span> <span class="n">pi</span>
<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span>
<span class="kn">variable</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span>     <span class="c1">-- The indexing type</span>
<span class="kn">variable</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">→</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="c1">-- The family of types already equipped with instances</span>

<span class="kn">set_option</span> <span class="n">pp</span><span class="bp">.</span><span class="n">all</span> <span class="n">true</span>

<span class="kn">open</span> <span class="n">tactic</span>

<span class="kn">instance</span> <span class="n">has_zero</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_zero</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine_struct</span> <span class="o">{</span> <span class="bp">..</span> <span class="o">},</span>
  <span class="n">result</span> <span class="bp">&gt;&gt;=</span> <span class="n">trace</span><span class="o">,</span>
  <span class="o">(</span><span class="n">do</span>
  <span class="n">tactic</span><span class="bp">.</span><span class="n">intro1</span><span class="o">,</span>
  <span class="n">tactic</span><span class="bp">.</span><span class="n">applyc</span> <span class="bp">`</span><span class="n">has_zero</span><span class="bp">.</span><span class="n">zero</span><span class="o">)</span>
<span class="kn">end</span>

<span class="bp">#</span><span class="kn">print</span> <span class="n">pi</span><span class="bp">.</span><span class="n">has_zero</span>

<span class="kn">end</span> <span class="n">pi</span>
</pre></div>


<p>You can clearly see that the problem has already occurred by the time we leave <code>refine_struct</code>: the <code>eq.mpr</code> is there no matter how we discharge the goal later.</p>



<a name="192749607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749607" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749607">(Apr 03 2020 at 01:41)</a>:</h4>
<p>Even shorter:</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">has_zero</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_zero</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="bp">..</span> <span class="o">}</span><span class="bp">;</span> <span class="n">exact</span> <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="mi">0</span>
</pre></div>



<a name="192749784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192749784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192749784">(Apr 03 2020 at 01:45)</a>:</h4>
<p>You can wrap the whole <code>refine_struct { .. }; exact λ _, 0</code> with <code>simp_result</code>, and successfully clear the <code>eq.mpr</code>, but it's not possible to fix <code>refine_struct</code> this way: until the metavariables have been filled in <code>simp_result</code> doesn't work.</p>



<a name="192750058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750058">(Apr 03 2020 at 01:50)</a>:</h4>
<p>Ok, the <code>eq.mpr</code> in the <code>result</code> is introduced in the line</p>
<div class="codehilite"><pre><span></span>      <span class="n">gs</span> <span class="err">←</span> <span class="n">with_enable_tags</span> <span class="o">(</span>
        <span class="n">mzip_with</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">name</span> <span class="bp">×</span> <span class="n">name</span><span class="o">)</span> <span class="n">v</span><span class="o">,</span> <span class="n">do</span>
           <span class="n">set_goals</span> <span class="o">[</span><span class="n">v</span><span class="o">],</span>
           <span class="n">try</span> <span class="o">(</span><span class="n">interactive</span><span class="bp">.</span><span class="n">unfold</span> <span class="o">(</span><span class="n">provided</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="bp">⟨</span><span class="n">s</span><span class="o">,</span><span class="n">f</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">update_prefix</span> <span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="n">loc</span><span class="bp">.</span><span class="n">ns</span> <span class="o">[</span><span class="n">none</span><span class="o">])),</span>
           <span class="n">apply_auto_param</span>
             <span class="bp">&lt;|&gt;</span> <span class="n">apply_opt_param</span>
             <span class="bp">&lt;|&gt;</span> <span class="o">(</span><span class="n">set_main_tag</span> <span class="o">[</span><span class="bp">`_</span><span class="n">field</span><span class="o">,</span><span class="n">n</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span><span class="n">n</span><span class="bp">.</span><span class="mi">1</span><span class="o">]),</span>
           <span class="n">get_goals</span><span class="o">)</span>
        <span class="n">missing_f&#39;</span> <span class="n">vs</span><span class="o">),</span>
</pre></div>


<p>in <code>meta def refine_one</code> in <code>tactic/interactive.lean</code>.</p>



<a name="192750071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750071">(Apr 03 2020 at 01:51)</a>:</h4>
<p>(You can <code>trace_result</code> before and after.)</p>



<a name="192750240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750240">(Apr 03 2020 at 01:54)</a>:</h4>
<p>And if we comment out the line </p>
<div class="codehilite"><pre><span></span><span class="n">try</span> <span class="o">(</span><span class="n">interactive</span><span class="bp">.</span><span class="n">unfold</span> <span class="o">(</span><span class="n">provided</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="bp">⟨</span><span class="n">s</span><span class="o">,</span><span class="n">f</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">update_prefix</span> <span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="n">loc</span><span class="bp">.</span><span class="n">ns</span> <span class="o">[</span><span class="n">none</span><span class="o">])),</span>
</pre></div>


<p>then the problem goes away.</p>



<a name="192750265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750265">(Apr 03 2020 at 01:55)</a>:</h4>
<p>Why do we need this line?</p>



<a name="192750414"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750414" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750414">(Apr 03 2020 at 01:59)</a>:</h4>
<p>When I read the code, I wish we had much more comments. Why do I forget about this when I write the code?</p>



<a name="192750420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750420">(Apr 03 2020 at 01:59)</a>:</h4>
<p>I have no idea. :-)</p>



<a name="192750421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750421">(Apr 03 2020 at 01:59)</a>:</h4>
<p>:-)</p>



<a name="192750435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750435" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750435">(Apr 03 2020 at 01:59)</a>:</h4>
<p>I will go and add extra comments to all my current PRs. I feel exactly the same way at the moment.</p>



<a name="192750494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750494">(Apr 03 2020 at 02:00)</a>:</h4>
<p>In fact I'm starting to think this is a bug in core again.</p>



<a name="192750509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750509">(Apr 03 2020 at 02:01)</a>:</h4>
<p>This <code>interactive.unfold</code> should be failing, on the basis that it's not really changing anything. Except, of course, that it is changing something: introducing this pesky <code>eq.mpr</code>!</p>



<a name="192750525"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750525" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750525">(Apr 03 2020 at 02:01)</a>:</h4>
<p>It seems we are calling <code>interactive.unfold [] (loc.ns [none])</code> here, which means <code>simp_core</code> is being called with no lemmas at all.</p>



<a name="192750530"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750530" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750530">(Apr 03 2020 at 02:01)</a>:</h4>
<p>So it has no excuse for doing anything.</p>



<a name="192750584"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750584" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750584">(Apr 03 2020 at 02:02)</a>:</h4>
<p>Can you try to turn it into an MWE?</p>



<a name="192750606"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750606" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750606">(Apr 03 2020 at 02:03)</a>:</h4>
<p>I mean, an example without <code>refine_struct</code>.</p>



<a name="192750619"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750619" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750619">(Apr 03 2020 at 02:03)</a>:</h4>
<p>Trying... if we just run</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">namespace</span> <span class="n">pi</span>
<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span>
<span class="kn">variable</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span>     <span class="c1">-- The indexing type</span>
<span class="kn">variable</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">→</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="c1">-- The family of types already equipped with instances</span>

<span class="kn">set_option</span> <span class="n">pp</span><span class="bp">.</span><span class="n">all</span> <span class="n">true</span>

<span class="kn">open</span> <span class="n">tactic</span>

<span class="kn">instance</span> <span class="n">has_zero</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_zero</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="o">{</span> <span class="bp">..</span> <span class="o">},</span>
  <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span><span class="bp">.</span><span class="n">unfold</span> <span class="o">[]</span> <span class="o">(</span><span class="n">interactive</span><span class="bp">.</span><span class="n">loc</span><span class="bp">.</span><span class="n">ns</span> <span class="o">[</span><span class="n">none</span><span class="o">]),</span>
  <span class="n">result</span> <span class="bp">&gt;&gt;=</span> <span class="n">trace</span><span class="o">,</span>
  <span class="n">exact</span> <span class="o">(</span><span class="bp">λ_</span><span class="o">,</span> <span class="mi">0</span><span class="o">),</span>
<span class="kn">end</span>

<span class="bp">#</span><span class="kn">print</span> <span class="n">pi</span><span class="bp">.</span><span class="n">has_zero</span>

<span class="kn">end</span> <span class="n">pi</span>
</pre></div>



<a name="192750675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750675" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750675">(Apr 03 2020 at 02:04)</a>:</h4>
<p>Then <code>unfold</code> correctly fails, saying it has nothing to do.</p>



<a name="192750761"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750761" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750761">(Apr 03 2020 at 02:06)</a>:</h4>
<p>But somehow inside <code>refine_struct</code>, with apparently the same goal, it succeeds and introduces the <code>eq.mpr</code>.</p>



<a name="192750778"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750778" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750778">(Apr 03 2020 at 02:07)</a>:</h4>
<p><code>simp</code> does stuff even with no lemmas</p>



<a name="192750783"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192750783" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192750783">(Apr 03 2020 at 02:07)</a>:</h4>
<p>like unfolding beta redexes</p>



<a name="192751194"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751194" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751194">(Apr 03 2020 at 02:16)</a>:</h4>
<p>and apparently introducing <code>eq.mpr</code> along <code>eq.refl _</code>, just for the fun of it. :-(</p>



<a name="192751292"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751292" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751292">(Apr 03 2020 at 02:18)</a>:</h4>
<p>We should call it <code>unsimp</code> here. You need to hit the result with <code>simp [eq_mpr_refl]</code> to get something reasonable back...</p>



<a name="192751386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751386">(Apr 03 2020 at 02:20)</a>:</h4>
<p><span class="user-mention" data-user-id="110026">@Simon Hudon</span>, when you notice this thread, don't feel the need to read from the top. We can write a good summary now, we're getting much closer to the source.</p>



<a name="192751466"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751466" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751466">(Apr 03 2020 at 02:23)</a>:</h4>
<p>Usually people call <code>simp</code> when the goal is in <code>Prop</code>, so the exact proof term is not important.</p>



<a name="192751536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751536" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751536">(Apr 03 2020 at 02:24)</a>:</h4>
<p>I just tried commenting out that offending line inside <code>refine_struct</code>. All the tests in <code>test/examples.lean</code> succeed, but maybe they don't test enough.</p>



<a name="192751553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751553">(Apr 03 2020 at 02:25)</a>:</h4>
<p>I think that the logic of <code>refine_struct</code> should be changed so that if there is no field with a given name among explicitly provided fields, then it doesn't <code>unfold</code>/<code>simp</code>/whatever.</p>



<a name="192751735"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751735" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751735">(Apr 03 2020 at 02:28)</a>:</h4>
<p>What is the status here?</p>



<a name="192751809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751809" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751809">(Apr 03 2020 at 02:30)</a>:</h4>
<p>The following code generates an <code>eq.mpr</code> in the result:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">instance</span> <span class="n">has_zero</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">has_zero</span> <span class="err">$</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_zero</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="bp">..</span> <span class="o">}</span><span class="bp">;</span> <span class="n">exact</span> <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="mi">0</span>
</pre></div>



<a name="192751820"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751820" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751820">(Apr 03 2020 at 02:30)</a>:</h4>
<p><span class="user-mention" data-user-id="110087">@Scott Morrison</span> found the offending line in <code>refine_struct</code></p>



<a name="192751835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751835" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751835">(Apr 03 2020 at 02:31)</a>:</h4>
<p>It's</p>
<div class="codehilite"><pre><span></span><span class="n">try</span> <span class="o">(</span><span class="n">interactive</span><span class="bp">.</span><span class="n">unfold</span> <span class="o">(</span><span class="n">provided</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="bp">⟨</span><span class="n">s</span><span class="o">,</span><span class="n">f</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">update_prefix</span> <span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="n">loc</span><span class="bp">.</span><span class="n">ns</span> <span class="o">[</span><span class="n">none</span><span class="o">])),</span>
</pre></div>



<a name="192751872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751872">(Apr 03 2020 at 02:32)</a>:</h4>
<p>That's all I know. May be <span class="user-mention" data-user-id="110087">@Scott Morrison</span> has more details to add</p>



<a name="192751923"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751923" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751923">(Apr 03 2020 at 02:33)</a>:</h4>
<p>I wonder why <code>refine_struct</code> does something to a goal if there is no field with the same name provided in the <code>{ .. }</code> block.</p>



<a name="192751928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751928" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751928">(Apr 03 2020 at 02:33)</a>:</h4>
<p>And how hard would it be to fix this.</p>



<a name="192751935"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192751935" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192751935">(Apr 03 2020 at 02:33)</a>:</h4>
<p>If we use <code>dunfold</code> instead of <code>unfold</code>, does that solve the problem?</p>



<a name="192752030"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752030" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752030">(Apr 03 2020 at 02:36)</a>:</h4>
<p>No <code>eq.mpr</code> but there is <code>id</code>.</p>



<a name="192752063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752063">(Apr 03 2020 at 02:36)</a>:</h4>
<p>Don't know how bad is it for class instances.</p>



<a name="192752129"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752129" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752129">(Apr 03 2020 at 02:38)</a>:</h4>
<p>I think it's going to be an issue too. Can you skip that line if the goal is not a prop?</p>



<a name="192752147"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752147" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752147">(Apr 03 2020 at 02:39)</a>:</h4>
<p>I don't understand what happens in <code>refine_one</code>.</p>



<a name="192752221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752221" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752221">(Apr 03 2020 at 02:41)</a>:</h4>
<p>If you insert this after the definition of <code>refine_struct</code> in <code>tactic.interactive</code>, it will tell you whether the problem is fixed or not:</p>
<div class="codehilite"><pre><span></span><span class="kn">instance</span> <span class="n">pi</span><span class="bp">.</span><span class="n">has_one</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="bp">Π</span> <span class="n">x</span><span class="o">,</span> <span class="n">has_one</span> <span class="o">(</span><span class="n">β</span> <span class="n">x</span><span class="o">)]</span> <span class="o">:</span> <span class="n">has_one</span> <span class="o">(</span><span class="bp">Π</span> <span class="n">x</span><span class="o">,</span> <span class="n">β</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine_struct</span> <span class="o">{</span> <span class="bp">..</span> <span class="o">}</span><span class="bp">;</span> <span class="n">exact</span> <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="mi">1</span>

<span class="kn">set_option</span> <span class="n">pp</span><span class="bp">.</span><span class="n">all</span> <span class="n">true</span>
<span class="bp">#</span><span class="kn">print</span> <span class="n">pi</span><span class="bp">.</span><span class="n">has_one</span>
</pre></div>



<a name="192752238"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752238" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752238">(Apr 03 2020 at 02:41)</a>:</h4>
<p><code>refine_struct</code> has to work recursively because structures can extend each other and I have to elaborate one instance at a time</p>



<a name="192752303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752303" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752303">(Apr 03 2020 at 02:42)</a>:</h4>
<p><code>refine_one</code> takes the definition of a struct and an instance, infers the missing fields, tries to fill them up and tag the left-over goals</p>



<a name="192752314"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752314" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752314">(Apr 03 2020 at 02:43)</a>:</h4>
<p>Ok, I think I see how we can do things.</p>



<a name="192752439"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752439" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752439">(Apr 03 2020 at 02:45)</a>:</h4>
<p>We can create a copy of the current goal, rewrite it using <code>dunfold</code>, get the new statement with <code>target</code> and use it with <code>change</code> in the original goal</p>



<a name="192752556"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752556" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752556">(Apr 03 2020 at 02:48)</a>:</h4>
<p>What are you doing to fields that are not in <code>provided</code>?</p>



<a name="192752608"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192752608" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192752608">(Apr 03 2020 at 02:49)</a>:</h4>
<p>Creating a meta variable with their type and add it to the list of goals</p>



<a name="192753078"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192753078" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192753078">(Apr 03 2020 at 03:00)</a>:</h4>
<p>Why do you run <code>unfold</code> on them?</p>



<a name="192753183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192753183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192753183">(Apr 03 2020 at 03:03)</a>:</h4>
<p>I think it's because otherwise I can get this kind of expression <code>{ add := my_add }.add x y ≤ _</code></p>



<a name="192753237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192753237" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192753237">(Apr 03 2020 at 03:04)</a>:</h4>
<p>I see, they can depend on provided fields.</p>



<a name="192753246"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192753246" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192753246">(Apr 03 2020 at 03:04)</a>:</h4>
<p>(and <code>Prop</code>s normally do)</p>



<a name="192753288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192753288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192753288">(Apr 03 2020 at 03:05)</a>:</h4>
<p>Yes and I'd rather have <code>my_add x y ≤ _</code></p>



<a name="192753532"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192753532" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192753532">(Apr 03 2020 at 03:10)</a>:</h4>
<p>I'm heading to bed. Good luck with <code>refine_struct</code></p>



<a name="192753990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192753990" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192753990">(Apr 03 2020 at 03:20)</a>:</h4>
<p>We may ask for help again tomorrow. :-)</p>



<a name="192758871"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Need%20help%20with%20class%20instance%20resolution/near/192758871" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/Need.20help.20with.20class.20instance.20resolution.html#192758871">(Apr 03 2020 at 05:08)</a>:</h4>
<p>Let's see if <a href="https://github.com/leanprover-community/mathlib/issues/2319" title="https://github.com/leanprover-community/mathlib/issues/2319">#2319</a> works.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>