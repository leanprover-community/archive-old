---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/tidy.20bug.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html">tidy bug</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="135060203"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060203" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060203">(Oct 02 2018 at 20:01)</a>:</h4>
<p>Can someone try</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">tidy</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">X</span> <span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">,</span> <span class="bp">∃</span> <span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">,</span> <span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">g</span> <span class="o">:</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">X</span><span class="o">,</span> <span class="n">f</span> <span class="err">∘</span> <span class="n">g</span> <span class="bp">=</span> <span class="n">id</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">cases</span> <span class="n">classical</span><span class="bp">.</span><span class="n">axiom_of_choice</span> <span class="n">h</span> <span class="k">with</span> <span class="n">g</span> <span class="n">H</span><span class="o">,</span>
  <span class="n">tidy</span><span class="o">,</span>
 <span class="kn">end</span>
</pre></div>



<a name="135060275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060275" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060275">(Oct 02 2018 at 20:02)</a>:</h4>
<p>Here it says <code>no goals</code> after <code>tidy</code> but red-squiggle <code>example</code> with <code>type mismatch at application  g a term  a has type  Y_1 but is expected to have type   Y types contain aliased name(s): Y remark: the tactic `dedup` can be used to rename aliases</code></p>



<a name="135060435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060435" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060435">(Oct 02 2018 at 20:05)</a>:</h4>
<blockquote>
<p>Here it says <code>no goals</code> after <code>tidy</code> but red-squiggle <code>example</code> with <code>type mismatch at application  g a term  a has type  Y_1 but is expected to have type   Y types contain aliased name(s): Y remark: the tactic `dedup` can be used to rename aliases</code></p>
</blockquote>
<p>I get the same.</p>



<a name="135060519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060519">(Oct 02 2018 at 20:07)</a>:</h4>
<p>Let's wait for <span class="user-mention" data-user-id="110087">@Scott Morrison</span> to wake up, or finish lunch, or whatever it's time to do in Australia</p>



<a name="135060631"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060631" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060631">(Oct 02 2018 at 20:08)</a>:</h4>
<p>Here's the trace:</p>
<div class="codehilite"><pre><span></span><span class="c">/-</span><span class="cm"> `tidy` says -/</span>
<span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
<span class="n">fsplit</span><span class="o">,</span>
<span class="n">work_on_goal</span> <span class="mi">0</span> <span class="o">{</span> <span class="n">intros</span> <span class="n">a</span> <span class="o">},</span>
<span class="n">work_on_goal</span> <span class="mi">1</span> <span class="o">{</span> <span class="n">ext1</span><span class="o">,</span> <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="n">solve_by_elim</span> <span class="o">}</span>
</pre></div>



<a name="135060646"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060646" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060646">(Oct 02 2018 at 20:08)</a>:</h4>
<p>I'm working on that demo file we discussed earlier, trying to see what general purpose automation can do what. The problem with magic is it's somewhat unpredictable. It seems <code>finish</code> is pretty powerful in those example, but I'd like to understand when <code>tidy</code> or <code>tauto</code> actually also work (or even work better)</p>



<a name="135060745"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060745" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060745">(Oct 02 2018 at 20:10)</a>:</h4>
<p>Good idea Bryan!</p>



<a name="135060767"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060767" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060767">(Oct 02 2018 at 20:10)</a>:</h4>
<p>Not sure if I misunderstand the meaning of the trace, but throwing it in as a proof fails at the first <code>dsimp</code></p>



<a name="135060783"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060783" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060783">(Oct 02 2018 at 20:10)</a>:</h4>
<p>It's very strange to follow, it seems hopeless and then <code>solve_by_elim</code> pretends to get rid of all meta-vars and do the job</p>



<a name="135060810"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060810" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060810">(Oct 02 2018 at 20:11)</a>:</h4>
<p>here I get exactly the same result as with tidy itself</p>



<a name="135060834"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060834" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060834">(Oct 02 2018 at 20:11)</a>:</h4>
<p>google says Scott may be sleeping</p>



<a name="135060897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060897" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060897">(Oct 02 2018 at 20:12)</a>:</h4>
<p>I see this:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">tidy</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">X</span> <span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">,</span> <span class="bp">∃</span> <span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">,</span> <span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">g</span> <span class="o">:</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">X</span><span class="o">,</span> <span class="n">f</span> <span class="err">∘</span> <span class="n">g</span> <span class="bp">=</span> <span class="n">id</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
<span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>  <span class="c1">-- squiggly line under dsimp</span>
<span class="c">/-</span><span class="cm"> Tactic State</span>
<span class="cm">X Y : Type,</span>
<span class="cm">f : X → Y,</span>
<span class="cm">h : ∀ (y : Y), ∃ (x : X), f x = y</span>
<span class="cm">⊢ ∃ (g : Y → X), f ∘ g = id</span>
<span class="cm">scratch.lean:14:0: error</span>
<span class="cm">dsimplify tactic failed to simplify</span>
<span class="cm">state:</span>
<span class="cm">⊢ ∀ (X Y : Type) (f : X → Y), (∀ (y : Y), ∃ (x : X), f x = y) → (∃ (g : Y → X), f ∘ g = id) -/</span>
<span class="n">fsplit</span><span class="o">,</span>
<span class="n">work_on_goal</span> <span class="mi">0</span> <span class="o">{</span> <span class="n">intros</span> <span class="n">a</span> <span class="o">},</span>
<span class="n">work_on_goal</span> <span class="mi">1</span> <span class="o">{</span> <span class="n">ext1</span><span class="o">,</span> <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="n">solve_by_elim</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>



<a name="135060910"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060910" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060910">(Oct 02 2018 at 20:13)</a>:</h4>
<p>you erased too much</p>



<a name="135060915"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060915" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060915">(Oct 02 2018 at 20:13)</a>:</h4>
<p>the choice idea is required</p>



<a name="135060932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135060932" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135060932">(Oct 02 2018 at 20:13)</a>:</h4>
<p>Oops!</p>



<a name="135061725"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135061725" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135061725">(Oct 02 2018 at 20:26)</a>:</h4>
<p>Yes, now I see the same.  </p>
<p>Nothing seems strange with the intermediate tactic states. Is there a way to use the <code>discharger</code> option for <code>solve_by_elim</code> to make it spit out what it's doing at each stage?</p>



<a name="135061835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135061835" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135061835">(Oct 02 2018 at 20:29)</a>:</h4>
<p>How is it possible that none of our general purpose weapon can kill</p>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">(</span><span class="n">X</span> <span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">X</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">f</span> <span class="err">∘</span> <span class="n">g</span> <span class="bp">=</span> <span class="n">id</span> <span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">y</span>
</pre></div>



<a name="135061909"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135061909" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135061909">(Oct 02 2018 at 20:30)</a>:</h4>
<p>I don't use weapons :P</p>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">(</span><span class="n">X</span> <span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">X</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">f</span> <span class="err">∘</span> <span class="n">g</span> <span class="bp">=</span> <span class="n">id</span> <span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">y</span> <span class="o">:=</span> <span class="n">congr_fun</span> <span class="n">h</span> <span class="n">y</span>
</pre></div>



<a name="135061953"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135061953" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135061953">(Oct 02 2018 at 20:31)</a>:</h4>
<p>Kenny, this is exactly what I did at <a href="https://github.com/PatrickMassot/lean-scratchpad/blob/master/src/demo.lean#L60" target="_blank" title="https://github.com/PatrickMassot/lean-scratchpad/blob/master/src/demo.lean#L60">https://github.com/PatrickMassot/lean-scratchpad/blob/master/src/demo.lean#L60</a> but I'm trying to rewrite this file using automation, for comparison</p>



<a name="135062010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062010" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062010">(Oct 02 2018 at 20:32)</a>:</h4>
<p>I guess this is again because tactic writers don't like function equalities, especially with compositions</p>



<a name="135062015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062015" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062015">(Oct 02 2018 at 20:32)</a>:</h4>
<p>Replacing <code>solve_by_elim</code> with <code>apply_assumption</code> gives the same strange behavior.</p>



<a name="135062022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062022">(Oct 02 2018 at 20:32)</a>:</h4>
<p>Higher order reasoning is hard!</p>



<a name="135062062"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062062" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062062">(Oct 02 2018 at 20:33)</a>:</h4>
<p><code>finish</code> and its friends could try to turn each function equality assumption into a forall</p>



<a name="135062136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062136" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062136">(Oct 02 2018 at 20:34)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">example</span> <span class="o">(</span><span class="n">X</span> <span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">X</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">z</span><span class="o">,</span> <span class="o">(</span><span class="n">f</span> <span class="err">∘</span> <span class="n">g</span><span class="o">)</span> <span class="n">z</span> <span class="bp">=</span> <span class="n">id</span> <span class="n">z</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">):</span>
  <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">y</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">finish</span>
</pre></div>


<p>does work</p>



<a name="135062179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062179">(Oct 02 2018 at 20:35)</a>:</h4>
<p>Of course rewriting <code>h</code> like this is the most un-mathematical thing you could see</p>



<a name="135062206"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062206" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062206">(Oct 02 2018 at 20:35)</a>:</h4>
<blockquote>
<p><code>finish</code> and its friends</p>
</blockquote>



<a name="135062395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062395">(Oct 02 2018 at 20:39)</a>:</h4>
<p>its friends are <code>tauto</code> and <code>tidy</code></p>



<a name="135062619"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062619" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062619">(Oct 02 2018 at 20:43)</a>:</h4>
<p>Could it be that there's something strange happening with <code>work_on_goal</code>? The following works:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">tidy</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">X</span> <span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">,</span> <span class="bp">∃</span> <span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">,</span> <span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">g</span> <span class="o">:</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">X</span><span class="o">,</span> <span class="n">f</span> <span class="err">∘</span> <span class="n">g</span> <span class="bp">=</span> <span class="n">id</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">cases</span> <span class="n">classical</span><span class="bp">.</span><span class="n">axiom_of_choice</span> <span class="n">h</span> <span class="k">with</span> <span class="n">g</span> <span class="n">H</span><span class="o">,</span>
  <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="n">fsplit</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">exact</span> <span class="n">g</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">ext1</span><span class="o">,</span>
  <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="n">apply_assumption</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>



<a name="135062701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062701">(Oct 02 2018 at 20:44)</a>:</h4>
<p>Compare this, which gives the same <code>no goals</code> + weird error as the initial <code>tidy</code> call:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">tidy</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">X</span> <span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">,</span> <span class="bp">∃</span> <span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">,</span> <span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">g</span> <span class="o">:</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">X</span><span class="o">,</span> <span class="n">f</span> <span class="err">∘</span> <span class="n">g</span> <span class="bp">=</span> <span class="n">id</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">cases</span> <span class="n">classical</span><span class="bp">.</span><span class="n">axiom_of_choice</span> <span class="n">h</span> <span class="k">with</span> <span class="n">g</span> <span class="n">H</span><span class="o">,</span>
  <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="n">fsplit</span><span class="o">,</span>
  <span class="c1">--{ exact g },</span>
  <span class="n">work_on_goal</span> <span class="mi">1</span> <span class="o">{</span> <span class="n">ext1</span><span class="o">,</span>
  <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="n">apply_assumption</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>



<a name="135062782"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062782" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062782">(Oct 02 2018 at 20:46)</a>:</h4>
<p>interesting</p>



<a name="135062942"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135062942" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135062942">(Oct 02 2018 at 20:48)</a>:</h4>
<p>Even better:</p>
<div class="codehilite"><pre><span></span><span class="w"> </span><span class="n">example</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Type</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">∀</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="err">∃</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="err">∃</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="err">∘</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"></span>
<span class="n">begin</span><span class="w"></span>
<span class="w">  </span><span class="n">cases</span><span class="w"> </span><span class="n">classical.axiom_of_choice</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="n">H</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dsimp</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">fsplit</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="n">exact</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="n">work_on_goal</span><span class="mi"> 0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ext1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dsimp</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">apply_assumption</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="n">end</span><span class="w"></span>
</pre></div>


<p>works!</p>



<a name="135063047"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135063047" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135063047">(Oct 02 2018 at 20:50)</a>:</h4>
<p>but actually this is getting far away from what tidy suggested</p>



<a name="135063189"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135063189" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135063189">(Oct 02 2018 at 20:53)</a>:</h4>
<p><a href="https://github.com/leanprover/mathlib/blob/decb0302869ac70069ba26708367e460695683cb/tactic/chain.lean#L44" target="_blank" title="https://github.com/leanprover/mathlib/blob/decb0302869ac70069ba26708367e460695683cb/tactic/chain.lean#L44">Here's</a> <code>work_on_goal</code>. If I had to guess, there's something wrong in here, possibly in handling what happens if a goal gets solved.</p>



<a name="135065300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135065300" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135065300">(Oct 02 2018 at 21:29)</a>:</h4>
<p>I think the problem is that when <code>apply_assumption</code> kills off a goal, it does not return properly to <code>work_on_goal</code>. Then lean thinks it has finished, but in reality there are more goals that <code>work_on_goal</code> just temporarily deleted. There are no issues when <code>exact g</code> finishes a goal inside <code>work_on_goal</code>, so there's something going on with this particular interaction.</p>



<a name="135065407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135065407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135065407">(Oct 02 2018 at 21:31)</a>:</h4>
<p><code>apply_assumption</code> is <a href="https://github.com/leanprover/mathlib/blob/c2df6b1f3f62575649dbe128a2c5fc9e2de26ffb/tactic/basic.lean#L422" target="_blank" title="https://github.com/leanprover/mathlib/blob/c2df6b1f3f62575649dbe128a2c5fc9e2de26ffb/tactic/basic.lean#L422">here</a>, but it's too monad-y for me to make sense of at the moment.</p>



<a name="135065867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135065867" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135065867">(Oct 02 2018 at 21:42)</a>:</h4>
<p>What problem are you looking for?</p>



<a name="135066963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135066963" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135066963">(Oct 02 2018 at 22:07)</a>:</h4>
<p>Patrick started this thread with <a href="#narrow/stream/113488-general/subject/tidy.20bug/near/135060203" title="#narrow/stream/113488-general/subject/tidy.20bug/near/135060203">an example</a> where <code>tidy</code> leaves the tactic state with <code>no goals</code> but there is a strange error.</p>
<p>I'm proposing that the root cause of this is due to <code>apply_assumption</code> not returning properly to <code>work_on_goal</code>.</p>



<a name="135067028"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135067028" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135067028">(Oct 02 2018 at 22:08)</a>:</h4>
<p>Thanks for these bug reports. I probably won't have a chance to work on it until the weekend.</p>



<a name="135068289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135068289" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135068289">(Oct 02 2018 at 22:36)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">tactic</span><span class="bp">.</span><span class="n">interactive</span>

<span class="kn">example</span> <span class="o">(</span><span class="n">X</span> <span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">X</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">z</span><span class="o">,</span> <span class="o">(</span><span class="n">f</span> <span class="err">∘</span> <span class="n">g</span><span class="o">)</span> <span class="n">z</span> <span class="bp">=</span> <span class="n">id</span> <span class="n">z</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">):</span>
  <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">y</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">tauto</span>
</pre></div>



<a name="135068292"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135068292" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135068292">(Oct 02 2018 at 22:36)</a>:</h4>
<p><span class="user-mention" data-user-id="110031">@Patrick Massot</span></p>



<a name="135085753"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/135085753" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#135085753">(Oct 03 2018 at 07:14)</a>:</h4>
<p>Thanks Kenny, but this is the version I don't want, because <code>h</code> is stated un-mathematically</p>



<a name="293481892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/293481892" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#293481892">(Aug 15 2022 at 08:22)</a>:</h4>
<p>Looks like <code>tidy</code> used the same variable name twice:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">logic.relation</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="n">δ</span> <span class="n">ε</span> <span class="n">κ</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">f₁</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g₁</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">(</span><span class="n">f₂</span> <span class="o">:</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">ε</span><span class="o">)</span> <span class="o">(</span><span class="n">g₂</span> <span class="o">:</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">κ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">relation.map</span> <span class="o">(</span><span class="n">relation.map</span> <span class="n">r</span> <span class="n">f₁</span> <span class="n">g₁</span><span class="o">)</span> <span class="n">f₂</span> <span class="n">g₂</span> <span class="bp">=</span> <span class="n">relation.map</span> <span class="n">r</span> <span class="o">(</span><span class="n">f₂</span> <span class="bp">∘</span> <span class="n">f₁</span><span class="o">)</span> <span class="o">(</span><span class="n">g₂</span> <span class="bp">∘</span> <span class="n">g₁</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">tidy</span>

<span class="c">/-</span><span class="cm"></span>
<span class="cm">type mismatch at application</span>
<span class="cm">  r ᾰ_h_h_left_w</span>
<span class="cm">term</span>
<span class="cm">  ᾰ_h_h_left_w</span>
<span class="cm">has type</span>
<span class="cm">  α_1</span>
<span class="cm">but is expected to have type</span>
<span class="cm">  α</span>
<span class="cm">types contain aliased name(s): α</span>
<span class="cm">remark: the tactic `dedup` can be used to rename aliases</span>
<span class="cm">-/</span>
</code></pre></div>



<a name="293738951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/293738951" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bhavik Mehta <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#293738951">(Aug 16 2022 at 15:21)</a>:</h4>
<p>Is this a bug in <code>tidy</code> or in one of the things <code>tidy</code> uses? If I remember correctly, <code>tidy</code> doesn't have the ability to choose variable names whatsoever, just to call other tactics</p>



<a name="293803788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/293803788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#293803788">(Aug 16 2022 at 21:28)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">f₁</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g₁</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">(</span><span class="n">f₂</span> <span class="o">:</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">ε</span><span class="o">)</span> <span class="o">(</span><span class="n">g₂</span> <span class="o">:</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">κ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">relation.map</span> <span class="o">(</span><span class="n">relation.map</span> <span class="n">r</span> <span class="n">f₁</span> <span class="n">g₁</span><span class="o">)</span> <span class="n">f₂</span> <span class="n">g₂</span> <span class="bp">=</span> <span class="n">relation.map</span> <span class="n">r</span> <span class="o">(</span><span class="n">f₂</span> <span class="bp">∘</span> <span class="n">f₁</span><span class="o">)</span> <span class="o">(</span><span class="n">g₂</span> <span class="bp">∘</span> <span class="n">g₁</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">ext1</span><span class="o">,</span>
  <span class="n">ext1</span><span class="o">,</span>
  <span class="n">simp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="n">fsplit</span><span class="o">,</span>
  <span class="n">work_on_goal</span> <span class="mi">1</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">ᾰ</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">ᾰ</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">ᾰ_h</span><span class="o">,</span> <span class="n">cases</span> <span class="n">ᾰ_h_h</span><span class="o">,</span> <span class="n">cases</span> <span class="n">ᾰ_h_h_right</span><span class="o">,</span> <span class="n">cases</span> <span class="n">ᾰ_h_h_left</span><span class="o">,</span> <span class="n">cases</span> <span class="n">ᾰ_h_h_left_h</span><span class="o">,</span>
    <span class="n">induction</span> <span class="n">ᾰ_h_h_right_right</span><span class="o">,</span> <span class="n">induction</span> <span class="n">ᾰ_h_h_right_left</span><span class="o">,</span> <span class="n">cases</span> <span class="n">ᾰ_h_h_left_h_h</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">ᾰ_h_h_left_h_h_right</span><span class="o">,</span> <span class="n">induction</span> <span class="n">ᾰ_h_h_left_h_h_right_right</span><span class="o">,</span>
    <span class="n">induction</span> <span class="n">ᾰ_h_h_left_h_h_right_left</span><span class="o">,</span>
    <span class="n">fsplit</span><span class="o">,</span>
    <span class="n">work_on_goal</span> <span class="mi">2</span>
    <span class="o">{</span> <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
      <span class="n">fsplit</span><span class="o">,</span>
      <span class="n">work_on_goal</span> <span class="mi">2</span> <span class="o">{</span>
        <span class="n">fsplit</span><span class="o">,</span>
        <span class="n">work_on_goal</span> <span class="mi">1</span>
        <span class="o">{</span> <span class="n">assumption</span> <span class="o">},</span>
        <span class="n">simp</span> <span class="n">at</span> <span class="bp">*</span> <span class="o">}</span> <span class="o">}</span> <span class="o">},</span>
  <span class="n">intros</span> <span class="n">ᾰ</span><span class="o">,</span> <span class="n">cases</span> <span class="n">ᾰ</span><span class="o">,</span> <span class="n">cases</span> <span class="n">ᾰ_h</span><span class="o">,</span> <span class="n">cases</span> <span class="n">ᾰ_h_h</span><span class="o">,</span> <span class="n">cases</span> <span class="n">ᾰ_h_h_right</span><span class="o">,</span>
  <span class="n">induction</span> <span class="n">ᾰ_h_h_right_right</span><span class="o">,</span> <span class="n">induction</span> <span class="n">ᾰ_h_h_right_left</span><span class="o">,</span>
  <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="n">fsplit</span><span class="o">,</span>
  <span class="n">work_on_goal</span> <span class="mi">2</span> <span class="o">{</span>
    <span class="n">fsplit</span><span class="o">,</span>
    <span class="n">work_on_goal</span> <span class="mi">2</span> <span class="o">{</span>
      <span class="n">fsplit</span><span class="o">,</span>
      <span class="n">work_on_goal</span> <span class="mi">1</span> <span class="o">{</span>
        <span class="n">fsplit</span><span class="o">,</span>
        <span class="n">work_on_goal</span> <span class="mi">2</span> <span class="o">{</span>
          <span class="n">fsplit</span><span class="o">,</span>
          <span class="n">work_on_goal</span> <span class="mi">2</span> <span class="o">{</span>
            <span class="n">fsplit</span><span class="o">,</span>
            <span class="n">work_on_goal</span> <span class="mi">1</span>
            <span class="o">{</span> <span class="n">assumption</span> <span class="o">},</span>
            <span class="n">fsplit</span><span class="o">,</span>
            <span class="n">work_on_goal</span> <span class="mi">1</span>
            <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span>
            <span class="n">refl</span> <span class="o">}</span> <span class="o">}</span> <span class="o">},</span>
      <span class="n">simp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="o">}</span> <span class="o">},</span>
<span class="kd">end</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">type mismatch at application</span>
<span class="cm">  r ᾰ_h_h_left_w</span>
<span class="cm">term</span>
<span class="cm">  ᾰ_h_h_left_w</span>
<span class="cm">has type</span>
<span class="cm">  α_1</span>
<span class="cm">but is expected to have type</span>
<span class="cm">  α</span>
<span class="cm">types contain aliased name(s): α</span>
<span class="cm">remark: the tactic `dedup` can be used to rename aliases</span>
<span class="cm">-/</span>
</code></pre></div>
<p>(error at first line of example statement)</p>



<a name="293805948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/293805948" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#293805948">(Aug 16 2022 at 21:46)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">logic.relation</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="n">δ</span> <span class="n">ε</span> <span class="n">κ</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">f₁</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g₁</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">(</span><span class="n">f₂</span> <span class="o">:</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">ε</span><span class="o">)</span> <span class="o">(</span><span class="n">g₂</span> <span class="o">:</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">κ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">relation.map</span> <span class="o">(</span><span class="n">relation.map</span> <span class="n">r</span> <span class="n">f₁</span> <span class="n">g₁</span><span class="o">)</span> <span class="n">f₂</span> <span class="n">g₂</span> <span class="bp">=</span> <span class="n">relation.map</span> <span class="n">r</span> <span class="o">(</span><span class="n">f₂</span> <span class="bp">∘</span> <span class="n">f₁</span><span class="o">)</span> <span class="o">(</span><span class="n">g₂</span> <span class="bp">∘</span> <span class="n">g₁</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">ext1</span><span class="o">,</span>
  <span class="n">ext1</span><span class="o">,</span>
  <span class="n">simp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="n">fsplit</span><span class="o">,</span>
  <span class="n">work_on_goal</span> <span class="mi">1</span>
  <span class="o">{</span> <span class="n">rintros</span> <span class="o">⟨</span><span class="n">ᾰ_w</span><span class="o">,</span> <span class="n">ᾰ_h_w</span><span class="o">,</span> <span class="o">⟨</span><span class="n">ᾰ_h_h_left_w</span><span class="o">,</span> <span class="n">ᾰ_h_h_left_h_w</span><span class="o">,</span> <span class="n">ᾰ_h_h_left_h_h_left</span><span class="o">,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span>
      <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span>
    <span class="n">refine</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">⟩,</span>
    <span class="n">work_on_goal</span> <span class="mi">2</span>
    <span class="o">{</span> <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="c1">-- this line breaks it; comment out to fix proof</span>
      <span class="n">fsplit</span><span class="o">,</span>
      <span class="n">work_on_goal</span> <span class="mi">2</span> <span class="o">{</span>
        <span class="n">fsplit</span><span class="o">,</span>
        <span class="n">work_on_goal</span> <span class="mi">1</span>
        <span class="o">{</span> <span class="n">assumption</span> <span class="o">},</span>
        <span class="n">simp</span> <span class="n">at</span> <span class="bp">*</span> <span class="o">}</span> <span class="o">}</span> <span class="o">},</span>
  <span class="n">rintro</span> <span class="o">⟨</span><span class="n">ᾰ_w</span><span class="o">,</span> <span class="n">ᾰ_h_w</span><span class="o">,</span> <span class="n">ᾰ_h_h_left</span><span class="o">,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span>
  <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>
  <span class="n">refine</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">,</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">,</span> <span class="n">ᾰ_h_h_left</span><span class="o">,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span>
<span class="kd">end</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">type mismatch at application</span>
<span class="cm">  r ᾰ_h_h_left_w</span>
<span class="cm">term</span>
<span class="cm">  ᾰ_h_h_left_w</span>
<span class="cm">has type</span>
<span class="cm">  α_1</span>
<span class="cm">but is expected to have type</span>
<span class="cm">  α</span>
<span class="cm">types contain aliased name(s): α</span>
<span class="cm">remark: the tactic `dedup` can be used to rename aliases</span>
<span class="cm">-/</span>
</code></pre></div>



<a name="293805994"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/293805994" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#293805994">(Aug 16 2022 at 21:46)</a>:</h4>
<p><code>tidy</code> is running <code>dsimp</code> on a goal with metavariables and on some hypotheses all at the same time</p>



<a name="293807387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/tidy%20bug/near/293807387" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/tidy.20bug.html#293807387">(Aug 16 2022 at 21:58)</a>:</h4>
<p>This is as compact as I can get it:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">logic.relation</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="n">δ</span> <span class="n">ε</span> <span class="n">κ</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">f₁</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g₁</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">(</span><span class="n">f₂</span> <span class="o">:</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">ε</span><span class="o">)</span> <span class="o">(</span><span class="n">g₂</span> <span class="o">:</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">κ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">relation.map</span> <span class="o">(</span><span class="n">relation.map</span> <span class="n">r</span> <span class="n">f₁</span> <span class="n">g₁</span><span class="o">)</span> <span class="n">f₂</span> <span class="n">g₂</span> <span class="bp">=</span> <span class="n">relation.map</span> <span class="n">r</span> <span class="o">(</span><span class="n">f₂</span> <span class="bp">∘</span> <span class="n">f₁</span><span class="o">)</span> <span class="o">(</span><span class="n">g₂</span> <span class="bp">∘</span> <span class="n">g₁</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">ext1</span><span class="o">,</span>
  <span class="n">ext1</span><span class="o">,</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">eq_iff_iff</span><span class="o">],</span>
  <span class="n">refine</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">⟩,</span>
  <span class="o">{</span> <span class="n">rintros</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">,</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">,</span> <span class="n">foo</span><span class="o">,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span>
    <span class="n">refine</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">⟩,</span>
    <span class="n">swap</span><span class="o">,</span> <span class="c1">-- new first goal now depends on metavariable in new second goal</span>
    <span class="o">{</span> <span class="n">dsimp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="c1">-- this line breaks it; comment out to fix proof</span>
      <span class="n">exact</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">foo</span><span class="o">,</span> <span class="kd">by</span> <span class="n">simp</span><span class="o">⟩,</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">rintro</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">,</span> <span class="n">bar</span><span class="o">,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span>
    <span class="n">exact</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">,</span> <span class="o">⟨</span><span class="n">_</span><span class="o">,</span> <span class="n">_</span><span class="o">,</span> <span class="n">bar</span><span class="o">,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span> <span class="o">},</span>
<span class="kd">end</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">type mismatch at application</span>
<span class="cm">  r ᾰ_h_h_left_w</span>
<span class="cm">term</span>
<span class="cm">  ᾰ_h_h_left_w</span>
<span class="cm">has type</span>
<span class="cm">  α_1</span>
<span class="cm">but is expected to have type</span>
<span class="cm">  α</span>
<span class="cm">types contain aliased name(s): α</span>
<span class="cm">remark: the tactic `dedup` can be used to rename aliases</span>
<span class="cm">-/</span>
</code></pre></div>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>