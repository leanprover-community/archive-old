---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/optional.20arguments.20for.20tactics.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html">optional arguments for tactics</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="218456078"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218456078" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218456078">(Dec 01 2020 at 17:38)</a>:</h4>
<p>I'm confused on how to make optional arguments for tactics to work. Right now I have two different tactics, one of them takes an extra argument, and I want to make them just one tactic with that extra argument being optional:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite_search</span> <span class="o">(</span><span class="n">try_harder</span> <span class="o">:</span> <span class="n">parse</span> <span class="bp">$</span> <span class="n">optional</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"!"</span><span class="o">))</span>
  <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">config</span> <span class="bp">.</span> <span class="n">pick_default</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">rewrite_search_target</span> <span class="n">cfg</span> <span class="o">[]</span>

<span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite_search_with</span> <span class="o">(</span><span class="n">try_harder</span> <span class="o">:</span> <span class="n">parse</span> <span class="bp">$</span> <span class="n">optional</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"!"</span><span class="o">))</span> <span class="o">(</span><span class="n">rs</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">rw_rules</span><span class="o">)</span>
  <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">config</span> <span class="bp">.</span> <span class="n">pick_default</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">rewrite_search_target</span> <span class="n">cfg</span> <span class="n">rs.rules</span>
</code></pre></div>
<p>From the docs I thought I should just be able to add a <code>(rs : parse (optional rw_rules))</code> to the arguments for rewrite_search, but that causes my existing code to mis-parse.</p>



<a name="218458440"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218458440" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218458440">(Dec 01 2020 at 17:58)</a>:</h4>
<p>I think the <code>optional</code> will give you something of type <code>option rw_rules</code>, and so you can then match that with <code>none</code> or <code>some rs</code>.</p>



<a name="218458463"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218458463" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218458463">(Dec 01 2020 at 17:58)</a>:</h4>
<p>Does that make sense. (Me = meta noob)</p>



<a name="218458882"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218458882" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218458882">(Dec 01 2020 at 18:02)</a>:</h4>
<p>It is just no longer able to parse correctly though. Like this no longer parses when I add another optional arg to <code>rewrite_search</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">private</span> <span class="kd">example</span> <span class="o">:</span> <span class="o">[[</span><span class="mi">0</span><span class="o">],</span> <span class="o">[</span><span class="mi">0</span><span class="o">]]</span> <span class="bp">=</span> <span class="o">[[</span><span class="mi">4</span><span class="o">],</span> <span class="o">[</span><span class="mi">4</span><span class="o">]]</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">rewrite_search</span>
</code></pre></div>
<p>There is already one optional argument, maybe that is related?</p>



<a name="218459288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218459288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218459288">(Dec 01 2020 at 18:05)</a>:</h4>
<p>maybe... I'm already way out of my depth</p>



<a name="218459325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218459325" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218459325">(Dec 01 2020 at 18:05)</a>:</h4>
<p>These are interactive tactics? If so I don't think the <code> . </code> optional arguments are good to use</p>



<a name="218459411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218459411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218459411">(Dec 01 2020 at 18:06)</a>:</h4>
<p>yeah these are interactive tactics. i'll try dropping the <code>.</code> thing</p>



<a name="218459468"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218459468" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218459468">(Dec 01 2020 at 18:06)</a>:</h4>
<p>Instead, use another <code>cfg : parse $ optional config</code></p>



<a name="218468771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218468771" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218468771">(Dec 01 2020 at 19:22)</a>:</h4>
<p>the <code>.</code> is for using a tactic to produce the default. If it's just a value then you should use <code>:=</code></p>



<a name="218587702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218587702" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218587702">(Dec 02 2020 at 17:08)</a>:</h4>
<p><code>parse $ optional config</code> doesn't seem to work - for this code:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite_search</span> <span class="o">(</span><span class="n">try_harder</span> <span class="o">:</span> <span class="n">parse</span> <span class="bp">$</span> <span class="n">optional</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"!"</span><span class="o">))</span>
  <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">parse</span> <span class="bp">$</span> <span class="n">optional</span> <span class="n">config</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">rewrite_search_target</span> <span class="o">{}</span> <span class="o">[]</span>
</code></pre></div>
<p>the "optional" is squiggled with the error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="mi">82</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span> <span class="n">type</span> <span class="n">mismatch</span> <span class="n">at</span> <span class="n">application</span>
  <span class="n">optional</span> <span class="n">config</span>
<span class="n">term</span>
  <span class="n">config</span>
<span class="n">has</span> <span class="n">type</span>
  <span class="kt">Type</span> <span class="o">:</span> <span class="kt">Type</span> <span class="mi">1</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="n">lean.parser</span> <span class="bp">?</span><span class="n">m_1</span> <span class="o">:</span> <span class="kt">Type</span>

<span class="mi">82</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span> <span class="n">don't</span> <span class="n">know</span> <span class="n">how</span> <span class="n">to</span> <span class="n">synthesize</span> <span class="n">placeholder</span>
<span class="n">context</span><span class="o">:</span>
<span class="n">try_harder</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">optional</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"!"</span><span class="o">))</span>
<span class="bp">⊢</span> <span class="kt">Type</span>
</code></pre></div>
<p>The type of "config" is from:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">structure</span> <span class="n">config</span> <span class="kd">extends</span> <span class="n">tactic.nth_rewrite.cfg</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">max_iterations</span>     <span class="o">:</span> <span class="n">ℕ</span> <span class="o">:=</span> <span class="mi">5000</span><span class="o">)</span>
<span class="o">(</span><span class="n">explain</span>            <span class="o">:</span> <span class="n">bool</span> <span class="o">:=</span> <span class="n">ff</span><span class="o">)</span>
<span class="o">(</span><span class="n">explain_using_conv</span> <span class="o">:</span> <span class="n">bool</span> <span class="o">:=</span> <span class="n">tt</span><span class="o">)</span>
</code></pre></div>
<p>I don't really understand what any of this parser stuff is doing. I just want the tactic to take optional parameters of provided types, it seems like I shouldn't have to be doing any "parsing" at all.</p>



<a name="218588179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218588179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218588179">(Dec 02 2020 at 17:11)</a>:</h4>
<p>you know, I'm not even using this "try_harder" parse option. but removing that, it still doesn't work. simplified code:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite_search</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">parse</span> <span class="bp">$</span> <span class="n">optional</span> <span class="n">config</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">rewrite_search_target</span> <span class="o">{}</span> <span class="o">[]</span>
</code></pre></div>
<p>with error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="mi">81</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span> <span class="n">type</span> <span class="n">mismatch</span> <span class="n">at</span> <span class="n">application</span>
  <span class="n">optional</span> <span class="n">config</span>
<span class="n">term</span>
  <span class="n">config</span>
<span class="n">has</span> <span class="n">type</span>
  <span class="kt">Type</span> <span class="o">:</span> <span class="kt">Type</span> <span class="mi">1</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="n">lean.parser</span> <span class="bp">?</span><span class="n">m_1</span> <span class="o">:</span> <span class="kt">Type</span>

<span class="mi">81</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span> <span class="n">don't</span> <span class="n">know</span> <span class="n">how</span> <span class="n">to</span> <span class="n">synthesize</span> <span class="n">placeholder</span>
<span class="n">context</span><span class="o">:</span>
<span class="bp">⊢</span> <span class="kt">Type</span>
</code></pre></div>
<p>it works with the <code>.</code> syntax though</p>



<a name="218588611"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218588611" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218588611">(Dec 02 2020 at 17:14)</a>:</h4>
<p>i can't really find documentation about the <code>.</code> syntax for optional arguments, or for using <code>parse</code> for optional arguments, so for both of them I am kind of just cutting and pasting from similar-looking code and trying to tweak til it works, rather than nicely understanding what it's doing</p>



<a name="218589247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218589247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218589247">(Dec 02 2020 at 17:19)</a>:</h4>
<p>Take a look at other tactics like <code>simp</code> that accept an optional last structure parameter: <a href="https://github.com/leanprover/lean/blob/72a965986fa5aeae54062e98efb3140b2c4e79fd/library/init/meta/interactive.lean#L1210">https://github.com/leanprover/lean/blob/72a965986fa5aeae54062e98efb3140b2c4e79fd/library/init/meta/interactive.lean#L1210</a></p>



<a name="218589640"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218589640" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218589640">(Dec 02 2020 at 17:22)</a>:</h4>
<p>can i have two optional arguments at all</p>



<a name="218589692"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218589692" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218589692">(Dec 02 2020 at 17:22)</a>:</h4>
<p>Also seen here in <code>rewrite</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">rewrite_cfg</span> <span class="kd">extends</span> <span class="n">apply_cfg</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">md</span>            <span class="o">:=</span> <span class="n">reducible</span><span class="o">)</span>
<span class="o">(</span><span class="n">symm</span>          <span class="o">:=</span> <span class="n">ff</span><span class="o">)</span>
<span class="o">(</span><span class="n">occs</span>          <span class="o">:=</span> <span class="n">occurrences.all</span><span class="o">)</span>

<span class="kd">meta</span> <span class="kd">constant</span> <span class="n">rewrite_core</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">expr</span><span class="o">)</span> <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="n">expr</span><span class="o">)</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">rewrite_cfg</span> <span class="o">:=</span> <span class="o">{})</span> <span class="o">:</span> <span class="n">tactic</span> <span class="o">(</span><span class="n">expr</span> <span class="bp">×</span> <span class="n">expr</span> <span class="bp">×</span> <span class="n">list</span> <span class="n">expr</span><span class="o">)</span>

<span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">expr</span><span class="o">)</span> <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="n">expr</span><span class="o">)</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">rewrite_cfg</span> <span class="o">:=</span> <span class="o">{})</span> <span class="o">:</span> <span class="n">tactic</span> <span class="o">(</span><span class="n">expr</span> <span class="bp">×</span> <span class="n">expr</span> <span class="bp">×</span> <span class="n">list</span> <span class="n">expr</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">do</span> <span class="o">(</span><span class="n">new_t</span><span class="o">,</span> <span class="n">prf</span><span class="o">,</span> <span class="n">metas</span><span class="o">)</span> <span class="bp">←</span> <span class="n">rewrite_core</span> <span class="n">h</span> <span class="n">e</span> <span class="n">cfg</span><span class="o">,</span>
   <span class="n">try_apply_opt_auto_param</span> <span class="n">cfg.to_apply_cfg</span> <span class="n">metas</span><span class="o">,</span>
   <span class="n">return</span> <span class="o">(</span><span class="n">new_t</span><span class="o">,</span> <span class="n">prf</span><span class="o">,</span> <span class="n">metas</span><span class="o">)</span>
</code></pre></div>



<a name="218589758"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218589758" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218589758">(Dec 02 2020 at 17:23)</a>:</h4>
<p>Do you mean optional arguments like <code>simp?</code> or <code>simp!</code> or things like <code>rw</code> and <code>rw {occs = occurences ...}</code>?</p>



<a name="218589839"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218589839" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218589839">(Dec 02 2020 at 17:23)</a>:</h4>
<p>like <code>rw {occs = occurences ...}</code></p>



<a name="218589955"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218589955" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218589955">(Dec 02 2020 at 17:24)</a>:</h4>
<p><code>simp?</code> could just be a separate function from <code>simp</code> entirely, right? so the "optional argument" there is just messing with the parser to do something you could do straightforwardly</p>



<a name="218590092"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218590092" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218590092">(Dec 02 2020 at 17:25)</a>:</h4>
<p>Sorry, one sec</p>



<a name="218590330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218590330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218590330">(Dec 02 2020 at 17:27)</a>:</h4>
<p>OK, this lets me use the <code>:=</code> method and avoid the <code>.</code>. Great success.</p>



<a name="218590697"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218590697" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218590697">(Dec 02 2020 at 17:29)</a>:</h4>
<p>that brings me back to the original question, though, of how to add an optional argument with <code>(rs : parse (optional rw_rules))</code>. That still does not appear to work. This code compiles fine but then it causes anything that just uses <code>by rewrite_search</code> to fail to parse:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite_search</span> <span class="o">(</span><span class="n">rs</span> <span class="o">:</span> <span class="n">parse</span> <span class="bp">$</span> <span class="n">optional</span> <span class="n">rw_rules</span><span class="o">)</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">config</span> <span class="o">:=</span> <span class="o">{})</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">rewrite_search_target</span> <span class="n">cfg</span> <span class="o">[]</span>
</code></pre></div>
<p>Is that fundamentally illegitimate in Lean, to have multiple optional arguments? Or is there some other way to do it</p>



<a name="218590844"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218590844" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218590844">(Dec 02 2020 at 17:30)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite_search</span> <span class="o">(</span><span class="n">try_harder</span> <span class="o">:</span> <span class="n">parse</span> <span class="bp">$</span> <span class="n">optional</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"!"</span><span class="o">))</span>
  <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">config</span> <span class="o">:=</span> <span class="o">{})</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">rewrite_search_target</span>
<span class="o">{</span> <span class="n">max_iterations</span> <span class="o">:=</span> <span class="k">match</span> <span class="n">try_harder</span> <span class="k">with</span> <span class="bp">|</span> <span class="n">none</span> <span class="o">:=</span> <span class="mi">5000</span> <span class="bp">|</span> <span class="n">some</span> <span class="n">_</span> <span class="o">:=</span> <span class="mi">100000</span> <span class="kd">end</span><span class="o">,</span> <span class="bp">..</span><span class="n">cfg</span> <span class="o">}</span> <span class="o">[]</span>
</code></pre></div>



<a name="218590887"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218590887" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218590887">(Dec 02 2020 at 17:30)</a>:</h4>
<p>there's some issue with the definition, but I don't have all your code</p>



<a name="218590946"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218590946" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218590946">(Dec 02 2020 at 17:31)</a>:</h4>
<p>But you parse in the optional flags, and then map or const_map them how you will. There's probably a neater way to do it</p>



<a name="218590990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218590990" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218590990">(Dec 02 2020 at 17:31)</a>:</h4>
<p>there's no flags here, just a list and a config structure</p>



<a name="218591443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218591443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218591443">(Dec 02 2020 at 17:34)</a>:</h4>
<p>so basically when rewrite_search is defined as above, and I have code like:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">test_linear_path</span> <span class="o">:</span> <span class="n">h</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">h</span> <span class="mi">4</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">rewrite_search</span>

<span class="kd">constants</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">e</span> <span class="o">:</span> <span class="n">ℚ</span>
</code></pre></div>
<p>The "constants" line shows an error: <code>68:1: invalid expression, unexpected token</code></p>



<a name="218591560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218591560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218591560">(Dec 02 2020 at 17:35)</a>:</h4>
<p>Did you define an interactive tactic to go along with your tactic?</p>



<a name="218591601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218591601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218591601">(Dec 02 2020 at 17:35)</a>:</h4>
<p>yeah that definition is in <code>tactic.interactive</code></p>



<a name="218593580"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218593580" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218593580">(Dec 02 2020 at 17:49)</a>:</h4>
<p>OK, here's a simpler repro. AFAICT the optional parsing just does not work with the <code>rw_rules</code> type.</p>
<p>The tactic:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite_search</span> <span class="o">(</span><span class="n">rs</span> <span class="o">:</span> <span class="n">parse</span> <span class="bp">$</span> <span class="n">optional</span> <span class="n">rw_rules</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">string</span> <span class="o">:=</span>
<span class="n">rewrite_search_target</span> <span class="o">{}</span> <span class="o">[]</span>
</code></pre></div>
<p>The code that fails to parse:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">private</span> <span class="kd">example</span> <span class="o">:</span> <span class="o">[[</span><span class="mi">1</span><span class="o">],</span> <span class="o">[</span><span class="mi">1</span><span class="o">]]</span> <span class="bp">=</span> <span class="o">[[</span><span class="mi">7</span><span class="o">],</span> <span class="o">[</span><span class="mi">7</span><span class="o">]]</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">rewrite_search</span>

<span class="kd">constants</span> <span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span>
</code></pre></div>
<p>The error is on the "constants" - <code>37:1: invalid expression, unexpected token</code> - but it seems to just happen anywhere immediately after the <code>rewrite_search</code> tactic. Like the optional-parsing is failing to find the supposedly-optional thing, and then failing. This code works if I just delete the <code>(rs : parse $ optional rw_rules)</code> block.</p>



<a name="218594670"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218594670" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218594670">(Dec 02 2020 at 17:57)</a>:</h4>
<p>I haven't followed most of this thread and I'm gonna look at the PR soon, but <code>meta def rewrite_search (rs : parse $ optional rw_rules) : tactic string</code> looks fishy. Is this in the <code>tactic.interactive</code> namespace? Then it should be <code>tactic unit</code>, not <code>tactic string</code>. If it is in <code>tactic.interactive</code>, try the example outside of that namespace. If it isn't in <code>tactic.interactive</code> I wouldn't expect the parsing to work at all.</p>



<a name="218594831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218594831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218594831">(Dec 02 2020 at 17:58)</a>:</h4>
<p>it is in tactic.interactive. it works fine without this optional arg parsing stuff.</p>



<a name="218595183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218595183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218595183">(Dec 02 2020 at 18:01)</a>:</h4>
<p>it is actually returning a string here. but I think that part is working fine.</p>



<a name="218595673"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218595673" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218595673">(Dec 02 2020 at 18:04)</a>:</h4>
<p>This works:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.nth_rewrite</span>

<span class="kn">namespace</span> <span class="n">tactic</span>

<span class="kn">namespace</span> <span class="n">rewrite_search</span>

<span class="kd">meta</span> <span class="kd">structure</span> <span class="n">config</span> <span class="kd">extends</span> <span class="n">tactic.nth_rewrite.cfg</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">max_iterations</span>     <span class="o">:</span> <span class="n">ℕ</span> <span class="o">:=</span> <span class="mi">5000</span><span class="o">)</span>
<span class="o">(</span><span class="n">explain</span>            <span class="o">:</span> <span class="n">bool</span> <span class="o">:=</span> <span class="n">ff</span><span class="o">)</span>
<span class="o">(</span><span class="n">explain_using_conv</span> <span class="o">:</span> <span class="n">bool</span> <span class="o">:=</span> <span class="n">tt</span><span class="o">)</span>

<span class="kd">meta</span> <span class="kd">def</span> <span class="n">core</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">config</span> <span class="o">:=</span> <span class="o">{})</span> <span class="o">(</span><span class="n">l</span> <span class="o">:</span> <span class="n">list</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="o">(</span><span class="n">list</span> <span class="n">string</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">do</span>
  <span class="n">msgs</span> <span class="bp">←</span> <span class="n">pure</span> <span class="o">(</span><span class="n">to_string</span> <span class="bp">&lt;$&gt;</span> <span class="n">l</span><span class="o">),</span>
  <span class="n">trace</span> <span class="n">msgs</span><span class="o">,</span>
  <span class="n">pure</span> <span class="n">msgs</span>

<span class="kd">end</span> <span class="n">rewrite_search</span>

<span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite_search</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">tactic.rewrite_search.config</span> <span class="o">:=</span> <span class="o">{})</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="o">(</span><span class="k">if</span> <span class="n">cfg.max_iterations</span> <span class="bp">=</span> <span class="mi">5000</span>
  <span class="k">then</span> <span class="n">tactic.rewrite_search.core</span> <span class="n">cfg</span> <span class="o">[</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">]</span>
  <span class="k">else</span> <span class="n">tactic.rewrite_search.core</span> <span class="n">cfg</span> <span class="o">[</span><span class="mi">1000000</span><span class="o">])</span>
  <span class="bp">&gt;&gt;</span> <span class="n">skip</span>

<span class="kn">namespace</span> <span class="n">interactive</span>
<span class="kn">open</span> <span class="n">lean.parser</span> <span class="n">interactive</span>

<span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite_search</span> <span class="o">(</span><span class="n">try_harder</span> <span class="o">:</span> <span class="n">parse</span> <span class="bp">$</span> <span class="n">optional</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"!"</span><span class="o">))</span>
  <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">rewrite_search.config</span> <span class="o">:=</span> <span class="o">{})</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">tactic.rewrite_search</span> <span class="o">{</span> <span class="n">max_iterations</span> <span class="o">:=</span> <span class="k">match</span> <span class="n">try_harder</span> <span class="k">with</span> <span class="bp">|</span> <span class="n">none</span> <span class="o">:=</span> <span class="mi">5000</span> <span class="bp">|</span> <span class="n">some</span> <span class="n">_</span> <span class="o">:=</span> <span class="mi">100000</span> <span class="kd">end</span><span class="o">,</span>
<span class="bp">..</span><span class="n">cfg</span> <span class="o">}</span>

<span class="kd">end</span> <span class="n">interactive</span>


<span class="kd">variable</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span><span class="o">)</span>

<span class="kd">lemma</span> <span class="n">test_linear_path</span> <span class="o">:</span> <span class="n">h</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">h</span> <span class="mi">4</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">rewrite_search</span>

<span class="kd">lemma</span> <span class="n">test_linear_path'</span> <span class="o">:</span> <span class="n">h</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">h</span> <span class="mi">4</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">rewrite_search</span><span class="bp">!</span>
</code></pre></div>



<a name="218595707"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218595707" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218595707">(Dec 02 2020 at 18:04)</a>:</h4>
<p>Ahah, I take it back, I see what's going on.</p>



<a name="218595710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218595710" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218595710">(Dec 02 2020 at 18:04)</a>:</h4>
<p>Mouse over on the two <code>rewrite_search</code> and <code>rewrite_search!</code></p>



<a name="218595732"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218595732" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218595732">(Dec 02 2020 at 18:04)</a>:</h4>
<p><code>optional rw_rules</code> doesn't make sense, because the <code>rw_rules</code> parser always succeeds.</p>



<a name="218595769"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218595769" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218595769">(Dec 02 2020 at 18:05)</a>:</h4>
<p><span class="user-mention" data-user-id="308899">@Yakov Pechersky</span> your example isn't using an optional rw_rules though, which is the sticking point</p>



<a name="218595772"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218595772" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218595772">(Dec 02 2020 at 18:05)</a>:</h4>
<p>If there's no argument given you get an empty <code>rw_rules</code> object.</p>



<a name="218595794"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218595794" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218595794">(Dec 02 2020 at 18:05)</a>:</h4>
<p>oh, interesting</p>



<a name="218595963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218595963" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218595963">(Dec 02 2020 at 18:06)</a>:</h4>
<p>Er, wait, that's not quite it.</p>



<a name="218596013"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218596013" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218596013">(Dec 02 2020 at 18:07)</a>:</h4>
<p><code>rw_rules</code> looks for a list <code>[...]</code> or an expression.</p>



<a name="218596063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218596063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218596063">(Dec 02 2020 at 18:07)</a>:</h4>
<p>When it sees <code>constant</code> it thinks that's the beginning of an expression.</p>



<a name="218596188"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218596188" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218596188">(Dec 02 2020 at 18:08)</a>:</h4>
<p>lean syntax does not seem to be a natural fit for optional arguments to functions</p>



<a name="218596338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218596338" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218596338">(Dec 02 2020 at 18:09)</a>:</h4>
<p>if the answer here is like, optionally parsing a <code>rw_rules</code> just isn't simple so don't do it, I can live with that. but a PR reviewer asked for it and it seems reasonable abstractly so I would like to do it if it's straightforward ;-)</p>



<a name="218596385"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218596385" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218596385">(Dec 02 2020 at 18:09)</a>:</h4>
<p>bc right now there's just two identical tactics but one has this argument and one doesn't</p>



<a name="218596815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218596815" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218596815">(Dec 02 2020 at 18:12)</a>:</h4>
<p>Expressions can't contain <code>constant</code>, but I think the interactive parser doesn't know that, so it thinks parsing succeeded? But I'm not completely sure what's going on there.</p>



<a name="218596859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218596859" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218596859">(Dec 02 2020 at 18:13)</a>:</h4>
<p>The easy fix would be to prefix the optional <code>rw_rules</code> with a keyword like <code>using</code></p>



<a name="218597003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218597003" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218597003">(Dec 02 2020 at 18:14)</a>:</h4>
<p>So <code>rewrite_search using [....]</code> works, and if you write <code>using</code> without giving a <code>rw_rule</code> you deserve an error. <code>rewrite_search</code> without <code>using</code> won't even try to parse a <code>rw_rule</code> so it won't complain about the following token.</p>



<a name="218597067"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218597067" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218597067">(Dec 02 2020 at 18:15)</a>:</h4>
<p>that seems quite similar to have a second tactic called <code>rewrite_search_using</code></p>



<a name="218597120"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218597120" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218597120">(Dec 02 2020 at 18:15)</a>:</h4>
<p>but either way, TLDR I just shouldn't expect <code>(parse $ optional rw_rules)</code> to work</p>



<a name="218597348"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218597348" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218597348">(Dec 02 2020 at 18:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="238605">Kevin Lacker</span> <a href="#narrow/stream/113488-general/topic/optional.20arguments.20for.20tactics/near/218597067">said</a>:</p>
<blockquote>
<p>that seems quite similar to have a second tactic called <code>rewrite_search_using</code></p>
</blockquote>
<p>I mean, yes, except you're not duplicating code? Lots and lots of tactics take optional arguments this way.</p>



<a name="218597474"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218597474" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218597474">(Dec 02 2020 at 18:18)</a>:</h4>
<p>it isn't duplicating code, you just have both of them call a helper function</p>



<a name="218597583"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218597583" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218597583">(Dec 02 2020 at 18:19)</a>:</h4>
<p>but i am happy to stylistically adhere to the practices of other tactics</p>



<a name="218597883"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218597883" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218597883">(Dec 02 2020 at 18:21)</a>:</h4>
<p>If you really hate it you can just use the brackets part of <code>rw_rules</code>. </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">optional</span> <span class="o">((</span><span class="n">tk</span> <span class="s2">"["</span> <span class="bp">*&gt;</span>
 <span class="n">rw_rules_t.mk</span> <span class="bp">&lt;$&gt;</span> <span class="n">sep_by</span> <span class="o">(</span><span class="n">skip_info</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">","</span><span class="o">))</span> <span class="o">(</span><span class="n">set_goal_info_pos</span> <span class="bp">$</span> <span class="n">rw_rule_p</span> <span class="o">(</span><span class="n">parser.pexpr</span> <span class="mi">0</span><span class="o">))</span>
               <span class="bp">&lt;*&gt;</span> <span class="o">(</span><span class="n">some</span> <span class="bp">&lt;$&gt;</span> <span class="n">cur_pos</span> <span class="bp">&lt;*</span> <span class="n">set_goal_info_pos</span> <span class="o">(</span><span class="n">tk</span> <span class="s2">"]"</span><span class="o">))))</span>
</code></pre></div>
<p>or whatever (maybe don't inline it though). You won't be able to write <code>by rewrite_search foo</code> but you can do <code>by rewrite_search [foo]</code>.</p>



<a name="218597930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218597930" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218597930">(Dec 02 2020 at 18:21)</a>:</h4>
<p>hmm, I hate that more.</p>



<a name="218597957"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218597957" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218597957">(Dec 02 2020 at 18:21)</a>:</h4>
<p>what is another tactic that happily uses a "using" keyword that I can copy off its design</p>



<a name="218598060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218598060" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218598060">(Dec 02 2020 at 18:22)</a>:</h4>
<p>Note that this is the same syntax as <code>simp</code> (you can't write <code>by simp foo</code>, has to be <code>by simp [foo]</code>)</p>



<a name="218598176"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218598176" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218598176">(Dec 02 2020 at 18:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="238605">Kevin Lacker</span> <a href="#narrow/stream/113488-general/topic/optional.20arguments.20for.20tactics/near/218597957">said</a>:</p>
<blockquote>
<p>what is another tactic that happily uses a "using" keyword that I can copy off its design</p>
</blockquote>
<p><code>simpa</code>, <code>convert</code></p>



<a name="218598356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218598356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218598356">(Dec 02 2020 at 18:24)</a>:</h4>
<p><a href="https://leanprover-community.github.io/mathlib_docs/find/tactic.interactive.choose/src">src#tactic.interactive.choose</a></p>



<a name="218598465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218598465" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218598465">(Dec 02 2020 at 18:25)</a>:</h4>
<p>OK i'll look there</p>



<a name="218598479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218598479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218598479">(Dec 02 2020 at 18:25)</a>:</h4>
<p>thanks for the help folks</p>



<a name="218609660"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218609660" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218609660">(Dec 02 2020 at 19:51)</a>:</h4>
<p>After reviewing the PR, I think there's a better solution here.</p>
<p>Define</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">private</span> <span class="kd">meta</span> <span class="kd">def</span> <span class="n">rw_search_parser</span> <span class="o">:</span> <span class="n">lean.parser</span> <span class="o">(</span><span class="n">pexpr</span> <span class="bp">×</span> <span class="n">bool</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">do</span> <span class="n">flipped</span> <span class="bp">←</span> <span class="n">optional</span> <span class="bp">$</span> <span class="n">tk</span> <span class="s2">"←"</span><span class="o">,</span>
   <span class="n">e</span> <span class="bp">←</span> <span class="n">lean.parser.pexpr</span> <span class="mi">0</span><span class="o">,</span>
   <span class="n">return</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">flipped.is_some</span><span class="o">)</span>

<span class="sd">/-- Search for a chain of rewrites to prove an equation or iff statement. -/</span>
<span class="kd">meta</span> <span class="kd">def</span> <span class="n">rewrite_search</span> <span class="o">(</span><span class="n">args</span> <span class="o">:</span> <span class="n">parse</span> <span class="o">(</span><span class="n">optional</span> <span class="o">(</span><span class="n">list_of</span> <span class="n">rw_search_parser</span><span class="o">)))</span> <span class="o">(</span><span class="n">cfg</span> <span class="o">:</span> <span class="n">config</span> <span class="o">:=</span> <span class="o">{})</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">rewrite_search_target</span> <span class="n">cfg</span> <span class="o">(</span><span class="n">args.get_or_else</span> <span class="o">[])</span> <span class="bp">$&gt;</span> <span class="o">()</span>
</code></pre></div>
<p>Now <code>rewrite_search_target</code> is getting a list of <code>pexpr × bool</code>s instead of a list of <code>rw_rule</code>s. But you never used the <code>rw_rule</code>s as <code>rw_rule</code>s, you converted them into <code>expr × bool</code> immediately. You need to propagate that change through a few functions but it isn't hard.</p>



<a name="218609857"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218609857" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218609857">(Dec 02 2020 at 19:53)</a>:</h4>
<p>This allows you to write <code>by rewrite_search</code> and <code>by rewrite_search [a, b, c]</code>. You can't write <code>by rewrite_search a</code>. But I'm not inclined to allow that anyway. <code>rw_search</code> is closer to <code>simp</code> than <code>rw</code>. Even if you only give it a single extra rule, morally you're giving it a singleton set of rules. That rule can be used multiple times.</p>



<a name="218609909"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218609909" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218609909">(Dec 02 2020 at 19:53)</a>:</h4>
<p>So needing to enclose it in a list makes sense.</p>



<a name="218635112"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218635112" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218635112">(Dec 02 2020 at 23:28)</a>:</h4>
<p>This is the reason why <code>simp</code> has required brackets around its arguments while <code>rw</code> doesn't, btw</p>



<a name="218635251"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218635251" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218635251">(Dec 02 2020 at 23:30)</a>:</h4>
<p>oh, rob said this already</p>



<a name="218635296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218635296" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218635296">(Dec 02 2020 at 23:30)</a>:</h4>
<p>Actually, I think it might be possible to write a parser that only allows the config if the brackets are provided, but lets you leave off the brackets if you don't provide a config</p>



<a name="218635547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218635547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218635547">(Dec 02 2020 at 23:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113488-general/topic/optional.20arguments.20for.20tactics/near/218635296">said</a>:</p>
<blockquote>
<p>Actually, I think it might be possible to write a parser that only allows the config if the brackets are provided, but lets you leave off the brackets if you don't provide a config</p>
</blockquote>
<p>Possible, but I wouldn't bother</p>



<a name="218635554"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218635554" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218635554">(Dec 02 2020 at 23:33)</a>:</h4>
<p>In fact, I'd prefer that you not bother!</p>



<a name="218635836"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218635836" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218635836">(Dec 02 2020 at 23:37)</a>:</h4>
<p>how come?</p>



<a name="218635914"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218635914" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218635914">(Dec 02 2020 at 23:38)</a>:</h4>
<p>is it just the churn of changing <code>simp</code>, or is it the regression in writing <code>simp [] {config_opt := ...}</code> instead of <code>simp {config_opt := ...}</code></p>



<a name="218635973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218635973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218635973">(Dec 02 2020 at 23:39)</a>:</h4>
<p>It's a more complicated parser and more work to describe the available syntax options, and semantically it doesn't make a ton of sense.</p>



<a name="218635999"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218635999" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218635999">(Dec 02 2020 at 23:39)</a>:</h4>
<p>I'm not sure I follow the latter argument</p>



<a name="218636000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636000">(Dec 02 2020 at 23:39)</a>:</h4>
<p>I was talking about <code>rewrite_search foo {...}</code> vs <code>rewrite_search [foo] {...}</code></p>



<a name="218636092"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636092" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636092">(Dec 02 2020 at 23:40)</a>:</h4>
<p>May have misinterpreted what you meant about <code>simp</code>, I didn't know you needed <code>[]</code> in your example.</p>



<a name="218636149"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636149" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636149">(Dec 02 2020 at 23:41)</a>:</h4>
<p>you would in the suggested change, because the <code>{...}</code> would be treated as a simp lemma otherwise</p>



<a name="218636161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636161">(Dec 02 2020 at 23:41)</a>:</h4>
<p>Oh, wait, sorry</p>



<a name="218636171"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636171" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636171">(Dec 02 2020 at 23:41)</a>:</h4>
<p>I read you right the first time and misread the second time</p>



<a name="218636203"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636203" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636203">(Dec 02 2020 at 23:41)</a>:</h4>
<p>I suppose you could check for a <code>{</code> but I'm not sure if it's possible to do that, roll back by one token and then parse it as an expr</p>



<a name="218636274"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636274" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636274">(Dec 02 2020 at 23:42)</a>:</h4>
<p>the major limitation is that lean's parser does not do backtracking, so you have to sometimes write parsers in a weird way</p>



<a name="218636344"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636344" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636344">(Dec 02 2020 at 23:43)</a>:</h4>
<p>Allowing <code>simp foo</code> saves you two characters in an edge case in exchange for a more complicated parser. And you have a simp set anyway, semantically it makes sense that you're adding a set (/list) to it, so, <code>[a]</code>.</p>



<a name="218636380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636380">(Dec 02 2020 at 23:43)</a>:</h4>
<p>Wasn't even thinking of the <code>simp [] {}</code> case, but that's another argument.</p>



<a name="218636383"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636383" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636383">(Dec 02 2020 at 23:43)</a>:</h4>
<p>I don't think <code>simp [one_lemma]</code> is an edge case</p>



<a name="218636418"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636418" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636418">(Dec 02 2020 at 23:44)</a>:</h4>
<p>it's much more common than <code>simp {config}</code></p>



<a name="218636545"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636545" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636545">(Dec 02 2020 at 23:45)</a>:</h4>
<p>Given how often <code>simp</code> is called, it wouldn't surprise me if the more complicated parser even had a visible performance impact.</p>



<a name="218636567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636567" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636567">(Dec 02 2020 at 23:45)</a>:</h4>
<p>6950 hits for <code>simp [</code>, 2478 for <code>simp [one_word]</code>, 39 for <code>simp {</code></p>



<a name="218636766"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636766" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636766">(Dec 02 2020 at 23:48)</a>:</h4>
<p>I don't have a really good understanding of parser performance behavior. There is an extra <code>eval_expr</code> to get the config but this seems to be a pretty uncommon option anyway</p>



<a name="218636903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218636903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218636903">(Dec 02 2020 at 23:49)</a>:</h4>
<p>My guess is that it would not be visible in the benchmark over the noise, but probably we would have to test to find out</p>



<a name="218637236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218637236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218637236">(Dec 02 2020 at 23:52)</a>:</h4>
<p>I remember reporting this "inconsistency" between <code>simp</code> and <code>rw</code> back in the day to leo et al, and being told about the parser limitations preventing this. I have since become better at writing parsers</p>



<a name="218637339"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218637339" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218637339">(Dec 02 2020 at 23:53)</a>:</h4>
<p>the cfg currently comes at a really weird place though, after everything including the <code>with attrs...</code> and <code>at pos</code></p>



<a name="218641802"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218641802" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218641802">(Dec 03 2020 at 00:57)</a>:</h4>
<p>Well, I managed to find a lean bug while mocking this up:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic</span>

<span class="kn">namespace</span> <span class="n">tactic.interactive</span>
<span class="n">setup_tactic_parser</span>

<span class="kd">meta</span> <span class="kd">def</span> <span class="n">test</span> <span class="o">:</span> <span class="n">parse</span> <span class="n">texpr</span><span class="bp">?</span> <span class="bp">→</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span><span class="o">,</span> <span class="n">trivial</span>

<span class="kd">end</span> <span class="n">tactic.interactive</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">test</span> <span class="bp">.</span> <span class="c1">-- ok</span>
<span class="kd">example</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">test</span>   <span class="c1">-- works, but...</span>
<span class="kd">example</span> <span class="c1">-- invalid expression, unexpected token</span>
  <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">test</span> <span class="bp">.</span>
</code></pre></div>



<a name="218641904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218641904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218641904">(Dec 03 2020 at 00:58)</a>:</h4>
<p>It appears that the <code>optional texpr</code> parser will crash badly if it sees a command keyword instead of just failing by the usual channels. It still works to parse what it was supposed to, the tactic continues and everything, but it throws an error on the token while it's at it</p>



<a name="218642557"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218642557" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218642557">(Dec 03 2020 at 01:08)</a>:</h4>
<p>Here's a repro in pure lean:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">transitivity</span> <span class="c1">-- this error is expected</span>
<span class="kd">example</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span> <span class="n">trivial</span> <span class="c1">-- this one is not</span>
</code></pre></div>



<a name="218665064"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/optional%20arguments%20for%20tactics/near/218665064" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/optional.20arguments.20for.20tactics.html#218665064">(Dec 03 2020 at 08:32)</a>:</h4>
<p>nice. yeah missing <code>by rewrite_search a</code> is not a big loss. i'll implement this suggestion in the PR</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>