---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/various.20type-class.20loops.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html">various type-class loops</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="251459374"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251459374" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251459374">(Aug 31 2021 at 21:03)</a>:</h4>
<p>I wrote a new linter that catches type-class loops (<a href="https://github.com/leanprover-community/mathlib/issues/8932">#8932</a>), and I'm making some topics with some issues it found. I don't always know the best solution to fix these loops, so I'm hoping that someone who knows that part of mathlib better can fix these.</p>
<p>Here are some problematic instances in the library</p>
<ul>
<li><a href="https://leanprover-community.github.io/mathlib_docs/find/nat.subtype.semilattice_sup_bot">docs#nat.subtype.semilattice_sup_bot</a> loops with the forgetful instances <code>semilattice_sup_bot -&gt; has_bot -&gt; nonempty</code> (I think this was originally written by <span class="user-mention" data-user-id="110044">@Chris Hughes</span>, but it's very old). Here is an example (that is supposed to fail):</li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">data.nat.basic</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">set</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">[</span><span class="n">decidable_pred</span> <span class="o">(</span><span class="bp">∈</span> <span class="n">s</span><span class="o">)]</span> <span class="o">:</span> <span class="n">semilattice_sup_bot</span> <span class="n">s</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">apply_instance</span>
</code></pre></div>
<ul>
<li><a href="https://leanprover-community.github.io/mathlib_docs/find/sub_mul_action.has_zero">docs#sub_mul_action.has_zero</a> loops with <a href="https://leanprover-community.github.io/mathlib_docs/find/has_zero.nonempty">docs#has_zero.nonempty</a>. (<span class="user-mention" data-user-id="310045">@Eric Wieser</span>)</li>
<li>The class <a href="https://leanprover-community.github.io/mathlib_docs/find/add_torsor">docs#add_torsor</a> is problematic. It comes with the instance <a href="https://leanprover-community.github.io/mathlib_docs/find/add_torsor.nonempty">docs#add_torsor.nonempty</a> (a "dangerous" instance <a href="https://leanprover-community.github.io/mathlib_docs/find/linter.dangerous_instance/src">src#linter.dangerous_instance</a>). This causes a loop with e.g. <a href="https://leanprover-community.github.io/mathlib_docs/find/affine_subspace.to_add_torsor">docs#affine_subspace.to_add_torsor</a> (which would normally be a fine instance) (<span class="user-mention" data-user-id="266253">@Joseph Myers</span>)</li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">linear_algebra.affine_space.affine_subspace</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">k</span> <span class="n">V</span> <span class="n">P</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">ring</span> <span class="n">k</span><span class="o">]</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">V</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="n">k</span> <span class="n">V</span><span class="o">]</span>
 <span class="o">[</span><span class="n">add_torsor</span> <span class="n">V</span> <span class="n">P</span><span class="o">]</span> <span class="o">{</span><span class="n">s</span> <span class="o">:</span> <span class="n">set</span> <span class="n">P</span><span class="o">}</span> <span class="o">:</span> <span class="n">nonempty</span> <span class="o">(</span><span class="n">affine_span</span> <span class="n">k</span> <span class="n">s</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">apply_instance</span>
</code></pre></div>



<a name="251459390"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251459390" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251459390">(Aug 31 2021 at 21:03)</a>:</h4>
<ul>
<li>The next problem I found has the least clear solution. It is an instance that doesn't loop, but takes a long time to fail. On yesterday's mathlib it takes 8.6 seconds on my laptop (<a href="https://github.com/leanprover-community/mathlib/issues/8933">#8933</a> should have reduced that a bit)</li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c1">--after running scripts/mk_all.sh</span>
<span class="kn">import</span> <span class="n">all</span>

<span class="kn">open</span> <span class="n">topological_space</span> <span class="n">measure_theory</span>

<span class="kd">set_option</span> <span class="n">profiler</span> <span class="n">true</span>
<span class="kd">example</span> <span class="o">{</span><span class="n">α</span> <span class="n">E</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">m0</span> <span class="o">:</span> <span class="n">measurable_space</span> <span class="n">α</span><span class="o">}</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ennreal</span><span class="o">}</span> <span class="o">{</span><span class="n">μ</span> <span class="o">:</span> <span class="n">measure</span> <span class="n">α</span><span class="o">}</span>
  <span class="o">[</span><span class="n">measurable_space</span> <span class="n">E</span><span class="o">]</span> <span class="o">[</span><span class="n">normed_group</span> <span class="n">E</span><span class="o">]</span> <span class="o">[</span><span class="n">borel_space</span> <span class="n">E</span><span class="o">]</span>
  <span class="o">[</span><span class="n">second_countable_topology</span> <span class="n">E</span><span class="o">]</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">≤</span> <span class="n">p</span><span class="o">)]</span> <span class="o">:</span>
  <span class="n">complete_space</span> <span class="o">(</span><span class="n">measure_theory.Lp</span> <span class="n">E</span> <span class="n">p</span> <span class="n">μ</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">apply_instance</span>
</code></pre></div>
<p>During the type-class search, a suprising amount of time is spent that some of these infinite-dimensional objects are instances of <code>fintype</code>, <code>decidable_eq</code>, <code>unique</code>, <code>subsingleton</code>, etc., which are classes with a lot of instances.</p>
<p>The following instances reduce the type-class inference type most.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">local</span> <span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="kd">instance</span><span class="o">]</span> <span class="c1">-- with all instances: 8.6s</span>
  <span class="n">finite_dimensional.complex_to_real</span> <span class="c1">-- without this instance: 5.1s</span>
  <span class="c1">-- as of #8933 the next line should be insignificant</span>
  <span class="n">is_simple_lattice.fintype</span> <span class="c1">-- without this and above instances: 2.7s</span>
  <span class="n">ring.is_noetherian_of_fintype</span> <span class="c1">-- without this and above instances: 1.3s</span>
  <span class="n">finite_dimensional.proper_is_R_or_C</span> <span class="c1">-- without this and above instances: 0.6s</span>
  <span class="n">fintype.compact_space</span> <span class="c1">-- without this and above instances: 0.3s</span>
  <span class="n">subsingleton.compact_space</span> <span class="c1">-- without this and above instances: 0.2s</span>
</code></pre></div>
<p>I'm wondering if we can make some of these instances localized. For example, I expect that <a href="https://leanprover-community.github.io/mathlib_docs/find/ring.is_noetherian_of_fintype">docs#ring.is_noetherian_of_fintype</a>, <a href="https://leanprover-community.github.io/mathlib_docs/find/fintype.compact_space">docs#fintype.compact_space</a> and <a href="https://leanprover-community.github.io/mathlib_docs/find/subsingleton.compact_space">docs#subsingleton.compact_space</a> are rarely used (and the last one can probably be removed given that we have the <code>fintype</code> one). Maybe we could localize them in some locale? The remaining two instances (<a href="https://leanprover-community.github.io/mathlib_docs/find/finite_dimensional.complex_to_real">docs#finite_dimensional.complex_to_real</a> and <a href="https://leanprover-community.github.io/mathlib_docs/find/finite_dimensional.proper_is_R_or_C">docs#finite_dimensional.proper_is_R_or_C</a>) do seem useful often, so I'm not sure what to do with them.</p>



<a name="251468385"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251468385" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251468385">(Aug 31 2021 at 22:09)</a>:</h4>
<p>Removing/localizing these instances would also speed up other failures of type-class problems</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">all</span>

<span class="c1">-- 6.3s with all instances -&gt; 0.1s without the instances mentioned above</span>
<span class="kd">example</span> <span class="o">{</span><span class="n">R</span> <span class="n">K</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">integral_domain</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">[</span><span class="n">algebra</span> <span class="n">R</span> <span class="n">K</span><span class="o">]</span>
  <span class="o">[</span><span class="n">is_fraction_ring</span> <span class="n">R</span> <span class="n">K</span><span class="o">]</span> <span class="o">:</span> <span class="n">fintype</span> <span class="o">(</span><span class="n">class_group</span> <span class="n">R</span> <span class="n">K</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">apply_instance</span>

<span class="c1">-- 8.5s with all instances -&gt; 1.6s without the instances mentioned above</span>
<span class="c1">-- (this one might be harder to get under &lt;0.5s)</span>
<span class="kd">example</span> <span class="o">{</span><span class="n">K</span> <span class="n">V</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">field</span> <span class="n">K</span><span class="o">]</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">V</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="n">K</span> <span class="n">V</span><span class="o">]</span>
<span class="o">(</span><span class="n">S₁</span> <span class="n">S₂</span> <span class="o">:</span> <span class="n">submodule</span> <span class="n">K</span> <span class="n">V</span><span class="o">)</span> <span class="o">:</span> <span class="n">finite_dimensional</span> <span class="n">K</span> <span class="o">(</span><span class="n">S₁</span> <span class="bp">⊓</span> <span class="n">S₂</span> <span class="o">:</span> <span class="n">submodule</span> <span class="n">K</span> <span class="n">V</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">apply_instance</span>
</code></pre></div>



<a name="251481493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251481493" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph Myers <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251481493">(Sep 01 2021 at 00:23)</a>:</h4>
<p>It looks like the <code>add_torsor.nonempty</code> instance was added by <span class="user-mention" data-user-id="214703">@Yury G. Kudryashov</span> as part of the <code>out_param</code> changes (<a href="https://github.com/leanprover-community/mathlib/issues/3727">#3727</a>). What breaks if you make it no longer an instance?</p>



<a name="251483487"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251483487" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251483487">(Sep 01 2021 at 00:47)</a>:</h4>
<p>Let's find out! <a href="https://github.com/leanprover-community/mathlib/tree/add_torsor_nonempty">branch#add_torsor_nonempty</a> (I mistakenly looked at the field <code>[nonempty : nonempty P]</code> in Git blame for whom to "blame")</p>



<a name="251483824"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251483824" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251483824">(Sep 01 2021 at 00:52)</a>:</h4>
<p>Note that the loop has nothing to do with the instance being "dangerous".</p>



<a name="251484213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251484213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251484213">(Sep 01 2021 at 00:56)</a>:</h4>
<p>Oh you're right, I missed that <code>G</code> is an <code>out_param</code> of the class. <br>
In that case <a href="https://leanprover-community.github.io/mathlib_docs/find/affine_subspace.to_add_torsor">docs#affine_subspace.to_add_torsor</a> seems like a bad instance</p>



<a name="251485894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251485894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251485894">(Sep 01 2021 at 01:17)</a>:</h4>
<p>But we want to have an affine space structure on a nontrivial affine subspace. Should we introduce yet another <code>ne_bot</code>?</p>



<a name="251485959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251485959" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251485959">(Sep 01 2021 at 01:18)</a>:</h4>
<p>And use it instead of <code>nonempty</code> for <code>affine_subspace</code>s until we migrate to Lean 4?</p>



<a name="251501525"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251501525" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251501525">(Sep 01 2021 at 05:01)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> a generic question: do you think some of these problems are "worth" ignoring <span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span> because Lean 4 is around the proverbial corner?</p>



<a name="251504733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/various%20type-class%20loops/near/251504733" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/various.20type-class.20loops.html#251504733">(Sep 01 2021 at 05:37)</a>:</h4>
<p>If Lean 4 has no problem with all these loops, then I guess it's ok to ignore these in Lean 3 for the moment. <br>
I'll test these loops in the binported version, and see if (and how well) it can deal with these.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>