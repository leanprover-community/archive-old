---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/fun.20with.20coe_fn.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/fun.20with.20coe_fn.html">fun with coe_fn</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="205793861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/fun%20with%20coe_fn/near/205793861" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/fun.20with.20coe_fn.html#205793861">(Aug 03 2020 at 13:34)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">universe</span> <span class="n">u</span>

<span class="kn">structure</span> <span class="n">fun_wrapper</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">to_fun</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">→</span> <span class="n">A</span><span class="o">)</span>

<span class="kn">instance</span> <span class="n">fun_wrapper</span><span class="bp">.</span><span class="n">has_one</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">:</span> <span class="n">has_one</span> <span class="o">(</span><span class="n">fun_wrapper</span> <span class="n">A</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨⟨</span><span class="n">id</span><span class="bp">⟩⟩</span>

<span class="kn">instance</span> <span class="n">fun_wrapper</span><span class="bp">.</span><span class="n">has_coe_to_fun</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">:</span> <span class="n">has_coe_to_fun</span> <span class="o">(</span><span class="n">fun_wrapper</span> <span class="n">A</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">⟨_</span><span class="o">,</span> <span class="n">fun_wrapper</span><span class="bp">.</span><span class="n">to_fun</span><span class="bp">⟩</span>

<span class="kn">theorem</span> <span class="n">foo</span> <span class="o">:</span> <span class="o">((</span><span class="mi">1</span> <span class="o">:</span> <span class="n">fun_wrapper</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">unit</span> <span class="bp">→</span> <span class="n">empty</span><span class="o">)</span> <span class="bp">=</span> <span class="n">id</span> <span class="o">:=</span> <span class="n">rfl</span>
</code></pre></div>



<a name="205793872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/fun%20with%20coe_fn/near/205793872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/fun.20with.20coe_fn.html#205793872">(Aug 03 2020 at 13:34)</a>:</h4>
<p>question: what's the type of <code>id</code> in the statement of <code>foo</code>?</p>



<a name="205794188"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/fun%20with%20coe_fn/near/205794188" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/fun.20with.20coe_fn.html#205794188">(Aug 03 2020 at 13:37)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> how does type ascription work?</p>



<a name="205795513"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/fun%20with%20coe_fn/near/205795513" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/fun.20with.20coe_fn.html#205795513">(Aug 03 2020 at 13:47)</a>:</h4>
<p>Kenny, the new widget interface answers your question about <code>foo</code></p>



<a name="205795535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/fun%20with%20coe_fn/near/205795535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/fun.20with.20coe_fn.html#205795535">(Aug 03 2020 at 13:47)</a>:</h4>
<p><code>id</code> is natural number <code>id</code></p>



<a name="205797198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/fun%20with%20coe_fn/near/205797198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/fun.20with.20coe_fn.html#205797198">(Aug 03 2020 at 14:01)</a>:</h4>
<p>That is pretty interesting. I haven't run the code yet, but I assume it typechecks, and my guess is the following:</p>
<ul>
<li><code>(1 : fun_wrapper ℕ)</code> has the expected meaning, the wrapper around <code>@id ℕ</code></li>
<li>Because this has type <code>fun_wrapper ℕ</code> does not have the type <code>unit -&gt; empty</code> or unify with it, lean inserts a <code>coe_fn</code> into the term</li>
<li>Now the resulting term <code>coe_fn (@has_one.one (fun_wrapper ℕ) ...) = id</code> is typechecked, finishing up the remaining holes in the term around <code>coe_fn</code> and <code>id</code>.</li>
<li>Importantly, the type ascription <code>: unit -&gt; empty</code> is now gone, because it has no representation as an expr. We only have a few metavariables left to solve in an otherwise complete <code>expr</code></li>
<li>The <code>fun_wrapper.has_coe_to_fun</code> instance is inserted, which means that the result type is <code>ℕ -&gt; ℕ</code>, so the rhs is inferred to be <code>@id ℕ</code>, and we are done.</li>
</ul>



<a name="205797712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/fun%20with%20coe_fn/near/205797712" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/fun.20with.20coe_fn.html#205797712">(Aug 03 2020 at 14:05)</a>:</h4>
<p>Note the difference with <code>coe : A -&gt; B</code>, where the output has type <code>B</code>, so a type ascription will cause <code>@coe ?A ?B ...</code>  to solve the <code>?B</code> metavariable. In <code>coe_fn</code> there is no metavariable <code>B</code>, it is a delayed unification of the form <code>has_coe_fo_fun.F ?C ?x =?= B</code>, which doesn't help to solve for <code>?C</code>. I guess lean forgot about this unification constraint when it decided to insert the <code>coe_fn</code> in the term</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>