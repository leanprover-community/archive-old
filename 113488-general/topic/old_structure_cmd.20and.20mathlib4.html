---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html">old_structure_cmd and mathlib4</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="256820034"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820034" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820034">(Oct 08 2021 at 23:28)</a>:</h4>
<p>Recall that <code>old_structure_cmd</code> doesn't exist in Lean4.<br>
Instead, Lean4 now has <a href="https://github.com/leanprover/lean4/blob/master/tests/lean/diamond7.lean">direct support for diamond inheritance</a>.</p>
<p>Thus in Lean4 <code>class Field (α : Type u) extends DivisionRing α, CommRing α</code> produces constructors and projections like:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Field.mk</span> <span class="o">:</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_1</span><span class="o">}</span> <span class="bp">→</span> <span class="o">[</span><span class="n">toDivisionRing</span> <span class="o">:</span> <span class="n">DivisionRing</span> <span class="n">α</span><span class="o">]</span> <span class="bp">→</span> <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">a</span><span class="o">)</span> <span class="bp">→</span> <span class="n">Field</span> <span class="n">α</span>

<span class="kd">def</span> <span class="n">Field.toDivisionRing.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="o">:</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="bp">→</span> <span class="o">[</span><span class="n">self</span> <span class="o">:</span> <span class="n">Field.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">α</span><span class="o">]</span> <span class="bp">→</span> <span class="n">DivisionRing.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">α</span> <span class="o">:=</span>
<span class="k">fun</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">self</span> <span class="o">:</span> <span class="n">Field.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">α</span><span class="o">]</span> <span class="bp">=&gt;</span> <span class="n">self.1</span>

<span class="kd">def</span> <span class="n">Field.toCommRing.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="o">:</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="bp">→</span> <span class="o">[</span><span class="n">self</span> <span class="o">:</span> <span class="n">Field.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">α</span><span class="o">]</span> <span class="bp">→</span> <span class="n">CommRing.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">α</span> <span class="o">:=</span>
<span class="k">fun</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">self</span> <span class="o">:</span> <span class="n">Field.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">α</span><span class="o">]</span> <span class="bp">=&gt;</span>
  <span class="bp">@</span><span class="n">CommRing.mk.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">DivisionRing.toRing.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">Field.toDivisionRing.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">α</span> <span class="n">self</span><span class="o">))</span> <span class="o">(</span><span class="bp">@</span><span class="n">Field.mul_comm.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">α</span> <span class="n">self</span><span class="o">)</span>
</code></pre></div>



<a name="256820063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820063">(Oct 08 2021 at 23:28)</a>:</h4>
<p>Ideally in the long run in Mathlib4 we will be using this implementation. We need to work out how to get there!</p>



<a name="256820071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820071">(Oct 08 2021 at 23:28)</a>:</h4>
<p>Some alternatives:</p>
<ol>
<li>remove use of <code>old_structure_cmd</code> from mathlib3 before the port</li>
<li>during migration, port <code>old_structure_cmd</code> structures by hand to "new" structures, and write automation in mathport to align</li>
<li>during migration, implement <code>old_structure_cmd</code> in mathlib4 and automate the port entirely</li>
</ol>



<a name="256820107"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820107" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820107">(Oct 08 2021 at 23:29)</a>:</h4>
<p>If 1. is viable, I'm in favour of it:</p>
<ul>
<li>it reduces the work mathport needs to do, saving Daniel's effort for other things</li>
<li>option 3. seems prematurely pessimistic --- it prolongs the life of the old_structure_cmd hack</li>
<li>option 2. requires additional work during the port, while option 1. can be done now, while we have lots of refactoring resources available</li>
</ul>



<a name="256820120"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820120" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820120">(Oct 08 2021 at 23:29)</a>:</h4>
<p>That said, even option 1. may require some work in mathport, depending on whether we can remove <code>old_structure_cmd</code> in a way that exactly matches the type signatures that "new structures" generate.</p>



<a name="256820127"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820127" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820127">(Oct 08 2021 at 23:29)</a>:</h4>
<p>To this end, yesterday I tried removing some uses of <code>old_structure_cmd</code> from mathlib3. I just worked on the "long-hanging fruit", to get up to speed, and all the cases I tried were either trivial or easy: <a href="https://github.com/leanprover-community/mathlib/issues/9612">#9612</a> <a href="https://github.com/leanprover-community/mathlib/issues/9613">#9613</a> <a href="https://github.com/leanprover-community/mathlib/issues/9614">#9614</a> <a href="https://github.com/leanprover-community/mathlib/issues/9615">#9615</a> <a href="https://github.com/leanprover-community/mathlib/issues/9616">#9616</a> <a href="https://github.com/leanprover-community/mathlib/issues/9617">#9617</a> <a href="https://github.com/leanprover-community/mathlib/issues/9620">#9620</a> <a href="https://github.com/leanprover-community/mathlib/issues/9621">#9621</a> <a href="https://github.com/leanprover-community/mathlib/issues/9622">#9622</a>.</p>



<a name="256820139"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820139" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820139">(Oct 08 2021 at 23:29)</a>:</h4>
<p>The remaining uses of <code>old_structure_cmd</code> fall mostly into three cases:</p>
<ul>
<li>algebraic structures</li>
<li>algebraic morphisms</li>
<li>order structures</li>
</ul>
<p>I suspect that it makes sense to deal with these "all at once" (i.e. 3 seperate refactors), and I'm happy to have a go at these, although if anyone else would like to do some or all please let me know!</p>



<a name="256820146"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820146" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820146">(Oct 08 2021 at 23:29)</a>:</h4>
<p>The basic principle of removing <code>old_structure_cmd</code> is:</p>
<ol>
<li>if two parents have overlapping fields, chose a "preferred" one</li>
<li>remove the non-preferred parent from the <code>extends</code> clause</li>
<li>copy-and-paste the fields of the non-preferred parent into the current structure</li>
<li>write <code>to_non_preferred_parent</code>, either as a def or an instance</li>
<li>optionally, write a "fully-flattened" constructor that emulates the constructor that <code>old_structure_cmd</code> provided</li>
<li>update initialization of <code>simps</code> (see examples in PRs above)</li>
<li>patch downstream code as necessary, particularly use of constructors</li>
</ol>



<a name="256820189"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820189" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820189">(Oct 08 2021 at 23:30)</a>:</h4>
<p>(To be clear, the proposal is that <em>after</em> the mathport phase of the mathlib3 -&gt; mathlib4 port, when we are cleaning up files by hand, we will be able to remove these copy-and-paste fields, and restore the non-preferred parent to the extends clause, and Lean4 will then automatically generate <code>to_non_preferred_parent</code>.)</p>



<a name="256820199"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820199" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820199">(Oct 08 2021 at 23:30)</a>:</h4>
<p>In the PRs I made so far, it was always obvious which was the "preferred" parent, and it's slightly less so in the remaining cases. I propose the following preferences:</p>
<ul>
<li>data over axioms</li>
<li>additive stuff over multiplicative stuff</li>
<li>less-algebraic-structure over upgrading-to-equivalences</li>
</ul>
<p>I'm not sure what other decisions will need to be made.</p>



<a name="256820206"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256820206" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256820206">(Oct 08 2021 at 23:30)</a>:</h4>
<p>So --- in summary:</p>
<ul>
<li>If there are reasons I'm missing for not attempting to remove use of <code>old_structure_cmd</code> from mathlib3, please explain them!</li>
<li>Otherwise, I'll try doing more of this,</li>
<li>but help is very welcome. :-)</li>
</ul>



<a name="256821436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256821436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256821436">(Oct 08 2021 at 23:47)</a>:</h4>
<p>When you are doing this, make sure to put an attribute to mark the non-preferred parents as parents</p>



<a name="256853549"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256853549" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256853549">(Oct 09 2021 at 08:50)</a>:</h4>
<p>Won't making this change mean that after telling Leo "hey, we really want direct support for diamonds", that the mathlib port will not end up using them at all?</p>



<a name="256853986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256853986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256853986">(Oct 09 2021 at 08:59)</a>:</h4>
<p>Immediately after the automatic port, it won't be using diamonds. Instead, it will be using definitions (manually constructed in mathlib3, automatically ported to mathlib4) which are pretty close to what Leo's solution produces. Then, soon after we're happy with the output of mathport, we will delete these definitions, replacing them with multiple-extends-diamond-inheritance.</p>



<a name="256854003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256854003" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256854003">(Oct 09 2021 at 08:59)</a>:</h4>
<p>It's just a bridge to get to the point where we are using the direct support for diamonds.</p>



<a name="256854042"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256854042" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256854042">(Oct 09 2021 at 09:00)</a>:</h4>
<p>(But a bridge for which the work can be done "on this side of the gap".)</p>



<a name="256854593"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256854593" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256854593">(Oct 09 2021 at 09:08)</a>:</h4>
<p>Perhaps this is what Mario was saying above, but it sounds like we should tag every such diamond workaround with a comment (library note?) or attribute, to make them easier to find after the port</p>



<a name="256856034"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256856034" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256856034">(Oct 09 2021 at 09:34)</a>:</h4>
<p>Is there any indication that old_str_cmd is an issue for the port?  I thought we could just ignore it because the nw structure command is more general.</p>



<a name="256866582"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256866582" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256866582">(Oct 09 2021 at 12:28)</a>:</h4>
<p>I think it limits our flexibility as follows. If we do the port as an automated run through mathport "from scratch", and then patch things up afterwards, then yes, we can probably ignore <code>old_structure_cmd</code>. However we're (probably) not doing the port from scratch: we're going to have a partially "by hand" ported mathlib, just enough to support writing essential tactics, and then we're going to run <code>mathport</code> "relative" to that.</p>
<p>As an example, we already have <code>Ring</code> in mathlib4, to support writing the <code>ring</code> tactic, and when mathport runs at the moment it can't align the ported <code>ring</code> from mathlib3 with the <code>Ring</code> in mathlib4 (because the <code>ring</code> in mathlib3 has flattened fields), so we get a <code>Ring</code> (hand-ported) and a <code>Ringₓ</code> (generated by mathport).</p>
<p>That said:</p>
<ol>
<li>Of course we can put more effort (either by hand or automation) into aligning <code>Ring</code> and <code>Ringₓ</code>.</li>
<li>There may not actually be many instances of this problem, because tactics don't actually rely much on the algebraic hierarchy, so we don't need to port much "by hand". (And we could re-engineer things to rely even less on the algebraic hierarchy.)</li>
</ol>



<a name="256866758"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256866758" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256866758">(Oct 09 2021 at 12:31)</a>:</h4>
<p>There's also just the argument that <code>old_structure_cmd</code> is cruft, and deserves to die. :-) The changes I made so far were surprisingly easy, hence the desire to possibly continue.</p>



<a name="256866956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256866956" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256866956">(Oct 09 2021 at 12:34)</a>:</h4>
<p>Also re: ignoring it --- the fact that there are <em>some</em> changes that need to be made after removing <code>old_structure_cmd</code> (besides just adding the extra <code>to_parent</code> projections) I'm pretty sure means those changes would be needed during the port. Hopefully by removing <code>old_structure_cmd</code> ahead of time we can make the port have fewer moving pieces.</p>



<a name="256868023"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256868023" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256868023">(Oct 09 2021 at 12:51)</a>:</h4>
<p>Maybe I am being wildly optimistic about getting alignment for <code>ring</code> without further tweaking or further cleverness in mathport.</p>



<a name="256875773"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256875773" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256875773">(Oct 09 2021 at 14:56)</a>:</h4>
<p>Which of the PRs you link above actually involve diamonds?</p>



<a name="256886547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256886547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256886547">(Oct 09 2021 at 17:48)</a>:</h4>
<blockquote>
<p>we're going to have a partially "by hand" ported mathlib, just enough to support writing essential tactics</p>
</blockquote>
<p>I wonder how realistic it is to align these classes.  There are a lot of changes in core that affect them.  For example OfNat vs. has_zero/has_one/has_add.  As a result, the mathlib4 instances are significantly different than the Lean 3 ones.  The encoding scheme for inheritance seems like the least of our worries here.</p>



<a name="256891335"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/256891335" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#256891335">(Oct 09 2021 at 19:03)</a>:</h4>
<blockquote>
<p>so we get a Ring (hand-ported) and a Ringₓ (generated by mathport).</p>
</blockquote>
<p>This is not necessarily a huge problem btw.  We can add an <code>instance [Ringₓ R] : Ring R where ...</code> and then the tactic should work.</p>



<a name="257911747"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257911747" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257911747">(Oct 17 2021 at 11:37)</a>:</h4>
<p>A consequence of removing <code>old_structure_cmd</code> comes up in <a href="https://github.com/leanprover-community/mathlib/issues/9774">#9774</a>; default field values in parent structures no longer work, meaning we need custom <code>mk'</code> constructors and have to replace something readable like <code>{ carrier := C, mul_mem' := h_mul, add_mem' := h_add,  algebra_map_mem' := h_grade0 }</code> with something less readable like <code>mk' C h_mul h_add h_grade0</code>. Are we convinced that removing <code>old_structure_cmd</code> is actually useful enough to the porting effort to justify losing readability?</p>



<a name="257911878"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257911878" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257911878">(Oct 17 2021 at 11:39)</a>:</h4>
<p>It's nothing to do with "we", right? Leo has been arguing since about 2017 that old structures are terrible for internal reasons involving horrible blow-up of term size. It took us 4 years to listen to him, but when we started having slowdowns this was diagnosed as the cause. Old structures aren't in Lean 4 and I am pretty sure that they will not be being added to Lean 4 any time soon.</p>



<a name="257911940"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257911940" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257911940">(Oct 17 2021 at 11:40)</a>:</h4>
<p>On the other hand, making cool custom constructors which can do the kind of thing which you're missing is surely well within the scope of Lean 4's fancy macro system</p>



<a name="257911941"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257911941" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257911941">(Oct 17 2021 at 11:40)</a>:</h4>
<blockquote>
<p>It took us 4 years to listen to him, but when we started having slowdowns this was diagnosed as the cause.</p>
</blockquote>
<p>Do we have any data that shows replacing structures in mathlib with new-style ones actually improves performance?</p>



<a name="257911976"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257911976" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257911976">(Oct 17 2021 at 11:41)</a>:</h4>
<p>I think Leo has ample data for him to have made this decision, and indeed he has had it since 2017.</p>



<a name="257912012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257912012" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257912012">(Oct 17 2021 at 11:41)</a>:</h4>
<blockquote>
<p>Old structures aren't in Lean 4 and I am pretty sure that they will not be being added to Lean 4 any time soon.</p>
</blockquote>
<p>But that's not really relevant, because the new structures in lean4 come with all the behavior we needed from the old structures in the first place.</p>



<a name="257912109"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257912109" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257912109">(Oct 17 2021 at 11:43)</a>:</h4>
<p>I think the fix for your issue is to make a fancy new constructor thing and not to start thinking about old structures again.</p>



<a name="257912133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257912133" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257912133">(Oct 17 2021 at 11:44)</a>:</h4>
<p><a href="https://github.com/leanprover/lean/wiki/Refactoring-structures">https://github.com/leanprover/lean/wiki/Refactoring-structures</a> is Leo's explanation</p>



<a name="257912301"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257912301" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257912301">(Oct 17 2021 at 11:46)</a>:</h4>
<p>You have seen the benefits of a super-fine-grained algebra heirarchy, indeed you have contributed to making it even more complex and this idea seems to make maths in Lean better. But Leo says that this + old structures makes complex algebra classes "monstrosities behind the scenes".</p>



<a name="257912426"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257912426" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257912426">(Oct 17 2021 at 11:48)</a>:</h4>
<p>My reading of that page is that eliminating old structures is only half the solution, the other half is redesigning the algebra heirarchy to not carry the data so that it has no diamonds</p>



<a name="257912462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257912462" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257912462">(Oct 17 2021 at 11:48)</a>:</h4>
<p>And I think the plan to do that half was abandoned long ago</p>



<a name="257952932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257952932" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257952932">(Oct 17 2021 at 22:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4/near/257912012">said</a>:</p>
<blockquote>
<blockquote>
<p>But that's not really relevant, because the new structures in lean4 come with all the behaviour we needed from the old structures in the first place.</p>
</blockquote>
</blockquote>
<p>No, this part is just not the case. The way I am removing <code>old_structure_cmd</code> at the moment is by replacing it with a rough approximation of what Lean4's new structure command will produce. It will be nicer in Lean4 --- we won't have to write out the "non-preferred parent fields" by hand, and we won't have to write the <code>to_other_parent</code> declarations ourselves, but they will be produced under the hood.</p>
<p>Thus, to a first approximation all the changes that need to be made downstream (i.e. after doing those two things) are changes that will need to be made to the library for mathlib4 in any case. Given the choice of doing it now, or doing it mid-port, when many other things are going on as well, and many things are broken, I would far prefer to get it done now.</p>
<p>It's true that <a href="https://github.com/leanprover-community/mathlib/pull/9774#discussion_r730400989">the thing Eric is annoyed about here</a> (having to write a separate constructor when you use multiple inheritance and fill in some of the preferred-parent fields using default values) will be better in Lean4 than we can currently achieve (I think?). But we can readily change this back after mathlib4 is the official version (i.e. change a few <code>subalgebra.mk'</code> back to structure literals), at very little expense compared to the peace of mind of knowing that mathlib is possible without <code>old_structure_cmd</code>.</p>



<a name="257953425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257953425" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257953425">(Oct 17 2021 at 22:21)</a>:</h4>
<p>I don't see how what you say contradicts what Eric said. We used old_structure_cmd for years because "new structures" banned diamonds, and this was not an acceptable solution. Lean 4's "newer" structure command is a hybrid that allows diamonds but is otherwise new-structure-like.</p>



<a name="257953891"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257953891" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257953891">(Oct 17 2021 at 22:29)</a>:</h4>
<p>It is not clear to me that performing a mathlib refactor to remove old_structure_cmd is necessarily all that helpful for the port. It is good to know if the refactor will hit any major roadblocks, so doing the exploration now is fine, but actually <em>applying</em> the refactor might be counterproductive for synport, since it would prefer to see actual structure instance syntax rather than <code>foo.mk'</code>, and similarly for <code>extends</code> in structures.</p>



<a name="257959650"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257959650" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257959650">(Oct 18 2021 at 00:06)</a>:</h4>
<p>Okay -- but these refactors (unlike the earlier ones) are resulting in lots of changes downstream being required. We really don't want to have to be making those changes "mid-port".</p>



<a name="257959787"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257959787" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257959787">(Oct 18 2021 at 00:09)</a>:</h4>
<p>Further, the experiments only work step by step. I can only remove <code>old_structure_cmd</code> from something once its has been removed from all descendants. I can't really keep going unless we actually apply the earlier stages.</p>



<a name="257959923"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257959923" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257959923">(Oct 18 2021 at 00:11)</a>:</h4>
<p>Could we think about how to remove uses of <code>old_structure_cmd</code>, but to leave some indication (just the <code>@[ancestor]</code> attribute?) so that synport can automatically write new structure commands? </p>
<p>This had seemed to me like unnecessary extra work in synport: my thought had just been to do the translation from "by hand newer structures" to "actual newer structures" as a late step in the port, by hand. But we could also automate it.</p>



<a name="257960035"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257960035" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257960035">(Oct 18 2021 at 00:13)</a>:</h4>
<p>But really my main point is just the above: changing from old structures to newer ones is not completely trivial, and already we're going to have a million things broken in the output of synport, and I think if we can make changes ahead of time we should.</p>



<a name="257992948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257992948" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257992948">(Oct 18 2021 at 08:21)</a>:</h4>
<p>I agree with Mario.  For synport it would be better to have "idiomatic Lean 3", because that is most likely to map to idiomatic Lean 4.  If you don't look under the hood, the Lean 3 old_structure_cmd and Lean 4's structure command behave very similarly.  (The only real difference I can think of is how the cases tactic behaves, but maybe we should change that in Lean 4 instead.)</p>



<a name="257996363"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257996363" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257996363">(Oct 18 2021 at 08:54)</a>:</h4>
<p>Okay! We'll give it a go that way, I guess. :-) I remain pretty worried about how much stuff is going to be broken even with the most optimistic view of what synport can achieve, but we'll get there somehow.</p>



<a name="257996676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257996676" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257996676">(Oct 18 2021 at 08:56)</a>:</h4>
<p>I have some PRs <a href="https://github.com/leanprover-community/mathlib/issues/9719">#9719</a> <a href="https://github.com/leanprover-community/mathlib/issues/9739">#9739</a> <a href="https://github.com/leanprover-community/mathlib/issues/9748">#9748</a> that remove one or two <code>old_structure_cmd</code>, but only incidentally (really they are about making <code>domain</code> and <code>integral_domain</code> mixins, and in fact combining them into a single <code>is_domain</code>). They'll stay on the queue, but <a href="https://github.com/leanprover-community/mathlib/issues/9774">#9774</a> can be abandoned.</p>



<a name="257996926"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257996926" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257996926">(Oct 18 2021 at 08:59)</a>:</h4>
<p>There is still a big difference that, in Lean 4, we will need to choose a preferred parent for the data fields, right? And this choice should be made with conscious design decisions, because this will have an impact performancewise. Currently, there is no way synport will have this kind of information available.</p>



<a name="257997155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257997155" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257997155">(Oct 18 2021 at 09:00)</a>:</h4>
<p>But it does?  Synport can just write the extends clause in the same order.</p>



<a name="257997222"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257997222" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257997222">(Oct 18 2021 at 09:01)</a>:</h4>
<p>And hopefully the performance impact isn't any worse than old structures to begin with, so this could be optimized after porting</p>



<a name="257997457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257997457" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257997457">(Oct 18 2021 at 09:03)</a>:</h4>
<p>What if you have <code>foo</code> with fields <code>A, B, C</code> and <code>bar</code> with fields <code>A, B, D</code>, and you want a class extending <code>foo</code> and <code>bar</code> to pick <code>A, C</code> from <code>foo</code> and <code>B, D</code> from <code>bar</code>? (This is the kind of stuff that you see all the time in the algebraic hierarchy).</p>



<a name="257997650"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257997650" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257997650">(Oct 18 2021 at 09:05)</a>:</h4>
<p>With the lean 4 structure command, you get <code>foo</code> as preferred parent and <code>D</code> as a mixin from <code>bar</code>; I don't know what it would mean to pick <code>A, C</code> from <code>foo</code> and <code>B, D</code> from <code>bar</code></p>



<a name="257997715"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257997715" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257997715">(Oct 18 2021 at 09:05)</a>:</h4>
<p>in lean 3 old structures you always merge all common fields, so there is no half and half thing</p>



<a name="257997819"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257997819" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257997819">(Oct 18 2021 at 09:06)</a>:</h4>
<p>i.e. you get one class with <code>A, B, C, D</code> and the forgetful functors to <code>foo</code> and <code>bar</code> do the obvious thing</p>



<a name="257997900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/old_structure_cmd%20and%20mathlib4/near/257997900" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/old_structure_cmd.20and.20mathlib4.html#257997900">(Oct 18 2021 at 09:07)</a>:</h4>
<p>There is no constructor that takes a complete <code>foo</code> and a complete <code>bar</code> and mixes and matches fields; this would almost certainly lead to type errors due to the existence of non-defeq <code>foo.A</code> and <code>bar.A</code> in the context</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>