---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113488-general/index.html">general</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html">app builder exception, caused by `subst`</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="192116230"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116230" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116230">(Mar 28 2020 at 10:18)</a>:</h4>
<p>Has anyone seen the error</p>
<div class="codehilite"><pre><span></span>app_builder_exception, more information can be obtained using command `set_option trace.app_builder true`
</pre></div>


<p>and then with <code>trace_app_builder</code></p>
<div class="codehilite"><pre><span></span>[app_builder] failed to build eq.rec, invalid motive:
λ (r : ↥R), ↥S
</pre></div>


<p>This being caused by a call to <code>subst z</code>, where </p>
<div class="codehilite"><pre><span></span>R S : Ring,
r : ↥R,
r_1 : (forget Ring).obj S,
z : r = ⇑(equiv.symm (iso.to_equiv (map_iso (forget Ring).obj i))) r_1
</pre></div>



<a name="192116235"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116235" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116235">(Mar 28 2020 at 10:18)</a>:</h4>
<p>I'm not really sure what problem I should be looking for.</p>



<a name="192116413"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116413" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116413">(Mar 28 2020 at 10:23)</a>:</h4>
<p>what is the goal?</p>



<a name="192116415"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116415" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116415">(Mar 28 2020 at 10:23)</a>:</h4>
<p>pp.all please</p>



<a name="192116483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116483">(Mar 28 2020 at 10:25)</a>:</h4>
<p>one sec, there's a duplicated variable name, let me get rid of that</p>



<a name="192116553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116553">(Mar 28 2020 at 10:27)</a>:</h4>
<p><a href="https://gist.github.com/semorrison/a3c3c46a1b260fc04387c5492bca96d2" title="https://gist.github.com/semorrison/a3c3c46a1b260fc04387c5492bca96d2">https://gist.github.com/semorrison/a3c3c46a1b260fc04387c5492bca96d2</a></p>



<a name="192116566"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116566" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116566">(Mar 28 2020 at 10:27)</a>:</h4>
<p>without <code>pp.all</code> the state is</p>
<div class="codehilite"><pre><span></span>app_builder_exception, more information can be obtained using command `set_option trace.app_builder true`
state:
R S : Ring,
i : R ≅ S,
r : ↥R,
x : (forget Ring).obj S,
z : r = ⇑(equiv.symm (iso.to_equiv (map_iso (forget Ring).obj i))) x
⊢ ↥S
</pre></div>


<p>and we're calling <code>subst z</code>.</p>



<a name="192116632"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116632" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116632">(Mar 28 2020 at 10:29)</a>:</h4>
<p>I also want to see that invalid motive with pp.all</p>



<a name="192116752"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116752" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116752">(Mar 28 2020 at 10:32)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="o">[</span><span class="n">app_builder</span><span class="o">]</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">build</span> <span class="n">eq</span><span class="bp">.</span><span class="n">rec</span><span class="o">,</span> <span class="n">invalid</span> <span class="n">motive</span><span class="o">:</span>
<span class="bp">λ</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="bp">@</span><span class="n">coe_sort</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="bp">+</span><span class="mi">2</span> <span class="n">u</span><span class="bp">+</span><span class="mi">2</span><span class="o">}</span> <span class="n">Ring</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">Ring</span><span class="bp">.</span><span class="n">has_coe_to_sort</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span><span class="o">),</span>
  <span class="bp">@</span><span class="n">coe_sort</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="bp">+</span><span class="mi">2</span> <span class="n">u</span><span class="bp">+</span><span class="mi">2</span><span class="o">}</span> <span class="n">Ring</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">Ring</span><span class="bp">.</span><span class="n">has_coe_to_sort</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">S</span>
</pre></div>



<a name="192116756"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116756" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116756">(Mar 28 2020 at 10:32)</a>:</h4>
<p>seems harmless to me?</p>



<a name="192116775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116775">(Mar 28 2020 at 10:33)</a>:</h4>
<p>Oh, I just checked the code and that term is supposed to be a pi type</p>



<a name="192116814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116814">(Mar 28 2020 at 10:34)</a>:</h4>
<p>it gives that error because it's a lambda instead</p>



<a name="192116824"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116824" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116824">(Mar 28 2020 at 10:34)</a>:</h4>
<p>wait, scratch that, it infers the type and makes sure that is a pi type which is a sort</p>



<a name="192116835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116835" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116835">(Mar 28 2020 at 10:35)</a>:</h4>
<p>I think I see how this is going wrong</p>



<a name="192116839"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116839" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116839">(Mar 28 2020 at 10:35)</a>:</h4>
<p>what is the type of that term?</p>



<a name="192116929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116929">(Mar 28 2020 at 10:37)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">category</span><span class="bp">.</span><span class="n">CommRing</span><span class="bp">.</span><span class="n">basic</span>
<span class="n">universes</span> <span class="n">u</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">R</span> <span class="n">S</span> <span class="o">:</span> <span class="n">Ring</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">})</span>
<span class="bp">#</span><span class="kn">check</span>
  <span class="bp">λ</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="bp">@</span><span class="n">coe_sort</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="bp">+</span><span class="mi">2</span> <span class="n">u</span><span class="bp">+</span><span class="mi">2</span><span class="o">}</span> <span class="n">Ring</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">Ring</span><span class="bp">.</span><span class="n">has_coe_to_sort</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">R</span><span class="o">),</span>
  <span class="bp">@</span><span class="n">coe_sort</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="bp">+</span><span class="mi">2</span> <span class="n">u</span><span class="bp">+</span><span class="mi">2</span><span class="o">}</span> <span class="n">Ring</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">Ring</span><span class="bp">.</span><span class="n">has_coe_to_sort</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="n">S</span>
<span class="c1">-- λ (r : ↥R), ↥S : ↥R → has_coe_to_sort.S Ring</span>
</pre></div>



<a name="192116985"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192116985" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192116985">(Mar 28 2020 at 10:39)</a>:</h4>
<p><code>has_coe_to_sort.S Ring</code> is defeq to <code>Sort u</code> but subst isn't trying hard enough to find that out</p>



<a name="192155160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192155160" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192155160">(Mar 29 2020 at 04:04)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span>, is there some simplification that I could do beforehand that might help <code>subst</code>? Or I'm I going to have to look into the implementation of <code>subst_core</code>?</p>



<a name="192155193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192155193" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192155193">(Mar 29 2020 at 04:05)</a>:</h4>
<p>a quick fix might be to use <code>cases</code> or <code>rw</code> instead of <code>subst</code></p>



<a name="192155292"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192155292" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192155292">(Mar 29 2020 at 04:08)</a>:</h4>
<p>Oh, actually the way it's written it doesn't even try to reduce the expression before matching it against <code>Sort u</code>. That's definitely a bug, it should <code>whnf</code> the thing first</p>



<a name="192155409"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192155409" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192155409">(Mar 29 2020 at 04:13)</a>:</h4>
<p><a href="https://github.com/leanprover-community/lean/pull/165" title="https://github.com/leanprover-community/lean/pull/165">https://github.com/leanprover-community/lean/pull/165</a></p>



<a name="192155679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192155679" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192155679">(Mar 29 2020 at 04:22)</a>:</h4>
<p>Awesome :-)</p>



<a name="192155692"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192155692" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192155692">(Mar 29 2020 at 04:22)</a>:</h4>
<p>Now I need to remember how to run against a branch of lean. I will try this out asap.</p>



<a name="192155838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/app%20builder%20exception%2C%20caused%20by%20%60subst%60/near/192155838" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113488-general/topic/app.20builder.20exception.2C.20caused.20by.20.60subst.60.html#192155838">(Mar 29 2020 at 04:27)</a>:</h4>
<p>hmm, less easy than I hoped :-)</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>