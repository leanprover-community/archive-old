---
layout: archive
title: Zulip Chat Archive
permalink: /stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/index.html">Program verification</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html">RISC-V ISA in Lean</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="212017762"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212017762" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212017762">(Oct 02 2020 at 06:38)</a>:</h4>
<p>(Migrating from 'Is there code for X?" "bidirectional maps?" = <a href="#narrow/stream/217875-Is-there.20code.20for.20X.3F/topic/bidirectional.20maps.3F/near/212013731">https://leanprover.zulipchat.com/#narrow/stream/217875-Is-there.20code.20for.20X.3F/topic/bidirectional.20maps.3F/near/212013731</a>) <span class="user-mention" data-user-id="110049">@Mario Carneiro</span></p>



<a name="212039897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212039897" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212039897">(Oct 02 2020 at 07:18)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Can you explain why you're using inductive Props in your x86.lean?</p>



<a name="212039906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212039906" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212039906">(Oct 02 2020 at 07:18)</a>:</h4>
<p>because it's a spec</p>



<a name="212039918"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212039918" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212039918">(Oct 02 2020 at 07:18)</a>:</h4>
<p>it's not intended to be directly executable</p>



<a name="212039930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212039930" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212039930">(Oct 02 2020 at 07:18)</a>:</h4>
<p>but the advantage is that you don't need separate encode/decode</p>



<a name="212040466"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212040466" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212040466">(Oct 02 2020 at 07:26)</a>:</h4>
<p>Hmm. Not something I can use then.</p>



<a name="212040504"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212040504" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212040504">(Oct 02 2020 at 07:26)</a>:</h4>
<p>No, I don't expect that aspect will translate</p>



<a name="212040559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212040559" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212040559">(Oct 02 2020 at 07:27)</a>:</h4>
<p>I wrote a proof producing disassembler for x86/ARM before which is closer to what you need, but it is at least for now closed source</p>



<a name="212040724"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212040724" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212040724">(Oct 02 2020 at 07:29)</a>:</h4>
<p>Okay.</p>



<a name="212040886"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212040886" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212040886">(Oct 02 2020 at 07:31)</a>:</h4>
<p>I've heard good things about metaprogramming in Lean but ... the documentation doesn't demonstrate how. Do you have any reference I can use for implementing <code>make_defs</code>? <a href="https://leanprover.github.io/reference/metaprogramming.html">https://leanprover.github.io/reference/metaprogramming.html</a></p>



<a name="212041186"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212041186" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212041186">(Oct 02 2020 at 07:34)</a>:</h4>
<p>for the most part it's just functional programming</p>



<a name="212041200"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212041200" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212041200">(Oct 02 2020 at 07:34)</a>:</h4>
<p>you have to interact with the lean API to make definitions</p>



<a name="212041236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212041236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212041236">(Oct 02 2020 at 07:34)</a>:</h4>
<p>and the API is admittedly not so well documented</p>



<a name="212041265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212041265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212041265">(Oct 02 2020 at 07:35)</a>:</h4>
<p>Rob Lewis made a metaprogramming tutorial that is pretty good</p>



<a name="212041303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212041303" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212041303">(Oct 02 2020 at 07:35)</a>:</h4>
<p><a href="https://www.youtube.com/playlist?list=PLlF-CfQhukNnq2kDCw2P_vI5AfXN7egP2">https://www.youtube.com/playlist?list=PLlF-CfQhukNnq2kDCw2P_vI5AfXN7egP2</a></p>



<a name="212041383"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212041383" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212041383">(Oct 02 2020 at 07:36)</a>:</h4>
<p>Thanks. I'll watch the series.</p>



<a name="212062203"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212062203" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212062203">(Oct 02 2020 at 11:31)</a>:</h4>
<p>There's also the metaprogramming section of the <a href="https://raw.githubusercontent.com/blanchette/logical_verification_2020/master/hitchhikers_guide.pdf">Hitchhiker's guide</a> and, if I may be so bold, my <a href="https://limperg.de/posts/2020-08-19-lean-metaprogramming.html">blog post</a> on some gotchas of the API (but that'll only make sense once you have a bit of an overview). Beyond that, you'll have to read <code>init/meta/expr.lean</code> and <code>init/meta/tactic.lean</code>, which are reasonably documented.</p>



<a name="212070231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212070231" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212070231">(Oct 02 2020 at 12:57)</a>:</h4>
<p>Okay. I've watched the short series linked above and bookmarked the blog post. I've adjusted the python scripts to generate at least a decent mostly-correct subset of RISC-V instruction to format with embedded constants list. <code>add_inductive</code> and <code>add_defn_equations</code> appear to be my next steps, which look straight forward. Afterwards, I may open an issue in the riscv-opcode repo proposing an alternative format and a new code generator to make certain things cleaner and better reflect the specification.</p>
<p>Thanks for all the links everyone. I'll resume this tomorrow morning. :)</p>



<a name="212077159"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/212077159" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#212077159">(Oct 02 2020 at 13:52)</a>:</h4>
<p>Okay, I couldn't resist but... ouch. <code>add_inductive</code>, as the documentation for its sibling <code>add_ginductive</code> suggests, doesn't generate the auxiliary definitions necessary for matching against it... I couldn't figure out how to use <code>add_ginductive</code> however. Could someone correct this code?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">make_defs</span> <span class="o">(</span><span class="n">l</span> <span class="o">:</span> <span class="n">list</span> <span class="o">(</span><span class="n">name</span> <span class="bp">×</span> <span class="n">type</span><span class="o">))</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="n">tactic.add_inductive</span> <span class="bp">`</span><span class="n">rvim</span> <span class="o">[]</span> <span class="mi">0</span> <span class="bp">`</span><span class="o">(</span><span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">l.map</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">⟨</span><span class="n">n</span><span class="o">,</span> <span class="n">t</span><span class="o">⟩,</span> <span class="o">⟨</span><span class="n">n</span><span class="o">,</span> <span class="n">expr.const</span> <span class="bp">`</span><span class="n">rvim</span> <span class="o">[]⟩))</span>
</code></pre></div>



<a name="213000987"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213000987" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213000987">(Oct 12 2020 at 06:11)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Any insight on this issue?</p>



<a name="213001421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213001421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213001421">(Oct 12 2020 at 06:20)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">make_defs'</span> <span class="o">(</span><span class="n">l</span> <span class="o">:</span> <span class="n">list</span> <span class="o">(</span><span class="n">name</span> <span class="bp">×</span> <span class="n">type</span><span class="o">))</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="k">do</span> <span class="n">env</span> <span class="bp">←</span> <span class="n">tactic.get_env</span><span class="o">,</span>
  <span class="n">env'</span> <span class="bp">←</span> <span class="n">env.add_ginductive</span> <span class="n">options.mk</span>
    <span class="o">[]</span> <span class="o">[]</span> <span class="o">[((</span><span class="bp">`</span><span class="n">rvim'</span><span class="o">,</span> <span class="bp">`</span><span class="o">(</span><span class="kt">Type</span><span class="o">)),</span>
      <span class="n">l.map</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">⟨</span><span class="n">n</span><span class="o">,</span> <span class="n">t</span><span class="o">⟩,</span>
        <span class="o">{</span> <span class="n">constr</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">rvim'</span> <span class="bp">++</span> <span class="n">n</span><span class="o">,</span>
          <span class="n">type</span> <span class="o">:=</span> <span class="n">expr.const</span> <span class="bp">`</span><span class="n">rvim'</span> <span class="o">[]</span> <span class="o">}))]</span>
    <span class="n">ff</span><span class="o">,</span>
  <span class="n">tactic.set_env</span> <span class="n">env'</span>

<span class="kd">run_cmd</span> <span class="n">make_defs'</span> <span class="o">[(</span><span class="bp">`</span><span class="n">a</span><span class="o">,</span> <span class="o">()),</span> <span class="o">(</span><span class="bp">`</span><span class="n">b</span><span class="o">,</span> <span class="o">())]</span>
<span class="k">#print</span> <span class="n">rvim'</span>
</code></pre></div>



<a name="213001694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213001694" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213001694">(Oct 12 2020 at 06:25)</a>:</h4>
<p>There we go, thanks again!</p>



<a name="213001799"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213001799" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213001799">(Oct 12 2020 at 06:27)</a>:</h4>
<p>Note that I changed your code a bit to prefix <code>rvim</code> on the names of the constructors. Lean will let you name the constructors something else, but the front end <code>inductive</code> command doesn't, so it seems ill-advised</p>



<a name="213002765"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213002765" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213002765">(Oct 12 2020 at 06:47)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span>  Noticed. Though now I'm stuck trying to control the types of the constructors. As these need the registers and immediate values. I was expecting something like <code>type := `(nat -&gt; `rvim)</code> to work. But that says "invalid return type". As it does with just <code> `(`rvim)</code>.</p>



<a name="213002819"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213002819" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213002819">(Oct 12 2020 at 06:48)</a>:</h4>
<p><code>rvim</code> needs to be a local constant</p>



<a name="213002871"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213002871" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213002871">(Oct 12 2020 at 06:49)</a>:</h4>
<p>Like <code>let rvim := `rvim in `(rvim)</code>?</p>



<a name="213002975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213002975" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213002975">(Oct 12 2020 at 06:50)</a>:</h4>
<p>Or <code> let rvim := @expr.const ff `rvim [] in `(rvim) </code>? Neither worked.</p>



<a name="213003000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003000">(Oct 12 2020 at 06:51)</a>:</h4>
<p>The tricky part is that <code>rvim</code> doesn't exist yet, so <code>`(rvim)</code> isn't going to work</p>



<a name="213003014"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003014" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003014">(Oct 12 2020 at 06:51)</a>:</h4>
<p>You can use <code>let rvim : expr := expr.const `rvim' [],</code> and then splice it in</p>



<a name="213003025"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003025" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003025">(Oct 12 2020 at 06:51)</a>:</h4>
<p>i.e. <code>`((%%rvim : Type) → (%%rvim : Type))</code></p>



<a name="213003100"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003100" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003100">(Oct 12 2020 at 06:52)</a>:</h4>
<p>actually, it seems it should be a constant not a local constant</p>



<a name="213003109"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003109" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003109">(Oct 12 2020 at 06:53)</a>:</h4>
<p>which is extra tricky because that definitely doesn't typecheck</p>



<a name="213003124"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003124" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003124">(Oct 12 2020 at 06:53)</a>:</h4>
<p>Well, this worked. <code>let rvim : expr := expr.const `rvim [] in `(nat -&gt; (%%rvim : Type))</code></p>



<a name="213003129"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003129" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003129">(Oct 12 2020 at 06:53)</a>:</h4>
<p>I think the usual approach if you need more advanced inference would be to create a new local constant with the appropriate type, and then substitute the constant for it at the end</p>



<a name="213003701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003701">(Oct 12 2020 at 07:03)</a>:</h4>
<p>Okay, I have <code>rvim</code> expanded with the correct number of natural arguments for each instruction. :)</p>



<a name="213003718"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003718" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003718">(Oct 12 2020 at 07:03)</a>:</h4>
<p>But it is getting slow... which is worrying considering how early this is still.</p>



<a name="213003832"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003832" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003832">(Oct 12 2020 at 07:05)</a>:</h4>
<p>What is the vscodium trick to expand all the variants on a def? <code>def q : rvim -&gt; nat := _</code></p>



<a name="213003882"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003882" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003882">(Oct 12 2020 at 07:06)</a>:</h4>
<p>I thought it was under ctrl+dot with the _ in focus. But that doesn't include the option for some reason.</p>



<a name="213003922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213003922" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213003922">(Oct 12 2020 at 07:07)</a>:</h4>
<p>I've seen a different method on a video</p>



<a name="213004135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213004135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213004135">(Oct 12 2020 at 07:11)</a>:</h4>
<p>Video used <code>{! x -&gt; y}</code> and that worked. I guess the language server just has a hole..</p>



<a name="213004598"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213004598" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213004598">(Oct 12 2020 at 07:17)</a>:</h4>
<p>processing new inductives is a little sluggish, especially if you are using nested or mutual inductives</p>



<a name="213004739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213004739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213004739">(Oct 12 2020 at 07:19)</a>:</h4>
<p>You can double check if you have accidentally defined a nested inductive because if you <code>#print rvim</code> it will say <code>def rvim := .. </code> instead of <code>inductive rvim ...</code></p>



<a name="213004812"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213004812" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213004812">(Oct 12 2020 at 07:20)</a>:</h4>
<p>It says inductive.</p>



<a name="213004835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213004835" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213004835">(Oct 12 2020 at 07:20)</a>:</h4>
<p>how many variants are we talking here?</p>



<a name="213004917"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213004917" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213004917">(Oct 12 2020 at 07:21)</a>:</h4>
<p>I have 63 instructions.</p>



<a name="213005008"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213005008" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213005008">(Oct 12 2020 at 07:23)</a>:</h4>
<p>hm, I wonder whether <code>no_confusion</code> is as expensive as I suspected</p>



<a name="213005041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213005041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213005041">(Oct 12 2020 at 07:23)</a>:</h4>
<p>it's basically quadratic in size</p>



<a name="213005043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213005043" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213005043">(Oct 12 2020 at 07:23)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">fmt</span> <span class="o">:</span> <span class="kt">Type</span>
<span class="bp">|</span> <span class="n">R</span>     <span class="o">(</span><span class="n">opcode7</span> <span class="n">funct3</span> <span class="n">funct7</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="c1">-- (rd rs1 rs2     : nat)</span>
<span class="bp">|</span> <span class="n">I</span>     <span class="o">(</span><span class="n">opcode7</span> <span class="n">funct3</span>        <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="c1">-- (rd rs1     imm : nat)</span>
<span class="bp">|</span> <span class="n">ISH</span>   <span class="o">(</span><span class="n">opcode7</span> <span class="n">funct3</span> <span class="n">funct7</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="c1">-- (rd rs1     imm : nat)</span>
<span class="bp">|</span> <span class="n">ISHW</span>  <span class="o">(</span><span class="n">opcode7</span> <span class="n">funct3</span> <span class="n">funct7</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="c1">-- (rd rs1     imm : nat)</span>
<span class="bp">|</span> <span class="n">S</span>     <span class="o">(</span><span class="n">opcode7</span> <span class="n">funct3</span>        <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="c1">-- (   rs1 rs2 imm : nat)</span>
<span class="bp">|</span> <span class="n">B</span>     <span class="o">(</span><span class="n">opcode7</span> <span class="n">funct3</span>        <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="c1">-- (   rs1 rs2 imm : nat)</span>
<span class="bp">|</span> <span class="n">U</span>     <span class="o">(</span><span class="n">opcode7</span>               <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="c1">-- (rd         imm : nat)</span>
<span class="bp">|</span> <span class="n">J</span>     <span class="o">(</span><span class="n">opcode7</span>               <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="c1">-- (rd         imm : nat)</span>
<span class="bp">|</span> <span class="n">FENCE</span> <span class="o">(</span><span class="n">opcode7</span>               <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>

<span class="kd">meta</span> <span class="kd">def</span> <span class="n">make_defs</span> <span class="o">(</span><span class="n">l</span> <span class="o">:</span> <span class="n">list</span> <span class="o">(</span><span class="n">name</span> <span class="bp">×</span> <span class="n">fmt</span><span class="o">))</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
  <span class="n">tactic.updateex_env</span> <span class="bp">$</span> <span class="bp">λ</span> <span class="n">env</span><span class="o">,</span> <span class="n">env.add_ginductive</span> <span class="n">options.mk</span>
    <span class="o">[]</span> <span class="o">[]</span> <span class="o">[(</span>
      <span class="o">(</span><span class="bp">`</span><span class="n">rvim</span><span class="o">,</span> <span class="bp">`</span><span class="o">(</span><span class="kt">Type</span><span class="o">)),</span>
      <span class="n">l.map</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">⟨</span><span class="n">n</span><span class="o">,</span> <span class="n">t</span><span class="o">⟩,</span>
        <span class="o">{</span> <span class="n">constr</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">rvim</span> <span class="bp">++</span> <span class="n">n</span><span class="o">,</span>
          <span class="n">type</span> <span class="o">:=</span> <span class="k">let</span> <span class="n">rvim</span> <span class="o">:</span> <span class="n">expr</span> <span class="o">:=</span> <span class="n">expr.const</span> <span class="bp">`</span><span class="n">rvim</span> <span class="o">[]</span> <span class="k">in</span>
                  <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
                  <span class="bp">|</span> <span class="o">(</span><span class="n">fmt.R</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">`</span><span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="o">(</span><span class="bp">%%</span><span class="n">rvim</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">))</span>
                  <span class="bp">|</span> <span class="o">(</span><span class="n">fmt.I</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">`</span><span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="o">(</span><span class="bp">%%</span><span class="n">rvim</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">))</span>
                  <span class="bp">|</span> <span class="o">(</span><span class="n">fmt.ISH</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">`</span><span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="o">(</span><span class="bp">%%</span><span class="n">rvim</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">))</span>
                  <span class="bp">|</span> <span class="o">(</span><span class="n">fmt.ISHW</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">`</span><span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="o">(</span><span class="bp">%%</span><span class="n">rvim</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">))</span>
                  <span class="bp">|</span> <span class="o">(</span><span class="n">fmt.S</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">`</span><span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="o">(</span><span class="bp">%%</span><span class="n">rvim</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">))</span>
                  <span class="bp">|</span> <span class="o">(</span><span class="n">fmt.B</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">`</span><span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="o">(</span><span class="bp">%%</span><span class="n">rvim</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">))</span>
                  <span class="bp">|</span> <span class="o">(</span><span class="n">fmt.U</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">`</span><span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="o">(</span><span class="bp">%%</span><span class="n">rvim</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">))</span>
                  <span class="bp">|</span> <span class="o">(</span><span class="n">fmt.J</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">`</span><span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">nat</span> <span class="bp">-&gt;</span> <span class="o">(</span><span class="bp">%%</span><span class="n">rvim</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">))</span>
                  <span class="bp">|</span> <span class="o">(</span><span class="n">fmt.FENCE</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">`</span><span class="o">((</span><span class="bp">%%</span><span class="n">rvim</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">))</span>
                  <span class="kd">end</span>
        <span class="o">}</span>
      <span class="o">)</span>
    <span class="o">)]</span>
  <span class="n">ff</span>

<span class="kn">open</span> <span class="n">fmt</span>

<span class="c1">-- rv{32,64}[im] sans pseudo instructions</span>
<span class="kd">run_cmd</span> <span class="n">make_defs</span> <span class="o">[</span>
<span class="c1">--#eval list.length [</span>
  <span class="c1">-- rv32i</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">BEQ</span><span class="o">,</span>        <span class="n">B</span>    <span class="mi">0b1100011</span> <span class="mi">0b000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">BNE</span><span class="o">,</span>        <span class="n">B</span>    <span class="mi">0b1100011</span> <span class="mi">0b001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">BLT</span><span class="o">,</span>        <span class="n">B</span>    <span class="mi">0b1100011</span> <span class="mi">0b100</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">BGE</span><span class="o">,</span>        <span class="n">B</span>    <span class="mi">0b1100011</span> <span class="mi">0b101</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">BLTU</span><span class="o">,</span>       <span class="n">B</span>    <span class="mi">0b1100011</span> <span class="mi">0b110</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">BGEU</span><span class="o">,</span>       <span class="n">B</span>    <span class="mi">0b1100011</span> <span class="mi">0b111</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">JALR</span><span class="o">,</span>       <span class="n">I</span>    <span class="mi">0b1100111</span> <span class="mi">0b000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">JAL</span><span class="o">,</span>        <span class="n">J</span>    <span class="mi">0b1101111</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">LUI</span><span class="o">,</span>        <span class="n">U</span>    <span class="mi">0b0110111</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">AUIPC</span><span class="o">,</span>      <span class="n">U</span>    <span class="mi">0b0010111</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">ADDI</span><span class="o">,</span>       <span class="n">I</span>    <span class="mi">0b0010011</span> <span class="mi">0b000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SLLI</span><span class="o">,</span>       <span class="n">ISH</span>  <span class="mi">0b0010011</span> <span class="mi">0b001</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SLTI</span><span class="o">,</span>       <span class="n">I</span>    <span class="mi">0b0010011</span> <span class="mi">0b010</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SLTIU</span><span class="o">,</span>      <span class="n">I</span>    <span class="mi">0b0010011</span> <span class="mi">0b011</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">XORI</span><span class="o">,</span>       <span class="n">I</span>    <span class="mi">0b0010011</span> <span class="mi">0b100</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SRLI</span><span class="o">,</span>       <span class="n">ISH</span>  <span class="mi">0b0010011</span> <span class="mi">0b101</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SRAI</span><span class="o">,</span>       <span class="n">ISH</span>  <span class="mi">0b0010011</span> <span class="mi">0b101</span> <span class="mi">0b0100000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">ORI</span><span class="o">,</span>        <span class="n">I</span>    <span class="mi">0b0010011</span> <span class="mi">0b110</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">ANDI</span><span class="o">,</span>       <span class="n">I</span>    <span class="mi">0b0010011</span> <span class="mi">0b111</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">ADD</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b000</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SUB</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b000</span> <span class="mi">0b0100000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SLL</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b001</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SLT</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b010</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SLTU</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b011</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">XOR</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b100</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SRL</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b101</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SRA</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b101</span> <span class="mi">0b0100000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">OR</span><span class="o">,</span>         <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b110</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">AND</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b111</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">LB</span><span class="o">,</span>         <span class="n">I</span>    <span class="mi">0b0000011</span> <span class="mi">0b000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">LH</span><span class="o">,</span>         <span class="n">I</span>    <span class="mi">0b0000011</span> <span class="mi">0b001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">LW</span><span class="o">,</span>         <span class="n">I</span>    <span class="mi">0b0000011</span> <span class="mi">0b010</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">LBU</span><span class="o">,</span>        <span class="n">I</span>    <span class="mi">0b0000011</span> <span class="mi">0b100</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">LHU</span><span class="o">,</span>        <span class="n">I</span>    <span class="mi">0b0000011</span> <span class="mi">0b101</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SB</span><span class="o">,</span>         <span class="n">S</span>    <span class="mi">0b0100011</span> <span class="mi">0b000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SH</span><span class="o">,</span>         <span class="n">S</span>    <span class="mi">0b0100011</span> <span class="mi">0b001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SW</span><span class="o">,</span>         <span class="n">S</span>    <span class="mi">0b0100011</span> <span class="mi">0b010</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">FENCE</span><span class="o">,</span>      <span class="n">I</span>    <span class="mi">0b0001111</span> <span class="mi">0b000</span><span class="o">),</span>
  <span class="c1">-- FENCEI belongs in Zifencei... why is it here?</span>
  <span class="c1">-- (`FENCE_I,    I    0b0001111 0b001),</span>
  <span class="c1">-- Shouldn't we have ECALL and EBREAK?</span>
  <span class="c1">-- rv32m</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">MUL</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b000</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">MULH</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b001</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">MULHSU</span><span class="o">,</span>     <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b010</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">MULHU</span><span class="o">,</span>      <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b011</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">DIV</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b100</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">DIVU</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b101</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">REM</span><span class="o">,</span>        <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b110</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">REMU</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0110011</span> <span class="mi">0b111</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="c1">-- rv64i</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">ADDIW</span><span class="o">,</span>      <span class="n">I</span>    <span class="mi">0b0011011</span> <span class="mi">0b000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SLLIW</span><span class="o">,</span>      <span class="n">ISHW</span> <span class="mi">0b0011011</span> <span class="mi">0b001</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SRLIW</span><span class="o">,</span>      <span class="n">ISHW</span> <span class="mi">0b0011011</span> <span class="mi">0b101</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SRAIW</span><span class="o">,</span>      <span class="n">ISHW</span> <span class="mi">0b0011011</span> <span class="mi">0b101</span> <span class="mi">0b0100000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">ADDW</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0111011</span> <span class="mi">0b000</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SUBW</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0111011</span> <span class="mi">0b000</span> <span class="mi">0b0100000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SLLW</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0111011</span> <span class="mi">0b001</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SRLW</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0111011</span> <span class="mi">0b101</span> <span class="mi">0b0000000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SRAW</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0111011</span> <span class="mi">0b101</span> <span class="mi">0b0100000</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">LD</span><span class="o">,</span>         <span class="n">I</span>    <span class="mi">0b0000011</span> <span class="mi">0b011</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">LWU</span><span class="o">,</span>        <span class="n">I</span>    <span class="mi">0b0000011</span> <span class="mi">0b110</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">SD</span><span class="o">,</span>         <span class="n">S</span>    <span class="mi">0b0100011</span> <span class="mi">0b011</span><span class="o">),</span>
  <span class="c1">-- rv64m</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">MULW</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0111011</span> <span class="mi">0b000</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">DIVW</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0111011</span> <span class="mi">0b100</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">DIVUW</span><span class="o">,</span>      <span class="n">R</span>    <span class="mi">0b0111011</span> <span class="mi">0b101</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">REMW</span><span class="o">,</span>       <span class="n">R</span>    <span class="mi">0b0111011</span> <span class="mi">0b110</span> <span class="mi">0b0000001</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">`</span><span class="n">REMUW</span><span class="o">,</span>      <span class="n">R</span>    <span class="mi">0b0111011</span> <span class="mi">0b111</span> <span class="mi">0b0000001</span><span class="o">)</span>
<span class="o">]</span>

<span class="kd">def</span> <span class="n">is_16_bit_instruction</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span>
<span class="n">n.land</span> <span class="mi">0b11</span> <span class="bp">≠</span> <span class="mi">0b11</span>

<span class="kd">def</span> <span class="n">is_32_bit_instruction</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span>
<span class="n">n.land</span> <span class="mi">0b11</span> <span class="bp">=</span> <span class="mi">0b11</span> <span class="bp">∧</span> <span class="n">n.land</span> <span class="mi">0b11100</span> <span class="bp">≠</span> <span class="mi">0b11100</span>

<span class="kd">def</span> <span class="n">is_valid_instruction</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span>
<span class="n">is_16_bit_instruction</span> <span class="n">n</span> <span class="bp">∨</span>
<span class="n">is_32_bit_instruction</span> <span class="n">n</span>
</code></pre></div>



<a name="213005443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213005443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213005443">(Oct 12 2020 at 07:28)</a>:</h4>
<p>one thing you can do to make the ISA easier to analyze is to bucket the instructions, for example putting all binops in one variant</p>



<a name="213005484"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213005484" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213005484">(Oct 12 2020 at 07:29)</a>:</h4>
<p>It wouldn't be hard to bucket these by type now, although that may not be exactly the layout you want</p>



<a name="213005805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213005805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213005805">(Oct 12 2020 at 07:34)</a>:</h4>
<p>RISC-V uses tri-ops generally; though compressed ops do include binary ops where the first source register is repeated as the destination. <code>ADD rd rs1 rs2</code> is <code>rd = rs1 + rs2</code>. I like the current order, ordered by XLEN and ISA extensions; because these are the units they are introduced. If I were to add more order, it'd probably be either (opcode, funct3, funct7)-order or format-shape order.</p>



<a name="213005869"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213005869" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213005869">(Oct 12 2020 at 07:34)</a>:</h4>
<p><code>reg[rd] = reg[rs1] + reg[rs2]</code> **</p>



<a name="213005937"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213005937" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213005937">(Oct 12 2020 at 07:35)</a>:</h4>
<p>Oh, you meant reduce the inductive variants and use defs to map the instructions to the fewer variants?</p>



<a name="213005998"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213005998" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213005998">(Oct 12 2020 at 07:36)</a>:</h4>
<p>If you have an inductive type with 63 constructors, proving anything by <code>cases</code> on the type will be an exercise in patience (particularly if you have two variables, e.g. to prove determinism)</p>



<a name="213006072"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213006072" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213006072">(Oct 12 2020 at 07:37)</a>:</h4>
<p>I'm open to any way to reduce the complexity.</p>



<a name="213006169"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213006169" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213006169">(Oct 12 2020 at 07:39)</a>:</h4>
<p>e.g.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">binop</span>
<span class="bp">|</span> <span class="n">ADD</span> <span class="bp">|</span> <span class="n">SUB</span> <span class="bp">|</span> <span class="n">SLL</span> <span class="c1">-- | ...</span>

<span class="kd">inductive</span> <span class="n">loadop</span>
<span class="bp">|</span> <span class="n">LUI</span> <span class="bp">|</span> <span class="n">LD</span> <span class="c1">-- | ...</span>

<span class="kd">inductive</span> <span class="n">rvim</span>
<span class="bp">|</span> <span class="n">binop</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">binop</span><span class="o">)</span> <span class="o">(</span><span class="n">rd</span> <span class="n">rs</span> <span class="n">rt</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">rvim</span>
<span class="bp">|</span> <span class="n">load</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">loadop</span><span class="o">)</span> <span class="o">(</span><span class="n">rd</span> <span class="n">imm</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">rvim</span>
</code></pre></div>



<a name="213006319"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213006319" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213006319">(Oct 12 2020 at 07:41)</a>:</h4>
<p>Bucketing based on format shape is the obvious thing to do, but you should also separate out variants that treat their arguments significantly differently in the same format-shape, not sure if this is a major concern in riscv</p>



<a name="213006514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213006514" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213006514">(Oct 12 2020 at 07:43)</a>:</h4>
<p>Note that proving <code>no_confusion</code> with a bucketed inductive like this is literally lower asymptotic complexity, since if you have a 7 * 7 bucketed inductive then proving that different variants are different is 8 * 7 ^ 2 large (8 inductives of 7 variants each) instead of 49 ^ 2 with a 49 variant inductive</p>



<a name="213007011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007011">(Oct 12 2020 at 07:49)</a>:</h4>
<p>Note all of these instructions are either a pick-3 of rd, rs1, rs2, imm; or both rd, imm; or zero (in the single case of FENCE), so they could all be reduced to 3 cases (so far; though there are more variations with more ISA extensions active). The format constants (opcode7, funct3, funct7) could be flattened into a single natural of 17 bits. The opcode7 internally embeds the tag for the format variant.</p>



<a name="213007113"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007113" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007113">(Oct 12 2020 at 07:50)</a>:</h4>
<p>Rather, it doesn't explicitly embed the tag but is sufficient to reconstruct it.</p>



<a name="213007178"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007178" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007178">(Oct 12 2020 at 07:51)</a>:</h4>
<p>The pick-3 can be seen at the top, in the comments of the <code>inductive fmt</code> section.</p>



<a name="213007346"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007346" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007346">(Oct 12 2020 at 07:53)</a>:</h4>
<p>One deviating hack I've considered is to allow the rd/rs1/rs2 to exceed their 5-bit limit to represent pseudo-registers a la SSA. But this adds a mode where assembly is illegal; which is fine. Assembly should happen only after register allocation anyway and these instructions are useful before register allocation.</p>



<a name="213007370"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007370" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007370">(Oct 12 2020 at 07:53)</a>:</h4>
<p>and imm, for offset symbols.</p>



<a name="213007594"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007594" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007594">(Oct 12 2020 at 07:56)</a>:</h4>
<blockquote>
<p>The format constants (opcode7, funct3, funct7) could be flattened into a single natural of 17 bits.</p>
</blockquote>
<p>I would suggest translating these to variants as early as possible though, because lean's handling of 17 bit numbers will not be satisfactory to you</p>



<a name="213007634"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007634" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007634">(Oct 12 2020 at 07:56)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> BTW: "LUI" is load upper-immediate; isn't a load involving memory so I wouldn't call it a "load operation". It only writes the immediate to the upper bits of a register.</p>



<a name="213007657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007657">(Oct 12 2020 at 07:56)</a>:</h4>
<p>yeah you can tell I'm mocking things quickly</p>



<a name="213007700"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007700" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007700">(Oct 12 2020 at 07:57)</a>:</h4>
<p>it's not actually about the type of operation that it does but rather it's "mode of operation", i.e. the way it handles its arguments</p>



<a name="213007725"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007725" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007725">(Oct 12 2020 at 07:57)</a>:</h4>
<p>just imagine you are doing a proof by cases on these variants, what is the most useful categorization?</p>



<a name="213007813"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007813" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007813">(Oct 12 2020 at 07:58)</a>:</h4>
<p>if some of these only interact with certain parts of the machine state (e.g. ALU ops vs memory ops) that's another possible categorization</p>



<a name="213007915"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007915" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007915">(Oct 12 2020 at 07:59)</a>:</h4>
<p>RISC-V is indeed a load-store architecture; which means that the ALU operations do not touch memory at all; and memory operations do no arithmetic (besides immediate offsets added to the register for the address)</p>



<a name="213007981"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213007981" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213007981">(Oct 12 2020 at 08:00)</a>:</h4>
<blockquote>
<p>One deviating hack I've considered is to allow the rd/rs1/rs2 to exceed their 5-bit limit to represent pseudo-registers a la SSA. But this adds a mode where assembly is illegal; which is fine. Assembly should happen only after register allocation anyway and these instructions are useful before register allocation.</p>
</blockquote>
<p>This should be fine; you can have an assembly function that turns an instruction into a bit pattern, and it can fail on some arguments</p>



<a name="213008201"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213008201" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213008201">(Oct 12 2020 at 08:02)</a>:</h4>
<p>although it sounds like you might need an extended semantics with a machine with infinite registers to make sense of the extra instructions</p>



<a name="213008233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213008233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213008233">(Oct 12 2020 at 08:02)</a>:</h4>
<p>unless they are just garbage instructions with no semantics</p>



<a name="213008413"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213008413" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213008413">(Oct 12 2020 at 08:04)</a>:</h4>
<p>I know some compilers use a v-code style approach, where you have the same instructions as the machine but with infinite registers; I prefer to just have an IR for that, where I get to pick a nicer set of high level instructions</p>



<a name="213008780"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213008780" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213008780">(Oct 12 2020 at 08:08)</a>:</h4>
<p>Regarding proofs; all will target the non-{pseudo,compressed} instructions. Pseudoinstructions won't exist in my compiler. Compressed instructions are only abbreviations of the larger instructions. Compression is applied when certain registers are used and when the destination is the first source register and in a few other cases. Currently all instructions are 32-bits. Compressed instructions are 16. Higher sizes exist in the specification but have no members and their format isn't frozen.</p>



<a name="213008827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213008827" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213008827">(Oct 12 2020 at 08:09)</a>:</h4>
<p>v-code?</p>



<a name="213008918"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213008918" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213008918">(Oct 12 2020 at 08:10)</a>:</h4>
<p>My IR will be RVSDG-based enriched with equivalence graphs a la eqsat.</p>



<a name="213008966"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213008966" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213008966">(Oct 12 2020 at 08:11)</a>:</h4>
<p>RVSDG is very lambda calculus ish. My source language will be RDT based.</p>



<a name="213009007"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009007" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009007">(Oct 12 2020 at 08:11)</a>:</h4>
<p>well you also need a low level IR for doing register allocation</p>



<a name="213009067"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009067" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009067">(Oct 12 2020 at 08:12)</a>:</h4>
<p>unless you are going to go straight from there to machine code</p>



<a name="213009085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009085">(Oct 12 2020 at 08:12)</a>:</h4>
<p>RVSDG = <a href="https://www.sintef.no/contentassets/11da6d67207348db98a30ddbdf3b0bba/reissmann_poster.pdf">https://www.sintef.no/contentassets/11da6d67207348db98a30ddbdf3b0bba/reissmann_poster.pdf</a><br>
Equality Saturation = <a href="https://www.cs.cornell.edu/~ross/publications/eqsat/">https://www.cs.cornell.edu/~ross/publications/eqsat/</a><br>
Resourceful Dependent Types = <a href="http://www.cse.chalmers.se/~abela/talkTYPES18.pdf">http://www.cse.chalmers.se/~abela/talkTYPES18.pdf</a> + <a href="http://www.cse.chalmers.se/~abela/types18.pdf">http://www.cse.chalmers.se/~abela/types18.pdf</a></p>



<a name="213009285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009285" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009285">(Oct 12 2020 at 08:14)</a>:</h4>
<p>I forget where I heard about v-code architecture, possibly <a href="https://github.com/bytecodealliance/wasmtime/blob/master/cranelift/codegen/src/machinst/vcode.rs">cranelift</a></p>



<a name="213009361"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009361" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009361">(Oct 12 2020 at 08:15)</a>:</h4>
<p>My understanding of RVSDG is that register colouring and instruction selection can be done straight from it without additional IRs.</p>



<a name="213009503"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009503" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009503">(Oct 12 2020 at 08:17)</a>:</h4>
<p>Is there a more complete reference for RVSDG than the poster?</p>



<a name="213009507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009507" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009507">(Oct 12 2020 at 08:17)</a>:</h4>
<p>BTW: eqsat enriched here means that the RVSDG IR is non-destructively optimized by adding equivalent programs in an equivalence graph. All optimizations are applied in all orders until the resource bounds are reached.</p>



<a name="213009511"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009511" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009511">(Oct 12 2020 at 08:17)</a>:</h4>
<p>Yes.</p>



<a name="213009576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009576">(Oct 12 2020 at 08:18)</a>:</h4>
<p>I thought it had a link at the bottom but it just says the reference.</p>



<a name="213009669"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009669" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009669">(Oct 12 2020 at 08:19)</a>:</h4>
<p>And that didn't seem to reference what I expected.. This is a great start. <a href="https://arxiv.org/abs/1912.05036">https://arxiv.org/abs/1912.05036</a></p>



<a name="213009760"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009760" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009760">(Oct 12 2020 at 08:20)</a>:</h4>
<p>I also found <a href="https://www.sjalander.com/research/pdf/reissmann-PhD-thesis.pdf">Reissmann's thesis</a></p>



<a name="213009955"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213009955" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213009955">(Oct 12 2020 at 08:22)</a>:</h4>
<p>Also a good resource. Though this arxiv paper is the GOTO reference IIUC. The poster is just a nice dense visual overview. :)</p>



<a name="213010643"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213010643" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213010643">(Oct 12 2020 at 08:30)</a>:</h4>
<p>As an added bonus; with RDT as the source and RVSDG in the middle; I'll have linearity throughout the whole compiler. Which should have very good implications for memory usage.</p>



<a name="213012077"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012077" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012077">(Oct 12 2020 at 08:47)</a>:</h4>
<p>Re splitting up <code>rvim</code>. If I split by these categories; the largest I have is 21. First by XLEN <code>{32, 64}</code>, then by ISA extension <code>{i, m}</code>, then into <code>{control flow (8), arithmetic (21), memory (8)}</code> with these numbers for rv32i. rv64i adds (0, 9, 3) respectively. rv32m +8 arith, rv64m +5 arith.</p>



<a name="213012122"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012122" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012122">(Oct 12 2020 at 08:47)</a>:</h4>
<p>But this might be a bit too fine.. ?</p>



<a name="213012510"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012510" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012510">(Oct 12 2020 at 08:51)</a>:</h4>
<p>The XLEN thing can hopefully be parameterized</p>



<a name="213012588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012588">(Oct 12 2020 at 08:52)</a>:</h4>
<p>ISA extension is probably not worth it unless you intend to do something in particular with e.g. compiling to just rv64i</p>



<a name="213012649"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012649" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012649">(Oct 12 2020 at 08:53)</a>:</h4>
<p>For arithmetic ops in particular I would try my best to get uniform handling of a large number of those</p>



<a name="213012687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012687" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012687">(Oct 12 2020 at 08:53)</a>:</h4>
<p>i.e. operations which differ only in the mathematical binary function being applied</p>



<a name="213012742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012742" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012742">(Oct 12 2020 at 08:54)</a>:</h4>
<p>I will be compiling to restrictive configurations; but most extensions can be emulated so are safe to allow so long that they do get reduced to the target. I.e. multiplication without the M extension.</p>



<a name="213012798"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012798" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012798">(Oct 12 2020 at 08:54)</a>:</h4>
<p>Another way to represent that is to have a predicate that tells you whether an instruction is in the configuration</p>



<a name="213012872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012872">(Oct 12 2020 at 08:55)</a>:</h4>
<p>which seems like a good idea especially for risc-v because it has so many extensions</p>



<a name="213012891"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012891" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012891">(Oct 12 2020 at 08:55)</a>:</h4>
<p>You'll love the vector extension ;)</p>



<a name="213012973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213012973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213012973">(Oct 12 2020 at 08:56)</a>:</h4>
<p>egh.. throw those all in one variant so they don't pollute the rest of the code</p>



<a name="213013024"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013024" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013024">(Oct 12 2020 at 08:57)</a>:</h4>
<p>Note these aren't all R, the format detection code I wrote in python to generate these doesn't yet understand the vectors. <a href="https://gist.github.com/4fd94ffef4917b2f42d9bdb48e72fa8b">https://gist.github.com/4fd94ffef4917b2f42d9bdb48e72fa8b</a></p>



<a name="213013050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013050">(Oct 12 2020 at 08:57)</a>:</h4>
<p>441</p>



<a name="213013128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013128" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013128">(Oct 12 2020 at 08:58)</a>:</h4>
<p>I mean, this is just a bad representation, total abuse of the concept of an instruction</p>



<a name="213013138"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013138" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013138">(Oct 12 2020 at 08:58)</a>:</h4>
<p>Certainly a lot more consumable than Intel's many many thousands of instructions.</p>



<a name="213013141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013141" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013141">(Oct 12 2020 at 08:58)</a>:</h4>
<p>see also <a href="https://www.sigarch.org/simd-instructions-considered-harmful/">https://www.sigarch.org/simd-instructions-considered-harmful/</a></p>



<a name="213013208"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013208" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013208">(Oct 12 2020 at 08:59)</a>:</h4>
<p>in lean you can at least separate those mostly into orthogonal representation pieces (like size + op)</p>



<a name="213013258"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013258" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013258">(Oct 12 2020 at 08:59)</a>:</h4>
<p>there are 441 things you can do, in the same sense that there are 441 kinds of burgers I can get at the local burger shop</p>



<a name="213013322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013322">(Oct 12 2020 at 09:00)</a>:</h4>
<p>Very important note for RISC-V vectors; they are hardware configuration agnostic. I.e. unlike SSE, SSE3, AVX, AVX2, AVX512; RISC-V's V extension covers all of them generically. The vector lengths are user controlled and the hardware implements and optimizes however it wants to, if at all.</p>



<a name="213013414"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013414" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013414">(Oct 12 2020 at 09:01)</a>:</h4>
<p>I find 37 occurrences of <code>ADD</code> in that list. clearly it's not orthogonal enough</p>



<a name="213013726"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013726" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013726">(Oct 12 2020 at 09:04)</a>:</h4>
<p><a href="https://github.com/riscv/riscv-v-spec/blob/master/v-spec.adoc">https://github.com/riscv/riscv-v-spec/blob/master/v-spec.adoc</a></p>



<a name="213013954"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213013954" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213013954">(Oct 12 2020 at 09:08)</a>:</h4>
<p>One thing I notice in the docs is that instructions are indeed grouped, and they even use "dot notation" for separating out the orthogonal parts, e.g. <code>vw(add|sub)(u?).{vw}{vx}</code> has some clear orthogonality going on</p>



<a name="213014019"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213014019" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213014019">(Oct 12 2020 at 09:08)</a>:</h4>
<p>Note that many of these instructions really are just names for variants of the same instruction.</p>



<a name="213014023"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213014023" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213014023">(Oct 12 2020 at 09:08)</a>:</h4>
<p>As you just pointed out. :)</p>



<a name="213014068"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213014068" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213014068">(Oct 12 2020 at 09:09)</a>:</h4>
<p>I think it is very important that a formalization of the spec makes as much orthogonality explicit as possible</p>



<a name="213014085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213014085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213014085">(Oct 12 2020 at 09:09)</a>:</h4>
<p>Agreed and this is the goal.</p>



<a name="213014165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213014165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213014165">(Oct 12 2020 at 09:10)</a>:</h4>
<p>I still don't have a great grasp on how many instructions x86 has if you do this properly, but it's a lot less than 1500</p>



<a name="213014234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213014234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213014234">(Oct 12 2020 at 09:11)</a>:</h4>
<p>Imagine how low that'd be for RISC-V ;)</p>



<a name="213014236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213014236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213014236">(Oct 12 2020 at 09:11)</a>:</h4>
<p>it's just unfortunate that so many ISA specs "case bash" in their documentation</p>



<a name="213014319"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213014319" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213014319">(Oct 12 2020 at 09:12)</a>:</h4>
<p>so it's not clear when something is one part of a family or a special exception until you read all the exponentially many doc strings to ensure they are all the same</p>



<a name="213016483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213016483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213016483">(Oct 12 2020 at 09:33)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span>  Not sure if you remember; but I started with only the "opcode map" and not the instructions themselves. Note that most opcodes are the same. The 32-bit instructions have 7 bits, where the low two are both high. Thus 5 bits, 32 opcodes. Note that SUB is really an ADD with one of its basically unused bits set high.</p>



<a name="213016674"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213016674" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213016674">(Oct 12 2020 at 09:35)</a>:</h4>
<p>See the top of page 129.  <a href="https://github.com/riscv/riscv-isa-manual/releases/download/draft-20200727-8088ba4/riscv-spec.pdf">https://github.com/riscv/riscv-isa-manual/releases/download/draft-20200727-8088ba4/riscv-spec.pdf</a></p>



<a name="213016843"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213016843" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213016843">(Oct 12 2020 at 09:37)</a>:</h4>
<p>All the branch instructions have the BRANCH opcode, row = 11, column =  000, size = 11 (32-bit length). 1100011,</p>



<a name="213016872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213016872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213016872">(Oct 12 2020 at 09:37)</a>:</h4>
<p>For the most part the decoding is less important than the semantic classes of the instructions. It's not clear to me if the difference between <code>ADD</code> and <code>SUB</code> is any less/more than the difference between <code>ADD</code> and <code>XOR</code>, except in the encoding</p>



<a name="213016990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213016990" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213016990">(Oct 12 2020 at 09:38)</a>:</h4>
<p>ADD and XOR have the same opcode, but are different functions. See their funct3 bits. ADD is 000, XOR is 100.</p>



<a name="213017004"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017004" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017004">(Oct 12 2020 at 09:38)</a>:</h4>
<p>I see that</p>



<a name="213017054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017054">(Oct 12 2020 at 09:39)</a>:</h4>
<p>ADD and SUB have the same funct3 but differ in the extra bits</p>



<a name="213017084"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017084" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017084">(Oct 12 2020 at 09:39)</a>:</h4>
<p>Yes. Similarly for shifting left and right.</p>



<a name="213017085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017085">(Oct 12 2020 at 09:39)</a>:</h4>
<p>but that seems like they just wanted 10 ALU ops and ran out of bits for the encoding</p>



<a name="213017289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017289" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017289">(Oct 12 2020 at 09:41)</a>:</h4>
<p>Not quite; SUB is exactly the same hardware as ADD with one minor tweak. SUB is effectively a fused instruction to invert the sign, then add. Thus subtraction is an argument of addition.... ish</p>



<a name="213017412"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017412" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017412">(Oct 12 2020 at 09:42)</a>:</h4>
<p>hm, where's add-carry?</p>



<a name="213017418"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017418" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017418">(Oct 12 2020 at 09:42)</a>:</h4>
<p>Er, the left/right shifts use funct3. The right shifts logical vs arithmetic use the extra bit in funct7. Which just decides if it sign-extends or not.</p>



<a name="213017433"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017433" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017433">(Oct 12 2020 at 09:42)</a>:</h4>
<p>No add-carry because there are no carry flags or overflow exceptions ;)</p>



<a name="213017440"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017440" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017440">(Oct 12 2020 at 09:42)</a>:</h4>
<p>I guess a SUB is an ADC + NOT</p>



<a name="213017465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017465" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017465">(Oct 12 2020 at 09:42)</a>:</h4>
<p>well I mean the operation x , y -&gt; x + y + 1</p>



<a name="213017483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017483">(Oct 12 2020 at 09:43)</a>:</h4>
<p>or x + y + c if possible</p>



<a name="213017530"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017530" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017530">(Oct 12 2020 at 09:43)</a>:</h4>
<p>it's pretty important to have an op for that if you want to do e.g. bignum addition</p>



<a name="213017596"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017596" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017596">(Oct 12 2020 at 09:44)</a>:</h4>
<p>Right, not an instruction. Easy to emulate of course. Just as rv32i does multiplication and division without multiplication or division.</p>



<a name="213017646"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017646" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017646">(Oct 12 2020 at 09:44)</a>:</h4>
<p>Bignum implementations should defer carries anyway. Familiar with radix 2^51?</p>



<a name="213017687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213017687" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213017687">(Oct 12 2020 at 09:45)</a>:</h4>
<p><a href="https://www.chosenplaintext.ca/articles/radix-2-51-trick.html">https://www.chosenplaintext.ca/articles/radix-2-51-trick.html</a></p>



<a name="213018369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213018369" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213018369">(Oct 12 2020 at 09:52)</a>:</h4>
<p>RISC-V avoids exceptions and flags. There are no arithmetic flags. I.e. division by zero acts like it does in Lean, but in hardware! There are floating point flags, available in the control and status registers (CSR); fflags.</p>



<a name="213018658"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213018658" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213018658">(Oct 12 2020 at 09:55)</a>:</h4>
<p>I don't object to that, but I hope there is still a way to perform a 65-bit addition</p>



<a name="213019289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213019289" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213019289">(Oct 12 2020 at 10:02)</a>:</h4>
<p>Lets ask godbolt. <a href="https://godbolt.org/z/WPs5Mq">https://godbolt.org/z/WPs5Mq</a></p>
<p>Add then set less-than unsigned.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">widdening_add</span><span class="o">:</span>                          <span class="bp">#</span> <span class="bp">@</span><span class="n">widdening_add</span>
        <span class="n">add</span>     <span class="n">a0</span><span class="o">,</span> <span class="n">a0</span><span class="o">,</span> <span class="n">a1</span>
        <span class="n">sltu</span>    <span class="n">a1</span><span class="o">,</span> <span class="n">a0</span><span class="o">,</span> <span class="n">a1</span>
        <span class="n">ret</span>
</code></pre></div>



<a name="213019830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213019830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213019830">(Oct 12 2020 at 10:09)</a>:</h4>
<p>clever</p>



<a name="213019890"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213019890" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213019890">(Oct 12 2020 at 10:10)</a>:</h4>
<p>These are equivalent.</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="n">uint128</span> <span class="nf">widdening_add</span><span class="p">(</span><span class="n">uint64</span> <span class="n">a</span><span class="p">,</span> <span class="n">uint64</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">uint128</span><span class="p">)</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">uint128</span><span class="p">)</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">uint128</span> <span class="nf">widdening_add2</span><span class="p">(</span><span class="n">uint64</span> <span class="n">a</span><span class="p">,</span> <span class="n">uint64</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">uint64</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">uint128</span><span class="p">)</span> <span class="n">c</span> <span class="o">+</span>
      <span class="p">(((</span><span class="n">uint128</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



<a name="213020076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213020076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213020076">(Oct 12 2020 at 10:12)</a>:</h4>
<p>To contrast to x86...</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">widdening_add</span><span class="o">:</span>
        <span class="n">mov</span>     <span class="n">rax</span><span class="o">,</span> <span class="n">rdi</span>
        <span class="n">xor</span>     <span class="n">edx</span><span class="o">,</span> <span class="n">edx</span>
        <span class="n">xor</span>     <span class="n">edi</span><span class="o">,</span> <span class="n">edi</span>
        <span class="n">add</span>     <span class="n">rax</span><span class="o">,</span> <span class="n">rsi</span>
        <span class="n">adc</span>     <span class="n">rdx</span><span class="o">,</span> <span class="n">rdi</span>
        <span class="n">ret</span>
<span class="n">widdening_add2</span><span class="o">:</span>
        <span class="n">add</span>     <span class="n">rdi</span><span class="o">,</span> <span class="n">rsi</span>
        <span class="n">mov</span>     <span class="n">edx</span><span class="o">,</span> <span class="mi">0</span>
        <span class="n">mov</span>     <span class="n">rax</span><span class="o">,</span> <span class="n">rdi</span>
        <span class="n">jnc</span>     <span class="bp">.</span><span class="n">L3</span>
        <span class="n">add</span>     <span class="n">rdx</span><span class="o">,</span> <span class="mi">1</span>
<span class="bp">.</span><span class="n">L3</span><span class="o">:</span>
        <span class="n">ret</span>
</code></pre></div>



<a name="213020110"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213020110" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213020110">(Oct 12 2020 at 10:13)</a>:</h4>
<p>Register movement noise and it doesn't even generate the same code.</p>



<a name="213020225"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213020225" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213020225">(Oct 12 2020 at 10:14)</a>:</h4>
<p>I don't think that's optimal code though</p>



<a name="213020275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213020275" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213020275">(Oct 12 2020 at 10:15)</a>:</h4>
<p>I'm pretty sure you can get it down to one instruction if you handcode the assembly</p>



<a name="213020303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213020303" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213020303">(Oct 12 2020 at 10:15)</a>:</h4>
<p>BTW: I use RISC-V's assembly to debug my x86 code... I avoid x86. :D</p>



<a name="213020364"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213020364" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213020364">(Oct 12 2020 at 10:16)</a>:</h4>
<p>I don't want to suggest that x86 is a good ISA by any stretch, but ADC looks like a useful instruction to me</p>



<a name="213020512"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213020512" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213020512">(Oct 12 2020 at 10:18)</a>:</h4>
<p>Aside: even <a href="https://github.com/leanprover-community/mathlib/blob/master/src/tactic/norm_num.lean#L115-L131">norm_num</a> likes adc</p>



<a name="213020846"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213020846" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213020846">(Oct 12 2020 at 10:23)</a>:</h4>
<p>I believe that RISC-V is the best ISA option there is. It may not be perfect but the complaints are small and few. I think I can trim RISC-V down by using the real opcode map instead of the instruction list; then generalize over the formats and get something pretty small.</p>
<p>With this, I guess I'm going to set aside our progress so far and start fresh. Focusing on keeping the inductives reasonable. An unfortunate reason to push towards this design, though I hope it'll work out better anyway.</p>



<a name="213021197"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213021197" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213021197">(Oct 12 2020 at 10:27)</a>:</h4>
<p>The main reason I chose x86 instead of RISC-V for the MM0 project was because x86 hardware is more accessible</p>



<a name="213021296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213021296" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213021296">(Oct 12 2020 at 10:28)</a>:</h4>
<p>I think that from a technical perspective RISC-V is an obvious improvement on all axes, because it was actually designed instead of accrued</p>



<a name="213021689"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213021689" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213021689">(Oct 12 2020 at 10:32)</a>:</h4>
<p>I don't know the implications on hardware demands for your project; but for mine, where there are sensitive security critical details involved... I'd really rather start with a well designed ISA I can memorize and reason with.</p>
<p>I'm "okay" with running my code in an emulator or using a JIT to x86 recompiler to run my code. Simply because it will take time to implement my compiler and language, to implement what I want to in it, and verify the whole chain there. This is a project for the future, where I can only see success for RISC-V and x86 necessarily dying out.</p>
<p>Worst case, someone else can just extend my compiler with an x86 backend. ;)</p>



<a name="213021797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213021797" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213021797">(Oct 12 2020 at 10:33)</a>:</h4>
<p>The emulator and JIT obviously ruin the security properties of the language and compiler; but are fine to just run code.</p>



<a name="213021817"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213021817" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213021817">(Oct 12 2020 at 10:33)</a>:</h4>
<p>Well, as long as it can be soundly specified one ISA is as good as another</p>



<a name="213021974"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213021974" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213021974">(Oct 12 2020 at 10:35)</a>:</h4>
<p>but other arches are on the todo list, after the initial MVP is done</p>



<a name="213022063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213022063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213022063">(Oct 12 2020 at 10:36)</a>:</h4>
<p>What are your targets?</p>



<a name="213022089"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213022089" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213022089">(Oct 12 2020 at 10:36)</a>:</h4>
<p>But for the purpose of minimizing the chain of trust, it's no good to emulate the hardware because then you have to trust the emulator <em>and</em> the x86 machine it's running on</p>



<a name="213022132"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213022132" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213022132">(Oct 12 2020 at 10:37)</a>:</h4>
<p>Right now, I target a simple subset of x86-64 + a simple subset of posix</p>



<a name="213022220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213022220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213022220">(Oct 12 2020 at 10:38)</a>:</h4>
<p>the output is an ELF executable file, and the spec describes how the bits of that file turn into operational behavior</p>



<a name="213022292"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213022292" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213022292">(Oct 12 2020 at 10:39)</a>:</h4>
<p>Right; I can't trust x86 at all and I certainly can't trust my RISC-V code when emulating it. The emulator is exclusively to just run it on legacy hardware until both all my code is ready, and RISC-V is cheap enough and has taken over the world. Yes, I'm calling all x86 legacy. :)</p>



<a name="213022535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213022535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213022535">(Oct 12 2020 at 10:42)</a>:</h4>
<p>Kernel-wise; I'll target seL4 and will write a basic wrapper to run it on POSIX environments. OS-wise, I'll target Robigalia. Which is barely a thing so far.... but we're passionate to have a safe operating system. :)</p>



<a name="213022706"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213022706" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213022706">(Oct 12 2020 at 10:45)</a>:</h4>
<p>I'm focusing on cryptography, capabilities, and verified distributed protocols.</p>



<a name="213022789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213022789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213022789">(Oct 12 2020 at 10:46)</a>:</h4>
<p>Do you plan to implement all of x86?</p>



<a name="213022873"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213022873" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213022873">(Oct 12 2020 at 10:47)</a>:</h4>
<p>I'd like to at least handle all of RV{32,64}IMCV. Note the lack of atomics and floats. Though they could come later.</p>



<a name="213022979"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213022979" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213022979">(Oct 12 2020 at 10:48)</a>:</h4>
<p>Might throw in B too, the bit manipulation extension can be good for cryptography. But that is much less ready than V. V might even be stable soon.</p>



<a name="213023129"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213023129" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213023129">(Oct 12 2020 at 10:50)</a>:</h4>
<p>I believe that SiFive is waiting on V to be stable before they offer a cheap Linux-ready SBC. Holding back with the expensive devboards until then.</p>



<a name="213023165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213023165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213023165">(Oct 12 2020 at 10:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="328454">SnowFox</span> <a href="#narrow/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean/near/213022789">said</a>:</p>
<blockquote>
<p>Do you plan to implement all of x86?</p>
</blockquote>
<p>Certainly not. x86 is the means not the end. I've got about 30 instructions and even that might have been more than needed</p>



<a name="213023325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213023325" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213023325">(Oct 12 2020 at 10:52)</a>:</h4>
<p><a href="https://github.com/digama0/mm0/blob/master/examples/x86.mm0">https://github.com/digama0/mm0/blob/master/examples/x86.mm0</a> is about 1600 lines to specify x86 + linux enough to compile a C-like programming language</p>



<a name="213023615"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213023615" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213023615">(Oct 12 2020 at 10:55)</a>:</h4>
<p>The <a href="https://github.com/digama0/mm0/blob/master/examples/x86.mm0#L292-L331">main inductive type for instructions</a> has 5+6+7+4=22 variants</p>



<a name="213023635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213023635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213023635">(Oct 12 2020 at 10:56)</a>:</h4>
<p>aside: My godbolt test was a widening addition with 2x 64 bit numbers, not two 65 bit numbers. Not sure which you intended. If you meant the 2x 65-bit addition, then it is equivalent to 2x 128-bit addition. 3x 64-bit adds + one sltu to extract the carry bit.</p>



<a name="213023730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213023730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213023730">(Oct 12 2020 at 10:56)</a>:</h4>
<p>The unit of work in a bignum addition is 64 + 64 + 1 bit addition to produce a 65 bit result</p>



<a name="213023962"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213023962" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213023962">(Oct 12 2020 at 10:59)</a>:</h4>
<p>Then I guess that'd be 3x add + 2x sltu.</p>



<a name="213024059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213024059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213024059">(Oct 12 2020 at 11:00)</a>:</h4>
<p>But I think that'd be a silly method. When working with lots of or large numbers, you really want to defer the carries. Carries are too slow to handle immediately.</p>



<a name="213024125"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213024125" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213024125">(Oct 12 2020 at 11:01)</a>:</h4>
<p>Especially if you have lots of operations to do.</p>



<a name="213024507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213024507" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213024507">(Oct 12 2020 at 11:05)</a>:</h4>
<p>For verification though, with a single add loop, you probably don't want the complexity of deferred carries</p>



<a name="213024539"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213024539" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213024539">(Oct 12 2020 at 11:05)</a>:</h4>
<p>like in the norm_num example, I don't know if deferred carries help at all</p>



<a name="213024564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213024564" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213024564">(Oct 12 2020 at 11:05)</a>:</h4>
<p>because it's serial</p>



<a name="213024831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213024831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213024831">(Oct 12 2020 at 11:09)</a>:</h4>
<p>The difference is when you do something like adding 50 numbers. With the smaller radix; you split each number into smaller parts and let them grow until they could overflow, and finally apply the carries all at once. For radix 2^51 with 64-bit words, you can add 2^13 pre-normalized numbers before you need to normalize the carries. Next with associativity, you can see how parallel you can make this go. Not serial.</p>



<a name="213024925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213024925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213024925">(Oct 12 2020 at 11:10)</a>:</h4>
<p>No I mean proof checking is serial</p>



<a name="213024951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213024951" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213024951">(Oct 12 2020 at 11:11)</a>:</h4>
<p>so something like <code>norm_num</code> has no advantage producing proofs of numerical facts with deferred carries</p>



<a name="213025134"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213025134" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213025134">(Oct 12 2020 at 11:13)</a>:</h4>
<p>/me shrugs; just not where you'd use either then :P</p>



<a name="213025213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213025213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213025213">(Oct 12 2020 at 11:14)</a>:</h4>
<p>well, lean does addition in base 2 instead of 2^64 but the principle is the same</p>



<a name="213025287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213025287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213025287">(Oct 12 2020 at 11:15)</a>:</h4>
<p>amusingly, I've written norm_num three times now in three different proof systems and each time the base is different: lean's is base 2, metamath uses base 10, and MM0 uses base 16</p>



<a name="213025306"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213025306" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213025306">(Oct 12 2020 at 11:15)</a>:</h4>
<p>Heh</p>



<a name="213025560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213025560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213025560">(Oct 12 2020 at 11:19)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> You mentioned "nested inductives" earlier, what does this mean? I understand mutually inductive types, haven't seen nested. Is there a syntax for it or just a thing you can do with the low level tools?</p>



<a name="213025576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213025576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213025576">(Oct 12 2020 at 11:19)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">foo</span>
<span class="bp">|</span> <span class="n">mk</span> <span class="o">:</span> <span class="n">list</span> <span class="n">foo</span> <span class="bp">-&gt;</span> <span class="n">foo</span>
</code></pre></div>



<a name="213025634"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213025634" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213025634">(Oct 12 2020 at 11:20)</a>:</h4>
<p>you use the inductive you are defining as a parameter to another inductive type</p>



<a name="213025648"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213025648" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213025648">(Oct 12 2020 at 11:20)</a>:</h4>
<p>Ah. Okay.</p>



<a name="213025665"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213025665" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213025665">(Oct 12 2020 at 11:20)</a>:</h4>
<p>functions don't count - this is a regular inductive</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">foo</span>
<span class="bp">|</span> <span class="n">mk</span> <span class="o">:</span> <span class="o">(</span><span class="n">nat</span> <span class="bp">-&gt;</span> <span class="n">foo</span><span class="o">)</span> <span class="bp">-&gt;</span> <span class="n">foo</span>
</code></pre></div>



<a name="213025750"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213025750" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213025750">(Oct 12 2020 at 11:21)</a>:</h4>
<p>Noted. What is special about the nested variant that makes it a def instead of an inductive; in so far as #print sees it?</p>



<a name="213026009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213026009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213026009">(Oct 12 2020 at 11:25)</a>:</h4>
<p>lean's kernel doesn't actually support nested inductives, so instead it does some smoke and mirrors around a definition like</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">mutual</span> <span class="kd">inductive</span> <span class="n">foo</span><span class="o">,</span> <span class="n">list_foo</span>
<span class="k">with</span> <span class="n">foo</span> <span class="o">:</span> <span class="kt">Type</span>
<span class="bp">|</span> <span class="n">mk</span> <span class="o">:</span> <span class="n">list_foo</span> <span class="bp">-&gt;</span> <span class="n">foo</span>
<span class="k">with</span> <span class="n">list_foo</span> <span class="o">:</span> <span class="kt">Type</span>
<span class="bp">|</span> <span class="n">nil</span> <span class="o">:</span> <span class="n">list_foo</span>
<span class="bp">|</span> <span class="n">cons</span> <span class="o">:</span> <span class="n">foo</span> <span class="bp">-&gt;</span> <span class="n">list_foo</span> <span class="bp">-&gt;</span> <span class="n">list_foo</span>
</code></pre></div>

<p>which is itself defined in terms of</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">foo'</span> <span class="o">:</span> <span class="n">bool</span> <span class="bp">-&gt;</span> <span class="kt">Type</span>
<span class="bp">|</span> <span class="n">mk</span> <span class="o">:</span> <span class="n">foo'</span> <span class="n">tt</span> <span class="bp">-&gt;</span> <span class="n">foo'</span> <span class="n">ff</span>
<span class="bp">|</span> <span class="n">nil</span> <span class="o">:</span> <span class="n">foo'</span> <span class="n">tt</span>
<span class="bp">|</span> <span class="n">cons</span> <span class="o">:</span> <span class="n">foo'</span> <span class="n">ff</span> <span class="bp">-&gt;</span> <span class="n">foo'</span> <span class="n">tt</span> <span class="bp">-&gt;</span> <span class="n">foo'</span> <span class="n">tt</span>
</code></pre></div>

<p>which is a regular (indexed) inductive type that lean's kernel understands. Then you have to define all the maps from this type to the original type you wanted, and prove the recursion principle, and here the support is a little lacking, and you get a weak recursion principle that isn't good enough to prove all the facts you would like</p>



<a name="213026214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213026214" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213026214">(Oct 12 2020 at 11:27)</a>:</h4>
<p>So I advise you to avoid the conditions under which lean triggers the nested/mutual compilation strategy, and write <code>foo'</code> directly if you need to</p>



<a name="213026283"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213026283" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213026283">(Oct 12 2020 at 11:28)</a>:</h4>
<p>Huh, sounds unfortunate.. Noted.</p>



<a name="213027910"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213027910" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213027910">(Oct 12 2020 at 11:50)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> What do you think of this so far?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">abbreviation</span> <span class="n">register</span> <span class="o">:=</span> <span class="n">nat</span>

<span class="kd">inductive</span> <span class="n">reg_imm</span>
<span class="bp">|</span> <span class="n">reg</span> <span class="o">(</span><span class="n">reg</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">imm</span> <span class="o">(</span><span class="n">imm</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>

<span class="kd">inductive</span> <span class="n">compare</span> <span class="bp">|</span> <span class="n">eq</span> <span class="bp">|</span> <span class="n">ne</span> <span class="bp">|</span> <span class="n">lt</span> <span class="bp">|</span> <span class="n">ge</span> <span class="bp">|</span> <span class="n">ltu</span> <span class="bp">|</span> <span class="n">geu</span>

<span class="kd">inductive</span> <span class="n">operation</span>
<span class="bp">|</span> <span class="n">add</span> <span class="o">(</span><span class="n">invert</span> <span class="o">:</span> <span class="n">opt_param</span> <span class="n">bool</span> <span class="n">ff</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">shift</span> <span class="o">(</span><span class="n">amount</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">arith</span> <span class="o">:</span> <span class="n">opt_param</span> <span class="n">bool</span> <span class="n">ff</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">xor</span>
<span class="bp">|</span> <span class="n">or</span>
<span class="bp">|</span> <span class="n">and</span>

<span class="kd">inductive</span> <span class="n">ast</span>
<span class="bp">|</span> <span class="n">branch</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">compare</span><span class="o">)</span> <span class="o">(</span><span class="n">rs1</span> <span class="n">rs2</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">jump</span> <span class="o">(</span><span class="n">reg</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">base</span> <span class="o">:</span> <span class="n">option</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">arith</span> <span class="o">(</span><span class="n">op</span> <span class="o">:</span> <span class="n">operation</span><span class="o">)</span> <span class="o">(</span><span class="n">rd</span> <span class="n">rs1</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">rs2_imm</span> <span class="o">:</span> <span class="n">reg_imm</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">load</span> <span class="o">(</span><span class="n">dest</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">width</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">base</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">store</span> <span class="o">(</span><span class="n">src</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">width</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">base</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
</code></pre></div>



<a name="213027961"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213027961" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213027961">(Oct 12 2020 at 11:51)</a>:</h4>
<p>is the shift amount always an immediate?</p>



<a name="213028024"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028024" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028024">(Oct 12 2020 at 11:52)</a>:</h4>
<p>Er, that amount shouldn't be in that position.</p>



<a name="213028044"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028044" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028044">(Oct 12 2020 at 11:52)</a>:</h4>
<p>But it is the only integer here, so replace that with direction : bool</p>



<a name="213028084"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028084" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028084">(Oct 12 2020 at 11:53)</a>:</h4>
<p>looks pretty good. Is this the whole thing?</p>



<a name="213028087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028087">(Oct 12 2020 at 11:53)</a>:</h4>
<p>Or just two separate operations.</p>



<a name="213028126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028126">(Oct 12 2020 at 11:53)</a>:</h4>
<p>This covers RV32I.</p>



<a name="213028133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028133" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028133">(Oct 12 2020 at 11:53)</a>:</h4>
<p>if so it's a pretty massive reduction from the original</p>



<a name="213028198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028198">(Oct 12 2020 at 11:54)</a>:</h4>
<p>Very!</p>



<a name="213028389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028389">(Oct 12 2020 at 11:56)</a>:</h4>
<p>There is also what I started with; before we derailed with the raw instructions. Which I'll probably use this round.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">rv_base_opcode</span>
<span class="bp">|</span> <span class="n">load</span>   <span class="bp">|</span> <span class="n">load_fp</span>  <span class="bp">|</span> <span class="n">custom_0</span>   <span class="bp">|</span> <span class="n">misc_mem</span> <span class="bp">|</span> <span class="n">op_imm</span> <span class="bp">|</span> <span class="n">auipc</span>      <span class="bp">|</span> <span class="n">op_imm_32</span>
<span class="bp">|</span> <span class="n">store</span>  <span class="bp">|</span> <span class="n">store_fp</span> <span class="bp">|</span> <span class="n">custom_1</span>   <span class="bp">|</span> <span class="n">amo</span>      <span class="bp">|</span> <span class="n">op</span>     <span class="bp">|</span> <span class="n">lui</span>        <span class="bp">|</span> <span class="n">op_32</span>
<span class="bp">|</span> <span class="n">madd</span>   <span class="bp">|</span> <span class="n">msub</span>     <span class="bp">|</span> <span class="n">nmsub</span>      <span class="bp">|</span> <span class="n">nmadd</span>    <span class="bp">|</span> <span class="n">op_fp</span>  <span class="bp">|</span> <span class="n">reserved_0</span> <span class="bp">|</span> <span class="n">custom_2</span>
<span class="bp">|</span> <span class="n">branch</span> <span class="bp">|</span> <span class="n">jalr</span>     <span class="bp">|</span> <span class="n">reserved_1</span> <span class="bp">|</span> <span class="n">jal</span>      <span class="bp">|</span> <span class="n">system</span> <span class="bp">|</span> <span class="n">reserved_2</span> <span class="bp">|</span> <span class="n">custom_3</span>
</code></pre></div>



<a name="213028429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028429">(Oct 12 2020 at 11:56)</a>:</h4>
<p>This doesn't cover encoding though; hopefully these classes align well with the opcodes</p>



<a name="213028436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028436">(Oct 12 2020 at 11:56)</a>:</h4>
<p>right, that</p>



<a name="213028560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028560">(Oct 12 2020 at 11:58)</a>:</h4>
<p>They do. All operations over immediates are <code>rv_base_opcode.op_imm</code>. All operations over registers are <code>rv_base_opcode.op</code>. The specifics only map to <code>funct3</code> and <code>funct7</code> where <code>funct7</code> is basically one bit rarely set, occasionally a different bit. :P</p>



<a name="213028569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028569">(Oct 12 2020 at 11:58)</a>:</h4>
<p>... mostly lots of zeros :)</p>



<a name="213028600"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028600" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028600">(Oct 12 2020 at 11:59)</a>:</h4>
<p>I mean <code>ast</code></p>



<a name="213028614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028614" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028614">(Oct 12 2020 at 11:59)</a>:</h4>
<p>clearly <code>rv_base_opcode</code> maps well to the opcodes, AFAICT it's 1-1</p>



<a name="213028625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028625" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028625">(Oct 12 2020 at 11:59)</a>:</h4>
<p>Right, I meant that <code>ast.arith</code> has only two opcodes.</p>



<a name="213028722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028722" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028722">(Oct 12 2020 at 12:00)</a>:</h4>
<p><code>ast.branch</code> maps to <code>opcodes.branch</code>, <code>ast.jump</code> with <code>jal</code> and <code>jalr</code>. load and store, are well, exactly those.</p>



<a name="213028781"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028781" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028781">(Oct 12 2020 at 12:01)</a>:</h4>
<p>you should try writing the function <code>ast -&gt; (opc, funct3, funct7)</code>, hopefully you can pattern match your way to victory</p>



<a name="213028954"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213028954" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213028954">(Oct 12 2020 at 12:03)</a>:</h4>
<p>or I guess that could even map directly to <code>nat</code> (really <code>fin (2^32)</code>) using helper functions like <code>fmt_R (opcode7 funct3 funct7 rd rs1 rs2 : nat) : nat</code></p>



<a name="213029049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213029049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213029049">(Oct 12 2020 at 12:04)</a>:</h4>
<p>that seems like the cleanest way to write down all that encoding information on this <code>ast</code> basis</p>



<a name="213029494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213029494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213029494">(Oct 12 2020 at 12:10)</a>:</h4>
<p>Why does vscodium not always offer to expand case splits for you? o.o</p>



<a name="213036327"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036327" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036327">(Oct 12 2020 at 13:16)</a>:</h4>
<p>Hmm. Does it make sense to expand these out or use "modes" of the base operation?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">operation</span>
<span class="bp">|</span> <span class="n">add</span> <span class="bp">|</span> <span class="n">sub</span> <span class="bp">|</span> <span class="n">addw</span>
<span class="bp">|</span> <span class="n">sll</span> <span class="bp">|</span> <span class="n">srl</span> <span class="bp">|</span> <span class="n">sra</span>
<span class="bp">|</span> <span class="n">xor</span>
<span class="bp">|</span> <span class="n">or</span>
<span class="bp">|</span> <span class="n">and</span>
<span class="bp">|</span> <span class="n">mul</span> <span class="bp">|</span> <span class="n">mulh</span> <span class="bp">|</span> <span class="n">mulhs</span> <span class="bp">|</span> <span class="n">mulhsu</span> <span class="bp">|</span> <span class="n">mulw</span>
<span class="bp">|</span> <span class="n">div</span> <span class="bp">|</span> <span class="n">divu</span> <span class="bp">|</span> <span class="n">divw</span> <span class="bp">|</span> <span class="n">divuw</span>
<span class="bp">|</span> <span class="n">rem</span> <span class="bp">|</span> <span class="n">remu</span> <span class="bp">|</span> <span class="n">remw</span> <span class="bp">|</span> <span class="n">remuw</span>
</code></pre></div>



<a name="213036422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036422" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036422">(Oct 12 2020 at 13:17)</a>:</h4>
<p>how are they specified?</p>



<a name="213036436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036436">(Oct 12 2020 at 13:17)</a>:</h4>
<p>rv64i adds <code>addw</code>. rvm adds the last 3 rows.</p>



<a name="213036538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036538" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036538">(Oct 12 2020 at 13:18)</a>:</h4>
<p>Eh, RV64I adds a few more.</p>



<a name="213036577"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036577" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036577">(Oct 12 2020 at 13:18)</a>:</h4>
<p>The main question is whether you are always going to have to case split the subparts anyway</p>



<a name="213036629"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036629" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036629">(Oct 12 2020 at 13:19)</a>:</h4>
<p>Yes.</p>



<a name="213036645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036645" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036645">(Oct 12 2020 at 13:19)</a>:</h4>
<p>if there are functions where you can say <code>(mul _) := stuff</code> where <code>_</code> is the subop, then it's a win</p>



<a name="213036703"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036703" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036703">(Oct 12 2020 at 13:19)</a>:</h4>
<p>The Ws are operations over sign-extended 32-bits on 64-bit systems. the rest are XLEN-wise.</p>



<a name="213036824"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036824" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036824">(Oct 12 2020 at 13:20)</a>:</h4>
<p>All but the logical operations have a W variant.</p>



<a name="213036858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036858" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036858">(Oct 12 2020 at 13:20)</a>:</h4>
<p>So I guess I should split arithmetic into two modes and split logic out.</p>



<a name="213036914"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213036914" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213036914">(Oct 12 2020 at 13:21)</a>:</h4>
<p>I also forgot about set less than (unsigned) which I guess is logic.</p>



<a name="213037161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213037161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213037161">(Oct 12 2020 at 13:23)</a>:</h4>
<p>However, there is no mul[h[[s]u]]w.</p>



<a name="213037186"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213037186" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213037186">(Oct 12 2020 at 13:23)</a>:</h4>
<p>Only mulw, of all those options.</p>



<a name="213037279"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213037279" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213037279">(Oct 12 2020 at 13:24)</a>:</h4>
<p>Which I guess is fine to "allow" and later mark as invalid.</p>



<a name="213037319"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213037319" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213037319">(Oct 12 2020 at 13:24)</a>:</h4>
<p>As I'd do for subtraction with an immediate.</p>



<a name="213037392"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213037392" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213037392">(Oct 12 2020 at 13:25)</a>:</h4>
<p>(Because addition with an immediate has signed immediates already)</p>



<a name="213039151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213039151" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213039151">(Oct 12 2020 at 13:39)</a>:</h4>
<p><code>RV{32,64}IM</code> with a few illegal cases, but easy to normalize (<code>subi -&gt; addi</code>) or mark as invalid (no <code>mulhw</code> et al).</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">abbreviation</span> <span class="n">register</span> <span class="o">:=</span> <span class="n">nat</span>

<span class="kd">inductive</span> <span class="n">reg_imm</span>
<span class="bp">|</span> <span class="n">reg</span> <span class="o">(</span><span class="n">reg</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">imm</span> <span class="o">(</span><span class="n">imm</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>

<span class="kd">inductive</span> <span class="n">compare</span> <span class="bp">|</span> <span class="n">eq</span> <span class="bp">|</span> <span class="n">ne</span> <span class="bp">|</span> <span class="n">lt</span> <span class="bp">|</span> <span class="n">ge</span> <span class="bp">|</span> <span class="n">ltu</span> <span class="bp">|</span> <span class="n">geu</span>

<span class="kd">inductive</span> <span class="n">arithmetic</span>
<span class="bp">|</span> <span class="n">add</span> <span class="bp">|</span> <span class="n">sub</span>
<span class="bp">|</span> <span class="n">sll</span> <span class="bp">|</span> <span class="n">srl</span> <span class="bp">|</span> <span class="n">sra</span>
<span class="bp">|</span> <span class="n">slt</span> <span class="bp">|</span> <span class="n">sltu</span>
<span class="bp">|</span> <span class="n">mul</span> <span class="bp">|</span> <span class="n">mulh</span> <span class="bp">|</span> <span class="n">mulhu</span> <span class="bp">|</span> <span class="n">mulhsu</span>
<span class="bp">|</span> <span class="n">div</span> <span class="bp">|</span> <span class="n">divu</span>
<span class="bp">|</span> <span class="n">rem</span> <span class="bp">|</span> <span class="n">remu</span>

<span class="kd">inductive</span> <span class="n">logical</span>
<span class="bp">|</span> <span class="n">xor</span>
<span class="bp">|</span> <span class="n">or</span>
<span class="bp">|</span> <span class="n">and</span>

<span class="kd">inductive</span> <span class="n">ast</span>
<span class="bp">|</span> <span class="n">arith</span> <span class="o">(</span><span class="n">op</span> <span class="o">:</span> <span class="n">arithmetic</span><span class="o">)</span> <span class="o">(</span><span class="n">w</span> <span class="o">:</span> <span class="n">bool</span><span class="o">)</span> <span class="o">(</span><span class="n">rd</span> <span class="n">rs1</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">rs2_imm</span> <span class="o">:</span> <span class="n">reg_imm</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">logic</span> <span class="o">(</span><span class="n">op</span> <span class="o">:</span> <span class="n">logical</span><span class="o">)</span>  <span class="o">(</span><span class="n">rd</span> <span class="n">rs1</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">rs2_imm</span> <span class="o">:</span> <span class="n">reg_imm</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">lui</span> <span class="o">(</span><span class="n">rd</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">auipc</span> <span class="o">(</span><span class="n">rd</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">jump</span> <span class="o">(</span><span class="n">reg</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">base</span> <span class="o">:</span> <span class="n">option</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">branch</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">compare</span><span class="o">)</span> <span class="o">(</span><span class="n">rs1</span> <span class="n">rs2</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">load</span> <span class="o">(</span><span class="n">dest</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">width</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">4</span><span class="o">)</span> <span class="o">(</span><span class="n">base</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">store</span> <span class="o">(</span><span class="n">src</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">width</span> <span class="o">:</span> <span class="n">fin</span> <span class="mi">4</span><span class="o">)</span> <span class="o">(</span><span class="n">base</span> <span class="o">:</span> <span class="n">register</span><span class="o">)</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">fence</span> <span class="o">(</span><span class="n">mode</span> <span class="n">pred</span> <span class="n">succ</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">call</span>
<span class="bp">|</span> <span class="n">break</span>
</code></pre></div>



<a name="213042236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213042236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213042236">(Oct 12 2020 at 14:03)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> <code>get_opcode</code> and <code>get_funct</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">namespace</span> <span class="n">ast</span>
  <span class="kd">def</span> <span class="n">get_opcode</span> <span class="o">:</span> <span class="n">ast</span> <span class="bp">-&gt;</span> <span class="n">opcode</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">branch</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="n">opcode.branch</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">jump</span> <span class="n">_</span> <span class="o">(</span><span class="n">some</span> <span class="n">_</span><span class="o">)</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="n">opcode.jalr</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">jump</span> <span class="n">_</span> <span class="n">none</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="n">opcode.jal</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">_</span> <span class="n">ff</span> <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="n">reg_imm.reg</span> <span class="n">_</span><span class="o">))</span> <span class="o">:=</span> <span class="n">opcode.op</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">_</span> <span class="n">ff</span> <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="n">reg_imm.imm</span> <span class="n">_</span><span class="o">))</span> <span class="o">:=</span> <span class="n">opcode.op_imm</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">_</span> <span class="n">tt</span> <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="n">reg_imm.reg</span> <span class="n">_</span><span class="o">))</span> <span class="o">:=</span> <span class="n">opcode.op_32</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">_</span> <span class="n">tt</span> <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="n">reg_imm.imm</span> <span class="n">_</span><span class="o">))</span> <span class="o">:=</span> <span class="n">opcode.op_imm_32</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">logic</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="n">reg_imm.reg</span> <span class="n">_</span><span class="o">))</span> <span class="o">:=</span> <span class="n">opcode.op_32</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">logic</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="n">reg_imm.imm</span> <span class="n">_</span><span class="o">))</span> <span class="o">:=</span> <span class="n">opcode.op_imm_32</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">lui</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="n">opcode.lui</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">auipc</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="n">opcode.auipc</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">load</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="n">opcode.load</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">store</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="n">opcode.store</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">fence</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="n">opcode.misc_mem</span>
  <span class="bp">|</span> <span class="n">call</span> <span class="o">:=</span> <span class="n">opcode.system</span>
  <span class="bp">|</span> <span class="n">break</span> <span class="o">:=</span> <span class="n">opcode.system</span>

  <span class="kn">open</span> <span class="n">arithmetic</span>
  <span class="kn">open</span> <span class="n">logical</span>
  <span class="kn">open</span> <span class="n">compare</span>

  <span class="c1">-- funct7 &lt;&lt; 3 + funct3</span>
  <span class="kd">def</span> <span class="n">get_funct</span> <span class="o">:</span> <span class="n">ast</span> <span class="bp">-&gt;</span> <span class="n">nat</span>
  <span class="c1">-- rvi</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">branch</span> <span class="n">c</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span>
    <span class="k">match</span> <span class="n">c</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="n">eq</span> <span class="o">:=</span> <span class="mi">0b000</span>
    <span class="bp">|</span> <span class="n">ne</span> <span class="o">:=</span> <span class="mi">0b001</span>
    <span class="bp">|</span> <span class="n">lt</span> <span class="o">:=</span> <span class="mi">0b100</span>
    <span class="bp">|</span> <span class="n">ge</span> <span class="o">:=</span> <span class="mi">0b101</span>
    <span class="bp">|</span> <span class="n">ltu</span> <span class="o">:=</span> <span class="mi">0b110</span>
    <span class="bp">|</span> <span class="n">gtu</span> <span class="o">:=</span> <span class="mi">0b111</span>
    <span class="kd">end</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">jump</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">add</span>  <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b000</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">sub</span>  <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b000</span> <span class="bp">+</span> <span class="n">nat.shiftl</span> <span class="mi">3</span> <span class="mi">0b0100000</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">sll</span>  <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b001</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">slt</span>  <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b010</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">sltu</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b011</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">srl</span>  <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b101</span> <span class="bp">+</span> <span class="n">nat.shiftl</span> <span class="mi">3</span> <span class="mi">0b0100000</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">sra</span>  <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b101</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">logic</span> <span class="n">xor</span>  <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span>   <span class="o">:=</span> <span class="mi">0b100</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">logic</span> <span class="n">or</span>   <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span>   <span class="o">:=</span> <span class="mi">0b110</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">logic</span> <span class="n">and</span>  <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span>   <span class="o">:=</span> <span class="mi">0b111</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">load</span> <span class="n">_</span> <span class="n">width</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span>   <span class="o">:=</span> <span class="n">width.val</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">store</span> <span class="n">_</span> <span class="n">width</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span>  <span class="o">:=</span> <span class="n">width.val</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">lui</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">auipc</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">fence</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0</span>
  <span class="bp">|</span> <span class="n">call</span> <span class="o">:=</span> <span class="mi">0</span>
  <span class="bp">|</span> <span class="n">break</span> <span class="o">:=</span> <span class="mi">0</span>
  <span class="c1">-- rvm</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">mul</span>    <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b000</span> <span class="bp">+</span> <span class="n">nat.shiftl</span> <span class="mi">3</span> <span class="mi">0b0000001</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">mulh</span>   <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b001</span> <span class="bp">+</span> <span class="n">nat.shiftl</span> <span class="mi">3</span> <span class="mi">0b0000001</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">mulhsu</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b010</span> <span class="bp">+</span> <span class="n">nat.shiftl</span> <span class="mi">3</span> <span class="mi">0b0000001</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">mulhu</span>  <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b011</span> <span class="bp">+</span> <span class="n">nat.shiftl</span> <span class="mi">3</span> <span class="mi">0b0000001</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">div</span>    <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b100</span> <span class="bp">+</span> <span class="n">nat.shiftl</span> <span class="mi">3</span> <span class="mi">0b0000001</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">divu</span>   <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b101</span> <span class="bp">+</span> <span class="n">nat.shiftl</span> <span class="mi">3</span> <span class="mi">0b0000001</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">rem</span>    <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b110</span> <span class="bp">+</span> <span class="n">nat.shiftl</span> <span class="mi">3</span> <span class="mi">0b0000001</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">remu</span>   <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0b111</span> <span class="bp">+</span> <span class="n">nat.shiftl</span> <span class="mi">3</span> <span class="mi">0b0000001</span>
<span class="kd">end</span> <span class="n">ast</span>
</code></pre></div>



<a name="213042356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213042356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213042356">(Oct 12 2020 at 14:04)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> How does this partitioning look?</p>



<a name="213043593"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213043593" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213043593">(Oct 12 2020 at 14:14)</a>:</h4>
<p><code>s/ast/inst/g</code>. Not quite a tree...</p>



<a name="213043888"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213043888" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213043888">(Oct 12 2020 at 14:17)</a>:</h4>
<p>why the <code>match</code> on branch conditions, instead of putting it in the top level?</p>



<a name="213044198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213044198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213044198">(Oct 12 2020 at 14:19)</a>:</h4>
<p>Unless <code>funct7</code> is actually 3 bits above <code>funct3</code>, you probably shouldn't mix them like that, and instead either return an inductive type (with a case for <code>funct3</code> and another for <code>funct3 + funct7</code>), or a precomposed <code>nat</code> containing the entire instruction (using auxiliary functions <code>type_1 : funct3 -&gt; nat</code> and <code>type_2 : funct3 -&gt; funct7 -&gt; nat</code>)</p>



<a name="213044356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213044356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213044356">(Oct 12 2020 at 14:21)</a>:</h4>
<p>Actually I should shift it more than 3, as they are a fixed distance across. This is consistent for all 32-bit instructions.</p>



<a name="213044443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213044443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213044443">(Oct 12 2020 at 14:21)</a>:</h4>
<p>That match will be moved. I'm currently enumerating the opcodes of interest to map them to formats; then I'll write an encoder and decoder which masks appropriately.</p>



<a name="213044520"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213044520" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213044520">(Oct 12 2020 at 14:22)</a>:</h4>
<p>I mean you have those instruction formats, right? you should keep them separate until you have all the fields</p>



<a name="213044854"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213044854" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213044854">(Oct 12 2020 at 14:25)</a>:</h4>
<p>The format only decides the layout of the immediates and which are present between <code>rd rs1 rs2 funct3 funct7</code>. <code>funct7</code> "doesn't exist for immediates" but there are a few immediates which effectively use it. Specifically the shift right arithmetic. So it "acts" half-way between I and R.</p>



<a name="213045093"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213045093" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213045093">(Oct 12 2020 at 14:27)</a>:</h4>
<p>that is, you can define</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">fmt_R</span> <span class="o">(</span><span class="n">opcode7</span> <span class="n">funct3</span> <span class="n">funct7</span> <span class="n">rd</span> <span class="n">rs1</span> <span class="n">rs2</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">nat</span> <span class="o">:=</span>
<span class="n">opcode7</span> <span class="bp">+</span> <span class="n">rd.shiftl</span> <span class="mi">7</span> <span class="bp">+</span> <span class="n">funct3.shiftl</span> <span class="mi">12</span> <span class="bp">+</span>
<span class="n">rs1.shiftl</span> <span class="mi">15</span> <span class="bp">+</span> <span class="n">rs2.shiftl</span> <span class="mi">20</span> <span class="bp">+</span> <span class="n">funct7.shiftl</span> <span class="mi">25</span>
</code></pre></div>

<p>and then write <code>encode : ast -&gt; nat</code> that calls <code>fmt_R</code> for R-type instructions</p>



<a name="213045183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213045183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213045183">(Oct 12 2020 at 14:28)</a>:</h4>
<p>and <code>fmt_I</code> doesn't have a <code>funct7</code> argument so there is no bad typing</p>



<a name="213047137"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213047137" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213047137">(Oct 12 2020 at 14:42)</a>:</h4>
<p>The format only influences decoding (as we need to know how to mask the correct values out); and for the immediate layout while encoding. The encoder can assume every instruction has an opcode, has all the registers, and has both function parts without caring about the format.</p>



<a name="213047315"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213047315" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213047315">(Oct 12 2020 at 14:44)</a>:</h4>
<p>Only the immediate explosion depends on the format -- for encoding. Actually decoding could probably be pretty lazy too.</p>



<a name="213048663"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213048663" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213048663">(Oct 12 2020 at 14:54)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="kd">def</span> <span class="n">opcode.encode</span> <span class="o">:</span> <span class="n">opcode</span> <span class="bp">→</span> <span class="n">nat</span> <span class="o">:=</span> <span class="n">sorry</span>

  <span class="kd">def</span> <span class="n">branch_funct3</span> <span class="o">:</span> <span class="n">compare</span> <span class="bp">→</span> <span class="n">nat</span>
  <span class="bp">|</span> <span class="n">eq</span> <span class="o">:=</span> <span class="mi">0b000</span>
  <span class="bp">|</span> <span class="n">ne</span> <span class="o">:=</span> <span class="mi">0b001</span>
  <span class="bp">|</span> <span class="n">lt</span> <span class="o">:=</span> <span class="mi">0b100</span>
  <span class="bp">|</span> <span class="n">ge</span> <span class="o">:=</span> <span class="mi">0b101</span>
  <span class="bp">|</span> <span class="n">ltu</span> <span class="o">:=</span> <span class="mi">0b110</span>
  <span class="bp">|</span> <span class="n">gtu</span> <span class="o">:=</span> <span class="mi">0b111</span>

  <span class="kd">def</span> <span class="n">B_type</span> <span class="o">(</span><span class="n">opcode</span> <span class="n">funct3</span> <span class="n">rs1</span> <span class="n">rs2</span> <span class="n">imm</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">nat</span> <span class="o">:=</span> <span class="n">sorry</span>
  <span class="kd">def</span> <span class="n">J_type</span> <span class="o">(</span><span class="n">opcode</span> <span class="n">rd</span> <span class="n">imm</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">nat</span> <span class="o">:=</span> <span class="n">sorry</span>
  <span class="kd">def</span> <span class="n">I_type</span> <span class="o">(</span><span class="n">opcode</span> <span class="n">funct3</span> <span class="n">rd</span> <span class="n">rs1</span> <span class="n">imm</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">nat</span> <span class="o">:=</span> <span class="n">sorry</span>
  <span class="kd">def</span> <span class="n">R_type</span> <span class="o">(</span><span class="n">opcode</span> <span class="n">funct3</span> <span class="n">funct7</span> <span class="n">rd</span> <span class="n">rs1</span> <span class="n">rs2</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">nat</span> <span class="o">:=</span> <span class="n">sorry</span>

  <span class="kd">def</span> <span class="n">encode_arith</span> <span class="o">:</span> <span class="n">arithmetic</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">×</span> <span class="n">ℕ</span>
  <span class="bp">|</span> <span class="n">add</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">0b000</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
  <span class="bp">|</span> <span class="n">sub</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">0b000</span><span class="o">,</span> <span class="mi">0b0100000</span><span class="o">)</span>
  <span class="bp">|</span> <span class="n">sll</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">0b001</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
  <span class="bp">|</span> <span class="n">slt</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">0b010</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
  <span class="bp">|</span> <span class="n">sltu</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">0b011</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
  <span class="bp">|</span> <span class="n">srl</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">0b101</span><span class="o">,</span> <span class="mi">0b0100000</span><span class="o">)</span>
  <span class="bp">|</span> <span class="n">sra</span> <span class="o">:=</span> <span class="o">(</span><span class="mi">0b101</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
  <span class="bp">|</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">sorry</span>

  <span class="kd">def</span> <span class="n">encode</span> <span class="o">:</span> <span class="n">ast</span> <span class="bp">-&gt;</span> <span class="n">nat</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">branch</span> <span class="n">c</span> <span class="n">rs1</span> <span class="n">rs2</span> <span class="n">off</span><span class="o">)</span> <span class="o">:=</span> <span class="n">B_type</span> <span class="n">opcode.branch.encode</span> <span class="o">(</span><span class="n">branch_funct3</span> <span class="n">c</span><span class="o">)</span> <span class="n">rs1</span> <span class="n">rs2</span> <span class="n">off</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">jump</span> <span class="n">reg</span> <span class="o">(</span><span class="n">some</span> <span class="n">rs1</span><span class="o">)</span> <span class="n">off</span><span class="o">)</span> <span class="o">:=</span> <span class="n">I_type</span> <span class="n">opcode.jalr.encode</span> <span class="mi">0b000</span> <span class="n">reg</span> <span class="n">rs1</span> <span class="n">off</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">jump</span> <span class="n">reg</span> <span class="n">none</span> <span class="n">off</span><span class="o">)</span> <span class="o">:=</span> <span class="n">J_type</span> <span class="n">opcode.jal.encode</span> <span class="n">reg</span> <span class="n">off</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">op</span> <span class="n">w</span> <span class="n">rd</span> <span class="n">rs1</span> <span class="o">(</span><span class="n">reg_imm.reg</span> <span class="n">rs2</span><span class="o">))</span> <span class="o">:=</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">funct3</span><span class="o">,</span> <span class="n">funct7</span><span class="o">)</span> <span class="o">:=</span> <span class="n">encode_arith</span> <span class="n">op</span> <span class="k">in</span>
    <span class="n">R_type</span> <span class="o">(</span><span class="k">if</span> <span class="n">w</span> <span class="k">then</span> <span class="n">opcode.op_32</span> <span class="k">else</span> <span class="n">opcode.op</span><span class="o">)</span><span class="bp">.</span><span class="n">encode</span> <span class="n">funct3</span> <span class="n">funct7</span> <span class="n">rd</span> <span class="n">rs1</span> <span class="n">rs2</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">arith</span> <span class="n">op</span> <span class="n">w</span> <span class="n">rd</span> <span class="n">rs1</span> <span class="o">(</span><span class="n">reg_imm.imm</span> <span class="n">imm</span><span class="o">))</span> <span class="o">:=</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">funct3</span><span class="o">,</span> <span class="n">_</span><span class="o">)</span> <span class="o">:=</span> <span class="n">encode_arith</span> <span class="n">op</span> <span class="k">in</span>
    <span class="n">I_type</span> <span class="o">(</span><span class="k">if</span> <span class="n">w</span> <span class="k">then</span> <span class="n">opcode.op_imm_32</span> <span class="k">else</span> <span class="n">opcode.op_imm</span><span class="o">)</span><span class="bp">.</span><span class="n">encode</span> <span class="n">funct3</span> <span class="n">rd</span> <span class="n">rs1</span> <span class="n">imm</span>
  <span class="bp">|</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">sorry</span>
</code></pre></div>



<a name="213049016"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049016" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049016">(Oct 12 2020 at 14:57)</a>:</h4>
<p>I'm ignoring the funct7 field of arith with immediate here, I suppose that means that <code>subi</code> doesn't exist?</p>



<a name="213049107"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049107" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049107">(Oct 12 2020 at 14:58)</a>:</h4>
<p>Well, <code>subi</code> doesn't exist anyway.</p>



<a name="213049176"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049176" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049176">(Oct 12 2020 at 14:59)</a>:</h4>
<p>yeah, the type of this function doesn't really allow for error handling so I guess it doesn't matter what it does in that case</p>



<a name="213049183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049183">(Oct 12 2020 at 14:59)</a>:</h4>
<p>But <code>srli</code> does.</p>



<a name="213049204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049204">(Oct 12 2020 at 14:59)</a>:</h4>
<p>oh?</p>



<a name="213049334"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049334" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049334">(Oct 12 2020 at 15:00)</a>:</h4>
<p>Yes, the shifts are the exception to the format rule here; they don't fit in any of them. :P</p>



<a name="213049389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049389">(Oct 12 2020 at 15:00)</a>:</h4>
<p>no ISA is complete without a few exceptions to the rule</p>



<a name="213049399"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049399" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049399">(Oct 12 2020 at 15:00)</a>:</h4>
<p>Because you encode the shift amount in the lower bits of the immediate; the upper bits are all zeros except for the single bit which indicates if a right shift is arithmetic vs logical.</p>



<a name="213049427"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049427" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049427">(Oct 12 2020 at 15:00)</a>:</h4>
<p>arithmetic means sign-extended shift.</p>



<a name="213049784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049784">(Oct 12 2020 at 15:03)</a>:</h4>
<p>ah, the funct7 bits are switched between <code>srl</code> and <code>sra</code></p>



<a name="213049961"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213049961" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213049961">(Oct 12 2020 at 15:04)</a>:</h4>
<p>Yeah I noticed that while splitting the funct7 out to its own function.</p>



<a name="213051678"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213051678" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213051678">(Oct 12 2020 at 15:18)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="kd">def</span> <span class="n">encode</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">inst</span><span class="o">)</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="o">:=</span>
  <span class="n">i.get_opcode.to_nat</span> <span class="bp">+</span> <span class="n">i.rd.shiftl</span> <span class="mi">7</span> <span class="bp">+</span> <span class="n">i.funct3.shiftl</span> <span class="mi">12</span>
  <span class="bp">+</span> <span class="n">i.rs1.shiftl</span> <span class="mi">15</span> <span class="bp">+</span> <span class="n">i.rs2.shiftl</span> <span class="mi">20</span> <span class="bp">+</span> <span class="n">i.funct7.shiftl</span> <span class="mi">25</span> <span class="bp">+</span> <span class="n">i.imm</span>
</code></pre></div>



<a name="213051707"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213051707" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213051707">(Oct 12 2020 at 15:18)</a>:</h4>
<p>This works for all 32-bit instructions.</p>



<a name="213051785"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213051785" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213051785">(Oct 12 2020 at 15:19)</a>:</h4>
<p>The format only influences the positions of the immediates. :)</p>



<a name="213052123"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213052123" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213052123">(Oct 12 2020 at 15:21)</a>:</h4>
<p>Returning to the magic metaprogramming we started with; implemented for all instructions. I'll adapt this to the opcode, funct3, and funct7 mapping to get bidirectional maps.</p>



<a name="213052332"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213052332" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213052332">(Oct 12 2020 at 15:23)</a>:</h4>
<p>Actually. I may take it a step further regarding the opcode map. To actually use the rows/columns to encode them. :)  Which is basically just the binary count of the position +3 while skipping any where the lower 5 bits are all high.</p>



<a name="213052399"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213052399" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213052399">(Oct 12 2020 at 15:24)</a>:</h4>
<p>The condition map is at least a direct count. Is there a <code>@[derive to_nat]</code> for inductives?</p>



<a name="213052785"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213052785" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213052785">(Oct 12 2020 at 15:27)</a>:</h4>
<p>The point of the different functions is to make it easier to express which format a given instruction has, so that you have to pass 6 arguments vs 7 and such</p>



<a name="213052931"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213052931" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213052931">(Oct 12 2020 at 15:28)</a>:</h4>
<p>Regarding the opcode inductive, you could just skip it and put numbers in where I had things like <code>opcode.op.encode</code></p>



<a name="213053179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213053179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213053179">(Oct 12 2020 at 15:30)</a>:</h4>
<p>There is no <code>derive to_nat</code>, although it wouldn't be hard to autogenerate</p>



<a name="213053187"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213053187" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213053187">(Oct 12 2020 at 15:30)</a>:</h4>
<p>Could.</p>



<a name="213053206"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213053206" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213053206">(Oct 12 2020 at 15:30)</a>:</h4>
<p>Probably will.</p>



<a name="213053263"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213053263" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213053263">(Oct 12 2020 at 15:31)</a>:</h4>
<p>But it is nice to have the full list and to use them by-name to avoid mistakes. But this'll be verified eventually anyway... So it would be fine to just put the numbers.</p>



<a name="213053312"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213053312" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213053312">(Oct 12 2020 at 15:31)</a>:</h4>
<p>You can also skip the inductive and instead do <code>def opcode.op := 0b0100011</code> or whatever</p>



<a name="213053476"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213053476" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213053476">(Oct 12 2020 at 15:33)</a>:</h4>
<p>True. Although the biggest detail for annoyance will be flipping the encoder to decode; ideally using the metaprogramming trick to avoid the duplication.</p>



<a name="213055508"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213055508" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213055508">(Oct 12 2020 at 15:51)</a>:</h4>
<p>!! Lean's language server appears to have a memory leak?</p>



<a name="213055538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213055538" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213055538">(Oct 12 2020 at 15:51)</a>:</h4>
<p>Filled my ram to 100% started using emergency swap. o.o</p>



<a name="213066996"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213066996" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213066996">(Oct 12 2020 at 17:42)</a>:</h4>
<p>keep your finger on the <code>Lean: Restart</code> button</p>



<a name="213150980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213150980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213150980">(Oct 13 2020 at 13:08)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I'm stuck again with generating definitions. Is there anything stopping an interface for constructing these a la <code>`(«def» q := 3)</code> or just with <code>def</code> as it is obvious that we're inside an opened parenthesis so it mustn't be a command anyway. </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">run_cmd</span> <span class="o">[</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">load</span><span class="o">,</span>   <span class="bp">`</span><span class="n">load_fp</span><span class="o">,</span>  <span class="bp">`</span><span class="n">custom_0</span><span class="o">,</span> <span class="bp">`</span><span class="n">misc_mem</span><span class="o">,</span> <span class="bp">`</span><span class="n">op_imm</span><span class="o">,</span>   <span class="bp">`</span><span class="n">auipc</span><span class="o">,</span>      <span class="bp">`</span><span class="n">op_imm_32</span><span class="o">],</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">store</span><span class="o">,</span>  <span class="bp">`</span><span class="n">store_fp</span><span class="o">,</span> <span class="bp">`</span><span class="n">custom_1</span><span class="o">,</span> <span class="bp">`</span><span class="n">amo</span><span class="o">,</span>      <span class="bp">`</span><span class="n">op</span><span class="o">,</span>       <span class="bp">`</span><span class="n">lui</span><span class="o">,</span>        <span class="bp">`</span><span class="n">op_32</span>    <span class="o">],</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">madd</span><span class="o">,</span>   <span class="bp">`</span><span class="n">msub</span><span class="o">,</span>     <span class="bp">`</span><span class="n">nmsub</span><span class="o">,</span>    <span class="bp">`</span><span class="n">nmadd</span><span class="o">,</span>    <span class="bp">`</span><span class="n">op_fp</span><span class="o">,</span>    <span class="bp">`</span><span class="n">reserved_0</span><span class="o">,</span> <span class="bp">`</span><span class="n">custom_2</span> <span class="o">],</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">branch</span><span class="o">,</span> <span class="bp">`</span><span class="n">jalr</span><span class="o">,</span>     <span class="bp">`</span><span class="n">reserved</span><span class="o">,</span> <span class="bp">`</span><span class="n">jal</span><span class="o">,</span>      <span class="bp">`</span><span class="n">system</span><span class="o">,</span>   <span class="bp">`</span><span class="n">reserved_1</span><span class="o">,</span> <span class="bp">`</span><span class="n">custom_3</span> <span class="o">]</span>
  <span class="o">]</span><span class="bp">.</span><span class="n">enum</span> <span class="bp">&gt;&gt;=</span> <span class="bp">λ</span> <span class="o">⟨</span><span class="n">i</span><span class="o">,</span> <span class="n">n</span><span class="o">⟩,</span> <span class="n">n.enum</span> <span class="bp">&gt;&gt;=</span> <span class="bp">λ</span> <span class="o">⟨</span><span class="n">j</span><span class="o">,</span> <span class="n">n</span><span class="o">⟩,</span> <span class="c">/-</span><span class="cm"> def n := 3 + j.shiftl 2 + i.shiftl 5 -/</span>
</code></pre></div>



<a name="213151096"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213151096" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213151096">(Oct 13 2020 at 13:09)</a>:</h4>
<p>well commands are not expressions, so  that doesn't work literally</p>



<a name="213151221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213151221" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213151221">(Oct 13 2020 at 13:10)</a>:</h4>
<p>or any similar interface if not exactly using the expr-quotes.</p>



<a name="213151318"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213151318" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213151318">(Oct 13 2020 at 13:12)</a>:</h4>
<p>I mean for the longest time there wasn't even an API to add defs at all (with all the bells and whistles)</p>



<a name="213151565"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213151565" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213151565">(Oct 13 2020 at 13:13)</a>:</h4>
<p>you can use <code>tactic.add_decl</code>, I think that might not add equation lemmas though</p>



<a name="213151775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213151775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213151775">(Oct 13 2020 at 13:15)</a>:</h4>
<p>there is also <code>environment.add_defn_eqns</code> for more advanced definitions</p>



<a name="213151901"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213151901" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213151901">(Oct 13 2020 at 13:16)</a>:</h4>
<p>Re reducing variations. I've arrived at embedding the width in the register and using an "alt" flag. Usually to distinguish between (un)signed operations, though also to select the high half of mults (which then respects source register (un)sign flags). This lines up well for tuning the operations.</p>



<a name="213151921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213151921" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213151921">(Oct 13 2020 at 13:16)</a>:</h4>
<p>Anyway lean 4 will add something a lot like you are proposing; quotation and antiquotation now works on every syntactic class</p>



<a name="213152273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213152273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213152273">(Oct 13 2020 at 13:18)</a>:</h4>
<p>Awesome. When I started with Lean, I dove into Lean 4's code ... then I found myself writing Lean 4 by mistake. :P</p>



<a name="213152315"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213152315" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213152315">(Oct 13 2020 at 13:19)</a>:</h4>
<p>As in, while using lean3.</p>



<a name="213153151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213153151" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213153151">(Oct 13 2020 at 13:25)</a>:</h4>
<p>I was trying to use <code>tactic.add_defn_equations</code> before; though with <code>add_decl</code>, I feel much closer but have hit at least an issue with lists/tactics/monad switching... Not sure how to fix this in Lean...</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="kd">run_cmd</span> <span class="o">[</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">load</span><span class="o">,</span>   <span class="bp">`</span><span class="n">load_fp</span><span class="o">,</span>  <span class="bp">`</span><span class="n">custom_0</span><span class="o">,</span> <span class="bp">`</span><span class="n">misc_mem</span><span class="o">,</span> <span class="bp">`</span><span class="n">op_imm</span><span class="o">,</span>   <span class="bp">`</span><span class="n">auipc</span><span class="o">,</span>      <span class="bp">`</span><span class="n">op_imm_32</span><span class="o">],</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">store</span><span class="o">,</span>  <span class="bp">`</span><span class="n">store_fp</span><span class="o">,</span> <span class="bp">`</span><span class="n">custom_1</span><span class="o">,</span> <span class="bp">`</span><span class="n">amo</span><span class="o">,</span>      <span class="bp">`</span><span class="n">op</span><span class="o">,</span>       <span class="bp">`</span><span class="n">lui</span><span class="o">,</span>        <span class="bp">`</span><span class="n">op_32</span>    <span class="o">],</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">madd</span><span class="o">,</span>   <span class="bp">`</span><span class="n">msub</span><span class="o">,</span>     <span class="bp">`</span><span class="n">nmsub</span><span class="o">,</span>    <span class="bp">`</span><span class="n">nmadd</span><span class="o">,</span>    <span class="bp">`</span><span class="n">op_fp</span><span class="o">,</span>    <span class="bp">`</span><span class="n">reserved_0</span><span class="o">,</span> <span class="bp">`</span><span class="n">custom_2</span> <span class="o">],</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">branch</span><span class="o">,</span> <span class="bp">`</span><span class="n">jalr</span><span class="o">,</span>     <span class="bp">`</span><span class="n">reserved</span><span class="o">,</span> <span class="bp">`</span><span class="n">jal</span><span class="o">,</span>      <span class="bp">`</span><span class="n">system</span><span class="o">,</span>   <span class="bp">`</span><span class="n">reserved_1</span><span class="o">,</span> <span class="bp">`</span><span class="n">custom_3</span> <span class="o">]</span>
  <span class="o">]</span><span class="bp">.</span><span class="n">enum</span> <span class="bp">&gt;&gt;=</span> <span class="bp">λ</span> <span class="o">⟨</span><span class="n">i</span><span class="o">,</span> <span class="n">n</span><span class="o">⟩,</span> <span class="n">n.enum</span> <span class="bp">&gt;&gt;=</span> <span class="bp">λ</span> <span class="o">⟨</span><span class="n">j</span><span class="o">,</span> <span class="n">n</span><span class="o">⟩,</span>
  <span class="n">tactic.add_decl</span> <span class="o">(</span><span class="n">declaration.defn</span> <span class="n">n</span> <span class="o">[]</span> <span class="bp">`</span><span class="o">(</span><span class="n">ℕ</span><span class="o">)</span> <span class="bp">`</span><span class="o">(</span><span class="mi">3</span> <span class="bp">+</span> <span class="n">j.shiftl</span> <span class="mi">2</span> <span class="bp">+</span> <span class="n">i.shiftl</span> <span class="mi">5</span><span class="o">)</span>
                     <span class="n">reducibility_hints.abbrev</span> <span class="n">tt</span><span class="o">)</span>
</code></pre></div>



<a name="213153956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213153956" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213153956">(Oct 13 2020 at 13:31)</a>:</h4>
<p>There we go. <code>.mmap</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="kd">run_cmd</span> <span class="o">[</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">load</span><span class="o">,</span>   <span class="bp">`</span><span class="n">load_fp</span><span class="o">,</span>  <span class="bp">`</span><span class="n">custom_0</span><span class="o">,</span> <span class="bp">`</span><span class="n">misc_mem</span><span class="o">,</span> <span class="bp">`</span><span class="n">op_imm</span><span class="o">,</span>   <span class="bp">`</span><span class="n">auipc</span><span class="o">,</span>      <span class="bp">`</span><span class="n">op_imm_32</span><span class="o">],</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">store</span><span class="o">,</span>  <span class="bp">`</span><span class="n">store_fp</span><span class="o">,</span> <span class="bp">`</span><span class="n">custom_1</span><span class="o">,</span> <span class="bp">`</span><span class="n">amo</span><span class="o">,</span>      <span class="bp">`</span><span class="n">op</span><span class="o">,</span>       <span class="bp">`</span><span class="n">lui</span><span class="o">,</span>        <span class="bp">`</span><span class="n">op_32</span>    <span class="o">],</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">madd</span><span class="o">,</span>   <span class="bp">`</span><span class="n">msub</span><span class="o">,</span>     <span class="bp">`</span><span class="n">nmsub</span><span class="o">,</span>    <span class="bp">`</span><span class="n">nmadd</span><span class="o">,</span>    <span class="bp">`</span><span class="n">op_fp</span><span class="o">,</span>    <span class="bp">`</span><span class="n">reserved_0</span><span class="o">,</span> <span class="bp">`</span><span class="n">custom_2</span> <span class="o">],</span>
    <span class="o">[</span><span class="bp">`</span><span class="n">branch</span><span class="o">,</span> <span class="bp">`</span><span class="n">jalr</span><span class="o">,</span>     <span class="bp">`</span><span class="n">reserved</span><span class="o">,</span> <span class="bp">`</span><span class="n">jal</span><span class="o">,</span>      <span class="bp">`</span><span class="n">system</span><span class="o">,</span>   <span class="bp">`</span><span class="n">reserved_1</span><span class="o">,</span> <span class="bp">`</span><span class="n">custom_3</span> <span class="o">]</span>
  <span class="o">]</span><span class="bp">.</span><span class="n">enum.mmap</span> <span class="bp">$</span> <span class="bp">λ</span> <span class="o">⟨</span><span class="n">i</span><span class="o">,</span> <span class="n">n</span><span class="o">⟩,</span> <span class="n">n.enum.mmap</span> <span class="bp">$</span> <span class="bp">λ</span> <span class="o">⟨</span><span class="n">j</span><span class="o">,</span> <span class="n">n</span><span class="o">⟩,</span>
  <span class="n">tactic.add_decl</span> <span class="o">(</span><span class="n">declaration.defn</span> <span class="n">n</span> <span class="o">[]</span> <span class="bp">`</span><span class="o">(</span><span class="n">ℕ</span><span class="o">)</span> <span class="bp">`</span><span class="o">(</span><span class="mi">3</span> <span class="bp">+</span> <span class="n">j.shiftl</span> <span class="mi">2</span> <span class="bp">+</span> <span class="n">i.shiftl</span> <span class="mi">5</span><span class="o">)</span>
                     <span class="n">reducibility_hints.abbrev</span> <span class="n">tt</span><span class="o">)</span>
</code></pre></div>



<a name="213154060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154060" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154060">(Oct 13 2020 at 13:32)</a>:</h4>
<p>you probably want <code>mmap'</code> there since you aren't returning anything</p>



<a name="213154221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154221" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154221">(Oct 13 2020 at 13:33)</a>:</h4>
<p>you may or may not want to precompute those numbers btw, by using <code>let n := 3 + j.shiftl 2 + i.shiftl 5 in reflect n</code></p>



<a name="213154367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154367" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154367">(Oct 13 2020 at 13:34)</a>:</h4>
<p>oh, actually what you have definitely won't work because you haven't antiquoted <code>i</code> and <code>j</code></p>



<a name="213154368"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154368" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154368">(Oct 13 2020 at 13:34)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c">/-</span><span class="cm"></span>
<span class="cm">invalid field notation, 'branch' is not a valid "field" because environment does not contain 'nat.branch'</span>
<span class="cm">  op</span>
<span class="cm">which has type</span>
<span class="cm">  ℕ</span>
<span class="cm">-/</span>
</code></pre></div>



<a name="213154420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154420">(Oct 13 2020 at 13:35)</a>:</h4>
<p>did you write <code>op.branch</code> somewhere?</p>



<a name="213154467"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154467" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154467">(Oct 13 2020 at 13:35)</a>:</h4>
<p>Yes. And I'm running the <code>run_cmd</code> inside the <code>op</code> namespace.</p>



<a name="213154584"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154584" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154584">(Oct 13 2020 at 13:36)</a>:</h4>
<p>you might want to qualify those names, <code>op</code> is kind of general for an unqualified name</p>



<a name="213154630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154630" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154630">(Oct 13 2020 at 13:36)</a>:</h4>
<p>It seems to be clobbering the namespace... does the <code>add_decl</code> bypass the namespace?</p>



<a name="213154673"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154673" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154673">(Oct 13 2020 at 13:37)</a>:</h4>
<p>Seem so. <code>(`op ++ n) </code> worked.</p>



<a name="213154691"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154691" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154691">(Oct 13 2020 at 13:37)</a>:</h4>
<p>Yeah, you said <code>add_decl `op</code> so it's making a definition called <code> `op</code></p>



<a name="213154790"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154790" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154790">(Oct 13 2020 at 13:38)</a>:</h4>
<p>you can sometimes use <code> ``op</code> to do name resolution but it won't work here because the thing doesn't exist yet</p>



<a name="213154840"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154840" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154840">(Oct 13 2020 at 13:38)</a>:</h4>
<p>Makes sense. I assumed the namespace would inject itself but I guess that only affects the commands. The tactic just bypasses it.</p>



<a name="213154972"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213154972" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213154972">(Oct 13 2020 at 13:39)</a>:</h4>
<p>Current code -&gt; <a href="https://gist.github.com/4d56511885f5b44514b0fcf006a5546a">https://gist.github.com/4d56511885f5b44514b0fcf006a5546a</a></p>



<a name="213156504"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213156504" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213156504">(Oct 13 2020 at 13:50)</a>:</h4>
<p>Any more tips <span class="user-mention" data-user-id="110049">@Mario Carneiro</span>?</p>



<a name="213156775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213156775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213156775">(Oct 13 2020 at 13:52)</a>:</h4>
<p>It seems a bit odd to put the alt flag in the register instead of the instruction</p>



<a name="213157199"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213157199" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213157199">(Oct 13 2020 at 13:54)</a>:</h4>
<p>The flag basically means that the register itself is treated as signed in most cases. The mul is the only deviation, where <code>rd.alt</code> means it acts on the high half of the result, but then the <code>rs1.alt</code> and <code>rs2.alt</code> represent their own signs.</p>



<a name="213170555"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213170555" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213170555">(Oct 13 2020 at 15:15)</a>:</h4>
<p>I found one edge case with my approach with the type tagged registers (the alt flag). I can't encode one variant of the the SRAI hint, where the immediate is zero; because I use the sign of the immediate to differentiate between left and right shifts. The alt in this case applies to the destination, to distinguish logical vs signed arithmetic shifts. One minor edge case!</p>



<a name="213170755"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213170755" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213170755">(Oct 13 2020 at 15:16)</a>:</h4>
<p>I could specially encode this with its own hack... but I'll leave it out for now.</p>



<a name="213171953"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213171953" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213171953">(Oct 13 2020 at 15:23)</a>:</h4>
<p>Considering it is a single unused custom hint; which may never be used... pretty safe to ignore. :)</p>



<a name="213172787"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213172787" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213172787">(Oct 13 2020 at 15:28)</a>:</h4>
<p>Actually... I just overconstrained it. I don't care about the direction in this position because it has already been declared that it is an arithmetic shift; which is only valid for right shifts.</p>



<a name="213175521"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213175521" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213175521">(Oct 13 2020 at 15:45)</a>:</h4>
<p>Actually the hint issue does exist; <code>SRL</code> with <code>rd = x0</code> and <code>imm = 0</code> is inexpressible.</p>



<a name="213397329"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/213397329" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> SnowFox <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#213397329">(Oct 15 2020 at 09:04)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Major update. Still a lot left to do. Now the registers may only be legally composed for each of the instructions. This should cover all of <code>RV{32,64,128}IMFDQZicsr</code>, or soon. I need to do another pass over all the variations. The core instruction type unifies all these extensions well. Abstracting over int vs float, (un)signed, and all widths.  <a href="https://gist.github.com/4d56511885f5b44514b0fcf006a5546a">https://gist.github.com/4d56511885f5b44514b0fcf006a5546a</a></p>



<a name="295636743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/295636743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#295636743">(Aug 27 2022 at 20:05)</a>:</h4>
<p>I'm interested in getting RISC-V semantics in Lean to help with my STARK verification project. Sorry to resurrect a two-year old thread, but I thought I'd ask <span class="user-mention" data-user-id="328454">@SnowFox</span> , did you do any more work on this? Is there any repository you have that I could potentially use?</p>



<a name="295637229"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/295637229" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Karl Palmskog <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#295637229">(Aug 27 2022 at 20:12)</a>:</h4>
<p>maybe useful for RISC-V specification: <a href="https://github.com/rems-project/sail">https://github.com/rems-project/sail</a>  <a href="https://github.com/mit-plv/riscv-coq">https://github.com/mit-plv/riscv-coq</a></p>



<a name="295637832"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/295637832" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#295637832">(Aug 27 2022 at 20:21)</a>:</h4>
<p>I have heard of this project, and in fact it's at the top of the list for what my team is considering using now. The only issue is that it's written in Coq, and I would prefer to use Lean.</p>



<a name="295637867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/295637867" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Karl Palmskog <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#295637867">(Aug 27 2022 at 20:21)</a>:</h4>
<p>you could add a Lean backend to Sail (possibly following the Coq backend for Sail)</p>



<a name="295638043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/295638043" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#295638043">(Aug 27 2022 at 20:23)</a>:</h4>
<p>That sounds like it could be the path of least resistance. Thanks!</p>



<a name="295713408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/295713408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrés Goens <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#295713408">(Aug 28 2022 at 13:57)</a>:</h4>
<p>I would also be very interested in that (adding such a Lean backend to Sail)</p>



<a name="295812164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/295812164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sofia Snow <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#295812164">(Aug 29 2022 at 09:52)</a>:</h4>
<p><span class="user-mention" data-user-id="282271">@Bolton Bailey</span>, <span class="user-mention" data-user-id="198375">@Karl Palmskog</span>, <span class="user-mention" data-user-id="315434">@Andrés Goens</span>: Yes, work continued, but along a few different dimensions, very incomplete and I've been meaning to get back to this. <a href="https://gist.github.com/sofia-snow/31b32cc03c433faedde58ef63db08b0e">https://gist.github.com/sofia-snow/31b32cc03c433faedde58ef63db08b0e</a></p>
<p>Notably this design focuses on dataflow operations and expressing all the variations with minimal explosion. All control flow is factored out and will be handled by an RVSDG based IR. Ex. Conditional branches will be encoded as <code>slt</code> simple nodes composed with gamma nodes, fused respectively when encoding.</p>
<p>I've shifted focus towards other components of my compiler, notably the type theory, and optimizer. No repository yet. I welcome collaborating with others.</p>
<p>I'd like to integrate it with sail, but I feel that sail is too low level and anything it generates promotes poor interfaces. I'm after a higher level specification which can generate all which sail does, and more, with appropriate abstractions. Thus can generate similar output to sail and cross-verify their consistency.</p>



<a name="295815325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/295815325" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sofia Snow <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#295815325">(Aug 29 2022 at 10:16)</a>:</h4>
<p>CSRs and memory accesses need state edges, RVSDG models partial orderings for states. A tweak to RVSDG I've applied is to make states linear and use an additional node which acts like gamma (generalized switch statement) to partition and join state rather than choice. Notably along with this, strict memory partitioning. My exact memory model isn't yet written down but it'll allow mutable sharing when explicitly stated as intentional.</p>



<a name="295815981"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/295815981" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sofia Snow <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#295815981">(Aug 29 2022 at 10:20)</a>:</h4>
<p>Similar to Lean's totality checker, some uses can be proven eventually consistent for all orders, but others may require manual proofs, or you may explicitly allow divergence.</p>



<a name="295817790"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/295817790" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sofia Snow <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#295817790">(Aug 29 2022 at 10:34)</a>:</h4>
<p>Also notable I'll be using an E-graph representation extending RVSDG to run equality saturation, using user-defined and user-proven rewrites. Meaning it'll represent an exponentially large set of equivalent programs, then use an SMT solver to select the optimal program per a cost function (for each dimension along the Pareto frontier of the cost function), and I want a full correctness proof from the source language (very Lean like syntax, with resource grades for exact or bounded usage and taint tracking (notably sensitive data may not be published or leaked through side channels)); to the machine code (at least RISC-V and WebAssembly; if successful, may consider SPIR-V or a tiny subset of x86_64 or arm64).</p>
<p>RVSDG.</p>
<p><a href="https://arxiv.org/abs/1912.05036">https://arxiv.org/abs/1912.05036</a><br>
<a href="https://www.sintef.no/contentassets/11da6d67207348db98a30ddbdf3b0bba/reissmann_poster.pdf">https://www.sintef.no/contentassets/11da6d67207348db98a30ddbdf3b0bba/reissmann_poster.pdf</a></p>
<p>Equality saturation.</p>
<p><a href="https://arxiv.org/abs/1012.1802">https://arxiv.org/abs/1012.1802</a><br>
<a href="https://arxiv.org/abs/2004.03082">https://arxiv.org/abs/2004.03082</a><br>
<a href="https://arxiv.org/abs/2108.02290">https://arxiv.org/abs/2108.02290</a></p>



<a name="302398716"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/302398716" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrea Nardi <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#302398716">(Oct 05 2022 at 07:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="455721">Sofia Snow</span><br>
I wanted to work on a similar project for an optimizing compiler, but instead of assembly code it would optimize fpga netlists. In my mind it is very similat as working with a what you(and the literature) refer to as dataflow. In the fpga world (differently from cpus), every "operation" has a well defined and predictable "runtime" often referred to as latency in clock cycles. It would be interesting using equality saturation to optimize for latency. You could take it a step further and allow different possibly aproximative methods of calculation which have different accuracy (e.g. lookup table vs cordic for sin(x)) and pareto optimize for latency and accuracy.<br>
Did not know the method of saturation equality. Those seem like nice background material.</p>



<a name="302412501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/236449-Program%20verification/topic/RISC-V%20ISA%20in%20Lean/near/302412501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sofia Snow <a href="https://leanprover-community.github.io/archive/stream/236449-Program-verification/topic/RISC-V.20ISA.20in.20Lean.html#302412501">(Oct 05 2022 at 08:45)</a>:</h4>
<p>(Conversation continued in a private message.)</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>