---
layout: archive
title: Zulip Chat Archive
permalink: /stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/index.html">metaprogramming / tactics</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html">cancel_denoms exercise</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="214181630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214181630" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214181630">(Oct 22 2020 at 12:51)</a>:</h4>
<p><span class="user-mention" data-user-id="110596">@Rob Lewis</span>  As I am trying to learn Lean tactics, I sort of did the cancel_denoms exercise:<br>
<a href="/user_uploads/3121/XjNMfwBK5joWhoWzfmuhzMvC/cancel_denoms.lean">cancel_denoms.lean</a> <br>
Would you like to integrate it to mathlib? Notes:</p>
<ul>
<li>I defined <code>lcm</code> and <code>gcd</code> for rational numbers there. If you agree it is a reasonable definition, it could belong somewhere else.</li>
<li>It is still handling numerical values only. Handling general expression would be chalenging, I would need some sort of the least common multiple for polynomial expressions.</li>
<li>It is not a conservative extension -- some cases are handled a bit differently.</li>
</ul>



<a name="214237061"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214237061" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214237061">(Oct 22 2020 at 19:31)</a>:</h4>
<p><span class="user-mention" data-user-id="133339">@Miroslav Olšák</span> An improved <code>cancel_denoms</code> would be great to have in mathlib. It's only expected to handle numerical values, polynomial denominators are indeed much harder. Do the <code>linarith</code> tests pass using your <code>cancel_denoms</code> in place of the existing one? That would be a very good sign.</p>



<a name="214237087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214237087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214237087">(Oct 22 2020 at 19:31)</a>:</h4>
<p>I'm on vacation and won't be able to look at this until next week at the earliest.</p>



<a name="214237237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214237237" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214237237">(Oct 22 2020 at 19:32)</a>:</h4>
<p>But if you make a PR I'll review when I have time, or of course I don't mind if others review first!</p>



<a name="214249597"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214249597" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214249597">(Oct 22 2020 at 21:20)</a>:</h4>
<p>I am not sure how to perform the tests. Where are they? And if I just replace the file <code>cancel_denoms.lean</code> in the mathlib directory by mine, will Lean reload it? (as far as I understand, mathlib is somehow precompiled)</p>



<a name="214249614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214249614" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214249614">(Oct 22 2020 at 21:20)</a>:</h4>
<p>I hope that my version will work but there still could be some issues with zeroes, and it is also probably slower as it is handling fractions generally as <code>expr / expr</code>, and uses rational numbers instead of naturals.</p>



<a name="214249635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214249635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214249635">(Oct 22 2020 at 21:20)</a>:</h4>
<p>I can wait when you will have time. But help from someone else is also welcome.</p>



<a name="214249829"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214249829" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214249829">(Oct 22 2020 at 21:22)</a>:</h4>
<p>You can run the <code>linarith</code> tests locally by running <code>lean test/linarith.lean</code>.</p>
<p>You can also push your edits to a branch on the mathlib repo (do you need access?) and then the CI will run all the tests for you.</p>



<a name="214285547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214285547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214285547">(Oct 23 2020 at 08:26)</a>:</h4>
<p>OK, so it is not as easy to pass the tests. First it turned out that the function <code>derive</code> is actually necessary, so I implemented it again, and now it does not work for some reason. Could it be because I leave too much mess in the expression which is cleaned up by <code>norm_num</code> in the interactive version?<br>
Current version: <a href="/user_uploads/3121/0udOeJLjBnoXk3sPne7B17yu/cancel_denoms.lean">cancel_denoms.lean</a></p>



<a name="214615076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214615076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214615076">(Oct 26 2020 at 18:31)</a>:</h4>
<p><span class="user-mention" data-user-id="133339">@Miroslav Olšák</span> I've sent you an invite to the mathlib repository. Instead of sharing lean files here, it's much easier to discuss/comment on a git branch. <a href="https://github.com/leanprover-community/mathlib/tree/cancel-denoms-mirefek">https://github.com/leanprover-community/mathlib/tree/cancel-denoms-mirefek</a></p>



<a name="214615131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214615131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214615131">(Oct 26 2020 at 18:32)</a>:</h4>
<p>(I haven't made a PR yet. You should do that so you get the credit for it.)</p>



<a name="214615284"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214615284" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214615284">(Oct 26 2020 at 18:33)</a>:</h4>
<p>Indeed, <code>derive</code> is necessary and isn't strong enough in your version. You can see in the first failing <code>linarith</code> test what's going on:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.linarith</span>

<span class="kd">set_option</span> <span class="n">trace.linarith</span> <span class="n">true</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">A</span> <span class="n">B</span> <span class="o">:</span> <span class="n">ℚ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">A</span> <span class="bp">*</span> <span class="n">B</span><span class="o">)</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">A</span><span class="bp">*</span><span class="n">B</span><span class="bp">/</span><span class="mi">8</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">linarith</span>
<span class="kd">end</span>
</code></pre></div>



<a name="214615323"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214615323" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214615323">(Oct 26 2020 at 18:33)</a>:</h4>
<p>After the <code>cancel_denoms</code> preprocessing, you're left with </p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>Preprocessing: cancel denominators
[1 * (1 * (1 * A) * (1 * B)) / (1 / 8 * 8) ≤ 0, -(A * B) &lt; 0]
</code></pre></div>



<a name="214615434"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214615434" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214615434">(Oct 26 2020 at 18:34)</a>:</h4>
<p>The <code>1*</code>s shouldn't really matter, but the denominator isn't cancelled, and that does matter.</p>



<a name="214615500"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214615500" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214615500">(Oct 26 2020 at 18:35)</a>:</h4>
<p>For comparison, the current <code>cancel_denoms</code> results in </p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>Preprocessing: cancel denominators
[1 * A * (1 * B) ≤ 0, -(A * B) &lt; 0]
</code></pre></div>



<a name="214615812"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214615812" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214615812">(Oct 26 2020 at 18:37)</a>:</h4>
<p><code>linarith</code> might be smart enough to deal with a <code>/ 1</code> left over, off the top of my head I'm not sure. But I guess it doesn't like the <code>/ (1/8 * 8)</code>.</p>



<a name="214616007"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214616007" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214616007">(Oct 26 2020 at 18:39)</a>:</h4>
<p>I haven't looked carefully at the diff between the old version and yours yet. Do you have an idea how you might fix this? If not, I'll look more closely.</p>



<a name="214616192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214616192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214616192">(Oct 26 2020 at 18:40)</a>:</h4>
<p>If you do, you can push your changes directly to the branch <a href="https://github.com/leanprover-community/mathlib/tree/cancel-denoms-mirefek">branch#cancel-denoms-mirefek</a></p>



<a name="214616444"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214616444" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214616444">(Oct 26 2020 at 18:42)</a>:</h4>
<p>Github will try to build every commit that gets pushed. So you'll see a red X there as long as things are failing to build, including the tests. In this case, though, it's maybe easier to build the linarith test file locally. There aren't many imports between the test file and cancel_denoms.lean</p>



<a name="214617656"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214617656" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214617656">(Oct 26 2020 at 18:52)</a>:</h4>
<p>I think I can fix it. I was just lazy, so if the <code>norm_num</code> actually canceled the mess, I didn't care so much.</p>



<a name="214617702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214617702" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214617702">(Oct 26 2020 at 18:53)</a>:</h4>
<p>norm_num can't cancel that</p>



<a name="214617711"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214617711" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214617711">(Oct 26 2020 at 18:53)</a>:</h4>
<p><code>ring</code> might</p>



<a name="214617739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214617739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214617739">(Oct 26 2020 at 18:53)</a>:</h4>
<p>OK, I am not sure what it was.</p>



<a name="214617852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214617852" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214617852">(Oct 26 2020 at 18:54)</a>:</h4>
<p>I reused a lot of the original code.</p>



<a name="214617898"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214617898" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214617898">(Oct 26 2020 at 18:54)</a>:</h4>
<p><code>ring</code> won't be able to fix that the lhs is apparently 64 times larger than rob's version? Does that matter?</p>



<a name="214618224"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214618224" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214618224">(Oct 26 2020 at 18:57)</a>:</h4>
<p>I will look at the github repository, and fix the issues, hopefully this week. I was not sure how much I have to care about the special cases as long as it was somehow miraculously working on the basic examples I tried.</p>



<a name="214618541"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214618541" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214618541">(Oct 26 2020 at 18:59)</a>:</h4>
<p>But if someone knows why the interactive version contrary to <code>derive</code> reduces the expression, I would appreciate knowing it.</p>



<a name="214618621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214618621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214618621">(Oct 26 2020 at 19:00)</a>:</h4>
<p>I don't see any tactic <code>ring</code> used there.</p>



<a name="214956967"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214956967" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214956967">(Oct 29 2020 at 12:04)</a>:</h4>
<p><span class="user-mention" data-user-id="110596">@Rob Lewis</span> I pushed a version which already passes the linarith tests. On the other hand, they are about 2.5 times slower than with the original version, I am not exactly sure what to do about it.</p>



<a name="214961322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214961322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214961322">(Oct 29 2020 at 12:52)</a>:</h4>
<p>I received a message from Github that "continuous integration: Some jobs were not successful": <a href="https://github.com/leanprover-community/mathlib/actions/runs/335756434">https://github.com/leanprover-community/mathlib/actions/runs/335756434</a><br>
What does it mean?</p>



<a name="214963130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214963130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214963130">(Oct 29 2020 at 13:06)</a>:</h4>
<p>Whenever you push to a branch on the mathlib repository, Github tries to build and lint the commit you pushed. This process failed, so your changes have broken something in mathlib. You can click on "Lint style" and "Build mathlib" on the left and it'll show you exactly what errors were found. You don't have to fix them immediately, but they should be fixed when you make a PR.</p>



<a name="214978001"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214978001" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214978001">(Oct 29 2020 at 14:58)</a>:</h4>
<p>OK, one error is easily fixable "too long lines", and the other is the <code>linarith</code> tactic failing somewhere (in particular <code>gromov_hausdorff.lean</code>).  Would it be possible to figure out from it where the <code>cancel_denom</code> does not work properly?</p>



<a name="214978527"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214978527" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214978527">(Oct 29 2020 at 15:01)</a>:</h4>
<p>Yes, it should be line 531:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>/home/runner/work/mathlib/mathlib/src/topology/metric_space/gromov_hausdorff.lean:531:30: error: linarith failed to find a contradiction
</code></pre></div>



<a name="214978761"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214978761" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214978761">(Oct 29 2020 at 15:02)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/blob/d510a637b9d1d1cb72acb1f847694281f0c61051/src/topology/metric_space/gromov_hausdorff.lean#L531">https://github.com/leanprover-community/mathlib/blob/d510a637b9d1d1cb72acb1f847694281f0c61051/src/topology/metric_space/gromov_hausdorff.lean#L531</a></p>



<a name="214978899"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214978899" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214978899">(Oct 29 2020 at 15:03)</a>:</h4>
<p>The goal seems to be</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">ε₂</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">*</span> <span class="o">(</span><span class="n">ε₂</span><span class="bp">/</span><span class="mi">2</span> <span class="bp">+</span> <span class="n">δ</span><span class="o">)</span>
</code></pre></div>



<a name="214992125"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214992125" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214992125">(Oct 29 2020 at 16:27)</a>:</h4>
<p>You can use <code>set_option trace.linarith true</code> to get some information about what <code>linarith</code> is doing. In particular it will print the hypotheses before and after denominator cancellation.</p>



<a name="214992235"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/214992235" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#214992235">(Oct 29 2020 at 16:27)</a>:</h4>
<p>For the efficiency problem, I'll take a look. <code>set_option profiler true</code> often gives useful information here.</p>



<a name="215010048"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215010048" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215010048">(Oct 29 2020 at 18:38)</a>:</h4>
<p>The pattern you use <a href="https://github.com/leanprover-community/mathlib/blob/cancel-denoms-mirefek/src/tactic/cancel_denoms.lean#L142">here</a> and above, where you try to apply a bunch of different lemmas to see which one works, can be expensive. It's better if you can identify which lemma is the right one based on the values you have access to, and apply it directly.</p>



<a name="215010069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215010069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215010069">(Oct 29 2020 at 18:38)</a>:</h4>
<p>I'm not sure that this is what's causing the slowdown though.</p>



<a name="215010133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215010133" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215010133">(Oct 29 2020 at 18:39)</a>:</h4>
<p>Your version is spending a lot more time in various places, including in <code>norm_num</code>.</p>



<a name="215010206"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215010206" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215010206">(Oct 29 2020 at 18:39)</a>:</h4>
<p>Part of this is because it's doing more than the old version is. But on problems that the old version solves too, I wouldn't expect it to be doing too much more, not enough to see this kind of slowdown.</p>



<a name="215010359"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215010359" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215010359">(Oct 29 2020 at 18:40)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/blob/cancel-denoms-mirefek/src/tactic/cancel_denoms.lean#L158">https://github.com/leanprover-community/mathlib/blob/cancel-denoms-mirefek/src/tactic/cancel_denoms.lean#L158</a> is wrong, this check only works if the original problem is over <code>rat</code>. A simpler check is <code>guard (v = 1)</code>.</p>



<a name="215010414"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215010414" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215010414">(Oct 29 2020 at 18:41)</a>:</h4>
<p>This simplifies one call to <code>norm_num</code> but not by a huge amount.</p>



<a name="215068280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215068280" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215068280">(Oct 30 2020 at 08:55)</a>:</h4>
<p>Sure, I am aware of many places where some optimization could be added (I should try the profiler to see which is the bottleneck now).</p>



<a name="215068283"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215068283" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215068283">(Oct 30 2020 at 08:55)</a>:</h4>
<p>Now, I am rather planning to figure out the problem with <code>gromov_hausdorf.lean</code>.</p>



<a name="215070259"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215070259" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215070259">(Oct 30 2020 at 09:18)</a>:</h4>
<p>I don't get the problem with <code>gromov_hausdorf.lean</code>. When I enabled debug prints for <code>linarith</code>, I got</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Preprocessing</span><span class="o">:</span> <span class="n">make</span> <span class="n">comparisons</span> <span class="k">with</span> <span class="n">zero</span>
<span class="o">[</span><span class="bp">-</span><span class="n">δ</span> <span class="bp">&lt;</span> <span class="mi">0</span><span class="o">,</span> <span class="n">dist</span> <span class="n">xα</span> <span class="n">xs</span> <span class="bp">-</span> <span class="n">ε₁</span> <span class="bp">≤</span> <span class="mi">0</span><span class="o">,</span> <span class="bp">-</span><span class="n">ε₂</span> <span class="bp">≤</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">2</span> <span class="bp">*</span> <span class="o">(</span><span class="n">ε₂</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">+</span> <span class="n">δ</span><span class="o">)</span> <span class="bp">-</span> <span class="n">ε₂</span> <span class="bp">&lt;</span> <span class="mi">0</span><span class="o">]</span>
<span class="n">Preprocessing</span><span class="o">:</span> <span class="n">cancel</span> <span class="n">denominators</span>
<span class="o">[</span><span class="mi">2</span> <span class="bp">*</span> <span class="o">(</span><span class="n">ε₂</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">+</span> <span class="n">δ</span><span class="o">)</span> <span class="bp">-</span> <span class="n">ε₂</span> <span class="bp">&lt;</span> <span class="mi">0</span><span class="o">,</span> <span class="bp">-</span><span class="n">ε₂</span> <span class="bp">≤</span> <span class="mi">0</span><span class="o">,</span> <span class="n">dist</span> <span class="n">xα</span> <span class="n">xs</span> <span class="bp">-</span> <span class="n">ε₁</span> <span class="bp">≤</span> <span class="mi">0</span><span class="o">,</span> <span class="bp">-</span><span class="n">δ</span> <span class="bp">&lt;</span> <span class="mi">0</span><span class="o">]</span>
</code></pre></div>

<p>But when I test <code>derive</code> on my own, like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">test_derive</span> <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="n">expr</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="k">do</span>
  <span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">pf</span><span class="o">)</span> <span class="bp">←</span> <span class="n">cancel_factors.derive</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">tp</span> <span class="bp">←</span> <span class="n">tactic.infer_type</span> <span class="n">pf</span><span class="o">,</span>
  <span class="n">tactic.trace</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">tactic.trace</span> <span class="n">tp</span>

<span class="kd">constants</span> <span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">ℚ</span>
<span class="kd">run_cmd</span> <span class="n">test_derive</span> <span class="bp">`</span><span class="o">(</span><span class="mi">2</span> <span class="bp">*</span> <span class="o">(</span><span class="n">x</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span> <span class="bp">-</span> <span class="n">x</span><span class="o">)</span>
</code></pre></div>

<p>It behaves well:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="mi">1</span>
<span class="mi">1</span> <span class="bp">*</span> <span class="o">(</span><span class="mi">2</span> <span class="bp">*</span> <span class="o">(</span><span class="n">x</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span> <span class="bp">-</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">1</span> <span class="bp">*</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">y</span><span class="o">)</span> <span class="bp">-</span> <span class="n">x</span>
</code></pre></div>



<a name="215070334"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215070334" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215070334">(Oct 30 2020 at 09:19)</a>:</h4>
<p>Maybe <code>linarith</code> does not use the simplification when the factor is 1?</p>



<a name="215114297"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215114297" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215114297">(Oct 30 2020 at 15:59)</a>:</h4>
<p>Hmm. There is something odd going on here. Didn't manage to locate it immediately. I'll take a closer look later today when I have the time.</p>



<a name="215114370"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215114370" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215114370">(Oct 30 2020 at 15:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133339">Miroslav Olšák</span> <a href="#narrow/stream/239415-metaprogramming-.2F.20tactics/topic/cancel_denoms.20exercise/near/215070334">said</a>:</p>
<blockquote>
<p>Maybe <code>linarith</code> does not use the simplification when the factor is 1?</p>
</blockquote>
<p>It's something to do with this, yes, but not as obviously as you might expect.</p>



<a name="215850517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215850517" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Miroslav Olšák <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215850517">(Nov 06 2020 at 14:13)</a>:</h4>
<p>Any progress? Should I look into <code>linarith</code>?</p>



<a name="215851817"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215851817" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215851817">(Nov 06 2020 at 14:22)</a>:</h4>
<p>Sorry. It's been a distracting week</p>



<a name="215851831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215851831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215851831">(Nov 06 2020 at 14:22)</a>:</h4>
<p>I'll find time to look into this today.</p>



<a name="215881013"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215881013" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215881013">(Nov 06 2020 at 17:53)</a>:</h4>
<p><span class="user-mention" data-user-id="133339">@Miroslav Olšák</span> sorry for the delay. I pushed a fix to the branch.</p>



<a name="215881414"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/cancel_denoms%20exercise/near/215881414" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/cancel_denoms.20exercise.html#215881414">(Nov 06 2020 at 17:57)</a>:</h4>
<p>The issue was with expressions that can be cancelled without a new factor, like <code>2 * (x / 2 + y)</code>. <code>cancel_denoms</code> needs to do some work here, and the old version unnecessarily multiplied the whole thing by 2. When the new one produces a factor of 1 there's an extra step needed to make sure that <code>1*</code> appears (or doesn't appear) in the right place.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>