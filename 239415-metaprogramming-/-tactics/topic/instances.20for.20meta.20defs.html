---
layout: archive
title: Zulip Chat Archive
permalink: /stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/index.html">metaprogramming / tactics</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html">instances for meta defs</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="212738421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212738421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212738421">(Oct 08 2020 at 19:29)</a>:</h4>
<p>Does the following make sense?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">init.meta.interactive</span>

<span class="kd">meta</span> <span class="kd">instance</span> <span class="o">{</span><span class="n">state</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">:</span> <span class="n">functor</span> <span class="o">(</span><span class="n">interaction_monad</span> <span class="n">state</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span> <span class="n">interaction_monad_fmap</span><span class="o">,</span>
  <span class="n">map_const</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">x</span><span class="o">,</span> <span class="n">interaction_monad_fmap</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">_</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">}</span>
</code></pre></div>

<p>or is that not useful, won't be accessible to the typeclass system?</p>



<a name="212739114"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212739114" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212739114">(Oct 08 2020 at 19:35)</a>:</h4>
<p>I guess it could be something, since there is a <code>meta instance</code> of <code>monad</code> in <code>interaction_monad.lean</code></p>



<a name="212739137"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212739137" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212739137">(Oct 08 2020 at 19:35)</a>:</h4>
<p>But I don't understand why <code>interaction_monad.result</code> is a separate defn</p>



<a name="212743248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212743248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212743248">(Oct 08 2020 at 20:12)</a>:</h4>
<p>It already exists as a consequence of the <code>monad</code> instance</p>



<a name="212743260"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212743260" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212743260">(Oct 08 2020 at 20:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="308899">Yakov Pechersky</span> <a href="#narrow/stream/239415-metaprogramming-.2F.20tactics/topic/instances.20for.20meta.20defs/near/212739137">said</a>:</p>
<blockquote>
<p>But I don't understand why <code>interaction_monad.result</code> is a separate defn</p>
</blockquote>
<p>As opposed to what?</p>



<a name="212744979"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212744979" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212744979">(Oct 08 2020 at 20:29)</a>:</h4>
<p>I guess what I'm trying to understand is whether <code>interactive_monad.result</code> can itself be a monad or a functor. Or something similar. In <a href="https://github.com/leanprover-community/lean/issues/476">lean#476</a>, is there a way to simplify the following:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="o">(</span><span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="k">match</span> <span class="n">found</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">success</span> <span class="n">r</span> <span class="n">s'</span><span class="o">)</span> <span class="o">:=</span>  <span class="o">(</span><span class="n">success</span> <span class="n">r</span> <span class="n">s</span><span class="o">)</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">exception</span> <span class="n">f</span> <span class="n">p</span> <span class="n">s'</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">exception</span> <span class="n">f</span> <span class="n">p</span> <span class="n">s</span><span class="o">)</span>
  <span class="kd">end</span><span class="o">),</span>
</code></pre></div>



<a name="212745003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212745003" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212745003">(Oct 08 2020 at 20:29)</a>:</h4>
<p>Which as I understand, is just replacing the state in <code>found</code></p>



<a name="212750126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212750126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212750126">(Oct 08 2020 at 21:14)</a>:</h4>
<p>I wonder if something in <a href="https://github.com/leanprover-community/lean/blob/master/library/init/control/except.lean">https://github.com/leanprover-community/lean/blob/master/library/init/control/except.lean</a> is what I'm after</p>



<a name="212754609"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212754609" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212754609">(Oct 08 2020 at 22:01)</a>:</h4>
<p><span class="user-mention" data-user-id="308899">@Yakov Pechersky</span> There are combinators that will do most of the variations on that kind of function, but you might want to do different things with the state, e.g. rolling it back in success case but not failure</p>



<a name="212756150"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212756150" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212756150">(Oct 08 2020 at 22:19)</a>:</h4>
<p>Oh you might have found a bug in my PR then</p>



<a name="212756165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212756165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212756165">(Oct 08 2020 at 22:19)</a>:</h4>
<p>I wasn't really thinking about state rollbacks</p>



<a name="212756227"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212756227" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212756227">(Oct 08 2020 at 22:20)</a>:</h4>
<p>But maybe it doesn't matter because the caller does the rollback anyway?</p>



<a name="212756337"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212756337" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212756337">(Oct 08 2020 at 22:21)</a>:</h4>
<p>What PR?</p>



<a name="212758495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212758495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212758495">(Oct 08 2020 at 22:48)</a>:</h4>
<p><a href="https://github.com/leanprover-community/lean/issues/476">lean#476</a></p>



<a name="212831931"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212831931" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212831931">(Oct 09 2020 at 14:21)</a>:</h4>
<p>It looks like the operations I'm looking for are</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c1">-- capture / pack the result of a tactic</span>
<span class="kd">meta</span> <span class="kd">def</span> <span class="n">capture</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">(</span><span class="n">t</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="o">(</span><span class="n">tactic_result</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="k">match</span> <span class="n">t</span> <span class="n">s</span> <span class="k">with</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">success</span> <span class="n">r</span> <span class="n">s'</span><span class="o">)</span> <span class="o">:=</span> <span class="n">success</span> <span class="o">(</span><span class="n">success</span> <span class="n">r</span> <span class="n">s'</span><span class="o">)</span> <span class="n">s'</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">exception</span> <span class="n">f</span> <span class="n">p</span> <span class="n">s'</span><span class="o">)</span> <span class="o">:=</span> <span class="n">success</span> <span class="o">(</span><span class="n">exception</span> <span class="n">f</span> <span class="n">p</span> <span class="n">s'</span><span class="o">)</span> <span class="n">s'</span>
<span class="kd">end</span>

<span class="c1">-- release / rethrow / unpack a captured result</span>
<span class="kd">meta</span> <span class="kd">def</span> <span class="n">release</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">(</span><span class="n">t</span> <span class="o">:</span> <span class="n">tactic_result</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">α</span> <span class="o">:=</span>
<span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">success</span> <span class="n">r</span> <span class="n">s'</span><span class="o">)</span> <span class="o">:=</span> <span class="n">return</span> <span class="n">r</span>
<span class="bp">|</span> <span class="n">e</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="n">e</span>
<span class="kd">end</span>
</code></pre></div>

<p>Do these exist already under other names? If not, are the names I propose sensible?</p>



<a name="212832350"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832350" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832350">(Oct 09 2020 at 14:25)</a>:</h4>
<p><code>capture</code> is similar to <code>try_core</code>, but returns more information. I think returning the <code>tactic_state</code> is generally not desirable though</p>



<a name="212832413"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832413" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832413">(Oct 09 2020 at 14:25)</a>:</h4>
<p>The sole purpose of <code>capture</code> is to put the result through <code>release</code> later</p>



<a name="212832450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832450">(Oct 09 2020 at 14:25)</a>:</h4>
<p>In particular I'm skeptical about the <code>| e := λ s, e</code> case</p>



<a name="212832637"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832637" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832637">(Oct 09 2020 at 14:27)</a>:</h4>
<p>Which is equivalent to <code>| (exception f p s') := λ s, (exception f p s')</code>, right? Presumably you're worried the second <code>s'</code> should be <code>s</code>?</p>



<a name="212832696"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832696" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832696">(Oct 09 2020 at 14:27)</a>:</h4>
<p><code>capture t</code> is just <code>t &lt;$&gt; read</code>, right?</p>



<a name="212832813"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832813" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832813">(Oct 09 2020 at 14:28)</a>:</h4>
<p>Doesn't <a href="https://leanprover-community.github.io/mathlib_docs/find/read">docs#read</a> give me a <code>tactic (tactic_state)</code>, not <code>tactic (tactic_result α)</code>?</p>



<a name="212832870"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832870" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832870">(Oct 09 2020 at 14:28)</a>:</h4>
<p>And a tactic is a function from <code>tactic_state</code> to <code>tactic_result α</code>.</p>



<a name="212832904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832904">(Oct 09 2020 at 14:28)</a>:</h4>
<p>oh, I was looking for <code>read</code> but I thought it would be called <code>get</code></p>



<a name="212832908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832908">(Oct 09 2020 at 14:29)</a>:</h4>
<p>Ah, I see what you mean</p>



<a name="212832911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832911" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832911">(Oct 09 2020 at 14:29)</a>:</h4>
<p>Yes, that's right</p>



<a name="212832925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212832925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212832925">(Oct 09 2020 at 14:29)</a>:</h4>
<p>How about <code>release</code> then?</p>



<a name="212833034"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833034" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833034">(Oct 09 2020 at 14:29)</a>:</h4>
<p><code>release r</code> is almost <code>λ _, r</code>, except that it doesn't update the tactic state.</p>



<a name="212833112"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833112" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833112">(Oct 09 2020 at 14:30)</a>:</h4>
<p>It leaves it unupdated for exceptions, but updates it for success</p>



<a name="212833182"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833182" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833182">(Oct 09 2020 at 14:30)</a>:</h4>
<p>Really I'm just skeptical about this entire endeavor I guess. Manipulating these <code>tactic_state</code>s directly is like a worse version of GOTO.</p>



<a name="212833205"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833205" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833205">(Oct 09 2020 at 14:30)</a>:</h4>
<p>@Reid, did you see the PR?</p>



<a name="212833221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833221" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833221">(Oct 09 2020 at 14:31)</a>:</h4>
<p>Yes, but I couldn't understand it</p>



<a name="212833239"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833239" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833239">(Oct 09 2020 at 14:31)</a>:</h4>
<p>AFAIU it's a workaround for <code>ext_simplify_core</code> ignoring errors.</p>



<a name="212833252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833252" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833252">(Oct 09 2020 at 14:31)</a>:</h4>
<p>Exactly</p>



<a name="212833269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833269" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833269">(Oct 09 2020 at 14:31)</a>:</h4>
<p><code>ext_simplify_core </code>  uses errors to indicate "skip this match"</p>



<a name="212833270"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833270" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833270">(Oct 09 2020 at 14:31)</a>:</h4>
<p>Do we have to work around it? Could we fix it instead?</p>



<a name="212833336"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833336" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833336">(Oct 09 2020 at 14:31)</a>:</h4>
<p>We'd have to change the API significantly</p>



<a name="212833352"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833352" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833352">(Oct 09 2020 at 14:31)</a>:</h4>
<p>At the least, something like this needs <em>way</em> more documentation</p>



<a name="212833480"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833480" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833480">(Oct 09 2020 at 14:32)</a>:</h4>
<p>Where would that documentation go?</p>



<a name="212833559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833559" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833559">(Oct 09 2020 at 14:33)</a>:</h4>
<p>In probably like an 80-line block comment above the definition of <code>conv.interactive.for</code></p>



<a name="212833562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833562">(Oct 09 2020 at 14:33)</a>:</h4>
<p>(note that I'm modelling the name <code>capture</code> from <a href="https://outcome.readthedocs.io/en/latest/api.html#outcome.capture">https://outcome.readthedocs.io/en/latest/api.html#outcome.capture</a>). I suppose to match that, I should use <code>unwrap</code> instead of <code>release</code></p>



<a name="212833577"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833577" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833577">(Oct 09 2020 at 14:33)</a>:</h4>
<p><code>find</code> needs it too</p>



<a name="212833752"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833752" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833752">(Oct 09 2020 at 14:35)</a>:</h4>
<p>This is why I'm suggesting the two defs above - they leave a nice place for some explanatory documentation of why they can be useful</p>



<a name="212833789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212833789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212833789">(Oct 09 2020 at 14:35)</a>:</h4>
<p>Even if one of them is just <code>t &lt;$&gt; read</code></p>



<a name="212834021"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212834021" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212834021">(Oct 09 2020 at 14:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/239415-metaprogramming-.2F.20tactics/topic/instances.20for.20meta.20defs/near/212832637">said</a>:</p>
<blockquote>
<p>Which is equivalent to <code>| (exception f p s') := λ s, (exception f p s')</code>, right? Presumably you're worried the second <code>s'</code> should be <code>s</code>?</p>
</blockquote>
<p>I'm definitely less worried if the second <code>s'</code> is <code>s</code>.</p>



<a name="212834084"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212834084" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212834084">(Oct 09 2020 at 14:37)</a>:</h4>
<p>Because then you can write it using normal tactic functions.</p>



<a name="212834151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212834151" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212834151">(Oct 09 2020 at 14:38)</a>:</h4>
<p>That would give an incorrect error message though. I want to see the tactic state at the point the error happened, not at the point that <code>ext_simplify_core</code> did its cleanup after that</p>



<a name="212834174"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212834174" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212834174">(Oct 09 2020 at 14:38)</a>:</h4>
<p>(whatever that cleanup may be)</p>



<a name="212834218"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212834218" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212834218">(Oct 09 2020 at 14:38)</a>:</h4>
<p>I don't believe the tactic state in <code>exception</code> is used for anything other than diagnostics</p>



<a name="212834240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212834240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212834240">(Oct 09 2020 at 14:38)</a>:</h4>
<p>Trying to continue from an error state by extracting and using the <code>s</code> of <code>exception</code> would be foolish in any situation - if you recover from an error, you should resume from a known-good state (ie, the beginning of a <code>try</code>)</p>



<a name="212834633"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212834633" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212834633">(Oct 09 2020 at 14:42)</a>:</h4>
<p>Well this all hurts my head</p>



<a name="212834685"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212834685" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212834685">(Oct 09 2020 at 14:42)</a>:</h4>
<p>I think maybe only 80 lines will not be enough? <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="212834720"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212834720" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212834720">(Oct 09 2020 at 14:42)</a>:</h4>
<p>Can you just use mutable variables somehow?</p>



<a name="212835013"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835013" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835013">(Oct 09 2020 at 14:45)</a>:</h4>
<p>I really think that whatever you are trying to do should be possible without this weird non-chronological control flow</p>



<a name="212835045"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835045" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835045">(Oct 09 2020 at 14:45)</a>:</h4>
<p>This isn't non-chronological</p>



<a name="212835141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835141" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835141">(Oct 09 2020 at 14:46)</a>:</h4>
<p>This is just a rewind, which is exactly what <code>try {}</code> already does - the only difference is I'm rewinding to an error state,  not to the pre-error state</p>



<a name="212835174"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835174" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835174">(Oct 09 2020 at 14:46)</a>:</h4>
<p>Isn't it? You're saving an intermediate <em>state</em> and using it later, after more things might have affected the state in the meantime</p>



<a name="212835206"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835206" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835206">(Oct 09 2020 at 14:46)</a>:</h4>
<p>My claim is that nothing uses that state</p>



<a name="212835208"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835208" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835208">(Oct 09 2020 at 14:46)</a>:</h4>
<p>Yeah but <code>try</code> doesn't give you an object to use in totally uncontrolled ways</p>



<a name="212835222"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835222" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835222">(Oct 09 2020 at 14:47)</a>:</h4>
<p>So then you must not need it, right? <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="212835252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835252" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835252">(Oct 09 2020 at 14:47)</a>:</h4>
<p>Sorry, my claim is that the only user of the third argument to <code>exception</code> is the debug window printout</p>



<a name="212835264"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835264" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835264">(Oct 09 2020 at 14:47)</a>:</h4>
<p>And for that use case, the old state is the one that matters</p>



<a name="212835357"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835357" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835357">(Oct 09 2020 at 14:48)</a>:</h4>
<p>And you can't just capture the debug window output locally in a thunk or something?</p>



<a name="212835404"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835404" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835404">(Oct 09 2020 at 14:48)</a>:</h4>
<p>Isn't that debug window output exactly <code>tactic_state</code>?</p>



<a name="212835425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835425" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835425">(Oct 09 2020 at 14:48)</a>:</h4>
<p>(I don't know the answer to this)</p>



<a name="212835446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835446" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835446">(Oct 09 2020 at 14:49)</a>:</h4>
<p>Like, if the tactic monad was the IO monad, your implementation would be impossible</p>



<a name="212835460"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835460" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835460">(Oct 09 2020 at 14:49)</a>:</h4>
<p>but what you want to do doesn't seem impossible</p>



<a name="212835499"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835499" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835499">(Oct 09 2020 at 14:49)</a>:</h4>
<p>What I want to do would be impossible in the IO monad</p>



<a name="212835524"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835524" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835524">(Oct 09 2020 at 14:49)</a>:</h4>
<p>ok, I give up</p>



<a name="212835608"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835608" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835608">(Oct 09 2020 at 14:50)</a>:</h4>
<p>If I have a <code>print_with_commas some_monad</code> that ignores errors in <code>some_monad</code> and keeps printing commas, there's nothing I can do to stop those commas being printed</p>



<a name="212835656"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212835656" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212835656">(Oct 09 2020 at 14:50)</a>:</h4>
<p>But in the tactic monad, I can (and need to) rollback time to before the commas are printed. <code>try {}</code> is also not possible in the IO monad</p>



<a name="212838129"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212838129" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212838129">(Oct 09 2020 at 15:10)</a>:</h4>
<p>Thanks for the feedback, anyway - I'll see if I can make the intent clearer</p>



<a name="212840086"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212840086" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212840086">(Oct 09 2020 at 15:24)</a>:</h4>
<p>I still think it would be better to fix the API of <code>ext_simplify_core</code> so that it doesn't swallow all exceptions--this might fix other bugs at the same time.</p>



<a name="212840169"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212840169" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212840169">(Oct 09 2020 at 15:25)</a>:</h4>
<p>My main resistance to that is <code>ext_simplify_core</code> being written in C++</p>



<a name="212840390"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212840390" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212840390">(Oct 09 2020 at 15:26)</a>:</h4>
<p>But yes, I suppose the signature of  the <code>pre</code> and <code>post</code>callbacks to <code>ext_simplify_core</code> could be changed from returning <code>tactic (α × expr × option expr × bool)</code> to returning <code>tactic $ option (α × expr × option expr × bool)</code>, where <code>none</code> in the new version means monadic failure means together</p>



<a name="212840738"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212840738" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212840738">(Oct 09 2020 at 15:29)</a>:</h4>
<p>But that requires changing every single caller of <code>ext_simplify_core</code>, which is something I don't feel at all comfortable doing.</p>



<a name="212845710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212845710" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212845710">(Oct 09 2020 at 16:07)</a>:</h4>
<p>I've updated the PR code with some more comments, and the PR description to summarize the alternative I describe above.</p>



<a name="212892266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212892266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212892266">(Oct 10 2020 at 01:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/239415-metaprogramming-.2F.20tactics/topic/instances.20for.20meta.20defs/near/212840738">said</a>:</p>
<blockquote>
<p>But that requires changing every single caller of <code>ext_simplify_core</code>, which is something I don't feel at all comfortable doing.</p>
</blockquote>
<p>There aren't that many, because it's a very unwieldy API</p>



<a name="212903151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212903151" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212903151">(Oct 10 2020 at 07:12)</a>:</h4>
<p>There are a fair number of transitive callers that would change too</p>



<a name="212903248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/212903248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#212903248">(Oct 10 2020 at 07:16)</a>:</h4>
<p>Would a suitable compromise be to:</p>
<ul>
<li>Define a wrapper, <code>ext_simplify_core_strict</code>, which does the monad tricks currently in the PR</li>
<li>Change find and for to use this def instead</li>
<li>Slowly convert other callers to use the new API over multiple PRs</li>
<li>Change the C++ API to make ext_simplify_core_strict the default behavior, once all callers are changed</li>
</ul>
<p>I don't want to have to perform a massive refactor to fix an annoying bug - I'd prefer to fix the bug first, and leave breadcrumbs for someone more competent to perform the refactor</p>



<a name="213134796"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/239415-metaprogramming%20/%20tactics/topic/instances%20for%20meta%20defs/near/213134796" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/239415-metaprogramming-/-tactics/topic/instances.20for.20meta.20defs.html#213134796">(Oct 13 2020 at 10:18)</a>:</h4>
<p>(note that this was merged in the end, and <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span>  pointed out that <code>ext_simplify_core</code> not only discards errors, but rolls back any changes to the tactic state)</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>