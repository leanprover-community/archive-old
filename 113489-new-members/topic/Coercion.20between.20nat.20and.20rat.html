---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html">Coercion between nat and rat</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="202237272"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202237272" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Stevens <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202237272">(Jun 28 2020 at 13:43)</a>:</h4>
<p>How was I able to prove this obviously untrue statement? By which I mean, how can I phrase the statement I wanted?</p>
<p><code>lemma bad (b p : nat) : (b : ℚ) / (p : ℚ) = (((b : ℕ) / (p : ℕ)) : ℚ) := rfl</code></p>
<p>This is Obviously False: 1/2 is 1/2 in the rationals and 0 in the naturals. How do I phrase <code>bad</code> in such a way that <code>rfl</code> doesn't prove it and instead I need to add the hypothesis that <code>p</code> divides <code>b</code>?</p>



<a name="202237408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202237408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202237408">(Jun 28 2020 at 13:46)</a>:</h4>
<p>Type inference is outside in.</p>



<a name="202237411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202237411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202237411">(Jun 28 2020 at 13:46)</a>:</h4>
<p>(Generally speaking.)</p>



<a name="202237555"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202237555" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Stevens <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202237555">(Jun 28 2020 at 13:51)</a>:</h4>
<p>I hoped I'd be able to completely override the type inference algorithm by specifying the types of everything - I presume the problem is that the right-hand <code>/</code> has implicitly upcasted its two explicitly <code>nat</code> inputs. How can I stop it doing that? I ask because I have the following:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">lemma</span> <span class="n">r</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">p_prime</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">b_nonzero</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">dvd</span> <span class="o">:</span> <span class="n">p</span> <span class="err">∣</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span><span class="o">)</span> <span class="bp">-</span> <span class="mi">1</span> <span class="bp">=</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="o">(</span><span class="n">b</span> <span class="bp">/</span> <span class="n">p</span><span class="o">))</span> <span class="o">:=</span>
<span class="k">begin</span>
<span class="k">let</span> <span class="n">e</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">div</span> <span class="n">p</span> <span class="n">p_prime</span> <span class="n">b</span> <span class="n">p</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="n">b_nonzero</span><span class="o">)</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">ne_zero</span> <span class="n">p_prime</span><span class="o">)),</span>
<span class="n">rw</span> <span class="bp">@</span><span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">padic_val_rat_self</span> <span class="n">p</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">one_lt</span> <span class="n">p_prime</span><span class="o">)</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
<span class="n">rw</span> <span class="err">←</span> <span class="bp">@</span><span class="n">padic_val_rat_of_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
<span class="c1">--have s : (b : ℚ) / (p : ℚ) = (((b : ℕ) / (p : ℕ)) : ℚ) := rfl,</span>
<span class="c1">--rw ← @padic_val_rat_of_nat p (b / p) at e,</span>
<span class="kn">end</span>
</code></pre></div>


<p>In scope is a term of type <code>padic_val_rat p (↑b / ↑p) = ↑(padic_val_nat p b) - 1</code>, and I know <code>padic_val_rat_of_nat</code> can turn the left-hand side into a <code>padic_val_nat</code> (it's currently talking about <code>padic_val_rat</code>) <em>if</em> I can make that <code>b / p</code> term appear as an upcasted natural, rather than a rational</p>



<a name="202237645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202237645" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202237645">(Jun 28 2020 at 13:53)</a>:</h4>
<p>there should be a theorem <code>nat.cast_div</code> (but there probably isn't right now)</p>



<a name="202237708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202237708" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202237708">(Jun 28 2020 at 13:55)</a>:</h4>
<p>The way to write your statement is something like (untested)<br>
<code>lemma bad (b p : nat) : (b / p : ℚ) = (b / p : ℕ)</code></p>



<a name="202237710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202237710" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202237710">(Jun 28 2020 at 13:55)</a>:</h4>
<p><span aria-label="up" class="emoji emoji-2b06" role="img" title="up">:up:</span></p>



<a name="202242816"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202242816" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Stevens <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202242816">(Jun 28 2020 at 16:07)</a>:</h4>
<p>Writing either of these functions is by a large margin the hardest thing I've experienced in Lean. My approach must be completely wrong, because it feels like Lean is fighting me as hard as it can in a way I've never experienced from a computer. It would be a lot easier if I could simply prevent it from doing any coercion locally, because then at least I could easily control what types anything had!</p>
<div class="codehilite"><pre><span></span><code><span class="kn">theorem</span> <span class="n">cast_dvd</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semiring</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">has_div</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">n_dvd</span> <span class="o">:</span> <span class="n">n</span> <span class="err">∣</span> <span class="n">m</span><span class="o">)</span> <span class="o">(</span><span class="n">n_nonzero</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="o">((</span><span class="n">m</span> <span class="bp">/</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="bp">=</span> <span class="n">m</span> <span class="bp">/</span> <span class="n">n</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">induction</span> <span class="n">m</span> <span class="k">with</span> <span class="n">m</span> <span class="n">ind_m</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">cases</span> <span class="n">n</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">trivial</span> <span class="o">},</span>
    <span class="k">have</span> <span class="n">r</span> <span class="o">:</span> <span class="err">↑</span><span class="o">(</span><span class="n">n</span><span class="bp">.</span><span class="n">succ</span><span class="o">)</span> <span class="bp">≠</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="n">n_nonzero</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">s</span> <span class="o">:</span> <span class="err">↑</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">,</span> <span class="k">by</span> <span class="n">simp</span><span class="o">,</span>
    <span class="n">norm_num</span><span class="o">,</span>
    <span class="n">sorry</span><span class="o">,</span>
  <span class="o">},</span>
  <span class="o">{</span> <span class="n">sorry</span><span class="o">,</span> <span class="o">},</span>
<span class="kn">end</span>

<span class="kn">open</span> <span class="n">padic_val_rat</span>

<span class="kn">lemma</span> <span class="n">thing</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">p_prime</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">b_nonzero</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">dvd</span> <span class="o">:</span> <span class="n">p</span> <span class="err">∣</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="o">(</span><span class="n">b</span> <span class="bp">/</span> <span class="n">p</span><span class="o">))</span> <span class="bp">=</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span><span class="o">)</span> <span class="bp">-</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">let</span> <span class="n">e</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">div</span> <span class="n">p</span> <span class="n">p_prime</span> <span class="n">b</span> <span class="n">p</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="n">b_nonzero</span><span class="o">)</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">ne_zero</span> <span class="n">p_prime</span><span class="o">)),</span>
  <span class="n">rw</span> <span class="bp">@</span><span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">padic_val_rat_self</span> <span class="n">p</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">one_lt</span> <span class="n">p_prime</span><span class="o">)</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">rw</span> <span class="err">←</span> <span class="bp">@</span><span class="n">padic_val_rat_of_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">rw</span> <span class="bp">&lt;-</span> <span class="bp">@</span><span class="n">cast_dvd</span> <span class="n">ℚ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">b</span> <span class="n">p</span> <span class="n">dvd</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">ne_zero</span> <span class="n">p_prime</span><span class="o">)</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">rw</span> <span class="bp">&lt;-</span> <span class="bp">@</span><span class="n">padic_val_rat_of_nat</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">r</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">≤</span> <span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">sorry</span><span class="o">,</span> <span class="c1">-- I can do that one</span>
<span class="c1">-- this is nonsense</span>
  <span class="k">let</span> <span class="n">e</span> <span class="o">:</span> <span class="bp">@</span><span class="n">coe</span> <span class="bp">ℕ</span> <span class="bp">ℤ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">=</span> <span class="err">↑</span><span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_sub</span> <span class="bp">ℤ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="mi">1</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span><span class="o">)</span> <span class="n">r</span><span class="o">,</span>
  <span class="n">sorry</span><span class="o">,</span>
<span class="kn">end</span>
</code></pre></div>



<a name="202243650"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202243650" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202243650">(Jun 28 2020 at 16:26)</a>:</h4>
<p>You can always control coercion by putting more type ascriptions in, or putting <code>\u</code> directly in the term where you want the coercion to appear</p>



<a name="202243721"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202243721" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202243721">(Jun 28 2020 at 16:28)</a>:</h4>
<p>in particular you can use double type ascription like <code>((x + y : nat) : int)</code> to make sure a coercion gets inserted between the type ascriptions</p>



<a name="202243814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202243814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202243814">(Jun 28 2020 at 16:30)</a>:</h4>
<p><code>cast_dvd</code> is not true in the generality you have stated for it</p>



<a name="202243818"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202243818" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202243818">(Jun 28 2020 at 16:30)</a>:</h4>
<p>the division on alpha has nothing to do with the algebraic structure</p>



<a name="202243958"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202243958" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202243958">(Jun 28 2020 at 16:35)</a>:</h4>
<p>Here's a true version of your theorem (possibly not maximally general)</p>
<div class="codehilite"><pre><span></span><code><span class="kn">theorem</span> <span class="n">cast_dvd</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">field</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">n_dvd</span> <span class="o">:</span> <span class="n">n</span> <span class="err">∣</span> <span class="n">m</span><span class="o">)</span> <span class="o">(</span><span class="n">n_nonzero</span> <span class="o">:</span> <span class="o">(</span><span class="n">n</span><span class="o">:</span><span class="n">α</span><span class="o">)</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="o">((</span><span class="n">m</span> <span class="bp">/</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="bp">=</span> <span class="n">m</span> <span class="bp">/</span> <span class="n">n</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rcases</span> <span class="n">n_dvd</span> <span class="k">with</span> <span class="bp">⟨</span><span class="n">k</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="k">have</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">,</span> <span class="o">{</span><span class="n">rintro</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">simpa</span> <span class="kn">using</span> <span class="n">n_nonzero</span><span class="o">},</span>
  <span class="n">rw</span> <span class="n">nat</span><span class="bp">.</span><span class="n">mul_div_cancel_left</span> <span class="bp">_</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">pos_iff_ne_zero</span><span class="bp">.</span><span class="mi">2</span> <span class="n">this</span><span class="o">),</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_mul</span><span class="o">,</span> <span class="n">mul_div_cancel_left</span> <span class="bp">_</span> <span class="n">n_nonzero</span><span class="o">],</span>
<span class="kn">end</span>
</code></pre></div>



<a name="202244265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202244265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202244265">(Jun 28 2020 at 16:43)</a>:</h4>
<p>Maybe this will help you for the second part:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">lemma</span> <span class="n">thing</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">p_prime</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">b_nonzero</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">dvd</span> <span class="o">:</span> <span class="n">p</span> <span class="err">∣</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="o">(</span><span class="n">b</span> <span class="bp">/</span> <span class="n">p</span><span class="o">))</span> <span class="bp">=</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span><span class="o">)</span> <span class="bp">-</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">let</span> <span class="n">e</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">div</span> <span class="n">p</span> <span class="n">p_prime</span> <span class="n">b</span> <span class="n">p</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="n">b_nonzero</span><span class="o">)</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">ne_zero</span> <span class="n">p_prime</span><span class="o">)),</span>
  <span class="n">rw</span> <span class="bp">@</span><span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">padic_val_rat_self</span> <span class="n">p</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">one_lt</span> <span class="n">p_prime</span><span class="o">)</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">rw</span> <span class="err">←</span> <span class="bp">@</span><span class="n">padic_val_rat_of_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">rw</span> <span class="bp">&lt;-</span> <span class="bp">@</span><span class="n">cast_dvd</span> <span class="n">ℚ</span> <span class="bp">_</span> <span class="n">b</span> <span class="n">p</span> <span class="n">dvd</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="mi">2</span> <span class="err">$</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">ne_zero</span> <span class="n">p_prime</span><span class="o">)</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">rw</span> <span class="bp">&lt;-</span> <span class="bp">@</span><span class="n">padic_val_rat_of_nat</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">int</span><span class="bp">.</span><span class="n">coe_nat_inj</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">e</span><span class="o">,</span> <span class="n">int</span><span class="bp">.</span><span class="n">coe_nat_sub</span><span class="o">],</span> <span class="o">{</span><span class="n">simp</span><span class="o">},</span>
  <span class="n">sorry</span><span class="o">,</span>
<span class="kn">end</span>
</code></pre></div>



<a name="202244531"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202244531" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202244531">(Jun 28 2020 at 16:50)</a>:</h4>
<p>You also don't have to provide as many arguments to the rewrites if you do them from left to right:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">lemma</span> <span class="n">thing</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">p_prime</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">b_nonzero</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">dvd</span> <span class="o">:</span> <span class="n">p</span> <span class="err">∣</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="o">(</span><span class="n">b</span> <span class="bp">/</span> <span class="n">p</span><span class="o">))</span> <span class="bp">=</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span><span class="o">)</span> <span class="bp">-</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">int</span><span class="bp">.</span><span class="n">coe_nat_inj</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">b0&#39;</span> <span class="o">:</span> <span class="o">(</span><span class="n">b</span><span class="o">:</span><span class="n">ℚ</span><span class="o">)</span> <span class="bp">≠</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="mi">2</span> <span class="n">b_nonzero</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">p0&#39;</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span><span class="o">:</span><span class="n">ℚ</span><span class="o">)</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="o">,</span> <span class="n">exact</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">ne_zero</span> <span class="n">p_prime</span> <span class="o">},</span>
  <span class="n">haveI</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">)</span> <span class="o">:=</span> <span class="n">p_prime</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">padic_val_rat_of_nat</span><span class="o">,</span> <span class="n">cast_dvd</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">dvd</span> <span class="n">p0&#39;</span><span class="o">,</span>
    <span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">div</span> <span class="n">p</span> <span class="n">b0&#39;</span> <span class="n">p0&#39;</span><span class="o">,</span>
    <span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">padic_val_rat_self</span> <span class="n">p_prime</span><span class="bp">.</span><span class="n">one_lt</span><span class="o">,</span>
    <span class="n">int</span><span class="bp">.</span><span class="n">coe_nat_sub</span><span class="o">,</span> <span class="n">padic_val_rat_of_nat</span><span class="o">,</span> <span class="n">int</span><span class="bp">.</span><span class="n">coe_nat_one</span><span class="o">],</span>
  <span class="n">sorry</span><span class="o">,</span>
<span class="kn">end</span>
</code></pre></div>



<a name="202244556"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202244556" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202244556">(Jun 28 2020 at 16:51)</a>:</h4>
<p><span class="user-mention" data-user-id="117987">@Patrick Stevens</span></p>



<a name="202250719"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202250719" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202250719">(Jun 28 2020 at 19:25)</a>:</h4>
<p>You just have to learn the knack. <code>lemma bad (b p : nat) : (b : ℚ) / (p : ℚ) = (((b : ℕ) / (p : ℕ)) : ℚ) := rfl</code> works because Lean knows the RHS is a rational so it deduces that <code>/</code> is rat.div` and then it coerces b and p into Q before doing the division. You need to tell Lean the division is still happening in nat, that's what it guesses incorrectly.</p>



<a name="202256510"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202256510" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Stevens <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202256510">(Jun 28 2020 at 21:33)</a>:</h4>
<p>Thanks all, I'll stare at these</p>



<a name="202256526"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202256526" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202256526">(Jun 28 2020 at 21:34)</a>:</h4>
<p>It took me a while. You go from outside in. I used to be forever checking types when I was doing this the first time</p>



<a name="202279517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202279517" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Stevens <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202279517">(Jun 29 2020 at 07:36)</a>:</h4>
<p>This is what I mean when I say I don't know how to control the type of anything: I have not yet found <em>any</em> type annotations I can place on the last line while retaining an expression that type-checks, and I don't know what types the things on the left or right hand side of <code>f</code> are. When I hover over them in the Lean widget, it tells me it's coercing to Z, but when I try and annotate anything as being in Z, the nat.cast_sub stops compiling, with an error message that tells me two identical terms are not equal. (Obviously the terms aren't identical - one of them has been coerced to a different type than the other. But I have no idea what those types are.)</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span>
<span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">nat</span><span class="bp">.</span><span class="n">multiplicity</span>
<span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">padics</span><span class="bp">.</span><span class="n">padic_norm</span>
<span class="kn">import</span> <span class="n">tactic</span>
<span class="kn">import</span> <span class="n">ring_theory</span><span class="bp">.</span><span class="n">multiplicity</span>

<span class="kn">theorem</span> <span class="n">cast_dvd</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">field</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">n_dvd</span> <span class="o">:</span> <span class="n">n</span> <span class="err">∣</span> <span class="n">m</span><span class="o">)</span> <span class="o">(</span><span class="n">n_nonzero</span> <span class="o">:</span> <span class="o">(</span><span class="n">n</span><span class="o">:</span><span class="n">α</span><span class="o">)</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="o">((</span><span class="n">m</span> <span class="bp">/</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="bp">=</span> <span class="n">m</span> <span class="bp">/</span> <span class="n">n</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rcases</span> <span class="n">n_dvd</span> <span class="k">with</span> <span class="bp">⟨</span><span class="n">k</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="k">have</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">,</span> <span class="o">{</span><span class="n">rintro</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">simpa</span> <span class="kn">using</span> <span class="n">n_nonzero</span><span class="o">},</span>
  <span class="n">rw</span> <span class="n">nat</span><span class="bp">.</span><span class="n">mul_div_cancel_left</span> <span class="bp">_</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">pos_iff_ne_zero</span><span class="bp">.</span><span class="mi">2</span> <span class="n">this</span><span class="o">),</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_mul</span><span class="o">,</span> <span class="n">mul_div_cancel_left</span> <span class="bp">_</span> <span class="n">n_nonzero</span><span class="o">],</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">padic_val_nat_of_quot</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">p_prime</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">b_nonzero</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">dvd</span> <span class="o">:</span> <span class="n">p</span> <span class="err">∣</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="o">(</span><span class="n">b</span> <span class="bp">/</span> <span class="n">p</span><span class="o">))</span> <span class="bp">=</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span><span class="o">)</span> <span class="bp">-</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">let</span> <span class="n">e</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">div</span> <span class="n">p</span> <span class="n">p_prime</span> <span class="n">b</span> <span class="n">p</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="n">b_nonzero</span><span class="o">)</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">ne_zero</span> <span class="n">p_prime</span><span class="o">)),</span>
  <span class="n">rw</span> <span class="bp">@</span><span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">padic_val_rat_self</span> <span class="n">p</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">one_lt</span> <span class="n">p_prime</span><span class="o">)</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">rw</span> <span class="err">←</span> <span class="bp">@</span><span class="n">padic_val_rat_of_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">rw</span> <span class="bp">&lt;-</span> <span class="bp">@</span><span class="n">cast_dvd</span> <span class="n">ℚ</span> <span class="bp">_</span> <span class="n">b</span> <span class="n">p</span> <span class="n">dvd</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">ne_zero</span> <span class="n">p_prime</span><span class="o">))</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="n">rw</span> <span class="bp">&lt;-</span> <span class="bp">@</span><span class="n">padic_val_rat_of_nat</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">r</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">≤</span> <span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">sorry</span><span class="o">,</span> <span class="c1">-- I can do this</span>

  <span class="k">have</span> <span class="n">f</span> <span class="o">:</span> <span class="err">↑</span><span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="bp">-</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">=</span> <span class="err">↑</span><span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span><span class="o">)</span> <span class="bp">-</span> <span class="err">↑</span><span class="mi">1</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_sub</span> <span class="bp">ℤ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">r</span><span class="o">,</span>
<span class="kn">end</span>
</code></pre></div>


<p>The aim is to append these lines to get a <code>u</code> that type-checks, but currently <code>f.symm</code> is of the wrong type (although the error message does not help me work out what that type is):</p>
<div class="codehilite"><pre><span></span><code>  <span class="k">have</span> <span class="n">s</span> <span class="o">:</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="bp">-</span> <span class="err">↑</span><span class="mi">1</span> <span class="bp">=</span> <span class="err">↑</span><span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span><span class="o">)</span> <span class="bp">-</span> <span class="mi">1</span><span class="o">,</span> <span class="k">by</span> <span class="n">congr</span><span class="o">,</span>
  <span class="n">rw</span> <span class="bp">&lt;-</span> <span class="n">s</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="k">let</span> <span class="n">u</span> <span class="o">:=</span> <span class="n">eq</span><span class="bp">.</span><span class="n">trans</span> <span class="n">e</span> <span class="o">(</span><span class="n">f</span><span class="bp">.</span><span class="n">symm</span><span class="o">),</span>
</code></pre></div>



<a name="202279784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202279784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Stevens <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202279784">(Jun 29 2020 at 07:40)</a>:</h4>
<p>Ah, I found an unhelpful type annotation I can place without breaking things: I can note that either of the <code>1</code>s is a <code>nat</code>. But that doesn't tell me what anything has been coerced to.</p>



<a name="202282072"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282072" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282072">(Jun 29 2020 at 08:11)</a>:</h4>
<p>I don't have long to look at this now, but the fact that you are writing <code>↑</code> by hand seems like a bad idea. Always write <code>(x : T)</code> when you want to make coercions.</p>



<a name="202282165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282165">(Jun 29 2020 at 08:12)</a>:</h4>
<p>What do you want <code>f</code> to say?</p>



<a name="202282515"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282515" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282515">(Jun 29 2020 at 08:16)</a>:</h4>
<p>When I copy-paste your code I get <code>unknown identifier 'padic_val_nat'</code>.</p>



<a name="202282579"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282579" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282579">(Jun 29 2020 at 08:17)</a>:</h4>
<p>Hmm... I don't!</p>



<a name="202282663"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282663" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282663">(Jun 29 2020 at 08:18)</a>:</h4>
<p>Oops, I needed to restart Lean after updating.</p>



<a name="202282737"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282737" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282737">(Jun 29 2020 at 08:19)</a>:</h4>
<p>Now I can ask "What do you want <code>f</code> to say?".</p>



<a name="202282831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282831">(Jun 29 2020 at 08:20)</a>:</h4>
<p>So if you replace the last line with</p>
<div class="codehilite"><pre><span></span><code>  <span class="k">have</span> <span class="n">f</span> <span class="o">:</span> <span class="o">((</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="bp">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="bp">-</span> <span class="o">((</span><span class="mi">1</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">convert</span> <span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_sub</span> <span class="bp">ℤ</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">r</span><span class="o">,</span>
</code></pre></div>



<a name="202282840"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282840" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282840">(Jun 29 2020 at 08:20)</a>:</h4>
<p>you at least get a manageable error message</p>



<a name="202282845"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282845" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282845">(Jun 29 2020 at 08:20)</a>:</h4>
<p>But at least I can finish the proof: <code>exact_mod_cast e</code>.</p>



<a name="202282861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282861" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282861">(Jun 29 2020 at 08:20)</a>:</h4>
<p>:-)</p>



<a name="202282992"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202282992" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202282992">(Jun 29 2020 at 08:22)</a>:</h4>
<p>I would advise trusting in Patrick's answer, but if you want to dig deeper you'll have to work out why there are two different ways the coercion is happening. :-(</p>



<a name="202283005"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202283005" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202283005">(Jun 29 2020 at 08:22)</a>:</h4>
<p>The unsolved goal from my last line is <code>coe_base = nat.cast_coe</code>, ... which isn't a good sign!</p>



<a name="202284230"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202284230" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202284230">(Jun 29 2020 at 08:38)</a>:</h4>
<p>I did a bit of cleanup, but now I should work instead:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span>
<span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">nat</span><span class="bp">.</span><span class="n">multiplicity</span>
<span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">padics</span><span class="bp">.</span><span class="n">padic_norm</span>
<span class="kn">import</span> <span class="n">tactic</span>
<span class="kn">import</span> <span class="n">ring_theory</span><span class="bp">.</span><span class="n">multiplicity</span>

<span class="kn">theorem</span> <span class="n">cast_dvd</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">field</span> <span class="n">α</span><span class="o">]</span> <span class="o">{</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">(</span><span class="n">n_dvd</span> <span class="o">:</span> <span class="n">n</span> <span class="err">∣</span> <span class="n">m</span><span class="o">)</span> <span class="o">(</span><span class="n">n_nonzero</span> <span class="o">:</span> <span class="o">(</span><span class="n">n</span><span class="o">:</span><span class="n">α</span><span class="o">)</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="o">((</span><span class="n">m</span> <span class="bp">/</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="bp">=</span> <span class="n">m</span> <span class="bp">/</span> <span class="n">n</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rcases</span> <span class="n">n_dvd</span> <span class="k">with</span> <span class="bp">⟨</span><span class="n">k</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="k">have</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">,</span> <span class="o">{</span><span class="n">rintro</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">simpa</span> <span class="kn">using</span> <span class="n">n_nonzero</span><span class="o">},</span>
  <span class="n">rw</span> <span class="n">nat</span><span class="bp">.</span><span class="n">mul_div_cancel_left</span> <span class="bp">_</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">pos_iff_ne_zero</span><span class="bp">.</span><span class="mi">2</span> <span class="n">this</span><span class="o">),</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_mul</span><span class="o">,</span> <span class="n">mul_div_cancel_left</span> <span class="bp">_</span> <span class="n">n_nonzero</span><span class="o">],</span>
<span class="kn">end</span>

<span class="bp">@</span><span class="o">[</span><span class="n">norm_cast</span><span class="o">]</span>
<span class="kn">theorem</span> <span class="n">cast_dvd_char_zero</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">field</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">char_zero</span> <span class="n">α</span> <span class="o">]</span> <span class="o">{</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">(</span><span class="n">n_dvd</span> <span class="o">:</span> <span class="n">n</span> <span class="err">∣</span> <span class="n">m</span><span class="o">)</span> <span class="o">:</span> <span class="o">((</span><span class="n">m</span> <span class="bp">/</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="bp">=</span> <span class="n">m</span> <span class="bp">/</span> <span class="n">n</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">by_cases</span> <span class="n">hn</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">subst</span> <span class="n">hn</span><span class="o">,</span>
    <span class="n">simp</span> <span class="o">},</span>
  <span class="n">exact</span> <span class="n">cast_dvd</span> <span class="n">n_dvd</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="n">hn</span><span class="o">),</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">padic_val_nat_of_quot</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">(</span><span class="n">p_prime</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span><span class="n">b</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">(</span><span class="n">b_nonzero</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">dvd</span> <span class="o">:</span> <span class="n">p</span> <span class="err">∣</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="o">(</span><span class="n">b</span> <span class="bp">/</span> <span class="n">p</span><span class="o">))</span> <span class="bp">=</span> <span class="o">(</span><span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span><span class="o">)</span> <span class="bp">-</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">haveI</span> <span class="o">:</span> <span class="n">fact</span> <span class="n">p</span><span class="bp">.</span><span class="n">prime</span> <span class="o">:=</span> <span class="n">p_prime</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">e</span> <span class="o">:=</span> <span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">div</span> <span class="n">p</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="n">b_nonzero</span><span class="o">)</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_ne_zero</span><span class="bp">.</span><span class="n">mpr</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">ne_zero</span> <span class="n">p_prime</span><span class="o">)),</span>
  <span class="n">rw</span> <span class="n">padic_val_rat</span><span class="bp">.</span><span class="n">padic_val_rat_self</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">one_lt</span> <span class="n">p_prime</span><span class="o">)</span> <span class="n">at</span> <span class="n">e</span><span class="o">,</span>
  <span class="k">have</span> <span class="n">r</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">≤</span> <span class="n">padic_val_nat</span> <span class="n">p</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">sorry</span><span class="o">,</span> <span class="c1">-- I can do this</span>
  <span class="n">exact_mod_cast</span> <span class="n">e</span><span class="o">,</span>
<span class="kn">end</span>
</code></pre></div>



<a name="202298665"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202298665" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Stevens <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202298665">(Jun 29 2020 at 11:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat/near/202282072">said</a>:</p>
<blockquote>
<p>I don't have long to look at this now, but the fact that you are writing <code>↑</code> by hand seems like a bad idea. Always write <code>(x : T)</code> when you want to make coercions.</p>
</blockquote>
<p>Ah OK, thanks - I was essentially copy-pasting out of the goal window at that point; just wanted to construct terms that I could <code>rw</code> by to make progress</p>



<a name="202298749"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202298749" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Stevens <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202298749">(Jun 29 2020 at 11:51)</a>:</h4>
<p>Thanks again all, I will stare harder at these examples</p>



<a name="202299403"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Coercion%20between%20nat%20and%20rat/near/202299403" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Coercion.20between.20nat.20and.20rat.html#202299403">(Jun 29 2020 at 11:59)</a>:</h4>
<p>I often find myself deleting arrows which I've cut and pasted from goal windows</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>