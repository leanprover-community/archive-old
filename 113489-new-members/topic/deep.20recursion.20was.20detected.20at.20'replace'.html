---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html">deep recursion was detected at 'replace'</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="212331185"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212331185" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212331185">(Oct 05 2020 at 17:30)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="mi">6</span> <span class="bp">*</span> <span class="mi">10</span> <span class="bp">^</span> <span class="mi">5</span> <span class="bp">+</span> <span class="n">c</span> <span class="bp">=</span> <span class="mi">4</span> <span class="bp">*</span> <span class="o">(</span><span class="mi">10</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="mi">6</span><span class="o">))</span> <span class="o">:</span> <span class="mi">599976</span> <span class="bp">=</span> <span class="mi">39</span> <span class="bp">*</span> <span class="n">c</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">linarith</span>
</code></pre></div>

<p>when i try to compile this i get an error saying "deep recursion was detected at 'replace'. potential solution: increase stack space". for other expressions of this form but with smaller numbers, it works fine. is this just, the numbers are too large to handle? any suggestion for what to do about it?</p>



<a name="212331908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212331908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212331908">(Oct 05 2020 at 17:36)</a>:</h4>
<p>No, this should be fine. Somehow <code>ring</code> must be triggering kernel reduction on natural number arithmetic (cc <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> ):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="mi">6</span> <span class="bp">*</span> <span class="mi">10</span> <span class="bp">^</span> <span class="mi">5</span> <span class="bp">+</span> <span class="n">c</span> <span class="bp">-</span> <span class="mi">4</span> <span class="bp">*</span> <span class="o">(</span><span class="mi">10</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="mi">6</span><span class="o">)</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">39</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">-</span> <span class="mi">599976</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">ring</span> <span class="c1">-- deep recursion detected</span>
</code></pre></div>



<a name="212331963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212331963" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212331963">(Oct 05 2020 at 17:36)</a>:</h4>
<p>It works if you make <code>c</code> an integer (or anything other than a nat pobably).</p>



<a name="212332403"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212332403" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212332403">(Oct 05 2020 at 17:40)</a>:</h4>
<p>is there a way to jump from, statement x is true about the natural number c, to statement x is true in the integers about c</p>



<a name="212333536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212333536" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212333536">(Oct 05 2020 at 17:50)</a>:</h4>
<p>The <code>zify</code> tactic.</p>



<a name="212334287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212334287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212334287">(Oct 05 2020 at 17:57)</a>:</h4>
<p>aha that's exactly what i wanted! thanks</p>



<a name="212342608"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212342608" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212342608">(Oct 05 2020 at 19:01)</a>:</h4>
<p>hmm, I'm still getting these deep recursion errors sometimes with integers. for example, this line gets a deep recursion error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">helper</span> <span class="o">(</span><span class="n">c</span> <span class="n">n</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">=</span> <span class="mi">10</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="mi">6</span><span class="o">)</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="mi">10</span> <span class="bp">^</span> <span class="mi">6</span> <span class="bp">≤</span> <span class="mi">10</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">≥</span> <span class="mi">153846</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">linarith</span>
</code></pre></div>



<a name="212343011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212343011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212343011">(Oct 05 2020 at 19:04)</a>:</h4>
<p>But maybe you can help it with a little bit of rewriting, <code>le_trans</code> and <code>norm_num</code>?</p>



<a name="212343125"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212343125" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212343125">(Oct 05 2020 at 19:05)</a>:</h4>
<p>i'm trying, it's just a lot of rewriting. even this fails: <code>lemma helper (n : ℕ) (h : 1000000 ≤ n) : n ≥ 153846 := by linarith</code></p>



<a name="212343331"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212343331" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212343331">(Oct 05 2020 at 19:07)</a>:</h4>
<p>First <code>rw h1</code> and then</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">calc</span> <span class="n">_</span> <span class="bp">\</span><span class="n">ge</span> <span class="mi">10</span> <span class="bp">*</span> <span class="n">c</span> <span class="o">:</span> <span class="kd">by</span> <span class="n">norm_num</span>
<span class="bp">...</span> <span class="bp">\</span><span class="n">ge</span> <span class="mi">10</span> <span class="bp">^</span> <span class="mi">6</span> <span class="o">:</span> <span class="n">h2</span>
<span class="bp">...</span> <span class="bp">\</span><span class="n">ge</span> <span class="mi">153846</span> <span class="o">:</span> <span class="kd">by</span> <span class="n">norm_num</span>
</code></pre></div>



<a name="212343607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212343607" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212343607">(Oct 05 2020 at 19:09)</a>:</h4>
<p>you can prove <code>153846 \le 10 ^ 6</code> by norm_num?</p>



<a name="212343738"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212343738" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212343738">(Oct 05 2020 at 19:11)</a>:</h4>
<p>well, looks like that works. success</p>



<a name="212347415"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212347415" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212347415">(Oct 05 2020 at 19:45)</a>:</h4>
<p>Wait, how is <code>ring</code> supposed to prove Rob's goal? It uses nat subtraction</p>



<a name="212347686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212347686" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212347686">(Oct 05 2020 at 19:48)</a>:</h4>
<p>Oh, good point -- that makes this more curious.</p>



<a name="212348745"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212348745" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212348745">(Oct 05 2020 at 19:58)</a>:</h4>
<p>Kevin's original goal doesn't use subtraction, so presumably <code>linarith</code> wouldn't have introduced it</p>



<a name="212349041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212349041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212349041">(Oct 05 2020 at 20:00)</a>:</h4>
<p>It would have, after zifying. I copied that goal from somewhere in the trace output but it should have had casts in it.</p>



<a name="212349062"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212349062" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212349062">(Oct 05 2020 at 20:00)</a>:</h4>
<p>In the middle of something else, I'll look again in a bit</p>



<a name="212349784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212349784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212349784">(Oct 05 2020 at 20:06)</a>:</h4>
<p>the simplest example of something that I expected to work but did not is: <code>example : 123456 &lt; 1000000 := by linarith</code></p>



<a name="212349795"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212349795" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212349795">(Oct 05 2020 at 20:06)</a>:</h4>
<p><code>norm_num</code> does solve that</p>



<a name="212351028"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212351028" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212351028">(Oct 05 2020 at 20:17)</a>:</h4>
<p>Huh.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">constant</span> <span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span>
<span class="kd">axiom</span> <span class="n">h</span> <span class="o">:</span> <span class="mi">39</span><span class="bp">*</span><span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="mi">599976</span>

<span class="k">#check</span> <span class="n">id_rhs</span> <span class="o">(</span><span class="mi">39</span><span class="bp">*</span><span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">≤</span> <span class="mi">599976</span><span class="o">)</span> <span class="n">h</span> <span class="c1">-- deep recursion</span>
</code></pre></div>



<a name="212353241"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212353241" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212353241">(Oct 05 2020 at 20:35)</a>:</h4>
<p>Who is doing that?</p>



<a name="212353870"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212353870" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212353870">(Oct 05 2020 at 20:41)</a>:</h4>
<p>I've learned the hard way that you can't rely on definitional unfolding like that going the way you want. If you need to do that unfolding you should apply a lemma that says so</p>



<a name="212354090"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212354090" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212354090">(Oct 05 2020 at 20:43)</a>:</h4>
<p>It's done in linarith, but even applying the lemma seems to cause the same error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">constant</span> <span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span>
<span class="kd">axiom</span> <span class="n">h</span> <span class="o">:</span> <span class="mi">39</span><span class="bp">*</span><span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="bp">&lt;</span> <span class="mi">599976</span>

<span class="k">#check</span> <span class="n">int.add_one_le_iff.mpr</span> <span class="n">h</span> <span class="c1">-- deep recursion</span>
</code></pre></div>



<a name="212354138"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212354138" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212354138">(Oct 05 2020 at 20:43)</a>:</h4>
<p>There should be no unfolding at all there, or am I missing something?</p>



<a name="212354310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212354310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212354310">(Oct 05 2020 at 20:45)</a>:</h4>
<p><code>attribute [irreducible] int.le</code> fixes it</p>



<a name="212359684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212359684" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212359684">(Oct 05 2020 at 21:33)</a>:</h4>
<p>Curiouser:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#check</span> <span class="n">iff.mpr</span> <span class="o">(</span><span class="bp">@</span><span class="n">int.add_one_le_iff</span> <span class="o">(</span><span class="mi">39</span><span class="bp">*</span><span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="mi">599976</span><span class="o">)</span> <span class="c1">-- deep recursion</span>
</code></pre></div>



<a name="212359705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212359705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212359705">(Oct 05 2020 at 21:33)</a>:</h4>
<p>we haven't even applied <code>h</code> yet</p>



<a name="212359736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212359736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212359736">(Oct 05 2020 at 21:33)</a>:</h4>
<p>This is fine:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#check</span> <span class="bp">@</span><span class="n">iff.mpr</span> <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">int.add_one_le_iff</span> <span class="o">(</span><span class="mi">39</span><span class="bp">*</span><span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="mi">599976</span><span class="o">)</span>
</code></pre></div>



<a name="212360087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212360087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212360087">(Oct 05 2020 at 21:37)</a>:</h4>
<p>wait, what?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#check</span> <span class="n">h</span> <span class="c1">-- deep recursion</span>
</code></pre></div>



<a name="212360578"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212360578" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212360578">(Oct 05 2020 at 21:43)</a>:</h4>
<p>ah, crap, I know what this is</p>



<a name="212360605"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212360605" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212360605">(Oct 05 2020 at 21:43)</a>:</h4>
<p>I just remembered that <code>int.lt</code> is defined to be either <code>true</code> or <code>false</code> depending on the result of recursion</p>



<a name="212360710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212360710" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212360710">(Oct 05 2020 at 21:45)</a>:</h4>
<p>which means that when you have something of type <code>int.lt something something</code>, it's not immediately obvious that this is even well typed, because it might evaluate to something other than a proposition</p>



<a name="212360955"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212360955" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212360955">(Oct 05 2020 at 21:48)</a>:</h4>
<p>Basically this is a term for which <code>infer_type</code> blows up</p>



<a name="212361535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212361535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212361535">(Oct 05 2020 at 21:55)</a>:</h4>
<p>No, that's not right. <code>infer_type</code> is fine but <code>to_expr</code> blows up</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="o">:=</span> <span class="n">sorry</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">@</span><span class="n">coe</span> <span class="n">ℕ</span> <span class="n">ℤ</span> <span class="n">_</span> <span class="n">c</span> <span class="bp">&lt;</span> <span class="mi">5999</span><span class="o">)</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="k">do</span>
  <span class="o">[</span><span class="n">h</span><span class="o">]</span> <span class="bp">←</span> <span class="n">tactic.local_context</span><span class="o">,</span>
  <span class="n">tactic.infer_type</span> <span class="n">h</span> <span class="bp">&gt;&gt;=</span> <span class="n">tactic.trace</span><span class="o">,</span>
  <span class="n">e</span> <span class="bp">←</span> <span class="n">tactic.mk_app</span> <span class="bp">`</span><span class="n">id</span> <span class="o">[</span><span class="n">h</span><span class="o">],</span>
  <span class="n">tactic.infer_type</span> <span class="n">e</span> <span class="bp">&gt;&gt;=</span> <span class="n">tactic.trace</span><span class="o">,</span>
  <span class="n">tactic.to_expr</span> <span class="bp">```</span><span class="o">(</span><span class="n">h</span><span class="o">),</span> <span class="c1">-- boom</span>
  <span class="n">tactic.admit</span>
</code></pre></div>



<a name="212361680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212361680" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212361680">(Oct 05 2020 at 21:57)</a>:</h4>
<p>IIRC <code>linarith</code> uses a lot of pexpr quotations to construct its terms. Maybe it should switch to using <code>instance_cache.mk_app</code> like <code>ring</code> does?</p>



<a name="212408435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212408435" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212408435">(Oct 06 2020 at 10:25)</a>:</h4>
<p>Arguably it should, but that seems like a heavy change for this weird issue. With Gabriel's type class caching improvements <code>linarith</code> doesn't spend a huge amount of time in type class search, and <code>instance_cache</code> is kind of an inconvenient workaround for things that should be faster natively.</p>



<a name="212408484"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212408484" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212408484">(Oct 06 2020 at 10:26)</a>:</h4>
<p>I'm trying to make <code>int.le</code> irreducible, it's going alright so far.</p>



<a name="212416458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212416458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212416458">(Oct 06 2020 at 11:58)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/4474">#4474</a></p>



<a name="212541868"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212541868" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212541868">(Oct 07 2020 at 10:57)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> returning to this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.ring</span>
<span class="kd">example</span> <span class="o">:</span> <span class="o">(</span><span class="mi">876544</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="bp">*</span> <span class="bp">-</span><span class="mi">1</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">1000000</span> <span class="bp">-</span> <span class="mi">123456</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">ring</span> <span class="c1">-- deep recursion detected</span>
</code></pre></div>

<p>The problem is at type checking time. <code>ring</code> succeeds and produces a proof that <code>infer_type</code> thinks is right, but the kernel doesn't like it. Neither does <code>tactic.type_check</code>. The proof comes mostly from <code>norm_num</code> as you would expect, and using <code>norm_num</code> directly works fine, so I'm a little confused.</p>



<a name="212543183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212543183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212543183">(Oct 07 2020 at 11:12)</a>:</h4>
<p>Aha: If I use this to get the proof that was sent:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="o">(</span><span class="mi">9477</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="bp">*</span> <span class="bp">-</span><span class="mi">1</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">10000</span> <span class="bp">-</span> <span class="mi">523</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="k">do</span>
  <span class="o">[</span><span class="n">g</span><span class="o">]</span> <span class="bp">←</span> <span class="n">tactic.get_goals</span><span class="o">,</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">ring</span><span class="o">],</span>
  <span class="n">tactic.trace</span> <span class="n">g</span>
</code></pre></div>

<p>and remove parts to get a MWE, I get this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="o">(</span><span class="mi">9477</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="bp">*</span> <span class="bp">-</span><span class="mi">1</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">10000</span> <span class="bp">-</span> <span class="mi">523</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="n">norm_num.subst_into_add</span> <span class="o">(</span><span class="mi">9477</span> <span class="bp">*</span> <span class="bp">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="mi">10000</span> <span class="bp">-</span> <span class="mi">523</span><span class="o">)</span> <span class="o">(</span><span class="bp">-</span><span class="mi">9477</span><span class="o">)</span> <span class="mi">9477</span> <span class="mi">0</span>
  <span class="n">sorry</span>
  <span class="o">(</span><span class="n">tactic.ring.unfold_sub</span> <span class="mi">10000</span> <span class="mi">523</span> <span class="mi">9477</span>
     <span class="n">sorry</span><span class="o">)</span>
  <span class="n">sorry</span>
</code></pre></div>

<p>Here</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">tactic.ring.unfold_sub</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">_inst_1</span> <span class="o">:</span> <span class="n">add_group</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span> <span class="n">a</span> <span class="bp">+</span> <span class="bp">-</span><span class="n">b</span> <span class="bp">=</span> <span class="n">c</span> <span class="bp">→</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">c</span>
</code></pre></div>

<p>is used to prove</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">(</span><span class="mi">10000</span> <span class="bp">-</span> <span class="mi">523</span> <span class="o">:</span> <span class="n">int</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">9477</span>
</code></pre></div>



<a name="212543362"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212543362" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212543362">(Oct 07 2020 at 11:14)</a>:</h4>
<p>And sure enough, if I look at the <code>norm_num</code> proof there is a suspicious application of a theorem called</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">(</span><span class="n">norm_num.int_sub_hack</span> <span class="mi">10000</span> <span class="mi">523</span> <span class="mi">9477</span>
              <span class="o">(</span><span class="n">norm_num.sub_pos</span> <span class="mi">10000</span> <span class="mi">523</span> <span class="o">(</span><span class="bp">-</span><span class="mi">523</span><span class="o">)</span> <span class="mi">9477</span> <span class="o">(</span><span class="n">eq.refl</span> <span class="o">(</span><span class="bp">-</span><span class="mi">523</span><span class="o">))</span>
<span class="bp">...</span>
</code></pre></div>

<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="sd">/-- This is needed because when `a` and `b` are numerals lean is more likely to unfold them</span>
<span class="sd">than unfold the instances in order to prove that `add_group_has_sub = int.has_sub`. -/</span>
<span class="kd">theorem</span> <span class="n">int_sub_hack</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">@</span><span class="n">has_sub.sub</span> <span class="n">ℤ</span> <span class="n">add_group_has_sub</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">c</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">c</span> <span class="o">:=</span> <span class="n">h</span>
</code></pre></div>



<a name="212543605"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212543605" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212543605">(Oct 07 2020 at 11:17)</a>:</h4>
<p>That does look suspicious!</p>



<a name="212544071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/deep%20recursion%20was%20detected%20at%20%27replace%27/near/212544071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/deep.20recursion.20was.20detected.20at.20'replace'.html#212544071">(Oct 07 2020 at 11:22)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/4503">#4503</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>