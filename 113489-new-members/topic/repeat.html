---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/repeat.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html">repeat</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="252128379"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/252128379" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#252128379">(Sep 06 2021 at 05:26)</a>:</h4>
<p>The documentation for repeat says: "... the tactic is applied recursively to all the generated subgoals until it eventually fails. The recursion stops in a subgoal when the tactic has failed to make progress."</p>
<p>Which is it: Is it applied recursively until it fails, or until it fails to make progress?</p>



<a name="253894896"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253894896" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253894896">(Sep 18 2021 at 21:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="282271">Bolton Bailey</span> has marked this topic as unresolved.</p>



<a name="253895519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253895519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253895519">(Sep 18 2021 at 21:39)</a>:</h4>
<p>I'll reopen this thread and ask again because I just don't understand what I'm seeing. <br>
The code I'm working on is a bit too complicated to post an mwe, so hopefully you can bear with me. In the code below, I get an output with two different goals. It reports the error <code>error: solve1 tactic failed, focused goal has not been solved</code> on the final closing bracket. This suggests to me that at the very least , lines 4-6 below are not causing an error. But when I comment those lines out and rerun the program, I get <em>a different output</em>, which only has one goal, (but still says the same error that the goal is not solved by the final bracket).</p>
<p>This makes no sense to me, because, based om my reading of <a href="https://leanprover-community.github.io/mathlib_docs/find/repeat">docs#repeat</a>, if the middle three lines don't cause a failure, the output of <code>t, repeat { t, },</code> should be the same as <code>repeat { t, },</code>. What gives?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">{</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="bp">*</span><span class="o">]</span> <span class="k">with</span> <span class="n">integral_domain_simp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span>

  <span class="n">try</span> <span class="o">{</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[]</span> <span class="k">with</span> <span class="n">integral_domain_simp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">clear</span> <span class="n">found_zero</span><span class="o">},</span> <span class="c1">-- clear "found_zero" if present</span>
  <span class="n">done</span> <span class="bp">&lt;|&gt;</span> <span class="kd">begin</span> <span class="n">cases</span> <span class="o">‹</span><span class="n">_</span> <span class="bp">∨</span> <span class="n">_</span><span class="o">›</span> <span class="k">with</span> <span class="n">found_zero</span> <span class="n">found_zero</span><span class="bp">;</span> <span class="n">rw</span> <span class="n">found_zero</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="kd">end</span><span class="o">,</span>

  <span class="n">repeat</span> <span class="o">{</span>
    <span class="n">try</span> <span class="o">{</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[]</span> <span class="k">with</span> <span class="n">integral_domain_simp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
    <span class="n">try</span> <span class="o">{</span><span class="n">clear</span> <span class="n">found_zero</span><span class="o">},</span> <span class="c1">-- clear "found_zero" if present</span>
    <span class="n">done</span> <span class="bp">&lt;|&gt;</span> <span class="kd">begin</span> <span class="n">cases</span> <span class="o">‹</span><span class="n">_</span> <span class="bp">∨</span> <span class="n">_</span><span class="o">›</span> <span class="k">with</span> <span class="n">found_zero</span> <span class="n">found_zero</span><span class="bp">;</span> <span class="n">rw</span> <span class="n">found_zero</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="kd">end</span> <span class="o">},</span>
<span class="o">}</span>
</code></pre></div>



<a name="253896116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896116" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896116">(Sep 18 2021 at 21:51)</a>:</h4>
<p>I would suggest replacing <code>repeat</code> with <code>iterate n</code> for different values of <code>n</code> and see for which values it succeeds</p>



<a name="253896186"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896186" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896186">(Sep 18 2021 at 21:52)</a>:</h4>
<p>It is worth noting that <code>begin ... end</code> in tactic mode is the same as <code>{ ... }</code>. In particular, it will fail if you haven't closed the goal at the end of the block</p>



<a name="253896309"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896309" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896309">(Sep 18 2021 at 21:55)</a>:</h4>
<p>This looks like an error reporting bug:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">theorem</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">true</span> <span class="bp">∧</span> <span class="n">true</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">done</span> <span class="bp">&lt;|&gt;</span> <span class="o">{</span>
    <span class="n">refine</span> <span class="o">⟨</span><span class="n">trivial</span><span class="o">,</span> <span class="n">_</span><span class="o">⟩,</span>
  <span class="o">},</span> <span class="c1">-- the error is actually here</span>

  <span class="c1">-- uncommenting this doesn't work</span>
  <span class="c1">-- refine trivial,</span>

<span class="kd">end</span> <span class="c1">-- but it is reported here</span>
</code></pre></div>



<a name="253896374"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896374" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896374">(Sep 18 2021 at 21:56)</a>:</h4>
<p>So what is really happening is that your first <code>begin cases</code> line is failing and the repeat never runs</p>



<a name="253896386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896386">(Sep 18 2021 at 21:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113489-new-members/topic/repeat/near/253896186">said</a>:</p>
<blockquote>
<p>It is worth noting that <code>begin ... end</code> in tactic mode is the same as <code>{ ... }</code>. In particular, it will fail if you haven't closed the goal at the end of the block</p>
</blockquote>
<p>This is certainly good to know.</p>



<a name="253896403"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896403" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896403">(Sep 18 2021 at 21:57)</a>:</h4>
<p>You should use <code>id { ... }</code> instead to group tactics without the implicit <code>done</code> at the end</p>



<a name="253896505"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896505" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896505">(Sep 18 2021 at 21:59)</a>:</h4>
<p>Sorry, what does <code>id</code> do?</p>



<a name="253896562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896562">(Sep 18 2021 at 22:00)</a>:</h4>
<p>it's a tactic combinator like <code>try</code></p>



<a name="253896589"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896589" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896589">(Sep 18 2021 at 22:00)</a>:</h4>
<p>it does nothing, it's the identity function</p>



<a name="253896620"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896620" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896620">(Sep 18 2021 at 22:01)</a>:</h4>
<p>but the <code>{ ... }</code> is part of the syntax, so it doesn't count as regular focusing brackets</p>



<a name="253896651"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896651" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896651">(Sep 18 2021 at 22:01)</a>:</h4>
<p>So you mean I should use</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">iterate</span> <span class="mi">2</span> <span class="n">id</span> <span class="o">{</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[]</span> <span class="k">with</span> <span class="n">integral_domain_simp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">clear</span> <span class="n">found_zero</span><span class="o">},</span> <span class="c1">-- clear "found_zero" if present</span>
  <span class="n">id</span> <span class="o">{</span><span class="n">cases</span> <span class="o">‹</span><span class="n">_</span> <span class="bp">∨</span> <span class="n">_</span><span class="o">›</span> <span class="k">with</span> <span class="n">found_zero</span> <span class="n">found_zero</span><span class="bp">;</span> <span class="n">rw</span> <span class="n">found_zero</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span> <span class="o">},</span>
</code></pre></div>
<p>And this will cause it to not fail if the goal is completed by the second line?</p>



<a name="253896698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896698" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896698">(Sep 18 2021 at 22:02)</a>:</h4>
<p>The braces after <code>iterate 2 { ... }</code> are also part of the syntax</p>



<a name="253896700"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896700" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896700">(Sep 18 2021 at 22:02)</a>:</h4>
<p>so that's not well formed</p>



<a name="253896718"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896718" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896718">(Sep 18 2021 at 22:02)</a>:</h4>
<p>Immediately after <code>iterate 2</code> though, you already have a tactic block argument, so you don't need the <code>id</code></p>



<a name="253896730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896730">(Sep 18 2021 at 22:03)</a>:</h4>
<p>It's useful in things like <code>done &lt;|&gt; id { ... }</code></p>



<a name="253896742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896742" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896742">(Sep 18 2021 at 22:03)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">iterate</span> <span class="mi">2</span>  <span class="o">{</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[]</span> <span class="k">with</span> <span class="n">integral_domain_simp</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
  <span class="n">try</span> <span class="o">{</span><span class="n">clear</span> <span class="n">found_zero</span><span class="o">},</span> <span class="c1">-- clear "found_zero" if present</span>
  <span class="n">done</span> <span class="bp">&lt;|&gt;</span> <span class="n">id</span> <span class="o">{</span><span class="n">cases</span> <span class="o">‹</span><span class="n">_</span> <span class="bp">∨</span> <span class="n">_</span><span class="o">›</span> <span class="k">with</span> <span class="n">found_zero</span> <span class="n">found_zero</span><span class="bp">;</span> <span class="n">rw</span> <span class="n">found_zero</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span> <span class="o">},</span>
</code></pre></div>



<a name="253896797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896797" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896797">(Sep 18 2021 at 22:04)</a>:</h4>
<p>you can probably replace <code>done &lt;|&gt; id ...</code> with <code>try ...</code> in this case</p>



<a name="253896821"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896821" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896821">(Sep 18 2021 at 22:04)</a>:</h4>
<p>Wouldn't that loop forever with repeat?</p>



<a name="253896825"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896825" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896825">(Sep 18 2021 at 22:04)</a>:</h4>
<p>yes it would</p>



<a name="253896845"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896845" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896845">(Sep 18 2021 at 22:05)</a>:</h4>
<p>I think <code>done</code> would as well though</p>



<a name="253896858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896858" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896858">(Sep 18 2021 at 22:05)</a>:</h4>
<p>if there are no goals then it will just spin with <code>done</code> succeeding every time</p>



<a name="253896906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896906" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896906">(Sep 18 2021 at 22:06)</a>:</h4>
<p>See the very first comment in this thread. The docs for repeat should probably be changed to not say "when the tactic has failed to make progress."</p>



<a name="253896916"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896916" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896916">(Sep 18 2021 at 22:06)</a>:</h4>
<p>"make progress" isn't something lean knows how to detect</p>



<a name="253896923"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896923" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896923">(Sep 18 2021 at 22:06)</a>:</h4>
<p>Exactly my point</p>



<a name="253896924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896924" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896924">(Sep 18 2021 at 22:06)</a>:</h4>
<p>it assumes that tactics fail when they fail to make progress</p>



<a name="253896929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253896929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253896929">(Sep 18 2021 at 22:06)</a>:</h4>
<p>which is generally true of front end tactics</p>



<a name="253897014"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253897014" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253897014">(Sep 18 2021 at 22:08)</a>:</h4>
<p>But not of all tactics, as I realized to my confusion a few weeks ago.</p>



<a name="253897029"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253897029" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253897029">(Sep 18 2021 at 22:09)</a>:</h4>
<p>If you use the more explicit structural tactics like <code>done</code> and <code>try</code> that's not quite true anymore</p>



<a name="253901067"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901067" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901067">(Sep 18 2021 at 23:30)</a>:</h4>
<p>Ok, I am confused again. <code>iterate { fail_if_success { done }, ... }</code> succeeds in producing 5 new simpler goals in 2 minutes or so. But <code>repeat { fail_if_success { done }, ... }</code> and <code>repeat { ... }</code> both seem to hang, taking at least 5 minutes. Why would these behave differently?</p>



<a name="253901070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901070">(Sep 18 2021 at 23:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="282271">Bolton Bailey</span> has marked this topic as unresolved.</p>



<a name="253901377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901377" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901377">(Sep 18 2021 at 23:37)</a>:</h4>
<p>It would really help if you made <a href="https://leanprover-community.github.io/mwe.html">#mwe</a>'s for this stuff</p>



<a name="253901447"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901447" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901447">(Sep 18 2021 at 23:38)</a>:</h4>
<p>Why are these tactics taking minutes? You aren't supposed to exhaust the recursion limit</p>



<a name="253901458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901458">(Sep 18 2021 at 23:38)</a>:</h4>
<p>Yes, sorry about that. Let me try to make a simpler mwe.</p>



<a name="253901547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901547">(Sep 18 2021 at 23:40)</a>:</h4>
<p>Part of the problem is there is a lot of code earlier on in the file that takes a while to run which generates these equations, and it's hard to separate that time from the time taken by the tactics we are talking about.</p>



<a name="253901567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901567" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901567">(Sep 18 2021 at 23:41)</a>:</h4>
<p>You seem to think that the actual content of the blocks doesn't matter, so make a MWE with a simpler block</p>



<a name="253901633"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901633" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901633">(Sep 18 2021 at 23:42)</a>:</h4>
<p>my examples use <code>split</code> and <code>trivial</code> which is usually good enough for interesting branching patterns</p>



<a name="253901667"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901667" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901667">(Sep 18 2021 at 23:43)</a>:</h4>
<p>If you need an expensive tactic, use <code>sleep</code></p>



<a name="253901941"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901941" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901941">(Sep 18 2021 at 23:48)</a>:</h4>
<p>I wonder if I should <a href="https://en.wikipedia.org/wiki/XY_problem">#xy</a> your problem though. This all looks very case-bashy and you haven't even shown what the goal is, but it looks like you are factoring a polynomial? I'm like 80% sure there is a better proof approach that involves specifying the factorization</p>



<a name="253901994"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253901994" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253901994">(Sep 18 2021 at 23:49)</a>:</h4>
<p>The problem is I keep making MWEs with simpler blocks and the error doesn't manifest.</p>



<a name="253902085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902085">(Sep 18 2021 at 23:51)</a>:</h4>
<p>Your block doesn't seem to reference any lemmas except whatever is in <code>integral_domain_simp</code>, so why not just have a big list of sorry lemmas and then your theorem statement? That will at least skip the top of the file</p>



<a name="253902150"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902150" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902150">(Sep 18 2021 at 23:52)</a>:</h4>
<p>You can also use <code>trace_state</code> to see how the evaluation is progressing btw. How deep is this recursion?</p>



<a name="253902158"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902158" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902158">(Sep 18 2021 at 23:52)</a>:</h4>
<p>Isn't it simpler to just use <code>iterate 3</code> or something?</p>



<a name="253902201"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902201" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902201">(Sep 18 2021 at 23:53)</a>:</h4>
<p>Let me try to answer all these questions:</p>



<a name="253902274"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902274" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902274">(Sep 18 2021 at 23:54)</a>:</h4>
<p>What I am trying to do is to prove that a collection of ~50 equations over an integral domain implies a goal equation.</p>



<a name="253902287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902287">(Sep 18 2021 at 23:55)</a>:</h4>
<p>how in the world did that happen</p>



<a name="253902314"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902314" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902314">(Sep 18 2021 at 23:55)</a>:</h4>
<p>This problem arises in the context of the proof of soundness of a cryptographic construction called a SNARK.</p>



<a name="253902357"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902357" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902357">(Sep 18 2021 at 23:56)</a>:</h4>
<p>ah, well that explains it</p>



<a name="253902391"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902391" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902391">(Sep 18 2021 at 23:56)</a>:</h4>
<p>I hope you have done everything possible to simplify the problem before the main proof</p>



<a name="253902404"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902404" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902404">(Sep 18 2021 at 23:57)</a>:</h4>
<p>for example, if two of the equations imply a third equation that is more useful</p>



<a name="253902435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902435" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902435">(Sep 18 2021 at 23:57)</a>:</h4>
<p>breaking big proofs into small pieces is good for a bunch of reasons</p>



<a name="253902444"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902444" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902444">(Sep 18 2021 at 23:57)</a>:</h4>
<p>Indeed, I have been working on this in parallel: I could try to look at the paper proof carefully and see if I could reduce the number of equations. Unfortunately, this doesn't bode well for being able to generalize to other constructions.</p>



<a name="253902493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902493" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902493">(Sep 18 2021 at 23:58)</a>:</h4>
<p>in what way do you want to generalize?</p>



<a name="253902509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902509">(Sep 18 2021 at 23:58)</a>:</h4>
<p>I want to generalize to other SNARK constructions, which have different sets of equations.</p>



<a name="253902535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902535">(Sep 18 2021 at 23:59)</a>:</h4>
<p>If I hard-code in "these 30 equations are not necessary" then I have to do that every time in the future.</p>



<a name="253902547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902547">(Sep 18 2021 at 23:59)</a>:</h4>
<p>I don't mean to reduce the number of equations, I mean to factor the 50 lemmas -&gt; 1 conclusion proof into a tree like 10 x (5 equations -&gt; 1 concl) -&gt; 2 equations -&gt; 1 concl</p>



<a name="253902648"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902648" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902648">(Sep 19 2021 at 00:00)</a>:</h4>
<p>It sounds like you want a general mechanism to prove theorems in this language</p>



<a name="253902672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902672">(Sep 19 2021 at 00:00)</a>:</h4>
<p>in which case you should write a custom tactic for it</p>



<a name="253902688"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902688" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902688">(Sep 19 2021 at 00:00)</a>:</h4>
<p>I considered this.</p>



<a name="253902704"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902704" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902704">(Sep 19 2021 at 00:01)</a>:</h4>
<p>The <code>nsatz</code> tactic from coq seems to do what I would want.</p>



<a name="253902775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902775">(Sep 19 2021 at 00:02)</a>:</h4>
<p>I expect writing a whole tactic from scratch to resolve these equations would be harder to do though.</p>



<a name="253902814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902814">(Sep 19 2021 at 00:03)</a>:</h4>
<p>I don't think you need to be so ambitious as that</p>



<a name="253902825"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902825" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902825">(Sep 19 2021 at 00:03)</a>:</h4>
<p>I mean a tactic to coordinate calls to <code>simp only</code> and <code>rw</code></p>



<a name="253902831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902831">(Sep 19 2021 at 00:03)</a>:</h4>
<p>i.e. what you are doing already</p>



<a name="253902884"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902884" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902884">(Sep 19 2021 at 00:04)</a>:</h4>
<p>you just handle the goal manipulation and control flow</p>



<a name="253902936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253902936" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253902936">(Sep 19 2021 at 00:05)</a>:</h4>
<p>I guess I don't understand how what you are suggesting is different from what I'm doing.</p>



<a name="253903051"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903051" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903051">(Sep 19 2021 at 00:07)</a>:</h4>
<p>You will have much better control over the equations and recursion ordering. It's hard to demonstrate because you still haven't shown a <a href="https://leanprover-community.github.io/mwe.html">#mwe</a></p>



<a name="253903126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903126">(Sep 19 2021 at 00:08)</a>:</h4>
<p>Ok, here's an mwe I'm working on where iterate and repeat behave differently</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">data.nat.basic</span>

<span class="kn">section</span> <span class="n">my_section</span>

<span class="kd">lemma</span> <span class="n">zero_eq_zero</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">↔</span> <span class="n">true</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">eq_self_iff_true</span><span class="o">],</span>
<span class="kd">end</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">e</span> <span class="n">f</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">∨</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">d</span> <span class="bp">*</span> <span class="n">e</span> <span class="bp">=</span> <span class="n">a</span><span class="o">)</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">d</span> <span class="bp">*</span> <span class="n">f</span> <span class="bp">*</span> <span class="n">e</span> <span class="bp">=</span> <span class="mi">0</span>
<span class="o">:=</span>
<span class="kd">begin</span>

  <span class="n">iterate</span> <span class="o">{</span>
    <span class="n">fail_if_success</span> <span class="o">{</span> <span class="n">done</span> <span class="o">},</span>
    <span class="n">try</span> <span class="o">{</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">mul_eq_zero</span><span class="o">,</span> <span class="n">zero_mul</span><span class="o">,</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">zero_eq_zero</span><span class="o">,</span> <span class="n">or_true</span><span class="o">,</span> <span class="n">true_or</span><span class="o">]</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
    <span class="n">try</span> <span class="o">{</span><span class="n">clear</span> <span class="n">found_zero</span><span class="o">},</span> <span class="c1">-- clear "found_zero" if present</span>
    <span class="n">done</span> <span class="bp">&lt;|&gt;</span> <span class="n">id</span> <span class="o">{</span><span class="n">cases</span> <span class="o">‹</span><span class="n">_</span> <span class="bp">∨</span> <span class="n">_</span><span class="o">›</span> <span class="k">with</span> <span class="n">found_zero</span> <span class="n">found_zero</span><span class="bp">;</span> <span class="n">rw</span> <span class="n">found_zero</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span> <span class="o">},</span>

<span class="kd">end</span>

<span class="kd">end</span> <span class="n">my_section</span>
</code></pre></div>



<a name="253903130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903130">(Sep 19 2021 at 00:08)</a>:</h4>
<p>But it sounds like you just haven't tried writing tactics before, it's not as hard as you think and they can be as simple or complicated as you like. You should watch Rob's metaprogramming tutorial</p>



<a name="253903155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903155" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903155">(Sep 19 2021 at 00:09)</a>:</h4>
<p>Note that <code>iterate</code> and <code>repeat</code> are different tactics that do different things, as I mentioned. So it's not that much of a surprise that they act differently</p>



<a name="253903225"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903225" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903225">(Sep 19 2021 at 00:10)</a>:</h4>
<p>the difference is basically <code>iterate {tac} = tac, iterate {tac}</code> while <code>repeat {tac} = tac; repeat {tac}</code></p>



<a name="253903289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903289" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903289">(Sep 19 2021 at 00:11)</a>:</h4>
<p>The <code>all_goals</code> behavior of <code>repeat</code> is important for this example. This works:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">begin</span>
  <span class="n">iterate</span> <span class="o">{</span>
    <span class="n">fail_if_success</span> <span class="o">{</span> <span class="n">done</span> <span class="o">},</span>
    <span class="n">all_goals</span> <span class="o">{</span>
      <span class="n">try</span> <span class="o">{</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">mul_eq_zero</span><span class="o">,</span> <span class="n">zero_mul</span><span class="o">,</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">zero_eq_zero</span><span class="o">,</span> <span class="n">or_true</span><span class="o">,</span> <span class="n">true_or</span><span class="o">]</span> <span class="n">at</span> <span class="bp">*</span><span class="o">},</span>
      <span class="n">try</span> <span class="o">{</span><span class="n">clear</span> <span class="n">found_zero</span><span class="o">},</span> <span class="c1">-- clear "found_zero" if present</span>
      <span class="n">done</span> <span class="bp">&lt;|&gt;</span> <span class="n">id</span> <span class="o">{</span><span class="n">cases</span> <span class="o">‹</span><span class="n">_</span> <span class="bp">∨</span> <span class="n">_</span><span class="o">›</span> <span class="k">with</span> <span class="n">found_zero</span> <span class="n">found_zero</span><span class="bp">;</span> <span class="n">rw</span> <span class="n">found_zero</span> <span class="n">at</span> <span class="bp">*</span><span class="o">}</span> <span class="o">}</span> <span class="o">},</span>
<span class="kd">end</span>
</code></pre></div>



<a name="253903343"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903343" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903343">(Sep 19 2021 at 00:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113489-new-members/topic/repeat/near/253903130">said</a>:</p>
<blockquote>
<p>But it sounds like you just haven't tried writing tactics before, it's not as hard as you think and they can be as simple or complicated as you like. You should watch Rob's metaprogramming tutorial</p>
</blockquote>
<p>I have watched it through twice. It seems like every time I encounter a pitfall, I have to watch it again.</p>



<a name="253903354"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903354" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903354">(Sep 19 2021 at 00:12)</a>:</h4>
<p>If you hit any issues when writing tactics feel free to ask here</p>



<a name="253903375"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903375" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903375">(Sep 19 2021 at 00:13)</a>:</h4>
<p>Most tactics prefer to be called on one goal, and <code>repeat</code> does that, but <code>iterate</code> just calls <code>tac</code> repeatedly and doesn't care if the first invocation produced many subgoals</p>



<a name="253903784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903784">(Sep 19 2021 at 00:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113489-new-members/topic/repeat/near/253903225">said</a>:</p>
<blockquote>
<p>the difference is basically <code>iterate {tac} = tac, iterate {tac}</code> while <code>repeat {tac} = tac; repeat {tac}</code></p>
</blockquote>
<p>I have never read any formal documentation for the difference between <code>,</code> and <code>;</code>. I honestly don't understand the difference between these definitions. Shouldn't they be the same?</p>



<a name="253903904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903904">(Sep 19 2021 at 00:23)</a>:</h4>
<p>It seems like both of those definitions are just "recursively apply tac on all subgoals, creating a branching tree of subgoals until you reach failure".</p>



<a name="253903910"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903910" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903910">(Sep 19 2021 at 00:23)</a>:</h4>
<p>That's what <code>;</code> does</p>



<a name="253903915"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903915" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903915">(Sep 19 2021 at 00:23)</a>:</h4>
<p><code>,</code> means do tac1, then do tac2</p>



<a name="253903971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253903971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253903971">(Sep 19 2021 at 00:24)</a>:</h4>
<p><code>tac1; tac2</code> means do tac1, then focus on each goal produced by tac1 and do tac2 in that state, then join all the goals that result</p>



<a name="253904107"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253904107" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253904107">(Sep 19 2021 at 00:27)</a>:</h4>
<p>Ok, I understand the difference between <code>,</code> and <code>;</code> I think. But that doesn't explain why iterate fails in a situation where repeat closes all goals.</p>



<a name="253904179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253904179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253904179">(Sep 19 2021 at 00:28)</a>:</h4>
<p>Here's my logic: If repeat closes all goals, then essentially what it did to solve those goals is just to apply <code>tac</code> over and over, to whatever goal was on top of the stack at the time. If that succeeds, shouldn't iterate do the same thing?</p>



<a name="253904697"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253904697" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253904697">(Sep 19 2021 at 00:38)</a>:</h4>
<p>I'm trying to get a better understanding by reading lean's definition of <code>iterate</code>. I reached this auxiliary function</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="sd">/--</span>
<span class="sd">`iterate_at_most' n t` repeats `t` `n` times or until `t` fails.</span>
<span class="sd">-/</span>
<span class="kd">meta</span> <span class="kd">def</span> <span class="n">iterate_at_most'</span> <span class="o">:</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="bp">→</span> <span class="n">tactic</span> <span class="n">unit</span>
<span class="bp">|</span> <span class="mi">0</span>        <span class="n">t</span> <span class="o">:=</span> <span class="n">skip</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="o">)</span> <span class="n">t</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="o">(</span><span class="n">some</span> <span class="n">_</span><span class="o">)</span> <span class="bp">←</span> <span class="n">try_core</span> <span class="n">t</span> <span class="bp">|</span> <span class="n">skip</span><span class="o">,</span>
  <span class="n">iterate_at_most'</span> <span class="n">n</span> <span class="n">t</span>
</code></pre></div>
<p>What does the <code>|</code> between <code>try_core t</code> and <code>skip</code> do? This is one of those things that might have been covered in Rob Lewis course, but I can't remember all the details.</p>



<a name="253904789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253904789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253904789">(Sep 19 2021 at 00:40)</a>:</h4>
<p>If the pattern doesn't match, it will run the thing on the other side of the <code>|</code> and skip the rest of the block</p>



<a name="253904810"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253904810" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253904810">(Sep 19 2021 at 00:41)</a>:</h4>
<p>so here that means that if <code>try_core t</code> returns <code>none</code> (i.e. <code>t</code> fails) then the tactic terminates with success</p>



<a name="253904881"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253904881" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253904881">(Sep 19 2021 at 00:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="282271">Bolton Bailey</span> <a href="#narrow/stream/113489-new-members/topic/repeat/near/253904179">said</a>:</p>
<blockquote>
<p>Here's my logic: If repeat closes all goals, then essentially what it did to solve those goals is just to apply <code>tac</code> over and over, to whatever goal was on top of the stack at the time. If that succeeds, shouldn't iterate do the same thing?</p>
</blockquote>
<p>Tactics are called on the entire tactic state, which includes the full list of goals, not just the one on top</p>



<a name="253904893"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253904893" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253904893">(Sep 19 2021 at 00:42)</a>:</h4>
<p>Most tactics by convention only modify the top goal and leave the others alone, but not all</p>



<a name="253904903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253904903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253904903">(Sep 19 2021 at 00:43)</a>:</h4>
<p>in particular, <code>done</code> acts differently if there are "side goals" after the main goal</p>



<a name="253904916"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253904916" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253904916">(Sep 19 2021 at 00:43)</a>:</h4>
<p>because if the main goal is done then <code>done</code> will still fail because the side goals aren't</p>



<a name="253905003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905003" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905003">(Sep 19 2021 at 00:45)</a>:</h4>
<p>Ok, so then does a goal disappear when it is finished?</p>



<a name="253905065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905065" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905065">(Sep 19 2021 at 00:46)</a>:</h4>
<p>If I have two goals in my state that can both by finished by tac, and I call <code>tac, tac</code>, does that finish all goals?</p>



<a name="253905187"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905187" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905187">(Sep 19 2021 at 00:49)</a>:</h4>
<p>Ok, I finally see why my mwe fails with iterate: the <code>try {simp only [mul_eq_zero, zero_mul, mul_zero, zero_eq_zero, or_true, true_or] at *}, </code> closes a goal, and then <code>done &lt;|&gt; id {cases ‹_ ∨ _› with found_zero found_zero; rw found_zero at *}, },</code> is applied <strong>to a different goal</strong></p>



<a name="253905193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905193" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905193">(Sep 19 2021 at 00:49)</a>:</h4>
<p>This is what was confusing.</p>



<a name="253905266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905266">(Sep 19 2021 at 00:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="282271">Bolton Bailey</span> <a href="#narrow/stream/113489-new-members/topic/repeat/near/253905065">said</a>:</p>
<blockquote>
<p>If I have two goals in my state that can both by finished by tac, and I call <code>tac, tac</code>, does that finish all goals?</p>
</blockquote>
<p>Yes, assuming <code>tac</code> only acts on the first goal</p>



<a name="253905356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905356">(Sep 19 2021 at 00:52)</a>:</h4>
<p>Is there a way to say "apply this list of tactics as if the top goal was the only goal in the environment"</p>



<a name="253905384"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905384" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905384">(Sep 19 2021 at 00:53)</a>:</h4>
<p>I thought this was accomplished with <code>{ ... }</code> or <code>id { ... }</code>, but neither of those make the iterate mwe succeed.</p>



<a name="253905429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905429">(Sep 19 2021 at 00:54)</a>:</h4>
<p>here's a tactic that I think represents the control flow you are going for:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">open</span> <span class="n">tactic</span>
<span class="kd">meta</span> <span class="kd">def</span> <span class="n">mysatz</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">mul_eq_zero</span><span class="o">,</span> <span class="n">zero_mul</span><span class="o">,</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">zero_eq_zero</span><span class="o">,</span> <span class="n">or_true</span><span class="o">,</span> <span class="n">true_or</span><span class="o">]</span>
    <span class="n">at</span> <span class="bp">*</span> <span class="o">{</span><span class="n">fail_if_unchanged</span> <span class="o">:=</span> <span class="n">ff</span><span class="o">}],</span>
  <span class="n">_</span><span class="o">::</span><span class="n">_</span> <span class="bp">←</span> <span class="n">get_goals</span> <span class="bp">|</span> <span class="n">skip</span><span class="o">,</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">cases</span> <span class="o">‹</span><span class="n">_</span> <span class="bp">∨</span> <span class="n">_</span><span class="o">›</span> <span class="k">with</span> <span class="n">found_zero</span> <span class="n">found_zero</span><span class="o">]</span><span class="bp">;</span> <span class="o">(</span><span class="k">do</span>
    <span class="bp">`</span><span class="o">[</span><span class="n">rw</span> <span class="n">found_zero</span> <span class="n">at</span> <span class="bp">*;</span> <span class="n">clear</span> <span class="n">found_zero</span><span class="o">],</span>
    <span class="n">mysatz</span><span class="o">)</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">e</span> <span class="n">f</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">∨</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">d</span> <span class="bp">*</span> <span class="n">e</span> <span class="bp">=</span> <span class="n">a</span><span class="o">)</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">d</span> <span class="bp">*</span> <span class="n">f</span> <span class="bp">*</span> <span class="n">e</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">mysatz</span>
</code></pre></div>



<a name="253905525"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905525" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905525">(Sep 19 2021 at 00:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="282271">Bolton Bailey</span> <a href="#narrow/stream/113489-new-members/topic/repeat/near/253905356">said</a>:</p>
<blockquote>
<p>Is there a way to say "apply this list of tactics as if the top goal was the only goal in the environment"</p>
</blockquote>
<p><code>focus { tac }</code></p>



<a name="253905545"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905545" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905545">(Sep 19 2021 at 00:57)</a>:</h4>
<p>Yep, that works.</p>



<a name="253905625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905625" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905625">(Sep 19 2021 at 00:58)</a>:</h4>
<p>Ok, in the code you just posted, there are at least 3 things I am unfamiliar with.</p>



<a name="253905642"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905642" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905642">(Sep 19 2021 at 00:58)</a>:</h4>
<p>I guess "fail_if_unchaged" is pretty self-explanatory.</p>



<a name="253905659"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905659" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905659">(Sep 19 2021 at 00:59)</a>:</h4>
<p>It's basically equivalent to the <code>try { simp only ... }</code> you wrote, but this gives better errors</p>



<a name="253905671"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905671" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905671">(Sep 19 2021 at 00:59)</a>:</h4>
<p>What is <code>_::_ &lt;- get_goals | skip</code>?</p>



<a name="253905679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905679" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905679">(Sep 19 2021 at 00:59)</a>:</h4>
<p>same thing as the <code>|</code> from before</p>



<a name="253905732"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905732" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905732">(Sep 19 2021 at 01:00)</a>:</h4>
<p>it's <code>fail_if_success done</code></p>



<a name="253905765"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905765" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905765">(Sep 19 2021 at 01:00)</a>:</h4>
<p>actually scratch that</p>



<a name="253905789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905789">(Sep 19 2021 at 01:00)</a>:</h4>
<p>if there are no goals, then it succeeds <em>and terminates <code>mysatz</code></em></p>



<a name="253905796"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905796" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905796">(Sep 19 2021 at 01:01)</a>:</h4>
<p>If we let the <code>cases</code> run, then it would cause our tactic to fail</p>



<a name="253905831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905831">(Sep 19 2021 at 01:01)</a>:</h4>
<p>in other words, this covers the case where the <code>simp</code> closes the goal</p>



<a name="253905875"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905875" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905875">(Sep 19 2021 at 01:02)</a>:</h4>
<p>Right, ok</p>



<a name="253905892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905892" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905892">(Sep 19 2021 at 01:02)</a>:</h4>
<p>Regarding goal handling, this is a "regular" tactic, it assumes there is one goal to start and closes the goal or fails</p>



<a name="253905912"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905912" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905912">(Sep 19 2021 at 01:03)</a>:</h4>
<p>we can assume the <code>simp only</code> doesn't create goals so there is only one goal at the <code>cases</code></p>



<a name="253905982"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253905982" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253905982">(Sep 19 2021 at 01:04)</a>:</h4>
<p>and we use <code>;</code> after <code>cases</code> to run the succeeding block twice, on the two subgoals, and ensure we have only one goal</p>



<a name="253906008"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253906008" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253906008">(Sep 19 2021 at 01:05)</a>:</h4>
<p>crucially, after the <code>rw, clear</code> we call <code>mysatz</code> recursively</p>



<a name="253906015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253906015" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253906015">(Sep 19 2021 at 01:05)</a>:</h4>
<p>this causes a branching tree of invocations, like what <code>repeat</code> gives you</p>



<a name="253906103"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253906103" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253906103">(Sep 19 2021 at 01:07)</a>:</h4>
<p>actually, we should probably use <code>;</code> instead of <code>,</code> before the recursive call, because the <code>rw</code> might also close the goal</p>



<a name="253906269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253906269" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253906269">(Sep 19 2021 at 01:10)</a>:</h4>
<p>Ok, I understand. One more question, for my own edification. In my version of <code>mysatz</code> (creatively named <code>integral_domain_tactic</code>, and which was bugges for other reasons), instead of using the first <code>;</code> I was doing</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">...</span>
<span class="k">do</span> <span class="bp">`</span><span class="o">[</span><span class="n">cases_type</span> <span class="n">or</span><span class="o">],</span>
        <span class="n">trace</span> <span class="s2">"cases_type or succeeds"</span>
       <span class="c1">-- If cases_type or succeeds, call tactic recursively</span>
        <span class="bp">`</span><span class="o">[</span><span class="n">integral_domain_tactic</span><span class="o">],</span>
        <span class="bp">`</span><span class="o">[</span><span class="n">integral_domain_tactic</span><span class="o">])</span>
        <span class="c1">-- If cases_type or fails, rewrite using more powerful simp</span>
</code></pre></div>
<p>Does this also work in principle, because <code>cases_type or</code> always returns two subgoals, or is it flawed somehow?</p>



<a name="253906357"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253906357" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253906357">(Sep 19 2021 at 01:12)</a>:</h4>
<p>I expect the answer is "it would probably work, but <code>;</code> to do recursive subcalls is more elegant".</p>



<a name="253906373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253906373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253906373">(Sep 19 2021 at 01:12)</a>:</h4>
<p>It's a little riskier, because if the first <code>integral_domain_tactic</code> doesn't close the goal because of bugs or otherwise, then the second <code>integral_domain_tactic</code> will get a weird state</p>



<a name="253906411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/253906411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#253906411">(Sep 19 2021 at 01:13)</a>:</h4>
<p>Right, I see. <br>
I'm taking a break, thanks so much for all your help!</p>



<a name="254142519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/254142519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#254142519">(Sep 21 2021 at 01:18)</a>:</h4>
<p>Unfortunately, I'm realizing the <code>mysatz</code> tactic above is not doing quite what I want it to. After the <code>_::_ ← get_goals | skip,</code> line, it might be the case that there are no <code>∨</code> present in the hypotheses. In this case, I would like the tactic to gracefully just return the state at that point as a goal, rather than fail. I'm looking at the <code>try_core</code>and <code>match</code> syntax to try to resolve this, but I'm not having much luck. Anyone able to help? This is what I have</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">integral_domain_tactic</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[]</span> <span class="k">with</span> <span class="n">integral_domain_simp</span>
    <span class="n">at</span> <span class="bp">*</span> <span class="o">{</span><span class="n">fail_if_unchanged</span> <span class="o">:=</span> <span class="n">ff</span><span class="o">}],</span>
  <span class="n">try</span> <span class="bp">`</span><span class="o">[</span><span class="n">cases_type</span><span class="bp">*</span> <span class="n">true</span> <span class="n">false</span><span class="o">],</span>
  <span class="n">_</span><span class="o">::</span><span class="n">_</span> <span class="bp">←</span> <span class="n">get_goals</span> <span class="bp">|</span> <span class="n">skip</span><span class="o">,</span> <span class="c1">-- If no goals left (get goals is an empty list) then skip</span>
  <span class="c1">-- Otherwise try to recurse on an ∨.</span>
  <span class="c1">-- I still think this may be wrong. If there is no or, we ought to stop at this point</span>
  <span class="n">cases_success</span> <span class="bp">&lt;-</span> <span class="n">try_core</span> <span class="bp">`</span><span class="o">[</span><span class="n">cases</span> <span class="o">‹</span><span class="n">_</span> <span class="bp">∨</span> <span class="n">_</span><span class="o">›</span> <span class="k">with</span> <span class="n">found_zero</span> <span class="n">found_zero</span><span class="o">],</span>
  <span class="k">match</span> <span class="n">cases_success</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">some</span> <span class="n">_</span> <span class="o">:=</span> <span class="k">do</span> <span class="n">all_goals</span> <span class="o">{</span> <span class="bp">`</span><span class="o">[</span><span class="n">rw</span> <span class="n">found_zero</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="n">clear</span> <span class="n">found_zero</span><span class="o">],</span> <span class="n">integral_domain_tactic</span> <span class="o">}</span>
  <span class="bp">|</span> <span class="n">none</span> <span class="o">:=</span> <span class="n">skip</span>
</code></pre></div>



<a name="254142685"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/254142685" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#254142685">(Sep 21 2021 at 01:21)</a>:</h4>
<p>It doesn't work to put <code>;</code> after the try core either. Lean complains that it doesn't know the identifier <code>cases_success</code></p>



<a name="254143197"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/repeat/near/254143197" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bolton Bailey <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/repeat.html#254143197">(Sep 21 2021 at 01:29)</a>:</h4>
<p>Actually nevermind, after playing with it a few more minutes, I found</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">integral_domain_tactic</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="bp">`</span><span class="o">[</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[]</span> <span class="k">with</span> <span class="n">integral_domain_simp</span>
    <span class="n">at</span> <span class="bp">*</span> <span class="o">{</span><span class="n">fail_if_unchanged</span> <span class="o">:=</span> <span class="n">ff</span><span class="o">}],</span>
  <span class="n">try</span> <span class="bp">`</span><span class="o">[</span><span class="n">cases_type</span><span class="bp">*</span> <span class="n">true</span> <span class="n">false</span><span class="o">],</span>
  <span class="n">_</span><span class="o">::</span><span class="n">_</span> <span class="bp">←</span> <span class="n">get_goals</span> <span class="bp">|</span> <span class="n">skip</span><span class="o">,</span> <span class="c1">-- If no goals left (get goals is an empty list) then skip</span>
  <span class="c1">-- Otherwise try to recurse on an ∨.</span>
  <span class="c1">-- I still think this may be wrong. If there is no or, we ought to stop at this point</span>
  <span class="n">cases_success</span> <span class="bp">&lt;-</span> <span class="n">try_core</span> <span class="bp">`</span><span class="o">[</span><span class="n">cases</span> <span class="o">‹</span><span class="n">_</span> <span class="bp">∨</span> <span class="n">_</span><span class="o">›</span> <span class="k">with</span> <span class="n">found_zero</span> <span class="n">found_zero</span><span class="o">],</span>
  <span class="k">match</span> <span class="n">cases_success</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">some</span> <span class="n">_</span> <span class="o">:=</span> <span class="k">do</span> <span class="n">all_goals'</span> <span class="bp">`</span><span class="o">[</span><span class="n">rw</span> <span class="n">found_zero</span> <span class="n">at</span> <span class="bp">*</span><span class="o">,</span> <span class="n">clear</span> <span class="n">found_zero</span><span class="o">,</span> <span class="n">integral_domain_tactic</span><span class="o">]</span>
  <span class="bp">|</span> <span class="n">none</span> <span class="o">:=</span> <span class="n">skip</span>
  <span class="kd">end</span>
</code></pre></div>
<p>Seems to work. I'll let you all know if anything else comes up.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>