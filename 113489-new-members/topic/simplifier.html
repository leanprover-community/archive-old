---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/simplifier.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html">simplifier</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="233373413"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233373413" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Greg Price <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233373413">(Apr 06 2021 at 19:17)</a>:</h4>
<p>Is there a paper that describes the simplifier?</p>
<p>I recently read the ICFP paper <a href="https://leanprover.github.io/papers/tactic.pdf">https://leanprover.github.io/papers/tactic.pdf</a> on the metaprogramming/tactic framework, and it was very informative. I'd love to read something similar about the simplifier.</p>



<a name="233376348"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233376348" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Avigad <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233376348">(Apr 06 2021 at 19:38)</a>:</h4>
<p>Lean's simplifier is modeled after Isabelle's. You can read about Isabelle's simplifier here:<br>
<a href="https://isabelle.in.tum.de/dist/Isabelle2021/doc/prog-prove.pdf">https://isabelle.in.tum.de/dist/Isabelle2021/doc/prog-prove.pdf</a> (page 20)<br>
There is more information here:<br>
<a href="https://isabelle.in.tum.de/dist/Isabelle2021/doc/tutorial.pdf">https://isabelle.in.tum.de/dist/Isabelle2021/doc/tutorial.pdf</a> (page 27, page 175)<br>
Some of the issues that are specific to dependent type theory are described here:<br>
<a href="https://leanprover.github.io/papers/congr.pdf">https://leanprover.github.io/papers/congr.pdf</a><br>
I hope that helps. (This is where my knowledge trails off.)</p>



<a name="233378488"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233378488" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Greg Price <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233378488">(Apr 06 2021 at 19:53)</a>:</h4>
<p>Very informative, thanks!</p>



<a name="233380167"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233380167" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233380167">(Apr 06 2021 at 20:05)</a>:</h4>
<p>The discussion about <code>safe_log</code> in the <code>congr</code> paper is interesting. Do you know if there's anything else to read on the "e-matcher", or any lean examples demonstrating it?</p>



<a name="233606429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233606429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Greg Price <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233606429">(Apr 08 2021 at 06:11)</a>:</h4>
<p>An area I'd especially like to read more about is how the simplifier determines which simp lemmas have a LHS that matches the current expression.</p>
<p>IIUC that's where "e-matching" comes in. But I'm still working out what that means.</p>
<p>Are there papers people can recommend on e-matching as it's thought of in Lean?</p>



<a name="233606529"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233606529" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Greg Price <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233606529">(Apr 08 2021 at 06:13)</a>:</h4>
<p>One result I find from Google is a paper with Leo as an author, but that doesn't mention Lean:<br>
<a href="http://leodemoura.github.io/files/ematching.pdf">http://leodemoura.github.io/files/ematching.pdf</a><br>
because it's from 2007.</p>
<p>I'll certainly take a look at that but would be grateful if anyone knows of another helpful reference.</p>



<a name="233607115"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233607115" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233607115">(Apr 08 2021 at 06:22)</a>:</h4>
<p>The simplifier doesn't use e-matching</p>



<a name="233607129"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233607129" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233607129">(Apr 08 2021 at 06:22)</a>:</h4>
<p>The way the simplifier matches terms is just plain unification (modulo reducible definitions)</p>



<a name="233608550"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233608550" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Greg Price <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233608550">(Apr 08 2021 at 06:43)</a>:</h4>
<p>Ah OK, thanks!</p>
<p>Can you explain what "modulo reducible definitions" means? I've seen <code>@[reducible]</code> on definitions, but haven't quite put together what it means.</p>



<a name="233610207"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233610207" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233610207">(Apr 08 2021 at 07:01)</a>:</h4>
<p>It means that <code>simp</code> will unfold reducible definitions when they appear in the term to match, rather than attempting to find lemmas containing the reducible definition. (I think it does this with the simp lemmas themselves, so there won't be a mismatch even if both the goal and the lemma use the reducible definition.)</p>



<a name="233610820"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233610820" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Horatiu Cheval <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233610820">(Apr 08 2021 at 07:07)</a>:</h4>
<p>Does this mean that adding both <code>@[reducible, simp]</code> attributes to a definition is superfluous?</p>



<a name="233611157"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233611157" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233611157">(Apr 08 2021 at 07:10)</a>:</h4>
<p>No, you might still want to simp the definition away rather than just matching other lemmas modulo the definition</p>



<a name="233611209"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233611209" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233611209">(Apr 08 2021 at 07:11)</a>:</h4>
<p>(also I just tested it and I can't seem to get the matching modulo reducibles to work either)</p>



<a name="233611440"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233611440" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233611440">(Apr 08 2021 at 07:13)</a>:</h4>
<p>Since <code>simp</code> uses keyed matching, it will fail if the reducible definition is the head of the term to be matched:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c1">-- abbreviation F (a b : ℕ) := a + b</span>
<span class="kd">@[reducible]</span> <span class="kd">def</span> <span class="n">F</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:=</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span>
<span class="kd">theorem</span> <span class="n">foo</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="gr">sorry</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">F</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="o">[</span><span class="n">foo</span><span class="o">]</span> <span class="c1">-- fails</span>
<span class="kd">theorem</span> <span class="n">bar</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">id</span> <span class="o">(</span><span class="n">a</span> <span class="bp">+</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="gr">sorry</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">id</span> <span class="o">(</span><span class="n">F</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="o">[</span><span class="n">bar</span><span class="o">]</span> <span class="c1">-- ok</span>
</code></pre></div>



<a name="233611804"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233611804" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233611804">(Apr 08 2021 at 07:18)</a>:</h4>
<p>Here's a demonstration of the difference between <code>@[reducible]</code> and <code>@[reducible, simp]</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">f</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">id</span>
<span class="kd">@[reducible]</span> <span class="kd">def</span> <span class="n">F</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:=</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span>
<span class="kd">@[simp]</span> <span class="kd">theorem</span> <span class="n">bar</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="gr">sorry</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">F</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="c1">-- f (F a b) = 1</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">F</span> <span class="n">a</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="c1">-- 0 = 1</span>
<span class="kn">attribute</span> <span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="n">F</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">F</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="c1">-- f (a + b) = 1</span>
</code></pre></div>



<a name="233612041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233612041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233612041">(Apr 08 2021 at 07:20)</a>:</h4>
<p>Notice that in the first one, <code>F</code> was not unfolded, but in the second one it nevertheless was not an obstacle to matching the <code>f (a + a)</code> term against <code>f (F a a)</code>. In the third one, since <code>F</code> is now <code>@[simp]</code>, it is unfolded away in the goal</p>



<a name="233620288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233620288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Horatiu Cheval <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233620288">(Apr 08 2021 at 08:43)</a>:</h4>
<p>Ok, I get it, thank you for laying out all the different situations</p>



<a name="233769647"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233769647" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Greg Price <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233769647">(Apr 09 2021 at 05:16)</a>:</h4>
<p>That's very helpful, thanks!</p>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113489-new-members/topic/simplifier/near/233612041">said</a>:</p>
<blockquote>
<p>Notice that in the first one, <code>F</code> was not unfolded, but in the second one it nevertheless was not an obstacle to matching the <code>f (a + a)</code> term against <code>f (F a a)</code>.</p>
</blockquote>
<p>Do I understand right that this is a demo of getting the matching modulo reducibles to work? Or did you have something else in mind for what that meant?</p>



<a name="233769743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/233769743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#233769743">(Apr 09 2021 at 05:18)</a>:</h4>
<p>yes, this is showing how matching modulo reducibles works</p>



<a name="251388166"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/simplifier/near/251388166" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> AnduinHS <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/simplifier.html#251388166">(Aug 31 2021 at 13:52)</a>:</h4>
<p>(deleted)</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>