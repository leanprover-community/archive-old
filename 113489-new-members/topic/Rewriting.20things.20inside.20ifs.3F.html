---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html">Rewriting things inside ifs?</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="230744977"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230744977" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Guilherme Espada <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230744977">(Mar 17 2021 at 18:40)</a>:</h4>
<p>In this example:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="o">(</span><span class="k">if</span> <span class="o">(</span><span class="mi">0</span><span class="bp">&lt;</span><span class="mi">1</span><span class="o">)</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="kd">begin</span>
  <span class="k">have</span> <span class="n">proof</span><span class="o">:</span> <span class="o">((</span><span class="mi">0</span><span class="o">:</span><span class="n">int</span><span class="o">)</span><span class="bp">&lt;</span><span class="o">(</span><span class="mi">1</span><span class="o">:</span><span class="n">int</span><span class="o">))</span><span class="bp">=</span><span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="gr">sorry</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">proof</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>I don't see why the rewrite shouldn't work. What am I missing? What is a good way to handle ifs (both in the conclusion and in the premises)?</p>
<p>Thanks</p>



<a name="230745152"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230745152" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230745152">(Mar 17 2021 at 18:41)</a>:</h4>
<p>Well for one, your theorem statement is about <code>nat</code>, but <code>proof</code> is about <code>int</code></p>



<a name="230745214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230745214" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230745214">(Mar 17 2021 at 18:41)</a>:</h4>
<p><code>simp_rw proof</code> works after you fix that</p>



<a name="230745669"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230745669" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Guilherme Espada <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230745669">(Mar 17 2021 at 18:44)</a>:</h4>
<p>Oh, simp_rw seems exactly what I was looking for. Another tool for my toolbelt.</p>
<p>Why doesn't rw behave like simp_rw?</p>



<a name="230745911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230745911" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230745911">(Mar 17 2021 at 18:46)</a>:</h4>
<p>Because the condition of an <code>if</code> statement has a dependent argument, the proof that this condition is decidable, that needs to be rewritten as well</p>



<a name="230745970"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230745970" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230745970">(Mar 17 2021 at 18:46)</a>:</h4>
<p><code>rw</code> doesn't handle this very well, it gives a <code>motive is not type correct</code> error in these cases</p>



<a name="230746157"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230746157" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Guilherme Espada <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230746157">(Mar 17 2021 at 18:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F/near/230745970">said</a>:</p>
<blockquote>
<p><code>rw</code> doesn't handle this very well, it gives a <code>motive is not type correct</code> error in these cases</p>
</blockquote>
<p>That's exactly the error I was seeing when experimenting. Couldn't really understand it unfortunately</p>



<a name="230746195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230746195" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Guilherme Espada <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230746195">(Mar 17 2021 at 18:47)</a>:</h4>
<p>Thank you both for your answers <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="230746200"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230746200" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230746200">(Mar 17 2021 at 18:47)</a>:</h4>
<p><code>simp_rw</code> has the same interface as <code>rw</code> but uses the proof strategy of <code>simp</code>, which is able to handle dependencies in some places (but may sometimes fail to rewrite where <code>rw</code> will work)</p>



<a name="230832960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230832960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Guilherme Espada <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230832960">(Mar 18 2021 at 09:18)</a>:</h4>
<p>Something weird is happening: <code>simp_rw</code> works correctly in the example posted above, and in another minimized example which I extracted with <code>extract_goal</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.suggest</span>
<span class="kn">import</span> <span class="n">data.finset</span>
<span class="kn">import</span> <span class="n">data.finmap</span>
<span class="kn">import</span> <span class="n">data.list</span>
<span class="kn">import</span> <span class="n">data.finmap</span>

<span class="kd">@[derive decidable_eq]</span>
<span class="kd">inductive</span> <span class="n">ttype</span>
<span class="bp">|</span> <span class="n">ty_func</span> <span class="o">(</span><span class="n">l</span> <span class="n">r</span><span class="o">:</span><span class="n">ttype</span><span class="o">):</span> <span class="n">ttype</span>
<span class="bp">|</span> <span class="n">ty_bool</span> <span class="o">:</span> <span class="n">ttype</span>

<span class="kn">open</span> <span class="n">ttype</span>


<span class="kd">instance</span> <span class="o">:</span> <span class="n">inhabited</span> <span class="n">ttype</span> <span class="o">:=</span> <span class="n">inhabited.mk</span> <span class="n">ty_bool</span>

<span class="kd">@[derive decidable_eq]</span>
<span class="kd">inductive</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_var</span> <span class="o">(</span><span class="n">idx</span><span class="o">:</span><span class="n">int</span><span class="o">)</span> <span class="o">:</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_abs</span> <span class="o">(</span><span class="n">T</span><span class="o">:</span><span class="n">ttype</span><span class="o">)</span> <span class="o">(</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">)</span> <span class="o">:</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_app</span> <span class="o">(</span><span class="n">t1</span> <span class="n">t2</span><span class="o">:</span> <span class="n">term</span><span class="o">)</span> <span class="o">:</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_true</span> <span class="o">:</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_false</span> <span class="o">:</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_if</span> <span class="o">(</span><span class="n">cond</span> <span class="n">l</span> <span class="n">r</span><span class="o">:</span> <span class="n">term</span><span class="o">):</span> <span class="n">term</span>

<span class="kn">open</span> <span class="n">term</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">inhabited</span> <span class="n">term</span> <span class="o">:=</span> <span class="n">inhabited.mk</span> <span class="n">t_true</span>

<span class="kd">def</span> <span class="n">upshift_cutoff</span> <span class="o">:</span> <span class="n">int</span> <span class="bp">→</span> <span class="n">int</span> <span class="bp">→</span> <span class="n">term</span> <span class="bp">→</span> <span class="n">term</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="o">(</span><span class="n">t_var</span> <span class="n">k</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_var</span> <span class="o">(</span><span class="k">if</span> <span class="o">(</span><span class="n">k</span><span class="bp">&lt;</span><span class="n">c</span><span class="o">)</span> <span class="k">then</span> <span class="n">k</span> <span class="k">else</span> <span class="o">(</span><span class="n">k</span> <span class="bp">+</span> <span class="n">d</span><span class="o">))</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">T</span> <span class="n">t</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_abs</span> <span class="n">T</span> <span class="bp">$</span> <span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="o">(</span><span class="n">c</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="n">t</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_app</span> <span class="o">(</span><span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="n">c</span> <span class="n">t1</span><span class="o">)</span> <span class="o">(</span><span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="n">c</span> <span class="n">t2</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="n">t_true</span> <span class="o">:=</span> <span class="n">t_true</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="n">t_false</span> <span class="o">:=</span> <span class="n">t_false</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">cond</span> <span class="n">l</span> <span class="n">r</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_if</span> <span class="o">(</span><span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="n">c</span> <span class="n">cond</span><span class="o">)</span> <span class="o">(</span><span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="n">c</span> <span class="n">l</span><span class="o">)</span> <span class="o">(</span><span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="n">c</span> <span class="n">r</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">upshift</span> <span class="o">(</span><span class="n">amt</span><span class="o">:</span><span class="n">int</span><span class="o">)</span> <span class="o">(</span><span class="n">t1</span><span class="o">:</span><span class="n">term</span><span class="o">):</span> <span class="n">term</span> <span class="o">:=</span> <span class="n">upshift_cutoff</span> <span class="n">amt</span> <span class="mi">0</span> <span class="n">t1</span>

<span class="kd">def</span> <span class="n">subst</span>  <span class="o">:</span> <span class="n">int</span> <span class="bp">→</span> <span class="n">term</span> <span class="bp">→</span> <span class="n">term</span> <span class="bp">→</span> <span class="n">term</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="o">(</span><span class="n">t_var</span> <span class="n">n</span><span class="o">)</span> <span class="o">:=</span> <span class="k">if</span> <span class="n">n</span> <span class="bp">=</span> <span class="n">idx</span> <span class="k">then</span> <span class="n">s</span> <span class="k">else</span> <span class="n">t_var</span> <span class="n">n</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">T</span> <span class="n">t</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_abs</span> <span class="n">T</span> <span class="bp">$</span> <span class="o">(</span><span class="n">subst</span> <span class="o">(</span><span class="n">idx</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">upshift</span> <span class="mi">1</span> <span class="n">s</span><span class="o">)</span> <span class="n">t</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_app</span> <span class="o">(</span><span class="n">subst</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">t1</span><span class="o">)</span> <span class="o">(</span><span class="n">subst</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">t2</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">t_true</span> <span class="o">:=</span> <span class="n">t_true</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">t_false</span> <span class="o">:=</span> <span class="n">t_false</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">cond</span> <span class="n">l</span> <span class="n">r</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_if</span> <span class="o">(</span><span class="n">subst</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">cond</span><span class="o">)</span> <span class="o">(</span><span class="n">subst</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">l</span><span class="o">)</span> <span class="o">(</span><span class="n">subst</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">r</span><span class="o">)</span>

<span class="kd">inductive</span> <span class="n">eval</span> <span class="o">:</span> <span class="n">term</span> <span class="bp">→</span> <span class="n">term</span> <span class="bp">→</span> <span class="kt">Prop</span>
<span class="bp">|</span> <span class="n">e_app1</span> <span class="o">{</span><span class="n">t1</span> <span class="n">t1'</span> <span class="n">t2</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="n">t1</span> <span class="n">t1'</span> <span class="bp">→</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2</span><span class="o">)</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1'</span> <span class="n">t2</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">e_app2</span> <span class="o">{</span><span class="n">t1</span> <span class="n">t2</span> <span class="n">t2'</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="n">t2</span> <span class="n">t2'</span> <span class="bp">→</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2</span><span class="o">)</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2'</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">e_appabs</span> <span class="o">{</span><span class="n">T11</span> <span class="n">t12</span> <span class="n">v2</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_app</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">T11</span> <span class="n">t12</span><span class="o">)</span> <span class="n">v2</span><span class="o">)</span> <span class="o">(</span><span class="n">upshift</span> <span class="o">(</span><span class="bp">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">subst</span> <span class="mi">0</span> <span class="o">(</span><span class="n">upshift</span> <span class="mi">1</span> <span class="n">v2</span><span class="o">)</span> <span class="n">t12</span><span class="o">))</span>
<span class="bp">|</span> <span class="n">e_if_true</span> <span class="o">{</span><span class="n">t2</span> <span class="n">t3</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">t_true</span> <span class="n">t2</span> <span class="n">t3</span><span class="o">)</span> <span class="o">(</span><span class="n">t2</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">e_if_false</span> <span class="o">{</span><span class="n">t2</span> <span class="n">t3</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">t_false</span> <span class="n">t2</span> <span class="n">t3</span><span class="o">)</span> <span class="o">(</span><span class="n">t3</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">e_if</span> <span class="o">{</span><span class="n">t1</span> <span class="n">t1'</span> <span class="n">t2</span> <span class="n">t3</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="n">t1</span> <span class="n">t1'</span> <span class="bp">→</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">t1</span> <span class="n">t2</span> <span class="n">t3</span><span class="o">)</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">t1'</span> <span class="n">t2</span> <span class="n">t3</span><span class="o">)</span>

<span class="kd">example</span>
  <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">eval</span>
         <span class="o">((</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_var</span> <span class="mi">0</span><span class="o">)))</span><span class="bp">.</span><span class="n">t_app</span> <span class="o">(</span><span class="n">t_true.t_app</span> <span class="n">t_true</span><span class="o">))</span>
         <span class="o">(</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_var</span> <span class="o">(</span><span class="n">ite</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="mi">0</span> <span class="o">(</span><span class="bp">-</span><span class="mi">1</span><span class="o">)))))</span> <span class="o">(</span><span class="n">kk</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="mi">1</span> <span class="bp">=</span> <span class="n">true</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">eval</span> <span class="o">((</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_var</span> <span class="mi">0</span><span class="o">)))</span><span class="bp">.</span><span class="n">t_app</span> <span class="o">(</span><span class="n">t_true.t_app</span> <span class="n">t_true</span><span class="o">))</span>
    <span class="o">(</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_var</span> <span class="mi">0</span><span class="o">))</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">simp_rw</span> <span class="n">kk</span> <span class="n">at</span> <span class="n">b</span><span class="o">,</span> <span class="c1">--works as expected</span>
  <span class="n">simp</span> <span class="n">at</span> <span class="n">b</span><span class="o">,</span>
  <span class="n">assumption</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>However, in the more complex example I'm actually trying to prove, with the same context and goal as the example I posted above, it fails with <code>simplify tactic failed to simplify</code> (apologies for the huge example, but minification makes the issue disappear):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.suggest</span>
<span class="kn">import</span> <span class="n">data.finset</span>
<span class="kn">import</span> <span class="n">data.finmap</span>
<span class="kn">import</span> <span class="n">data.list</span>
<span class="kn">import</span> <span class="n">data.finmap</span>
<span class="kn">import</span> <span class="n">tactic.linarith</span>

<span class="kd">@[derive decidable_eq]</span>
<span class="kd">inductive</span> <span class="n">ttype</span>
<span class="bp">|</span> <span class="n">ty_func</span> <span class="o">(</span><span class="n">l</span> <span class="n">r</span><span class="o">:</span><span class="n">ttype</span><span class="o">):</span> <span class="n">ttype</span>
<span class="bp">|</span> <span class="n">ty_bool</span> <span class="o">:</span> <span class="n">ttype</span>

<span class="kn">open</span> <span class="n">ttype</span>


<span class="kd">instance</span> <span class="o">:</span> <span class="n">inhabited</span> <span class="n">ttype</span> <span class="o">:=</span> <span class="n">inhabited.mk</span> <span class="n">ty_bool</span>

<span class="kd">@[derive decidable_eq]</span>
<span class="kd">inductive</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_var</span> <span class="o">(</span><span class="n">idx</span><span class="o">:</span><span class="n">int</span><span class="o">)</span> <span class="o">:</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_abs</span> <span class="o">(</span><span class="n">T</span><span class="o">:</span><span class="n">ttype</span><span class="o">)</span> <span class="o">(</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">)</span> <span class="o">:</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_app</span> <span class="o">(</span><span class="n">t1</span> <span class="n">t2</span><span class="o">:</span> <span class="n">term</span><span class="o">)</span> <span class="o">:</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_true</span> <span class="o">:</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_false</span> <span class="o">:</span> <span class="n">term</span>
<span class="bp">|</span><span class="n">t_if</span> <span class="o">(</span><span class="n">cond</span> <span class="n">l</span> <span class="n">r</span><span class="o">:</span> <span class="n">term</span><span class="o">):</span> <span class="n">term</span>

<span class="kn">open</span> <span class="n">term</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">inhabited</span> <span class="n">term</span> <span class="o">:=</span> <span class="n">inhabited.mk</span> <span class="n">t_true</span>

<span class="kd">def</span> <span class="n">upshift_cutoff</span> <span class="o">:</span> <span class="n">int</span> <span class="bp">→</span> <span class="n">int</span> <span class="bp">→</span> <span class="n">term</span> <span class="bp">→</span> <span class="n">term</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="o">(</span><span class="n">t_var</span> <span class="n">k</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_var</span> <span class="o">(</span><span class="k">if</span> <span class="o">(</span><span class="n">k</span><span class="bp">&lt;</span><span class="n">c</span><span class="o">)</span> <span class="k">then</span> <span class="n">k</span> <span class="k">else</span> <span class="o">(</span><span class="n">k</span> <span class="bp">+</span> <span class="n">d</span><span class="o">))</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">T</span> <span class="n">t</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_abs</span> <span class="n">T</span> <span class="bp">$</span> <span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="o">(</span><span class="n">c</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="n">t</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_app</span> <span class="o">(</span><span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="n">c</span> <span class="n">t1</span><span class="o">)</span> <span class="o">(</span><span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="n">c</span> <span class="n">t2</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="n">t_true</span> <span class="o">:=</span> <span class="n">t_true</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="n">t_false</span> <span class="o">:=</span> <span class="n">t_false</span>
<span class="bp">|</span> <span class="n">d</span> <span class="n">c</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">cond</span> <span class="n">l</span> <span class="n">r</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_if</span> <span class="o">(</span><span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="n">c</span> <span class="n">cond</span><span class="o">)</span> <span class="o">(</span><span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="n">c</span> <span class="n">l</span><span class="o">)</span> <span class="o">(</span><span class="n">upshift_cutoff</span> <span class="n">d</span> <span class="n">c</span> <span class="n">r</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">upshift</span> <span class="o">(</span><span class="n">amt</span><span class="o">:</span><span class="n">int</span><span class="o">)</span> <span class="o">(</span><span class="n">t1</span><span class="o">:</span><span class="n">term</span><span class="o">):</span> <span class="n">term</span> <span class="o">:=</span> <span class="n">upshift_cutoff</span> <span class="n">amt</span> <span class="mi">0</span> <span class="n">t1</span>

<span class="kd">def</span> <span class="n">subst</span>  <span class="o">:</span> <span class="n">int</span> <span class="bp">→</span> <span class="n">term</span> <span class="bp">→</span> <span class="n">term</span> <span class="bp">→</span> <span class="n">term</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="o">(</span><span class="n">t_var</span> <span class="n">n</span><span class="o">)</span> <span class="o">:=</span> <span class="k">if</span> <span class="n">n</span> <span class="bp">=</span> <span class="n">idx</span> <span class="k">then</span> <span class="n">s</span> <span class="k">else</span> <span class="n">t_var</span> <span class="n">n</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">T</span> <span class="n">t</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_abs</span> <span class="n">T</span> <span class="bp">$</span> <span class="o">(</span><span class="n">subst</span> <span class="o">(</span><span class="n">idx</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">upshift</span> <span class="mi">1</span> <span class="n">s</span><span class="o">)</span> <span class="n">t</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_app</span> <span class="o">(</span><span class="n">subst</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">t1</span><span class="o">)</span> <span class="o">(</span><span class="n">subst</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">t2</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">t_true</span> <span class="o">:=</span> <span class="n">t_true</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">t_false</span> <span class="o">:=</span> <span class="n">t_false</span>
<span class="bp">|</span> <span class="n">idx</span> <span class="n">s</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">cond</span> <span class="n">l</span> <span class="n">r</span><span class="o">)</span> <span class="o">:=</span> <span class="n">t_if</span> <span class="o">(</span><span class="n">subst</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">cond</span><span class="o">)</span> <span class="o">(</span><span class="n">subst</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">l</span><span class="o">)</span> <span class="o">(</span><span class="n">subst</span> <span class="n">idx</span> <span class="n">s</span> <span class="n">r</span><span class="o">)</span>

<span class="kd">inductive</span> <span class="n">eval</span> <span class="o">:</span> <span class="n">term</span> <span class="bp">→</span> <span class="n">term</span> <span class="bp">→</span> <span class="kt">Prop</span>
<span class="bp">|</span> <span class="n">e_app1</span> <span class="o">{</span><span class="n">t1</span> <span class="n">t1'</span> <span class="n">t2</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="n">t1</span> <span class="n">t1'</span> <span class="bp">→</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2</span><span class="o">)</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1'</span> <span class="n">t2</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">e_app2</span> <span class="o">{</span><span class="n">t1</span> <span class="n">t2</span> <span class="n">t2'</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="n">t2</span> <span class="n">t2'</span> <span class="bp">→</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2</span><span class="o">)</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2'</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">e_appabs</span> <span class="o">{</span><span class="n">T11</span> <span class="n">t12</span> <span class="n">v2</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_app</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">T11</span> <span class="n">t12</span><span class="o">)</span> <span class="n">v2</span><span class="o">)</span> <span class="o">(</span><span class="n">upshift</span> <span class="o">(</span><span class="bp">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">subst</span> <span class="mi">0</span> <span class="o">(</span><span class="n">upshift</span> <span class="mi">1</span> <span class="n">v2</span><span class="o">)</span> <span class="n">t12</span><span class="o">))</span>
<span class="bp">|</span> <span class="n">e_if_true</span> <span class="o">{</span><span class="n">t2</span> <span class="n">t3</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">t_true</span> <span class="n">t2</span> <span class="n">t3</span><span class="o">)</span> <span class="o">(</span><span class="n">t2</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">e_if_false</span> <span class="o">{</span><span class="n">t2</span> <span class="n">t3</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">t_false</span> <span class="n">t2</span> <span class="n">t3</span><span class="o">)</span> <span class="o">(</span><span class="n">t3</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">e_if</span> <span class="o">{</span><span class="n">t1</span> <span class="n">t1'</span> <span class="n">t2</span> <span class="n">t3</span><span class="o">}</span> <span class="o">:</span> <span class="n">eval</span> <span class="n">t1</span> <span class="n">t1'</span> <span class="bp">→</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">t1</span> <span class="n">t2</span> <span class="n">t3</span><span class="o">)</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">t1'</span> <span class="n">t2</span> <span class="n">t3</span><span class="o">)</span>

<span class="kd">abbreviation</span> <span class="n">ctxtype</span> <span class="o">:=</span> <span class="n">list</span> <span class="n">ttype</span>

<span class="kd">def</span> <span class="n">lookup_list</span> <span class="o">:</span> <span class="n">ctxtype</span> <span class="bp">→</span> <span class="n">int</span> <span class="bp">→</span> <span class="n">option</span> <span class="n">ttype</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">)</span> <span class="mi">0</span>  <span class="o">:=</span> <span class="n">some</span> <span class="n">head</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">)</span> <span class="n">n</span>  <span class="o">:=</span> <span class="n">lookup_list</span> <span class="n">tail</span> <span class="o">(</span><span class="n">n</span><span class="bp">-</span><span class="mi">1</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">list.nil</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">none</span>
<span class="kd">@[simp]</span>
<span class="kd">def</span> <span class="n">in_ctx</span> <span class="o">(</span><span class="n">idx</span><span class="o">:</span> <span class="n">int</span><span class="o">)</span> <span class="o">(</span><span class="n">val</span><span class="o">:</span> <span class="n">ttype</span><span class="o">)</span> <span class="o">(</span><span class="n">ctx</span><span class="o">:</span><span class="n">ctxtype</span><span class="o">)</span> <span class="o">:=</span> <span class="n">lookup_list</span> <span class="n">ctx</span> <span class="n">idx</span> <span class="bp">=</span> <span class="o">(</span><span class="n">some</span> <span class="n">val</span><span class="o">)</span>

<span class="kd">inductive</span> <span class="n">typ</span> <span class="o">:</span> <span class="n">ctxtype</span> <span class="bp">→</span> <span class="n">term</span> <span class="bp">→</span> <span class="n">ttype</span> <span class="bp">→</span> <span class="kt">Prop</span>
<span class="bp">|</span> <span class="n">typ_var</span> <span class="o">{</span><span class="n">ctx</span> <span class="n">x</span> <span class="n">T</span><span class="o">}</span> <span class="o">:</span> <span class="n">x</span><span class="bp">≥</span><span class="mi">0</span> <span class="bp">→</span> <span class="n">in_ctx</span> <span class="n">x</span> <span class="n">T</span> <span class="n">ctx</span> <span class="bp">→</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="o">(</span><span class="n">t_var</span> <span class="n">x</span><span class="o">)</span> <span class="n">T</span>
<span class="bp">|</span> <span class="n">typ_abs</span> <span class="o">{</span><span class="n">ctx</span> <span class="n">T1</span> <span class="n">t2</span> <span class="n">T2</span><span class="o">}</span> <span class="o">:</span> <span class="n">typ</span> <span class="o">(</span><span class="n">T1</span><span class="o">::</span><span class="n">ctx</span><span class="o">)</span> <span class="n">t2</span> <span class="n">T2</span> <span class="bp">→</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">T1</span> <span class="n">t2</span><span class="o">)</span> <span class="o">(</span><span class="n">ty_func</span> <span class="n">T1</span> <span class="n">T2</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">typ_app</span> <span class="o">{</span><span class="n">ctx</span> <span class="n">t1</span> <span class="n">T11</span> <span class="n">T12</span> <span class="n">t2</span><span class="o">}</span> <span class="o">:</span> <span class="o">(</span><span class="n">typ</span> <span class="n">ctx</span> <span class="n">t1</span> <span class="o">(</span><span class="n">ty_func</span> <span class="n">T11</span> <span class="n">T12</span><span class="o">))</span> <span class="bp">→</span> <span class="o">(</span><span class="n">typ</span> <span class="n">ctx</span> <span class="n">t2</span> <span class="n">T11</span><span class="o">)</span> <span class="bp">→</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t1</span> <span class="n">t2</span><span class="o">)</span> <span class="n">T12</span>
<span class="bp">|</span> <span class="n">typ_true</span> <span class="o">{</span><span class="n">ctx</span><span class="o">}</span> <span class="o">:</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="n">t_true</span> <span class="n">ty_bool</span>
<span class="bp">|</span> <span class="n">typ_false</span> <span class="o">{</span><span class="n">ctx</span><span class="o">}</span> <span class="o">:</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="n">t_true</span> <span class="n">ty_bool</span>
<span class="bp">|</span> <span class="n">typ_if</span> <span class="o">{</span><span class="n">ctx</span> <span class="n">cond</span> <span class="n">l</span> <span class="n">r</span> <span class="n">T</span><span class="o">}</span> <span class="o">:</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="n">cond</span> <span class="n">ty_bool</span> <span class="bp">-&gt;</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="n">l</span> <span class="n">T</span> <span class="bp">-&gt;</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="n">r</span> <span class="n">T</span>  <span class="bp">-&gt;</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="o">(</span><span class="n">t_if</span> <span class="n">cond</span> <span class="n">l</span> <span class="n">r</span><span class="o">)</span> <span class="n">T</span>

<span class="kn">open</span> <span class="n">typ</span>

<span class="kd">theorem</span> <span class="n">subject_expansion_fails</span> <span class="o">:</span> <span class="bp">¬</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">ctx</span> <span class="n">t</span> <span class="n">t'</span> <span class="n">T</span><span class="o">,</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="n">t'</span> <span class="n">T</span> <span class="bp">→</span> <span class="n">eval</span> <span class="n">t</span> <span class="n">t'</span> <span class="bp">→</span> <span class="n">typ</span> <span class="n">ctx</span> <span class="n">t</span> <span class="n">T</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">simp</span><span class="o">,</span>
  <span class="n">existsi</span> <span class="o">(</span><span class="bp">∅</span><span class="o">:</span><span class="n">ctxtype</span><span class="o">),</span>
  <span class="n">existsi</span> <span class="n">t_app</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_var</span> <span class="mi">0</span><span class="o">)))</span> <span class="o">(</span><span class="n">t_app</span> <span class="n">t_true</span> <span class="n">t_true</span><span class="o">),</span>
  <span class="n">existsi</span> <span class="n">t_abs</span>  <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_var</span> <span class="mi">0</span><span class="o">),</span>
  <span class="n">existsi</span> <span class="n">ty_func</span> <span class="n">ty_bool</span> <span class="n">ty_bool</span><span class="o">,</span>
  <span class="n">split</span><span class="o">,</span>
  <span class="o">{</span>
    <span class="n">refine</span> <span class="n">typ_abs</span> <span class="n">_</span><span class="o">,</span>
    <span class="n">refine</span> <span class="n">typ_var</span> <span class="n">_</span> <span class="n">rfl</span><span class="o">,</span>
    <span class="n">linarith</span><span class="o">,</span>
  <span class="o">},</span>
  <span class="n">split</span><span class="o">,</span>
  <span class="o">{</span>
    <span class="k">have</span> <span class="n">a</span><span class="o">:=</span> <span class="n">eval.e_appabs</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">b</span><span class="o">:</span> <span class="n">eval</span> <span class="o">(</span><span class="n">t_app</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_var</span> <span class="mi">0</span><span class="o">)))</span> <span class="o">(</span><span class="n">t_true.t_app</span> <span class="n">t_true</span><span class="o">))</span> <span class="o">(</span><span class="n">upshift</span> <span class="o">(</span><span class="bp">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">subst</span> <span class="mi">0</span> <span class="o">(</span><span class="n">t_true.t_app</span> <span class="n">t_true</span><span class="o">)</span>  <span class="o">(</span><span class="n">t_abs</span> <span class="n">ty_bool</span> <span class="o">(</span><span class="n">t_var</span> <span class="mi">0</span><span class="o">))))</span> <span class="o">:=</span> <span class="n">a</span><span class="o">,</span>


    <span class="n">repeat</span><span class="o">{</span>
      <span class="n">rw</span> <span class="n">subst</span> <span class="n">at</span> <span class="n">b</span> <span class="bp">&lt;|&gt;</span>
      <span class="n">rw</span> <span class="n">upshift</span> <span class="n">at</span> <span class="n">b</span> <span class="bp">&lt;|&gt;</span>
      <span class="n">rw</span> <span class="n">upshift_cutoff</span> <span class="n">at</span> <span class="n">b</span> <span class="bp">&lt;|&gt;</span>
      <span class="n">simp</span> <span class="n">at</span> <span class="n">b</span>
    <span class="o">},</span>
    <span class="k">have</span> <span class="n">kk</span><span class="o">:</span> <span class="o">(</span><span class="mi">0</span><span class="bp">&lt;</span><span class="mi">1</span><span class="o">)</span><span class="bp">=</span><span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="gr">sorry</span><span class="o">,</span>
    <span class="n">simp_rw</span> <span class="n">kk</span> <span class="n">at</span> <span class="n">b</span><span class="o">,</span> <span class="c1">--error here</span>


    <span class="n">rw</span> <span class="n">subst</span> <span class="n">at</span> <span class="n">b</span><span class="o">,</span>
    <span class="n">simp</span> <span class="n">at</span> <span class="n">b</span><span class="o">,</span>
    <span class="n">rw</span> <span class="n">upshift_cutoff</span> <span class="n">at</span> <span class="n">b</span><span class="o">,</span>
    <span class="n">rw</span> <span class="n">upshift_cutoff</span> <span class="n">at</span> <span class="n">b</span><span class="o">,</span>
    <span class="n">exact</span> <span class="n">b</span><span class="o">,</span>
  <span class="o">},</span>
  <span class="o">{</span>
    <span class="n">intro</span> <span class="n">a</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">a</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">a_ᾰ</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">a_ᾰ</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">a_ᾰ_1</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">a_ᾰ_1_ᾰ</span><span class="o">,</span>
  <span class="o">}</span>
<span class="kd">end</span>
</code></pre></div>



<a name="230833192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230833192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Guilherme Espada <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230833192">(Mar 18 2021 at 09:20)</a>:</h4>
<p>I can workaround the bug by extracting to a lemma and using that, but this behavior seems weird to me</p>



<a name="230834705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230834705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230834705">(Mar 18 2021 at 09:34)</a>:</h4>
<p>Your mistake can be easily spotted if you use the infoview in VS code (and if you know what to look for -- this is a common slip ;-) ) and has nothing to do with Lean weirdness. Clicking on the <code>0 &lt; 1</code> within the <code>ite</code> shows that it's an inequality of integers, and clicking on the one on <code>kk</code> shows that it's an inequality of naturals. So you can fix with</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>    <span class="k">have</span> <span class="n">kk</span><span class="o">:</span> <span class="o">((</span><span class="mi">0</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="bp">&lt;</span><span class="mi">1</span><span class="o">)</span><span class="bp">=</span><span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="gr">sorry</span><span class="o">,</span>
    <span class="n">simp_rw</span> <span class="n">kk</span> <span class="n">at</span> <span class="n">b</span><span class="o">,</span> <span class="c1">-- works</span>
</code></pre></div>



<a name="230834859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230834859" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230834859">(Mar 18 2021 at 09:35)</a>:</h4>
<p>PS <code>    have kk: ((0 : ℤ) &lt;1)=true := by simp [zero_lt_one],</code></p>



<a name="230835025"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230835025" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230835025">(Mar 18 2021 at 09:36)</a>:</h4>
<p>PPS the whole point of introducing those weird hard-to-type <code>ᾰ</code> characters was to encourage users to name their own variables, users aren't supposed to be putting them in code.</p>



<a name="230838963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230838963" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Guilherme Espada <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230838963">(Mar 18 2021 at 10:12)</a>:</h4>
<p>Thanks for the help. I have another question: Why does the behavior differ when I extract the lemma? Does lean automatically try to figure out the right kind of 0 somehow, which differs when the lemma is extracted?</p>
<p>Regarding <code>ᾰ</code>, I'm trying to avoid it in new code. However, I have a large file that used autogenerated names (back when they used to be <code>a</code>) and it isn't really practical for me to rewrite it all.</p>



<a name="230839235"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230839235" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230839235">(Mar 18 2021 at 10:14)</a>:</h4>
<p>Yes, Lean has a "figure out which zero it is" thing going on, it's called typeclass resolution applied to the class <code>has_zero.zero</code>. However, in contrast to most other pieces of notation, numerals have this "default type" of nat. Some of us would love to see the back of this, and if we had our way then your version of <code>kk</code> would simply fail with the error "I don't know which 0 you're talking about". But I think the designers had their reasons for this default to nat thing. All I see is the confusion it causes ;-)</p>



<a name="230839564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230839564" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230839564">(Mar 18 2021 at 10:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="379013">Guilherme Espada</span> <a href="#narrow/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F/near/230838963">said</a>:</p>
<blockquote>
<p>Regarding <code>ᾰ</code>, I'm trying to avoid it in new code. However, I have a large file that used autogenerated names (back when they used to be <code>a</code>) and it isn't really practical for me to rewrite it all.</p>
</blockquote>
<p>Is it practical for you to downgrade to an older version of lean? Or do you need the newest version of mathlib?</p>



<a name="230841275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Rewriting%20things%20inside%20ifs%3F/near/230841275" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Guilherme Espada <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Rewriting.20things.20inside.20ifs.3F.html#230841275">(Mar 18 2021 at 10:32)</a>:</h4>
<p>Not really, the version I was using before had a bunch of broken things in visual studio. Besides, I really don't mind having to use ᾰ every now and then for old proofs, and I already went through and replaced the <code>a</code>s with <code>ᾰ</code> where needed. So at this point, I really wouldn't gain anything from downgrading.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>