---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/Instances.20of.20functions.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Instances.20of.20functions.html">Instances of functions</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="319701679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Instances%20of%20functions/near/319701679" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrew Carter <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Instances.20of.20functions.html#319701679">(Jan 06 2023 at 00:59)</a>:</h4>
<p>I'm trying to get some instance code working but I'm running into "maximum class-instance resolution depth has been reached ...", and I'm a little bit worried that I'm using instances beyond their intended capacity. The only instances I have defined are:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">instance</span> <span class="n">iteration_complexity</span> <span class="o">(</span><span class="n">α</span><span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">α_en</span><span class="o">:</span> <span class="n">has_encoding</span> <span class="n">α</span><span class="o">]</span>
  <span class="o">(</span><span class="n">f</span><span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">[</span><span class="n">cf</span><span class="o">:</span> <span class="n">has_complexity</span> <span class="n">f</span><span class="o">]:</span> <span class="n">has_complexity</span> <span class="o">(</span><span class="n">nat.iterate</span> <span class="n">f</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">fconstructor</span><span class="o">,</span>
  <span class="n">fconstructor</span><span class="o">,</span>
  <span class="n">swap</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">iteration_complexity_le</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">cf.value.2</span><span class="o">,</span>
  <span class="n">refl</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">refl</span> <span class="o">},</span>
<span class="kd">end</span>

<span class="kd">instance</span> <span class="n">flip_complexity</span> <span class="o">(</span><span class="n">α</span> <span class="n">β</span> <span class="n">γ</span><span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">α_en</span><span class="o">:</span> <span class="n">has_encoding</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">β_en</span><span class="o">:</span> <span class="n">has_encoding</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">γ_en</span><span class="o">:</span> <span class="n">has_encoding</span> <span class="n">γ</span><span class="o">]</span>
  <span class="o">(</span><span class="n">f</span><span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">cf</span><span class="o">:</span> <span class="n">has_complexity</span> <span class="n">f</span><span class="o">]:</span> <span class="n">has_complexity</span> <span class="o">(</span><span class="n">function.swap</span> <span class="n">f</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">fconstructor</span><span class="o">,</span>
  <span class="n">fconstructor</span><span class="o">,</span>
  <span class="n">swap</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">flip_complexity_le</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">cf.value.2</span><span class="o">,</span>
  <span class="n">refl</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">refl</span> <span class="o">},</span>
<span class="kd">end</span>

<span class="kd">instance</span> <span class="n">pred_complexity</span><span class="o">:</span> <span class="n">has_complexity</span> <span class="n">nat.pred</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">fconstructor</span><span class="o">,</span>
  <span class="n">fconstructor</span><span class="o">,</span>
  <span class="n">swap</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">pred_complexity_le</span><span class="o">,</span>
<span class="kd">end</span>

<span class="kd">instance</span> <span class="n">sub_complexity</span><span class="o">:</span> <span class="n">has_complexity</span> <span class="n">nat.sub</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="k">show</span> <span class="n">nat.sub</span> <span class="bp">=</span> <span class="n">function.swap</span> <span class="o">(</span><span class="n">nat.iterate</span> <span class="n">nat.pred</span><span class="o">),</span> <span class="kd">begin</span>
    <span class="n">ext1</span> <span class="n">n</span><span class="o">,</span> <span class="n">ext1</span> <span class="n">m</span><span class="o">,</span>
    <span class="n">induction</span> <span class="n">m</span> <span class="n">generalizing</span> <span class="n">n</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">simp</span> <span class="o">[</span><span class="n">nat.sub</span><span class="o">,</span> <span class="n">function.swap</span><span class="o">]</span> <span class="o">},</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">function.swap</span><span class="o">,</span> <span class="n">function.iterate_succ_apply'</span><span class="o">,</span> <span class="n">nat.sub</span><span class="o">,</span> <span class="n">nat.sub_succ</span><span class="o">,</span> <span class="n">m_ih</span><span class="o">],</span>
  <span class="kd">end</span><span class="o">],</span>
  <span class="n">apply_instance</span><span class="o">,</span>
  <span class="c1">-- maximum class-instance resolution depth has been reached</span>
  <span class="c1">-- (the limit can be increased by setting option 'class.instance_max_depth')</span>
  <span class="c1">-- (the class-instance resolution trace can be visualized by setting option 'trace.class_instances')</span>
<span class="kd">end</span>
</code></pre></div>
<p>The last one doesn't compile (I don't think any of the other proofs are important here, but I can provide more details if they are). With the error message in the comment. I'm wondering if this is improper use of instances because I'm matching on function names instead of types. As a human it looks pretty easy to unwrap the declaration (find an instance that matches function.swap, then find one that matches nat.iterate, then find the one for nat.pred).</p>



<a name="319702174"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Instances%20of%20functions/near/319702174" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Instances.20of.20functions.html#319702174">(Jan 06 2023 at 01:03)</a>:</h4>
<p>I think the problem is that <a href="https://leanprover-community.github.io/mathlib_docs/find/function.swap">docs#function.swap</a> is reducible and so <code>flip_complexity </code> forms a loop with itself</p>



<a name="319702906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Instances%20of%20functions/near/319702906" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrew Carter <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Instances.20of.20functions.html#319702906">(Jan 06 2023 at 01:10)</a>:</h4>
<p>Ah, interesting. Wrapping a new function for flip worked, thanks <span class="user-mention" data-user-id="310045">@Eric Wieser</span> .</p>



<a name="319703132"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Instances%20of%20functions/near/319703132" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Instances.20of.20functions.html#319703132">(Jan 06 2023 at 01:13)</a>:</h4>
<p>Does <a href="https://leanprover-community.github.io/mathlib_docs/find/flip">docs#flip</a> work for you?</p>



<a name="319704258"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Instances%20of%20functions/near/319704258" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrew Carter <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Instances.20of.20functions.html#319704258">(Jan 06 2023 at 01:26)</a>:</h4>
<p>Yes it does, not sure how I missed it, given it had the name I expected</p>



<a name="319704748"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Instances%20of%20functions/near/319704748" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrew Carter <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Instances.20of.20functions.html#319704748">(Jan 06 2023 at 01:32)</a>:</h4>
<p>A follow-up question (related mostly on the question of instance abuse).<br>
I've defined the instance as follows</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">is_complexity</span> <span class="o">{</span><span class="n">α</span><span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">has_encodable_function</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">f</span><span class="o">:</span> <span class="n">α</span><span class="o">):=</span>
<span class="n">mk</span> <span class="o">::</span> <span class="o">(</span><span class="n">cost</span> <span class="o">:</span> <span class="n">cost_function'</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">inv</span> <span class="o">:</span> <span class="n">complexity_le</span> <span class="n">f</span> <span class="n">cost</span><span class="o">)</span>

<span class="kd">class</span> <span class="n">has_complexity</span> <span class="o">{</span><span class="n">α</span><span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">has_encodable_function</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">f</span><span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">(</span><span class="n">value</span><span class="o">:</span> <span class="n">is_complexity</span> <span class="n">f</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">complexity</span> <span class="o">{</span><span class="n">α</span><span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">[</span><span class="n">has_encodable_function</span> <span class="n">α</span><span class="o">]</span>  <span class="o">(</span><span class="n">f</span><span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">[</span><span class="n">cf</span><span class="o">:</span> <span class="n">has_complexity</span> <span class="n">f</span><span class="o">]</span> <span class="o">:=</span>
  <span class="n">cf.value.1</span>
</code></pre></div>
<p>is there a way for me to interact with the underlying cost function from an instance? Or is it quotiented away in some sense.<br>
I.e.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">sc_cost</span><span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span> <span class="n">m</span><span class="o">,</span> <span class="o">(</span><span class="mi">2</span> <span class="bp">*</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">15</span><span class="o">)</span> <span class="bp">*</span> <span class="n">m</span> <span class="bp">+</span> <span class="mi">5</span>
<span class="kd">theorem</span> <span class="n">sc</span><span class="o">:</span> <span class="o">(</span><span class="n">complexity</span> <span class="n">nat.sub</span><span class="o">)</span><span class="bp">.</span><span class="n">always_le</span> <span class="n">sc_cost</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">intros</span> <span class="n">n</span> <span class="n">m</span><span class="o">,</span>
  <span class="n">simp</span> <span class="o">[</span><span class="n">complexity</span><span class="o">,</span> <span class="n">sc_cost</span><span class="o">],</span>
  <span class="c1">-- |- has_complexity.value.cost n m ≤ (2 * n + 15) * m + 5</span>
  <span class="gr">sorry</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="319734578"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Instances%20of%20functions/near/319734578" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Instances.20of.20functions.html#319734578">(Jan 06 2023 at 08:08)</a>:</h4>
<p>Sure it's possible, though it will be kind of hard to work with because you used <code>rw</code> to define data</p>



<a name="319734675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Instances%20of%20functions/near/319734675" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Instances.20of.20functions.html#319734675">(Jan 06 2023 at 08:09)</a>:</h4>
<p>It would be better to define a function like <a href="https://leanprover-community.github.io/mathlib_docs/find/fin.cast">docs#fin.cast</a> that copies the data, and only rewrites in the proof</p>



<a name="320349908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Instances%20of%20functions/near/320349908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrew Carter <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Instances.20of.20functions.html#320349908">(Jan 09 2023 at 23:19)</a>:</h4>
<p>Thanks, I'll take a look</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>