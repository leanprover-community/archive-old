---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html">Mathlib and lean server consumes too much memory on mac m1</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="237599111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237599111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hyunggyu Jang <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237599111">(May 06 2021 at 03:16)</a>:</h4>
<p>Hi, I&rsquo;m newbie about <code>lean</code> and <code>mathlib</code> also. And I&rsquo;m trying to set up <code>mathlib</code> facilities on my environment, mac m1. To do so, I&rsquo;ve followed the instructions for quick start, that is, <code>leanproject get tutorials</code>. Launched <code>00_first_proofs.lean</code>, and wait for a while for <code>lean</code> to correctly load the dependencies and compile.</p>
<p>It seemed to work for a while, but seems with some noticeable lags, and eventually spitted an error message saying</p>
<blockquote>
<p>error: excessive memory consumption detected at &rsquo;replace&rsquo; (potential solution: increase memory consumption threshold)</p>
</blockquote>
<p>To inspect what&rsquo;s going on, first, I opened Activity Monitor, and confirmed <code>lean</code> itself consumes too much memory:<br>
<a href="/user_uploads/3121/xMc1tQ0pPGpjLJsvleT0sNW4/Screen-Shot-2021-05-06-at-12.03.19-PM.png">Screen-Shot-2021-05-06-at-12.03.19-PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/xMc1tQ0pPGpjLJsvleT0sNW4/Screen-Shot-2021-05-06-at-12.03.19-PM.png" title="Screen-Shot-2021-05-06-at-12.03.19-PM.png"><img src="/user_uploads/3121/xMc1tQ0pPGpjLJsvleT0sNW4/Screen-Shot-2021-05-06-at-12.03.19-PM.png"></a></div><p>Thanks for all your hard work! </p>
<p>Best regards,<br>
-- <strong>Hyunggyu Jang</strong></p>



<a name="237599280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237599280" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237599280">(May 06 2021 at 03:19)</a>:</h4>
<p>Did you open the tutorials directory in VS Code, or just the file <code>00_first_proofs.lean</code>?</p>



<a name="237599419"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237599419" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hyunggyu Jang <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237599419">(May 06 2021 at 03:21)</a>:</h4>
<p>Thanks for your quick reply!</p>
<p>I&rsquo;ve launched <code>00_first_proofs.lean</code> at Emacs directly.</p>



<a name="237599535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237599535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237599535">(May 06 2021 at 03:22)</a>:</h4>
<p>Oh, I see. I'm not sure if the same is true for the emacs mode, but at least for VS Code you have to open the directory, not just a single file.</p>



<a name="237599688"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237599688" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hyunggyu Jang <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237599688">(May 06 2021 at 03:24)</a>:</h4>
<p>At least, to me, there&rsquo;s no way to trigger lean server by opening the enclosing directory, not the file itself.</p>
<p>I really <em>love</em> Emacs, so I want to avoid to use VS Code.</p>
<p>Thanks!</p>



<a name="237599705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237599705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237599705">(May 06 2021 at 03:25)</a>:</h4>
<p>If you navigate to your tutorials directory in the console and run <code>ls _target/deps/mathlib/src/algebra</code> do you see any files with a <code>.olean</code> extension? If so, that means that <code>leanproject</code> did at least get the compiled files which should make Lean load quickly.</p>



<a name="237599777"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237599777" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hyunggyu Jang <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237599777">(May 06 2021 at 03:26)</a>:</h4>
<p>Yes, I can confirm it compiled to <code>*.olean</code> along with its source file, <code>*.lean</code></p>



<a name="237599889"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237599889" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hyunggyu Jang <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237599889">(May 06 2021 at 03:28)</a>:</h4>
<p>Furthermore, even after I met such an error from <code>lean</code> server, I still can interact as normal. The only problem seems to be the fact that I consumes too much memory. It affects my OS&rsquo;s behavior noticeably.</p>



<a name="237599904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237599904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237599904">(May 06 2021 at 03:28)</a>:</h4>
<p>Well, the reason Lean is using so many resources is because it's recompiling the <code>.lean</code> files. What version of Lean are you using?</p>



<a name="237599946"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237599946" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237599946">(May 06 2021 at 03:29)</a>:</h4>
<p>We don't have an official M1 release, so just to be sure, are you using the x86 version coming from <code>elan</code>?</p>



<a name="237600282"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237600282" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hyunggyu Jang <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237600282">(May 06 2021 at 03:34)</a>:</h4>
<p>The latest one, 3.30c. But it seems like the tutorial wants 3.28 version.</p>
<p>Oh, <code>elan</code> seems to have <code>gmp</code> <a href="https://github.com/leanprover/elan/issues/20">path problem</a>, and even I set it properly by</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>install_name_tool -change /usr/local/opt/gmp/lib/libgmp.10.dylib /opt/homebrew/lib/libgmp.10.dylib ~/.elan/toolchains/leanprover-community--lean---3.28.0/bin/lean
</code></pre></div>
<p>As my <code>gmp</code> is <code>arm64</code> version, it conflicted with <code>lean</code> executable.</p>
<p>So I&rsquo;ve gone with <code>brew</code>&rsquo;s <code>lean</code>, which supports <code>arm64</code> architecture, plus, it supports <code>HEAD</code> option, which presumably builds <code>lean</code> from github repository, I guess.</p>



<a name="237600405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237600405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hyunggyu Jang <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237600405">(May 06 2021 at 03:35)</a>:</h4>
<p>Since <code>lean</code> doesn&rsquo;t support m1 officially, then maybe I should use Rosetta 2 for emulating intel architecture?</p>



<a name="237600493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237600493" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237600493">(May 06 2021 at 03:36)</a>:</h4>
<p>Yes, I think Rosetta + elan is still the recommended way to go. </p>
<p>We don't recommend using homebrew, as that only installs a single version of Lean and you may find yourself looking at projects which require different versions of Lean, e.g. the tutorials which are on 3.28 and mathlib which is currently on 3.30.</p>



<a name="237600536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237600536" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237600536">(May 06 2021 at 03:37)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="321696">@Julian Berman</span> has been using Lean on an M1 Mac; he might have some more advice.</p>



<a name="237600757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237600757" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hyunggyu Jang <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237600757">(May 06 2021 at 03:40)</a>:</h4>
<p>Thanks for redirecting! I hope I can get some insight how to setup <code>lean</code> in M1.</p>
<p>For the Rosetta + elan combination, I guess should install Rosetta version homebrew.</p>
<p>Thanks for your sincere advice! At least, I think, I found what caused the excessive memory consumption from <code>lean</code> server side!</p>



<a name="237604534"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237604534" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hyunggyu Jang <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237604534">(May 06 2021 at 04:39)</a>:</h4>
<p>For anyone who reached this discussion, if one scarifies version managing facilities from <code>elan</code>, that is, if you are okay with a single version of <code>lean</code>, you can do it as following, at least for the tutorials:</p>
<ol>
<li>Install the latest <code>lean</code> via either from source or homebrew. For example, I&rsquo;ve installed with the command:</li>
</ol>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>brew install lean --HEAD
</code></pre></div>
<div class="codehilite"><pre><span></span><code>At the time of writing, it should match with the version supported by `mathlib`.
</code></pre></div>

<ol start="2">
<li>Build tutorials with <code>leanpackage get tutorials</code>. It is for getting the source files from <code>tutorials</code> rather than building <code>mathlib</code> dependencies, which are to be done via the following step.</li>
<li>Build <code>mathlib</code> dependency with <code>leanpackage new</code>. Note that this should be issued other than the <code>tutorials</code> directory to avoid meta configuration file conflicts. You shouldn&rsquo;t get any error messages in this step.</li>
<li>Move the source codes from <code>tutorials</code> to the newly built project. Might need to adjust <code>leanpkg.toml</code> or <code>leanpkg.path</code>.</li>
</ol>
<p>Result?<br>
<a href="/user_uploads/3121/6PeIcQ2fYLvtJ9_wrGyveFPT/Screen-Shot-2021-05-06-at-1.36.17-PM.png">Screen-Shot-2021-05-06-at-1.36.17-PM.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/3121/6PeIcQ2fYLvtJ9_wrGyveFPT/Screen-Shot-2021-05-06-at-1.36.17-PM.png" title="Screen-Shot-2021-05-06-at-1.36.17-PM.png"><img src="/user_uploads/3121/6PeIcQ2fYLvtJ9_wrGyveFPT/Screen-Shot-2021-05-06-at-1.36.17-PM.png"></a></div><p>All I needed was to taste and experiment with <code>lean</code>, thus, felt a single version of <code>lean</code> is more than sufficient to me.<br>
Thanks for guiding me, <span class="user-mention" data-user-id="123965">@Bryan Gin-ge Chen</span>!!</p>



<a name="237920841"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237920841" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Brandon Brown <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237920841">(May 08 2021 at 03:36)</a>:</h4>
<p>I'm getting the same error in VS Code on Macbook Air M1 with 16GB RAM: "excessive memory consumption detected at 'replace' (potential solution: increase memory consumption threshold)" only when importing from mathlib it seems.</p>



<a name="237936128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/237936128" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#237936128">(May 08 2021 at 08:00)</a>:</h4>
<p>Do you have a fully compiled mathlib on your system? If not then that error is not unexpected</p>



<a name="238003971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/238003971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Brandon Brown <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#238003971">(May 09 2021 at 03:19)</a>:</h4>
<p>I fixed it somehow. I had the folder syncing with Dropbox, so I disabled that in case dropbox was messing with things. I also deleting the project and all the files and then did a fresh <code>leanproject new</code> and now it's so far not giving me that error.</p>



<a name="238084410"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Mathlib%20and%20lean%20server%20consumes%20too%20much%20memory%20on%20mac%20m1/near/238084410" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Mathlib.20and.20lean.20server.20consumes.20too.20much.20memory.20on.20mac.20m1.html#238084410">(May 10 2021 at 04:05)</a>:</h4>
<p>Switching back to lean3 from lean4, I am having the same issue with Emacs getting up an running:<br>
<code>Lean (version 3.30.0, commit a5822ea47ebc, Release)</code><br>
Used leanproject to get mathlib, where I have oleans<br>
<code>mathlib = {git = "https://github.com/leanprover-community/mathlib", rev = "ea0043ca0f7c83de3103c0a5b87b7b39717cb837"}</code><br>
VSCode runs <code>import topology.basic</code> without issues, and an otherwise responsive Emacs lean-mode will spin up several threads and hang. Looks like it may be unable to find/use the oleans, and is trying to rebuild mathlib.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>