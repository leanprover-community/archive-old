---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/vm.20check.20failed.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html">vm check failed</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="202211349"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202211349" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bhavik Mehta <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202211349">(Jun 28 2020 at 00:14)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">list</span><span class="bp">.</span><span class="n">range</span>

<span class="n">def</span> <span class="n">burgerfy</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">string</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">nat</span><span class="bp">.</span><span class="n">strong_rec_on</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">intros</span> <span class="n">k</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">apply</span> <span class="s2">&quot;{&quot;</span> <span class="bp">++</span> <span class="n">string</span><span class="bp">.</span><span class="n">intercalate</span> <span class="s2">&quot;,&quot;</span> <span class="o">(</span><span class="n">list</span><span class="bp">.</span><span class="n">map</span> <span class="bp">_</span> <span class="o">(</span><span class="n">list</span><span class="bp">.</span><span class="n">fin_range</span> <span class="n">k</span><span class="o">))</span> <span class="bp">++</span> <span class="s2">&quot;}&quot;</span><span class="o">,</span>
  <span class="n">intro</span> <span class="n">m</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">h</span> <span class="n">m</span><span class="bp">.</span><span class="mi">1</span> <span class="n">m</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span>
<span class="kn">end</span>

<span class="bp">#</span><span class="kn">eval</span> <span class="o">(</span><span class="n">burgerfy</span> <span class="mi">1</span><span class="o">)</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="o">(</span><span class="n">burgerfy</span> <span class="mi">2</span><span class="o">)</span>
</code></pre></div>


<p>The first works and the second fails with the error message "vm check failed: is_closure(o) (possibly due to incorrect axioms, or sorry)" but I'm not using sorry and only using mathlib/core functions, why is this?</p>



<a name="202211421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202211421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bhavik Mehta <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202211421">(Jun 28 2020 at 00:16)</a>:</h4>
<p>Also, this is a def which isn't noncomputable, so I expected it to compute fine</p>



<a name="202217111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217111">(Jun 28 2020 at 03:12)</a>:</h4>
<p>There appears to be a bug in the VM implementation of <code>nat.strong_rec_on</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">strong_rec_on</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="mi">0</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">-</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="k">then</span> <span class="n">ih</span> <span class="bp">_</span> <span class="n">h</span> <span class="bp">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">-- 0</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">strong_rec_on</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="mi">1</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">-</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="k">then</span> <span class="n">ih</span> <span class="bp">_</span> <span class="n">h</span> <span class="bp">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">-- 1</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">strong_rec_on</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="mi">2</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">-</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="k">then</span> <span class="n">ih</span> <span class="bp">_</span> <span class="n">h</span> <span class="bp">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">-- 2</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">strong_rec_on</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="mi">3</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">-</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="k">then</span> <span class="n">ih</span> <span class="bp">_</span> <span class="n">h</span> <span class="bp">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">-- vm check failed: cidx(closure) == 0 (possibly due to incorrect axioms, or sorry</span>
</code></pre></div>



<a name="202217139"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217139" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bhavik Mehta <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217139">(Jun 28 2020 at 03:13)</a>:</h4>
<p>yay I found a vm bug</p>



<a name="202217254"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217254" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217254">(Jun 28 2020 at 03:16)</a>:</h4>
<p>A workaround is to not use <code>strong_rec_on</code> to write wf definitions for the VM</p>



<a name="202217256"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217256" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217256">(Jun 28 2020 at 03:16)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">burgerfy</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">string</span>
<span class="bp">|</span> <span class="n">n</span> <span class="o">:=</span> <span class="s2">&quot;{&quot;</span> <span class="bp">++</span> <span class="n">string</span><span class="bp">.</span><span class="n">intercalate</span> <span class="s2">&quot;,&quot;</span> <span class="o">((</span><span class="n">list</span><span class="bp">.</span><span class="n">fin_range</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="n">map</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">⟨</span><span class="n">m</span><span class="o">,</span> <span class="n">h</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">burgerfy</span> <span class="n">m</span><span class="o">))</span> <span class="bp">++</span> <span class="s2">&quot;}&quot;</span>
</code></pre></div>


<p>This generally performs better anyway</p>



<a name="202217261"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217261" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217261">(Jun 28 2020 at 03:17)</a>:</h4>
<p>But this is the first time I have ever seen a VM bug so congrats</p>



<a name="202217308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217308">(Jun 28 2020 at 03:18)</a>:</h4>
<p>Do you know if the VM has a specialized version of <code>nat.strong_rec_on</code>, or does it compile its Lean definition like usual?</p>



<a name="202217309"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217309" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217309">(Jun 28 2020 at 03:18)</a>:</h4>
<p>I think it just compiles the regular definition</p>



<a name="202217310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217310">(Jun 28 2020 at 03:18)</a>:</h4>
<p>I might try shrinking it to find the cause</p>



<a name="202217311"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217311" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bhavik Mehta <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217311">(Jun 28 2020 at 03:18)</a>:</h4>
<p>Oh that's the version I was looking for! I tried using the equation compiler but couldn't satisfy it, so went straight to <code>strong_rec_on</code> in tactic mode</p>



<a name="202217371"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217371" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217371">(Jun 28 2020 at 03:20)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">universe</span> <span class="n">u</span>
<span class="kn">open</span> <span class="n">nat</span>
<span class="n">def</span> <span class="n">strong_rec_on₂</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">nat</span> <span class="bp">→</span> <span class="n">Sort</span> <span class="n">u</span><span class="o">}</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">nat</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span><span class="o">,</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">m</span><span class="o">,</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">p</span> <span class="n">m</span><span class="o">)</span> <span class="bp">→</span> <span class="n">p</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">p</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">suffices</span> <span class="bp">∀</span> <span class="n">n</span> <span class="n">m</span><span class="o">,</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">p</span> <span class="n">m</span><span class="o">,</span> <span class="k">from</span> <span class="n">this</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="o">)</span> <span class="n">n</span> <span class="o">(</span><span class="n">lt_succ_self</span> <span class="bp">_</span><span class="o">),</span>
<span class="k">begin</span>
  <span class="n">intros</span> <span class="n">n</span><span class="o">,</span> <span class="n">induction</span> <span class="n">n</span> <span class="k">with</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span>
    <span class="o">{</span><span class="n">intros</span> <span class="n">m</span> <span class="n">h₁</span><span class="o">,</span> <span class="n">exact</span> <span class="n">absurd</span> <span class="n">h₁</span> <span class="o">(</span><span class="n">not_lt_zero</span> <span class="bp">_</span><span class="o">)},</span>
    <span class="o">{</span><span class="n">intros</span> <span class="n">m</span> <span class="n">h₁</span><span class="o">,</span>
      <span class="n">apply</span> <span class="n">or</span><span class="bp">.</span><span class="n">by_cases</span> <span class="o">(</span><span class="n">lt_or_eq_of_le</span> <span class="o">(</span><span class="n">le_of_lt_succ</span> <span class="n">h₁</span><span class="o">)),</span>
        <span class="o">{</span><span class="n">intros</span><span class="o">,</span> <span class="n">apply</span> <span class="n">ih</span><span class="o">,</span> <span class="n">assumption</span><span class="o">},</span>
        <span class="o">{</span><span class="n">intros</span><span class="o">,</span> <span class="n">subst</span> <span class="n">m</span><span class="o">,</span> <span class="n">apply</span> <span class="n">h</span> <span class="bp">_</span> <span class="n">ih</span><span class="o">}}</span>
<span class="kn">end</span>

<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">strong_rec_on₂</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="mi">3</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">-</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="k">then</span> <span class="n">ih</span> <span class="bp">_</span> <span class="n">h</span> <span class="bp">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">-- vm check failed: cidx(closure) == 0 (possibly due to incorrect axioms, or sorry</span>
</code></pre></div>


<p>still fails</p>



<a name="202217494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bhavik Mehta <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217494">(Jun 28 2020 at 03:25)</a>:</h4>
<p>Huh, I'm surprised there's a difference between</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">list</span><span class="bp">.</span><span class="n">range</span>

<span class="n">def</span> <span class="n">burgerfy</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">string</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="s2">&quot;nothing burger&quot;</span>
<span class="bp">|</span> <span class="n">n</span> <span class="o">:=</span> <span class="n">string</span><span class="bp">.</span><span class="n">intercalate</span> <span class="s2">&quot; and &quot;</span> <span class="o">((</span><span class="n">list</span><span class="bp">.</span><span class="n">fin_range</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="n">map</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">⟨</span><span class="n">m</span><span class="o">,</span> <span class="n">h</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">burgerfy</span> <span class="n">m</span><span class="o">))</span> <span class="bp">++</span> <span class="s2">&quot; burger&quot;</span>
</code></pre></div>


<p>and</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">list</span><span class="bp">.</span><span class="n">range</span>

<span class="n">def</span> <span class="n">burgerfy</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">string</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="s2">&quot;nothing burger&quot;</span>
<span class="bp">|</span> <span class="n">n</span> <span class="o">:=</span> <span class="n">string</span><span class="bp">.</span><span class="n">intercalate</span> <span class="s2">&quot; and &quot;</span> <span class="o">((</span><span class="n">list</span><span class="bp">.</span><span class="n">fin_range</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="n">map</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">⟨</span><span class="n">m</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span> <span class="n">burgerfy</span> <span class="n">m</span><span class="o">))</span> <span class="bp">++</span> <span class="s2">&quot; burger&quot;</span>
</code></pre></div>



<a name="202217812"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217812" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217812">(Jun 28 2020 at 03:36)</a>:</h4>
<p>That's because <code>default_dec_tac</code> automatically clears hypotheses with "internal" names (meaning initial underscore)</p>



<a name="202217880"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217880" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217880">(Jun 28 2020 at 03:39)</a>:</h4>
<p>After picking apart <code>nat.strong_rec_on</code> a bit, I reached a step where I replaced a <code>nat.rec</code> with a pattern match and it seemingly fixed it. I'll try to investigate the difference</p>



<a name="202217929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202217929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202217929">(Jun 28 2020 at 03:40)</a>:</h4>
<p>Hmm, the pattern matching elaborator generates much more complicated code than a simple <code>nat.rec</code>.</p>



<a name="202218055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218055">(Jun 28 2020 at 03:45)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">bar</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">ih</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">m</span><span class="o">,</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">→</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">-</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="k">then</span> <span class="n">ih</span> <span class="bp">_</span> <span class="n">h</span> <span class="bp">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
<span class="n">def</span> <span class="n">foo</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">n</span> <span class="n">m</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">nat</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span> <span class="n">h₁</span><span class="o">,</span> <span class="n">absurd</span> <span class="n">h₁</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">not_lt_zero</span> <span class="bp">_</span><span class="o">)</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">m</span> <span class="n">h₁</span><span class="o">,</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="k">then</span> <span class="n">foo</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">h</span> <span class="k">else</span> <span class="n">bar</span> <span class="n">n</span> <span class="o">(</span><span class="n">foo</span> <span class="bp">_</span><span class="o">)</span>

<span class="n">def</span> <span class="n">foo&#39;</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">m</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">nat</span> <span class="o">:=</span>
<span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">m</span> <span class="n">h₁</span><span class="o">,</span> <span class="n">absurd</span> <span class="n">h₁</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">not_lt_zero</span> <span class="bp">_</span><span class="o">))</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">IH</span> <span class="n">m</span> <span class="n">h₁</span><span class="o">,</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="k">then</span> <span class="n">IH</span> <span class="bp">_</span> <span class="n">h</span> <span class="k">else</span> <span class="n">bar</span> <span class="n">n</span> <span class="n">IH</span><span class="o">)</span>

<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">foo</span> <span class="mi">3</span> <span class="mi">2</span> <span class="n">dec_trivial</span> <span class="c1">-- 2</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">foo&#39;</span> <span class="mi">3</span> <span class="mi">2</span> <span class="n">dec_trivial</span> <span class="c1">-- vm check failed: cidx(closure) == 0 (possibly due to incorrect axioms, or sorry</span>
</code></pre></div>



<a name="202218099"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218099" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218099">(Jun 28 2020 at 03:46)</a>:</h4>
<p>Nice</p>



<a name="202218101"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218101" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218101">(Jun 28 2020 at 03:46)</a>:</h4>
<p>The VM has special support for definitions using the equation compiler</p>



<a name="202218111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218111">(Jun 28 2020 at 03:47)</a>:</h4>
<p>But in any case it's different code so it's not particularly surprising that it doesn't behave the same; there probably isn't too much point in examining the pattern match code to find out why it works</p>



<a name="202218115"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218115" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218115">(Jun 28 2020 at 03:47)</a>:</h4>
<p>Yeah, I had switched to simplifying the <code>nat.rec</code> code instead, but you came up with something simpler anyway</p>



<a name="202218155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218155" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218155">(Jun 28 2020 at 03:48)</a>:</h4>
<p>I would be surprised if there was a difference between <code>nat.rec</code> and <code>nat.rec_on</code> here; they both get special support</p>



<a name="202218272"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218272" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218272">(Jun 28 2020 at 03:52)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">bar</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">IH</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">IH</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span>
<span class="n">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">m</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">IH</span> <span class="n">m</span><span class="o">,</span> <span class="n">bar</span> <span class="n">n</span> <span class="n">IH</span><span class="o">)</span>
<span class="n">def</span> <span class="n">foo&#39;</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">m</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">IH</span> <span class="n">m</span><span class="o">,</span> <span class="n">IH</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span>

<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">foo</span> <span class="mi">3</span> <span class="mi">2</span> <span class="c1">-- vm check failed: cidx(closure) == 0 (possibly due to incorrect axioms, or sorry</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">foo&#39;</span> <span class="mi">3</span> <span class="mi">2</span> <span class="c1">-- 3</span>
</code></pre></div>



<a name="202218519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218519">(Jun 28 2020 at 04:03)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">bar</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">IH</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">IH</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span>
<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">compiler</span><span class="bp">.</span><span class="n">optimize_bytecode</span> <span class="n">true</span>
<span class="n">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">m</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">IH</span> <span class="n">m</span><span class="o">,</span> <span class="n">bar</span> <span class="n">n</span> <span class="n">IH</span><span class="o">)</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">compiler</span><span class="bp">.</span><span class="n">optimize_bytecode</span><span class="o">]</span>  <span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span> <span class="mi">1</span>
<span class="mi">0</span><span class="o">:</span> <span class="n">move</span> <span class="mi">0</span>
<span class="mi">1</span><span class="o">:</span> <span class="n">nat_cases</span> <span class="mi">4</span>
<span class="mi">2</span><span class="o">:</span> <span class="n">scnstr</span> <span class="bp">#</span><span class="mi">0</span>
<span class="mi">3</span><span class="o">:</span> <span class="n">ret</span>
<span class="mi">4</span><span class="o">:</span> <span class="n">push</span> <span class="mi">1</span>
<span class="mi">5</span><span class="o">:</span> <span class="n">ginvoke</span> <span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span>
<span class="mi">6</span><span class="o">:</span> <span class="n">move</span> <span class="mi">1</span>
<span class="mi">7</span><span class="o">:</span> <span class="n">ginvoke</span> <span class="n">bar</span>
<span class="mi">8</span><span class="o">:</span> <span class="n">drop</span> <span class="mi">1</span>
<span class="mi">9</span><span class="o">:</span> <span class="n">ret</span>
<span class="o">[</span><span class="n">compiler</span><span class="bp">.</span><span class="n">optimize_bytecode</span><span class="o">]</span>  <span class="n">foo</span> <span class="mi">2</span>
<span class="mi">0</span><span class="o">:</span> <span class="n">move</span> <span class="mi">1</span>
<span class="mi">1</span><span class="o">:</span> <span class="n">ginvoke</span> <span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span>
<span class="mi">2</span><span class="o">:</span> <span class="n">ret</span>
</code></pre></div>



<a name="202218830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218830">(Jun 28 2020 at 04:15)</a>:</h4>
<p>This compilation is a bit odd. As a primer for those who don't know, the main function <code>foo 2</code> here indicates that <code>foo</code> is a function with two arguments. It calls <code>move 1</code>, pushing argument 1 (I think this is <code>n</code>) on the stack, and then calls <code>foo._rec_1</code>, which is the recursive function that is constructed as part of <code>nat.rec_on</code>. This could normally be a closure, depending on arguments outside the <code>nat.rec_on</code>, but in this case we don't reference any external variables so <code>foo._rec_1</code> has only one argument, the index. You can think of it as being defined like this:</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">func</span> <span class="o">:=</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="bp">ℕ</span>
<span class="n">meta</span> <span class="n">def</span> <span class="n">foo</span><span class="bp">.</span><span class="n">rec_1</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">func</span> <span class="bp">|</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">nat</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">n</span>
<span class="c1">-- 0: move 0</span>
<span class="c1">-- 1: nat_cases 4</span>
<span class="o">(</span> <span class="c1">-- 2: scnstr #0</span>
  <span class="c1">-- 3: ret</span>
  <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
<span class="o">(</span><span class="bp">λ</span> <span class="n">m</span><span class="o">,</span>
  <span class="c1">-- 4: push 1</span>
  <span class="c1">-- 5: ginvoke foo._rec_1</span>
  <span class="k">let</span> <span class="n">IH</span> <span class="o">:=</span> <span class="n">foo</span><span class="bp">.</span><span class="n">rec_1</span> <span class="n">m</span> <span class="k">in</span>
  <span class="c1">-- 6: move 1</span>
  <span class="c1">-- 7: ginvoke bar</span>
  <span class="k">let</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">bar</span> <span class="n">n</span> <span class="n">IH</span> <span class="k">in</span>
  <span class="c1">-- 8: drop 1</span>
  <span class="c1">-- 9: ret</span>
  <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span>
</code></pre></div>



<a name="202218885"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218885" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218885">(Jun 28 2020 at 04:16)</a>:</h4>
<p>The thing that is weird is that there doesn't seem to be any indication of the second lambda; <code>foo.rec_1</code> is supposed to be producing a function, not a natural number, and I've fudged it in the gloss by adding <code>λ _,</code> in two places</p>



<a name="202218934"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202218934" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202218934">(Jun 28 2020 at 04:18)</a>:</h4>
<p>an even simpler version:</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">bar</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">IH</span> <span class="o">:</span> <span class="n">unit</span> <span class="bp">→</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">IH</span> <span class="o">()</span> <span class="bp">+</span> <span class="mi">1</span>
<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">compiler</span><span class="bp">.</span><span class="n">optimize_bytecode</span> <span class="n">true</span>
<span class="n">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">unit</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">IH</span> <span class="bp">_</span><span class="o">,</span> <span class="n">bar</span> <span class="n">n</span> <span class="n">IH</span><span class="o">)</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">foo</span> <span class="mi">3</span> <span class="o">()</span> <span class="c1">-- vm check failed: cidx(closure) == 0 (possibly due to incorrect axioms, or sorry</span>
</code></pre></div>


<p>The <code>+1</code> only matters, by the way, in order to cause the crash by doing something that requires the result to be a nat</p>



<a name="202219019"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202219019" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202219019">(Jun 28 2020 at 04:20)</a>:</h4>
<p>It also fails at <code>@foo 2 ()</code> now for what it's worth</p>



<a name="202219210"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202219210" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202219210">(Jun 28 2020 at 04:27)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">bar</span> <span class="o">(</span><span class="n">IH</span> <span class="o">:</span> <span class="n">unit</span> <span class="bp">→</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">IH</span> <span class="o">()</span> <span class="bp">+</span> <span class="mi">0</span>
<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">compiler</span><span class="bp">.</span><span class="n">optimize_bytecode</span> <span class="n">true</span>
<span class="n">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">unit</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">IH</span> <span class="bp">_</span><span class="o">,</span> <span class="n">bar</span> <span class="n">IH</span><span class="o">)</span>
<span class="n">meta</span> <span class="n">def</span> <span class="n">foo&#39;</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">unit</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="bp">|</span> <span class="n">n</span> <span class="bp">_</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">n</span> <span class="mi">1</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span><span class="o">,</span> <span class="n">bar</span> <span class="o">(</span><span class="n">foo&#39;</span> <span class="n">n</span><span class="o">))</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">foo</span> <span class="mi">1</span> <span class="o">()</span> <span class="c1">-- vm check failed: cidx(closure) == 0 (possibly due to incorrect axioms, or sorry</span>
<span class="bp">#</span><span class="kn">eval</span> <span class="bp">@</span><span class="n">foo&#39;</span> <span class="mi">1</span> <span class="o">()</span> <span class="c1">-- 1</span>
</code></pre></div>


<p>I think this gets to the heart of it. The meta def is very close to the final compiled form, but you will notice that the recursive function after compilation has 2 arguments instead of 1 and is called using <code>closure</code> instead of <code>ginvoke</code></p>



<a name="202219254"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202219254" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202219254">(Jun 28 2020 at 04:28)</a>:</h4>
<p>The compiler has some logic in it to eliminate curried functions and remove erased arguments, and I think the bug is there</p>



<a name="202219660"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202219660" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202219660">(Jun 28 2020 at 04:43)</a>:</h4>
<p>Do you think it comes from this function? <a href="https://github.com/leanprover-community/lean/blob/7b2f3fa452e4bdb38c5d96e64d29205c5986a1a8/src/library/compiler/elim_recursors.cpp#L97-L99">https://github.com/leanprover-community/lean/blob/7b2f3fa452e4bdb38c5d96e64d29205c5986a1a8/src/library/compiler/elim_recursors.cpp#L97-L99</a></p>



<a name="202219702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202219702" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202219702">(Jun 28 2020 at 04:44)</a>:</h4>
<p>Line 119 makes it look like this deals with the <code>ginvoke</code>/<code>closure</code> distinction you mentioned</p>



<a name="202220166"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220166" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220166">(Jun 28 2020 at 05:02)</a>:</h4>
<p>I think it's happening in an optimization pass. The original expression <code>nat.rec_on n (λ _, 1) (λ n IH _, bar IH)</code> is translated to <code>nat.cases_on n (λ _, 1) (λ n _, bar (self n))</code> and then it notices that we have a cases followed by a lambda and lifts one over the other to get <code>λ _, nat.cases_on n (1) (λ n, bar (self n))</code>, whereupon we can deduce that the ignored argument can be eliminated. But eliminating this argument changes the type of <code>self n</code>, so <code>bar</code> ends up getting passed a value of type <code>nat</code> instead of <code>unit -&gt; nat</code></p>



<a name="202220179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220179">(Jun 28 2020 at 05:03)</a>:</h4>
<p>The reason it works with <code>0</code> in place of <code>1</code> in the base case is that <code>0</code> plays many roles in the VM; it is the neutral value meaning that all proofs become <code>0</code>, and in particular application <code>0 x</code> is defined and equals <code>0</code></p>



<a name="202220182"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220182" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220182">(Jun 28 2020 at 05:03)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">bar</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">IH</span> <span class="o">:</span> <span class="n">unit</span> <span class="bp">→</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">IH</span> <span class="o">()</span> <span class="bp">+</span> <span class="mi">1</span>
<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">compiler</span><span class="bp">.</span><span class="n">elim_recursors</span> <span class="n">true</span>
<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">compiler</span><span class="bp">.</span><span class="n">reduce_arity</span> <span class="n">true</span>
<span class="n">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">unit</span> <span class="bp">→</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">n</span> <span class="n">IH</span> <span class="bp">_</span><span class="o">,</span> <span class="n">bar</span> <span class="n">n</span> <span class="n">IH</span><span class="o">)</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">compiler</span><span class="bp">.</span><span class="n">elim_recursors</span><span class="o">]</span>
<span class="bp">&gt;&gt;</span> <span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span>
<span class="bp">λ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">unit</span><span class="o">),</span> <span class="n">n</span><span class="bp">.</span><span class="n">cases_on</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="bp">_</span><span class="n">x</span> <span class="o">:</span> <span class="n">unit</span><span class="o">),</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="bp">_</span><span class="n">x</span> <span class="o">:</span> <span class="n">unit</span><span class="o">),</span> <span class="n">bar</span> <span class="n">n</span> <span class="o">([</span><span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span><span class="o">]</span> <span class="n">n</span><span class="o">))</span> <span class="n">a</span>
<span class="bp">&gt;&gt;</span> <span class="n">foo</span>
<span class="bp">λ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">unit</span><span class="o">),</span> <span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span> <span class="n">n</span> <span class="n">a</span>
<span class="o">[</span><span class="n">compiler</span><span class="bp">.</span><span class="n">reduce_arity</span><span class="o">]</span>
<span class="bp">&gt;&gt;</span> <span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span>
<span class="bp">λ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">nat</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">n</span> <span class="mi">0</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">bar</span> <span class="n">n</span> <span class="o">(</span><span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span> <span class="n">n</span><span class="o">))</span>
<span class="bp">&gt;&gt;</span> <span class="n">foo</span>
<span class="bp">λ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">unit</span><span class="o">),</span> <span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span> <span class="n">n</span>
</code></pre></div>



<a name="202220221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220221" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220221">(Jun 28 2020 at 05:04)</a>:</h4>
<p>aha, as I suspected</p>



<a name="202220223"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220223" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220223">(Jun 28 2020 at 05:04)</a>:</h4>
<p>Like you said, after the <code>reduce_arity</code> pass it's not type-correct on <code>bar</code>'s argument</p>



<a name="202220288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220288">(Jun 28 2020 at 05:07)</a>:</h4>
<p>My mistake, it's the <code>erase_irrelevant</code> pass</p>



<a name="202220292"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220292" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220292">(Jun 28 2020 at 05:07)</a>:</h4>
<p>Those traces are actually next to each other so there's no more doubt:</p>
<div class="codehilite"><pre><span></span><code>        <span class="n">lean_trace</span><span class="p">(</span><span class="n">name</span><span class="p">({</span><span class="s">&quot;compiler&quot;</span><span class="p">,</span> <span class="s">&quot;elim_recursors&quot;</span><span class="p">}),</span> <span class="n">tout</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span> <span class="n">display</span><span class="p">(</span><span class="n">procs</span><span class="p">););</span>
        <span class="n">erase_irrelevant</span><span class="p">(</span><span class="n">procs</span><span class="p">);</span>
        <span class="n">lean_trace</span><span class="p">(</span><span class="n">name</span><span class="p">({</span><span class="s">&quot;compiler&quot;</span><span class="p">,</span> <span class="s">&quot;erase_irrelevant&quot;</span><span class="p">}),</span> <span class="n">tout</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span> <span class="n">display</span><span class="p">(</span><span class="n">procs</span><span class="p">););</span>
</code></pre></div>



<a name="202220387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220387" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220387">(Jun 28 2020 at 05:10)</a>:</h4>
<p>The <code>erase_irrelevant</code> pass still looks okay though</p>



<a name="202220388"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220388" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220388">(Jun 28 2020 at 05:10)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">compiler</span><span class="bp">.</span><span class="n">erase_irrelevant</span><span class="o">]</span>
<span class="bp">&gt;&gt;</span> <span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span>
<span class="bp">λ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">unit</span><span class="o">),</span> <span class="n">nat</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">n</span> <span class="mi">0</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">bar</span> <span class="o">(</span><span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span> <span class="n">n</span><span class="o">))</span>
<span class="bp">&gt;&gt;</span> <span class="n">foo</span>
<span class="bp">λ</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">unit</span><span class="o">),</span> <span class="n">foo</span><span class="bp">._</span><span class="n">rec_1</span> <span class="n">n</span> <span class="n">a</span>
</code></pre></div>



<a name="202220394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220394" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220394">(Jun 28 2020 at 05:11)</a>:</h4>
<p>It has done the lambda-over-cases transformation, which is not itself harmful</p>



<a name="202220398"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220398" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220398">(Jun 28 2020 at 05:11)</a>:</h4>
<p>notice that <code>foo._rec_1</code> is still accepting two arguments and passes a partially applied version of itself to <code>bar</code></p>



<a name="202220436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Olson <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220436">(Jun 28 2020 at 05:12)</a>:</h4>
<p>Ah! I didn't read carefully enough</p>



<a name="202220495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220495">(Jun 28 2020 at 05:15)</a>:</h4>
<p><a href="https://github.com/leanprover-community/lean/blob/7b2f3fa452e4bdb38c5d96e64d29205c5986a1a8/src/library/compiler/reduce_arity.cpp#L48-L53">https://github.com/leanprover-community/lean/blob/7b2f3fa452e4bdb38c5d96e64d29205c5986a1a8/src/library/compiler/reduce_arity.cpp#L48-L53</a></p>



<a name="202220501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220501">(Jun 28 2020 at 05:15)</a>:</h4>
<p>I think this is where the action is</p>



<a name="202220503"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/vm%20check%20failed/near/202220503" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/vm.20check.20failed.html#202220503">(Jun 28 2020 at 05:16)</a>:</h4>
<p>In particular it says "we try to eta expand applications" which is the right idea but isn't being implemented right here?</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>