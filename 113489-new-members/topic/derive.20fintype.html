---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/derive.20fintype.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html">derive fintype</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="214494140"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214494140" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214494140">(Oct 25 2020 at 15:08)</a>:</h4>
<p>I am trying to prove that a dependent type ("move") is finite, and found <code>derive fintype</code>. When I try to use it, I get <code>cases tactic failed, unexpected failure when introducing auxiliary equalities</code> -- I assume this is because just adding it to my structure is trying to prove <code>fintype move</code>, which is indeed not true, I want it to derive <code>fintype (move b)</code> for a fixed thing.</p>
<p>Is there something else I can do to still use that helper or should I give up on <code>derive fintype</code> and  prove finiteness without it (something I'm not having much success doing either but at least I know what the proof should look like.)</p>



<a name="214494198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214494198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214494198">(Oct 25 2020 at 15:09)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[derive fintype, nolint has_inhabited_instance]</span>
<span class="kd">structure</span> <span class="n">move</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">start_square</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
<span class="o">(</span><span class="n">end_square</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
<span class="o">(</span><span class="n">occupied_start</span> <span class="o">:</span> <span class="n">b.contents.occupied_at</span> <span class="n">start_square</span> <span class="bp">.</span> <span class="n">tactic.exact_dec_trivial</span><span class="o">)</span>
<span class="o">(</span><span class="n">unoccupied_end</span> <span class="o">:</span> <span class="bp">¬</span> <span class="n">b.contents.occupied_at</span> <span class="n">end_square</span> <span class="bp">.</span> <span class="n">tactic.exact_dec_trivial</span><span class="o">)</span>
</code></pre></div>

<p>is what the type looks like, though it's taking me a bit to make that a <a href="https://leanprover-community.github.io/mwe.html">#mwe</a></p>



<a name="214495386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214495386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214495386">(Oct 25 2020 at 15:33)</a>:</h4>
<p>OK trying to use <code>refine derive_fintype.mk_fintype _ _ _,</code> isn't getting me much further so probably I've done something else wrong I guess. Never mind the above will try to put something self contained together if I can't figure it out.</p>



<a name="214498165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214498165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214498165">(Oct 25 2020 at 16:32)</a>:</h4>
<p>It might be easier to guess what's going on with at least the declarations of what appear to be variables <code>m</code>, <code>n</code>, <code>b</code></p>



<a name="214499290"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214499290" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214499290">(Oct 25 2020 at 16:53)</a>:</h4>
<p>Yeah apologies... <code>m</code> and <code>n</code> are</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">variables</span> <span class="o">{</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span>
<span class="kd">variables</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">m</span><span class="o">]</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">n</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">m</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">n</span><span class="o">]</span>
</code></pre></div>

<p><code>b</code> is another struct... a <code> board m n ι K</code> which is what's making it hard to reproduce on a smaller example. When I try with some other contrived derived type I seem to be able to make <code>derive fintype</code> work regardless.</p>
<p>The full (non-working) patch is <a href="https://github.com/Julian/lean-across-the-board/commit/e7c7531b1288e72d9e96b54373fa3d2008f5f52e#diff-8ddc75490aa5cdbfa06071ac71ab81708c32207a98cd5688fa4dcc74781b9cefR74-R76">https://github.com/Julian/lean-across-the-board/commit/e7c7531b1288e72d9e96b54373fa3d2008f5f52e#diff-8ddc75490aa5cdbfa06071ac71ab81708c32207a98cd5688fa4dcc74781b9cefR74-R76</a></p>
<p>which I just took a break from again to recharge, but if anything looks obviously wrong there lemme know. Otherwise going to take another crack at it later.</p>



<a name="214499402"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214499402" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214499402">(Oct 25 2020 at 16:55)</a>:</h4>
<p>The documentation for fintype deriving says that it will assume <code>fintype</code> instances on any type variables of the structure, so that seems okay. Does it work if you delete the last two fields of <code>move</code>?</p>



<a name="214499412"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214499412" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214499412">(Oct 25 2020 at 16:55)</a>:</h4>
<p>Yes</p>



<a name="214499546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214499546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214499546">(Oct 25 2020 at 16:57)</a>:</h4>
<p>how about if you remove the <code>. tactic</code> stuff?</p>



<a name="214499598"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214499598" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214499598">(Oct 25 2020 at 16:58)</a>:</h4>
<p>I assume those fields are <code>Prop</code>s?</p>



<a name="214499623"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214499623" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214499623">(Oct 25 2020 at 16:58)</a>:</h4>
<p>It also works on e.g.:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">data.fintype.basic</span>
<span class="kn">import</span> <span class="n">tactic.derive_fintype</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span>
<span class="kd">variables</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">m</span><span class="o">]</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">n</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">m</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">n</span><span class="o">]</span>

<span class="kd">structure</span> <span class="n">bar</span>
<span class="o">(</span><span class="n">z</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span>

<span class="kd">variable</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">bar</span> <span class="mi">7</span><span class="o">)</span>

<span class="kd">@[derive fintype]</span>
<span class="kd">structure</span> <span class="n">foo</span>
<span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
<span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
<span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">.</span> <span class="n">tactic.exact_dec_trivial</span><span class="o">)</span>
</code></pre></div>

<p>which was my attempt to extract</p>



<a name="214499669"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214499669" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214499669">(Oct 25 2020 at 16:59)</a>:</h4>
<p>I see. Sometimes it's easier to put everything needed in a new file and then start whittling away at it until it no longer breaks, rather than trying to build up from scratch while guessing the key features</p>



<a name="214499733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214499733" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214499733">(Oct 25 2020 at 17:00)</a>:</h4>
<p><em>nod</em> yeah will try doing that</p>



<a name="214499812"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214499812" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214499812">(Oct 25 2020 at 17:01)</a>:</h4>
<p>But anyways it seems like your original usage is within the scope of what the derive handler is currently supposed to do</p>



<a name="214499999"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214499999" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214499999">(Oct 25 2020 at 17:04)</a>:</h4>
<p>OK that's good, glad to have the sanity check, appreciated.</p>



<a name="214500228"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500228" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500228">(Oct 25 2020 at 17:09)</a>:</h4>
<p>It doesn't handle this</p>



<a name="214500238"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500238" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500238">(Oct 25 2020 at 17:09)</a>:</h4>
<p>I didn't implement anything for propositional fields</p>



<a name="214500333"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500333" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500333">(Oct 25 2020 at 17:11)</a>:</h4>
<p>these are problematic because they don't have fintype instances</p>



<a name="214500342"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500342" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500342">(Oct 25 2020 at 17:11)</a>:</h4>
<p>because <code>fintype p</code> for <code>p : Prop</code> is already not well typed</p>



<a name="214500413"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500413" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500413">(Oct 25 2020 at 17:13)</a>:</h4>
<p>actually, looking at the code again, it seems that we only need a fintype instance on the iterated <code>Sigma'</code> type</p>



<a name="214500418"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500418" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500418">(Oct 25 2020 at 17:13)</a>:</h4>
<p>if you'll allow me to say something naive just to check my understanding...</p>



<a name="214500423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500423">(Oct 25 2020 at 17:13)</a>:</h4>
<p>terms of <code>p</code> are proofs right?</p>



<a name="214500432"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500432" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500432">(Oct 25 2020 at 17:13)</a>:</h4>
<p>and there's proof equivalence that I've seen referenced before?</p>



<a name="214500437"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500437" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500437">(Oct 25 2020 at 17:13)</a>:</h4>
<p><code>p</code> is a proposition, its elements are proofs</p>



<a name="214500449"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500449" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500449">(Oct 25 2020 at 17:13)</a>:</h4>
<p>it's obviously a fintype in the mathematical sense, there is only zero or one element</p>



<a name="214500456"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500456" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500456">(Oct 25 2020 at 17:13)</a>:</h4>
<p>so even if they're infinite, one could regard them as finite</p>



<a name="214500462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500462" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500462">(Oct 25 2020 at 17:14)</a>:</h4>
<p>right ok cool</p>



<a name="214500510"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500510" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500510">(Oct 25 2020 at 17:14)</a>:</h4>
<p>but <code>fintype : Type u -&gt; Type u</code> so <code>p</code> doesn't fit in there</p>



<a name="214500523"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500523" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500523">(Oct 25 2020 at 17:14)</a>:</h4>
<p>you could put <code>plift p</code> in instead</p>



<a name="214500551"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500551" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500551">(Oct 25 2020 at 17:15)</a>:</h4>
<p>clearly <code>fin_enum</code> is superior <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="214500666"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500666" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500666">(Oct 25 2020 at 17:17)</a>:</h4>
<p>This should probably be addressed in <code>fintype</code> but it's a question of where to draw the line, as you might argue that <code>finset</code> or <code>multiset</code> or <code>list</code> should accept <code>Sort u</code> as well</p>



<a name="214500690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500690">(Oct 25 2020 at 17:17)</a>:</h4>
<p>However, given that the proof method relies on inferring instances for <code>Sigma'</code> it might be possible to fix this with a few extra instances</p>



<a name="214500770"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500770" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500770">(Oct 25 2020 at 17:19)</a>:</h4>
<p>Specifically, <code>Sigma' h : p, a h</code> is a fintype if <code>a h</code> is, and <code>Sigma' x : A, p x</code> is a fintype if <code>A</code> is, where <code>p</code> is a prop</p>



<a name="214500780"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500780" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500780">(Oct 25 2020 at 17:19)</a>:</h4>
<p><span class="user-mention" data-user-id="321696">@Julian Berman</span> Didn't you say that your <code>foo</code> example worked though?</p>



<a name="214500852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214500852" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214500852">(Oct 25 2020 at 17:20)</a>:</h4>
<p><span class="user-mention" data-user-id="110032">@Reid Barton</span> it does yes</p>



<a name="214501148"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214501148" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214501148">(Oct 25 2020 at 17:25)</a>:</h4>
<p>I was confused about this for a bit until I realized that <code>foo</code> there has three parameters and no fields</p>



<a name="214501209"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214501209" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214501209">(Oct 25 2020 at 17:26)</a>:</h4>
<p>ah :( sorry</p>



<a name="214501212"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214501212" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214501212">(Oct 25 2020 at 17:26)</a>:</h4>
<p>I noticed that about <code>bar</code> (because of <code>bar 7</code>) but missed it for <code>foo</code>!</p>



<a name="214501235"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214501235" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214501235">(Oct 25 2020 at 17:27)</a>:</h4>
<p>and if you put the <code>:=</code> in the right place you get the expected error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">failed</span> <span class="n">to</span> <span class="n">synthesize</span> <span class="n">type</span> <span class="kd">class</span> <span class="kd">instance</span> <span class="n">for</span>
<span class="bp">⊢</span> <span class="n">fintype</span> <span class="o">(</span><span class="bp">Σ'</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">),</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">b</span><span class="o">)</span>
</code></pre></div>



<a name="214501262"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214501262" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214501262">(Oct 25 2020 at 17:27)</a>:</h4>
<p>that's still slightly different than the one in my real code which blows up harder and doesn't even show me a failed to synthesize type class message</p>



<a name="214503565"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214503565" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214503565">(Oct 25 2020 at 18:09)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/4777">#4777</a> adds some tweaks to make sure that this use case is supported</p>



<a name="214503619"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214503619" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214503619">(Oct 25 2020 at 18:10)</a>:</h4>
<p>but it would be good to know what error you are seeing in case it's not handled</p>



<a name="214503779"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214503779" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214503779">(Oct 25 2020 at 18:13)</a>:</h4>
<p>btw the instances on psigma for props are already there, <a href="https://leanprover-community.github.io/mathlib_docs/find/psigma.fintype_prop_left/src">src#psigma.fintype_prop_left</a></p>



<a name="214503845"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214503845" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214503845">(Oct 25 2020 at 18:14)</a>:</h4>
<p>the reason the example above isn't finding it is because the prop has to be decidable and equality on <code>bar 7</code> is not registered as decidable</p>



<a name="214508192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214508192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214508192">(Oct 25 2020 at 19:43)</a>:</h4>
<p>Oh amazing, thanks. Will give that commit a shot.</p>



<a name="214508239"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214508239" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214508239">(Oct 25 2020 at 19:44)</a>:</h4>
<p>The error I get at the minute is really the above -- <code>cases tactic failed, unexpected failure when introducing auxiliary equalities</code> with no further detail</p>



<a name="214508283"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214508283" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214508283">(Oct 25 2020 at 19:45)</a>:</h4>
<p>I don't know what sigma' and psigma are yet to understand the other thing you told me :), but will see if I can follow after staring a bit</p>



<a name="214508448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214508448" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214508448">(Oct 25 2020 at 19:48)</a>:</h4>
<p>Actually I guess I can show you the error by pushing and letting CI fail, so can do that...</p>



<a name="214508518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214508518" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214508518">(Oct 25 2020 at 19:50)</a>:</h4>
<p>Yeah, that bug is fixed in <a href="https://github.com/leanprover-community/mathlib/issues/4777">#4777</a></p>



<a name="214508547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214508547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214508547">(Oct 25 2020 at 19:51)</a>:</h4>
<p>ah awesome, ok gonna try it now thanks.</p>



<a name="214508805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214508805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214508805">(Oct 25 2020 at 19:56)</a>:</h4>
<p>OK that indeed now gives me a clearer error, now I get:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">lean</span><span class="o">]</span> <span class="o">[</span><span class="n">E</span><span class="o">]</span> <span class="n">exact</span> <span class="n">tactic</span> <span class="n">failed</span><span class="o">,</span> <span class="n">type</span> <span class="n">mismatch</span><span class="o">,</span> <span class="n">given</span> <span class="n">expression</span> <span class="n">has</span> <span class="n">type</span>
  <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="bp">Σ'</span> <span class="o">(</span><span class="n">end_square</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
    <span class="o">(</span><span class="n">occupied_start</span> <span class="o">:</span>
      <span class="n">auto_param</span> <span class="o">(</span><span class="n">b.contents.occupied_at</span> <span class="bp">?</span><span class="n">m_1</span><span class="o">)</span>
        <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"exact_dec_trivial"</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"tactic"</span> <span class="n">name.anonymous</span><span class="o">)))</span>
    <span class="o">(</span><span class="n">unoccupied_end</span> <span class="o">:</span>
      <span class="n">auto_param</span> <span class="o">(</span><span class="bp">¬</span><span class="n">b.contents.occupied_at</span> <span class="n">end_square</span><span class="o">)</span>
        <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"exact_dec_trivial"</span> <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"tactic"</span> <span class="n">name.anonymous</span><span class="o">))),</span>
    <span class="n">unit</span>
</code></pre></div>



<a name="214508827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214508827" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214508827">(Oct 25 2020 at 19:56)</a>:</h4>
<p>(where I guess it figured out one field?)</p>



<a name="214509144"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214509144" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214509144">(Oct 25 2020 at 20:03)</a>:</h4>
<p>oh no that's a bug</p>



<a name="214509155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214509155" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214509155">(Oct 25 2020 at 20:03)</a>:</h4>
<p>could you make a <a href="https://leanprover-community.github.io/mwe.html">#mwe</a>?</p>



<a name="214509243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214509243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214509243">(Oct 25 2020 at 20:05)</a>:</h4>
<p>Trying to.</p>



<a name="214509912"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214509912" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214509912">(Oct 25 2020 at 20:19)</a>:</h4>
<p>OK I think this is reasonably minimal hopefully:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.derive_fintype</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">m</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">m</span><span class="o">]</span>
<span class="kd">structure</span> <span class="n">board</span> <span class="o">:=</span> <span class="o">(</span><span class="n">contents</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">m</span> <span class="bp">→</span> <span class="n">m</span><span class="o">)</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">board</span> <span class="n">m</span><span class="o">)</span>

<span class="kd">@[derive fintype]</span>
<span class="kd">structure</span> <span class="n">move</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">start_square</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">m</span><span class="o">)</span>
<span class="o">(</span><span class="n">occupied_start</span> <span class="o">:</span> <span class="n">b.contents</span> <span class="n">start_square</span> <span class="bp">=</span> <span class="n">b.contents</span> <span class="n">start_square</span><span class="o">)</span>
</code></pre></div>



<a name="214510633"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214510633" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214510633">(Oct 25 2020 at 20:34)</a>:</h4>
<p>ok, fixed in <a href="https://github.com/leanprover-community/mathlib/issues/4777">#4777</a></p>



<a name="214511153"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214511153" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214511153">(Oct 25 2020 at 20:44)</a>:</h4>
<p>Works, thank you!</p>



<a name="214526503"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214526503" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214526503">(Oct 26 2020 at 02:27)</a>:</h4>
<p>Found another bug here if you're not tired of me already. I think minimal repro is:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.derive_fintype</span>

<span class="kd">@[derive fintype]</span>
<span class="kd">structure</span> <span class="n">foo4</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">→</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
<span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
<span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">b</span> <span class="n">x.1</span> <span class="bp">=</span> <span class="n">b</span> <span class="n">y.1</span><span class="o">)</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span>
<span class="kd">variable</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">→</span> <span class="n">ℕ</span><span class="o">)</span>

<span class="kd">@[derive fintype]</span>
<span class="kd">structure</span> <span class="n">foo5</span> <span class="kd">extends</span> <span class="o">(</span><span class="n">foo4</span> <span class="n">m</span> <span class="n">n</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">to_foo4</span> <span class="bp">=</span> <span class="n">to_foo4</span><span class="o">)</span>
</code></pre></div>



<a name="214526511"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214526511" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214526511">(Oct 26 2020 at 02:27)</a>:</h4>
<p>(Seems it doesn't like the <code>to_foo4</code> in particular.)</p>



<a name="214534277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214534277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214534277">(Oct 26 2020 at 05:20)</a>:</h4>
<p><span class="user-mention" data-user-id="321696">@Julian Berman</span> This one is not a bug. The <code>fintype</code> deriver assumes that the fintype instance has the form (<code>fintype</code> on all type args -&gt; <code>fintype</code> on inductive), but for propositions you need <code>decidable_eq</code>, and even if you <code>derive decidable_eq</code> on <code>foo4</code> it still will have to assume that <code>m</code> and <code>n</code> have <code>decidable_eq</code>, which is not implied by <code>fintype</code>. So you have to state the correct assumptions manually, although you can still use the tactic to prove it:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[derive [fintype, decidable_eq]</span><span class="o">]</span>
<span class="kd">structure</span> <span class="n">foo4</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">→</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
<span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
<span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">b</span> <span class="n">x.1</span> <span class="bp">=</span> <span class="n">b</span> <span class="n">y.1</span><span class="o">)</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">m</span><span class="o">]</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">n</span><span class="o">]</span>
<span class="kd">variable</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">→</span> <span class="n">ℕ</span><span class="o">)</span>

<span class="kd">structure</span> <span class="n">foo5</span> <span class="kd">extends</span> <span class="o">(</span><span class="n">foo4</span> <span class="n">m</span> <span class="n">n</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">to_foo4</span> <span class="bp">=</span> <span class="n">to_foo4</span><span class="o">)</span>

<span class="kd">instance</span> <span class="n">foo5.fintype</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">m</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">fintype</span> <span class="o">(</span><span class="n">foo5</span> <span class="n">m</span> <span class="n">n</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">tactic.mk_fintype_instance</span>
</code></pre></div>



<a name="214566405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214566405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214566405">(Oct 26 2020 at 12:29)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span>  Apologies I think I slightly oversimplified the example, just to be sure, it's this one (which even with that manual declaration produces the error I see in my real code, shown at the bottom here): </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.derive_fintype</span>

<span class="kd">variables</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">m</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">m</span><span class="o">]</span>
<span class="kd">variables</span> <span class="o">[</span><span class="n">fintype</span> <span class="n">n</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">n</span><span class="o">]</span>

<span class="kd">structure</span> <span class="n">board</span> <span class="o">:=</span> <span class="o">(</span><span class="n">contents</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">m</span><span class="o">)</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">m</span> <span class="n">n</span><span class="o">}</span>
<span class="kd">variables</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">board</span> <span class="n">m</span> <span class="n">n</span><span class="o">)</span>

<span class="kd">@[derive [fintype, decidable_eq]</span><span class="o">]</span>
<span class="kd">structure</span> <span class="n">foo4</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
<span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">m</span> <span class="bp">×</span> <span class="n">n</span><span class="o">)</span>
<span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">b.contents</span> <span class="bp">=</span> <span class="n">b.contents</span><span class="o">)</span>

<span class="kd">structure</span> <span class="n">foo5</span> <span class="kd">extends</span> <span class="n">foo4</span> <span class="n">b</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">to_foo4</span> <span class="bp">=</span> <span class="n">to_foo4</span><span class="o">)</span>

<span class="kd">instance</span> <span class="n">foo5.fintype</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">m</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">fintype</span> <span class="o">(</span><span class="n">foo5</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">tactic.mk_fintype_instance</span>
</code></pre></div>

<p>produces:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">lean</span><span class="o">]</span> <span class="o">[</span><span class="n">E</span><span class="o">]</span> <span class="n">synthesized</span> <span class="n">type</span> <span class="kd">class</span> <span class="kd">instance</span> <span class="n">is</span> <span class="n">not</span> <span class="n">definitionally</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">expression</span> <span class="n">inferred</span> <span class="kd">by</span> <span class="n">typing</span> <span class="n">rules</span><span class="o">,</span> <span class="n">synthesized</span>
  <span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">n</span><span class="o">),</span> <span class="n">_inst_6</span> <span class="n">a</span> <span class="n">b</span>
<span class="n">inferred</span>
  <span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">n</span><span class="o">),</span> <span class="n">_inst_4</span> <span class="n">a</span> <span class="n">b</span>
<span class="bp">——————————————————————————————————————————————————————————————————————————————</span>
<span class="o">[</span><span class="n">lean</span><span class="o">]</span> <span class="o">[</span><span class="n">E</span><span class="o">]</span> <span class="n">synthesized</span> <span class="n">type</span> <span class="kd">class</span> <span class="kd">instance</span> <span class="n">is</span> <span class="n">not</span> <span class="n">definitionally</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">expression</span> <span class="n">inferred</span> <span class="kd">by</span> <span class="n">typing</span> <span class="n">rules</span><span class="o">,</span> <span class="n">synthesized</span>
  <span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">n</span><span class="o">),</span> <span class="n">_inst_6</span> <span class="n">a</span> <span class="n">b</span>
<span class="n">inferred</span>
  <span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">n</span><span class="o">),</span> <span class="n">_inst_4</span> <span class="n">a</span> <span class="n">b</span>
</code></pre></div>



<a name="214566426"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214566426" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214566426">(Oct 26 2020 at 12:29)</a>:</h4>
<p>Let me see if I understand enough about what you explained to see whether that's still my fault.</p>



<a name="214567134"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214567134" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214567134">(Oct 26 2020 at 12:36)</a>:</h4>
<p>OK I <em>think</em> if I follow what you told me this morning that that's now "fixed" about this example?</p>



<a name="214567302"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214567302" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214567302">(Oct 26 2020 at 12:38)</a>:</h4>
<p>And now that error message is saying what... <code>derive_fintype</code> figured out how to make a <code>fintype</code> instance, but the one it made isn't equal enough to the one <code>fintype</code> wants? <del>Is that saying I need <code>foo5</code> to be <code>decidable_eq</code> too.. let's see.</del></p>



<a name="214571593"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214571593" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214571593">(Oct 26 2020 at 13:19)</a>:</h4>
<p>You now have two decidable_eq assumptions, since you've got it in the variables</p>



<a name="214575544"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214575544" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214575544">(Oct 26 2020 at 13:52)</a>:</h4>
<p>you can actually use</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">instance</span> <span class="n">foo5.fintype</span> <span class="o">:</span> <span class="n">fintype</span> <span class="o">(</span><span class="n">foo5</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">tactic.mk_fintype_instance</span>
</code></pre></div>

<p>or go back to the simple form</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[derive fintype]</span>
<span class="kd">structure</span> <span class="n">foo5</span> <span class="kd">extends</span> <span class="n">foo4</span> <span class="n">b</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">to_foo4</span> <span class="bp">=</span> <span class="n">to_foo4</span><span class="o">)</span>
</code></pre></div>

<p>with this version</p>



<a name="214576448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214576448" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214576448">(Oct 26 2020 at 13:59)</a>:</h4>
<p>Ahh ok I think I follow.</p>



<a name="214577740"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214577740" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214577740">(Oct 26 2020 at 14:09)</a>:</h4>
<p>Yeah that indeed works perfectly again, I guess I didn't realize having <code>[decidable_eq m]</code> twice wasn't "idempotent", probably my understanding of precisely what that does is still too hazy, sorry for the noise, and thanks again.</p>



<a name="214578490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578490">(Oct 26 2020 at 14:14)</a>:</h4>
<p>It's just like having two <code>has_zero A</code> instances</p>



<a name="214578507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578507" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578507">(Oct 26 2020 at 14:15)</a>:</h4>
<p>the two zeros aren't necessarily the same</p>



<a name="214578592"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578592" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578592">(Oct 26 2020 at 14:15)</a>:</h4>
<p>In this case, the two decidable instances are equal, because <code>decidable</code> is a subsingleton, but they aren't definitionally equal and the tactic is picking the wrong one up from typeclass inference</p>



<a name="214578594"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578594" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578594">(Oct 26 2020 at 14:15)</a>:</h4>
<p>ahh ok that I think is my misunderstanding -- I thought <code>[decidable_eq m]</code> means "make sure m is a type for which instances have decidable equality"</p>



<a name="214578626"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578626" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578626">(Oct 26 2020 at 14:16)</a>:</h4>
<p>it means literally get me an instance of that type?</p>



<a name="214578681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578681" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578681">(Oct 26 2020 at 14:16)</a>:</h4>
<p>(one with that property)</p>



<a name="214578688"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578688" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578688">(Oct 26 2020 at 14:16)</a>:</h4>
<p>er, term, sorry</p>



<a name="214578713"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578713" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578713">(Oct 26 2020 at 14:16)</a>:</h4>
<p>yes, it's literally an extra argument to the instance</p>



<a name="214578737"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578737" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578737">(Oct 26 2020 at 14:16)</a>:</h4>
<p>got it</p>



<a name="214578743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578743">(Oct 26 2020 at 14:16)</a>:</h4>
<p>You can <code>#print foo5.fintype</code> to see all the instance arguments that are going into it</p>



<a name="214578765"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578765" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578765">(Oct 26 2020 at 14:17)</a>:</h4>
<p>you should try to avoid having duplicate instance arguments</p>



<a name="214578854"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578854" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578854">(Oct 26 2020 at 14:17)</a>:</h4>
<p>what do you do in your case? where you want 2 <code>has_zero</code>s?</p>



<a name="214578946"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214578946" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214578946">(Oct 26 2020 at 14:18)</a>:</h4>
<p>why would you ever want that? That's just asking for trouble to notate two distinct elements with the same notation</p>



<a name="214579029"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214579029" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214579029">(Oct 26 2020 at 14:19)</a>:</h4>
<p>ok good</p>



<a name="214579065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/derive%20fintype/near/214579065" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/derive.20fintype.html#214579065">(Oct 26 2020 at 14:19)</a>:</h4>
<p>thanks that makes a lot more sense now</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>