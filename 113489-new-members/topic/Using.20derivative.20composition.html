---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/Using.20derivative.20composition.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html">Using derivative composition</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="320750157"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320750157" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Icaro Costa <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320750157">(Jan 11 2023 at 16:56)</a>:</h4>
<p>Code:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">analysis.calculus.deriv</span>
<span class="kn">import</span> <span class="n">data.real.basic</span>
<span class="kn">import</span> <span class="n">data.list.basic</span>
<span class="kn">import</span> <span class="n">tactic</span>
<span class="kn">import</span> <span class="n">algebra.big_operators.basic</span>
<span class="kn">import</span> <span class="n">data.nat.interval</span>

<span class="kn">import</span> <span class="n">algebra.group.defs</span>

<span class="n">open_locale</span> <span class="n">big_operators</span>

<span class="kn">open</span> <span class="n">finset</span>

<span class="c">/-</span><span class="cm">Function definitions-/</span>
<span class="kd">variable</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span>
<span class="kd">variable</span> <span class="o">(</span><span class="n">u</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span>


<span class="c">/-</span><span class="cm">Derivative-/</span>
<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">D</span> <span class="o">:</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span>
  <span class="bp">|</span> <span class="n">a</span> <span class="o">:=</span> <span class="n">deriv</span> <span class="n">a</span>

<span class="c">/-</span><span class="cm">Higher order derivatives-/</span>
<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">Dn</span> <span class="o">:</span> <span class="o">(</span><span class="n">ℕ</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span>
  <span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="n">id</span> <span class="bp">∘</span> <span class="n">f</span>
  <span class="bp">|</span> <span class="mi">1</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="n">D</span> <span class="n">f</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">a</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="n">Dn</span> <span class="n">a</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span>

<span class="c">/-</span><span class="cm">Derivative rules-/</span>
<span class="kd">def</span> <span class="n">product_rule</span> <span class="o">:=</span> <span class="n">D</span> <span class="n">f</span><span class="bp">*</span><span class="n">u</span> <span class="bp">=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span><span class="bp">*</span><span class="n">u</span> <span class="bp">+</span> <span class="n">f</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">composite_deriv</span> <span class="o">:=</span> <span class="n">D</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span> <span class="bp">∘</span> <span class="n">u</span> <span class="bp">+</span> <span class="n">f</span> <span class="bp">∘</span> <span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span>

<span class="c">/-</span><span class="cm">Composite function derivative-/</span>
<span class="kd">lemma</span> <span class="n">second_composite_deriv</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:</span> <span class="n">Dn</span> <span class="mi">2</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span> <span class="n">x</span> <span class="bp">=</span> <span class="o">(((</span><span class="n">D</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">))</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span><span class="bp">^</span><span class="mi">2</span> <span class="bp">+</span> <span class="o">((</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)))</span> <span class="n">x</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">unfold</span> <span class="n">Dn</span><span class="o">,</span> <span class="c">/-</span><span class="cm">Out: D (D (f ∘ u)) x = (D (D f) ∘ u * D u ^ 2 + D f ∘ u * D (D u)) x-/</span>
  <span class="n">rw</span> <span class="n">composite_deriv</span> <span class="n">f</span> <span class="n">u</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>Problem:</p>
<p>Using <code>rw composite_deriv f u</code> fails with message: "rewrite tactic failed, lemma is not an equality nor a iff". Why is it giving me this error? Isn't my lemma already an equality?</p>



<a name="320752551"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320752551" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Icaro Costa <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320752551">(Jan 11 2023 at 17:06)</a>:</h4>
<p>It also doesn't seem to work with the "obvious" case, it yields the same error message.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c">/-</span><span class="cm">Composite function with first derivative-/</span>
<span class="kd">lemma</span> <span class="n">first_composite_deriv</span> <span class="o">:</span> <span class="n">Dn</span> <span class="mi">1</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span> <span class="bp">∘</span> <span class="n">u</span> <span class="bp">+</span> <span class="n">f</span> <span class="bp">∘</span> <span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">unfold</span> <span class="n">Dn</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">composite_deriv</span> <span class="n">f</span> <span class="n">u</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="320758339"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320758339" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Icaro Costa <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320758339">(Jan 11 2023 at 17:34)</a>:</h4>
<p>It seems to be a problem with the definition of <code>Dn</code> again:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c">/-</span><span class="cm">Higher order derivatives-/</span>
<span class="kd">def</span> <span class="n">Dn</span><span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="o">((</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">))</span>
  <span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">id</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="n">D</span> <span class="bp">∘</span> <span class="n">Dn</span> <span class="n">n</span>

<span class="k">#check</span> <span class="n">Dn</span> <span class="mi">0</span>
</code></pre></div>
<p>The check returns a map <code>Dn 0 : ℕ → (ℝ → ℝ) → ℝ → ℝ</code>, but I would be expecting <code> (ℝ → ℝ) → (ℝ → ℝ)</code>, which is just <code>id</code>.</p>



<a name="320762217"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320762217" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kalle Kytölä <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320762217">(Jan 11 2023 at 17:55)</a>:</h4>
<p>It is a bit unclear what you are trying above. The <code>product_rule</code> and <code>composite_deriv</code> you have defined are statements (about a pair of real functions), not results. You can see this in Lean by, e.g., <code>#check product_rule</code>. This explains why the rewrite fails --- indeed "...lemma is not an equality nor a iff".</p>
<p>The statement <code>product_rule f u</code> would in fact be a <em>true</em> statement if one furthermore assumes differentiability of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">u</span></span></span></span>. Under that hypothesis you could therefore make it a result (prove it). The content of it would be more or less <a href="https://leanprover-community.github.io/mathlib_docs/find/deriv_mul">docs#deriv_mul</a>.</p>
<p>It is less clear under what reasonable assumptions your <code>composite_deriv</code> would be true. Did you mean something more like the chain rule, <a href="https://leanprover-community.github.io/mathlib_docs/find/deriv.comp">docs#deriv.comp</a>?</p>



<a name="320766779"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320766779" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mark Andrew Gerads <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320766779">(Jan 11 2023 at 18:19)</a>:</h4>
<p>Look at <a href="https://leanprover-community.github.io/mathlib_docs/analysis/calculus/iterated_deriv.html#iterated_deriv">https://leanprover-community.github.io/mathlib_docs/analysis/calculus/iterated_deriv.html#iterated_deriv</a><br>
You do not need to redefine what was already defined.</p>



<a name="320775853"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320775853" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Icaro Costa <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320775853">(Jan 11 2023 at 19:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="373986">Kalle Kytölä</span> <a href="#narrow/stream/113489-new-members/topic/Using.20derivative.20composition/near/320762217">said</a>:</p>
<blockquote>
<p>It is a bit unclear what you are trying above. The <code>product_rule</code> and <code>composite_deriv</code> you have defined are statements (about a pair of real functions), not results. You can see this in Lean by, e.g., <code>#check product_rule</code>. This explains why the rewrite fails --- indeed "...lemma is not an equality nor a iff".</p>
<p>The statement <code>product_rule f u</code> would in fact be a <em>true</em> statement if one furthermore assumes differentiability of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">u</span></span></span></span>. Under that hypothesis you could therefore make it a result (prove it). The content of it would be more or less <a href="https://leanprover-community.github.io/mathlib_docs/find/deriv_mul">docs#deriv_mul</a>.</p>
<p>It is less clear under what reasonable assumptions your <code>composite_deriv</code> would be true. Did you mean something more like the chain rule, <a href="https://leanprover-community.github.io/mathlib_docs/find/deriv.comp">docs#deriv.comp</a>?</p>
</blockquote>
<p>I want to use those as "substitutions" in the proof, that's why I'm calling rewrite. Am I supposed to write this instead?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c">/-</span><span class="cm">Derivative rules-/</span>
<span class="kd">def</span> <span class="n">product_rule</span> <span class="n">D</span> <span class="n">f</span><span class="bp">*</span><span class="n">u</span> <span class="o">:=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span><span class="bp">*</span><span class="n">u</span> <span class="bp">+</span> <span class="n">f</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">composite_deriv</span> <span class="n">D</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span> <span class="bp">∘</span> <span class="n">u</span> <span class="bp">+</span> <span class="n">f</span> <span class="bp">∘</span> <span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span>
</code></pre></div>



<a name="320786679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320786679" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Icaro Costa <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320786679">(Jan 11 2023 at 20:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="385848">Mark Andrew Gerads</span> <a href="#narrow/stream/113489-new-members/topic/Using.20derivative.20composition/near/320766779">said</a>:</p>
<blockquote>
<p>Look at <a href="https://leanprover-community.github.io/mathlib_docs/analysis/calculus/iterated_deriv.html#iterated_deriv">https://leanprover-community.github.io/mathlib_docs/analysis/calculus/iterated_deriv.html#iterated_deriv</a><br>
You do not need to redefine what was already defined.</p>
</blockquote>
<p>The reason I am redefining it is to learn the language by proving things that I already know.</p>



<a name="320828615"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320828615" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sky Wilshaw <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320828615">(Jan 12 2023 at 01:32)</a>:</h4>
<p>I think what you need to do is actually prove that the product rule holds.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">product_rule</span> <span class="n">D</span> <span class="n">f</span> <span class="n">u</span> <span class="o">(</span><span class="n">and</span> <span class="n">some</span> <span class="n">differentiability</span> <span class="n">hypotheses</span><span class="o">)</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">f</span> <span class="bp">*</span> <span class="n">u</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span><span class="bp">*</span><span class="n">u</span> <span class="bp">+</span> <span class="n">f</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
<span class="bp">...</span>
<span class="kd">end</span>
</code></pre></div>
<p>Your current definitions are just that: definitions. They're not proofs of any fact, so you can't use them to rewrite e.g. <code>D (f * u)</code> into <code>(D f) * u + f * (D u)</code>.</p>
<p>More precisely, when you write <code>def product_rule := D f*u = (D f)*u + f*(D u)</code>, you create a new <em>proposition</em> called <code>product_rule D f u</code> which is true when the product rule holds on <code>f </code> and <code>u</code>, and false when it doesn't hold.</p>



<a name="320828739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320828739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sky Wilshaw <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320828739">(Jan 12 2023 at 01:34)</a>:</h4>
<p>Using your original definitions, you could make a theorem like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">deriv_eq_of_product_rule</span> <span class="o">:</span> <span class="n">product_rule</span> <span class="n">D</span> <span class="n">f</span> <span class="n">u</span> <span class="bp">→</span> <span class="n">D</span> <span class="n">f</span><span class="bp">*</span><span class="n">u</span> <span class="bp">=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span><span class="bp">*</span><span class="n">u</span> <span class="bp">+</span> <span class="n">f</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">intro</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">unfold</span> <span class="n">product_rule</span> <span class="n">at</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">exact</span> <span class="n">h</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>which says that "when the product rule holds for <code>f</code> and <code>u</code>, we have <code>D f*u = (D f)*u + f*(D u)</code>.</p>



<a name="320839556"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320839556" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320839556">(Jan 12 2023 at 03:30)</a>:</h4>
<p>Note <code>D f*u</code> is exactly the same as <code>(D f)*u</code>.<br>
You can also pretend the proposition is true by writing</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">product_rule</span> <span class="o">:</span> <span class="n">D</span> <span class="n">f</span><span class="bp">*</span><span class="n">u</span> <span class="bp">=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span><span class="bp">*</span><span class="n">u</span> <span class="bp">+</span> <span class="n">f</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span> <span class="o">:=</span> <span class="gr">sorry</span>
</code></pre></div>
<p>or</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">axiom</span> <span class="n">product_rule</span> <span class="o">:</span> <span class="n">D</span> <span class="n">f</span><span class="bp">*</span><span class="n">u</span> <span class="bp">=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span><span class="bp">*</span><span class="n">u</span> <span class="bp">+</span> <span class="n">f</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span>
</code></pre></div>
<p><span class="user-mention silent" data-user-id="577757">Icaro Costa</span> <a href="#narrow/stream/113489-new-members/topic/Using.20derivative.20composition/near/320758339">said</a>:</p>
<blockquote>
<p>It seems to be a problem with the definition of <code>Dn</code> again:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#check</span> <span class="n">Dn</span> <span class="mi">0</span>
</code></pre></div>
<p>The check returns a map <code>Dn 0 : ℕ → (ℝ → ℝ) → ℝ → ℝ</code>, but I would be expecting <code> (ℝ → ℝ) → (ℝ → ℝ)</code>, which is just <code>id</code>.</p>
</blockquote>
<p>By the way, I can't reproduce this. I get <code>Dn 0 : (ℝ → ℝ) → ℝ → ℝ</code>.</p>



<a name="320930779"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320930779" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Icaro Costa <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320930779">(Jan 12 2023 at 12:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224323">Junyan Xu</span> <a href="#narrow/stream/113489-new-members/topic/Using.20derivative.20composition/near/320839556">said</a>:</p>
<blockquote>
<p>Note <code>D f*u</code> is exactly the same as <code>(D f)*u</code>.<br>
You can also pretend the proposition is true by writing</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">product_rule</span> <span class="o">:</span> <span class="n">D</span> <span class="n">f</span><span class="bp">*</span><span class="n">u</span> <span class="bp">=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span><span class="bp">*</span><span class="n">u</span> <span class="bp">+</span> <span class="n">f</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span> <span class="o">:=</span> <span class="gr">sorry</span>
</code></pre></div>
<p>or</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">axiom</span> <span class="n">product_rule</span> <span class="o">:</span> <span class="n">D</span> <span class="n">f</span><span class="bp">*</span><span class="n">u</span> <span class="bp">=</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span><span class="bp">*</span><span class="n">u</span> <span class="bp">+</span> <span class="n">f</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span>
</code></pre></div>
<p><span class="user-mention silent" data-user-id="577757">Icaro Costa</span> <a href="#narrow/stream/113489-new-members/topic/Using.20derivative.20composition/near/320758339">said</a>:</p>
<blockquote>
<p>It seems to be a problem with the definition of <code>Dn</code> again:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#check</span> <span class="n">Dn</span> <span class="mi">0</span>
</code></pre></div>
<p>The check returns a map <code>Dn 0 : ℕ → (ℝ → ℝ) → ℝ → ℝ</code>, but I would be expecting <code> (ℝ → ℝ) → (ℝ → ℝ)</code>, which is just <code>id</code>.</p>
</blockquote>
<p>By the way, I can't reproduce this. I get <code>Dn 0 : (ℝ → ℝ) → ℝ → ℝ</code>.</p>
</blockquote>
<p>Hm that's interesting, I think that an axiom is what I really wanted. However, I am still having problems about the definition of a higher order derivative:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c">/-</span><span class="cm">Identiy operator-/</span>
<span class="kd">def</span> <span class="n">Id</span> <span class="o">:</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">x</span>

<span class="c">/-</span><span class="cm">Higher order derivatives-/</span>
<span class="kd">def</span> <span class="n">Dn</span><span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="o">((</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">))</span>
  <span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">Id</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="n">D</span> <span class="bp">∘</span> <span class="n">Dn</span> <span class="n">n</span>
</code></pre></div>
<p>Doing <code>#check Dn 1</code> outputs a type <code>Dn 1 : ℕ → (ℝ → ℝ) → ℝ → ℝ</code> while what I really want is <code>Dn 1 : (ℝ → ℝ) → (ℝ → ℝ)</code>.  Any way I can make this work?</p>



<a name="320932014"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320932014" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320932014">(Jan 12 2023 at 13:01)</a>:</h4>
<p>Do you have some <code>variables</code>/<code>include</code> lying around? What does <code>#check Dn</code> say?</p>



<a name="320938558"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320938558" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Icaro Costa <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320938558">(Jan 12 2023 at 13:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/113489-new-members/topic/Using.20derivative.20composition/near/320932014">said</a>:</p>
<blockquote>
<p>Do you have some <code>variables</code>/<code>include</code> lying around? What does <code>#check Dn</code> say?</p>
</blockquote>
<p>Doing <code>#check Dn</code> gives me <code>Dn : ((ℝ → ℝ) → ℝ → ℝ) → ℕ → (ℝ → ℝ) → ℝ → ℝ</code>, which doesn't make sense to me.</p>
<p>The variables that I have are these:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c">/-</span><span class="cm">Function definitions-/</span>
<span class="kd">variable</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span>
<span class="kd">variable</span> <span class="o">(</span><span class="n">u</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span>

<span class="c">/-</span><span class="cm">Derivative-/</span>
<span class="kd">variable</span> <span class="o">(</span><span class="n">D</span><span class="o">:</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">))</span>
</code></pre></div>



<a name="320939672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320939672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320939672">(Jan 12 2023 at 13:40)</a>:</h4>
<p>The first argument to <code>Dn</code> is the variable <code>D</code>, not the variable <code>n</code>. So either you write <code>Dn deriv n</code>, or you turn <code>D</code> into a <code>def</code></p>



<a name="320942811"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320942811" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Icaro Costa <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320942811">(Jan 12 2023 at 13:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/113489-new-members/topic/Using.20derivative.20composition/near/320939672">said</a>:</p>
<blockquote>
<p>The first argument to <code>Dn</code> is the variable <code>D</code>, not the variable <code>n</code>. So either you write <code>Dn deriv n</code>, or you turn <code>D</code> into a <code>def</code></p>
</blockquote>
<p>That fixed it!</p>



<a name="320949841"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Using%20derivative%20composition/near/320949841" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Icaro Costa <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Using.20derivative.20composition.html#320949841">(Jan 12 2023 at 14:22)</a>:</h4>
<p>Here's the working code if anyone is interested:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">analysis.calculus.deriv</span>
<span class="kn">import</span> <span class="n">data.real.basic</span>
<span class="kn">import</span> <span class="n">data.list.basic</span>
<span class="kn">import</span> <span class="n">tactic</span>
<span class="kn">import</span> <span class="n">algebra.big_operators.basic</span>
<span class="kn">import</span> <span class="n">data.nat.interval</span>

<span class="kn">import</span> <span class="n">algebra.group.defs</span>

<span class="n">open_locale</span> <span class="n">big_operators</span>

<span class="kn">open</span> <span class="n">finset</span>

<span class="c">/-</span><span class="cm">Function definitions-/</span>
<span class="kd">def</span> <span class="n">f</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span> <span class="o">:=</span> <span class="gr">sorry</span>
<span class="kd">def</span> <span class="n">u</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span> <span class="o">:=</span> <span class="gr">sorry</span>

<span class="c">/-</span><span class="cm">Derivative-/</span>
<span class="kd">def</span> <span class="n">D</span><span class="o">:</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:=</span> <span class="gr">sorry</span>

<span class="c">/-</span><span class="cm">Identiy operator-/</span>
<span class="kd">def</span> <span class="n">Id</span> <span class="o">:</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">),</span> <span class="n">x</span>

<span class="c">/-</span><span class="cm">Higher order derivatives-/</span>
<span class="kd">def</span> <span class="n">Dn</span><span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="o">((</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">))</span>
  <span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">Id</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="n">D</span> <span class="bp">∘</span> <span class="n">Dn</span> <span class="n">n</span>

<span class="k">#check</span> <span class="n">Dn</span> <span class="mi">1</span>

<span class="c">/-</span><span class="cm">Derivative rules-/</span>
<span class="kd">axiom</span> <span class="n">product_rule</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)(</span><span class="n">g</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">):</span> <span class="n">D</span> <span class="o">(</span><span class="n">h</span><span class="bp">*</span><span class="n">g</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">D</span> <span class="n">h</span><span class="o">)</span><span class="bp">*</span><span class="n">g</span> <span class="bp">+</span> <span class="n">h</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">g</span><span class="o">)</span>
<span class="kd">axiom</span> <span class="n">composite_deriv</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">)(</span><span class="n">g</span> <span class="o">:</span> <span class="n">ℝ</span> <span class="bp">→</span> <span class="n">ℝ</span><span class="o">):</span> <span class="n">D</span> <span class="o">(</span><span class="n">h</span> <span class="bp">∘</span> <span class="n">g</span><span class="o">)</span> <span class="bp">=</span> <span class="o">((</span><span class="n">D</span> <span class="n">h</span><span class="o">)</span> <span class="bp">∘</span> <span class="n">g</span><span class="o">)</span> <span class="bp">*</span> <span class="o">(</span><span class="n">D</span> <span class="n">g</span><span class="o">)</span>

<span class="c">/-</span><span class="cm">Composite function with first derivative-/</span>
<span class="kd">lemma</span> <span class="n">first_composite_deriv</span> <span class="o">:</span> <span class="o">(</span><span class="n">Dn</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span> <span class="bp">=</span> <span class="o">((</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">unfold</span> <span class="n">Dn</span><span class="o">,</span>
  <span class="n">simp</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">Id</span><span class="o">,</span>
  <span class="n">simp</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">composite_deriv</span> <span class="n">f</span> <span class="n">u</span><span class="o">,</span>
<span class="kd">end</span>

<span class="c">/-</span><span class="cm">Composite function with second derivative-/</span>
<span class="kd">lemma</span> <span class="n">second_composite_deriv</span> <span class="o">:</span> <span class="n">Dn</span> <span class="mi">2</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(((</span><span class="n">D</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">))</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">)</span> <span class="bp">+</span> <span class="o">((</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span><span class="bp">*</span><span class="o">(</span><span class="n">D</span> <span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">))):=</span>
<span class="kd">begin</span>
  <span class="n">unfold</span> <span class="n">Dn</span><span class="o">,</span>
  <span class="n">simp</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">Id</span><span class="o">,</span>
  <span class="n">simp</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">composite_deriv</span> <span class="n">f</span> <span class="n">u</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">product_rule</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span> <span class="bp">∘</span> <span class="n">u</span><span class="o">)</span> <span class="o">(</span><span class="n">D</span> <span class="n">u</span><span class="o">),</span>
  <span class="n">rw</span> <span class="n">composite_deriv</span> <span class="o">(</span><span class="n">D</span> <span class="n">f</span><span class="o">)</span> <span class="n">u</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>