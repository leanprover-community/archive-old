---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html">Diamond in instances on `with_top R`</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="251236018"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251236018" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251236018">(Aug 30 2021 at 14:16)</a>:</h4>
<p>I'm hitting a diamond trying to define and use reasonable instances on <code>with_top R</code>. Can diamond/mul_action experts chime in possibly?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">type</span> <span class="n">mismatch</span> <span class="n">at</span> <span class="n">application</span>
  <span class="n">concave_on'</span> <span class="n">R</span>
<span class="n">term</span>
  <span class="n">with_top.distrib_mul_action</span> <span class="n">R</span>
<span class="n">has</span> <span class="n">type</span>
  <span class="bp">@</span><span class="n">distrib_mul_action</span> <span class="n">R</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">monoid_with_zero.to_monoid</span> <span class="n">R</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_monoid_with_zero</span> <span class="n">R</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">linear_ordered_semiring.to_ordered_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">))))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">with_top.add_monoid</span> <span class="n">R</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="n">R</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span> <span class="n">R</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">linear_ordered_semiring.to_ordered_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">)))))))</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="bp">@</span><span class="n">distrib_mul_action</span> <span class="n">R</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">monoid_with_zero.to_monoid</span> <span class="n">R</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_monoid_with_zero</span> <span class="n">R</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">linear_ordered_semiring.to_ordered_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">))))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_monoid.to_add_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ordered_add_comm_monoid.to_add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">with_top.ordered_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">ordered_cancel_add_comm_monoid.to_ordered_add_comm_monoid</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_ordered_cancel_add_comm_monoid</span> <span class="n">R</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">linear_ordered_semiring.to_ordered_semiring</span> <span class="n">R</span> <span class="n">_inst_2</span><span class="o">))))))</span>
</code></pre></div>



<a name="251236059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251236059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251236059">(Aug 30 2021 at 14:16)</a>:</h4>
<p>I'll include a mwe in a minute.</p>



<a name="251236673"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251236673" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251236673">(Aug 30 2021 at 14:20)</a>:</h4>
<p>On <a href="https://github.com/leanprover-community/mathlib/tree/pechersky/tropical-semiring">branch#pechersky/tropical-semiring</a>,</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.ordered_ring</span>
<span class="kn">import</span> <span class="n">algebra.tropical.basic</span>
<span class="kn">import</span> <span class="n">data.polynomial.basic</span>

<span class="kd">universe</span> <span class="n">u</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">R</span><span class="o">]</span>

<span class="kd">instance</span> <span class="o">[</span><span class="n">has_zero</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">has_mul</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span> <span class="n">has_scalar</span> <span class="n">R</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">⟨</span><span class="bp">λ</span> <span class="n">k</span> <span class="n">x</span><span class="o">,</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="bp">*</span> <span class="n">x</span><span class="o">⟩</span>

<span class="kd">lemma</span> <span class="n">with_top.smul_def</span> <span class="o">[</span><span class="n">has_zero</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">has_mul</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">k</span> <span class="bp">•</span> <span class="n">x</span> <span class="bp">=</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="bp">*</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">with_top.smul_coe</span> <span class="o">[</span><span class="n">has_zero</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">has_mul</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">k</span> <span class="n">x</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">k</span> <span class="bp">•</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="bp">*</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">with_top.zero_smul</span> <span class="o">[</span><span class="n">has_zero</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">has_mul</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="bp">•</span> <span class="n">x</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">zero_mul</span> <span class="n">x</span>

<span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">with_top.smul_zero</span> <span class="o">[</span><span class="n">has_zero</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">has_mul</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">k</span> <span class="bp">•</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">mul_zero</span> <span class="n">k</span>

<span class="kd">lemma</span> <span class="n">with_top.smul_top_of_ne_zero</span> <span class="o">[</span><span class="n">has_zero</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">has_mul</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="n">k</span> <span class="o">:</span> <span class="n">R</span><span class="o">}</span> <span class="o">(</span><span class="n">hk</span> <span class="o">:</span> <span class="n">k</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">k</span> <span class="bp">•</span> <span class="o">(</span><span class="bp">⊤</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">⊤</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">by_cases</span> <span class="n">H</span> <span class="o">:</span> <span class="o">(</span><span class="bp">⊤</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">simp</span> <span class="o">[</span><span class="n">H</span><span class="o">]</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">refine</span> <span class="n">if_neg</span> <span class="n">_</span><span class="o">,</span>
    <span class="n">simpa</span> <span class="n">using</span> <span class="n">hk</span> <span class="o">}</span>
<span class="kd">end</span>

<span class="kd">variable</span> <span class="o">(</span><span class="n">R</span><span class="o">)</span>

<span class="kd">instance</span> <span class="o">[</span><span class="n">monoid_with_zero</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">no_zero_divisors</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">nontrivial</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span> <span class="n">mul_action</span> <span class="n">R</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">one_smul</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="o">[</span><span class="n">with_top.smul_def</span><span class="o">],</span>
  <span class="n">mul_smul</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="o">[</span><span class="n">with_top.smul_def</span><span class="o">,</span> <span class="n">with_top.coe_mul</span><span class="o">,</span> <span class="n">mul_assoc</span><span class="o">],</span>
  <span class="bp">..</span><span class="n">with_top.has_scalar</span> <span class="o">}</span>

<span class="kd">instance</span> <span class="o">[</span><span class="n">semiring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">no_zero_divisors</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">nontrivial</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
  <span class="n">distrib_mul_action</span> <span class="n">R</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">smul_add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="kd">by</span> <span class="o">{</span>
    <span class="n">rcases</span> <span class="n">eq_or_ne</span> <span class="n">r</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">rfl</span><span class="bp">|</span><span class="n">hr</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">simp</span> <span class="o">},</span>
    <span class="n">induction</span> <span class="n">x</span> <span class="n">using</span> <span class="n">with_top.rec_top_coe</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">simp</span> <span class="o">[</span><span class="n">with_top.smul_top_of_ne_zero</span> <span class="n">hr</span><span class="o">]</span> <span class="o">},</span>
    <span class="n">induction</span> <span class="n">y</span> <span class="n">using</span> <span class="n">with_top.rec_top_coe</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">simp</span> <span class="o">[</span><span class="n">with_top.smul_top_of_ne_zero</span> <span class="n">hr</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="bp">←</span><span class="n">with_top.coe_add</span><span class="o">,</span> <span class="n">with_top.smul_coe</span><span class="o">,</span> <span class="bp">←</span><span class="n">with_top.coe_mul</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">],</span>
      <span class="n">simp</span> <span class="o">[</span><span class="n">with_top.coe_mul</span><span class="o">,</span> <span class="n">with_top.coe_add</span><span class="o">]</span> <span class="o">}</span> <span class="o">},</span>
  <span class="n">smul_zero</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">_</span><span class="o">,</span> <span class="n">mul_zero</span> <span class="n">_</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">with_top.mul_action</span> <span class="n">R</span> <span class="o">}</span>

<span class="kn">section</span> <span class="n">concave</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">E</span> <span class="n">S</span> <span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">add_comm_monoid</span> <span class="n">E</span><span class="o">]</span> <span class="o">[</span><span class="n">ordered_add_comm_monoid</span> <span class="n">β</span><span class="o">]</span>

<span class="kd">variable</span> <span class="o">(</span><span class="n">S</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">convex'</span> <span class="o">[</span><span class="n">linear_ordered_semiring</span> <span class="n">S</span><span class="o">]</span> <span class="o">[</span><span class="n">distrib_mul_action</span> <span class="n">S</span> <span class="n">E</span><span class="o">]</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">set</span> <span class="n">E</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">∀</span> <span class="o">⦃</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">E</span><span class="o">⦄,</span> <span class="n">x</span> <span class="bp">∈</span> <span class="n">s</span> <span class="bp">→</span> <span class="n">y</span> <span class="bp">∈</span> <span class="n">s</span> <span class="bp">→</span> <span class="bp">∀</span> <span class="o">⦃</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">S</span><span class="o">⦄,</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">a</span> <span class="bp">→</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">b</span> <span class="bp">→</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">1</span> <span class="bp">→</span>
  <span class="n">a</span> <span class="bp">•</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">•</span> <span class="n">y</span> <span class="bp">∈</span> <span class="n">s</span>

<span class="sd">/-- Concavity of functions -/</span>
<span class="kd">def</span> <span class="n">concave_on'</span> <span class="o">[</span><span class="n">linear_ordered_semiring</span> <span class="n">S</span><span class="o">]</span> <span class="o">[</span><span class="n">distrib_mul_action</span> <span class="n">S</span> <span class="n">E</span><span class="o">]</span> <span class="o">[</span><span class="n">distrib_mul_action</span> <span class="n">S</span> <span class="n">β</span><span class="o">]</span>
  <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">set</span> <span class="n">E</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">E</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span>
  <span class="n">convex'</span> <span class="n">S</span> <span class="n">s</span> <span class="bp">∧</span>
  <span class="bp">∀</span> <span class="o">⦃</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">E</span><span class="o">⦄,</span> <span class="n">x</span> <span class="bp">∈</span> <span class="n">s</span> <span class="bp">→</span> <span class="n">y</span> <span class="bp">∈</span> <span class="n">s</span> <span class="bp">→</span> <span class="bp">∀</span> <span class="o">⦃</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">S</span><span class="o">⦄,</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">a</span> <span class="bp">→</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">b</span> <span class="bp">→</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">1</span> <span class="bp">→</span>
    <span class="n">a</span> <span class="bp">•</span> <span class="n">f</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">•</span> <span class="n">f</span> <span class="n">y</span> <span class="bp">≤</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">•</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">•</span> <span class="n">y</span><span class="o">)</span>

<span class="kd">variables</span> <span class="o">{</span><span class="n">S</span><span class="o">}</span> <span class="o">[</span><span class="n">linear_ordered_semiring</span> <span class="n">S</span><span class="o">]</span> <span class="o">[</span><span class="n">distrib_mul_action</span> <span class="n">S</span> <span class="n">E</span><span class="o">]</span> <span class="o">[</span><span class="n">has_scalar</span> <span class="n">S</span> <span class="n">E</span><span class="o">]</span>

<span class="kd">lemma</span> <span class="n">convex'_univ</span> <span class="o">:</span> <span class="n">convex'</span> <span class="n">S</span> <span class="o">(</span><span class="n">set.univ</span> <span class="o">:</span> <span class="n">set</span> <span class="n">E</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span> <span class="n">trivial</span>

<span class="kd">end</span> <span class="n">concave</span>

<span class="kd">instance</span> <span class="n">linear_ordered_semiring.to_linear_ordered_add_comm_monoid</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>
  <span class="o">[</span><span class="n">h</span> <span class="o">:</span> <span class="n">linear_ordered_semiring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span> <span class="n">linear_ordered_add_comm_monoid</span> <span class="n">R</span> <span class="o">:=</span>
<span class="o">{</span> <span class="bp">..</span><span class="n">h</span> <span class="o">}</span>

<span class="kd">variables</span> <span class="o">[</span><span class="n">linear_ordered_semiring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">no_zero_divisors</span> <span class="n">R</span><span class="o">]</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">distrib_mul_action</span> <span class="n">R</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="n">with_top.distrib_mul_action</span> <span class="n">R</span>

<span class="kd">def</span> <span class="n">polynomial.eval_tropical'</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="o">(</span><span class="n">tropical</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)))</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">R</span> <span class="o">:=</span> <span class="gr">sorry</span>

<span class="kd">lemma</span> <span class="n">concave_on_eval_tropical'</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">polynomial</span> <span class="o">(</span><span class="n">tropical</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)))</span> <span class="o">:</span>
  <span class="bp">@</span><span class="n">concave_on'</span> <span class="n">R</span> <span class="n">R</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="o">(</span><span class="n">with_top.distrib_mul_action</span> <span class="n">R</span><span class="o">)</span> <span class="n">set.univ</span> <span class="n">p.eval_tropical'</span> <span class="o">:=</span>
  <span class="gr">sorry</span>
</code></pre></div>



<a name="251237024"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251237024" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251237024">(Aug 30 2021 at 14:22)</a>:</h4>
<p>Looking at the erro message only, it looks like there are two different add_comm_monoid structures on <code>with_top R</code>.</p>
<p>What's <code>_inst_2</code> in that context?</p>



<a name="251237484"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251237484" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251237484">(Aug 30 2021 at 14:25)</a>:</h4>
<p><code>linear_ordered_semiring R</code></p>



<a name="251241154"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251241154" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251241154">(Aug 30 2021 at 14:51)</a>:</h4>
<p>Reduced just a little bit:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.ordered_ring</span>
<span class="kd">variables</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">h</span> <span class="o">:</span> <span class="n">ordered_semiring</span> <span class="n">R</span><span class="o">]</span>

<span class="kd">lemma</span> <span class="n">fails</span> <span class="o">:</span> <span class="o">(</span><span class="bp">@</span><span class="n">with_top.add_comm_monoid</span> <span class="n">R</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span> <span class="n">R</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_semiring</span> <span class="n">R</span> <span class="n">h</span><span class="o">)))))</span>
        <span class="bp">=</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ordered_add_comm_monoid.to_add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">with_top.ordered_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">ordered_cancel_add_comm_monoid.to_ordered_add_comm_monoid</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_ordered_cancel_add_comm_monoid</span> <span class="n">R</span>
                   <span class="n">h</span><span class="o">))))</span> <span class="o">:=</span>
<span class="n">rfl</span>
</code></pre></div>



<a name="251241720"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251241720" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251241720">(Aug 30 2021 at 14:54)</a>:</h4>
<p>Is that on master?</p>



<a name="251241871"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251241871" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251241871">(Aug 30 2021 at 14:55)</a>:</h4>
<p>Perhaps the nsmul actions are not defeq?</p>



<a name="251242700"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251242700" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251242700">(Aug 30 2021 at 15:01)</a>:</h4>
<p>Yes, it's on master.</p>



<a name="251243703"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251243703" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251243703">(Aug 30 2021 at 15:07)</a>:</h4>
<p>The <code>nsmul</code> structures are the same:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">works</span> <span class="o">:</span> <span class="bp">@</span><span class="n">add_comm_monoid.nsmul</span> <span class="n">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">with_top.add_comm_monoid</span> <span class="n">R</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span> <span class="n">R</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_semiring</span> <span class="n">R</span> <span class="n">h</span><span class="o">)))))</span>
        <span class="bp">=</span>
       <span class="bp">@</span><span class="n">add_comm_monoid.nsmul</span> <span class="n">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">ordered_add_comm_monoid.to_add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">with_top.ordered_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">ordered_cancel_add_comm_monoid.to_ordered_add_comm_monoid</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_ordered_cancel_add_comm_monoid</span> <span class="n">R</span>
                   <span class="n">h</span><span class="o">))))</span> <span class="o">:=</span>
<span class="n">rfl</span>
</code></pre></div>
<p>So are the <code>add</code> fields and the <code>zero</code> fields...</p>



<a name="251244397"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251244397" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251244397">(Aug 30 2021 at 15:12)</a>:</h4>
<p>But the <code>nsmul_zero'</code> is not:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">fails</span> <span class="o">:</span> <span class="bp">@</span><span class="n">add_comm_monoid.nsmul_zero'</span> <span class="n">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">with_top.add_comm_monoid</span> <span class="n">R</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span> <span class="n">R</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_semiring</span> <span class="n">R</span> <span class="n">h</span><span class="o">)))))</span>
        <span class="bp">=</span>
       <span class="bp">@</span><span class="n">add_comm_monoid.nsmul_zero'</span> <span class="n">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">ordered_add_comm_monoid.to_add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">with_top.ordered_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">ordered_cancel_add_comm_monoid.to_ordered_add_comm_monoid</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_ordered_cancel_add_comm_monoid</span> <span class="n">R</span>
                   <span class="n">h</span><span class="o">))))</span> <span class="o">:=</span>
<span class="n">rfl</span>
</code></pre></div>
<p>Since <code>nsmul_zero'</code> is <code>∀ x, nsmul 0 x = 0 . try_refl_tac</code>, this looks like our old problem with pi types, or <code>try_refl_tac</code> is confusing Lean somewhere.</p>



<a name="251244898"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251244898" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251244898">(Aug 30 2021 at 15:15)</a>:</h4>
<p>Do we need to have definitional equality of propositions to have defeq of structures?</p>



<a name="251244971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251244971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251244971">(Aug 30 2021 at 15:16)</a>:</h4>
<p>Or is it that the <code>. try_refl_tac</code> is somehow preventing <code>proof_irrel</code> from firing?</p>



<a name="251246501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251246501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251246501">(Aug 30 2021 at 15:26)</a>:</h4>
<p>This is a question for lean4 experts then as well -- would we hit this diamond in current lean4? <span class="user-mention" data-user-id="110049">@Mario Carneiro</span></p>



<a name="251246807"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251246807" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251246807">(Aug 30 2021 at 15:28)</a>:</h4>
<p>Unclear, can you make a smaller example?</p>



<a name="251246849"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251246849" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251246849">(Aug 30 2021 at 15:29)</a>:</h4>
<p>it sounds like a bug</p>



<a name="251247505"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251247505" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251247505">(Aug 30 2021 at 15:32)</a>:</h4>
<p>We have </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">instance</span> <span class="o">[</span><span class="n">add_comm_monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">zero</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="n">add</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">+</span><span class="o">),</span>
  <span class="bp">..@</span><span class="n">additive.add_comm_monoid</span> <span class="n">_</span> <span class="bp">$</span> <span class="bp">@</span><span class="n">comm_monoid_with_zero.to_comm_monoid</span> <span class="n">_</span> <span class="bp">$</span>
    <span class="bp">@</span><span class="n">with_zero.comm_monoid_with_zero</span> <span class="o">(</span><span class="n">multiplicative</span> <span class="n">α</span><span class="o">)</span> <span class="n">_</span> <span class="o">}</span>
</code></pre></div>
<p>Maybe this issue has to do with the defeq abuse around using <code>with_zero</code>. Checking that.</p>



<a name="251247897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251247897" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251247897">(Aug 30 2021 at 15:35)</a>:</h4>
<p>a mathlib free example would be good</p>



<a name="251248969"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251248969" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251248969">(Aug 30 2021 at 15:41)</a>:</h4>
<p>Working on making that. In the meantime, I have the following:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">type</span> <span class="n">mismatch</span> <span class="n">at</span> <span class="n">application</span>
  <span class="n">add_comm_monoid.nsmul_zero'</span> <span class="bp">=</span> <span class="n">add_comm_monoid.nsmul_zero'</span>
<span class="n">term</span>
  <span class="n">add_comm_monoid.nsmul_zero'</span>
<span class="n">has</span> <span class="n">type</span>
  <span class="n">auto_param</span>
    <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">),</span>
       <span class="bp">@</span><span class="n">add_comm_monoid.nsmul</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
           <span class="o">(</span><span class="bp">@</span><span class="n">ordered_add_comm_monoid.to_add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
              <span class="o">(</span><span class="bp">@</span><span class="n">with_top.ordered_add_comm_monoid</span> <span class="n">R</span>
                 <span class="o">(</span><span class="bp">@</span><span class="n">ordered_cancel_add_comm_monoid.to_ordered_add_comm_monoid</span> <span class="n">R</span>
                    <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_ordered_cancel_add_comm_monoid</span> <span class="n">R</span> <span class="n">h</span><span class="o">))))</span>
           <span class="mi">0</span>
           <span class="n">x</span> <span class="bp">=</span>
         <span class="mi">0</span><span class="o">)</span>
    <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"try_refl_tac"</span> <span class="n">name.anonymous</span><span class="o">)</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="n">auto_param</span>
    <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">with_top</span> <span class="n">R</span><span class="o">),</span>
       <span class="bp">@</span><span class="n">add_comm_monoid.nsmul</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
           <span class="o">(</span><span class="bp">@</span><span class="n">with_top.add_comm_monoid'</span> <span class="n">R</span>
              <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span> <span class="n">R</span>
                 <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span> <span class="n">R</span>
                    <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_semiring</span> <span class="n">R</span> <span class="n">h</span><span class="o">)))))</span>
           <span class="mi">0</span>
           <span class="n">x</span> <span class="bp">=</span>
         <span class="mi">0</span><span class="o">)</span>
    <span class="o">(</span><span class="n">name.mk_string</span> <span class="s2">"try_refl_tac"</span> <span class="n">name.anonymous</span><span class="o">)</span>
</code></pre></div>



<a name="251249207"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251249207" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251249207">(Aug 30 2021 at 15:43)</a>:</h4>
<p>Oh, I assumed from the message above that simply <code>rfl</code> could not prove the result, not that the statement was ill-formed</p>



<a name="251249465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251249465" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251249465">(Aug 30 2021 at 15:45)</a>:</h4>
<p>This is from me trying to undo the definition of the algebraic instances from <code>additive (with_zero ...)</code> but manually.</p>



<a name="251250268"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251250268" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251250268">(Aug 30 2021 at 15:51)</a>:</h4>
<p>Elaborating on Sebastien's post:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.ordered_ring</span>
<span class="kd">variables</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">h</span> <span class="o">:</span> <span class="n">ordered_semiring</span> <span class="n">R</span><span class="o">]</span>

<span class="kd">lemma</span> <span class="n">with_irrel</span> <span class="o">:</span> <span class="bp">@</span><span class="n">add_comm_monoid.nsmul_zero'</span> <span class="n">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">with_top.add_comm_monoid</span> <span class="n">R</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span> <span class="n">R</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_semiring</span> <span class="n">R</span> <span class="n">h</span><span class="o">)))))</span>
        <span class="bp">=</span>
       <span class="bp">@</span><span class="n">add_comm_monoid.nsmul_zero'</span> <span class="n">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">ordered_add_comm_monoid.to_add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">with_top.ordered_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">ordered_cancel_add_comm_monoid.to_ordered_add_comm_monoid</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_ordered_cancel_add_comm_monoid</span> <span class="n">R</span>
                   <span class="n">h</span><span class="o">))))</span> <span class="o">:=</span>
<span class="n">proof_irrel</span> <span class="n">_</span> <span class="n">_</span> <span class="c1">-- ok</span>

<span class="kd">lemma</span> <span class="n">with_rfl</span> <span class="o">:</span> <span class="bp">@</span><span class="n">add_comm_monoid.nsmul_zero'</span> <span class="n">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">with_top.add_comm_monoid</span> <span class="n">R</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span> <span class="n">R</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_semiring</span> <span class="n">R</span> <span class="n">h</span><span class="o">)))))</span>
        <span class="bp">=</span>
       <span class="bp">@</span><span class="n">add_comm_monoid.nsmul_zero'</span> <span class="n">_</span> <span class="o">(</span><span class="bp">@</span><span class="n">ordered_add_comm_monoid.to_add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">with_top.ordered_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">ordered_cancel_add_comm_monoid.to_ordered_add_comm_monoid</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_ordered_cancel_add_comm_monoid</span> <span class="n">R</span>
                   <span class="n">h</span><span class="o">))))</span> <span class="o">:=</span>
<span class="n">rfl</span>  <span class="c1">-- fails</span>
</code></pre></div>



<a name="251252973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251252973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251252973">(Aug 30 2021 at 16:11)</a>:</h4>
<p><code>(λ (h₁ h₂ : (_ : Prop)), show h₁ = h₂, from rfl) _ _</code> works as a proof too</p>



<a name="251255786"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251255786" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251255786">(Aug 30 2021 at 16:32)</a>:</h4>
<p>Yes, I think this is due to the (ab)use of defeq via with_zero:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.ordered_ring</span>
<span class="kd">variables</span> <span class="o">{</span><span class="n">α</span> <span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">h</span> <span class="o">:</span> <span class="n">ordered_semiring</span> <span class="n">R</span><span class="o">]</span>

<span class="kn">local</span> <span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="kd">instance</span><span class="o">]</span> <span class="n">with_top.add_semigroup</span> <span class="n">with_top.add_comm_semigroup</span> <span class="n">with_top.add_monoid</span>
  <span class="n">with_top.add_comm_monoid</span> <span class="n">with_top.ordered_add_comm_monoid</span>

<span class="kd">instance</span> <span class="n">with_top.add_semigroup'</span> <span class="o">[</span><span class="n">add_semigroup</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_semigroup</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">add_assoc</span> <span class="o">:=</span>
  <span class="kd">begin</span>
    <span class="n">refine</span> <span class="n">with_top.rec_top_coe</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span>
    <span class="n">simp</span> <span class="o">[</span><span class="bp">←</span><span class="n">with_top.coe_add</span><span class="o">,</span> <span class="n">add_assoc</span><span class="o">],</span>
    <span class="n">intro</span><span class="o">,</span> <span class="n">refine</span> <span class="n">with_top.rec_top_coe</span> <span class="n">_</span> <span class="n">_</span><span class="bp">;</span>
    <span class="n">simp</span> <span class="o">[</span><span class="bp">←</span><span class="n">with_top.coe_add</span><span class="o">,</span> <span class="n">add_assoc</span><span class="o">],</span>
    <span class="n">intro</span><span class="o">,</span> <span class="n">refine</span> <span class="n">with_top.rec_top_coe</span> <span class="n">_</span> <span class="n">_</span><span class="bp">;</span>
    <span class="n">simp</span> <span class="o">[</span><span class="bp">←</span><span class="n">with_top.coe_add</span><span class="o">,</span> <span class="n">add_assoc</span><span class="o">]</span>
  <span class="kd">end</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">with_top.has_add</span> <span class="o">}</span>

<span class="kd">instance</span> <span class="n">with_top.add_comm_semigroup'</span> <span class="o">[</span><span class="n">add_comm_semigroup</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_comm_semigroup</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">add_comm</span> <span class="o">:=</span>
  <span class="kd">begin</span>
    <span class="n">refine</span> <span class="n">with_top.rec_top_coe</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span>
    <span class="n">simp</span> <span class="o">[</span><span class="bp">←</span><span class="n">with_top.coe_add</span><span class="o">,</span> <span class="n">add_comm</span><span class="o">],</span>
    <span class="n">intro</span><span class="o">,</span> <span class="n">refine</span> <span class="n">with_top.rec_top_coe</span> <span class="n">_</span> <span class="n">_</span><span class="bp">;</span>
    <span class="n">simp</span> <span class="o">[</span><span class="bp">←</span><span class="n">with_top.coe_add</span><span class="o">,</span> <span class="n">add_comm</span><span class="o">]</span>
  <span class="kd">end</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">with_top.add_semigroup'</span> <span class="o">}</span>

<span class="kd">instance</span> <span class="n">with_top.add_monoid'</span> <span class="o">[</span><span class="n">add_monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">zero_add</span> <span class="o">:=</span>
  <span class="kd">begin</span>
    <span class="n">refine</span> <span class="n">with_top.rec_top_coe</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">simpa</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intro</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="bp">←</span><span class="n">with_top.coe_zero</span><span class="o">,</span> <span class="bp">←</span><span class="n">with_top.coe_add</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">]</span> <span class="o">}</span>
  <span class="kd">end</span><span class="o">,</span>
  <span class="n">add_zero</span> <span class="o">:=</span>
  <span class="kd">begin</span>
    <span class="n">refine</span> <span class="n">with_top.rec_top_coe</span> <span class="n">_</span> <span class="n">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">simpa</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intro</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="bp">←</span><span class="n">with_top.coe_zero</span><span class="o">,</span> <span class="bp">←</span><span class="n">with_top.coe_add</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">]</span> <span class="o">}</span>
  <span class="kd">end</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">with_top.has_zero</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">with_top.add_semigroup'</span> <span class="o">}</span>


<span class="kd">instance</span> <span class="n">with_top.add_comm_monoid'</span> <span class="o">[</span><span class="n">add_comm_monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="bp">..</span><span class="n">with_top.add_monoid'</span><span class="o">,</span> <span class="bp">..</span><span class="n">with_top.add_comm_semigroup'</span> <span class="o">}</span>

<span class="kd">instance</span> <span class="n">with_top.ordered_add_comm_monoid'</span> <span class="o">[</span><span class="n">ordered_add_comm_monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">ordered_add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">add_le_add_left</span> <span class="o">:=</span>
    <span class="kd">begin</span>
      <span class="n">rintros</span> <span class="n">a</span> <span class="n">b</span> <span class="n">h</span> <span class="o">(</span><span class="n">_</span><span class="bp">|</span><span class="n">c</span><span class="o">),</span> <span class="o">{</span> <span class="n">simp</span> <span class="o">[</span><span class="n">with_top.none_eq_top</span><span class="o">]</span> <span class="o">},</span>
      <span class="n">rcases</span> <span class="n">b</span> <span class="k">with</span> <span class="o">(</span><span class="n">_</span><span class="bp">|</span><span class="n">b</span><span class="o">),</span> <span class="o">{</span> <span class="n">simp</span> <span class="o">[</span><span class="n">with_top.none_eq_top</span><span class="o">]</span> <span class="o">},</span>
      <span class="n">rcases</span> <span class="n">with_top.le_coe_iff.1</span> <span class="n">h</span> <span class="k">with</span> <span class="o">⟨</span><span class="n">a</span><span class="o">,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">h</span><span class="o">⟩,</span>
      <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">with_top.some_eq_coe</span><span class="o">,</span> <span class="bp">←</span> <span class="n">with_top.coe_add</span><span class="o">,</span> <span class="n">with_top.coe_le_coe</span><span class="o">]</span> <span class="n">at</span> <span class="n">h</span> <span class="bp">⊢</span><span class="o">,</span>
      <span class="n">exact</span> <span class="n">add_le_add_left</span> <span class="n">h</span> <span class="n">c</span>
    <span class="kd">end</span><span class="o">,</span>
  <span class="n">lt_of_add_lt_add_left</span> <span class="o">:=</span>
    <span class="kd">begin</span>
      <span class="n">intros</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">h</span><span class="o">,</span>
      <span class="n">rcases</span> <span class="n">with_top.lt_iff_exists_coe.1</span> <span class="n">h</span> <span class="k">with</span> <span class="o">⟨</span><span class="n">ab</span><span class="o">,</span> <span class="n">hab</span><span class="o">,</span> <span class="n">hlt</span><span class="o">⟩,</span>
      <span class="n">rcases</span> <span class="n">with_top.add_eq_coe.1</span> <span class="n">hab</span> <span class="k">with</span> <span class="o">⟨</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">rfl</span><span class="o">⟩,</span>
      <span class="n">rw</span> <span class="n">with_top.coe_lt_iff</span><span class="o">,</span>
      <span class="n">rintro</span> <span class="n">c</span> <span class="n">rfl</span><span class="o">,</span>
      <span class="n">exact</span> <span class="n">lt_of_add_lt_add_left</span> <span class="o">(</span><span class="n">with_top.coe_lt_coe.1</span> <span class="n">hlt</span><span class="o">)</span>
    <span class="kd">end</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">with_top.partial_order</span><span class="o">,</span> <span class="bp">..</span><span class="n">with_top.add_comm_monoid'</span> <span class="o">}</span>

<span class="kd">lemma</span> <span class="n">no_longer_fails</span> <span class="o">:</span> <span class="o">(</span><span class="bp">@</span><span class="n">with_top.add_comm_monoid'</span> <span class="n">R</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_add_comm_monoid</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_semiring.to_non_unital_non_assoc_semiring</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">semiring.to_non_assoc_semiring</span> <span class="n">R</span>
                   <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_semiring</span> <span class="n">R</span> <span class="n">h</span><span class="o">)))))</span>
        <span class="bp">=</span>
       <span class="o">(</span><span class="bp">@</span><span class="n">ordered_add_comm_monoid.to_add_comm_monoid</span> <span class="o">(</span><span class="n">with_top</span> <span class="n">R</span><span class="o">)</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">with_top.ordered_add_comm_monoid'</span> <span class="n">R</span>
             <span class="o">(</span><span class="bp">@</span><span class="n">ordered_cancel_add_comm_monoid.to_ordered_add_comm_monoid</span> <span class="n">R</span>
                <span class="o">(</span><span class="bp">@</span><span class="n">ordered_semiring.to_ordered_cancel_add_comm_monoid</span> <span class="n">R</span>
                   <span class="n">h</span><span class="o">))))</span> <span class="o">:=</span>
<span class="n">rfl</span>
</code></pre></div>



<a name="251256607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251256607" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251256607">(Aug 30 2021 at 16:39)</a>:</h4>
<p>Adding <code>attribute [semireducible] with_zero</code> to the mwe fixes it (<code>with_zero</code> is irreducible)</p>



<a name="251256650"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251256650" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251256650">(Aug 30 2021 at 16:39)</a>:</h4>
<p>So this is the <code>tensor_algebra.ring</code> problem resurfacing</p>



<a name="251256975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251256975" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251256975">(Aug 30 2021 at 16:42)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/8926">#8926</a></p>



<a name="251257019"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251257019" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251257019">(Aug 30 2021 at 16:42)</a>:</h4>
<p>Link for the <code>tensor_algebra.ring</code> issue tracker?</p>



<a name="251257274"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Diamond%20in%20instances%20on%20%60with_top%20R%60/near/251257274" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Diamond.20in.20instances.20on.20.60with_top.20R.60.html#251257274">(Aug 30 2021 at 16:44)</a>:</h4>
<p>No issue, but we have these comments:</p>
<ul>
<li><a href="https://github.com/leanprover-community/mathlib/blob/1e89df22bbce32e6f6fea2c95d6aa52dfadef012/src/algebra/free_algebra.lean#L287-L289">https://github.com/leanprover-community/mathlib/blob/1e89df22bbce32e6f6fea2c95d6aa52dfadef012/src/algebra/free_algebra.lean#L287-L289</a></li>
<li><a href="https://github.com/leanprover-community/mathlib/blob/master/src/linear_algebra/tensor_algebra.lean#L106-L109">https://github.com/leanprover-community/mathlib/blob/master/src/linear_algebra/tensor_algebra.lean#L106-L109</a></li>
<li><a href="https://github.com/leanprover-community/mathlib/blob/1e89df22bbce32e6f6fea2c95d6aa52dfadef012/src/linear_algebra/exterior_algebra.lean#L140-L142">https://github.com/leanprover-community/mathlib/blob/1e89df22bbce32e6f6fea2c95d6aa52dfadef012/src/linear_algebra/exterior_algebra.lean#L140-L142</a></li>
</ul>
<p>which link to <a href="#narrow/stream/113488-general/topic/algebra.2Esemiring_to_ring.20breaks.20semimodule.20typeclass.20lookup/near/212580241">this Zulip thread</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>