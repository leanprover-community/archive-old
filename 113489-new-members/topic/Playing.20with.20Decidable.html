---
layout: archive
title: Zulip Chat Archive
permalink: /stream/113489-new-members/topic/Playing.20with.20Decidable.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/index.html">new members</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html">Playing with Decidable</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="309516739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309516739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Langley <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309516739">(Nov 14 2022 at 00:54)</a>:</h4>
<p>(I hope somewhat silly questions are ok here—if I'm off topic please just say!)</p>
<p>I wanted to play around with Lean to contrast with Coq (which I also don't really know). As an experiment, I tried to define a Decidable instance for propositions ∀ (x : Fin 256), f x)—since the domain of Fin is finite, one can just do proof by computation. With some sorry'ing of things that I think I could prove, that seems doable (<a href="https://pastebin.com/raw/ixKU7J31">https://pastebin.com/raw/ixKU7J31</a>). Then I define a couple of test predicates and their <code>DecideablePred</code> instances and <code>#eval decide (∀ (x : Fin 256), test_p_true x)</code> says <code>true</code>, which sounds promising. But then using <code>by decide</code> fails(*) and <code>apply of_decide_eq_true ; rfl</code> seems to hang Lean (or at least VS Code). Trying to <code>#eval</code> around with <code>Decidable.rec</code> only says <code>failed to elaborate eliminator, expected type is not available</code>.</p>
<p>Have I done something dumb? Perhaps I need to fill out all the sorrys when needing to evaluate an expression rather than just inhabit a Prop?</p>
<p>(*) <code>failed to reduce to 'true':  Decidable.rec (fun h =&gt; (fun x =&gt; false) h) (fun h =&gt; (fun x =&gt; true) h) instDecidableForAllFinOfNatNatInstOfNatNat</code></p>



<a name="309517755"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309517755" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309517755">(Nov 14 2022 at 01:06)</a>:</h4>
<p>Here's a version that seems to perform fairly well:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">all</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">Bool</span><span class="o">)</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">i</span> <span class="bp">≤</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">Bool</span>
  <span class="bp">|</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">true</span>
  <span class="bp">|</span> <span class="n">i</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">h</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">⟨</span><span class="n">i</span><span class="o">,</span> <span class="n">h</span><span class="o">⟩</span> <span class="bp">&amp;&amp;</span> <span class="n">all</span> <span class="n">f</span> <span class="n">i</span> <span class="o">(</span><span class="n">Nat.le_of_lt</span> <span class="n">h</span><span class="o">)</span>

<span class="kd">theorem</span> <span class="n">all_iff</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">[</span><span class="n">DecidablePred</span> <span class="n">f</span><span class="o">]</span> <span class="o">:</span>
    <span class="n">all</span> <span class="o">(</span><span class="n">f</span> <span class="bp">·</span><span class="o">)</span> <span class="n">n</span> <span class="o">(</span><span class="n">Nat.le_refl</span> <span class="n">_</span><span class="o">)</span> <span class="bp">↔</span> <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span><span class="o">),</span> <span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span> <span class="gr">sorry</span>

<span class="kd">instance</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">[</span><span class="n">DecidablePred</span> <span class="n">f</span><span class="o">]</span> <span class="o">:</span> <span class="n">Decidable</span> <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span><span class="o">),</span> <span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">decidable_of_decidable_of_iff</span> <span class="o">(</span><span class="n">all_iff</span> <span class="n">f</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">test_p_true</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">256</span> <span class="bp">-&gt;</span> <span class="kt">Prop</span>
<span class="bp">|</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span>

<span class="kd">def</span> <span class="n">test_p_false</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">256</span> <span class="bp">-&gt;</span> <span class="kt">Prop</span>
<span class="bp">|</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">x</span> <span class="bp">=</span> <span class="mi">42</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">DecidablePred</span> <span class="n">test_p_true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">intro</span> <span class="n">x</span><span class="bp">;</span> <span class="n">unfold</span> <span class="n">test_p_true</span><span class="bp">;</span> <span class="n">apply</span> <span class="n">decEq</span>
<span class="kd">instance</span> <span class="o">:</span> <span class="n">DecidablePred</span> <span class="n">test_p_false</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">intro</span> <span class="n">x</span><span class="bp">;</span> <span class="n">unfold</span> <span class="n">test_p_false</span><span class="bp">;</span> <span class="n">apply</span> <span class="n">decEq</span>

<span class="k">#eval</span> <span class="o">(</span><span class="n">inferInstance</span> <span class="o">:</span> <span class="n">Decidable</span> <span class="o">((</span><span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">256</span><span class="o">),</span> <span class="n">test_p_true</span> <span class="n">x</span><span class="o">)</span> <span class="o">))</span>
<span class="k">#eval</span> <span class="n">decide</span> <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">256</span><span class="o">),</span> <span class="n">test_p_true</span> <span class="n">x</span><span class="o">)</span>
</code></pre></div>



<a name="309519924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309519924" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Langley <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309519924">(Nov 14 2022 at 01:34)</a>:</h4>
<p>Gosh, <code>decidable_of_decidable_of_iff</code> does indeed work much better than my mess! Thank you!</p>
<p><code>example : ∀ (x : Fin 256), test_p_true x := by decide</code> still fails, however. Although <code>apply of_decide_eq_true ; rfl</code> _does_ work.</p>



<a name="309520428"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520428" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520428">(Nov 14 2022 at 01:43)</a>:</h4>
<p>Oh, that's interesting. I guess it's because this is a fairly linear computation it's blowing the stack. The recommended suggestion of <code>set_option maxRecDepth 1000</code> does seem to work</p>



<a name="309520527"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520527" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520527">(Nov 14 2022 at 01:45)</a>:</h4>
<p>Does writing this in a tail-recursive way help at all? Or does lean 4 only handle that in the VM / not optimize it at all?</p>



<a name="309520533"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520533" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520533">(Nov 14 2022 at 01:45)</a>:</h4>
<p>Note that we don't usually use kernel computation like this in lean, unlike coq which leans heavily on it. The preferred way is to construct a proof term</p>



<a name="309520587"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520587" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520587">(Nov 14 2022 at 01:46)</a>:</h4>
<p>I was thinking about that, but the tail recursion of interest would be in the kernel whnf computation</p>



<a name="309520588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Langley <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520588">(Nov 14 2022 at 01:46)</a>:</h4>
<p>Ah, I hadn't considered that the default depth limit might legitimately be too small but it's in the prelude, and it's only 512.</p>



<a name="309520629"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520629" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520629">(Nov 14 2022 at 01:47)</a>:</h4>
<p>There isn't really any room for "optimization" when it comes to kernel computation, that would entail replacing the expr by a different one</p>



<a name="309520639"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520639" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520639">(Nov 14 2022 at 01:47)</a>:</h4>
<p>and it's not obvious how to do that without changing defeqs</p>



<a name="309520698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520698" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520698">(Nov 14 2022 at 01:48)</a>:</h4>
<p>Could the kernel not unify for tall-recursive cases in an order that requires constant rather than linear stack space?</p>



<a name="309520736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520736">(Nov 14 2022 at 01:49)</a>:</h4>
<p>it's a reasonable question. I don't know that much about how it unfolds specifically seeing as it has basically been untouched for as long as I have been around</p>



<a name="309520743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520743">(Nov 14 2022 at 01:49)</a>:</h4>
<p>I'm sure you know more than me</p>



<a name="309520809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520809" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520809">(Nov 14 2022 at 01:50)</a>:</h4>
<p>I suppose even if it did use constant space, <code>maxDepth</code> could end up counting the syntactic recursion</p>



<a name="309520831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520831">(Nov 14 2022 at 01:51)</a>:</h4>
<p>Actually, I recall gabriel mentioning that there is a way to get <code>whnf</code> to evaluate one step at a time; I want to make a user command to display the evaluation sequence now</p>



<a name="309520837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309520837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309520837">(Nov 14 2022 at 01:51)</a>:</h4>
<p>although that's the elaborator and not the kernel so there could be some discrepancies</p>



<a name="309522583"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309522583" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309522583">(Nov 14 2022 at 02:23)</a>:</h4>
<p>Actually, this kind of works:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>
<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Meta</span> <span class="n">Elab</span>

<span class="kd">def</span> <span class="n">whnf1</span> <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="n">Expr</span><span class="o">)</span> <span class="o">:</span> <span class="n">MetaM</span> <span class="n">Expr</span> <span class="o">:=</span>
  <span class="n">whnfEasyCases</span> <span class="n">e</span> <span class="k">fun</span> <span class="n">e</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">e'</span> <span class="bp">←</span> <span class="n">whnfCore</span> <span class="n">e</span>
    <span class="k">if</span> <span class="k">let</span> <span class="n">some</span> <span class="n">v</span> <span class="bp">←</span> <span class="n">reduceNat</span><span class="bp">?</span> <span class="n">e'</span> <span class="k">then</span> <span class="n">return</span> <span class="n">v</span>
    <span class="k">if</span> <span class="k">let</span> <span class="n">some</span> <span class="n">v</span> <span class="bp">←</span> <span class="n">reduceNative</span><span class="bp">?</span> <span class="n">e'</span> <span class="k">then</span> <span class="n">return</span> <span class="n">v</span>
    <span class="k">if</span> <span class="k">let</span> <span class="n">some</span> <span class="n">v</span> <span class="bp">←</span> <span class="n">unfoldDefinition</span><span class="bp">?</span> <span class="n">e'</span> <span class="k">then</span> <span class="n">return</span> <span class="n">v</span>
    <span class="n">return</span> <span class="n">e'</span>

<span class="n">elab</span> <span class="n">tk</span><span class="o">:</span><span class="s2">"#whnf_seq"</span> <span class="n">e</span><span class="o">:</span><span class="n">term</span> <span class="n">depth</span><span class="o">:((</span><span class="s2">":"</span> <span class="n">num</span><span class="o">)</span><span class="bp">?</span><span class="o">)</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="n">Command.runTermElabM</span> <span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mut</span> <span class="n">e</span> <span class="bp">←</span> <span class="n">Elab.Term.elabTermAndSynthesize</span> <span class="n">e</span> <span class="n">none</span>
    <span class="k">let</span> <span class="n">depth</span> <span class="o">:=</span> <span class="n">depth.raw</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="bp">.</span><span class="n">isNatLit</span><span class="bp">?.</span><span class="n">getD</span> <span class="mi">1000</span>
    <span class="k">let</span> <span class="n">mut</span> <span class="n">msg</span> <span class="o">:=</span> <span class="n">m</span><span class="bp">!</span><span class="s2">""</span>
    <span class="n">for</span> <span class="n">_</span> <span class="k">in</span> <span class="o">[:</span><span class="n">depth</span><span class="o">]</span> <span class="k">do</span>
      <span class="n">msg</span> <span class="o">:=</span> <span class="n">msg</span> <span class="bp">++</span> <span class="n">m</span><span class="bp">!</span><span class="s2">"• {MessageData.nest 2 e}</span><span class="se">\n</span><span class="s2">"</span>
      <span class="k">let</span> <span class="n">e'</span> <span class="bp">←</span> <span class="n">whnf1</span> <span class="n">e</span>
      <span class="k">if</span> <span class="n">e'</span> <span class="bp">==</span> <span class="n">e</span> <span class="k">then</span> <span class="n">logInfoAt</span> <span class="n">tk</span> <span class="n">msg</span><span class="bp">;</span> <span class="n">return</span>
      <span class="n">e</span> <span class="o">:=</span> <span class="n">e'</span>
    <span class="n">logInfoAt</span> <span class="n">tk</span> <span class="o">(</span><span class="n">msg</span> <span class="bp">++</span> <span class="s2">"..."</span><span class="o">)</span>
</code></pre></div>



<a name="309522588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309522588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309522588">(Nov 14 2022 at 02:23)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">#</span><span class="n">whnf_seq</span> <span class="n">all</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="bp">·</span><span class="o">)</span> <span class="mi">3</span> <span class="o">(</span><span class="kd">by</span> <span class="n">decide</span><span class="o">)</span>
</code></pre></div>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">•</span> <span class="n">all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="mi">3</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">3</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span>
<span class="bp">•</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="o">{</span> <span class="n">val</span> <span class="o">:=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">isLt</span> <span class="o">:=</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">3</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span> <span class="o">}</span> <span class="bp">&amp;&amp;</span>
    <span class="n">all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="mi">2</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span>
<span class="bp">•</span> <span class="k">match</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="o">{</span> <span class="n">val</span> <span class="o">:=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">isLt</span> <span class="o">:=</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">3</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span> <span class="o">}</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">false</span> <span class="bp">=&gt;</span> <span class="n">false</span>
  <span class="bp">|</span> <span class="n">true</span> <span class="bp">=&gt;</span> <span class="n">all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="mi">2</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span>
<span class="bp">•</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="o">{</span> <span class="n">val</span> <span class="o">:=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">isLt</span> <span class="o">:=</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span> <span class="o">}</span> <span class="bp">&amp;&amp;</span>
    <span class="n">all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="mi">1</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span>
<span class="bp">•</span> <span class="k">match</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="o">{</span> <span class="n">val</span> <span class="o">:=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">isLt</span> <span class="o">:=</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span> <span class="o">}</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">false</span> <span class="bp">=&gt;</span> <span class="n">false</span>
  <span class="bp">|</span> <span class="n">true</span> <span class="bp">=&gt;</span> <span class="n">all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="mi">1</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span>
<span class="bp">•</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="o">{</span> <span class="n">val</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">isLt</span> <span class="o">:=</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span> <span class="o">}</span> <span class="bp">&amp;&amp;</span>
    <span class="n">all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="mi">0</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span>
<span class="bp">•</span> <span class="k">match</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="o">{</span> <span class="n">val</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">isLt</span> <span class="o">:=</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span> <span class="o">}</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">false</span> <span class="bp">=&gt;</span> <span class="n">false</span>
  <span class="bp">|</span> <span class="n">true</span> <span class="bp">=&gt;</span> <span class="n">all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="mi">0</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span>
<span class="bp">•</span> <span class="n">true</span>
</code></pre></div>



<a name="309522650"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/309522650" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#309522650">(Nov 14 2022 at 02:24)</a>:</h4>
<p>This one doesn't though, it seems to do the whole subcomputation in one step:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">#</span><span class="n">whnf_seq</span> <span class="n">decide</span> <span class="o">(</span><span class="n">all</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="bp">·</span><span class="o">)</span> <span class="mi">3</span> <span class="o">(</span><span class="kd">by</span> <span class="n">decide</span><span class="o">))</span>
</code></pre></div>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">•</span> <span class="n">decide</span> <span class="o">(</span><span class="n">all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="mi">3</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">3</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">)</span> <span class="bp">=</span> <span class="n">true</span><span class="o">)</span>
<span class="bp">•</span> <span class="n">Decidable.casesOn</span> <span class="o">(</span><span class="n">instDecidableEqBool</span> <span class="o">(</span><span class="n">all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">decide</span> <span class="o">(</span><span class="n">test_p_true</span> <span class="n">x</span><span class="o">))</span> <span class="mi">3</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="mi">3</span> <span class="bp">≤</span> <span class="mi">256</span><span class="o">))</span> <span class="n">true</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">false</span><span class="o">)</span>
    <span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">true</span>
<span class="bp">•</span> <span class="n">true</span>
</code></pre></div>



<a name="310541905"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310541905" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Langley <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310541905">(Nov 17 2022 at 04:05)</a>:</h4>
<p>I did manage to reproduce the original issue, even with the better code. Changing the valid test function from <code>x = x</code> to <code>x &amp;&amp;&amp; 1 &lt; 2</code> causes the <code>by decide</code> to fail again with</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">failed</span> <span class="n">to</span> <span class="n">reduce</span> <span class="n">to</span> <span class="bp">'</span><span class="n">true'</span>
  <span class="n">Decidable.rec</span> <span class="o">(</span><span class="k">fun</span> <span class="n">h</span> <span class="bp">=&gt;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">false</span><span class="o">)</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">h</span> <span class="bp">=&gt;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">true</span><span class="o">)</span> <span class="n">h</span><span class="o">)</span>
    <span class="o">(</span><span class="n">instDecidableForAllFin</span> <span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">test_p_true</span> <span class="n">x</span><span class="o">)</span>
</code></pre></div>
<p>... even though the evals are both still happy.</p>
<p>Here's the tweaked, failing code:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">all</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">Bool</span><span class="o">)</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">i</span> <span class="bp">≤</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">Bool</span>
  <span class="bp">|</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">true</span>
  <span class="bp">|</span> <span class="n">i</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">h</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">⟨</span><span class="n">i</span><span class="o">,</span> <span class="n">h</span><span class="o">⟩</span> <span class="bp">&amp;&amp;</span> <span class="n">all</span> <span class="n">f</span> <span class="n">i</span> <span class="o">(</span><span class="n">Nat.le_of_lt</span> <span class="n">h</span><span class="o">)</span>

<span class="kd">theorem</span> <span class="n">all_iff</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">[</span><span class="n">DecidablePred</span> <span class="n">f</span><span class="o">]</span> <span class="o">:</span>
    <span class="n">all</span> <span class="o">(</span><span class="n">f</span> <span class="bp">·</span><span class="o">)</span> <span class="n">n</span> <span class="o">(</span><span class="n">Nat.le_refl</span> <span class="n">_</span><span class="o">)</span> <span class="bp">↔</span> <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span><span class="o">),</span> <span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span> <span class="gr">sorry</span>

<span class="kd">instance</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">[</span><span class="n">DecidablePred</span> <span class="n">f</span><span class="o">]</span> <span class="o">:</span> <span class="n">Decidable</span> <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span><span class="o">),</span> <span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">decidable_of_decidable_of_iff</span> <span class="o">(</span><span class="n">all_iff</span> <span class="n">f</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">test_p_true</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">256</span> <span class="bp">-&gt;</span> <span class="kt">Prop</span>
<span class="bp">|</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">x</span> <span class="bp">&amp;&amp;&amp;</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="mi">2</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">DecidablePred</span> <span class="n">test_p_true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">intro</span> <span class="n">x</span><span class="bp">;</span> <span class="n">unfold</span> <span class="n">test_p_true</span><span class="bp">;</span> <span class="n">apply</span> <span class="n">Nat.decLt</span>

<span class="k">#eval</span> <span class="o">(</span><span class="n">inferInstance</span> <span class="o">:</span> <span class="n">Decidable</span> <span class="o">((</span><span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">256</span><span class="o">),</span> <span class="n">test_p_true</span> <span class="n">x</span><span class="o">)</span> <span class="o">))</span>
<span class="k">#eval</span> <span class="n">decide</span> <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">256</span><span class="o">),</span> <span class="n">test_p_true</span> <span class="n">x</span><span class="o">)</span>

<span class="kd">example</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">256</span><span class="o">),</span> <span class="n">test_p_true</span> <span class="n">x</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">decide</span>
</code></pre></div>



<a name="310542163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310542163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Langley <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310542163">(Nov 17 2022 at 04:09)</a>:</h4>
<p><code>x &amp;&amp;&amp; 0 &lt; 2</code> is happy though.</p>



<a name="310543910"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310543910" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310543910">(Nov 17 2022 at 04:31)</a>:</h4>
<p><code>&amp;&amp;&amp;</code> is bitwise and, you don't need it for <code>Bool</code></p>



<a name="310544154"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310544154" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Langley <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310544154">(Nov 17 2022 at 04:34)</a>:</h4>
<p>Indeed, but <code>x &amp;&amp;&amp; 1 &lt; 2</code> is _true_ for all Fin 256 though (just as a dummy example). I had expected that if <code>decide</code> returns true then <code>by decide</code> would produce a proof.</p>



<a name="310544269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310544269" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310544269">(Nov 17 2022 at 04:35)</a>:</h4>
<p>I'm guessing that it's just too expensive to compute this in the kernel currently. If you use <code>#reduce</code> instead of <code>#eval</code> (which is what this code amounts to), it hits both the <code>maxRecDepth</code> limit and the <code>maxHeartbeats</code> limit</p>



<a name="310544332"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310544332" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310544332">(Nov 17 2022 at 04:36)</a>:</h4>
<p><code>by decide</code> doesn't produce a proof, it just asserts that the statement is true and the kernel has to work out why</p>



<a name="310544345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310544345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310544345">(Nov 17 2022 at 04:36)</a>:</h4>
<p>and the kernel isn't particularly good at that job, comparatively</p>



<a name="310544358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310544358" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Langley <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310544358">(Nov 17 2022 at 04:37)</a>:</h4>
<p>Ah, I see. Thanks!</p>



<a name="310544360"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310544360" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310544360">(Nov 17 2022 at 04:37)</a>:</h4>
<p>using <code>by native_decide</code> uses <code>#eval</code> instead, which scales much better but is also "cheating" in some sense</p>



<a name="310544438"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310544438" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Langley <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310544438">(Nov 17 2022 at 04:38)</a>:</h4>
<p><code>native_decide</code> brings a lot more into the set of trusted code, I assume?</p>



<a name="310544441"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310544441" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310544441">(Nov 17 2022 at 04:38)</a>:</h4>
<p>quite so</p>



<a name="310544481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310544481" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310544481">(Nov 17 2022 at 04:39)</a>:</h4>
<p>The tools for doing this with proofs are still under construction in mathlib4 but hopefully we will have something soon that can do this</p>



<a name="310544670"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/Playing%20with%20Decidable/near/310544670" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Langley <a href="https://leanprover-community.github.io/archive/stream/113489-new-members/topic/Playing.20with.20Decidable.html#310544670">(Nov 17 2022 at 04:42)</a>:</h4>
<p>It was fun to play around with, thank you!</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>