---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html">RFC: porting strategies</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="248243223"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248243223" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248243223">(Aug 03 2021 at 16:12)</a>:</h4>
<p>As many of you know, <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> and I have been working on automated porting tools. The two main tools are:</p>
<ul>
<li>binport: produces lean4 <code>.olean</code> files from lean3 <code>.tlean</code> files</li>
<li>synport: produces lean4 <code>.lean</code> files from lean3 <code>.ast.json</code> files, that look great but will not elaborate/type-check in general</li>
</ul>
<p>We are starting to think about both how best to connect them and how best to structure the overall porting effort. There are many possible strategies, for example:</p>
<ol>
<li>
<p>"top-down"</p>
<ul>
<li>produce <code>.olean</code> files from binport</li>
<li>working backwards from the leaves:<ul>
<li>produce non-working <code>.lean</code> file from synport that imports the previous binported files</li>
<li>tweak it manually so it elaborates</li>
<li>replace the binport <code>.olean</code> with the new <code>.lean</code> file</li>
</ul>
</li>
</ul>
</li>
<li>
<p>"bottom-up"</p>
<ul>
<li>start from the beginning (as in Mathlib4 repo currently)</li>
<li>in dependency order:<ul>
<li>produce non-working <code>.lean</code> file from synport that imports only working <code>.lean</code> files</li>
<li>tweak it manually so it elaborates</li>
</ul>
</li>
</ul>
</li>
<li>
<p>"parallel"</p>
<ul>
<li>produce <code>.olean</code> files from binport</li>
<li>stage 1: in parallel,<ul>
<li>produce non-working <code>.lean</code> file from synport that imports the previous <em>binported</em> files</li>
<li>tweak it manually so it elaborates</li>
</ul>
</li>
<li>stage 2: in parallel,<ul>
<li>replace the binportted <code>.oleans</code> with the working <code>.lean</code> files, and propagate the changes forward as necessary</li>
</ul>
</li>
</ul>
</li>
<li>
<p>"hybrid"</p>
<ul>
<li>somehow interleave manual + binport, and introduce new commands that add new rules/alignments to binport</li>
</ul>
</li>
</ol>
<p>Notes:</p>
<ul>
<li>
<p>All strategies have "-sorry" variants, where nontrivial proofs are <code>sorry</code>ed out until the final, parallel stage. Microsoft is prepared to run <strong>a lot</strong> of proof search to fill in these gaps. It might not be all that hard, since we have the original tactic scripts and the binported kernel terms, and we can mine a lot of useful hints from both.</p>
</li>
<li>
<p>There are also opportunities to use binport to help generate better <code>.lean</code> files. For example, <code>binport</code> can be used to delaborate defs/theorem statements to guarantee roundtripping. The new delaborator (<a href="https://github.com/leanprover/lean4/pull/575">https://github.com/leanprover/lean4/pull/575</a>) has a very high roundtrip success rate while staying concise in general. However, this approach is complicated by the fact that the binported terms won't in general be exactly def-eq to the terms desired in the <code>.lean</code> file. Some things will delab in undesirable ways, e.g. definitions compiled by lean3's equation compiler.</p>
</li>
<li>
<p>It is also not clear how to structure the repositories, and this depends on which strategy is adopted. For example, all approaches require synport to depend on binport (for resolving/translating names), automatic proof-patching must depend on <code>Mathlib/Tactic</code>, and the hybrid approach requires Mathlib4 and binport to be mutually dependent.</p>
</li>
<li>
<p>We can gather more empirical information before we make any big decisions. For example, for simple binport-enhanced synport, how many squigglies are there outside of proofs? When using the binported <code>.olean</code>s, how problematic are the "weird" binport relics (e.g. definitions compiled with lean3's equation compiler)?</p>
</li>
</ul>



<a name="248244820"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248244820" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248244820">(Aug 03 2021 at 16:25)</a>:</h4>
<p>Is it possible to have an Okazaki fragments like approach, for the "parallel" (3) approach? That is, select landmark files as ones that are prioritized for having in <code>.lean</code> format. Those could be tactics, or highly imported files (finset, big_operators). Those are made in <code>.lean</code>, relying on imported <code>.oleans</code>. Then we work backward to port the imported <code>.oleans</code> to <code>.lean</code>.</p>
<p>This is different than just the "bottom-up" approach because once we have a good baseline of tactics/notations, the second-level porting might go smoother. We'd also find corner cases sooner with this approach than a pure "bottom-up" approach.</p>



<a name="248245631"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248245631" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248245631">(Aug 03 2021 at 16:32)</a>:</h4>
<p>Daniel, where do you see the non-trivial tactic writing happening in those scenario? I mean <code>ring</code>, <code>linarith</code>, <code>abel</code>, <code>tidy</code>, <code>norm_cast</code>...</p>



<a name="248245763"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248245763" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248245763">(Aug 03 2021 at 16:33)</a>:</h4>
<p>The top-down approach looks like it minimizes the risk of divergence. But probably we can't decide on the best strategy without trying a bit of top-down and a bit of bottom-up.</p>



<a name="248246175"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248246175" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248246175">(Aug 03 2021 at 16:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248245631">said</a>:</p>
<blockquote>
<p>Daniel, where do you see the non-trivial tactic writing happening in those scenario? I mean <code>ring</code>, <code>linarith</code>, <code>abel</code>, <code>tidy</code>, <code>norm_cast</code>...</p>
</blockquote>
<p>Most of these (or alternatives/variants) will need to be written. When their absence will become a brick wall depends on the porting strategy adopted. For example, we can squeak by without them for a while longer if we adopt a <code>sorry</code>-variant approach and worry about the proofs in a second pass.</p>



<a name="248246447"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248246447" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248246447">(Aug 03 2021 at 16:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248245763">said</a>:</p>
<blockquote>
<p>The top-down approach looks like it minimizes the risk of divergence. But probably we can't decide on the best strategy without trying a bit of top-down and a bit of bottom-up.</p>
</blockquote>
<p>Yes, I think "top-down" is the most incremental and the least risky. It also maintains the invariant that there is a working (if not easily refactorable) Mathlib4.</p>



<a name="248246519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248246519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248246519">(Aug 03 2021 at 16:39)</a>:</h4>
<blockquote>
<p>We can gather more empirical information before we make any big decisions. For example, for simple binport-enhanced synport, how many squigglies are there outside of proofs?</p>
</blockquote>
<p>I think this is an important question.  Can you make a repo with the output of the "basic" binport-enhanced synport?</p>



<a name="248246667"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248246667" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248246667">(Aug 03 2021 at 16:40)</a>:</h4>
<p>Another big question (but maybe this was already answered and I missed that): what is the current status of the "old structure command debate"? Did we decide anything? What are the porting tools producing?</p>



<a name="248246761"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248246761" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248246761">(Aug 03 2021 at 16:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248246667">said</a>:</p>
<blockquote>
<p>Another big question (but maybe this was already answered and I missed that): what is the current status of the "old structure command debate"? Did we decide anything? What are the porting tools producing?</p>
</blockquote>
<p>Leo is investigating whether there is a sub-astronomically-complicated way of supporting efficient structure-nesting in lean4's structure command.</p>



<a name="248246934"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248246934" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248246934">(Aug 03 2021 at 16:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248246667">said</a>:</p>
<blockquote>
<p>What are the porting tools producing?</p>
</blockquote>
<p>Binport merely translates the kernel terms, which are whatever was produced by lean3. Synport is (at best) producing some kind of <code>structure</code> syntax that won't elaborate.</p>



<a name="248247030"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248247030" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248247030">(Aug 03 2021 at 16:44)</a>:</h4>
<p>We will hit that issue <em>very</em> soon, whatever the strategy.</p>



<a name="248248266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248248266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248248266">(Aug 03 2021 at 16:54)</a>:</h4>
<p>Ultimately all of these strategies have the same flag-day problem I think.  We can't change the parts we've already ported or this will mess up the porting tools.  No matter whether we do top-down or bottom-up, we'll need to essentially freeze mathlib3 when we seriously start the port.  (Or, phrased differently, manually port all PRs made after the flag day.)</p>



<a name="248248689"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248248689" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248248689">(Aug 03 2021 at 16:57)</a>:</h4>
<blockquote>
<p>"top-down"</p>
</blockquote>
<p>This requires that synport correctly translates pretty much all of the mathlib stuff (and in exactly the same way that the mathlib4 tactics expect):</p>
<ul>
<li>locales</li>
<li>auto-params</li>
<li>simps</li>
</ul>
<p>Replacing the binported olean with the tweaked lean file almost certainly requires fixing up the reverse dependencies.  This could very well be a quadratic cost.</p>



<a name="248249074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248249074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248249074">(Aug 03 2021 at 17:00)</a>:</h4>
<blockquote>
<p>"bottom-up"</p>
</blockquote>
<p>This is somewhat appealing because of the tactics.  We could first port the basic stuff, then the tactics, then the rest.  synport could then use the new oleans to delaborate the tactics proofs (in the rest part).</p>
<p>That said, I think it is completely infeasible to write "ABI-compatible" Lean 4 files.  synport would most likely fail to combine the newly compiled oleans with the remaining binported oleans.</p>



<a name="248250322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248250322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248250322">(Aug 03 2021 at 17:10)</a>:</h4>
<blockquote>
<p>where nontrivial proofs are sorryed out until the final, parallel stage.</p>
</blockquote>
<p>I think it's important that the proofs are in the ported files, even if they don't compile.  Concretely, I'd prefer a <code>sorrying (by simp)</code> over <code>sorry</code>, where <code>sorrying stx</code> elaborates to <code>sorry</code> and ignores <code>stx</code>.</p>
<p>Manually fixing up proofs is much easier if you don't have to hunt down the original version in mathlib and copy it to mathlib4.</p>



<a name="248272225"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248272225" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248272225">(Aug 03 2021 at 19:59)</a>:</h4>
<p>What would be even greater would be to have a way to record the Lean 3 tactic state, but I don't see how to do that without having a <em>lot</em> of comments in the auto-ported code.</p>



<a name="248273382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248273382" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248273382">(Aug 03 2021 at 20:07)</a>:</h4>
<p>If auto-generated Lean 4 source files included references to Lean 3 source locations, and it would be useful, we could probably add a (temporary, hacky) go-to-def that jumps to the right mathlib3 position.</p>



<a name="248277218"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248277218" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248277218">(Aug 03 2021 at 20:38)</a>:</h4>
<p>the ast jsons that synport makes do store all the position information, so that is probably doable</p>



<a name="248277253"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248277253" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248277253">(Aug 03 2021 at 20:39)</a>:</h4>
<p>(well, only the starts of things sadly... but that's good enough for this case)</p>



<a name="248277298"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248277298" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248277298">(Aug 03 2021 at 20:39)</a>:</h4>
<p>I'm quite in favour of <code>sorry</code>ing a lot of things and seeing how it goes from there</p>



<a name="248280565"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248280565" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248280565">(Aug 03 2021 at 21:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248248689">said</a>:</p>
<blockquote>
<blockquote>
<p>"top-down"</p>
</blockquote>
<p>This requires that synport correctly translates pretty much all of the mathlib stuff (and in exactly the same way that the mathlib4 tactics expect):</p>
<ul>
<li>locales</li>
<li>auto-params</li>
<li>simps</li>
</ul>
</blockquote>
<p>We want to support all of this anyway. Tactics are being manually ported so in the same way there will be extensions to support mathlib-specific automation whether it goes via attributes or user commands.</p>
<blockquote>
<p>Replacing the binported olean with the tweaked lean file almost certainly requires fixing up the reverse dependencies. This could very well be a quadratic cost.</p>
</blockquote>
<p>We're thinking about <code>#align</code> annotations on tweaked mathlib files to keep binport from diverging too badly.</p>
<blockquote>
<p>Manually fixing up proofs is much easier if you don't have to hunt down the original version in mathlib and copy it to mathlib4.</p>
</blockquote>
<p>Currently synport will print the lean 3 declaration unmodified if it encounters a fatal error during translation of an individual command, for this exact reason. (Well, actually it prints a reconstruction of the lean 3 ast, but it has access to the original span and could go look up the actual text from the original file.)</p>



<a name="248280588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248280588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248280588">(Aug 03 2021 at 21:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> said:</p>
<blockquote>
<p>What would be even greater would be to have a way to record the Lean 3 tactic state, but I don't see how to do that without having a <em>lot</em> of comments in the auto-ported code.</p>
</blockquote>
<p>It doesn't exist yet in the current version, but this is part of our "stage 2" plan. It will require some additional logging in lean 3, but I don't expect it to be too bad, and then the tactic information can be used to help guide the syntax generation. Just putting the state as comments in the ported code could work but I imagine it would be more harm than good in most cases since it's so noisy, so I would try to avoid it.</p>



<a name="248280599"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248280599" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248280599">(Aug 03 2021 at 21:03)</a>:</h4>
<p><span class="user-mention" data-user-id="128280">@Wojciech Nawrocki</span> said:</p>
<blockquote>
<p>If auto-generated Lean 4 source files included references to Lean 3 source locations, and it would be useful, we could probably add a (temporary, hacky) go-to-def that jumps to the right mathlib3 position.</p>
</blockquote>
<p>That would be great, but requires some support from the server (so maybe I should ask you?). How about an attribute like <code>@[link "mathlib/src/foo.lean" 20 1]</code> that can be attached to a definition, such that ctrl-clicking on <code>link</code> takes you to the specified location? Then mathport could generate those on each declaration.</p>



<a name="248281159"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248281159" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248281159">(Aug 03 2021 at 21:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248280588">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> said:</p>
<blockquote>
<p>What would be even greater would be to have a way to record the Lean 3 tactic state, but I don't see how to do that without having a <em>lot</em> of comments in the auto-ported code.</p>
</blockquote>
<p>It doesn't exist yet in the current version, but this is part of our "stage 2" plan. It will require some additional logging in lean 3, but I don't expect it to be too bad, and then the tactic information can be used to help guide the syntax generation. Just putting the state as comments in the ported code could work but I imagine it would be more harm than good in most cases since it's so noisy, so I would try to avoid it.</p>
</blockquote>
<p>what's the plan for this? would probably be nice for Alectryon, too</p>



<a name="248283941"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248283941" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248283941">(Aug 03 2021 at 21:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248280599">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> said:</p>
<blockquote>
<p>If auto-generated Lean 4 source files included references to Lean 3 source locations, and it would be useful, we could probably add a (temporary, hacky) go-to-def that jumps to the right mathlib3 position.</p>
</blockquote>
<p>That would be great, but requires some support from the server (so maybe I should ask you?). How about an attribute like <code>@[link "mathlib/src/foo.lean" 20 1]</code> that can be attached to a definition, such that ctrl-clicking on <code>link</code> takes you to the specified location? Then mathport could generate those on each declaration.</p>
</blockquote>
<p>Definitely possible. We currently require that declarations we jump to come from a "real" Lean module, but this could be (hopefully temporarily) relaxed to arbitrary files.</p>



<a name="248284815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248284815" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248284815">(Aug 03 2021 at 21:40)</a>:</h4>
<p>The mechanism here is more like an unstructured hyperlink, like the kind you find in markdown links in comments. I don't see why there should be any connection to "real" lean modules, and I also don't think it needs to be a temporary thing - having generic links is useful for lots of things</p>



<a name="248284938"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248284938" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248284938">(Aug 03 2021 at 21:41)</a>:</h4>
<p>it doesn't have to be triggered by "go to definition" if that helps</p>



<a name="248286163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248286163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248286163">(Aug 03 2021 at 21:55)</a>:</h4>
<p>Oh, then in VSCode you can just put the link in a comment (say line number is 10):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c1">-- file:///path/to/file#10</span>
</code></pre></div>
<p>For arbitrary editors I guess we'd need server support.</p>



<a name="248286894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248286894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248286894">(Aug 03 2021 at 22:03)</a>:</h4>
<p>one sadness is that the links will probably be machine-specific, so they aren't likely to make it to PR'd mathlib4 files</p>



<a name="248287383"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248287383" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248287383">(Aug 03 2021 at 22:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248272225">said</a>:</p>
<blockquote>
<p>What would be even greater would be to have a way to record the Lean 3 tactic state, but I don't see how to do that without having a <em>lot</em> of comments in the auto-ported code.</p>
</blockquote>
<p>An easier solution is just to have 2 editors open: one with a compiled mathlib3 proof (so you can step through the tactic state) and one with a broken mathlib4 proof. I do that regularly for big refactors, too.</p>



<a name="248444010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248444010" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248444010">(Aug 05 2021 at 06:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248286894">said</a>:</p>
<blockquote>
<p>one sadness is that the links will probably be machine-specific, so they aren't likely to make it to PR'd mathlib4 files</p>
</blockquote>
<p>could/would making the paths relative help?</p>



<a name="248445345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248445345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248445345">(Aug 05 2021 at 07:16)</a>:</h4>
<p>One perhaps crazy idea; what if the lean 4 code was inserted as special comments into the lean 3 code, and extracted and tested as part of the CI process. This would ensure it can't diverge from the lean 3 version, and would allow lean3 development to continue in parallel, so long as PR authors also moved around / fixed the corresponding lean 4 code. There'd still be a flag day, but on that day all that happens is the lean3 code and lean 4 comment markers are removed.</p>



<a name="248445960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248445960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248445960">(Aug 05 2021 at 07:25)</a>:</h4>
<p>That also has the bonus off leaving behind a useful git history for mathlib that makes tracking blames through the lean4 switch not a complete pain</p>



<a name="248485163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248485163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248485163">(Aug 05 2021 at 14:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248248266">said</a>:</p>
<blockquote>
<p>Ultimately all of these strategies have the same flag-day problem I think.  We can't change the parts we've already ported or this will mess up the porting tools.  No matter whether we do top-down or bottom-up, we'll need to essentially freeze mathlib3 when we seriously start the port.  (Or, phrased differently, manually port all PRs made after the flag day.)</p>
</blockquote>
<p>Suppose we do top-down. Once doing new things in lean4 with binported oleans is almost as easy as doing new things in lean3, we could define a border: new files go in Mathlib4, old files are changed in lean3 and only when absolutely necessary. Binport would be re-run when this happens. Every successful top-down lean4 <code>.lean</code> file generated (by synport + automation + delab + humans) would shift the border.</p>



<a name="248485858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248485858" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248485858">(Aug 05 2021 at 14:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248248689">said</a>:</p>
<blockquote>
<p>Replacing the binported olean with the tweaked lean file almost certainly requires fixing up the reverse dependencies.  This could very well be a quadratic cost.</p>
</blockquote>
<p>I agree that this is a concern. Two thoughts:</p>
<ul>
<li>A lot of the 'not-necessarily-strictly-defeq' changes will probably not require any changes downstream. For example, replacing binported equation-compiler definitions/lemmas with the lean4 ones may be transparent. </li>
<li>Perhaps this is a good argument for a sorry-staged approach, so that at least any quadratic changes do not break proofs.</li>
</ul>



<a name="248486568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248486568" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248486568">(Aug 05 2021 at 14:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248445345">said</a>:</p>
<blockquote>
<p>would allow lean3 development to continue in parallel, so long as PR authors also moved around / fixed the corresponding lean 4 code. </p>
</blockquote>
<p>I think that aiming to continue parallel development of mathlib in Lean 3 is a catastrophic idea. The porting problem is already hard enough, and we will need every available quantum of energy to work on porting or cleaning up the auto-port.</p>



<a name="248488729"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248488729" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248488729">(Aug 05 2021 at 14:54)</a>:</h4>
<blockquote>
<p>I think that aiming to continue parallel development of mathlib in Lean 3 is a catastrophic idea</p>
</blockquote>
<p>Isn't the alternative to throw away every open PR that exists on "flag day"? We certainly shouldn't encourage parallel development, but I expect there are or will be users interested in finishing up their old contributions with zero interest in helping with porting. With my suggestion, the lean 4 porters would be able to continue with their porting, and attach via automated tools a <code>@[lean4 /-" lean4 code here "-/]</code> attribute or similar to the definitions from new lean3 PRs whenever they feel like it.</p>



<a name="248490273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248490273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248490273">(Aug 05 2021 at 15:05)</a>:</h4>
<p>I honestly think we should stop reviewing PRs on flag day.</p>



<a name="248490585"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248490585" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248490585">(Aug 05 2021 at 15:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies/near/248490273">said</a>:</p>
<blockquote>
<p>I honestly think we should stop reviewing PRs on flag day.</p>
</blockquote>
<p>In the "border" proposal, mathlib3 would only accept PRs that (a) only touched files on the lean3 side of the border and (b) were motivated by the lean4 side, i.e. various kinds of backports.</p>



<a name="248490907"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248490907" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248490907">(Aug 05 2021 at 15:09)</a>:</h4>
<p>I agree, but I don't think this is what Eric had in mind.</p>



<a name="248492148"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/248492148" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#248492148">(Aug 05 2021 at 15:18)</a>:</h4>
<p>I have pretty strong feelings about this. Almost every current significant contributer to mathlib started contributing at a time when it was perfectly clear that Lean 4 was coming and that porting mathlib would be a huge task. As far as I understand we still don't have any guarantee that the easiest way won't be to redo everything from scratch (and we won't know for sure before the port is over). Almost everybody knew this (or at least should have understood this) before starting. So I think that having a total freeze time would be much <em>much</em> better than the expectation.</p>



<a name="249536149"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/RFC%3A%20porting%20strategies/near/249536149" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/RFC.3A.20porting.20strategies.html#249536149">(Aug 15 2021 at 23:44)</a>:</h4>
<p>I agree with Patrick here. mathlib3 is a dead-end, and its only long-term value is in helping us build mathlib4. (Well... I guess Lean4 could fail and mathematicians could conceivably keep using mathlib3, but this is a very bad outcome.)</p>
<p>Obviously at this point we're not ready to close mathlib3 to new content PRs, nor do we even have much of an estimate of when that day might usefully come. We would probably want to do a merge sprint around the time of "flag day", where we stop allowing new content PRs, and then triage the existing PRs --- get everything merged that can be in reasonable time, and then close (ie abandon forever) all the remaining <code>WIP</code>, <code>help-wanted</code>, <code>please-adopt</code> etc PRs. Some of that work --- taking a hard look at the full list of PRs and saying to authors "now or never" --- can begin already.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>