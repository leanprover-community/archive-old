---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/lake.20get-cache.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html">lake get-cache</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="316936698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/316936698" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#316936698">(Dec 20 2022 at 12:16)</a>:</h4>
<p>How far are we from <code>lake get-cache</code>? Switching branches and running <code>lake build</code> is quite time consuming.</p>



<a name="316961058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/316961058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#316961058">(Dec 20 2022 at 14:19)</a>:</h4>
<p>Is it going to be a general <code>lake</code> command or a Mathlib specific script (<code>lake run get_cache</code>)?<br>
My two cents:</p>
<ul>
<li>I don't think many (if any) other Lean 4 projects will implement caching as mathlib does, so implementing it as a <code>lake</code> command <em>may</em> be a bit wasteful</li>
<li>Mathlib maintainers will have much more freedom to adjust the script if it's a Mathlib self-contained thing</li>
<li><em>If</em> caching becomes a popular thing among Lean 4 projects someday, then upstreaming it to <code>lake</code> can become a more worthwhile effort</li>
</ul>
<p>Implementing it as a <code>lake</code> command has more complexities because it has to be more generic. For instance, the host might be a different one from Azure (a host config parameter enters the arena)</p>



<a name="316964074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/316964074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Shreyas Srinivas <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#316964074">(Dec 20 2022 at 14:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/316961058">said</a>:</p>
<blockquote>
<p>Is it going to be a general <code>lake</code> command or a Mathlib specific script (<code>lake run get_cache</code>)?<br>
My two cents:</p>
<ul>
<li>I don't think many (if any) other Lean 4 projects will implement caching as mathlib does, so implementing it as a <code>lake</code> command <em>may</em> be a bit wasteful</li>
<li>Mathlib maintainers will have much more freedom to adjust the script if it's a Mathlib self-contained thing</li>
<li><em>If</em> caching becomes a popular thing among Lean 4 projects someday, then upstreaming it to <code>lake</code> can become a more worthwhile effort</li>
</ul>
<p>Implementing it as a <code>lake</code> command has more complexities because it has to be more generic. For instance, the host might be a different one from Azure (a host config parameter enters the arena)</p>
</blockquote>
<p>This might not be true. Aren't there projects like <code>scilib</code> etc which might eventually get large enough? Other communities might benefit from <code>lean</code>. I can imagine theoretical CS folks building their own <code>tcslib</code> in the not too distant future. I am writing a tool  that might get large for a formal verification project in lean and I can imagine this will be useful for me.</p>



<a name="316964724"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/316964724" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#316964724">(Dec 20 2022 at 14:36)</a>:</h4>
<p>Right now the difference is that mathlib4 has many people working on it right now, and the other projects do not. I agree that in the future this might change in the sense that other projects might also get a lot of momentum, but mathlib4 is an extremely high priority project for lots of reasons.</p>



<a name="316965235"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/316965235" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#316965235">(Dec 20 2022 at 14:38)</a>:</h4>
<p>We agree that it can be useful, but I see it as an overengineering decision at this point in which mathlib folks can benefit from it <em>today</em>. There needs to be more discussions around caching as a <code>lake</code> command. For instance, mathlib pushes content to Azure via a bash script that runs after merges. I doubt that would be the solution inherited by a generic <code>lake</code> command. (a <code>lake push-cache</code> command enters the arena)</p>



<a name="316965835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/316965835" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#316965835">(Dec 20 2022 at 14:41)</a>:</h4>
<p>I agree that it would be better to have a <code>ml4-get-cache.sh</code> now rather then waiting 3 weeks for a <code>lake get-cache</code>.</p>



<a name="316969552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/316969552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#316969552">(Dec 20 2022 at 14:57)</a>:</h4>
<p>it might still be <code>lake run get_cache</code> though since you probably want that script to integrate with lake in some ways</p>



<a name="316999912"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/316999912" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Shreyas Srinivas <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#316999912">(Dec 20 2022 at 17:25)</a>:</h4>
<p>Makes sense to prioritise mathlib. <br>
A question out of curiosity: Is there a solution to this issue along the lines of  make?</p>



<a name="317001411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317001411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Shreyas Srinivas <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317001411">(Dec 20 2022 at 17:32)</a>:</h4>
<p>Something along the following lines of calling make from inside the lakefile</p>



<a name="317002110"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317002110" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Shreyas Srinivas <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317002110">(Dec 20 2022 at 17:36)</a>:</h4>
<p>then calling lean inside the make files with the target being the corresponding object file. I don't know enough about lake to make a meaningful conclusion about this possibility, hence the question.</p>



<a name="317002986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317002986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317002986">(Dec 20 2022 at 17:40)</a>:</h4>
<p>Lake scripts run in <code>IO</code> already. It's simpler to write a single Lake script that does it all, even if it calls <code>curl</code> indirectly</p>



<a name="317003312"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317003312" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Shreyas Srinivas <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317003312">(Dec 20 2022 at 17:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317002986">said</a>:</p>
<blockquote>
<p>Lake scripts run in <code>IO</code> already. It's simpler to write a single Lake script that does it all, even if it calls <code>curl</code> indirectly</p>
</blockquote>
<p>I am framing the usage of makefiles as a quick and dirty fix. lake being a build tool is likely to have access to ways of calling external commands.</p>



<a name="317003696"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317003696" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Shreyas Srinivas <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317003696">(Dec 20 2022 at 17:44)</a>:</h4>
<p>But I see your point. Doing it inside lake scripts might be advantageous</p>



<a name="317004129"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317004129" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Shreyas Srinivas <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317004129">(Dec 20 2022 at 17:46)</a>:</h4>
<p>and also the remote cache solution will save the necessity of the first build as well. A few minutes ago I was watching the build process take &gt; 18 minutes on the CI as it was apparently rebuilding every file (taking longer for some files).  This seems wasteful.</p>



<a name="317004630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317004630" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317004630">(Dec 20 2022 at 17:49)</a>:</h4>
<p>I find writing Lean code as easy (if not easier) than handling makefiles. It depends on the programmer, but as far as I can see, a Lake script is just as "quick and dirty" in this sense</p>



<a name="317019638"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317019638" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317019638">(Dec 20 2022 at 19:07)</a>:</h4>
<p>Since nobody has volunteered so far, I will do it as soon as I finish a task I'm currently working on</p>



<a name="317054810"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317054810" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317054810">(Dec 20 2022 at 22:53)</a>:</h4>
<p>Please don't let perfect be the enemy of good (any caching solution is better than what we have now), but for discussion:</p>
<p>I'd love to see the following behaviour for a cache retrieving function:</p>
<ul>
<li>Hash the contents of <code>lakefile.lean</code> <code>lake-manifest.json</code> and <code>lean-toolchain</code> (and possibly any information about hardware architecture that makes oleans non-platform independent). Call that the root hash</li>
<li>For each lean file, combine the root hash, the hash of each imported file (in the same project), and the hash of the contents of the file, and call that the file hash.</li>
<li>Send a request to a server with a list of all the hashes in current build job.</li>
<li>Get back build artifacts for some subset (ideally everything, but take what you can get) of those.</li>
<li>Build everything else, sending the resulting built artifacts back to the server.</li>
</ul>
<p>In a zeroth approximation we would do no verification of the submitted build artifacts whatsoever. :-)</p>



<a name="317054902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317054902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317054902">(Dec 20 2022 at 22:54)</a>:</h4>
<p>(i.e. roll our own minimal nix)</p>



<a name="317059052"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317059052" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317059052">(Dec 20 2022 at 23:27)</a>:</h4>
<p>I haven't started yet, but I am wondering if I should really use a Lake script since there isn't a self-contained solution for http requests. I will probably just do it in Python</p>



<a name="317059822"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317059822" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317059822">(Dec 20 2022 at 23:34)</a>:</h4>
<p>Can't you just call <code>curl</code> or something?</p>



<a name="317059864"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317059864" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317059864">(Dec 20 2022 at 23:34)</a>:</h4>
<p>I can but I don't know if it would work for Windows users</p>



<a name="317059903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317059903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317059903">(Dec 20 2022 at 23:35)</a>:</h4>
<p>(would it?)</p>



<a name="317060894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317060894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317060894">(Dec 20 2022 at 23:45)</a>:</h4>
<p>Okay, I'll call <code>curl</code> then. If anything, it can be changed later</p>



<a name="317062809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317062809" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sky Wilshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317062809">(Dec 21 2022 at 00:03)</a>:</h4>
<p><code>curl</code> does technically work on Windows, but depends on weird internet explorer stuff (which is susceptible to breakage) if I'm remembering correctly.</p>



<a name="317062844"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317062844" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sky Wilshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317062844">(Dec 21 2022 at 00:03)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">❯</span> <span class="n">curl</span> <span class="n">https</span><span class="o">:</span><span class="bp">//</span><span class="n">www.google.com</span>
<span class="n">curl</span> <span class="o">:</span> <span class="n">The</span> <span class="n">response</span> <span class="n">content</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">parsed</span> <span class="n">because</span> <span class="n">the</span> <span class="n">Internet</span> <span class="n">Explorer</span> <span class="n">engine</span> <span class="n">is</span> <span class="n">not</span> <span class="n">available</span><span class="o">,</span> <span class="n">or</span> <span class="n">Internet</span> <span class="n">Explorer's</span> <span class="n">first</span><span class="bp">-</span><span class="n">launch</span> <span class="n">configuration</span> <span class="n">is</span> <span class="n">not</span> <span class="n">complete.</span> <span class="n">Specify</span> <span class="n">the</span> <span class="n">UseBasicParsing</span> <span class="kd">parameter</span> <span class="n">and</span> <span class="n">try</span> <span class="n">again.</span>
<span class="n">At</span> <span class="n">line</span><span class="o">:</span><span class="mi">1</span> <span class="n">char</span><span class="o">:</span><span class="mi">1</span>
<span class="bp">+</span> <span class="n">curl</span> <span class="n">https</span><span class="o">:</span><span class="bp">//</span><span class="n">www.google.com</span>
<span class="bp">+</span> <span class="bp">~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
    <span class="bp">+</span> <span class="n">CategoryInfo</span>          <span class="o">:</span> <span class="n">NotImplemented</span><span class="o">:</span> <span class="o">(:)</span> <span class="o">[</span><span class="n">Invoke</span><span class="bp">-</span><span class="n">WebRequest</span><span class="o">],</span> <span class="n">NotSupportedException</span>
    <span class="bp">+</span> <span class="n">FullyQualifiedErrorId</span> <span class="o">:</span> <span class="n">WebCmdletIEDomNotSupportedException</span><span class="o">,</span><span class="n">Microsoft.PowerShell.Commands.InvokeWebRequestCommand</span>
</code></pre></div>



<a name="317064180"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317064180" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317064180">(Dec 21 2022 at 00:18)</a>:</h4>
<p>The lakefile will get pretty dirty. Should I make separate executables that can be run with <code>lake exe get-cache</code> or something?</p>



<a name="317065408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317065408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317065408">(Dec 21 2022 at 00:31)</a>:</h4>
<p>(I will do it because some possibilities open up and dev time will be shorter)</p>



<a name="317070393"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317070393" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317070393">(Dec 21 2022 at 01:30)</a>:</h4>
<p>Alright, I was able to efficiently hash all relevant Lean files. Can someone point me to a place where I can check how to push and get files to/from the Azure server?</p>



<a name="317071392"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317071392" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317071392">(Dec 21 2022 at 01:45)</a>:</h4>
<p>I can get you a blob storage on our Azure account.  Do you like the name <code>mathlib4cache</code>?</p>



<a name="317071467"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317071467" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317071467">(Dec 21 2022 at 01:46)</a>:</h4>
<p>Or are you looking for API docs? <a href="https://learn.microsoft.com/en-us/rest/api/storageservices/put-blob">https://learn.microsoft.com/en-us/rest/api/storageservices/put-blob</a></p>



<a name="317071501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317071501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317071501">(Dec 21 2022 at 01:47)</a>:</h4>
<p>Both actually</p>



<a name="317071589"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317071589" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317071589">(Dec 21 2022 at 01:49)</a>:</h4>
<p>This is the current status of the code btw: <a href="https://github.com/leanprover-community/mathlib4/blob/ap/caching/Caching/Utils.lean">https://github.com/leanprover-community/mathlib4/blob/ap/caching/Caching/Utils.lean</a></p>



<a name="317071714"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317071714" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317071714">(Dec 21 2022 at 01:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317071392">said</a>:</p>
<blockquote>
<p>I can get you a blob storage on our Azure account.  Do you like the name <code>mathlib4cache</code>?</p>
</blockquote>
<p>Please let me know the URL once that's done <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="317073244"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317073244" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317073244">(Dec 21 2022 at 02:14)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> , sorry I didn't suggest this earlier, but could you investigate whether you can use <code>Lake.computeTrace</code>?</p>



<a name="317073297"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317073297" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317073297">(Dec 21 2022 at 02:14)</a>:</h4>
<p>Reusing infrastructure from <code>lake</code>, even if we're not planning on modifying lake itself in the short term, seems like a win.</p>



<a name="317074411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317074411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317074411">(Dec 21 2022 at 02:31)</a>:</h4>
<p>What does that function do?</p>



<a name="317074650"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317074650" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317074650">(Dec 21 2022 at 02:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317059052">said</a>:</p>
<blockquote>
<p>I haven't started yet, but I am wondering if I should really use a Lake script since there isn't a self-contained solution for http requests. I will probably just do it in Python</p>
</blockquote>
<p>Fwiw <code>Socket.lean</code> has a <a href="https://github.com/xubaiw/Socket.lean/tree/main/examples/http-client">HTTP client example</a> although the library seems pretty experimental.</p>



<a name="317074788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317074788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317074788">(Dec 21 2022 at 02:37)</a>:</h4>
<p>Yeah, <code>curl</code> will make the code more stable and robust though</p>



<a name="317075282"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317075282" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317075282">(Dec 21 2022 at 02:45)</a>:</h4>
<blockquote>
<p>Fwiw Socket.lean has a HTTP client example although the library seems pretty experimental.</p>
</blockquote>
<p>I just want to say out loud that this implementation is completely unsuitable for production.  It doesn't do TLS, happy eyeballs or even just multiple A records, or really anything one might expect from an HTTP client.</p>



<a name="317078965"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317078965" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317078965">(Dec 21 2022 at 03:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317074411">said</a>:</p>
<blockquote>
<p>What does that function do?</p>
</blockquote>
<p>I'm not a lake expert, and I'm struggling to find where all the bits and pieces are, but:</p>
<ol>
<li>at <a href="https://github.com/leanprover/lake/blob/master/Lake/Build/Common.lean#L35">https://github.com/leanprover/lake/blob/master/Lake/Build/Common.lean#L35</a>, you can see that <code>Lake.computeTrace file</code> where <code>file : FilePath</code> computes <em>something</em>.</li>
<li>The lake <a href="https://github.com/leanprover/lake#glossary-of-terms">README</a> says: "A target's trace is derived from its various <strong>inputs</strong> (e.g., source file, Lean toolchain, imports, etc.)."</li>
</ol>



<a name="317079004"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317079004" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317079004">(Dec 21 2022 at 03:40)</a>:</h4>
<p>We could either experiment, or try summoning Mac. :-)</p>



<a name="317084980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317084980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317084980">(Dec 21 2022 at 05:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317054810">said</a>:</p>
<blockquote>
<ul>
<li>Build everything else, sending the resulting built artifacts back to the server.</li>
</ul>
</blockquote>
<p>I do have a bit of an uneasy feeling about this final step. Can we at least require some security check before allowing random people to upload stuff? Because the build artifacts will effectively be executed on our personal computers, so they can do random crazy shit.<br>
I guess it shouldn't be too hard to require the uploader to have write permissions to non-master branches of ml4?</p>



<a name="317087559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317087559" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317087559">(Dec 21 2022 at 05:55)</a>:</h4>
<p>I thought that was implicit, we're only going to give upload keys to trusted parties.</p>



<a name="317087680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317087680" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317087680">(Dec 21 2022 at 05:56)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> I've tried to create a new storage account and container, but this keeps failing with "Server encountered an internal error. Please try again after some time." :sigh:</p>



<a name="317088037"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317088037" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317088037">(Dec 21 2022 at 06:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317087559">said</a>:</p>
<blockquote>
<p>I thought that was implicit, we're only going to give upload keys to trusted parties.</p>
</blockquote>
<p>Sounds reasonable. :-) As long as it is possible for us to have uploads from non-central servers, I think we get most of the benefit just by allowing those uploads from maintainers. (Or some similar set.)</p>



<a name="317088070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317088070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317088070">(Dec 21 2022 at 06:00)</a>:</h4>
<p>I do an awful lot of building branches locally, then waiting for CI to do them again. :-)</p>



<a name="317097614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317097614" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Shreyas Srinivas <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317097614">(Dec 21 2022 at 07:32)</a>:</h4>
<p>Does lean have a git library? AFAIK, Scott's comments are implementable in roughly this way:</p>
<ol>
<li>Query git for the current commit/staging area and the parent commit. (Git already has the hashes Scott mentions, so why reinvent the wheel)</li>
<li>Query git for the list of files that have changed using the diff output</li>
<li>Check if lakefile.lean has changed. </li>
<li>Rebuild only the changed files. Pull either the local cache (existing build folder) or remote cache for the others</li>
</ol>



<a name="317106183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317106183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317106183">(Dec 21 2022 at 08:33)</a>:</h4>
<p>Git does not help you at all with the imports-closed file hash Scott described. Which is the right way to do it. And which indeed should correspond to Lake's trace hash.</p>



<a name="317108107"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317108107" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317108107">(Dec 21 2022 at 08:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317054810">said</a>:</p>
<blockquote>
<ul>
<li>Send a request to a server with a list of all the hashes in current build job.</li>
<li>Get back build artifacts for some subset (ideally everything, but take what you can get) of those.</li>
</ul>
</blockquote>
<p>So with a passive server these steps would likely be something like <code>curl --parallel &lt;server&gt;/&lt;trace1&gt;.olean -o build/.../foo.olean &lt;server&gt;/&lt;trace2&gt;.olean -o build/.../bar.olean ...</code>. Which apparently does the right thing of continuing even after a missing file automatically.</p>



<a name="317108357"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317108357" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317108357">(Dec 21 2022 at 08:48)</a>:</h4>
<p>Note that you'll want to cache and download the <code>.ilean</code> files as well, and have to create the corresponding <code>.trace</code> files for Lake to accept the downloaded files.</p>



<a name="317110725"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317110725" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317110725">(Dec 21 2022 at 09:03)</a>:</h4>
<p>Having to create the <code>.trace</code> files pretty much decides that we will have to use Lake's hashing, I guess!</p>



<a name="317127781"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317127781" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317127781">(Dec 21 2022 at 10:41)</a>:</h4>
<p>I was enjoying the initial hashing idea because I could cache intermediate hashes in memory. I believe Lake's tracing relies on IO to see if a trace already exists?</p>



<a name="317128559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317128559" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317128559">(Dec 21 2022 at 10:46)</a>:</h4>
<p>For example, if I want to hash file A that imports B and C but I've already hashed B and C, then I have to compute very little to hash A. Otherwise I compute what I need and cache it for future lookups.</p>
<p>How do I do that with Lake traces?</p>



<a name="317129701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317129701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317129701">(Dec 21 2022 at 10:52)</a>:</h4>
<p>I want to do this: <a href="https://github.com/leanprover-community/mathlib4/blob/0da94b48cea085f244b1b27f3d2aed81ff1cb21a/Caching/Utils.lean#L32">https://github.com/leanprover-community/mathlib4/blob/0da94b48cea085f244b1b27f3d2aed81ff1cb21a/Caching/Utils.lean#L32</a></p>



<a name="317142000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317142000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317142000">(Dec 21 2022 at 12:00)</a>:</h4>
<p>Or maybe I can just put/get trace files as well</p>



<a name="317146734"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317146734" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317146734">(Dec 21 2022 at 12:28)</a>:</h4>
<p>The only one that actually knows the ins and outs of lake is Mac, you can ping him but if he doesn't  answer its pretty much on your own to figure out.</p>



<a name="317154882"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317154882" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317154882">(Dec 21 2022 at 13:13)</a>:</h4>
<p>It's okay. I'm going with the initial solution and it's computing all the hashes blazing fast. Now I just need to sync with Gabriel about URLs and authorizations. The rest of the infra already works well</p>



<a name="317155164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317155164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317155164">(Dec 21 2022 at 13:14)</a>:</h4>
<p>This is a small piece of the generated <code>curl</code> command:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>curl --parallel https://foo/2391993928140408502.olean -o build/lib/Mathlib/Init/ZeroOne.olean https://foo/2391993928140408502.ilean -o build/lib/Mathlib/Init/ZeroOne.ilean https://foo/2391993928140408502.trace -o build/lib/Mathlib/Init/ZeroOne.trace
</code></pre></div>



<a name="317167320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317167320" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317167320">(Dec 21 2022 at 14:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317154882">said</a>:</p>
<blockquote>
<p>It's okay. I'm going with the initial solution and it's computing all the hashes blazing fast. Now I just need to sync with Gabriel about URLs and authorizations. The rest of the infra already works well</p>
</blockquote>
<p>What's your plan for making Lake accept these files then?</p>



<a name="317167792"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317167792" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317167792">(Dec 21 2022 at 14:13)</a>:</h4>
<p>I think the simplest solution would be:</p>
<ul>
<li>add an option to Lake that writes out trace files only, and also deletes old .oleans</li>
<li>try and fetch any missing oleans by their trace files</li>
<li>have Lake do a regular build to fill in any missing files</li>
</ul>



<a name="317168883"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317168883" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317168883">(Dec 21 2022 at 14:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317167320">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317154882">said</a>:</p>
<blockquote>
<p>It's okay. I'm going with the initial solution and it's computing all the hashes blazing fast. Now I just need to sync with Gabriel about URLs and authorizations. The rest of the infra already works well</p>
</blockquote>
<p>What's your plan for making Lake accept these files then?</p>
</blockquote>
<p>I'm pushing the trace files as well</p>



<a name="317169318"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317169318" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317169318">(Dec 21 2022 at 14:19)</a>:</h4>
<p>Hah, I guess that works!</p>



<a name="317171054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317171054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317171054">(Dec 21 2022 at 14:26)</a>:</h4>
<p>In a certain way, there are advantages to allowing mathlib maintainers to have a hashing algorithm that's agnostic to how Lake computes its hashes.</p>
<p>Also, I didn't look too closely but I got a little skeptical about Lake hashing files as Scott described (which I too think is the right way for our purposes). I couldn't find the piece of code that digs into the content of a source file and hashes that file according to the content of the imported files.</p>



<a name="317173922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317173922" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317173922">(Dec 21 2022 at 14:39)</a>:</h4>
<p>That's <code>Module.recBuildLean</code></p>



<a name="317174175"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317174175" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317174175">(Dec 21 2022 at 14:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317171054">said</a>:</p>
<blockquote>
<p>In a certain way, there are advantages to allowing mathlib maintainers to have a hashing algorithm that's agnostic to how Lake computes its hashes.</p>
</blockquote>
<p>I don't see how that can be helpful if Lake rebuilds anyway if the recomputed trace does not match the downloaded trace</p>



<a name="317175773"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317175773" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317175773">(Dec 21 2022 at 14:46)</a>:</h4>
<p>That would change the toolchain and thus change the root hash and all the hashes. But the advantage I'm talking about is in terms of freedom of maintenance for adaptation</p>



<a name="317176775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317176775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317176775">(Dec 21 2022 at 14:51)</a>:</h4>
<p>I don't know what toolchain you are talking about. But using a different hash for remote caching than for local recompilation checks surely is a quickfix at best and not a feature.</p>



<a name="317176942"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317176942" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317176942">(Dec 21 2022 at 14:52)</a>:</h4>
<p>Mathlib tooling should not fight against Lake</p>



<a name="317181765"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317181765" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317181765">(Dec 21 2022 at 15:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/317173922">said</a>:</p>
<blockquote>
<p>That's <code>Module.recBuildLean</code></p>
</blockquote>
<p>Does it mean that it's tied to building?</p>



<a name="317183975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317183975" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317183975">(Dec 21 2022 at 15:23)</a>:</h4>
<p>Yes, traces are currently generated during building afaik</p>



<a name="317186322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317186322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317186322">(Dec 21 2022 at 15:34)</a>:</h4>
<p>Alright, that's what I suspected because it makes so much sense to get the imports from a file by running Lean's frontend instead of fiddling with strings like I'm doing. I will go with the easier workaround for now so we don't have to build in order to know what we need to download</p>



<a name="317187134"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317187134" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317187134">(Dec 21 2022 at 15:37)</a>:</h4>
<p>In other words, I'm not dealing with stuff like</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span>
<span class="n">Lean.Data.HashMap</span>
</code></pre></div>
<p>Which is accepted by Lean</p>



<a name="317193009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317193009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317193009">(Dec 21 2022 at 16:04)</a>:</h4>
<p>No, parsing imports is separate from building the actual file. How would it ever short-circuit builds otherwise? You're looking for <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.parseImports'#doc">docs4#Lean.parseImports'</a>.</p>



<a name="317204708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317204708" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317204708">(Dec 21 2022 at 17:01)</a>:</h4>
<p>Thanks!!</p>



<a name="317536059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317536059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317536059">(Dec 23 2022 at 10:43)</a>:</h4>
<p>Hi all <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> <br>
Hashing is working efficiently and (apparently) correctly as Scott firstly described. The last piece of the puzzle is performing the actual requests, for which I'm needing some help <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span>🏼</p>



<a name="317559526"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317559526" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317559526">(Dec 23 2022 at 12:48)</a>:</h4>
<p>Our curl templates above didn't look too bad to me, what's still missing?</p>



<a name="317568260"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317568260" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317568260">(Dec 23 2022 at 13:35)</a>:</h4>
<p>The curl for <code>get</code> is formatted like that already, but it's missing the correct URL and possibly parameters to query from Azure (which I've never done before).</p>
<p>Now, for <code>put</code>, I don't know how to format it. The only thing I know is that I need to get the auth key from a file like <code>azure.key</code> or something</p>



<a name="317590273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317590273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317590273">(Dec 23 2022 at 15:23)</a>:</h4>
<p>I doubt you'll find many people on here with experience in Azure blob storage :) . But according to the docs Gabriel posted above, you mostly just need to set a few headers using <code>-H</code></p>



<a name="317656404"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/317656404" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#317656404">(Dec 23 2022 at 23:42)</a>:</h4>
<p>Is there a dummy URL I can use for testing?</p>



<a name="318024912"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318024912" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318024912">(Dec 27 2022 at 01:47)</a>:</h4>
<p>Okay, I've finally found the time to finish it: <a href="https://github.com/leanprover-community/mathlib4/pull/1230">mathlib4#1230</a></p>
<p>This PR implements caching for Mathlib build files. The basic API is:</p>
<ul>
<li><code>lake exe cache get</code> to download missing build files</li>
<li><code>lake exe cache put</code> to upload files that are missing on the server</li>
<li><code>lake exe cache</code> to print the help menu</li>
</ul>
<p>This caching method has a few enhancements on top of the solution we had for mathlib in Lean 3:</p>
<ol>
<li>Source files are content-addressed and build files are referenced by such hashes separately</li>
<li>Minimized download traffic with queries that only pull files that are missing locally</li>
<li>Minimized upload traffic with queries that only push files that are missing on the server</li>
<li>A <code>zip</code> and a <code>set</code> command that make branch switching easier, without required uploads/downloads</li>
</ol>



<a name="318028240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318028240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318028240">(Dec 27 2022 at 02:49)</a>:</h4>
<p>nice christmas present <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="318061601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318061601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318061601">(Dec 27 2022 at 09:47)</a>:</h4>
<p>Does this work for projects using mathlib?</p>



<a name="318066497"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318066497" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318066497">(Dec 27 2022 at 10:17)</a>:</h4>
<p>Not yet. I don't know if you can call <code>lake exe cache</code> on this from a different project. But even if it's possible the code needs adjustments to know whether <code>Mathlib</code> is a directory in the root folder or not</p>



<a name="318068229"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318068229" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318068229">(Dec 27 2022 at 10:27)</a>:</h4>
<p>But I don't want to worry about it for now. If anything, we can change it later. I want to avoid scope creep and get it ready to use for people doing the porting ASAP</p>



<a name="318152434"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318152434" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318152434">(Dec 27 2022 at 19:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/318024912">said</a>:</p>
<blockquote>
<p>This caching method has a few enhancements on top of the solution we had for mathlib in Lean 3:</p>
<ol start="4">
<li>A <code>zip</code> and a <code>set</code> command that make branch switching easier, without required uploads/downloads</li>
</ol>
</blockquote>
<p>I don't understand that item. What is there that wasn't in leanproject?</p>



<a name="318158482"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318158482" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318158482">(Dec 27 2022 at 20:57)</a>:</h4>
<p>Perhaps <span class="user-mention" data-user-id="451983">@Arthur Paulino</span> is not aware of lean 3's <code>mk-cache</code> (zip) and local behavior of <code>get-cache</code> (set)?</p>



<a name="318158608"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318158608" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318158608">(Dec 27 2022 at 20:58)</a>:</h4>
<p>Maybe the difference is just that <code>set</code> won't try downloading anything if a cache file isn't there</p>



<a name="318158888"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318158888" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318158888">(Dec 27 2022 at 21:01)</a>:</h4>
<p>You can configure that with a flag for lean 3, the default is to try everything</p>



<a name="318158995"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318158995" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318158995">(Dec 27 2022 at 21:02)</a>:</h4>
<p>Then there is no difference on that feature. Let me remove it from the list</p>



<a name="318165555"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318165555" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318165555">(Dec 27 2022 at 22:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/318158888">said</a>:</p>
<blockquote>
<p><del>You can configure that with a flag for lean 3, the default is to try everything</del> ok not really, only with <code>--from-url=example.com/has-no-caches</code></p>
</blockquote>
<p>Oh then it's an upgrade indeed</p>



<a name="318167685"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318167685" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318167685">(Dec 27 2022 at 22:33)</a>:</h4>
<p>Probably at best a new feature; I expect the number of people who want a cache but don't want to use ones from the server are counted on one hand</p>



<a name="318167783"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318167783" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318167783">(Dec 27 2022 at 22:34)</a>:</h4>
<p>I've already learnt that the current <code>--fallback=none</code> default in lean 3 is wanted by approximately no one (I chose it because it was backwards compatible)</p>



<a name="318171762"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318171762" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318171762">(Dec 27 2022 at 23:14)</a>:</h4>
<p>Yeah it has a very specific use. One example is working on multiple branches on a place without access to the internet</p>



<a name="318222055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318222055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318222055">(Dec 28 2022 at 09:46)</a>:</h4>
<p>That works fine in lean3, because it still always tries local caches first</p>



<a name="318222188"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318222188" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318222188">(Dec 28 2022 at 09:47)</a>:</h4>
<p>The only difference is that you get an error saying "no local cache and no internet connection" instead of "no local cache"</p>



<a name="318327083"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318327083" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318327083">(Dec 28 2022 at 21:26)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1230">mathlib4#1230</a> is ready for review again!</p>
<p>Now it also caches build files for Mathlib4 dependencies: <code>Aesop</code>, <code>Qq</code> and <code>Std</code>. And in order to make that work, I had to implement a solution that made the implementation of caching for projects that import Mathlib a lot easier. So I went ahead and just did it (cc <span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span>)</p>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> the infra for garbage collection is not ready yet, but I think people can already benefit from it.</p>



<a name="318327800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318327800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318327800">(Dec 28 2022 at 21:32)</a>:</h4>
<p>A lot changed so a new review round is super welcome. Tomorrow I will get the infra for garbage collection done (hopefully). It will just add more code, that's why a review is welcome at this point already</p>



<a name="318499518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318499518" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318499518">(Dec 29 2022 at 23:19)</a>:</h4>
<p>Just finished the implementation of <code>lake exe cache commit</code>, which stores a file that associates the current Git hash with a certain set of uploaded hashes. This will allow us to create garbage collection policies.</p>
<p>This is the output of <code>lake exe cache</code>:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>Mathlib4 caching CLI
Usage: cache [COMMAND]

Commands:
  # No priviledge required
  get       Download and decompress linked files missing on the local cache
  get!      Download and decompress all linked files
  mk        Compress non-compressed build files into the local cache
  mk!       Compress build files into the local cache (no skipping)
  set       Decompress linked files
  clear     Delete non-linked files
  clear!    Delete everything on the local cache

  # Priviledge required
  put       Run 'mk' then upload linked files missing on the server
  put!      Run 'mk' then upload all linked files
  commit    Run 'put' then writes a commit on the server
  commit!   Run 'put!' then (over)writes a commit on the server
  collect   TODO

* Linked files refer to local cache files with corresponding Lean sources
* Commands ending with '!' should be used manually, when hot-fixes are needed"
</code></pre></div>
<p>I added the <code>collect</code> to the list but maybe it shouldn't be implemented in Lean</p>



<a name="318500938"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318500938" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318500938">(Dec 29 2022 at 23:37)</a>:</h4>
<p>Just a little question, if i understand this correctly everyone can now upload cached .oleans right? Since .oleans can (I believe?) execute code via e.g. <code>initialize</code> or overwriting syntax to some custom elaborator that escapes to <code>IO</code> if I use this cache I am essentially extending attack surface of my machine to <em>every</em> person with push access to mathlib? Not that I want to claim people here have nefarious intentions, it's more of an attack surface thing. I now don't only have to trust myself to not mess stuff up but also dozens (in the future potentially more) people to not mess up themselves yes?</p>



<a name="318501057"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318501057" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jireh Loreaux <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318501057">(Dec 29 2022 at 23:38)</a>:</h4>
<p>Yes, but I think this is only intended to be a temporary measure while we are porting, but maybe I'm mistaken.</p>



<a name="318501106"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318501106" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318501106">(Dec 29 2022 at 23:39)</a>:</h4>
<p>Not everyone can do that. Only people with the token for pushing stuff</p>



<a name="318501231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318501231" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318501231">(Dec 29 2022 at 23:40)</a>:</h4>
<p>Once this is merged, I'm going to ask Gabriel to revoke the token he gave me for dev/testing purposes</p>



<a name="318501358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318501358" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318501358">(Dec 29 2022 at 23:42)</a>:</h4>
<p>Ah wait, you mean forcing the mathlib4 bot to push it for me (if I were a malicious person). Yes. That's possible</p>



<a name="318509623"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318509623" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318509623">(Dec 30 2022 at 01:28)</a>:</h4>
<p>On a second thought, malicious code would have a different hash. The only way you can run bad code is if you, yourself, fetch a branch and run it on your PC. But the vulnerability isn't on the hashing scheme. It's a vulnerability that's already present by design</p>



<a name="318509932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318509932" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318509932">(Dec 30 2022 at 01:33)</a>:</h4>
<p>The only way to make evil spread <em>via this hashing scheme</em> is by having a secret token that would allow you to overwrite olean files with malicious ones, really.</p>



<a name="318510707"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318510707" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318510707">(Dec 30 2022 at 01:45)</a>:</h4>
<blockquote>
<p>everyone can now upload cached .oleans, right?</p>
</blockquote>
<p>So, just to answer this clearly, no. Pushing data is restricted</p>



<a name="318514875"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318514875" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318514875">(Dec 30 2022 at 02:04)</a>:</h4>
<p>There is ONE genuine vulnerability: a hash collision with some malicious code whose olean was already sitting on the server!</p>



<a name="318531396"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318531396" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318531396">(Dec 30 2022 at 06:38)</a>:</h4>
<p>Nitpick: Isn't it "privilege"? or maybe my French is tricking me.</p>



<a name="318550074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318550074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318550074">(Dec 30 2022 at 09:49)</a>:</h4>
<p>No, you're right. I'll fix it, thanks!</p>



<a name="318962854"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/318962854" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#318962854">(Jan 02 2023 at 10:03)</a>:</h4>
<p><span aria-label="ping pong" class="emoji emoji-1f3d3" role="img" title="ping pong">:ping_pong:</span> <a href="https://github.com/leanprover-community/mathlib/pull/1230">mathlib#1230</a> is ready</p>



<a name="319306115"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319306115" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319306115">(Jan 04 2023 at 00:51)</a>:</h4>
<p>FYI, this command is deployed now.  On a mathlib4 checkout, you can run</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>lake exe cache get
</code></pre></div>
<p>And you should get fresh oleans!</p>



<a name="319308138"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319308138" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319308138">(Jan 04 2023 at 01:16)</a>:</h4>
<p>For those of us who are maintainers or "trusted users": are we supposed to be running some other command after local compiles, in order to upload the oleans we made?  I think it was mentioned that that might be part of the workflow?</p>



<a name="319308185"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319308185" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319308185">(Jan 04 2023 at 01:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395550">Henrik Böving</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/318500938">said</a>:</p>
<blockquote>
<p>Just a little question, if i understand this correctly everyone can now upload cached .oleans right?</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/318501106">said</a>:</p>
<blockquote>
<p>Not everyone can do that. Only people with the token for pushing stuff</p>
</blockquote>



<a name="319308925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319308925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319308925">(Jan 04 2023 at 01:26)</a>:</h4>
<p>Gabriel already set it so that it will be done by a GitHub workflow routine, like it was for mathlib in Lean 3: <a href="https://github.com/leanprover-community/mathlib4/blob/35255de060eac3fa22895d074d6a713c42f2752a/.github/workflows/bors.yml#L102">https://github.com/leanprover-community/mathlib4/blob/35255de060eac3fa22895d074d6a713c42f2752a/.github/workflows/bors.yml#L102</a></p>



<a name="319308957"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319308957" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319308957">(Jan 04 2023 at 01:26)</a>:</h4>
<p>Even better!</p>



<a name="319309195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319309195" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319309195">(Jan 04 2023 at 01:29)</a>:</h4>
<p>I haven't tested it on Windows. Please let me know if you find bugs</p>



<a name="319309198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319309198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319309198">(Jan 04 2023 at 01:29)</a>:</h4>
<p>I just tried it, it works great right out of the box. The only downside is that std is not cached, so when I pull master and then <code>lake exe cache get</code> it still has to compile all the <code>Std.*</code> files, but none of the <code>Mathlib</code> files</p>



<a name="319309325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319309325" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319309325">(Jan 04 2023 at 01:31)</a>:</h4>
<p>It caches Std, but for some reason it does that quick listing that only takes like 10 seconds</p>



<a name="319309347"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319309347" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319309347">(Jan 04 2023 at 01:31)</a>:</h4>
<p>I couldn't figure out why</p>



<a name="319309480"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319309480" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319309480">(Jan 04 2023 at 01:33)</a>:</h4>
<p>I ran <code>lake build</code> after <code>lake exe cache get</code> and it seemed to compile <code>Std</code>, it took 15 s and did not list any <code>Compiling Mathlib</code> lines</p>



<a name="319309577"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319309577" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319309577">(Jan 04 2023 at 01:34)</a>:</h4>
<p>Right, but how long would it take to go over the Std files without the cache? I think it would take a lot more</p>



<a name="319309616"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319309616" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319309616">(Jan 04 2023 at 01:34)</a>:</h4>
<p>I suspect Lake is recomputing the traces for some reason I couldn't figure out</p>



<a name="319309627"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319309627" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319309627">(Jan 04 2023 at 01:35)</a>:</h4>
<p>I see</p>



<a name="319309960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319309960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319309960">(Jan 04 2023 at 01:39)</a>:</h4>
<p>I really hope it works on Windows because that would be hard for a Linux user to debug <span aria-label="fear" class="emoji emoji-1f628" role="img" title="fear">:fear:</span></p>



<a name="319311110"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319311110" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319311110">(Jan 04 2023 at 01:53)</a>:</h4>
<blockquote>
<p>it still has to compile all the Std.* files</p>
</blockquote>
<p>While it has to <code>Compile</code> (cc) all files, it no longer has to <code>Build</code> (lean) them.  The binaries are platform-specific, so we didn't cache them.</p>



<a name="319312193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319312193" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319312193">(Jan 04 2023 at 02:04)</a>:</h4>
<p>It works beautifully for mathlib, but I haven't yet tried it for a project using mathlib as a dependency. For that will I have to  add this to my lakefile?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">lean_exe</span> <span class="n">cache</span> <span class="n">where</span>
  <span class="n">root</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">Cache.Main</span>
</code></pre></div>



<a name="319312257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319312257" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319312257">(Jan 04 2023 at 02:05)</a>:</h4>
<p>I think you can just call <code>lake exe cache get</code>. It works for LSpec, which allows us to call <code>lake exe lspec</code> from any repo that uses it</p>



<a name="319313811"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319313811" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319313811">(Jan 04 2023 at 02:19)</a>:</h4>
<p>You can call <code>lake exe cache get</code> but it fails badly:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">././</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/././</span><span class="n">Cache</span><span class="bp">/</span><span class="n">Requests.lean</span><span class="o">:</span><span class="mi">7</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">no</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span> <span class="o">(</span><span class="n">error</span> <span class="n">code</span><span class="o">:</span> <span class="mi">2</span><span class="o">)</span>
  <span class="n">file</span><span class="o">:</span> <span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">/</span><span class="n">Mathlib</span><span class="bp">/</span><span class="n">lakefile.lean</span>
</code></pre></div>



<a name="319313928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319313928" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319313928">(Jan 04 2023 at 02:21)</a>:</h4>
<p>I will take a look at it tomorrow, but this is not looking pretty. It seems to be failing to compile the <code>cache</code> executable</p>



<a name="319314005"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319314005" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319314005">(Jan 04 2023 at 02:22)</a>:</h4>
<p>I think this is just <code>Mathlib</code> vs. <code>mathlib</code>.  I think it should be enough to lowercase the mathlibDepPath.</p>



<a name="319314074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319314074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319314074">(Jan 04 2023 at 02:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319311110">said</a>:</p>
<blockquote>
<blockquote>
<p>it still has to compile all the Std.* files</p>
</blockquote>
<p>While it has to <code>Compile</code> (cc) all files, it no longer has to <code>Build</code> (lean) them.  The binaries are platform-specific, so we didn't cache them.</p>
</blockquote>
<p>I see now. It's because of the <code>runLinter</code> that's being compiled to a binary when we say <code>lake build</code> right? It relies on some Std files</p>



<a name="319314439"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319314439" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319314439">(Jan 04 2023 at 02:29)</a>:</h4>
<p>I can confirm that the result of all those <code>Compiling</code> lines was <code>Linking runLinter</code></p>



<a name="319314500"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319314500" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319314500">(Jan 04 2023 at 02:30)</a>:</h4>
<p>I think <code>runLinter</code> should probably be a bit more choosy about parts of Std it imports though</p>



<a name="319314525"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319314525" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319314525">(Jan 04 2023 at 02:31)</a>:</h4>
<p>oh I see, it imports <code>Mathlib.Data.Array.Defs</code> and of course mathlib files love to <code>import Std</code></p>



<a name="319314542"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319314542" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319314542">(Jan 04 2023 at 02:31)</a>:</h4>
<p>lol, <code>Mathlib.Data.Array.Defs</code> is completely empty except for <code>import Std</code></p>



<a name="319314848"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319314848" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319314848">(Jan 04 2023 at 02:36)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1322">mathlib4#1322</a></p>



<a name="319376038"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319376038" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319376038">(Jan 04 2023 at 12:12)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1326">mathlib4#1326</a> should fix the issue related to <code>cache get</code> when Mathlib4 is used as a dependency.</p>
<p>Btw, I find it confusing that there are <code>Mathlib</code> (lib name), <code>mathlib4</code> (repo name) and <code>mathlib</code> (package name). What if they were all just <code>Mathlib</code>?</p>



<a name="319376605"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319376605" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319376605">(Jan 04 2023 at 12:15)</a>:</h4>
<p>trying this on Windows gives me</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Floris</span><span class="bp">@</span><span class="n">MSI</span> <span class="n">MINGW64</span> <span class="bp">/</span><span class="n">d</span><span class="bp">/</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span> <span class="o">((</span><span class="n">f46ac6ed...</span><span class="o">))</span>
<span class="bp">$</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span>
<span class="n">info</span><span class="o">:</span> <span class="n">downloading</span> <span class="n">component</span> <span class="bp">'</span><span class="n">lean'</span>
<span class="n">info</span><span class="o">:</span> <span class="n">installing</span> <span class="n">component</span> <span class="bp">'</span><span class="n">lean'</span>
<span class="n">warning</span><span class="o">:</span> <span class="n">manifest</span> <span class="n">out</span> <span class="n">of</span> <span class="n">date</span><span class="o">:</span> <span class="n">package</span> <span class="n">directory</span> <span class="n">changed</span><span class="o">,</span> <span class="n">use</span> <span class="bp">`</span><span class="n">lake</span> <span class="n">update</span><span class="bp">`</span> <span class="n">to</span> <span class="n">update</span>
<span class="n">info</span><span class="o">:</span> <span class="n">updating</span> <span class="bp">.\./</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">\</span><span class="n">std</span> <span class="n">to</span> <span class="n">revision</span> <span class="mi">2919713</span><span class="n">bde15d55e3ea3625a03546531283bcb54</span>
<span class="n">info</span><span class="o">:</span> <span class="n">updating</span> <span class="bp">.\./</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">\</span><span class="n">aesop</span> <span class="n">to</span> <span class="n">revision</span> <span class="n">c4477a2a7931e2490339d8087f599a45e89f25e7</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Building</span> <span class="n">Cache.IO</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Building</span> <span class="n">Cache.Hashing</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Compiling</span> <span class="n">Cache.IO</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Compiling</span> <span class="n">Cache.Hashing</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Building</span> <span class="n">Cache.Requests</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Building</span> <span class="n">Cache.Main</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Compiling</span> <span class="n">Cache.Requests</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Compiling</span> <span class="n">Cache.Main</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Linking</span> <span class="n">cache.exe</span>
<span class="n">Attempting</span> <span class="n">to</span> <span class="n">download</span> <span class="mi">787</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="n">uncaught</span> <span class="n">exception</span><span class="o">:</span> <span class="n">unspecified</span> <span class="n">system_category</span> <span class="n">error</span> <span class="o">(</span><span class="n">error</span> <span class="n">code</span><span class="o">:</span> <span class="mi">206</span><span class="o">)</span>
</code></pre></div>



<a name="319377673"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319377673" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319377673">(Jan 04 2023 at 12:22)</a>:</h4>
<p>Hmm, seems like <code>IO</code> errors aren't well defined for Windows. Do you have <code>curl</code> and <code>tar</code> on your PATH?</p>



<a name="319377883"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319377883" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319377883">(Jan 04 2023 at 12:23)</a>:</h4>
<p>yes</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Floris@MSI MINGW64 /d/projects/mathlib <span class="o">(</span>simps_aux_attr<span class="o">)</span>
$ curl --version
curl <span class="m">7</span>.64.0 <span class="o">(</span>x86_64-w64-mingw32<span class="o">)</span> libcurl/7.64.0 OpenSSL/1.1.1a <span class="o">(</span>Schannel<span class="o">)</span> zlib/1.2.11 libidn2/2.1.1 nghttp2/1.36.0
Release-Date: <span class="m">2019</span>-02-06
Protocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtsp smtp smtps telnet tftp
Features: AsynchDNS IDN IPv6 Largefile SSPI Kerberos SPNEGO NTLM SSL libz TLS-SRP HTTP2 HTTPS-proxy MultiSSL Metalink

Floris@MSI MINGW64 /d/projects/mathlib <span class="o">(</span>simps_aux_attr<span class="o">)</span>
$ tar --version
tar <span class="o">(</span>GNU tar<span class="o">)</span> <span class="m">1</span>.31
Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2019</span> Free Software Foundation, Inc.
License GPLv3+: GNU GPL version <span class="m">3</span> or later &lt;https://gnu.org/licenses/gpl.html&gt;.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Written by John Gilmore and Jay Fenlason.
</code></pre></div>



<a name="319378269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319378269" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319378269">(Jan 04 2023 at 12:25)</a>:</h4>
<p>I think it's best to register that as an issue so maybe someone else can jump in and help us. I don't know what's happening with that error message <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="319378960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319378960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319378960">(Jan 04 2023 at 12:30)</a>:</h4>
<p><a href="https://learn.microsoft.com/en-us/windows/win32/debug/system-error-codes--0-499-">"The filename or extension is too long"</a>. I guess there's a maximum number of chars that can be passed as arguments?</p>



<a name="319380175"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319380175" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319380175">(Jan 04 2023 at 12:38)</a>:</h4>
<p>Windows has a very low command line length limit--is that the issue? Is curl getting invoked with 787 arguments?</p>



<a name="319380406"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319380406" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319380406">(Jan 04 2023 at 12:39)</a>:</h4>
<p>(or it used to, at any rate--I don't really know anything about Windows)</p>



<a name="319381152"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319381152" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ruben Van de Velde <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319381152">(Jan 04 2023 at 12:43)</a>:</h4>
<p>Also a low path length limit, depending on the API you use, as I recall. Also don't know much about windows :)</p>



<a name="319381319"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319381319" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319381319">(Jan 04 2023 at 12:44)</a>:</h4>
<p><a href="https://learn.microsoft.com/en-us/troubleshoot/windows-client/shell-experience/command-line-string-limitation">https://learn.microsoft.com/en-us/troubleshoot/windows-client/shell-experience/command-line-string-limitation</a> says 8KB. So that's definitely less than the length of 787 URLs (or even filenames).</p>



<a name="319381421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319381421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319381421">(Jan 04 2023 at 12:45)</a>:</h4>
<p>I think one issue is that the <code>curl</code> I got with <code>minGW</code> is very old, and doesn't support <code>--parallel</code> yet.</p>



<a name="319381496"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319381496" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319381496">(Jan 04 2023 at 12:45)</a>:</h4>
<p>I'm now updating it</p>



<a name="319382063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319382063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319382063">(Jan 04 2023 at 12:48)</a>:</h4>
<p>Apparently there is <code>curl -K</code> (or <code>curl --config</code>) to specify the URLs to download with a file</p>



<a name="319382828"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319382828" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319382828">(Jan 04 2023 at 12:52)</a>:</h4>
<p>I'm going to use that for downloads and (hopefully) for uploads</p>



<a name="319382992"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319382992" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319382992">(Jan 04 2023 at 12:53)</a>:</h4>
<p>If I manually run the <code>curl</code> command that <code>Cache</code> uses, I indeed get the error <br>
<code>bash: /c/ProgramData/chocolatey/bin/curl: Argument list too long</code></p>



<a name="319390031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319390031" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319390031">(Jan 04 2023 at 13:32)</a>:</h4>
<p>Ugh, it looks like libc++ doesn't correctly handle Windows error codes... high time to rewrite the Lean runtime in Lean</p>



<a name="319397267"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319397267" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Raghuram <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319397267">(Jan 04 2023 at 14:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319376038">said</a>:</p>
<blockquote>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1326">mathlib4#1326</a> should fix the issue related to <code>cache get</code> when Mathlib4 is used as a dependency.</p>
</blockquote>
<p>Why was this pull request closed?</p>



<a name="319397360"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319397360" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319397360">(Jan 04 2023 at 14:13)</a>:</h4>
<p>Because I'm including more fixes on a single PR</p>



<a name="319407672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319407672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319407672">(Jan 04 2023 at 15:03)</a>:</h4>
<p>Okay, mathlib <a href="https://github.com/leanprover-community/mathlib/pull/1333">#1333</a> should fix these issues</p>



<a name="319409455"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319409455" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319409455">(Jan 04 2023 at 15:11)</a>:</h4>
<p>Yeah, this is an optimisation I've been greatly looking forward to. But note that mathlib already reuses cache from previous pushes.</p>



<a name="319409696"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319409696" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319409696">(Jan 04 2023 at 15:12)</a>:</h4>
<p>The real difference is whether caches are still invalidated transitively or not.</p>



<a name="319409756"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319409756" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319409756">(Jan 04 2023 at 15:13)</a>:</h4>
<p>Yeah but they were addressed by commit hashes, so a new commit gets nothing from the cache and the building process will have to chew everything again</p>



<a name="319410160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319410160" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319410160">(Jan 04 2023 at 15:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319409696">said</a>:</p>
<blockquote>
<p>The real difference is whether caches are still invalidated transitively or not.</p>
</blockquote>
<p>That still holds because the hash of a file involves the hash of all files imported by it</p>



<a name="319414063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319414063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319414063">(Jan 04 2023 at 15:34)</a>:</h4>
<p>So is there any optimisation compared to mathlib CI besides Lean 4s generally better performance?</p>



<a name="319414273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319414273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319414273">(Jan 04 2023 at 15:35)</a>:</h4>
<blockquote>
<p>So is there any optimisation compare to mathlib CI besides </p>
</blockquote>
<p>Yes, mathlib CI does a worse job of merge commits</p>



<a name="319414459"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319414459" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319414459">(Jan 04 2023 at 15:36)</a>:</h4>
<p>Right. And anything more?</p>



<a name="319414617"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319414617" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319414617">(Jan 04 2023 at 15:37)</a>:</h4>
<p>I would guess that downloading is faster, as if you modify <code>data.set.basic</code> it sounds like the new system won't attempt to download any downstream oleans. Of course, that has to fight against the advantage of the tarball combining many downloads into one.</p>



<a name="319414799"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319414799" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319414799">(Jan 04 2023 at 15:38)</a>:</h4>
<p>Oh, and that also holds for the github CI?</p>



<a name="319414845"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319414845" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319414845">(Jan 04 2023 at 15:38)</a>:</h4>
<p>By github CI I assume you mean mathlib3 CI?</p>



<a name="319414916"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319414916" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319414916">(Jan 04 2023 at 15:39)</a>:</h4>
<p>Mathlib3 CI is basically a <code>leanproject get-cache --fallback=download-first</code> but <a href="#narrow/stream/113488-general/topic/.E2.9C.94.20multiple.20viable.20caches.20from.20parent.20commits/near/292122348">following a different parent commit on merges</a></p>



<a name="319414920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319414920" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319414920">(Jan 04 2023 at 15:39)</a>:</h4>
<p>Yes, as opposed to <code>leanproject get-c</code> run from a local terminal.</p>



<a name="319415450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319415450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319415450">(Jan 04 2023 at 15:41)</a>:</h4>
<p><code>leanproject get-c</code> is stupid and only does an exact match (if you don't like that, pass <code>--fallback</code>)</p>



<a name="319415683"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319415683" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319415683">(Jan 04 2023 at 15:43)</a>:</h4>
<p>In terms of the resulting <code>.olean</code> files and ignoring network traffic, <code>--fallback=download-first</code> is essentially the same as what it sounds like <span class="user-mention" data-user-id="451983">@Arthur Paulino</span> has implemented, but the new version does much better with merge commits</p>



<a name="319415981"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319415981" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319415981">(Jan 04 2023 at 15:44)</a>:</h4>
<p>(the stupidness of <code>get-c</code> is deliberate; it means that if you're checking out a random commit from mathlib, you get an error if you try to get the cache for a commit which was skipped over due to bors batching)</p>



<a name="319416419"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319416419" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319416419">(Jan 04 2023 at 15:46)</a>:</h4>
<p>There is <a href="#narrow/stream/113488-general/topic/Changing.20the.20default.20behavior.20of.20leanproject.20get-cache/near/288137688">a poll</a> to change the default</p>



<a name="319417173"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319417173" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319417173">(Jan 04 2023 at 15:50)</a>:</h4>
<p>Btw I don't take credit for the hashing scheme. Scott was the one who came up with it. I just implemented it</p>



<a name="319417830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319417830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319417830">(Jan 04 2023 at 15:54)</a>:</h4>
<p>I would have implemented it in mathlib3, but the problem is that the hashing is all internal to Lean and difficult to expose to python</p>



<a name="319418346"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319418346" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319418346">(Jan 04 2023 at 15:57)</a>:</h4>
<p>Oh, I didn't use the hashing that Lake does btw. That would require some refactor in Lake because Lake only outputs traces during the building process and it wouldn't make sense to build in order to know the hashes. What I did use was Lean's capabilities to hash strings and to combine hashes into new ones</p>



<a name="319449629"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319449629" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319449629">(Jan 04 2023 at 18:45)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> <a href="https://github.com/leanprover-community/mathlib4/pull/1333">mathlib4#1333</a> has been merged. Can you try again please?</p>



<a name="319451094"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319451094" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319451094">(Jan 04 2023 at 18:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319414273">said</a>:</p>
<blockquote>
<blockquote>
<p>So is there any optimisation compare to mathlib CI besides </p>
</blockquote>
<p>Yes, mathlib CI does a worse job of merge commits</p>
</blockquote>
<p>Notably, the new cache also works with non-merge commits (i.e. squashes like bors does).</p>



<a name="319453636"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319453636" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319453636">(Jan 04 2023 at 19:04)</a>:</h4>
<div class="codehilite" data-code-language="txt"><pre><span></span><code>buzzard@buster:~/lean-projects/mathlib4$ lake exe cache get
Attempting to download 582 file(s)
Decompressing cache
uncaught exception:
gzip: stdin: unexpected end of file
tar: Child returned status 1
tar: Error is not recoverable: exiting now

buzzard@buster:~/lean-projects/mathlib4$ lake exe cache get
Attempting to download 432 file(s)
Decompressing cache
uncaught exception:
gzip: stdin: unexpected end of file
tar: Child returned status 1
tar: Error is not recoverable: exiting now
</code></pre></div>
<p>Ubuntu 22.04, lake <code>Lake version 4.1.0-pre (Lean version 4.0.0-nightly-2022-12-23)</code></p>



<a name="319453914"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319453914" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319453914">(Jan 04 2023 at 19:05)</a>:</h4>
<p>Does <code>rm -r .cache</code> help?</p>



<a name="319454038"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319454038" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319454038">(Jan 04 2023 at 19:06)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">buzzard</span><span class="bp">@</span><span class="n">buster</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span> <span class="n">rm</span> <span class="bp">-</span><span class="n">r</span> <span class="bp">.</span><span class="n">cache</span>
<span class="n">buzzard</span><span class="bp">@</span><span class="n">buster</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span>
<span class="n">Attempting</span> <span class="n">to</span> <span class="n">download</span> <span class="mi">790</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="n">Decompressing</span> <span class="n">cache</span>
<span class="n">uncaught</span> <span class="n">exception</span><span class="o">:</span>
<span class="n">gzip</span><span class="o">:</span> <span class="n">stdin</span><span class="o">:</span> <span class="n">unexpected</span> <span class="kd">end</span> <span class="n">of</span> <span class="n">file</span>
<span class="n">tar</span><span class="o">:</span> <span class="n">Child</span> <span class="n">returned</span> <span class="n">status</span> <span class="mi">1</span>
<span class="n">tar</span><span class="o">:</span> <span class="n">Error</span> <span class="n">is</span> <span class="n">not</span> <span class="n">recoverable</span><span class="o">:</span> <span class="n">exiting</span> <span class="n">now</span>
</code></pre></div>



<a name="319454193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319454193" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319454193">(Jan 04 2023 at 19:07)</a>:</h4>
<p>Oh!</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="n">git</span> <span class="n">status</span>
<span class="n">On</span> <span class="n">branch</span> <span class="n">master</span>
<span class="n">Your</span> <span class="n">branch</span> <span class="n">is</span> <span class="n">up</span><span class="bp">-</span><span class="n">to</span><span class="bp">-</span><span class="n">date</span> <span class="k">with</span> <span class="bp">'</span><span class="n">origin</span><span class="bp">/</span><span class="n">master'.</span>

<span class="n">Changes</span> <span class="n">not</span> <span class="n">staged</span> <span class="n">for</span> <span class="n">commit</span><span class="o">:</span>
  <span class="o">(</span><span class="n">use</span> <span class="s2">"git add &lt;file&gt;..."</span> <span class="n">to</span> <span class="n">update</span> <span class="n">what</span> <span class="n">will</span> <span class="n">be</span> <span class="n">committed</span><span class="o">)</span>
  <span class="o">(</span><span class="n">use</span> <span class="s2">"git restore &lt;file&gt;..."</span> <span class="n">to</span> <span class="n">discard</span> <span class="n">changes</span> <span class="k">in</span> <span class="n">working</span> <span class="n">directory</span><span class="o">)</span>
    <span class="n">modified</span><span class="o">:</span>   <span class="n">lake</span><span class="bp">-</span><span class="n">manifest.json</span>

<span class="n">no</span> <span class="n">changes</span> <span class="n">added</span> <span class="n">to</span> <span class="n">commit</span> <span class="o">(</span><span class="n">use</span> <span class="s2">"git add"</span> <span class="n">and</span><span class="bp">/</span><span class="n">or</span> <span class="s2">"git commit -a"</span><span class="o">)</span>
<span class="n">buzzard</span><span class="bp">@</span><span class="n">buster</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span>
</code></pre></div>
<p>No idea why that has happened.</p>



<a name="319454358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319454358" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319454358">(Jan 04 2023 at 19:08)</a>:</h4>
<p>I didn't modify any json file as far as I know.</p>



<a name="319454758"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319454758" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319454758">(Jan 04 2023 at 19:10)</a>:</h4>
<p>I have stuff like</p>
<div class="codehilite" data-code-language="txt"><pre><span></span><code>@@ -34,21 +10,9 @@
   {"git":
    {"url": "https://github.com/JLimperg/aesop",
     "subDir?": null,
-    "rev": "c4477a2a7931e2490339d8087f599a45e89f25e7",
+    "rev": "72610cec1cd686884a08704f5fa91b45262136f9",
     "name": "aesop",
     "inputRev?": "master"}},
-  {"git":
-   {"url": "https://github.com/hargonix/LeanInk",
-    "subDir?": null,
-    "rev": "2447df5cc6e48eb965c3c3fba87e46d353b5e9f1",
-    "name": "leanInk",
-    "inputRev?": "doc-gen"}},
-  {"git":
-   {"url": "https://github.com/xubaiw/Unicode.lean",
-    "subDir?": null,
-    "rev": "6dd6ae3a3839c8350a91876b090eda85cf538d1d",
-    "name": "Unicode",
-    "inputRev?": "main"}},
</code></pre></div>
<p>in the diffs.</p>



<a name="319454830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319454830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319454830">(Jan 04 2023 at 19:10)</a>:</h4>
<p>That sounds like you did a <code>lake update</code> (which you should only do if you're preparing a bump PR).</p>



<a name="319454852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319454852" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319454852">(Jan 04 2023 at 19:10)</a>:</h4>
<p>Just a hunch, does this print anything:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">file</span> <span class="bp">.</span><span class="n">cache</span><span class="bp">/*</span> <span class="bp">|</span> <span class="n">grep</span> <span class="bp">-</span><span class="n">v</span> <span class="n">gzip</span>
</code></pre></div>



<a name="319455071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319455071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319455071">(Jan 04 2023 at 19:12)</a>:</h4>
<p>There is a slight possibility that I have pushed corrupted tar files during dev attempts <span aria-label="explosion" class="emoji emoji-1f4a5" role="img" title="explosion">:explosion:</span></p>



<a name="319455138"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319455138" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319455138">(Jan 04 2023 at 19:12)</a>:</h4>
<p>But it can be fixed with <code>put!</code></p>
<p>Edit: no need... <code>lake exe cache get</code> worked on master (on my machine) just now</p>



<a name="319457192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319457192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319457192">(Jan 04 2023 at 19:24)</a>:</h4>
<p>Another possibility: maybe <a href="https://github.com/leanprover-community/mathlib4/blob/7e2613afa5a47788e24f31a386e4dfad92b40289/Cache/Requests.lean#L66">this</a> validation if flawed/flaky</p>



<a name="319458371"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319458371" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319458371">(Jan 04 2023 at 19:31)</a>:</h4>
<p>This is a bit concerning.. I was just running <code>curl --parallel</code> manually to download <em>all</em> of the blobs.  Some were truncated, and curl got stuck in the middle. <span aria-label="fear" class="emoji emoji-1f628" role="img" title="fear">:fear:</span></p>



<a name="319459762"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319459762" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319459762">(Jan 04 2023 at 19:40)</a>:</h4>
<p>If it can get stuck on downloads, there's nothing stopping it from getting stuck during uploads</p>



<a name="319459979"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319459979" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319459979">(Jan 04 2023 at 19:42)</a>:</h4>
<p>Uh-oh, when we cancel a build that probably kills curl. <span aria-label="scream" class="emoji emoji-1f631" role="img" title="scream">:scream:</span></p>



<a name="319460102"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319460102" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319460102">(Jan 04 2023 at 19:43)</a>:</h4>
<p>Can it be set on a separate workflow that never gets killed?</p>



<a name="319460736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319460736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319460736">(Jan 04 2023 at 19:47)</a>:</h4>
<p>Apparently, <code>if: always()</code> (which we set for the upload) prevents cancellation.</p>



<a name="319461242"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319461242" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319461242">(Jan 04 2023 at 19:51)</a>:</h4>
<p>Idea: doing a raw build with <code>rm -rf .cache &amp;&amp; lake clean &amp;&amp; rm -rf lake-packages &amp;&amp; lake exe cache get &amp;&amp; lake build</code> right after uploading everything could spot flawed uploads</p>



<a name="319461563"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319461563" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319461563">(Jan 04 2023 at 19:53)</a>:</h4>
<p>If that fails, a <code>lake exe cache put!</code> is needed. Then a new verification round is needed. Loop until it goes through</p>



<a name="319461641"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319461641" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319461641">(Jan 04 2023 at 19:53)</a>:</h4>
<p>So far we haven't had any issues with uploads, and that check would not even detect missing uploads (it would just build a bit longer).</p>



<a name="319461809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319461809" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319461809">(Jan 04 2023 at 19:54)</a>:</h4>
<p>Silently doing a <code>lake exe cache put!</code> seems like a bad idea, this would just hide hash collisions.</p>



<a name="319462693"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319462693" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319462693">(Jan 04 2023 at 19:59)</a>:</h4>
<p>Then maybe it's a manual <code>get!</code> that may save the day for problematic downloads, since <code>get</code> will skip (supposedly corrupted) files that are already on the FS. I mean, that's precisely the role of <code>get!</code></p>



<a name="319463586"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319463586" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319463586">(Jan 04 2023 at 20:04)</a>:</h4>
<p>This sounds good:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>       <span class="c1">--remove-on-error</span>
              <span class="n">When</span> <span class="n">curl</span> <span class="n">returns</span> <span class="n">an</span> <span class="n">error</span> <span class="n">when</span> <span class="n">told</span> <span class="n">to</span> <span class="n">save</span> <span class="n">output</span> <span class="k">in</span>  <span class="n">a</span>  <span class="kn">local</span>
              <span class="n">file</span><span class="o">,</span>  <span class="n">this</span>  <span class="n">option</span> <span class="n">removes</span> <span class="n">that</span> <span class="n">saved</span> <span class="n">file</span> <span class="n">before</span> <span class="n">exiting.</span> <span class="n">This</span>
              <span class="n">prevents</span> <span class="n">curl</span> <span class="k">from</span> <span class="n">leaving</span> <span class="n">a</span> <span class="n">partial</span> <span class="n">file</span> <span class="k">in</span> <span class="n">the</span> <span class="n">case</span> <span class="n">of</span> <span class="n">an</span>  <span class="n">er</span><span class="bp">‐</span>
              <span class="n">ror</span> <span class="n">during</span> <span class="n">transfer.</span>
</code></pre></div>



<a name="319463789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319463789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319463789">(Jan 04 2023 at 20:05)</a>:</h4>
<p>I have no idea if this would help with the 404 pages:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>       <span class="bp">-</span><span class="n">f</span><span class="o">,</span> <span class="c1">--fail</span>
              <span class="o">(</span><span class="n">HTTP</span><span class="o">)</span> <span class="n">Fail</span> <span class="n">fast</span> <span class="k">with</span> <span class="n">no</span> <span class="n">output</span> <span class="n">at</span> <span class="n">all</span> <span class="n">on</span> <span class="n">server</span> <span class="n">errors.</span> <span class="n">This</span> <span class="n">is</span>
              <span class="n">useful</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">scripts</span> <span class="n">and</span> <span class="n">users</span> <span class="n">to</span> <span class="n">better</span>  <span class="n">deal</span>  <span class="k">with</span>  <span class="n">failed</span>
              <span class="n">attempts.</span> <span class="n">In</span> <span class="n">normal</span> <span class="n">cases</span> <span class="n">when</span> <span class="n">an</span> <span class="n">HTTP</span> <span class="n">server</span> <span class="n">fails</span> <span class="n">to</span> <span class="n">deliver</span> <span class="n">a</span>
              <span class="n">document</span><span class="o">,</span> <span class="n">it</span> <span class="n">returns</span> <span class="n">an</span> <span class="n">HTML</span> <span class="n">document</span> <span class="n">stating</span>  <span class="n">so</span>  <span class="o">(</span><span class="n">which</span>  <span class="n">often</span>
              <span class="n">also</span>  <span class="n">describes</span>  <span class="n">why</span> <span class="n">and</span> <span class="n">more</span><span class="o">)</span><span class="bp">.</span> <span class="n">This</span> <span class="n">flag</span> <span class="n">will</span> <span class="n">prevent</span> <span class="n">curl</span> <span class="k">from</span>
              <span class="n">outputting</span> <span class="n">that</span> <span class="n">and</span> <span class="n">return</span> <span class="n">error</span> <span class="mi">22</span><span class="bp">.</span>
</code></pre></div>



<a name="319463973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319463973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319463973">(Jan 04 2023 at 20:06)</a>:</h4>
<p>Oh wow, so we may be able to get rid of that ugly <code>ByteArray</code> check</p>



<a name="319464074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319464074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319464074">(Jan 04 2023 at 20:07)</a>:</h4>
<p>50 parallel transfers could be too much for some connections. Maybe pass <code>--parallel-max 8</code> as well if it doesn't make things that much slower?</p>



<a name="319464231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319464231" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319464231">(Jan 04 2023 at 20:08)</a>:</h4>
<p>There's also a <code>--retry N</code> option</p>



<a name="319464886"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319464886" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319464886">(Jan 04 2023 at 20:12)</a>:</h4>
<p>Amazing, there are multiple possibilities for workarounds. <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> do you want to go ahead and implement the solution you think is the best? Or do you want me to do so? In the later, I would rather being told the workaround you think will work the best</p>



<a name="319466077"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319466077" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319466077">(Jan 04 2023 at 20:19)</a>:</h4>
<p>There's only issue here:</p>
<blockquote>
<p>curl version 7.83.0 was released on April 27 2022</p>
</blockquote>
<p>And ubuntu 22.04 still contains 7.81..</p>



<a name="319466163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319466163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319466163">(Jan 04 2023 at 20:19)</a>:</h4>
<p>There is a flexible solution that would allow extra args to be passed to <code>curl</code>.<br>
For example <code>lake exe cache get --parallel-max 8 --retry 3</code>. But that's not very friendly</p>



<a name="319466396"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319466396" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319466396">(Jan 04 2023 at 20:21)</a>:</h4>
<p>Although the <code>--remove-on-error</code> and the <code>-f</code> flags look interesting regardless so maybe we can simply always use those</p>



<a name="319466447"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319466447" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319466447">(Jan 04 2023 at 20:21)</a>:</h4>
<p>The problem is that <code>--remove-on-error</code> was added in 7.83.</p>



<a name="319467059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319467059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319467059">(Jan 04 2023 at 20:25)</a>:</h4>
<p>Still, I think <code>-f</code> with a check on <code>exitCode == 0</code> should warn the user to try a <code>get</code> again</p>



<a name="319467184"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319467184" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319467184">(Jan 04 2023 at 20:26)</a>:</h4>
<p>(I'm assuming <code>-f</code> makes <code>curl</code> return something !=0 in case of failure)</p>



<a name="319467655"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319467655" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319467655">(Jan 04 2023 at 20:29)</a>:</h4>
<p>No <code>--fail</code> does nothing of the sort, it will just ignore the errors.  But apparently it does exactly what we want, it doesn't save 404 responses!</p>



<a name="319468041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319468041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319468041">(Jan 04 2023 at 20:31)</a>:</h4>
<p>I see. So we <em>can</em> get rid of that ugly <code>ByteArray.startsWith</code> check. What about extra parameters like <code>retry</code> and <code>max-parallel</code>?</p>



<a name="319468852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319468852" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319468852">(Jan 04 2023 at 20:36)</a>:</h4>
<p>We have no indication that <code>max-parallel</code> would fix any issues, so I'd leave it at the default value.  Same with <code>retry</code>.</p>



<a name="319468956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319468956" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319468956">(Jan 04 2023 at 20:37)</a>:</h4>
<p>But I mean, allowing the user to send extra custom arguments to <code>curl</code></p>



<a name="319469213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319469213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319469213">(Jan 04 2023 at 20:39)</a>:</h4>
<p>Oh, that seems reasonable enough.</p>



<a name="319469513"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319469513" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319469513">(Jan 04 2023 at 20:41)</a>:</h4>
<p>You actually need a pretty high degree of parallelism to saturate HTTP 2.0 multiplexing when downloading many small files <a href="https://github.com/NixOS/nix/issues/5118">https://github.com/NixOS/nix/issues/5118</a></p>



<a name="319470212"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319470212" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319470212">(Jan 04 2023 at 20:46)</a>:</h4>
<p><code>curl --fail</code> does return a nonzero exit code on HTTP errors</p>



<a name="319470684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319470684" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319470684">(Jan 04 2023 at 20:50)</a>:</h4>
<p>Though we need to ignore that exit code since 404 is expected.</p>



<a name="319479513"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319479513" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319479513">(Jan 04 2023 at 21:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319449629">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="111080">Floris van Doorn</span> <a href="https://github.com/leanprover-community/mathlib4/pull/1333">mathlib4#1333</a> has been merged. Can you try again please?</p>
</blockquote>
<p>There is progress, I now get no error:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Floris@MSI MINGW64 /d/projects/Mathlib4 <span class="o">((</span>c0e8ec73...<span class="o">))</span>
$ lake exe cache get
info: downloading component <span class="s1">'lean'</span>
info: installing component <span class="s1">'lean'</span>
warning: manifest out of date: package directory changed, use <span class="sb">`</span>lake update<span class="sb">`</span> to update
info: Building Cache.IO
info: Compiling Cache.IO
info: Building Cache.Hashing
info: Compiling Cache.Hashing
info: Building Cache.Requests
info: Compiling Cache.Requests
info: Building Cache.Main
info: Compiling Cache.Main
info: Linking cache.exe
Attempting to download <span class="m">789</span> file<span class="o">(</span>s<span class="o">)</span>
Decompressing cache
</code></pre></div>
<p>However, doing <code>lake build</code> immediately afterwards still recompiles everything. This takes about ~15 minutes for all of Std+Aesop+Mathlib, so I don't think it's using any caches.</p>



<a name="319479605"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319479605" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319479605">(Jan 04 2023 at 21:52)</a>:</h4>
<p>(<code>git status</code> shows no changes)</p>



<a name="319482933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319482933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319482933">(Jan 04 2023 at 22:16)</a>:</h4>
<p>Just a little remark, on my Linux machine everything is work correctly ootb <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span> </p>
<p>Would be a shame if lake was smart enough to notice the windows/linux difference here...</p>



<a name="319483010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319483010" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319483010">(Jan 04 2023 at 22:16)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> your manifest is out of date, meaning that its content may not be equivalent to the one used to make the hashing</p>



<a name="319483053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319483053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319483053">(Jan 04 2023 at 22:17)</a>:</h4>
<p>(the content of <code>lake-manifest.json</code> is involved in the root hash, which, in turn, is in the mix of the hash of all files)</p>



<a name="319483150"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319483150" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319483150">(Jan 04 2023 at 22:18)</a>:</h4>
<p>Should I add this to the doc-gen4 CI?</p>



<a name="319483289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319483289" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319483289">(Jan 04 2023 at 22:19)</a>:</h4>
<p>What do you mean? (add what?)</p>



<a name="319483485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319483485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319483485">(Jan 04 2023 at 22:21)</a>:</h4>
<p>Add the call to the cache to the doc-gen4 CI</p>



<a name="319483606"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319483606" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319483606">(Jan 04 2023 at 22:21)</a>:</h4>
<p>Ah, like a mini tutorial?</p>



<a name="319483765"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319483765" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319483765">(Jan 04 2023 at 22:22)</a>:</h4>
<blockquote>
<p><code>warning: manifest out of date: package directory changed, use </code>lake update<code> to update</code></p>
</blockquote>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> Do you get this every time on windows?  I wonder if this is platform-independent?</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="w"> </span><span class="nt">"packagesDir"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./lake-packages"</span><span class="p">,</span><span class="w"></span>
</code></pre></div>



<a name="319483879"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319483879" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319483879">(Jan 04 2023 at 22:23)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> Can you do <code>ls .cache</code> and check if any caches got downloaded at all?  I wouldn't be surprised if <code>hash filePath</code> gives a different result on windows than on linux/macos.</p>



<a name="319484031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319484031" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319484031">(Jan 04 2023 at 22:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319483606">said</a>:</p>
<blockquote>
<p>Ah, like a mini tutorial?</p>
</blockquote>
<p>no, doc-gen4's CI is responsible for building <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat#doc">docs4#Nat</a> so if I would use the cache I could basically shave 15 minutes off each CI run since I don't have to recompile</p>



<a name="319484032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319484032" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319484032">(Jan 04 2023 at 22:24)</a>:</h4>
<p>Okay, that's the catch! It certainly will. Let me fix that ASAP</p>



<a name="319484102"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319484102" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319484102">(Jan 04 2023 at 22:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395550">Henrik Böving</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319484031">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319483606">said</a>:</p>
<blockquote>
<p>Ah, like a mini tutorial?</p>
</blockquote>
<p>no, doc-gen4's CI is responsible for building <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat#doc">docs4#Nat</a> so if I would use the cache I could basically shave 15 minutes off each CI run since I don't have to recompile</p>
</blockquote>
<p>Oh, definitely worth trying then</p>



<a name="319484340"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319484340" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319484340">(Jan 04 2023 at 22:26)</a>:</h4>
<p><a href="/user_uploads/3121/uPFkLuTo4TyKk9WqAMBY5Qse/image.png">image.png</a><br>
woop</p>
<div class="message_inline_image"><a href="/user_uploads/3121/uPFkLuTo4TyKk9WqAMBY5Qse/image.png" title="image.png"><img src="/user_uploads/3121/uPFkLuTo4TyKk9WqAMBY5Qse/image.png"></a></div>



<a name="319484723"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319484723" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319484723">(Jan 04 2023 at 22:29)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> <a href="https://github.com/leanprover-community/mathlib4/pull/1339">mathlib4#1339</a></p>



<a name="319485207"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319485207" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319485207">(Jan 04 2023 at 22:33)</a>:</h4>
<p>Oh wait, it's breaking</p>



<a name="319486318"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319486318" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319486318">(Jan 04 2023 at 22:42)</a>:</h4>
<p>Okay the PR is fixed but it will take some minutes to build because all the hashes changed</p>



<a name="319489673"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319489673" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319489673">(Jan 04 2023 at 23:12)</a>:</h4>
<p>Okay, it pushed everything and built correctly. Should be ready to merge <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="319489781"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319489781" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319489781">(Jan 04 2023 at 23:12)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> please try again when you have a chance <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="319496711"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319496711" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319496711">(Jan 05 2023 at 00:29)</a>:</h4>
<p>Another issue with packages depending on mathlib: the oleans get extracted to <code>build/lib/Mathlib</code> and not <code>lake-packages/mathlib/build/lib/Mathlib</code>.</p>



<a name="319497422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319497422" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319497422">(Jan 05 2023 at 00:36)</a>:</h4>
<p>I see, <code>-C</code> should do the trick here. Let me fix that</p>



<a name="319499617"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319499617" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319499617">(Jan 05 2023 at 01:00)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1341">mathlib4#1341</a></p>



<a name="319500014"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319500014" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319500014">(Jan 05 2023 at 01:05)</a>:</h4>
<p>(sorry for so many PRs... it's hard to cover all use cases alone)</p>



<a name="319503724"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319503724" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319503724">(Jan 05 2023 at 01:52)</a>:</h4>
<p>Things are still not working for me (on Ubuntu). After I did a <code>lake update</code>, I deleted the <code>.cache</code> folder and ran with this result:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span>
<span class="n">Attempting</span> <span class="n">to</span> <span class="n">download</span> <span class="mi">789</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="n">Decompressing</span> <span class="mi">501</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="o">(</span><span class="n">base</span><span class="o">)</span> <span class="n">gadgil</span><span class="bp">@</span><span class="n">gadgil</span><span class="bp">-</span><span class="n">XPS</span><span class="bp">-</span><span class="mi">15</span><span class="o">:</span><span class="bp">~/</span><span class="n">code</span><span class="bp">/</span><span class="n">LeanAide</span><span class="bp">$</span> <span class="n">lake</span> <span class="n">build</span>
<span class="n">Building</span> <span class="n">Mathlib.Init.Data.Nat.Notation</span>
<span class="n">Building</span> <span class="n">Mathlib.Data.KVMap</span>
<span class="n">Building</span> <span class="n">Mathlib.Util.MemoFix</span>
<span class="n">Building</span> <span class="n">Mathlib.Tactic.Relation.Rfl</span>
<span class="n">Building</span> <span class="n">Mathlib.Lean.Meta</span>
<span class="n">Building</span> <span class="n">Mathlib.Mathport.Rename</span>
<span class="n">Building</span> <span class="n">Mathlib.Tactic.Alias</span>
<span class="n">Building</span> <span class="n">Mathlib.Tactic.RunCmd</span>
<span class="n">Building</span> <span class="n">Mathlib.Mathport.Attributes</span>
<span class="n">Building</span> <span class="n">Mathlib.Tactic.LeftRight</span>
<span class="n">Building</span> <span class="n">Mathlib.Lean.LocalContext</span>
<span class="n">Building</span> <span class="n">Mathlib.Util.WhatsNew</span>
<span class="n">error</span><span class="o">:</span> <span class="bp">&gt;</span> <span class="n">LEAN_PATH</span><span class="bp">=././</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">././</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">/</span><span class="n">Qq</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">././</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">/</span><span class="n">aesop</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">././</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">/</span><span class="n">std</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span> <span class="n">LD_LIBRARY_PATH</span><span class="bp">=/</span><span class="n">home</span><span class="bp">/</span><span class="n">gadgil</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-12-23/lib:/home/gadgil/software/z3/build::././lake-packages/mathlib/build/lib /home/gadgil/.elan/toolchains/leanprover--lean4---nightly-2022-12-23/bin/lean -DwarningAsError=true ././lake-packages/mathlib/././Mathlib/Data/KVMap.lean -R ././lake-packages/mathlib/./. -o ././lake-packages/mathlib/build/lib/Mathlib/Data/KVMap.olean -i ././lake-packages/mathlib/build/lib/Mathlib/Data/KVMap.ilean -c ././lake-packages/mathlib/build/ir/Mathlib/Data/KVMap.c</span>
<span class="n">error</span><span class="o">:</span> <span class="n">stdout</span><span class="o">:</span>
<span class="bp">././</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/././</span><span class="n">Mathlib</span><span class="bp">/</span><span class="n">Data</span><span class="bp">/</span><span class="n">KVMap.lean</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">31</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">expected</span> <span class="n">token</span>
<span class="n">error</span><span class="o">:</span> <span class="n">external</span> <span class="n">command</span> <span class="bp">`/</span><span class="n">home</span><span class="bp">/</span><span class="n">gadgil</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-12-23/bin/lean` exited with code 1</span>
<span class="bp">...</span>
</code></pre></div>



<a name="319504286"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319504286" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319504286">(Jan 05 2023 at 02:01)</a>:</h4>
<p>Can you send the link to that repo please?</p>



<a name="319504578"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319504578" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319504578">(Jan 05 2023 at 02:05)</a>:</h4>
<p>Oh, non-mathlib oleans now get extracted to interesting locations: <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">./</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">/</span><span class="n">std</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">Std</span><span class="bp">/</span><span class="n">Tactic</span><span class="bp">/</span><span class="n">NormCast</span><span class="bp">/</span><span class="n">Lemmas.olean</span>
</code></pre></div>



<a name="319504664"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319504664" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319504664">(Jan 05 2023 at 02:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319504286">said</a>:</p>
<blockquote>
<p>Can you send the link to that repo please?</p>
</blockquote>
<p><a href="https://github.com/siddhartha-gadgil/LeanAide.git">https://github.com/siddhartha-gadgil/LeanAide.git</a></p>



<a name="319504731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319504731" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319504731">(Jan 05 2023 at 02:07)</a>:</h4>
<p>Sorry, I should clarify this is on the <code>mathlib4</code> branch</p>



<a name="319504741"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319504741" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319504741">(Jan 05 2023 at 02:07)</a>:</h4>
<p>And I have not pushed the <code>lake update</code> that breaks things.</p>



<a name="319504958"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319504958" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319504958">(Jan 05 2023 at 02:10)</a>:</h4>
<p>Alright, it will be a lot easier to debug with an actual project at hand</p>



<a name="319505123"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319505123" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319505123">(Jan 05 2023 at 02:13)</a>:</h4>
<p>Checking out the <code>mathlib4</code> branch in the above and running "lake update" should get to the state I am working with.</p>



<a name="319506076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319506076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319506076">(Jan 05 2023 at 02:26)</a>:</h4>
<p>Also, thanks a lot for working on this. Soon over 20 students will be checking out my course repository which depends on <code>mathlib4</code> and building on various laptops (many fairly basic). And the mathlib4 will be updated periodically. Will help them hugely to have this.</p>
<p>Also I am hoping gitpod/github codespaces will be efficient with this.</p>



<a name="319511287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319511287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319511287">(Jan 05 2023 at 03:43)</a>:</h4>
<p><span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span> there's been a fix, but something's still weird. I'm taking a look</p>



<a name="319516027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319516027" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319516027">(Jan 05 2023 at 05:03)</a>:</h4>
<p>The weird behavior was that some cache files weren't being found.</p>
<p>But it's not an issue with caching. It's just that your version of Aesop is not the same one listed on mathlib's manifest. And the hash divergences cascate downstream</p>



<a name="319516722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319516722" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319516722">(Jan 05 2023 at 05:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319516027">said</a>:</p>
<blockquote>
<p>The weird behavior was that some cache files weren't being found on the server.</p>
<p>But it's not an issue with caching. It's just that your version of Aesop is not the same one listed on mathlib's manifest. And the hash divergences cascate downstream.</p>
<p>Mathlib's manifest needs to be updated</p>
</blockquote>
<p>Thanks. I can test by changing my version of Aesop to match with mathlib (or just use Aesop as a transitive dependency)</p>



<a name="319517132"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319517132" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319517132">(Jan 05 2023 at 05:21)</a>:</h4>
<p>My naive test failed. I will wait for the mathlib manifest update.</p>



<a name="319546358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319546358" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319546358">(Jan 05 2023 at 09:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319489781">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="111080">Floris van Doorn</span> please try again when you have a chance <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>
</blockquote>
<p>It works now! This is great! I get the files, <code>lake build</code> is very quick, and opening a random mathlib4 file uses the cached files.</p>



<a name="319546523"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319546523" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319546523">(Jan 05 2023 at 09:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319483765">said</a>:</p>
<blockquote>
<blockquote>
<p><code>warning: manifest out of date: package directory changed, use </code>lake update<code> to update</code></p>
</blockquote>
<p><span class="user-mention silent" data-user-id="111080">Floris van Doorn</span> Do you get this every time on windows?  I wonder if this is platform-independent?</p>
<p><div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="w"> </span><span class="nt">"packagesDir"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./lake-packages"</span><span class="p">,</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>Yes, I think I'm getting it on every commit. I was just ignoring it now. I can confirm that I'm getting it on the current commit (<code>cfd16dd8</code>).</p>



<a name="319546599"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319546599" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319546599">(Jan 05 2023 at 09:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319483879">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="111080">Floris van Doorn</span> Can you do <code>ls .cache</code> and check if any caches got downloaded at all?  I wouldn't be surprised if <code>hash filePath</code> gives a different result on windows than on linux/macos.</p>
</blockquote>
<p>You were correct that on yesterday's attempt no caches got downloaded.</p>



<a name="319547168"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319547168" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319547168">(Jan 05 2023 at 09:49)</a>:</h4>
<p>I've still never managed to get this working :-( On the machine I'm currently using:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">buzzard</span><span class="bp">@</span><span class="n">brutus</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span>
<span class="n">info</span><span class="o">:</span> <span class="n">updating</span> <span class="bp">././</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">/</span><span class="n">aesop</span> <span class="n">to</span> <span class="n">revision</span> <span class="mi">72610</span><span class="n">cec1cd686884a08704f5fa91b45262136f9</span>
<span class="n">error</span><span class="o">:</span> <span class="n">unknown</span> <span class="n">executable</span> <span class="bp">`</span><span class="n">cache</span><span class="bp">`</span>
<span class="n">buzzard</span><span class="bp">@</span><span class="n">brutus</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span> <span class="n">lake</span> <span class="c1">--version</span>
<span class="n">Lake</span> <span class="n">version</span> <span class="mi">4</span><span class="bp">.</span><span class="mi">1</span><span class="bp">.</span><span class="mi">0</span><span class="bp">-</span><span class="n">pre</span> <span class="o">(</span><span class="n">Lean</span> <span class="n">version</span> <span class="mi">4</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">0</span><span class="bp">-</span><span class="n">nightly</span><span class="bp">-</span><span class="mi">2022</span><span class="bp">-</span><span class="mi">12</span><span class="bp">-</span><span class="mi">23</span><span class="o">)</span>
<span class="n">buzzard</span><span class="bp">@</span><span class="n">brutus</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span> <span class="n">git</span> <span class="n">status</span>
<span class="n">On</span> <span class="n">branch</span> <span class="n">j</span><span class="bp">-</span><span class="n">loreaux</span><span class="bp">/</span><span class="n">data.fin.basic</span>
<span class="n">Your</span> <span class="n">branch</span> <span class="n">is</span> <span class="n">up</span><span class="bp">-</span><span class="n">to</span><span class="bp">-</span><span class="n">date</span> <span class="k">with</span> <span class="bp">'</span><span class="n">origin</span><span class="bp">/</span><span class="n">j</span><span class="bp">-</span><span class="n">loreaux</span><span class="bp">/</span><span class="n">data.fin.basic'.</span>

<span class="n">nothing</span> <span class="n">to</span> <span class="n">commit</span><span class="o">,</span> <span class="n">working</span> <span class="n">tree</span> <span class="n">clean</span>
<span class="n">buzzard</span><span class="bp">@</span><span class="n">brutus</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span>
</code></pre></div>



<a name="319547386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319547386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319547386">(Jan 05 2023 at 09:50)</a>:</h4>
<p>You need to merge master into your branch</p>



<a name="319547412"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319547412" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319547412">(Jan 05 2023 at 09:50)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> does it work on current <code>origin/master</code>?</p>



<a name="319547576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319547576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319547576">(Jan 05 2023 at 09:51)</a>:</h4>
<p>Aah, this branch is several weeks old so that might well be the issue. Yes it works on master on this machine!</p>



<a name="319547675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319547675" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319547675">(Jan 05 2023 at 09:52)</a>:</h4>
<p>I think it's good to mention somewhere (mathlib4 README, <code>lake exe cache</code> output) that you need <code>curl &gt;= 7.66.0</code> to use the <code>--parallel</code> flag. I'm probably not the only one with a 3+ year outdated curl.</p>



<a name="319547814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319547814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319547814">(Jan 05 2023 at 09:53)</a>:</h4>
<p>I don't like that it says "Attempting to download 789 file(s)" and then just sits there, with me not knowing if it's broken or not.</p>



<a name="319547833"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319547833" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319547833">(Jan 05 2023 at 09:53)</a>:</h4>
<p>One further remark: if I (re)run <code>lake exe cache get</code> when VSCode is open, I get an error on Windows.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Floris@MSI MINGW64 /d/projects/Mathlib4 <span class="o">((</span>cfd16dd8...<span class="o">))</span>
$ lake exe cache get
warning: manifest out of date: package directory changed, use <span class="sb">`</span>lake update<span class="sb">`</span> to update
No files to download
Decompressing <span class="m">789</span> file<span class="o">(</span>s<span class="o">)</span>
uncaught exception: lake-packages/std/build/lib/Std/Data/Array/Init/Lemmas.olean: Can<span class="err">'</span>t unlink already-existing object
tar: Error <span class="nb">exit</span> delayed from previous errors.
</code></pre></div>



<a name="319548083"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319548083" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319548083">(Jan 05 2023 at 09:55)</a>:</h4>
<p>I still have the same problem on the other machine though (Ubuntu 20.04, curl 7.68.0)</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">buzzard</span><span class="bp">@</span><span class="n">buster</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span> <span class="n">rm</span> <span class="bp">-</span><span class="n">rf</span> <span class="bp">.</span><span class="n">cache</span><span class="bp">/</span>
<span class="n">buzzard</span><span class="bp">@</span><span class="n">buster</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span>
<span class="n">Attempting</span> <span class="n">to</span> <span class="n">download</span> <span class="mi">789</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="n">Decompressing</span> <span class="mi">789</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="n">uncaught</span> <span class="n">exception</span><span class="o">:</span>
<span class="n">gzip</span><span class="o">:</span> <span class="n">stdin</span><span class="o">:</span> <span class="n">unexpected</span> <span class="kd">end</span> <span class="n">of</span> <span class="n">file</span>
<span class="n">tar</span><span class="o">:</span> <span class="n">Child</span> <span class="n">returned</span> <span class="n">status</span> <span class="mi">1</span>
<span class="n">tar</span><span class="o">:</span> <span class="n">Error</span> <span class="n">is</span> <span class="n">not</span> <span class="n">recoverable</span><span class="o">:</span> <span class="n">exiting</span> <span class="n">now</span>

<span class="n">buzzard</span><span class="bp">@</span><span class="n">buster</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span> <span class="n">git</span> <span class="n">status</span>
<span class="n">On</span> <span class="n">branch</span> <span class="n">master</span>
<span class="n">Your</span> <span class="n">branch</span> <span class="n">is</span> <span class="n">up</span><span class="bp">-</span><span class="n">to</span><span class="bp">-</span><span class="n">date</span> <span class="k">with</span> <span class="bp">'</span><span class="n">origin</span><span class="bp">/</span><span class="n">master'.</span>

<span class="n">nothing</span> <span class="n">to</span> <span class="n">commit</span><span class="o">,</span> <span class="n">working</span> <span class="n">tree</span> <span class="n">clean</span>
<span class="n">buzzard</span><span class="bp">@</span><span class="n">buster</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span> <span class="n">lake</span> <span class="c1">--version</span>
<span class="n">Lake</span> <span class="n">version</span> <span class="mi">4</span><span class="bp">.</span><span class="mi">1</span><span class="bp">.</span><span class="mi">0</span><span class="bp">-</span><span class="n">pre</span> <span class="o">(</span><span class="n">Lean</span> <span class="n">version</span> <span class="mi">4</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">0</span><span class="bp">-</span><span class="n">nightly</span><span class="bp">-</span><span class="mi">2023</span><span class="bp">-</span><span class="mi">01</span><span class="bp">-</span><span class="mi">04</span><span class="o">)</span>
<span class="n">buzzard</span><span class="bp">@</span><span class="n">buster</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">projects</span><span class="bp">/</span><span class="n">mathlib4</span><span class="bp">$</span>
</code></pre></div>



<a name="319549618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319549618" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319549618">(Jan 05 2023 at 10:04)</a>:</h4>
<p>Just checking: <code>git rev-parse HEAD</code> gives <code>cfd16dd8874d0989ff38ccd8b4727b59f17683e7</code>? (i.e. you did pull on the other machine?)</p>



<a name="319553753"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319553753" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319553753">(Jan 05 2023 at 10:29)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> try <code>lake exe cache get!</code> if you get an error like that. It looks like you have corrupted tar.gz files</p>



<a name="319583394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319583394" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319583394">(Jan 05 2023 at 13:18)</a>:</h4>
<p>While lake cache is really useful, I should report some weirdness in a project that has both a direct and transitive dependence on <code>mathlib</code>. I can successfully build <a href="https://github.com/siddhartha-gadgil/proofs-and-programs-2023.git">https://github.com/siddhartha-gadgil/proofs-and-programs-2023.git</a></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="o">:</span><span class="bp">//</span><span class="n">github.com</span><span class="bp">/</span><span class="n">siddhartha</span><span class="bp">-</span><span class="n">gadgil</span><span class="bp">/</span><span class="n">proofs</span><span class="bp">-</span><span class="n">and</span><span class="bp">-</span><span class="n">programs</span><span class="bp">-</span><span class="mi">2023</span><span class="bp">.</span><span class="n">git</span>
 <span class="n">cd</span> <span class="n">proofs</span><span class="bp">-</span><span class="n">and</span><span class="bp">-</span><span class="n">programs</span><span class="bp">-</span><span class="mi">2023</span><span class="bp">/</span>
 <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span>
 <span class="n">lake</span> <span class="n">build</span>
 <span class="n">rm</span> <span class="bp">-</span><span class="n">rf</span> <span class="n">build</span><span class="bp">/</span>
 <span class="n">lake</span> <span class="n">build</span>
</code></pre></div>
<p>The weird thing is that the first time I try to build it complains about a missing file while building a dependency. If I delete the file and continue the build it resumes and builds fine. </p>
<p>My guess is that this is a hash collision.</p>



<a name="319584078"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319584078" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319584078">(Jan 05 2023 at 13:23)</a>:</h4>
<p>Does LeanAide build after <code>cache get</code>?</p>



<a name="319584340"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319584340" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319584340">(Jan 05 2023 at 13:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319584078">said</a>:</p>
<blockquote>
<p>Does LeanAide build after <code>cache get</code>?</p>
</blockquote>
<p>Yes, for <code>LeanAide</code> <code>cache get</code> is working perfectly</p>



<a name="319585562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319585562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319585562">(Jan 05 2023 at 13:31)</a>:</h4>
<p>Does it decompress all files it tries to download? (~790 files)</p>



<a name="319587379"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319587379" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319587379">(Jan 05 2023 at 13:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319553753">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110038">Kevin Buzzard</span> try <code>lake exe cache get!</code> if you get an error like that. It looks like you have corrupted tar.gz files</p>
</blockquote>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>buzzard@buster:~/lean-projects/mathlib4$ git pull
Already up-to-date.
buzzard@buster:~/lean-projects/mathlib4$ git status
On branch master
Your branch is up-to-date with <span class="s1">'origin/master'</span>.

nothing to commit, working tree clean
buzzard@buster:~/lean-projects/mathlib4$ lake exe cache get!
Attempting to download <span class="m">790</span> file<span class="o">(</span>s<span class="o">)</span>
Decompressing <span class="m">790</span> file<span class="o">(</span>s<span class="o">)</span>
uncaught exception:
gzip: stdin: unexpected end of file
tar: Child returned status <span class="m">1</span>
tar: Error is not recoverable: exiting now
</code></pre></div>



<a name="319588916"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319588916" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319588916">(Jan 05 2023 at 13:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319585562">said</a>:</p>
<blockquote>
<p>Does it decompress all files it tries to download? (~790 files)</p>
</blockquote>
<p>Yes, and I can even find in <code>lake-packages</code> an <code>.olean</code> file it claims is missing.</p>



<a name="319589028"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319589028" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319589028">(Jan 05 2023 at 13:50)</a>:</h4>
<p>This could be some error in my intermediate dependency (there were some).</p>



<a name="319592781"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319592781" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319592781">(Jan 05 2023 at 14:08)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> I have a hunch that <code>curl</code> isn't working as intended on your older machine. It could be <code>tar</code> as well <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="319603058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319603058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319603058">(Jan 05 2023 at 14:58)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>buzzard@buster:~/lean-projects$ git clone git@github.com:leanprover-community/mathlib4.git
Cloning into <span class="s1">'mathlib4'</span>...
Warning: Permanently added the RSA host key <span class="k">for</span> IP address <span class="s1">'2a0c:5bc0:40:2fff::8c52:7904'</span> to the list of known hosts.
remote: Enumerating objects: <span class="m">21109</span>, <span class="k">done</span>.
remote: Counting objects: <span class="m">100</span>% <span class="o">(</span><span class="m">716</span>/716<span class="o">)</span>, <span class="k">done</span>.
remote: Compressing objects: <span class="m">100</span>% <span class="o">(</span><span class="m">327</span>/327<span class="o">)</span>, <span class="k">done</span>.
remote: Total <span class="m">21109</span> <span class="o">(</span>delta <span class="m">448</span><span class="o">)</span>, reused <span class="m">598</span> <span class="o">(</span>delta <span class="m">380</span><span class="o">)</span>, pack-reused <span class="m">20393</span>
Receiving objects: <span class="m">100</span>% <span class="o">(</span><span class="m">21109</span>/21109<span class="o">)</span>, <span class="m">6</span>.75 MiB <span class="p">|</span> <span class="m">10</span>.13 MiB/s, <span class="k">done</span>.
Resolving deltas: <span class="m">100</span>% <span class="o">(</span><span class="m">14652</span>/14652<span class="o">)</span>, <span class="k">done</span>.
buzzard@buster:~/lean-projects$ <span class="nb">cd</span> mathlib4
buzzard@buster:~/lean-projects/mathlib4$ lake exe cache get!
info: cloning https://github.com/leanprover/std4 to ././lake-packages/std
info: cloning https://github.com/gebner/quote4 to ././lake-packages/Qq
info: cloning https://github.com/JLimperg/aesop to ././lake-packages/aesop
info: Building Cache.IO
info: Compiling Cache.IO
info: Building Cache.Hashing
info: Compiling Cache.Hashing
info: Building Cache.Requests
info: Compiling Cache.Requests
info: Building Cache.Main
info: Compiling Cache.Main
info: Linking cache
Attempting to download <span class="m">790</span> file<span class="o">(</span>s<span class="o">)</span>
Decompressing <span class="m">790</span> file<span class="o">(</span>s<span class="o">)</span>
uncaught exception:
gzip: stdin: unexpected end of file
tar: Child returned status <span class="m">1</span>
tar: Error is not recoverable: exiting now

buzzard@buster:~/lean-projects/mathlib4$ curl --version
curl <span class="m">7</span>.68.0 <span class="o">(</span>x86_64-pc-linux-gnu<span class="o">)</span> libcurl/7.68.0 OpenSSL/1.1.1f zlib/1.2.11 brotli/1.0.7 libidn2/2.2.0 libpsl/0.21.0 <span class="o">(</span>+libidn2/2.2.0<span class="o">)</span> libssh/0.9.3/openssl/zlib nghttp2/1.40.0 librtmp/2.3
Release-Date: <span class="m">2020</span>-01-08
Protocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp
Features: AsynchDNS brotli GSS-API HTTP2 HTTPS-proxy IDN IPv6 Kerberos Largefile libz NTLM NTLM_WB PSL SPNEGO SSL TLS-SRP UnixSockets
buzzard@buster:~/lean-projects/mathlib4$ tar --version
tar <span class="o">(</span>GNU tar<span class="o">)</span> <span class="m">1</span>.30
Copyright © <span class="m">2017</span> Free Software Foundation, Inc.
Licence GPLv3+: GNU GPL version <span class="m">3</span> or later &lt;https://gnu.org/licences/gpl.html&gt;.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Written by John Gilmore and Jay Fenlason.
buzzard@buster:~/lean-projects/mathlib4$
</code></pre></div>
<p>This is an Ubuntu 20.04 laptop. Has anyone else got it working on Ubuntu 20.04? The Ubuntu 22 machine I was using this morning was working fine.</p>



<a name="319609396"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319609396" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319609396">(Jan 05 2023 at 15:27)</a>:</h4>
<p>I also have Ubuntu 20.04, and I'm getting the same error indeed.</p>



<a name="319609568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319609568" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319609568">(Jan 05 2023 at 15:28)</a>:</h4>
<p>I think <code>curl</code> is indeed misbehaving, my <code>.cache</code> folder seems to have a lot of empty files.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>vandoorn@pc93-178:~/projects/mathlib4<span class="o">((</span>HEAD detached at origin/master<span class="o">))</span>$ ls .cache/ -al
total <span class="m">73200</span>
drwxrwxr-x  <span class="m">2</span> vandoorn vandoorn   <span class="m">36864</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 .
drwxrwxr-x <span class="m">13</span> vandoorn vandoorn    <span class="m">4096</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 ..
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn  <span class="m">502564</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10004447746176569842</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10015491352002644549</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn   <span class="m">68157</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10018821831230171317</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">1001945985573292759</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10110306565386213522</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn  <span class="m">174259</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10127860650102912405</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10128865545074468906</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10130780366951701088</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10152004466792651860</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn  <span class="m">416066</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10152297513229284087</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn   <span class="m">25050</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10181612834428050335</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn   <span class="m">22944</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10190268219082491724</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn   <span class="m">85138</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10213030320477203917</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10214528561255169977</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10221609186266928200</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn   <span class="m">49324</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10227971936698935467</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn  <span class="m">169815</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10237809332798837709</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10329715650399075732</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn  <span class="m">377804</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10342692050553037471</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10345492726296217978</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn  <span class="m">329192</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10358353886519116077</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn   <span class="m">40472</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10381171239261229408</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn  <span class="m">200427</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10388488594487384490</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10394739949212461920</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn   <span class="m">24468</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10399526667226558710</span>.tar.gz
-rw-rw-r--  <span class="m">1</span> vandoorn vandoorn       <span class="m">0</span> Jan  <span class="m">5</span> <span class="m">16</span>:23 <span class="m">10423936910949293364</span>.tar.gz
<span class="o">[</span>...<span class="o">]</span>
</code></pre></div>



<a name="319610252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319610252" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319610252">(Jan 05 2023 at 15:31)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> I just had that problem and then a <code>get!</code> overwrote a file that wasn't downloaded properly.</p>
<p>What happens if you do this?<br>
<code>curl -X GET -f "https://lakecache.blob.core.windows.net/mathlib4/foo.bar" -o please.no</code></p>
<p>We expect <code>curl</code> not to create that <code>please.no</code> file on your file system</p>



<a name="319610591"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319610591" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319610591">(Jan 05 2023 at 15:33)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>buzzard@buster:~/lean-projects/mathlib4/crap$ curl -X GET -f <span class="s2">"https://lakecache.blob.core.windows.net/mathlib4/foo.bar"</span> -o please.no
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>    <span class="m">0</span>     <span class="m">0</span>      <span class="m">0</span>      <span class="m">0</span> --:--:-- --:--:-- --:--:--     <span class="m">0</span>
curl: <span class="o">(</span><span class="m">22</span><span class="o">)</span> The requested URL returned error: <span class="m">404</span> The specified blob does not exist.
buzzard@buster:~/lean-projects/mathlib4/crap$ ls
buzzard@buster:~/lean-projects/mathlib4/crap$
</code></pre></div>



<a name="319641701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319641701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319641701">(Jan 05 2023 at 18:04)</a>:</h4>
<p><a href="https://www.linuxcapable.com/how-to-install-upgrade-curl-on-ubuntu-20-04-lts/">https://www.linuxcapable.com/how-to-install-upgrade-curl-on-ubuntu-20-04-lts/</a> fixed the problem for me, although I'm now running curl as modified by some random person on the internet</p>



<a name="319677569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319677569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319677569">(Jan 05 2023 at 21:42)</a>:</h4>
<p>I get <code>gzip: stdin: unexpected end of file</code> on gitpod (Ubuntu 20.04.5 LTS) too, with curl version</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">curl</span> <span class="mi">7</span><span class="bp">.</span><span class="mi">68</span><span class="bp">.</span><span class="mi">0</span> <span class="o">(</span><span class="n">x86_64</span><span class="bp">-</span><span class="n">pc</span><span class="bp">-</span><span class="n">linux</span><span class="bp">-</span><span class="n">gnu</span><span class="o">)</span> <span class="n">libcurl</span><span class="bp">/</span><span class="mi">7</span><span class="bp">.</span><span class="mi">68</span><span class="bp">.</span><span class="mi">0</span> <span class="n">OpenSSL</span><span class="bp">/</span><span class="mi">1</span><span class="bp">.</span><span class="mi">1</span><span class="bp">.</span><span class="mi">1</span><span class="n">f</span> <span class="n">zlib</span><span class="bp">/</span><span class="mi">1</span><span class="bp">.</span><span class="mi">2</span><span class="bp">.</span><span class="mi">11</span> <span class="n">brotli</span><span class="bp">/</span><span class="mi">1</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">7</span> <span class="n">libidn2</span><span class="bp">/</span><span class="mi">2</span><span class="bp">.</span><span class="mi">2</span><span class="bp">.</span><span class="mi">0</span> <span class="n">libpsl</span><span class="bp">/</span><span class="mi">0</span><span class="bp">.</span><span class="mi">21</span><span class="bp">.</span><span class="mi">0</span> <span class="o">(</span><span class="bp">+</span><span class="n">libidn2</span><span class="bp">/</span><span class="mi">2</span><span class="bp">.</span><span class="mi">2</span><span class="bp">.</span><span class="mi">0</span><span class="o">)</span> <span class="n">libssh</span><span class="bp">/</span><span class="mi">0</span><span class="bp">.</span><span class="mi">9</span><span class="bp">.</span><span class="mi">3</span><span class="bp">/</span><span class="n">openssl</span><span class="bp">/</span><span class="n">zlib</span> <span class="n">nghttp2</span><span class="bp">/</span><span class="mi">1</span><span class="bp">.</span><span class="mi">40</span><span class="bp">.</span><span class="mi">0</span> <span class="n">librtmp</span><span class="bp">/</span><span class="mi">2</span><span class="bp">.</span><span class="mi">3</span>
<span class="n">Release</span><span class="bp">-</span><span class="n">Date</span><span class="o">:</span> <span class="mi">2020</span><span class="bp">-</span><span class="mi">01</span><span class="bp">-</span><span class="mi">08</span>
<span class="n">Protocols</span><span class="o">:</span> <span class="n">dict</span> <span class="n">file</span> <span class="n">ftp</span> <span class="n">ftps</span> <span class="n">gopher</span> <span class="n">http</span> <span class="n">https</span> <span class="n">imap</span> <span class="n">imaps</span> <span class="n">ldap</span> <span class="n">ldaps</span> <span class="n">pop3</span> <span class="n">pop3s</span> <span class="n">rtmp</span> <span class="n">rtsp</span> <span class="n">scp</span> <span class="n">sftp</span> <span class="n">smb</span> <span class="n">smbs</span> <span class="n">smtp</span> <span class="n">smtps</span> <span class="n">telnet</span> <span class="n">tftp</span>
<span class="n">Features</span><span class="o">:</span> <span class="n">AsynchDNS</span> <span class="n">brotli</span> <span class="n">GSS</span><span class="bp">-</span><span class="n">API</span> <span class="n">HTTP2</span> <span class="n">HTTPS</span><span class="bp">-</span><span class="n">proxy</span> <span class="n">IDN</span> <span class="n">IPv6</span> <span class="n">Kerberos</span> <span class="n">Largefile</span> <span class="n">libz</span> <span class="n">NTLM</span> <span class="n">NTLM_WB</span> <span class="n">PSL</span> <span class="n">SPNEGO</span> <span class="n">SSL</span> <span class="n">TLS</span><span class="bp">-</span><span class="n">SRP</span> <span class="n">UnixSockets</span>
</code></pre></div>



<a name="319678117"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319678117" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319678117">(Jan 05 2023 at 21:45)</a>:</h4>
<p>Following the instructions from the random person on the internet, I get the same error with the new version,</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ curl --version
curl <span class="m">7</span>.87.0 <span class="o">(</span>x86_64-pc-linux-gnu<span class="o">)</span> libcurl/7.87.0 OpenSSL/1.1.1f zlib/1.2.11 brotli/1.0.7 zstd/1.4.4 libidn2/2.2.0 libpsl/0.21.0 <span class="o">(</span>+libidn2/2.2.0<span class="o">)</span> libssh/0.9.3/openssl/zlib nghttp2/1.40.0 librtmp/2.3
Release-Date: <span class="m">2022</span>-12-21
Protocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtmp rtsp scp sftp smb smbs smtp smtps telnet tftp
Features: alt-svc AsynchDNS brotli GSS-API HSTS HTTP2 HTTPS-proxy IPv6 Kerberos Largefile libz NTLM NTLM_WB PSL SPNEGO SSL threadsafe TLS-SRP UnixSockets zstd
</code></pre></div>



<a name="319678577"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319678577" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319678577">(Jan 05 2023 at 21:48)</a>:</h4>
<p>Have you tried <code>get!</code> to overwrite corrupted downloads?</p>



<a name="319678613"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319678613" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319678613">(Jan 05 2023 at 21:49)</a>:</h4>
<p>Yes, it was <code>get!</code> that was failing</p>



<a name="319678698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319678698" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319678698">(Jan 05 2023 at 21:49)</a>:</h4>
<p>You should be able to debug this yourself if you want by opening gitpod with f1accc07b7ea20968ebf0d0d718e40d2a4528d7e checked out</p>



<a name="319680109"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319680109" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319680109">(Jan 05 2023 at 21:59)</a>:</h4>
<p>How do I access that?</p>



<a name="319681213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319681213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319681213">(Jan 05 2023 at 22:06)</a>:</h4>
<p><a href="http://gitpod.io/#https://github.com/leanprover-community/mathlib4">gitpod.io/#https://github.com/leanprover-community/mathlib4</a>, then <code>git fetch origin $THAT_SHA &amp;&amp; git checkout $THAT_SHA</code></p>



<a name="319681326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319681326" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319681326">(Jan 05 2023 at 22:07)</a>:</h4>
<p>You'll need to install the lean4 extension, open a lean file, then accept the popup to install elan</p>



<a name="319682701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319682701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319682701">(Jan 05 2023 at 22:18)</a>:</h4>
<p>Alright, I'll try to debug it later today. In the meantime you might want to try <code>get!</code> again</p>



<a name="319688006"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319688006" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319688006">(Jan 05 2023 at 22:56)</a>:</h4>
<p>Is this working for others on a mac? I'm just seeing:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">%</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span>
<span class="n">Attempting</span> <span class="n">to</span> <span class="n">download</span> <span class="mi">797</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="n">No</span> <span class="n">cache</span> <span class="n">files</span> <span class="n">to</span> <span class="n">decompress</span>
</code></pre></div>
<p>returning instantly, and then <code>lake build</code> compiles everything as normal.</p>



<a name="319689088"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319689088" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319689088">(Jan 05 2023 at 23:03)</a>:</h4>
<p>Hmm, more hash mismatches</p>



<a name="319690970"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319690970" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319690970">(Jan 05 2023 at 23:18)</a>:</h4>
<p>Separately, could we make the <code>cache commit</code> command more robust to build failures? E.g. see <a href="https://github.com/leanprover-community/mathlib4/actions/runs/3851007808/jobs/6561764041#step:8:9">https://github.com/leanprover-community/mathlib4/actions/runs/3851007808/jobs/6561764041#step:8:9</a></p>
<p>Here CI built lots of files, but one failed, but then cache commit didn't upload anything at all.</p>



<a name="319691680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319691680" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arien Malec <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319691680">(Jan 05 2023 at 23:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319688006">said</a>:</p>
<blockquote>
<p>Is this working for others on a mac? I'm just seeing:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">%</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span>
<span class="n">Attempting</span> <span class="n">to</span> <span class="n">download</span> <span class="mi">797</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="n">No</span> <span class="n">cache</span> <span class="n">files</span> <span class="n">to</span> <span class="n">decompress</span>
</code></pre></div>
<p>returning instantly, and then <code>lake build</code> compiles everything as normal.</p>
</blockquote>
<p>I get cache downloads but am seeing separate issues</p>



<a name="319692070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319692070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319692070">(Jan 05 2023 at 23:26)</a>:</h4>
<blockquote>
<p>Separately, could we make the <code>cache commit</code> command more robust to build failures?</p>
</blockquote>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1336">mathlib4#1336</a></p>



<a name="319693071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319693071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319693071">(Jan 05 2023 at 23:35)</a>:</h4>
<p>But this has nothing to do with <code>commit</code> right? We don't want to persist a commit with a file that didn't compile</p>



<a name="319693234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319693234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319693234">(Jan 05 2023 at 23:36)</a>:</h4>
<p>Yeah, I think Scott just said <code>commit</code> because it's the first command shown by github actions.  While it's the second <code>put</code> one that fails.</p>



<a name="319693383"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319693383" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319693383">(Jan 05 2023 at 23:38)</a>:</h4>
<p>Alright, this one should be a simple tweak</p>



<a name="319693463"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319693463" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319693463">(Jan 05 2023 at 23:38)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> I'm afraid I can't do much on that gitpod that doesn't decompress <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="319695661"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319695661" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319695661">(Jan 05 2023 at 23:59)</a>:</h4>
<p>What do you mean "that doesn't decompress"?</p>



<a name="319695775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319695775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319695775">(Jan 06 2023 at 00:00)</a>:</h4>
<p>Do you mean the cache is just bad on that commit?</p>



<a name="319695833"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319695833" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319695833">(Jan 06 2023 at 00:00)</a>:</h4>
<p>No, I just mean that it's failing to decompress</p>



<a name="319695875"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319695875" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319695875">(Jan 06 2023 at 00:01)</a>:</h4>
<p>I don't understand what "it" refers to</p>



<a name="319695956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319695956" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319695956">(Jan 06 2023 at 00:01)</a>:</h4>
<p>The execution of the program on your gitpod</p>



<a name="319696025"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319696025" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319696025">(Jan 06 2023 at 00:02)</a>:</h4>
<p>That's not "my" gitpod, that's a fresh gitpod instance spun up each time anyone clicks that link</p>



<a name="319696050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319696050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319696050">(Jan 06 2023 at 00:02)</a>:</h4>
<p>Do you mean the docker image never started up and you never got to vscode?</p>



<a name="319696148"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319696148" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319696148">(Jan 06 2023 at 00:03)</a>:</h4>
<p>No, I just mean that I don't know what to do with files that may be arriving corrupted on that machine</p>



<a name="319696536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319696536" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319696536">(Jan 06 2023 at 00:07)</a>:</h4>
<p>FWIW, I just tried it out on gitpod and all files in <code>.cache</code> were empty.</p>



<a name="319696921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319696921" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319696921">(Jan 06 2023 at 00:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319696148">said</a>:</p>
<blockquote>
<p>No, I just mean that I don't know what to do with files that may be arriving corrupted on that machine</p>
</blockquote>
<p>Oh, 'the program' refers to <code>lake exe cache</code>; I thought you were referring to gitpod itself as "the program"!</p>



<a name="319701407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319701407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319701407">(Jan 06 2023 at 00:57)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1361">mathlib4#1361</a></p>



<a name="319703651"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319703651" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319703651">(Jan 06 2023 at 01:19)</a>:</h4>
<p>About Mac issues... it's really hard for me to debug <span aria-label="dizzy" class="emoji emoji-1f635" role="img" title="dizzy">:dizzy:</span></p>



<a name="319703801"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319703801" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319703801">(Jan 06 2023 at 01:20)</a>:</h4>
<p>I don't have a computer with MacOS installed</p>



<a name="319705543"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319705543" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319705543">(Jan 06 2023 at 01:41)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span>, I can give you shell access here if you promise to be nice. :-)</p>



<a name="319706459"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319706459" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319706459">(Jan 06 2023 at 01:52)</a>:</h4>
<p>I would need an instance of VS Code running. I'm not hardcore enough for emacs/neovim</p>



<a name="319706642"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319706642" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319706642">(Jan 06 2023 at 01:55)</a>:</h4>
<p>I'm up for a pair programming session though, so we can try to figure out why the hashes aren't matching on your machine</p>



<a name="319706673"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319706673" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319706673">(Jan 06 2023 at 01:55)</a>:</h4>
<p>Let me know if you have some free time tomorrow</p>



<a name="319707826"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319707826" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319707826">(Jan 06 2023 at 02:09)</a>:</h4>
<p>I'm on Canberra time, which can be hard to coordinate with. I'm relatively flexible for the next 10 hours.</p>



<a name="319707951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319707951" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319707951">(Jan 06 2023 at 02:10)</a>:</h4>
<p>Separately, what do we think about giving out <code>cache put</code> privileges to a few people. (In particular, me. :-) I have a big machine, and when I'm in reviewing mode, I do a lot of local compilation. Seems a shame to waste it.)</p>



<a name="319708063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319708063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319708063">(Jan 06 2023 at 02:12)</a>:</h4>
<p>Very happy to try to diagnose the mac issues via pair programming, but you can in fact run a remote session in VS Code with nothing more than ssh access to the host. I do this all the time when I'm away from my desktop machine.</p>



<a name="319708079"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319708079" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319708079">(Jan 06 2023 at 02:12)</a>:</h4>
<p>In particular, the terminal window in VSCode is just a shell on the remote machine.</p>



<a name="319708119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319708119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319708119">(Jan 06 2023 at 02:13)</a>:</h4>
<p>I think <code>lake exe cache</code> is way too flaky for that at the moment.  For example it doesn't know if oleans are up to date.  If you do <code>echo this wont compile &gt;&gt; Mathlib/Algebra/Abs.lean</code>, then <code>lake exe cache put</code> will upload the old oleans for the modified file.</p>



<a name="319709470"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319709470" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319709470">(Jan 06 2023 at 02:33)</a>:</h4>
<p><span class="user-mention" data-user-id="110087">@Scott Morrison</span> the advantage of pair programming is that I can run the hashing algorithm on my machine and you can run on yours and we have an optimized/parallelized way to identify the source of divergence</p>



<a name="319709494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319709494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319709494">(Jan 06 2023 at 02:33)</a>:</h4>
<p>Sounds good. (That can also work with two VSCode windows, one local and one a remote session to my machine.)</p>



<a name="319709511"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319709511" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319709511">(Jan 06 2023 at 02:33)</a>:</h4>
<p>I'm free now if it suits.</p>



<a name="319709658"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319709658" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319709658">(Jan 06 2023 at 02:35)</a>:</h4>
<p>It's almost midnight now... I need to sleep. Maybe I can just try the remote access tomorrow. We can set it up later</p>



<a name="319719694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319719694" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319719694">(Jan 06 2023 at 05:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319688006">said</a>:</p>
<blockquote>
<p>Is this working for others on a mac? I'm just seeing:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">%</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span>
<span class="n">Attempting</span> <span class="n">to</span> <span class="n">download</span> <span class="mi">797</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="n">No</span> <span class="n">cache</span> <span class="n">files</span> <span class="n">to</span> <span class="n">decompress</span>
</code></pre></div>
<p>returning instantly, and then <code>lake build</code> compiles everything as normal.</p>
</blockquote>
<p><code>lake exe cache get</code> works perfectly on my Mac (M1 with OS 13.1 using MacPorts).</p>



<a name="319748200"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319748200" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319748200">(Jan 06 2023 at 09:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319707951">said</a>:</p>
<blockquote>
<p>Separately, what do we think about giving out <code>cache put</code> privileges to a few people.</p>
</blockquote>
<p>I see two obvious options:</p>
<ul>
<li>allow all maintainers</li>
<li>allow all reviewers</li>
</ul>
<p>Certainly at this point in time, maintainers should be enough. But once mathlib4 has grown we will probably want reviewers to be in the loop as well.</p>



<a name="319759047"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319759047" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319759047">(Jan 06 2023 at 11:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319708119">said</a>:</p>
<blockquote>
<p>I think <code>lake exe cache</code> is way too flaky for that at the moment.  For example it doesn't know if oleans are up to date.  If you do <code>echo this wont compile &gt;&gt; Mathlib/Algebra/Abs.lean</code>, then <code>lake exe cache put</code> will upload the old oleans for the modified file.</p>
</blockquote>
<p>That's true but it and any file that, transitively or not, depends on it, will have some useless hash that should never match with anything anyone will download</p>



<a name="319759484"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319759484" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319759484">(Jan 06 2023 at 11:09)</a>:</h4>
<p>About <code>put</code> privileges, just to say it out loud, I'm not the one who decides that. That's with the maintainers. I only have a key for dev purposes, which will expire in a few days</p>



<a name="319767961"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319767961" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319767961">(Jan 06 2023 at 12:05)</a>:</h4>
<p><span class="user-mention" data-user-id="110087">@Scott Morrison</span> <code>cache</code> is computing the hashes correctly on your machine but <code>cache get</code> was failing too fast (not even trying to download). So I checked <code>curl --version</code> and it said "7.64.something", which is too old. It's exiting with an error because it can't do <code>--parallel</code></p>



<a name="319773327"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319773327" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319773327">(Jan 06 2023 at 12:42)</a>:</h4>
<p>I too get <code> Can't unlink already-existing object</code> on Windows from VScode.</p>



<a name="319774567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319774567" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319774567">(Jan 06 2023 at 12:50)</a>:</h4>
<p>That looks like some IO error from <code>tar</code></p>



<a name="319774892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319774892" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319774892">(Jan 06 2023 at 12:52)</a>:</h4>
<p>Are you doing <code>cache get</code> while you can see orange bars of compilation? The orange bars mean that <code>olean</code> files might be in use and <code>tar</code> won't have the permission to overwrite them</p>



<a name="319777085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319777085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319777085">(Jan 06 2023 at 13:07)</a>:</h4>
<p>Ah I see. Is there a Lean 4 equivalent to <code>Lean: Check nothing</code>?</p>



<a name="319777338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319777338" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319777338">(Jan 06 2023 at 13:09)</a>:</h4>
<p>Closing all files seems to solve it.</p>



<a name="319779663"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319779663" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319779663">(Jan 06 2023 at 13:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319777085">said</a>:</p>
<blockquote>
<p>Ah I see. Is there a Lean 4 equivalent to <code>Lean: Check nothing</code>?</p>
</blockquote>
<p>I don't know</p>



<a name="319779859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319779859" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319779859">(Jan 06 2023 at 13:24)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1383">mathlib4#1383</a> implements a validation on the version of <code>curl</code><br>
It also removes an unnecessary workaround because of a bug that was fixed in core</p>



<a name="319819133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319819133" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319819133">(Jan 06 2023 at 16:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/316936698">said</a>:</p>
<blockquote>
<p>How far are we from <code>lake get-cache</code>? Switching branches and running <code>lake build</code> is quite time consuming.</p>
</blockquote>
<p>Since I started this thread, a lot has happened! <span class="user-mention" data-user-id="451983">@Arthur Paulino</span> thank you so much for all the time and energy you've poured into this! It works flawlessly on my side. Great work! <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span> <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="319819765"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319819765" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319819765">(Jan 06 2023 at 16:53)</a>:</h4>
<p>Don't forget to <code>lake exe cache clean</code> once in a while or your <code>.cache</code> folder will just grow and grow</p>



<a name="319826857"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319826857" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319826857">(Jan 06 2023 at 17:31)</a>:</h4>
<p>Could we have a loading bar when <code>lake</code> downloads the files? It's a bit dead in the <del>chat</del> terminal.</p>



<a name="319827044"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319827044" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319827044">(Jan 06 2023 at 17:32)</a>:</h4>
<p>Also, this <code>Can't unlink already-existing object</code> is quite annoying as the only solution I found so far is closing all Lean files.</p>



<a name="319828383"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319828383" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319828383">(Jan 06 2023 at 17:40)</a>:</h4>
<p>I can try the bar later, but <code>tar</code> won't trample a lock that your OS does</p>



<a name="319828574"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319828574" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319828574">(Jan 06 2023 at 17:41)</a>:</h4>
<p>If you don't want to lose your tabs, you can quit VS Code, do the caching thing and then open VS Code again</p>



<a name="319829542"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319829542" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319829542">(Jan 06 2023 at 17:47)</a>:</h4>
<p>Another thing you can try is pausing the Lean server in the top right corner of the infoview. Maybe that will unlock files that are being read so <code>tar</code> will have the permission to overwrite them</p>



<a name="319831046"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319831046" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319831046">(Jan 06 2023 at 17:55)</a>:</h4>
<p>Please let ppl know if this works<span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="319832464"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319832464" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319832464">(Jan 06 2023 at 18:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319759047">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319708119">said</a>:</p>
<blockquote>
<p>I think <code>lake exe cache</code> is way too flaky for that at the moment.  For example it doesn't know if oleans are up to date.  If you do <code>echo this wont compile &gt;&gt; Mathlib/Algebra/Abs.lean</code>, then <code>lake exe cache put</code> will upload the old oleans for the modified file.</p>
</blockquote>
<p>That's true but it and any file that, transitively or not, depends on it, will have some useless hash that should never match with anything anyone will download</p>
</blockquote>
<p>Other people <em>will</em> download it if you commit it.  This can happen very easily, if you modify a file and then run <code>lake exe cache put</code> <em>without</em> running <code>lake build</code> first.</p>



<a name="319832923"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319832923" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319832923">(Jan 06 2023 at 18:04)</a>:</h4>
<p>Deleting an open file is, it turns out, not quite straightforward on Windows: <a href="https://github.com/leanprover/lean4/blob/fedf235cba35ed8bf6bf571cf38e6d8536b904ac/src/library/module.cpp#L85-L89">https://github.com/leanprover/lean4/blob/fedf235cba35ed8bf6bf571cf38e6d8536b904ac/src/library/module.cpp#L85-L89</a>. I'm not surprised <code>tar</code> doesn't know about that. It would probably be easier to remove those files manually before invoking <code>tar</code>, though that would require a new runtime function implementing the linked code.</p>



<a name="319833150"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319833150" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319833150">(Jan 06 2023 at 18:06)</a>:</h4>
<p>Or rather we should just make <code>IO.FS.removeFile</code> do it</p>



<a name="319835348"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319835348" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319835348">(Jan 06 2023 at 18:19)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> please let me know if/when you implement it so I can upgrade <code>cache</code></p>



<a name="319843421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319843421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arien Malec <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319843421">(Jan 06 2023 at 19:02)</a>:</h4>
<p>On MacOS 13.0.1:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">clean</span><span class="bp">!</span>
<span class="n">arienmalec</span><span class="bp">@</span><span class="n">Ariens</span><span class="bp">-</span><span class="n">MBP</span><span class="bp">-</span><span class="mi">2</span> <span class="n">mwe</span> <span class="bp">%</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span>
<span class="n">Attempting</span> <span class="n">to</span> <span class="n">download</span> <span class="mi">804</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="n">Decompressing</span> <span class="mi">804</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
<span class="n">arienmalec</span><span class="bp">@</span><span class="n">Ariens</span><span class="bp">-</span><span class="n">MBP</span><span class="bp">-</span><span class="mi">2</span> <span class="n">mwe</span> <span class="bp">%</span> <span class="n">ls</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span>
<span class="n">Mathlib.ilean</span>   <span class="n">Mathlib.olean</span>   <span class="n">Mathlib.trace</span>   <span class="n">Mwe.ilean</span>
</code></pre></div>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">object</span> <span class="n">file</span> <span class="bp">'./</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">Mathlib</span><span class="bp">/</span><span class="n">Data</span><span class="bp">/</span><span class="n">Sum</span><span class="bp">/</span><span class="n">Basic.olean'</span> <span class="n">of</span> <span class="n">module</span> <span class="n">Mathlib.Data.Sum.Basic</span> <span class="n">does</span> <span class="n">not</span> <span class="n">exist</span>
</code></pre></div>



<a name="319847121"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319847121" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319847121">(Jan 06 2023 at 19:25)</a>:</h4>
<p>Is that a project that imports mathlib?</p>



<a name="319848544"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319848544" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319848544">(Jan 06 2023 at 19:33)</a>:</h4>
<p>I have very little bandwidth to fully support <code>cache</code> for projects that import Mathlib right now, sorry. I wanna focus on the support for people doing the port. Help is very much welcome though, and I'd be willing to answer questions and review PRs if someone wants to debug and fix <code>cache</code> for that use case</p>



<a name="319849295"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319849295" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arien Malec <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319849295">(Jan 06 2023 at 19:37)</a>:</h4>
<p>Gotcha -- yes, was trying to build an MWE space that used <code>Mathlib</code> as a client.</p>



<a name="319849720"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319849720" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319849720">(Jan 06 2023 at 19:39)</a>:</h4>
<p>But FWIW, if your Lake project is properly set to use mathlib as a dependency, <code>cache</code> should extract the olean files to <code>./lake-packages/...</code>, not <code>./build/...</code>. And you shouldn't be seeing an error message of a missed olean file from mathlib that is expected to be in <code>./build</code>. It should be in <code>./lake-packages/mathlib/build/...</code></p>



<a name="319850358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319850358" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arien Malec <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319850358">(Jan 06 2023 at 19:43)</a>:</h4>
<p>Then I assume there's some issue with lack of <code>lake-packages</code> awareness here.</p>



<a name="319850564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319850564" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319850564">(Jan 06 2023 at 19:44)</a>:</h4>
<p>There's probably something wrong with your <code>lakefile.lean</code>. The <a class="stream" data-stream-id="270676" href="/#narrow/stream/270676-lean4">#lean4</a> stream is the ideal place do get help about that</p>



<a name="319851018"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319851018" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arien Malec <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319851018">(Jan 06 2023 at 19:47)</a>:</h4>
<p>Unlikely, since I wiped and recreated from scratch. But again, if <em>using</em> mathlib as a client isn't a current concern, no issue right now.</p>



<a name="319886352"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319886352" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319886352">(Jan 07 2023 at 00:30)</a>:</h4>
<p>Feature request: Now that we download files one by one, could we ask to get cache for a specific file?</p>
<p>Typically I don't need most files to work on a given pull request and it's a waste to download them.</p>



<a name="319886514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319886514" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319886514">(Jan 07 2023 at 00:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319829542">said</a>:</p>
<blockquote>
<p>Another thing you can try is pausing the Lean server in the top right corner of the infoview. Maybe that will unlock files that are being read so <code>tar</code> will have the permission to overwrite them</p>
</blockquote>
<p>Doesn't work :(</p>



<a name="319917739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319917739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319917739">(Jan 07 2023 at 08:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319886352">said</a>:</p>
<blockquote>
<p>Feature request: Now that we download files one by one, could we ask to get cache for a specific file?</p>
<p>Typically I don't need most files to work on a given pull request and it's a waste to download them.</p>
</blockquote>
<p>Nice, I actually thought about that in the very beginning of the development. And now that the code is better structured, it's actually easy to implement it</p>



<a name="319919203"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319919203" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319919203">(Jan 07 2023 at 08:20)</a>:</h4>
<p>Do <code>ilean</code> or <code>olean</code> files keep track of the original paths of their respective Lean sources? I suspect this is probably why <code>cache get</code> isn't working for projects that import mathlib, since the sources for mathlib files will live inside <code>.lake-packages/mathlib</code> instead of <code>.</code>. That would invalidate the olean/ilean files</p>



<a name="319921635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/319921635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#319921635">(Jan 07 2023 at 08:44)</a>:</h4>
<p>It is actually mostly working, with an occasional failure as I reported earlier.</p>



<a name="320017495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320017495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320017495">(Jan 07 2023 at 23:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319696536">said</a>:</p>
<blockquote>
<p>FWIW, I just tried it out on gitpod and all files in <code>.cache</code> were empty.</p>
</blockquote>
<p>I now get only about half of the files being empty</p>



<a name="320017595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320017595" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320017595">(Jan 07 2023 at 23:57)</a>:</h4>
<p>(see <a href="https://github.com/leanprover-community/mathlib4/pull/1419">https://github.com/leanprover-community/mathlib4/pull/1419</a> for an easy way to startup gitpod to test this)</p>



<a name="320127029"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320127029" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320127029">(Jan 08 2023 at 23:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/319886352">said</a>:</p>
<blockquote>
<p>Feature request: Now that we download files one by one, could we ask to get cache for a specific file?</p>
<p>Typically I don't need most files to work on a given pull request and it's a waste to download them.</p>
</blockquote>
<p>Done in <a href="https://github.com/leanprover-community/mathlib/pull/1430">mathlib#1430</a> <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="320127266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320127266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ruben Van de Velde <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320127266">(Jan 08 2023 at 23:05)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1430">mathlib4#1430</a></p>



<a name="320127893"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320127893" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320127893">(Jan 08 2023 at 23:15)</a>:</h4>
<p>I made it more powerful than what was requested to avoid multiple <code>cache get</code> commands. Instead, you can request the download of cache files for lists of entire directories</p>



<a name="320127973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320127973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320127973">(Jan 08 2023 at 23:17)</a>:</h4>
<p>This is great. I had this in mind too, and then I thought it might be too much to ask <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="320128060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320128060" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320128060">(Jan 08 2023 at 23:18)</a>:</h4>
<p>One improvement that would save me a lot of time is if there was an option to tell it to figure out which files to download based on the diff with <code>master</code>. But that would be mathlib-specific, so I'm not sure how it would work.</p>



<a name="320128306"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320128306" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320128306">(Jan 08 2023 at 23:22)</a>:</h4>
<p>Doesn't it already only download the files that you don't have?</p>



<a name="320128340"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320128340" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320128340">(Jan 08 2023 at 23:23)</a>:</h4>
<p>so if you have been to <code>master</code> recently then you will have cache files for it and any that are shared with the branch will be used</p>



<a name="320128445"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320128445" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320128445">(Jan 08 2023 at 23:24)</a>:</h4>
<p>Yes, but if I am working on two level files <code>A</code> and <code>B</code> which don't import each other, then I would like to spare myself writing <code>lake exe cache get A B</code> because <code>A</code> and <code>B</code> will likely be longish names and I will need to get cache maybe 10 times in a day.</p>



<a name="320128498"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320128498" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320128498">(Jan 08 2023 at 23:25)</a>:</h4>
<p>you should get fish shell or something else with good command history</p>



<a name="320128568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320128568" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320128568">(Jan 08 2023 at 23:26)</a>:</h4>
<p>Ehrm, Gitpod...</p>



<a name="320128618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320128618" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320128618">(Jan 08 2023 at 23:27)</a>:</h4>
<p>I don't understand the idea. <code>lake exe cache get</code> on <code>master</code> should get you everything you don't have yet</p>



<a name="320128840"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320128840" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320128840">(Jan 08 2023 at 23:31)</a>:</h4>
<p>Yeah, and that's too much. I don't want to download the bazillion files that depend on <code>A</code> or <code>B</code>.</p>



<a name="320128912"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320128912" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320128912">(Jan 08 2023 at 23:32)</a>:</h4>
<p>Then <code>lake exe cache get path/to/A path/to/B</code></p>



<a name="320128950"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320128950" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320128950">(Jan 08 2023 at 23:33)</a>:</h4>
<p>Yeah, which is slightly too long for me to type it out every time.</p>



<a name="320129010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320129010" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320129010">(Jan 08 2023 at 23:34)</a>:</h4>
<p>Hence why it would be great if <code>lake</code> could detect that only <code>A</code> and <code>B</code> were touched from master.</p>



<a name="320129016"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320129016" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320129016">(Jan 08 2023 at 23:34)</a>:</h4>
<p>Use tab completion (that's why <code>.lean</code> is part of the file name, as opposed to what you suggested on the PR)</p>



<a name="320129072"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320129072" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320129072">(Jan 08 2023 at 23:35)</a>:</h4>
<p>Or just do <code>lake exe cache get *A.lean *B.lean</code></p>



<a name="320129213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320129213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320129213">(Jan 08 2023 at 23:37)</a>:</h4>
<p>If <code>A</code> is too generic and has a long path to it, like <code>Some/Really/Big/Path/A.lean</code>, then do <code>lake exe cache get *Path/A.lean</code></p>



<a name="320129393"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320129393" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320129393">(Jan 08 2023 at 23:39)</a>:</h4>
<p>I don't think the complexity you're asking for (parsing git diffs) is worth the effort here. Most people will just do history search on their terminals, when they're not just doing <code>lake exe cache get</code></p>



<a name="320129415"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320129415" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320129415">(Jan 08 2023 at 23:39)</a>:</h4>
<p>Yes probably</p>



<a name="320129517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320129517" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320129517">(Jan 08 2023 at 23:40)</a>:</h4>
<p>This is just ridiculous. The time taken to type path/to/A is surely comparable to the time taken to just download the entire cache! The brilliant cache system means I don't have to wait ten minutes but surely we can wait ten seconds!</p>



<a name="320129570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320129570" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320129570">(Jan 08 2023 at 23:41)</a>:</h4>
<p>Not if you're downloading it from my student room <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="320129576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320129576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320129576">(Jan 08 2023 at 23:41)</a>:</h4>
<p>:-/</p>



<a name="320129734"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320129734" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320129734">(Jan 08 2023 at 23:43)</a>:</h4>
<p>The feature is also an attempt to circumvent the flakiness of <code>curl -X GET</code> with less powerful connections, so that was another motivation</p>



<a name="320136300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320136300" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320136300">(Jan 09 2023 at 01:22)</a>:</h4>
<p>Another option is <code>lake exe cache get **/*A.lean</code> to recursively go down. Or <code>lake exe cache get $(find . -name "A.lean")</code> or <code>$(find . -name "*A.lean")</code>, depending on your use case. Use the shell to help you! I think it's too much to ask cli utils to replicate all the file directory walking that other more basic utilities do.</p>



<a name="320136453"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320136453" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320136453">(Jan 09 2023 at 01:24)</a>:</h4>
<p>If you care only (exactly) the files that have been modified wrt to <code>master</code>, then <code>$(git diff --name-only master --diff-filter=M)</code>.</p>



<a name="320137094"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320137094" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320137094">(Jan 09 2023 at 01:34)</a>:</h4>
<p>Are the semantics of <code>lake exe cache get $fname</code> "get the olean for <code>$fname</code> only" or "get all transitively-imported oleans needed for <code>$fname</code>"?</p>



<a name="320137333"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320137333" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320137333">(Jan 09 2023 at 01:38)</a>:</h4>
<p>And isn't <code>lake exe cache get *A.lean</code> expanded by the shell on Unix? If I do something sneaky like put a <code>*</code> in a filename, your code is going to double-expand it</p>



<a name="320137655"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320137655" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320137655">(Jan 09 2023 at 01:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/320137333">said</a>:</p>
<blockquote>
<p>If I do something sneaky like put a <code>*</code> in a filename, your code is going to double-expand it</p>
</blockquote>
<p>please don't do that</p>



<a name="320137889"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320137889" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320137889">(Jan 09 2023 at 01:47)</a>:</h4>
<p>Lean4 still allows anything you like as a module name as long as you import with <code>\f&lt;&lt;&gt;&gt;</code> like lean 3 did, right? (I still agree that we certainly shouldn't do it in mathlib)</p>



<a name="320137992"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320137992" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320137992">(Jan 09 2023 at 01:49)</a>:</h4>
<p>Yes. Note that even <code>Clear!.lean</code> caused some problems even though <code>!</code> is an identifier character in lean 4. I think it's best to be conservative with filename characters for portability given how many ways people manipulate filenames</p>



<a name="320138077"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138077" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138077">(Jan 09 2023 at 01:50)</a>:</h4>
<p>shell scripts are quite often not hardened against this kind of chicanery</p>



<a name="320138092"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138092" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138092">(Jan 09 2023 at 01:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/320137333">said</a>:</p>
<blockquote>
<p>And isn't <code>lake exe cache get *A.lean</code> expanded by the shell on Unix? If I do something sneaky like put a <code>*</code> in a filename, your code is going to double-expand it</p>
</blockquote>
<p>Some shells also give an error if the wildcard can't be expanded.  (I believe there's even a bash option for this.)</p>



<a name="320138106"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138106" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138106">(Jan 09 2023 at 01:50)</a>:</h4>
<p>I assume <span class="user-mention" data-user-id="451983">@Arthur Paulino</span> is a windows user</p>



<a name="320138116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138116" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138116">(Jan 09 2023 at 01:51)</a>:</h4>
<p>Does lean have any way to query "am I running on windows"?</p>



<a name="320138157"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138157" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138157">(Jan 09 2023 at 01:51)</a>:</h4>
<p>Because based on <a href="https://github.com/pallets/click/issues/1096#issuecomment-415866541">this comment</a> windows programs are expected to parse their own globs, but unix programs are not</p>



<a name="320138171"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138171" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138171">(Jan 09 2023 at 01:51)</a>:</h4>
<p><a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=System.Platform.isWindows#doc">docs4#System.Platform.isWindows</a></p>



<a name="320138256"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138256" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138256">(Jan 09 2023 at 01:52)</a>:</h4>
<blockquote>
<p>windows programs are expected to parse their own globs</p>
</blockquote>
<p>I believe windows programs are also expected to parse quotation marks.  I thought both quotation marks and wildcard expansion were already done by libc though?</p>



<a name="320138286"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138286" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138286">(Jan 09 2023 at 01:53)</a>:</h4>
<p>What does libc refer to on windows?</p>



<a name="320138294"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138294" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138294">(Jan 09 2023 at 01:53)</a>:</h4>
<p>windows has a libc</p>



<a name="320138363"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138363" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138363">(Jan 09 2023 at 01:54)</a>:</h4>
<p>Windows has MSVCRT, doesn't it? Wouldn't libc only be around if you use mingw?</p>



<a name="320138422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138422" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138422">(Jan 09 2023 at 01:55)</a>:</h4>
<p>I'm a linux user btw. Should I just use a different character then? Maybe <code>%</code>?</p>



<a name="320138426"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138426" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138426">(Jan 09 2023 at 01:55)</a>:</h4>
<p><a href="https://learn.microsoft.com/en-us/cpp/c-runtime-library/c-run-time-library-reference?view=msvc-170">https://learn.microsoft.com/en-us/cpp/c-runtime-library/c-run-time-library-reference?view=msvc-170</a></p>



<a name="320138483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138483">(Jan 09 2023 at 01:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/320138422">said</a>:</p>
<blockquote>
<p>I'm a linux user btw. Should I just use a different character then? Maybe <code>%</code>?</p>
</blockquote>
<p>Do your patterns have different semantics to the shell ones?</p>



<a name="320138493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138493" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138493">(Jan 09 2023 at 01:56)</a>:</h4>
<p>Because if they don't, then you probably don't need to implement them at all</p>



<a name="320138502"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138502" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138502">(Jan 09 2023 at 01:56)</a>:</h4>
<p>libc here meaning the library windows provides for making standards-conformant C programs (i.e. the ones with a <code>main()</code> function instead of <code>WinMain()</code>) run</p>



<a name="320138519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138519">(Jan 09 2023 at 01:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/320138493">said</a>:</p>
<blockquote>
<p>Because if they don't, then you probably don't need to implement them at all</p>
</blockquote>
<p>Nope... then I can just match file names as they are?</p>



<a name="320138546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138546">(Jan 09 2023 at 01:57)</a>:</h4>
<p>I mean, exact matches</p>



<a name="320138599"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138599" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138599">(Jan 09 2023 at 01:57)</a>:</h4>
<p>yes, on linux if you call <code>foo *.lean</code> the shell will actually call <code>foo A.lean B.lean</code> if those are the files in the directory</p>



<a name="320138604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138604" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138604">(Jan 09 2023 at 01:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/320138256">said</a>:</p>
<blockquote>
<blockquote>
<p>windows programs are expected to parse their own globs</p>
</blockquote>
<p>I believe windows programs are also expected to parse quotation marks.  I thought both quotation marks and wildcard expansion were already done by libc though?</p>
</blockquote>
<p><a href="https://learn.microsoft.com/en-us/cpp/c-language/expanding-wildcard-arguments?view=msvc-170">By default, wildcards aren't expanded in command-line arguments.</a> I don't know if Lean 4 is compiled with the opt-in parsing.</p>



<a name="320138648"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138648" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138648">(Jan 09 2023 at 01:58)</a>:</h4>
<p><code>*SomeFile.lean</code> did not work on my shell ootb btw. I relied on my match</p>



<a name="320138683"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138683" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138683">(Jan 09 2023 at 01:58)</a>:</h4>
<p>What is the full path that you wanted<code>*SomeFile.lean</code> to match?</p>



<a name="320138841"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138841" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138841">(Jan 09 2023 at 02:00)</a>:</h4>
<p><code>*SomeFile.lean</code> will match <code>FooSomeFile.lean</code> in the same directory, but not <code>Foo/SomeFile.lean</code> or <code>Foo/BarSomeFile.lean</code></p>



<a name="320138854"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138854" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138854">(Jan 09 2023 at 02:00)</a>:</h4>
<p>you need to use <code>**/*SomeFile.lean</code> to match the latter</p>



<a name="320138898"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138898" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138898">(Jan 09 2023 at 02:01)</a>:</h4>
<p>Ah, got it</p>



<a name="320138909"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138909" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138909">(Jan 09 2023 at 02:02)</a>:</h4>
<p>You might need to change your shell settings to enable that, it's not on by default</p>



<a name="320138925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320138925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320138925">(Jan 09 2023 at 02:02)</a>:</h4>
<p>I will remove the custom matches then and use exact matches</p>



<a name="320139739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320139739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320139739">(Jan 09 2023 at 02:13)</a>:</h4>
<p>PR updated: <a href="https://github.com/leanprover-community/mathlib4/pull/1430">mathlib4#1430</a></p>



<a name="320139995"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320139995" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320139995">(Jan 09 2023 at 02:16)</a>:</h4>
<p>I tried using <code>curl</code> progress bar but it prints a lot of trash when trying to download files that don't exist on the server</p>



<a name="320140064"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320140064" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320140064">(Jan 09 2023 at 02:17)</a>:</h4>
<p>So I guess no progress bar until we have a Lean implementation of a proper lib for HTTP requests</p>



<a name="320140475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320140475" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320140475">(Jan 09 2023 at 02:22)</a>:</h4>
<p>This is far from anything I am competent with, but as a bridge would it be good to have a Lean ffi wrapper around <a href="https://curl.se/libcurl/">libcurl</a> instead of calling the different shells with curl?</p>



<a name="320140712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320140712" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320140712">(Jan 09 2023 at 02:26)</a>:</h4>
<p>I believe someday we will have that. I definitely don't have time for it right now</p>



<a name="320142131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320142131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320142131">(Jan 09 2023 at 02:51)</a>:</h4>
<p>I had considered this for <code>LeanAide</code> but I am still unfamiliar with ffi (and in general unskilled in C/system stuff). But hopefully someone with the time and expertise will create a minimal <code>lean-curl</code> which can then be expanded to more of the API.</p>



<a name="320178107"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320178107" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320178107">(Jan 09 2023 at 09:19)</a>:</h4>
<p>I suspect distributing <code>lake exe cache</code> with an appropriate libcurl might be rather annoying, especially on windows</p>



<a name="320398283"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320398283" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320398283">(Jan 10 2023 at 08:30)</a>:</h4>
<p>How hard would it be to have a button in the infoview that runs <code>lake exe cache get X</code> when file <code>X</code> is open?</p>



<a name="320398587"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320398587" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320398587">(Jan 10 2023 at 08:32)</a>:</h4>
<p>Or <code>Ctrl-Shift-P: Lake ...</code> something something?</p>



<a name="320398645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320398645" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320398645">(Jan 10 2023 at 08:32)</a>:</h4>
<p>Yeah, that would be good too, although probably less discoverable.</p>



<a name="320398915"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320398915" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320398915">(Jan 10 2023 at 08:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/320398283">said</a>:</p>
<blockquote>
<p>How hard would it be to have a button in the infoview that runs <code>lake exe cache get X</code> when file <code>X</code> is open?</p>
</blockquote>
<p>That won't work without the upgrade on <code>IO.removeFile</code> to remove files being read</p>



<a name="320399000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320399000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320399000">(Jan 10 2023 at 08:35)</a>:</h4>
<p>Did that not already happen? I just ran <code>lake exe cache get</code> with <code>Algebra.Order.AbsoluteValue</code> and nothing complained about linked files.</p>



<a name="320399213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320399213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320399213">(Jan 10 2023 at 08:36)</a>:</h4>
<p>Nope... well, I haven't touched it.</p>
<p>Also, <code>cache</code> is an application that lives in <code>mathlib4</code> and the infoview is not mathlib4 specific</p>



<a name="320399300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320399300" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320399300">(Jan 10 2023 at 08:37)</a>:</h4>
<p>That's not a problem. We can and do override infoview functions, or at least we could in Lean 3.</p>



<a name="320399380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320399380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320399380">(Jan 10 2023 at 08:38)</a>:</h4>
<p>See <a href="https://tqft.net/mathlib/tactic/interactive_expr">file#tactic/interactive_expr</a></p>



<a name="320399433"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320399433" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320399433">(Jan 10 2023 at 08:38)</a>:</h4>
<ol start="404">
<li>But what would that do?</li>
</ol>



<a name="320399493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320399493" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320399493">(Jan 10 2023 at 08:39)</a>:</h4>
<p>Is it a button that only appears when you're in mathlib?</p>



<a name="320399552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320399552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320399552">(Jan 10 2023 at 08:39)</a>:</h4>
<p>Yes, that's how it would look like.</p>



<a name="320399733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320399733" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320399733">(Jan 10 2023 at 08:40)</a>:</h4>
<p>So that's two things: I haven't touched the code that overwrites oleans being read and I don't know about these repo-specific buttons</p>



<a name="320399740"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320399740" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320399740">(Jan 10 2023 at 08:40)</a>:</h4>
<p>If you've ever tried to open core files, you will see that the infoview looks different to the one you get in mathlib. And that difference come from the two lines here: <a href="https://github.com/leanprover-community/mathlib/blob/master/src/tactic/interactive_expr.lean#L496-L497">https://github.com/leanprover-community/mathlib/blob/master/src/tactic/interactive_expr.lean#L496-L497</a></p>



<a name="320399896"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320399896" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320399896">(Jan 10 2023 at 08:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/320399733">said</a>:</p>
<blockquote>
<p>So that's two things: I haven't touched the code that overwrites oleans being read and I don't know about these repo-specific buttons</p>
</blockquote>
<p>But if someone else knows how to get around these two points, please go ahead</p>



<a name="320400102"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320400102" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320400102">(Jan 10 2023 at 08:43)</a>:</h4>
<p>I know how to do the second one. Indeed I had to touch the machinery myself in <a href="https://github.com/leanprover-community/mathlib/pull/15959">#15959</a>. I have no idea about the first, though.</p>



<a name="320400145"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320400145" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320400145">(Jan 10 2023 at 08:43)</a>:</h4>
<p>For the former, we need an upgraded version of <code>IO.removeFile</code> that Sebastian said should be implemented in core. I don't know the status of that</p>



<a name="320464236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320464236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320464236">(Jan 10 2023 at 14:33)</a>:</h4>
<p><span aria-label="ping pong" class="emoji emoji-1f3d3" role="img" title="ping pong">:ping_pong:</span> <a href="https://github.com/leanprover-community/mathlib4/pull/1430">mathlib4#1430</a></p>



<a name="320564443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/320564443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#320564443">(Jan 10 2023 at 23:25)</a>:</h4>
<p>This one is a typo that <span class="user-mention" data-user-id="387244">@Yaël Dillies</span> noticed. The PR is very easy to review:<br>
<a href="https://github.com/leanprover-community/mathlib4/pull/1472">mathlib4#1472</a></p>



<a name="321049781"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321049781" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321049781">(Jan 12 2023 at 22:52)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span>, whatever I try, I still cannot get <code>lake exe cache get some_file</code> to work.</p>



<a name="321049836"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321049836" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321049836">(Jan 12 2023 at 22:53)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span> <span class="n">Mathlib</span><span class="bp">/</span><span class="n">Data</span><span class="bp">/</span><span class="n">Rat</span><span class="bp">/*.</span><span class="n">lean</span>
<span class="n">warning</span><span class="o">:</span> <span class="n">manifest</span> <span class="n">out</span> <span class="n">of</span> <span class="n">date</span><span class="o">:</span> <span class="n">package</span> <span class="n">directory</span> <span class="n">changed</span><span class="o">,</span> <span class="n">use</span> <span class="bp">`</span><span class="n">lake</span> <span class="n">update</span><span class="bp">`</span> <span class="n">to</span> <span class="n">update</span>
<span class="n">uncaught</span> <span class="n">exception</span><span class="o">:</span> <span class="n">No</span> <span class="k">match</span> <span class="n">for</span> <span class="n">Mathlib</span><span class="bp">/</span><span class="n">Data</span><span class="bp">/</span><span class="n">Rat</span><span class="bp">/</span><span class="n">Basic.lean</span>
</code></pre></div>



<a name="321049860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321049860" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321049860">(Jan 12 2023 at 22:53)</a>:</h4>
<p>Is this a Windows bug, maybe?</p>



<a name="321050075"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321050075" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321050075">(Jan 12 2023 at 22:54)</a>:</h4>
<p>Aren't Windows paths build with <code>\</code> instead of <code>/</code>?</p>



<a name="321050103"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321050103" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321050103">(Jan 12 2023 at 22:54)</a>:</h4>
<p>As in, your match is expanded with <code>/</code>, then it fails because Windows expects <code>\</code></p>



<a name="321050162"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321050162" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321050162">(Jan 12 2023 at 22:55)</a>:</h4>
<p>Ah so your program isn't doing anything about it!</p>



<a name="321050314"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321050314" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321050314">(Jan 12 2023 at 22:56)</a>:</h4>
<p>It is unexpected that the exact syntax from the help menu can't be used because it is OS-dependent.</p>



<a name="321050416"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321050416" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321050416">(Jan 12 2023 at 22:57)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span> <span class="n">Mathlib</span><span class="bp">\\</span><span class="n">Data</span><span class="bp">\\</span><span class="n">Rat</span><span class="bp">\\*.</span><span class="n">lean</span>
</code></pre></div>
<p>does work, but that's unergonomic.</p>



<a name="321050618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321050618" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321050618">(Jan 12 2023 at 22:58)</a>:</h4>
<p>Sorry, the paths in the hashmap are built with the separators that the current OS uses. Can't you at least use tab completion on Windows?</p>



<a name="321050679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321050679" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321050679">(Jan 12 2023 at 22:59)</a>:</h4>
<p>Not sure how that works</p>



<a name="321050749"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321050749" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321050749">(Jan 12 2023 at 22:59)</a>:</h4>
<p>Actually, it seems like the tab completion only works with <code>/</code> <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="321051273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321051273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321051273">(Jan 12 2023 at 23:03)</a>:</h4>
<p>What the... <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="321052137"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321052137" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321052137">(Jan 12 2023 at 23:09)</a>:</h4>
<p>Can your command just ignore Windows' weirdness and build the hasmap from <code>/</code>?</p>



<a name="321052308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321052308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321052308">(Jan 12 2023 at 23:11)</a>:</h4>
<p>It would be a bit of a nightmare to implement that. I'm using <code>System.FilePath</code> API to handle that for me</p>



<a name="321052487"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321052487" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321052487">(Jan 12 2023 at 23:12)</a>:</h4>
<p>/me is <span aria-label="face with symbols on mouth" class="emoji emoji-1f92c" role="img" title="face with symbols on mouth">:face_with_symbols_on_mouth:</span> Windows</p>



<a name="321052722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321052722" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321052722">(Jan 12 2023 at 23:14)</a>:</h4>
<p>Even if I do replace <code>/</code> for <code>\\</code> on Windows on the arguments of <code>cache get</code>, I'm not sure if automatic glob expansion works with <code>/</code> on Windows</p>



<a name="321052763"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321052763" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321052763">(Jan 12 2023 at 23:14)</a>:</h4>
<p><span class="user-mention" data-user-id="387244">@Yaël Dillies</span> do you know how to test that?</p>



<a name="321052860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321052860" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321052860">(Jan 12 2023 at 23:15)</a>:</h4>
<p>I'm afraid I am a Windows power-sufferer, not a Windows power-user.</p>



<a name="321052892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321052892" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321052892">(Jan 12 2023 at 23:15)</a>:</h4>
<p>What is automatic glob expansion?</p>



<a name="321053090"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321053090" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321053090">(Jan 12 2023 at 23:17)</a>:</h4>
<p>Have you ever programmed something that reads arguments from the shell input?</p>



<a name="321053232"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321053232" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321053232">(Jan 12 2023 at 23:18)</a>:</h4>
<p>No, never</p>



<a name="321053490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321053490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321053490">(Jan 12 2023 at 23:20)</a>:</h4>
<p>Suppose we have</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">main</span> <span class="o">(</span><span class="n">args</span> <span class="o">:</span> <span class="n">List</span> <span class="n">String</span><span class="o">)</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="n">IO.println</span> <span class="n">args</span>
</code></pre></div>
<p>that compiles to some binary <code>./build/bin/foo</code>. Then, with automatic glob expansion, if you call <code>./build/bin/foo *.txt</code>, your program will print every filepath that ends with <code>.txt</code> in the current folder</p>



<a name="321053581"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321053581" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321053581">(Jan 12 2023 at 23:21)</a>:</h4>
<p>Note that this only happens in a shell context</p>



<a name="321053613"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321053613" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321053613">(Jan 12 2023 at 23:22)</a>:</h4>
<p>This is not the actual behaviour of the system calls that perform the call, your shell does the glob expansion.</p>



<a name="321053622"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321053622" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321053622">(Jan 12 2023 at 23:22)</a>:</h4>
<p>That's something the shell does for you. The source code of the program does not contain any logic to do that search</p>



<a name="321054080"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321054080" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sky Wilshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321054080">(Jan 12 2023 at 23:26)</a>:</h4>
<p><a href="/user_uploads/3121/ARjEqG7Xu16IFoBToUmLF-23/image.png">image.png</a> It does work on Windows - at least in Powershell.</p>
<div class="message_inline_image"><a href="/user_uploads/3121/ARjEqG7Xu16IFoBToUmLF-23/image.png" title="image.png"><img src="/user_uploads/3121/ARjEqG7Xu16IFoBToUmLF-23/image.png"></a></div>



<a name="321054107"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321054107" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sky Wilshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321054107">(Jan 12 2023 at 23:26)</a>:</h4>
<p>Unless <code>cat</code> is doing some processing itself.</p>



<a name="321054163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321054163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321054163">(Jan 12 2023 at 23:27)</a>:</h4>
<p>Yeah can you test with a program that you write yourself please?</p>



<a name="321054199"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321054199" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321054199">(Jan 12 2023 at 23:27)</a>:</h4>
<p>It can be this simple:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">main</span> <span class="o">(</span><span class="n">args</span> <span class="o">:</span> <span class="n">List</span> <span class="n">String</span><span class="o">)</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="n">IO.println</span> <span class="n">args</span>
</code></pre></div>



<a name="321054301"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321054301" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321054301">(Jan 12 2023 at 23:28)</a>:</h4>
<p>If that works, I can do the upgrade tomorrow</p>



<a name="321054324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321054324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sky Wilshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321054324">(Jan 12 2023 at 23:28)</a>:</h4>
<p>I don't have easy access to a Lean executable at the minute but...<br>
<a href="/user_uploads/3121/qlIEXdXUasF-Bk_F3_czKLmK/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/qlIEXdXUasF-Bk_F3_czKLmK/image.png" title="image.png"><img src="/user_uploads/3121/qlIEXdXUasF-Bk_F3_czKLmK/image.png"></a></div>



<a name="321054369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321054369" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sky Wilshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321054369">(Jan 12 2023 at 23:29)</a>:</h4>
<p>which is a bit disappointing.</p>



<a name="321054654"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321054654" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321054654">(Jan 12 2023 at 23:31)</a>:</h4>
<p>Well well well, I guess I can do a custom processing in <code>get</code>/<code>get!</code> parameters on Windows and do the match manually</p>



<a name="321054750"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321054750" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321054750">(Jan 12 2023 at 23:32)</a>:</h4>
<p>But it's not going to be as powerful as native glob expansions. I can handle one wildcard, at most. I had this logic implemented on a previous version</p>



<a name="321055389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321055389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321055389">(Jan 12 2023 at 23:38)</a>:</h4>
<p>You shouldn't implement this in <code>lake exe cache</code></p>



<a name="321055402"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321055402" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321055402">(Jan 12 2023 at 23:38)</a>:</h4>
<p>If this isn't working, we need to set a compilation flag for lean somewhere</p>



<a name="321055425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321055425" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321055425">(Jan 12 2023 at 23:39)</a>:</h4>
<p>See <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/320138604">this message</a></p>



<a name="321055508"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321055508" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sky Wilshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321055508">(Jan 12 2023 at 23:40)</a>:</h4>
<p>Oh wow, I love Windows' idiosyncrasies :/</p>



<a name="321055830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321055830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321055830">(Jan 12 2023 at 23:42)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> I don't understand it. Then it should be a matter of setting that flag in the compilation of Lean and everything should work ootb?</p>



<a name="321056324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321056324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321056324">(Jan 12 2023 at 23:47)</a>:</h4>
<p>Yes, that would be my hope</p>



<a name="321056382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321056382" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321056382">(Jan 12 2023 at 23:48)</a>:</h4>
<p>In the meantime, windows users can just use a different shell</p>



<a name="321056397"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321056397" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321056397">(Jan 12 2023 at 23:48)</a>:</h4>
<p>I would expect that most Lean users have git bash installed</p>



<a name="321056421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321056421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321056421">(Jan 12 2023 at 23:48)</a>:</h4>
<p>Powershell has its own version of glob too</p>



<a name="321056457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321056457" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321056457">(Jan 12 2023 at 23:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321050618">said</a>:</p>
<blockquote>
<p>Sorry, the paths in the hashmap are built with the separators that the current OS uses. Can't you at least use tab completion on Windows?</p>
</blockquote>
<p>You should normalize the paths to use <code>/</code> before using them in the hash map; otherwise won't your hash computation be wrong?</p>



<a name="321056721"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321056721" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321056721">(Jan 12 2023 at 23:51)</a>:</h4>
<p>If I did normalization, I would have to "denormalize" everytime i'd use it for pointing to files. That would be a mess. I don't hash the path per se. I hash its components (<code>System.FilePath.components : FilePath -&gt; List String</code>)</p>



<a name="321056854"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321056854" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321056854">(Jan 12 2023 at 23:52)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/blob/aec2f1d48aa89d0e47360ef080ff0fb487766533/Cache/Hashing.lean#L79">https://github.com/leanprover-community/mathlib4/blob/aec2f1d48aa89d0e47360ef080ff0fb487766533/Cache/Hashing.lean#L79</a></p>



<a name="321057131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321057131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321057131">(Jan 12 2023 at 23:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321056397">said</a>:</p>
<blockquote>
<p>I would expect that most Lean users have git bash installed</p>
</blockquote>
<p><span class="user-mention" data-user-id="387244">@Yaël Dillies</span> do you want to test git bash? <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="321058095"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321058095" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321058095">(Jan 13 2023 at 00:03)</a>:</h4>
<blockquote>
<p>If I did normalization, I would have to "denormalize" everytime i'd use it for pointing to files</p>
</blockquote>
<p>Windows should do this for you</p>



<a name="321058198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321058198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321058198">(Jan 13 2023 at 00:04)</a>:</h4>
<p>Also, by normalize I also mean deal with paths like <code>Mathlib/../Mathlib/../Data/Nat/../Nat/Basic.lean</code></p>



<a name="321059279"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321059279" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321059279">(Jan 13 2023 at 00:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321055830">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> I don't understand it. Then it should be a matter of setting that flag in the compilation of Lean and everything should work ootb?</p>
</blockquote>
<p>Ah nevermind, Lean is built with <code>msys2</code> (which expects you to run in a gnu runtime like git bash) not <code>msvc</code> (for which the link above is relevant)</p>



<a name="321059345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321059345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321059345">(Jan 13 2023 at 00:14)</a>:</h4>
<p>Any attempt to fix shell globbing within <code>lake exe cache</code> itself will break people in shells that already handle this themselves.</p>



<a name="321061990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321061990" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321061990">(Jan 13 2023 at 00:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321059345">said</a>:</p>
<blockquote>
<p>Any attempt to fix shell globbing within <code>lake exe cache</code> itself will break people in shells that already handle this themselves.</p>
</blockquote>
<p>I disagree. We can process paths that get into the program and that still contain <code>*</code>. That means the shell didn't do anything for the user. That's what I had in mind in my previous implementation</p>



<a name="321062664"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321062664" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321062664">(Jan 13 2023 at 00:43)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> if any of you give me a thumbs up, I can recover that customized post-processing behavior (and further replace <code>/</code>s by <code>\\</code>s on Windows in case the user used tab completion as Yael tried)</p>



<a name="321063964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321063964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321063964">(Jan 13 2023 at 00:54)</a>:</h4>
<blockquote>
<p>I can recover that customized post-processing behavior</p>
</blockquote>
<p>I firmly believe that we shouldn't do that. If you want to be able to pass basic filename patterns to a program, use a shell that supports it. Everyone contributing to mathlib4 has git installed on the machine they develop on, and I'm pretty sure that comes with git bash on platforms not already equipped with a shell. I suppose if you really insist you could hide it between <code>--cmd-glob</code> (meaning "I am using <code>cmd</code> so need you to do glob expansion for me"). Even detecting windows would be a bad idea as you might be called from a reasonable shell.</p>



<a name="321063985"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321063985" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321063985">(Jan 13 2023 at 00:55)</a>:</h4>
<blockquote>
<p>(and further replace /s by \\s on Windows in case the user used tab completion as Yael tried)</p>
</blockquote>
<p>did you see <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=System.FilePath.normalize#doc">docs4#System.FilePath.normalize</a> ? You should just use that all the time on the user input (and on the paths in your hash map)</p>



<a name="321064240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321064240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321064240">(Jan 13 2023 at 00:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321063985">said</a>:</p>
<blockquote>
<blockquote>
<p>(and further replace /s by \\s on Windows in case the user used tab completion as Yael tried)</p>
</blockquote>
<p>did you see <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=System.FilePath.normalize#doc">docs4#System.FilePath.normalize</a> ? You should just use that all the time on the user input (and on the paths in your hash map)</p>
</blockquote>
<p>The paths in the hashmap are tailored from imported modules</p>



<a name="321064366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321064366" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321064366">(Jan 13 2023 at 00:58)</a>:</h4>
<p>I can do an upgrade and do that on the input paths from the user in the <code>get</code> and <code>get!</code> commands</p>



<a name="321064493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321064493" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321064493">(Jan 13 2023 at 00:59)</a>:</h4>
<blockquote>
<p>The paths in the hashmap are tailored from imported modules</p>
</blockquote>
<p>What does this mean?</p>



<a name="321066919"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321066919" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321066919">(Jan 13 2023 at 01:24)</a>:</h4>
<p>It means that I don't build paths from the result of scanning the FS directly. If a file imports <code>Foo.Bar</code> I make a file path from that module name</p>



<a name="321066969"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321066969" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321066969">(Jan 13 2023 at 01:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321064366">said</a>:</p>
<blockquote>
<p>I can do an upgrade and do that on the input paths from the user in the <code>get</code> and <code>get!</code> commands</p>
</blockquote>
<p>Actually nvm. This won't solve any problem we are seeing today</p>



<a name="321069382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321069382" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321069382">(Jan 13 2023 at 01:54)</a>:</h4>
<blockquote>
<p>I make a file path from that module name</p>
</blockquote>
<p>How do you do that?</p>



<a name="321071849"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321071849" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321071849">(Jan 13 2023 at 02:25)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/blob/aec2f1d48aa89d0e47360ef080ff0fb487766533/Cache/Hashing.lean#L42-L49">https://github.com/leanprover-community/mathlib4/blob/aec2f1d48aa89d0e47360ef080ff0fb487766533/Cache/Hashing.lean#L42-L49</a></p>



<a name="321073031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321073031" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321073031">(Jan 13 2023 at 02:40)</a>:</h4>
<p>Note you can use <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Name.components#doc">docs4#Lean.Name.components</a> rather than stringifying and splitting</p>



<a name="321073326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321073326" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321073326">(Jan 13 2023 at 02:44)</a>:</h4>
<p>But I agree there's no need to normalize those paths</p>



<a name="321073360"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321073360" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321073360">(Jan 13 2023 at 02:45)</a>:</h4>
<p>They already use a <code>\</code> on windows</p>



<a name="321074964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321074964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321074964">(Jan 13 2023 at 03:05)</a>:</h4>
<p>Lean.Name.components return a list of names anyways</p>



<a name="321075020"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321075020" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321075020">(Jan 13 2023 at 03:06)</a>:</h4>
<p>I would have to stringfy each separately</p>



<a name="321089353"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321089353" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321089353">(Jan 13 2023 at 06:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321052860">said</a>:</p>
<blockquote>
<p>I'm afraid I am a Windows power-sufferer, not a Windows power-user.</p>
</blockquote>
<p>It's time to leave the dark side! Step in to the light!</p>
<p><span aria-label="penguin" class="emoji emoji-1f427" role="img" title="penguin">:penguin:</span> <span aria-label="penguin" class="emoji emoji-1f427" role="img" title="penguin">:penguin:</span> <span aria-label="penguin" class="emoji emoji-1f427" role="img" title="penguin">:penguin:</span> <br>
<span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span> <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span> <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span></p>



<a name="321096012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321096012" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321096012">(Jan 13 2023 at 07:29)</a>:</h4>
<p>Yael are you not using git bash?</p>



<a name="321104329"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321104329" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321104329">(Jan 13 2023 at 08:30)</a>:</h4>
<p>I am using whatever VScode's terminal is, which seems to be bash. How do I change the default?</p>



<a name="321106307"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321106307" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321106307">(Jan 13 2023 at 08:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321075020">said</a>:</p>
<blockquote>
<p>I would have to stringfy each separately</p>
</blockquote>
<p>Yes, but the names are allowed to contain <code>.</code> so the two approaches are not equivalent</p>



<a name="321122766"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321122766" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321122766">(Jan 13 2023 at 10:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="387244">Yaël Dillies</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321104329">said</a>:</p>
<blockquote>
<p>I am using whatever VScode's terminal is, which seems to be bash. How do I change the default?</p>
</blockquote>
<p>If it's bash then you already have the right things. <code>cmd</code> is the bad one</p>



<a name="321123041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321123041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321123041">(Jan 13 2023 at 10:16)</a>:</h4>
<p>Ah well then my problem didn't get fixed <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="321125674"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321125674" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321125674">(Jan 13 2023 at 10:28)</a>:</h4>
<p>Can you paste the command you typed here?</p>



<a name="321126042"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321126042" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321126042">(Jan 13 2023 at 10:30)</a>:</h4>
<p>Aha, I think I know the problem:</p>
<ul>
<li>The glob pattern match is working as expected</li>
<li>You're using a unix shell so the glob generates<code>/</code>-style paths</li>
<li>Lean notices you're running on windows, so uses <code>\\</code>-style paths</li>
<li><code>Cache</code> does string equality on the paths rather than path equality, so the match fails</li>
</ul>



<a name="321126079"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321126079" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321126079">(Jan 13 2023 at 10:30)</a>:</h4>
<p>Adding the call to <code>.normalize</code> on user inputs <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321063985">as I suggested above</a> will fix the problem</p>



<a name="321136092"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321136092" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321136092">(Jan 13 2023 at 11:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321126079">said</a>:</p>
<blockquote>
<p>Adding the call to <code>.normalize</code> on user inputs <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321063985">as I suggested above</a> will fix the problem</p>
</blockquote>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1532">mathlib4#1532</a></p>



<a name="321136510"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321136510" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321136510">(Jan 13 2023 at 11:27)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> may I do a small optimization on your branch so we don't need to call <code>Name.toString</code> at all?</p>



<a name="321136754"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321136754" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321136754">(Jan 13 2023 at 11:28)</a>:</h4>
<p>I expect toString to be free</p>



<a name="321136966"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321136966" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321136966">(Jan 13 2023 at 11:29)</a>:</h4>
<p>Alright, I've approved it</p>



<a name="321143821"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321143821" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sky Wilshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321143821">(Jan 13 2023 at 12:04)</a>:</h4>
<p><span class="user-mention" data-user-id="387244">@Yaël Dillies</span> Might be useful: <a href="/user_uploads/3121/NI17wRQgVZO1Bkq12wMZlv-J/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/NI17wRQgVZO1Bkq12wMZlv-J/image.png" title="image.png"><img src="/user_uploads/3121/NI17wRQgVZO1Bkq12wMZlv-J/image.png"></a></div>



<a name="321146462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321146462" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321146462">(Jan 13 2023 at 12:17)</a>:</h4>
<p>Oh yeah I knew about that menu, but forgot that the default coudl be edited from here.</p>



<a name="321146709"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321146709" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321146709">(Jan 13 2023 at 12:19)</a>:</h4>
<p>The fix should be merged in master, can you try again <span class="user-mention" data-user-id="387244">@Yaël Dillies</span>?</p>



<a name="321148326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321148326" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321148326">(Jan 13 2023 at 12:28)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="n">lake</span> <span class="n">exe</span> <span class="n">cache</span> <span class="n">get</span> <span class="n">Mathlib</span><span class="bp">/</span><span class="n">Data</span><span class="bp">/</span><span class="n">Rat</span><span class="bp">/</span><span class="n">Floor.lean</span>
<span class="n">warning</span><span class="o">:</span> <span class="n">manifest</span> <span class="n">out</span> <span class="n">of</span> <span class="n">date</span><span class="o">:</span> <span class="n">package</span> <span class="n">directory</span> <span class="n">changed</span><span class="o">,</span> <span class="n">use</span> <span class="bp">`</span><span class="n">lake</span> <span class="n">update</span><span class="bp">`</span> <span class="n">to</span> <span class="n">update</span>
<span class="n">info</span><span class="o">:</span> <span class="n">updating</span> <span class="bp">.\./</span><span class="n">lake</span><span class="bp">-</span><span class="n">packages</span><span class="bp">\</span><span class="n">std</span> <span class="n">to</span> <span class="n">revision</span> <span class="n">fde95b16907bf38ea3f310af406868fc6bcf48d1</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Compiling</span> <span class="n">Cache.IO</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Compiling</span> <span class="n">Cache.Hashing</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Compiling</span> <span class="n">Cache.Requests</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Compiling</span> <span class="n">Cache.Main</span>
<span class="n">error</span><span class="o">:</span> <span class="bp">&gt;</span> <span class="n">c</span><span class="o">:</span><span class="bp">\</span><span class="n">Users</span><span class="bp">\</span><span class="n">YaelD</span><span class="bp">\.</span><span class="n">elan</span><span class="bp">\</span><span class="n">toolchains</span><span class="bp">\</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2023-01-12\bin\leanc.exe -c -o .\build\ir\Cache\IO.o .\build\ir\Cache\IO.c -O3 -DNDEBUG</span>
<span class="n">error</span><span class="o">:</span> <span class="n">stderr</span><span class="o">:</span>
<span class="n">uncaught</span> <span class="n">exception</span><span class="o">:</span> <span class="n">no</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span> <span class="o">(</span><span class="n">error</span> <span class="n">code</span><span class="o">:</span> <span class="mi">2</span><span class="o">)</span>
<span class="n">error</span><span class="o">:</span> <span class="n">external</span> <span class="n">command</span> <span class="bp">`</span><span class="n">c</span><span class="o">:</span><span class="bp">\</span><span class="n">Users</span><span class="bp">\</span><span class="n">YaelD</span><span class="bp">\.</span><span class="n">elan</span><span class="bp">\</span><span class="n">toolchains</span><span class="bp">\</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2023-01-12\bin\leanc.exe` exited with code 1</span>
<span class="n">error</span><span class="o">:</span> <span class="bp">&gt;</span> <span class="n">c</span><span class="o">:</span><span class="bp">\</span><span class="n">Users</span><span class="bp">\</span><span class="n">YaelD</span><span class="bp">\.</span><span class="n">elan</span><span class="bp">\</span><span class="n">toolchains</span><span class="bp">\</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2023-01-12\bin\leanc.exe -c -o .\build\ir\Cache\Hashing.o .\build\ir\Cache\Hashing.c -O3 -DNDEBUG</span>
<span class="n">error</span><span class="o">:</span> <span class="n">stderr</span><span class="o">:</span>
<span class="n">uncaught</span> <span class="n">exception</span><span class="o">:</span> <span class="n">no</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span> <span class="o">(</span><span class="n">error</span> <span class="n">code</span><span class="o">:</span> <span class="mi">2</span><span class="o">)</span>
<span class="n">error</span><span class="o">:</span> <span class="n">external</span> <span class="n">command</span> <span class="bp">`</span><span class="n">c</span><span class="o">:</span><span class="bp">\</span><span class="n">Users</span><span class="bp">\</span><span class="n">YaelD</span><span class="bp">\.</span><span class="n">elan</span><span class="bp">\</span><span class="n">toolchains</span><span class="bp">\</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2023-01-12\bin\leanc.exe` exited with code 1</span>
<span class="n">error</span><span class="o">:</span> <span class="bp">&gt;</span> <span class="n">c</span><span class="o">:</span><span class="bp">\</span><span class="n">Users</span><span class="bp">\</span><span class="n">YaelD</span><span class="bp">\.</span><span class="n">elan</span><span class="bp">\</span><span class="n">toolchains</span><span class="bp">\</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2023-01-12\bin\leanc.exe -c -o .\build\ir\Cache\Requests.o .\build\ir\Cache\Requests.c -O3 -DNDEBUG</span>
<span class="n">error</span><span class="o">:</span> <span class="n">stderr</span><span class="o">:</span>
<span class="n">uncaught</span> <span class="n">exception</span><span class="o">:</span> <span class="n">no</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span> <span class="o">(</span><span class="n">error</span> <span class="n">code</span><span class="o">:</span> <span class="mi">2</span><span class="o">)</span>
<span class="n">error</span><span class="o">:</span> <span class="n">external</span> <span class="n">command</span> <span class="bp">`</span><span class="n">c</span><span class="o">:</span><span class="bp">\</span><span class="n">Users</span><span class="bp">\</span><span class="n">YaelD</span><span class="bp">\.</span><span class="n">elan</span><span class="bp">\</span><span class="n">toolchains</span><span class="bp">\</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2023-01-12\bin\leanc.exe` exited with code 1</span>
<span class="n">error</span><span class="o">:</span> <span class="bp">&gt;</span> <span class="n">c</span><span class="o">:</span><span class="bp">\</span><span class="n">Users</span><span class="bp">\</span><span class="n">YaelD</span><span class="bp">\.</span><span class="n">elan</span><span class="bp">\</span><span class="n">toolchains</span><span class="bp">\</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2023-01-12\bin\leanc.exe -c -o .\build\ir\Cache\Main.o .\build\ir\Cache\Main.c -O3 -DNDEBUG</span>
<span class="n">error</span><span class="o">:</span> <span class="n">stderr</span><span class="o">:</span>
<span class="n">uncaught</span> <span class="n">exception</span><span class="o">:</span> <span class="n">no</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span> <span class="o">(</span><span class="n">error</span> <span class="n">code</span><span class="o">:</span> <span class="mi">2</span><span class="o">)</span>
<span class="n">error</span><span class="o">:</span> <span class="n">external</span> <span class="n">command</span> <span class="bp">`</span><span class="n">c</span><span class="o">:</span><span class="bp">\</span><span class="n">Users</span><span class="bp">\</span><span class="n">YaelD</span><span class="bp">\.</span><span class="n">elan</span><span class="bp">\</span><span class="n">toolchains</span><span class="bp">\</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2023-01-12\bin\leanc.exe` exited with code 1</span>
</code></pre></div>



<a name="321148356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321148356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321148356">(Jan 13 2023 at 12:28)</a>:</h4>
<p>Seems to be unrelated, though?</p>



<a name="321149131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321149131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321149131">(Jan 13 2023 at 12:32)</a>:</h4>
<p>Try <code>lake exe cache</code> to see if it prints the help menu</p>



<a name="321149763"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321149763" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321149763">(Jan 13 2023 at 12:35)</a>:</h4>
<p>If it doesn't print the help menu then it's indeed unrelated</p>



<a name="321773418"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321773418" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321773418">(Jan 17 2023 at 08:08)</a>:</h4>
<p>Ignorant question: if I have 5 clones of <code>mathlib4</code>, do they share a local cache? Or does each of them maintain its own cache?</p>



<a name="321797933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321797933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321797933">(Jan 17 2023 at 10:35)</a>:</h4>
<p>Each of them maintain their own cache (inside a gitignored <code>.cache</code> folder)</p>



<a name="321798233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321798233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321798233">(Jan 17 2023 at 10:36)</a>:</h4>
<p>I see. What do you think of using <code>$HOME/.cache/lake/</code> or something like that?</p>



<a name="321798319"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321798319" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321798319">(Jan 17 2023 at 10:37)</a>:</h4>
<p>I'm using <code>git worktree</code> to checkout every branch in its own directory.</p>



<a name="321798432"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321798432" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321798432">(Jan 17 2023 at 10:37)</a>:</h4>
<p>Which means I'm currently not really benefiting from local caching that much, and just redownloading the same files 10x per day</p>



<a name="321798668"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321798668" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321798668">(Jan 17 2023 at 10:38)</a>:</h4>
<p>I can add a check to see if the user has a <code>MATHLIB_CACHE_DIR</code> env var defined. If so, use that instead</p>



<a name="321798710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321798710" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321798710">(Jan 17 2023 at 10:39)</a>:</h4>
<p>Would that help?</p>



<a name="321798943"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321798943" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321798943">(Jan 17 2023 at 10:40)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> yeah, sounds good!</p>



<a name="321799015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321799015" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321799015">(Jan 17 2023 at 10:40)</a>:</h4>
<p>But then you would have to export that env variable on every terminal session</p>



<a name="321799075"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321799075" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321799075">(Jan 17 2023 at 10:40)</a>:</h4>
<p>I'm ok with that</p>



<a name="321799103"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321799103" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321799103">(Jan 17 2023 at 10:40)</a>:</h4>
<p>I personally would prefer having control over where to store the cache: currently, I am unable to use mathlib4 in the department, since I cannot install things myself, due to permissions.  If I can control as much as I can where files are placed, that would be helpful!</p>



<a name="321799500"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321799500" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321799500">(Jan 17 2023 at 10:42)</a>:</h4>
<p>Would writing it at $XDG_CACHE_HOME/mathlib be appropriate? A user could still do <code>XDG_CACHE_HOME=/tmpdir lake exe cache...</code> to override it.</p>



<a name="321799887"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321799887" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321799887">(Jan 17 2023 at 10:44)</a>:</h4>
<p>Mauricio, in this specific case, the $XDG_CACHE_HOME variable is set to a directory on which I have write permissions, so I would be happy with that as well!</p>



<a name="321810205"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321810205" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321810205">(Jan 17 2023 at 11:40)</a>:</h4>
<p>I will implement Mauricio's idea then</p>



<a name="321810384"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321810384" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321810384">(Jan 17 2023 at 11:41)</a>:</h4>
<p>Thanks!</p>



<a name="321810520"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321810520" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321810520">(Jan 17 2023 at 11:42)</a>:</h4>
<p>Ah, and I will use <code>.cache</code> as a fallback in case that's not defined</p>



<a name="321812397"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321812397" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321812397">(Jan 17 2023 at 11:54)</a>:</h4>
<p>Wait, is <code>XDG_CACHE_HOME</code> some default path on Unix systems? I don't have it defined on my machine (Ubuntu 22.04)</p>



<a name="321813286"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321813286" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321813286">(Jan 17 2023 at 11:59)</a>:</h4>
<p><a href="https://wiki.archlinux.org/title/XDG_user_directories">https://wiki.archlinux.org/title/XDG_user_directories</a></p>



<a name="321813371"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321813371" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321813371">(Jan 17 2023 at 12:00)</a>:</h4>
<p>Most distros do something with XDG</p>



<a name="321816023"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321816023" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321816023">(Jan 17 2023 at 12:15)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1623">mathlib4#1623</a></p>



<a name="321818071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321818071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321818071">(Jan 17 2023 at 12:26)</a>:</h4>
<p>The correct fallback for <code>XDG_CACHE_HOME</code> is <code>$HOME/.cache</code>. It doesn't make sense to decide between a local and global cache based on the existence of this variable.</p>



<a name="321824191"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321824191" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321824191">(Jan 17 2023 at 12:59)</a>:</h4>
<p>I can change that. But what if <code>HOME</code> is not defined?</p>



<a name="321824863"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321824863" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321824863">(Jan 17 2023 at 13:02)</a>:</h4>
<p>Then we're screwed</p>



<a name="321825402"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321825402" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321825402">(Jan 17 2023 at 13:05)</a>:</h4>
<p>And this is of course only on Linux, other platforms have completely different conventions <a href="https://crates.io/crates/dirs">https://crates.io/crates/dirs</a></p>



<a name="321826987"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321826987" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321826987">(Jan 17 2023 at 13:14)</a>:</h4>
<p>Then I'll leave <code>.cache</code> as the safe fallback</p>



<a name="321827154"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321827154" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321827154">(Jan 17 2023 at 13:14)</a>:</h4>
<p>(but anyone is free to push to that branch and advocate for their solution, of course)</p>



<a name="321827895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321827895" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321827895">(Jan 17 2023 at 13:18)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1623">mathlib4#1623</a> is updated</p>



<a name="321974135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321974135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321974135">(Jan 18 2023 at 05:06)</a>:</h4>
<p>I may be misunderstanding something about the relation between get-cache and <code>lake build</code>, so sorry if that's the case! </p>
<p>I have a project that uses mathlib as a dependency. I can run <code>lake exe cache get</code> in the root of my project and it seems to successfully download and/or unpack a cache. But running <code>lake build</code> tries to recompile everything. When I open a file with mathlib imports in vscode, it also starts recompiling. Any guess what I've done wrong here?</p>
<p>Curiously: this project is also set up for gitpod, and if I create a fresh gitpod instance (calling <code>lake exe cache get</code>) I can open files with no recompilation. But <code>lake build</code> still starts from the bottom.</p>



<a name="321974307"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321974307" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321974307">(Jan 18 2023 at 05:08)</a>:</h4>
<p><span class="user-mention" data-user-id="110596">@Rob Lewis</span> I think Arthur has conjectured that we shouldn't be pinning <code>master</code> in lakefiles, but pinning a specific hash/tag/release instead.</p>



<a name="321974326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321974326" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321974326">(Jan 18 2023 at 05:08)</a>:</h4>
<p>I haven't yet tested whether that helps, but it's worth a shot.</p>



<a name="321974328"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321974328" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321974328">(Jan 18 2023 at 05:08)</a>:</h4>
<p>On a semi-related note, is there a standard way to stop recompilation when it gets triggered by vscode? In the above, when I opened a file with imports, a bunch of lake and lean processes started eating my CPU, and restarting the Lean server and even quitting vscode didn't kill them. I had to kill them manually</p>



<a name="321974377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321974377" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321974377">(Jan 18 2023 at 05:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321974307">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110596">Rob Lewis</span> I think Arthur has conjectured that we shouldn't be pinning <code>master</code> in lakefiles, but pinning a specific hash/tag/release instead.</p>
</blockquote>
<p>Interesting -- will give that a shot!</p>



<a name="321974604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321974604" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321974604">(Jan 18 2023 at 05:12)</a>:</h4>
<p>Pinning a specific commit didn't seem to change anything. (Process: edit my project's <code>lakefile.lean</code>, <code>lake update</code>, <code>lake exe cache get</code>, <code>lake build</code>)</p>



<a name="321977277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321977277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321977277">(Jan 18 2023 at 05:46)</a>:</h4>
<p>I think maybe <code>lake update</code> is something you're just not supposed to do when you have dependencies.  (I seem to remember discussion of this.)</p>



<a name="321977332"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321977332" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321977332">(Jan 18 2023 at 05:47)</a>:</h4>
<p>So maybe instead of <code>lake update</code> you want to manually copy in the lake-manifest of current mathlib.  (well, or find a way to automate that.)</p>



<a name="321977649"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321977649" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321977649">(Jan 18 2023 at 05:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="260507">Heather Macbeth</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321977277">said</a>:</p>
<blockquote>
<p>I think maybe <code>lake update</code> is something you're just not supposed to do when you have dependencies.  (I seem to remember discussion of this.)</p>
</blockquote>
<p>That's a big vague, but I guess my question is: is <code>lake update</code> un-pinning your pinned hashes for the dependencies?</p>



<a name="321978777"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321978777" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321978777">(Jan 18 2023 at 06:07)</a>:</h4>
<p>It would have to copy the manifest from mathlib and then add mathlib itself (per the error message when I tried). But even if I do that I see the same behavior. Updated process: my project pins mathlib4 to a commit and its manifest matches that of mathlib4, with the addition of mathlib4 itself. I clone a fresh copy of this repository (so no build artifacts) and run <code>lake exe cache get</code>, <code>lake build</code></p>



<a name="321978846"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321978846" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321978846">(Jan 18 2023 at 06:07)</a>:</h4>
<p>Although, with this new process, I can open files that import mathlib before running <code>lake build</code></p>



<a name="321979836"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321979836" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321979836">(Jan 18 2023 at 06:21)</a>:</h4>
<blockquote>
<p>I think Arthur has conjectured that we shouldn't be pinning <code>master</code> in lakefiles, but pinning a specific hash/tag/release instead.</p>
</blockquote>
<p>This should make no difference whatsoever for the caching.  We've been fixing quite a few bugs though over the last few weeks, are you on the latest mathlib4 already?</p>



<a name="321979908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321979908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321979908">(Jan 18 2023 at 06:22)</a>:</h4>
<p>FWIW, mathport depends on <code>mathlib4</code> and successfully uses <code>lake exe cache get</code> in CI (i.e., avoiding building mathlib4)</p>



<a name="321979949"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321979949" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321979949">(Jan 18 2023 at 06:23)</a>:</h4>
<p>Note: you need matching Lean versions of course.  <code>cp lake-packages/mathlib/lean-toolchain .</code> is your friend.</p>



<a name="321980059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980059">(Jan 18 2023 at 06:24)</a>:</h4>
<p>Note: of course std4/aesop/etc. versions also need to match exactly.  Deleting any <code>require std</code> etc. in your lakefile is a good start, followed by <code>lake update</code>.</p>



<a name="321980187"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980187" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980187">(Jan 18 2023 at 06:25)</a>:</h4>
<blockquote>
<p>On a semi-related note, is there a standard way to stop recompilation when it gets triggered by vscode? In the above, when I opened a file with imports, a bunch of lake and lean processes started eating my CPU, and restarting the Lean server and even quitting vscode didn't kill them. I had to kill them manually</p>
</blockquote>
<p>No. We should probably file that as a bug.</p>



<a name="321980189"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980189" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980189">(Jan 18 2023 at 06:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321980059">said</a>:</p>
<blockquote>
<p>Note: of course std4/aesop/etc. versions also need to match exactly.  Deleting any <code>require std</code> etc. in your lakefile is a good start, followed by <code>lake update</code>.</p>
</blockquote>
<p>So will that ensure that in a project with just one dependency (mathlib), all the dependencies of that dependency (std/aesop/...) get updated only to whatever version mathlib is currently using -- not to latest version?</p>



<a name="321980402"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980402" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980402">(Jan 18 2023 at 06:27)</a>:</h4>
<p>Yes.  That's also been fixed recently (November last year).</p>



<a name="321980491"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980491" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980491">(Jan 18 2023 at 06:28)</a>:</h4>
<p>I'm on the latest commit of mathlib4 and the toolchain files match. This is the entirety of my lakefile:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>import Lake
open Lake DSL


require mathlib from git "https://github.com/leanprover-community/mathlib4" @ "d1e6d8643531bd36f7c7bb612413decb7cb07ede"

package «brown-cs22» {
  -- add package configuration options here
}

lean_lib BrownCs22 {
  -- add library configuration options here
}

@[default_target]
lean_exe «brown-cs22» {
  root := `Main
}
</code></pre></div>



<a name="321980532"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980532" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980532">(Jan 18 2023 at 06:28)</a>:</h4>
<p><code>lake update &amp;&amp; cp lake-packages/mathlib/lean-toolchain .</code> and you should be good to go.</p>



<a name="321980541"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980541" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980541">(Jan 18 2023 at 06:28)</a>:</h4>
<p>mathport is a good example for me to compare to -- I'll have to see if I can spot any relevant differences between that and my setup</p>



<a name="321980705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980705">(Jan 18 2023 at 06:30)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>rob@pop-os:~/teaching/cs22/s23/lean$ lake update <span class="o">&amp;&amp;</span> cp lake-packages/mathlib/lean-toolchain .
rob@pop-os:~/teaching/cs22/s23/lean$ lake exe cache get
No files to download
Decompressing <span class="m">926</span> file<span class="o">(</span>s<span class="o">)</span>
rob@pop-os:~/teaching/cs22/s23/lean$ lake build
Compiling Std.Data.RBMap.Basic
Compiling Qq.Macro
Compiling Mathlib.Lean.Meta
Compiling Qq.Rw
Compiling Std.Lean.Meta.DiscrTree
Compiling Std.Data.List.Basic
Compiling Mathlib.Tactic.Relation.Symm
Compiling Mathlib.Tactic.Relation.Trans
^C
rob@pop-os:~/teaching/cs22/s23/lean$
</code></pre></div>
<p><span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="321980718"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980718" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980718">(Jan 18 2023 at 06:30)</a>:</h4>
<p>That's normal.</p>



<a name="321980750"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980750" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980750">(Jan 18 2023 at 06:30)</a>:</h4>
<p>Compiling = running C compiler to produce native binary (not cached)</p>



<a name="321980762"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980762" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980762">(Jan 18 2023 at 06:30)</a>:</h4>
<p>Building = running Lean (slow and cached)</p>



<a name="321980808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321980808" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321980808">(Jan 18 2023 at 06:31)</a>:</h4>
<p>Oh!</p>



<a name="321981246"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321981246" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321981246">(Jan 18 2023 at 06:35)</a>:</h4>
<p>Wait -- so which one does <code>lake build</code> do?</p>



<a name="321981259"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321981259" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321981259">(Jan 18 2023 at 06:35)</a>:</h4>
<p>So, what I'd like to do in Lean 3 language: I have my project that depends on mathlib. I'd like to build oleans for my project so that when a student opens one of my files, they don't have to wait. <code>lean src --make</code> or whatever</p>



<a name="321981354"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321981354" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321981354">(Jan 18 2023 at 06:36)</a>:</h4>
<p>Imagining that there's a file in my project that's slow to build that gets imported by lots of others, e.g. a "course library" file</p>



<a name="321981458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321981458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321981458">(Jan 18 2023 at 06:37)</a>:</h4>
<p>I take it <code>lake build</code> is not what I'm looking for?</p>



<a name="321981628"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321981628" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321981628">(Jan 18 2023 at 06:39)</a>:</h4>
<p><code>lake build BrownCs22.MyModule</code> will build only that module and its dependencies.  The reason <code>lake build</code> compiles the C code is because it compiles <code>runLinter</code>--it won't compile any the modules in your project.  It will only build them.</p>



<a name="321981662"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321981662" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321981662">(Jan 18 2023 at 06:39)</a>:</h4>
<p>Or are you asking if you can use <code>lake exe cache get</code> for your project?</p>



<a name="321982191"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321982191" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321982191">(Jan 18 2023 at 06:43)</a>:</h4>
<p>Nope! I'm looking for <code>lake build BrownCs22.MyModule</code>, thanks so much</p>



<a name="321989577"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321989577" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321989577">(Jan 18 2023 at 07:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/321980059">said</a>:</p>
<blockquote>
<p>Note: of course std4/aesop/etc. versions also need to match exactly.  Deleting any <code>require std</code> etc. in your lakefile is a good start, followed by <code>lake update</code>.</p>
</blockquote>
<p>This is where I think things can go wrong: relying on Lake to figure out transitive dependencies. It's easy if your graph of dependencies is small, but it can become a nightmare for bigger graphs.</p>
<p>If I have a direct dependency on <code>Std</code> and on <code>Mathlib</code> but <code>Mathlib</code> also depends on <code>Std</code>, figuring out compatibility is a lot smoother if <code>Mathlib</code> explicitly states the commit  hash it needs from <code>Std</code> in its lakefile.</p>
<p>Another situation where dependency UX can go bad is when you depend on two libs, but they <em>implicitly</em> depend on different versions of a certain lib.</p>



<a name="321989871"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321989871" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321989871">(Jan 18 2023 at 07:44)</a>:</h4>
<p>Ah, and parsing Lake manifests with the human eye is out of question in terms of UX. Please let's not rely on that</p>



<a name="321990224"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321990224" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321990224">(Jan 18 2023 at 07:47)</a>:</h4>
<p>(are the current caching scripts really designed to work outside of the porting effort? It seems like more robust stuff will require a bit more infrastructure around dependency management)</p>



<a name="321991447"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321991447" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321991447">(Jan 18 2023 at 07:56)</a>:</h4>
<p>Yes and no. It is prepared to deal with the two situations: when you're in Mathlib or when you're importing Mathlib. I mean, it can understand in which scenario it's at, find sources and place olean files correctly. But it relies on precise management of dependencies. And Mathlib pinning the <code>master</code> rev of <code>Std</code> doesn't help</p>



<a name="321992531"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321992531" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321992531">(Jan 18 2023 at 08:04)</a>:</h4>
<p>Unless you're willing to rely on Lake to figure out transitive dependencies for you. But that will potentially make the life of people importing your project harder because they don't know which version of Std they will be downloading unless they look at your manifest</p>



<a name="321997253"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/321997253" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#321997253">(Jan 18 2023 at 08:38)</a>:</h4>
<p>Managing dependencies, however, is a world in itself. As a reference, Cargo adopts semantic versioning... but they also have a dedicated platform for hosting packages.</p>
<p>I will follow up on a thread in <a class="stream" data-stream-id="270676" href="/#narrow/stream/270676-lean4">#lean4</a></p>



<a name="322112458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322112458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322112458">(Jan 18 2023 at 17:37)</a>:</h4>
<blockquote>
<p>If I have a direct dependency on Std and on Mathlib but Mathlib also depends on Std, figuring out compatibility is a lot smoother if Mathlib explicitly states the commit hash it needs from Std in its lakefile.</p>
</blockquote>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> I don't know how to get this through to you, but your description is exactly how Lake and mathlib4 are already set up right now.  The <code>lake-manifest.json</code> in mathlib4 explicitly states the commit hash from std4 (and from aesop, etc.).  If you use <code>lake update</code> in a project that imports <code>mathlib4</code>, it will use these pinned revisions.</p>



<a name="322114210"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322114210" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322114210">(Jan 18 2023 at 17:45)</a>:</h4>
<blockquote>
<p>Another situation where dependency UX can go bad is when you depend on two libs, but they implicitly depend on different versions of a certain lib.</p>
</blockquote>
<p>This is indeed a hard one.  But I have an undocumented trick for you: the order of <code>require</code> directives in a lakefile matters, i.e., they are resolved top-to-bottom.  So as long as mathlib4 is your first <code>require</code>, <code>lake update</code> will take all dependency versions from <code>mathlib4</code>.  (And if you want a different version of aesop, you could put a <code>require aesop</code> on top.)</p>



<a name="322124900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322124900" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322124900">(Jan 18 2023 at 18:37)</a>:</h4>
<p>Alright, got it. Thanks! The order trick is important and I wasn't aware of it</p>



<a name="322127129"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322127129" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322127129">(Jan 18 2023 at 18:48)</a>:</h4>
<p><span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span> I think caching can work for you if you remove the requirements on Qq and Std</p>



<a name="322181259"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322181259" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322181259">(Jan 19 2023 at 00:44)</a>:</h4>
<p>Thanks. i will try</p>



<a name="322427943"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322427943" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Violeta Hernández <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322427943">(Jan 20 2023 at 04:48)</a>:</h4>
<p><a href="/user_uploads/3121/0fQVg8wK2BXzosmka18meS7P/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/0fQVg8wK2BXzosmka18meS7P/image.png" title="image.png"><img src="/user_uploads/3121/0fQVg8wK2BXzosmka18meS7P/image.png"></a></div>



<a name="322427960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322427960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Violeta Hernández <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322427960">(Jan 20 2023 at 04:48)</a>:</h4>
<p>What's going on here?</p>



<a name="322429369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322429369" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Violeta Hernández <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322429369">(Jan 20 2023 at 05:06)</a>:</h4>
<p>Well, I just built Mathlib4 myself and it works</p>



<a name="322429386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322429386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Violeta Hernández <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322429386">(Jan 20 2023 at 05:06)</a>:</h4>
<p>Very very fast</p>



<a name="322445636"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322445636" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322445636">(Jan 20 2023 at 07:41)</a>:</h4>
<p>Looks like a partial failure</p>



<a name="322509527"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/322509527" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#322509527">(Jan 20 2023 at 13:12)</a>:</h4>
<p><span class="user-mention" data-user-id="459227">@Violeta Hernández</span> it's better to do <code>lake exe cache get!</code> once to purge corrupted files</p>



<a name="323064612"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323064612" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323064612">(Jan 23 2023 at 16:33)</a>:</h4>
<p>Should we add some instructions for <code>lake exe get cache</code> on the mathlib4 readme.md?</p>



<a name="323232492"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323232492" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323232492">(Jan 24 2023 at 12:01)</a>:</h4>
<p>What's the plan for when we start getting hash collisions in <code>UInt64</code> btw?</p>



<a name="323233193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323233193" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323233193">(Jan 24 2023 at 12:04)</a>:</h4>
<p>Use a more reasonable hash?</p>



<a name="323240219"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323240219" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323240219">(Jan 24 2023 at 12:38)</a>:</h4>
<p>That's the obvious part. But I mean, are we going to implement something in Lean? Use some C implementation? FFI to something that's done in Rust?</p>



<a name="323242062"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323242062" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323242062">(Jan 24 2023 at 12:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/323232492">said</a>:</p>
<blockquote>
<p>What's the plan for when we start getting hash collisions in <code>UInt64</code> btw?</p>
</blockquote>
<p>What's the chance of that happening?</p>



<a name="323242455"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323242455" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323242455">(Jan 24 2023 at 12:49)</a>:</h4>
<p>It's low but I don't have a clear intuition for how likely that is to happen in the next year</p>



<a name="323243269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323243269" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323243269">(Jan 24 2023 at 12:53)</a>:</h4>
<p>Does the presence of a <code>git</code> installation mean that you have a command-line hashing tool installed?</p>



<a name="323246642"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323246642" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323246642">(Jan 24 2023 at 13:08)</a>:</h4>
<p>Eric, I don't know why you're communicating with questions like that. Yes, Git has a hashing algorithm. But that doesn't give us an obvious way to plug it in our hashing scheme</p>



<a name="323246808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323246808" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323246808">(Jan 24 2023 at 13:09)</a>:</h4>
<p>Sorry, let me try and be clearer: could you build a long string of all the data you want to hash, and pipe it to <code>git some-raw-hash-command</code> in order to punt the job of having native hashing down the road? Or would that be prohibitively slow? I'm not suggesting using git, but merely using the fact that git bundles a binary somewhere that can compute SHA1 hashes.</p>



<a name="323247303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323247303" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323247303">(Jan 24 2023 at 13:12)</a>:</h4>
<p>I found this: <a href="https://git-scm.com/docs/git-hash-object">https://git-scm.com/docs/git-hash-object</a></p>



<a name="323247616"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323247616" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323247616">(Jan 24 2023 at 13:14)</a>:</h4>
<p>The long string idea works, but we'd need to write it to a file and then hash. If we have ~1k files, that's ~1k writes and git hash calls though</p>



<a name="323248714"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323248714" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323248714">(Jan 24 2023 at 13:18)</a>:</h4>
<p>We have an implementation of the SHA3 hash <a href="https://github.com/yatima-inc/Ipld.lean/blob/main/Ipld/Keccak.lean">here</a>. But maybe that's an overkill. I know this is a very anticipated concern but I just don't want us to fall in a "fixing a plane while it's flying" territory. I think we should at least agree on a plan for when/if it happens</p>



<a name="323249619"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323249619" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323249619">(Jan 24 2023 at 13:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/323247616">said</a>:</p>
<blockquote>
<p>The long string idea works, but we'd need to write it to a file and then hash. If we have ~1k files, that's ~1k writes and git hash calls though</p>
</blockquote>
<p>Would piping it through stdin not work? Either way, the subprocess calls would add up I guess.</p>



<a name="323250995"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323250995" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323250995">(Jan 24 2023 at 13:28)</a>:</h4>
<p>Yes, the ideal solution wouldn't rely on more IO overhead, IMO</p>



<a name="323254275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323254275" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323254275">(Jan 24 2023 at 13:43)</a>:</h4>
<p><code>git hash-object</code> indeed has a <code>--stdin</code> option.</p>



<a name="323258199"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323258199" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323258199">(Jan 24 2023 at 14:00)</a>:</h4>
<p>i'm not sure it's worth worrying -- where do we rely on hashes to indicate equality?</p>



<a name="323258263"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323258263" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323258263">(Jan 24 2023 at 14:00)</a>:</h4>
<p>(deleted)</p>



<a name="323259045"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323259045" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323259045">(Jan 24 2023 at 14:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="407274">James Gallicchio</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/323258199">said</a>:</p>
<blockquote>
<p>i'm not sure it's worth worrying -- where do we rely on hashes to indicate equality?</p>
</blockquote>
<p>The hash indicates which <code>olean</code> file we should download. A hash collision would trigger a download of some unrelated olean and I'm not fully aware of the consequences of that</p>



<a name="323259538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323259538" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323259538">(Jan 24 2023 at 14:05)</a>:</h4>
<p>Unless Lake's trace has the same collision, it will surely rebuild the file</p>



<a name="323260325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323260325" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323260325">(Jan 24 2023 at 14:08)</a>:</h4>
<p>That's good news then. So in terms of build safety, we're backed up by Lake</p>



<a name="323260372"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323260372" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323260372">(Jan 24 2023 at 14:08)</a>:</h4>
<p>A collision could also cause uploads to either fail or invalidate old caches, right?</p>



<a name="323260811"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323260811" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323260811">(Jan 24 2023 at 14:10)</a>:</h4>
<p>Uploads would fail. But it's probably better to invalidate old caches <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="323267382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323267382" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323267382">(Jan 24 2023 at 14:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/287929-mathlib4/topic/lake.20get-cache/near/323259538">said</a>:</p>
<blockquote>
<p>Unless Lake's trace has the same collision, it will surely rebuild the file</p>
</blockquote>
<p>Just to make sure... we also download <code>.ilean</code>, <code>.trace</code>, <code>.c</code> and <code>.c.trace</code> files. Would Lake still be able to recover from that? I'm asking because I don't know to what extend Lake trusts what's already in the file system versus always recomputing traces</p>



<a name="323273736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323273736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323273736">(Jan 24 2023 at 14:59)</a>:</h4>
<p>Yes, comparing the trace on disk with the recomputed trace in memory is how Lake decides what to rebuild.</p>



<a name="323333543"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323333543" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323333543">(Jan 24 2023 at 19:13)</a>:</h4>
<p>Lake uses the same hash as <code>cache</code>, so a hash collision in the file contents would affect both of them.</p>



<a name="323334569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323334569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323334569">(Jan 24 2023 at 19:17)</a>:</h4>
<p>I've been thinking about adding a better, cryptographic hash function.  For example blake3 is about as fast our current hash, at least if you use the optimized assembly version.  But then I saw that Lake needs to be built by three different build systems (make, nix, and lake) and my motivation dropped drastically.</p>



<a name="323335346"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323335346" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323335346">(Jan 24 2023 at 19:21)</a>:</h4>
<p>We're using Rust's blake3 via FFI <a href="https://github.com/yatima-inc/LightData/blob/main/ffi.c">here</a>. But that would require users to have <code>cargo</code> installed</p>



<a name="323337779"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323337779" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323337779">(Jan 24 2023 at 19:34)</a>:</h4>
<p>Using blake3 via Rust is a very roundabout way of doing this.  Blake3 has a nice C implementation, there's no need to depend on Rust.  (At least when using it in Lean/Lake.  I guess you're already using Rust for other libraries as well, so it's not an extra dependency for you.)</p>



<a name="323338947"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323338947" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323338947">(Jan 24 2023 at 19:40)</a>:</h4>
<p>On that, we would prefer using the C implementation directly. But configuring the Rust FFI looked easier than adapting the C code.</p>



<a name="323344564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323344564" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323344564">(Jan 24 2023 at 20:12)</a>:</h4>
<p>If you manage to get that into <code>std4</code>, it would not only make mathlib4's caching better but also our team happier</p>



<a name="323346376"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323346376" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323346376">(Jan 24 2023 at 20:23)</a>:</h4>
<p>speaking of which, if someone wants to upstream the <code>cache</code> script to <code>std4</code> that would be great</p>



<a name="323346520"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323346520" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323346520">(Jan 24 2023 at 20:24)</a>:</h4>
<p>ideally in such a way that mathlib doesn't need to maintain a separate copy of the script</p>



<a name="323347534"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323347534" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323347534">(Jan 24 2023 at 20:30)</a>:</h4>
<p>The proper way of doing so is by having a generic package for caching</p>



<a name="323347796"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323347796" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323347796">(Jan 24 2023 at 20:32)</a>:</h4>
<p>A less ideal way of doing so is by migrating <code>Cache</code> to <code>std4</code> so mathlib4 would inherit <code>lake exe cache</code></p>



<a name="323347818"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323347818" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323347818">(Jan 24 2023 at 20:32)</a>:</h4>
<p>I have no idea how packages and lake scripts interact, but if you can make something work that's fine</p>



<a name="323348022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323348022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323348022">(Jan 24 2023 at 20:33)</a>:</h4>
<p>I just want this capability to be widely available somehow</p>



<a name="323348225"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323348225" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323348225">(Jan 24 2023 at 20:35)</a>:</h4>
<p>I prefer not to add new packages though since they add maintenance overhead when we do lean bumps and the like</p>



<a name="323348309"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/lake%20get-cache/near/323348309" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/lake.20get-cache.html#323348309">(Jan 24 2023 at 20:35)</a>:</h4>
<p>that feels like a wider conversation though that we don't need to broach now</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>