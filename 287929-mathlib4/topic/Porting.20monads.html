---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/Porting.20monads.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html">Porting monads</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="310724995"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310724995" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arien Malec <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310724995">(Nov 18 2022 at 00:03)</a>:</h4>
<p>Since Lean4 prefers <code>return</code> to <code>pure</code>, how should we handle in porting?</p>



<a name="310725207"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310725207" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arien Malec <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310725207">(Nov 18 2022 at 00:05)</a>:</h4>
<p>(Or maybe I don't understand the reference "we prefer <code>return</code> to <code>pure</code>).</p>



<a name="310725306"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310725306" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arien Malec <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310725306">(Nov 18 2022 at 00:05)</a>:</h4>
<p>Is this in the context of a <code>do</code>?</p>



<a name="310726151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310726151" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310726151">(Nov 18 2022 at 00:13)</a>:</h4>
<p>It seems that <code>return</code> just works even without <code>do</code>. I don't know whether the "preference" in the reference refers only to <code>do</code> blocks.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Nat</span> <span class="o">:=</span> <span class="n">return</span> <span class="mi">0</span>
<span class="kd">def</span> <span class="n">bar</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Nat</span> <span class="o">:=</span> <span class="n">pure</span> <span class="mi">0</span>
<span class="kd">example</span> <span class="o">:</span> <span class="n">foo</span> <span class="bp">=</span> <span class="n">bar</span> <span class="o">:=</span> <span class="n">rfl</span>
</code></pre></div>



<a name="310726341"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310726341" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arien Malec <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310726341">(Nov 18 2022 at 00:14)</a>:</h4>
<p>The actual <code>Monad</code> definition still spells <code>pure</code> as <code>pure</code>....</p>



<a name="310726762"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310726762" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310726762">(Nov 18 2022 at 00:18)</a>:</h4>
<p>Where is the <code>return</code> vs. <code>pure</code> convention mentioned?</p>



<a name="310726844"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310726844" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310726844">(Nov 18 2022 at 00:18)</a>:</h4>
<p><a href="https://leanprover.github.io/lean4/doc/lean3changes.html#style-changes">https://leanprover.github.io/lean4/doc/lean3changes.html#style-changes</a></p>



<a name="310726902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310726902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310726902">(Nov 18 2022 at 00:19)</a>:</h4>
<p><code>pure</code> and <code>return</code> are not always interchangeable.</p>



<a name="310727000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310727000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310727000">(Nov 18 2022 at 00:20)</a>:</h4>
<p>I think the manual is just saying that if you can do either <code>return</code> or <code>pure</code>, then you should do <code>return</code>.</p>



<a name="310727295"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310727295" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310727295">(Nov 18 2022 at 00:23)</a>:</h4>
<p>Here's an example of <code>return</code> jumping out of an inner <code>do</code> block: <a href="https://github.com/leanprover-community/mathlib4/blob/56284fa8920a42b4cadf77a94aa7ab167bebbb4f/Mathlib/Tactic/SplitIfs.lean#L55">https://github.com/leanprover-community/mathlib4/blob/56284fa8920a42b4cadf77a94aa7ab167bebbb4f/Mathlib/Tactic/SplitIfs.lean#L55</a></p>



<a name="310727601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310727601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arien Malec <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310727601">(Nov 18 2022 at 00:26)</a>:</h4>
<p>Iâ€™ll create a PR for the manual to clarify.</p>



<a name="310727707"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310727707" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310727707">(Nov 18 2022 at 00:27)</a>:</h4>
<p>I believe that kind of jumping-out-of-a-do-block is not possible in Haskell.</p>



<a name="310728605"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310728605" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310728605">(Nov 18 2022 at 00:36)</a>:</h4>
<p>Jumping out of a do block is pretty fun. :-)</p>



<a name="310729381"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310729381" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310729381">(Nov 18 2022 at 00:44)</a>:</h4>
<p>I don't agree with that convention to prefer <code>return</code> over <code>pure</code> (that's only in the lean 4 core repo I think). Certainly when translating from lean 3 monad code you should always use <code>pure</code></p>



<a name="310729584"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310729584" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310729584">(Nov 18 2022 at 00:46)</a>:</h4>
<p><code>return</code> can cause issues when you do something like</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">let</span> <span class="n">x</span> <span class="bp">&lt;-</span> <span class="k">match</span> <span class="n">foo</span> <span class="k">with</span>
<span class="bp">|</span> <span class="bp">.</span><span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">return</span> <span class="mi">0</span>
<span class="bp">|</span> <span class="bp">.</span><span class="n">b</span> <span class="n">z</span> <span class="bp">=&gt;</span> <span class="n">bar</span> <span class="n">z</span>
<span class="n">return</span> <span class="o">(</span><span class="bp">&lt;-</span> <span class="n">bar</span> <span class="n">x</span><span class="o">)</span>
</code></pre></div>
<p>if you meant the first <code>return</code> to be a <code>pure</code> then you've accidentally skipped the rest of the do block</p>



<a name="310729839"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310729839" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310729839">(Nov 18 2022 at 00:49)</a>:</h4>
<p>obviously this is sometimes useful if that's what you wanted to do, but it makes it more important to use <code>return</code> deliberately and call it out when doing so (it is nicely highlighted as a keyword, so it calls attention to itself more than <code>pure</code>), so using <code>return</code> at the end of a do block weakens the signal here</p>



<a name="310729983"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310729983" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310729983">(Nov 18 2022 at 00:50)</a>:</h4>
<p>one exception to this in my personal style is when using <code>return</code> to <em>start</em> a do block, since <code>return x</code> outside a do block means the same as <code>do pure x</code> (and in particular you can use <code>&lt;- foo</code> inside <code>x</code>, so it is a concise way to write <code>&lt;$&gt;</code> expressions without the sigils).</p>



<a name="310737970"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310737970" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310737970">(Nov 18 2022 at 02:24)</a>:</h4>
<blockquote>
<p>I don't agree with that convention to prefer <code>return</code> over <code>pure</code></p>
</blockquote>
<p>I think I'm with you on this.</p>



<a name="310738017"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310738017" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310738017">(Nov 18 2022 at 02:25)</a>:</h4>
<p>At least, the Rust programmer in me wants to avoid using <code>return</code> unless it is strictly needed.</p>



<a name="310790345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310790345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310790345">(Nov 18 2022 at 10:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/Porting.20monads/near/310729839">said</a>:</p>
<blockquote>
<p>obviously this is sometimes useful if that's what you wanted to do, but it makes it more important to use <code>return</code> deliberately and call it out when doing so (it is nicely highlighted as a keyword, so it calls attention to itself more than <code>pure</code>), so using <code>return</code> at the end of a do block weakens the signal here</p>
</blockquote>
<p>I was also concerned about this, but adopted the Lean 4 convention anyway and it hasn't bitten me so far. The few times where I mistakenly wrote <code>return</code> instead of <code>pure</code>, Lean saved me with an "unreachable do element" error. Then again, the only benefit of using <code>return</code> everywhere is that it saves you a <code>$</code> or <code>&lt;|</code>.</p>



<a name="310792450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310792450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310792450">(Nov 18 2022 at 10:54)</a>:</h4>
<p>note in the example I gave, you won't get that error because it's in a match and the other branches are not early returning</p>



<a name="310792608"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310792608" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310792608">(Nov 18 2022 at 10:55)</a>:</h4>
<p>you still might get a type error if the do block has a different return type than the type of <code>x</code>, but it's fundamentally not something lean can catch since it's a valid thing to want to do</p>



<a name="310793282"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Porting%20monads/near/310793282" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Porting.20monads.html#310793282">(Nov 18 2022 at 10:59)</a>:</h4>
<p>Yes, of course. I'm just saying it hasn't been an issue empirically (but also no big benefit).</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>