---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html">Writing tests that fail</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="319729866"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319729866" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319729866">(Jan 06 2023 at 07:23)</a>:</h4>
<p>In lean4 core, tests come with <code>expected.out</code> files which confirm that certain error messages/traces/etc. are generated.</p>
<p>I don't see those in mathlib4; how do we specify that we want a certain example in a test file to fail in a certain way?</p>



<a name="319730389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319730389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319730389">(Jan 06 2023 at 07:28)</a>:</h4>
<p>In mathlib3 we had <code>success_if_fail_with_msg</code>. Can we port that?</p>



<a name="319745707"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319745707" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319745707">(Jan 06 2023 at 09:34)</a>:</h4>
<p>For the time being I'm just going to leave commented code in test files describing what the behavior should be when uncommented, I guess?</p>



<a name="319745870"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319745870" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319745870">(Jan 06 2023 at 09:35)</a>:</h4>
<p>There are also certain instances where we're not in a tactic but still want to demonstrate certain error-message functionality. I imagine it's low-priority at the moment, but I wonder if we could have similar <code>*.expected.out</code> files somehow.</p>



<a name="319830715"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319830715" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319830715">(Jan 06 2023 at 17:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail/near/319730389">said</a>:</p>
<blockquote>
<p>In mathlib3 we had <code>success_if_fail_with_msg</code>. Can we port that?</p>
</blockquote>
<p>I opened <a href="https://github.com/leanprover-community/mathlib4/pull/1390">mathlib4#1390</a> to record this.</p>



<a name="319835557"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319835557" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319835557">(Jan 06 2023 at 18:20)</a>:</h4>
<p>There are a bunch of <code>@[simps]</code> tests that also used this, and for now are just using the less informative <code>success_if_fail</code>.</p>



<a name="319835847"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319835847" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319835847">(Jan 06 2023 at 18:21)</a>:</h4>
<p>I didn't realise we had <code>success_if_fail</code>, <span class="user-mention" data-user-id="548935">@Thomas Murrills</span> you can probably use this for now?</p>



<a name="319838143"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319838143" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319838143">(Jan 06 2023 at 18:33)</a>:</h4>
<p>A bit of poking around reveals it might be called <code>expect_failure</code> and <code>expect_failure_msg</code> now? Trying to use <code>success_with_failure</code> hits me with “unknown tactic”, and I can’t find it in mathlib4.</p>



<a name="319838242"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319838242" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319838242">(Jan 06 2023 at 18:34)</a>:</h4>
<p>Does this look like a good way to write this test?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="mi">3</span> <span class="bp">^</span> <span class="mi">3</span> <span class="bp">+</span> <span class="mi">4</span> <span class="bp">=</span> <span class="mi">31</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">expect_failure_msg</span> <span class="s2">"type mismatch</span>
<span class="s2">  HEq.rfl</span>
<span class="s2">has type</span>
<span class="s2">  HEq ?m.38198 ?m.38198 : Prop</span>
<span class="s2">but is expected to have type</span>
<span class="s2">  3 ^ 3 + 4 = 31 : Prop"</span> <span class="o">(</span><span class="n">norm_num1</span><span class="bp">;</span> <span class="n">with_reducible</span> <span class="n">rfl</span><span class="o">)</span>
  <span class="gr">admit</span>
</code></pre></div>



<a name="319840785"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319840785" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319840785">(Jan 06 2023 at 18:48)</a>:</h4>
<p>I'm afraid the <code>?m.38198</code> is not import changes-resilient.</p>



<a name="319841993"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319841993" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319841993">(Jan 06 2023 at 18:55)</a>:</h4>
<p>It's called <code>successIfFail</code> in <code>Mathlib.Lean.Exception</code>.</p>



<a name="319842138"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319842138" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319842138">(Jan 06 2023 at 18:55)</a>:</h4>
<p>But that is a monad operation, but a tactic.</p>



<a name="319867550"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319867550" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319867550">(Jan 06 2023 at 21:37)</a>:</h4>
<p>I see. I think I'll do this particular test with a syntactic <code>guard_target</code> followed by an <code>admit</code>, but this is all good to know!</p>



<a name="319867976"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319867976" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319867976">(Jan 06 2023 at 21:41)</a>:</h4>
<p>Or, wait. Is <code>admit</code> frowned upon in tests? is <code>successIfFail</code> better?</p>



<a name="319868043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319868043" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319868043">(Jan 06 2023 at 21:41)</a>:</h4>
<p>I'm not totally sure how to translate the monad operation into a tactic in this case.</p>



<a name="319883543"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319883543" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319883543">(Jan 06 2023 at 23:56)</a>:</h4>
<p>In Lean 3 we mandated that all tests are silent. In Lean 4 I think that might also be nice, but we're not doing it at the moment.<br>
I prefer doing a <code>successIfFail</code> followed by some (trivial) way to close the goal, which you can usually ensure there exists by changing the example a little bit.</p>



<a name="319892830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319892830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319892830">(Jan 07 2023 at 01:52)</a>:</h4>
<p>There is a tactic <code>fail_if_success</code>, defined in core Lean 4, that is used in <code>test/</code>.</p>



<a name="319895172"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319895172" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319895172">(Jan 07 2023 at 02:27)</a>:</h4>
<p>Isn’t that the opposite?</p>



<a name="319896228"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319896228" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319896228">(Jan 07 2023 at 02:43)</a>:</h4>
<p>Confusingly, <code>fail_if_success</code> and <code>successIfFail</code> mean the same thing. :-)</p>



<a name="319896249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319896249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319896249">(Jan 07 2023 at 02:43)</a>:</h4>
<p>Both swap success and failure of the enclosed tactic.</p>



<a name="319896798"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319896798" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319896798">(Jan 07 2023 at 02:51)</a>:</h4>
<p>so what you’re saying is…it should really be called <code>fail_iff_success</code> :)</p>



<a name="319917655"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Writing%20tests%20that%20fail/near/319917655" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Writing.20tests.20that.20fail.html#319917655">(Jan 07 2023 at 08:01)</a>:</h4>
<p>You can switch off universes being displayed with <code>set_option pp.universes false</code> if this is still an issue</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>