---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html">expand `have` capabilities</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="275569867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275569867" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275569867">(Mar 16 2022 at 20:04)</a>:</h4>
<p>I wanna try to implement <a href="#narrow/stream/287929-mathlib4/topic/.60replace.60.20tactic/near/275522296">unstructured <code>have</code></a> but I will need some guidance.</p>
<p>I have this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"have "</span> <span class="n">id</span><span class="o">:</span><span class="n">ident</span> <span class="s2">" : "</span> <span class="n">t</span><span class="o">:</span><span class="n">term</span> <span class="s2">" dont_wanna_do_this "</span> <span class="n">p</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="n">none</span>
  <span class="k">let</span> <span class="n">p</span> <span class="bp">←</span> <span class="n">elabTermEnsuringType</span> <span class="n">p</span> <span class="n">t</span>
  <span class="n">liftMetaTactic</span> <span class="k">fun</span> <span class="n">mvarId</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mvarIdNew</span> <span class="bp">←</span> <span class="n">assert</span> <span class="n">mvarId</span> <span class="n">id.getId</span> <span class="n">t</span> <span class="n">p</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">_</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">)</span> <span class="bp">←</span> <span class="n">intro1P</span> <span class="n">mvarIdNew</span>
    <span class="n">return</span> <span class="o">[</span><span class="n">mvarIdNew</span><span class="o">]</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">:</span> <span class="n">Nat</span> <span class="n">dont_wanna_do_this</span> <span class="mi">5</span>
  <span class="n">simp</span>
</code></pre></div>
<p>Instead of providing a term of the given type, I want to turn that type into a new goal (and add it to the list of goals).</p>
<p>So I have two questions:</p>
<ul>
<li>How can I add <code>h : Nat</code> to the context without relying on <code>assert</code> (nor on a given term of <code>Nat</code>)?</li>
<li>How can I add <code>⊢ Nat</code> as a new goal?</li>
</ul>



<a name="275569973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275569973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275569973">(Mar 16 2022 at 20:05)</a>:</h4>
<p>(aside: I object to the term "unstructured", since all uses of this tactic in mathlib are quite structured)</p>



<a name="275570082"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275570082" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275570082">(Mar 16 2022 at 20:06)</a>:</h4>
<p>it's a version of <code>have</code> that keeps the proof inside the same tactic block</p>



<a name="275570162"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275570162" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275570162">(Mar 16 2022 at 20:07)</a>:</h4>
<p>Yeah I don't understand why "unstructured" either. I'm just mimicking what's on the <code>Mathport/Syntax.lean</code> file</p>



<a name="275570345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275570345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275570345">(Mar 16 2022 at 20:08)</a>:</h4>
<p>I'm confused why you have the <code>dont_wanna_do_this</code> part</p>



<a name="275570366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275570366" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275570366">(Mar 16 2022 at 20:08)</a>:</h4>
<p>why aren't you just using the syntax as is?</p>



<a name="275570509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275570509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275570509">(Mar 16 2022 at 20:10)</a>:</h4>
<p>I just want to be explicit that I don't want to rely on <code>p</code>. With my current knowledge, the only way that I know how to add <code>h : Nat</code> to the context is through <code>assert</code>. And it relies on a term of the given type</p>



<a name="275570556"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275570556" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275570556">(Mar 16 2022 at 20:10)</a>:</h4>
<p>You can use <code>assert</code>, you just create a new metavariable with the desired type and pass it to <code>assert</code> and also put it in the goal list</p>



<a name="275570739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275570739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275570739">(Mar 16 2022 at 20:12)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="sd">/--</span>
<span class="sd">  Convert the given goal `Ctx |- target` into `Ctx |- type -&gt; target`.</span>
<span class="sd">  It assumes `val` has type `type` -/</span>
<span class="kd">def</span> <span class="n">assert</span> <span class="o">(</span><span class="n">mvarId</span> <span class="o">:</span> <span class="n">MVarId</span><span class="o">)</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="n">Name</span><span class="o">)</span> <span class="o">(</span><span class="n">type</span> <span class="o">:</span> <span class="n">Expr</span><span class="o">)</span> <span class="o">(</span><span class="n">val</span> <span class="o">:</span> <span class="n">Expr</span><span class="o">)</span> <span class="o">:</span> <span class="n">MetaM</span> <span class="n">MVarId</span>
</code></pre></div>
<p>How can I create an <code>Expr</code> of type <code>type</code> at this point? Isn't this the whole theorem proving challenge?</p>



<a name="275570764"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275570764" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275570764">(Mar 16 2022 at 20:12)</a>:</h4>
<p>(I'm talking about the 4th argument <code>val</code>)</p>



<a name="275570936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275570936" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275570936">(Mar 16 2022 at 20:13)</a>:</h4>
<p>I would appreciate a hint without much spoiling, if possible :)</p>



<a name="275571662"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275571662" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275571662">(Mar 16 2022 at 20:17)</a>:</h4>
<p>Huh, wait, something clicked in my head. Let me try something</p>



<a name="275577169"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275577169" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275577169">(Mar 16 2022 at 21:05)</a>:</h4>
<p>Alright, I think I got it:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"have "</span> <span class="n">id</span><span class="o">:</span><span class="n">ident</span> <span class="s2">" : "</span> <span class="n">t</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="n">none</span>
  <span class="k">let</span> <span class="n">p</span> <span class="bp">←</span> <span class="n">mkFreshExprMVar</span> <span class="n">t</span>
  <span class="n">liftMetaTactic</span> <span class="k">fun</span> <span class="n">mvarId</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mvarIdNew</span> <span class="bp">←</span> <span class="n">assert</span> <span class="n">mvarId</span> <span class="n">id.getId</span> <span class="n">t</span> <span class="n">p</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">_</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">)</span> <span class="bp">←</span> <span class="n">intro1P</span> <span class="n">mvarIdNew</span>
    <span class="n">return</span> <span class="o">[</span><span class="n">p.mvarId</span><span class="bp">!</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">]</span>
  <span class="k">let</span> <span class="n">goals</span> <span class="bp">←</span> <span class="n">getUnsolvedGoals</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">Nat</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">:</span> <span class="n">Nat</span>
  <span class="bp">·</span> <span class="n">exact</span> <span class="mi">5</span>
  <span class="n">exact</span> <span class="n">h</span>
</code></pre></div>
<p>Please let me know if this is too naive (of course I still need to generalize an optional identifier if the user wants to store on <code>this</code>)</p>



<a name="275581498"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275581498" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275581498">(Mar 16 2022 at 21:44)</a>:</h4>
<p>I don't see a <em>clear</em> advantage of this except for being able to change the goals order as in:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">Nat</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">:</span> <span class="n">Nat</span>
  <span class="n">swap</span>
  <span class="n">exact</span> <span class="n">h</span>
  <span class="n">exact</span> <span class="mi">5</span>
</code></pre></div>
<p>Are there other benefits? I thought about being able to add tags to the subgoals. Maybe that can be useful to make proofs more organized with <code>case &lt;tag&gt; =&gt; tacSeq</code>?</p>



<a name="275581522"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275581522" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275581522">(Mar 16 2022 at 21:45)</a>:</h4>
<p>you want the first two lines to be in the <code>liftMetaTactic</code> block, that also sets the context</p>



<a name="275581568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275581568" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275581568">(Mar 16 2022 at 21:45)</a>:</h4>
<p>the version that changes goals order is already a thing, that's <code>suffices</code></p>



<a name="275581702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275581702" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275581702">(Mar 16 2022 at 21:46)</a>:</h4>
<p>you should name the subgoals as well, I think it makes sense for the mvar to be named the same as the identifier</p>



<a name="275581764"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275581764" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275581764">(Mar 16 2022 at 21:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities/near/275581522">said</a>:</p>
<blockquote>
<p>you want the first two lines to be in the <code>liftMetaTactic</code> block, that also sets the context</p>
</blockquote>
<p>I can do this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"have "</span> <span class="n">id</span><span class="o">:</span><span class="n">ident</span> <span class="s2">" : "</span> <span class="n">t</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="n">none</span>
  <span class="n">liftMetaTactic</span> <span class="k">fun</span> <span class="n">mvarId</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">p</span> <span class="bp">←</span> <span class="n">mkFreshExprMVar</span> <span class="n">t</span>
    <span class="k">let</span> <span class="n">mvarIdNew</span> <span class="bp">←</span> <span class="n">assert</span> <span class="n">mvarId</span> <span class="n">id.getId</span> <span class="n">t</span> <span class="n">p</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">_</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">)</span> <span class="bp">←</span> <span class="n">intro1P</span> <span class="n">mvarIdNew</span>
    <span class="n">return</span> <span class="o">[</span><span class="n">p.mvarId</span><span class="bp">!</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">]</span>
</code></pre></div>
<p>But <code>elabTerm</code> can't be executed in <code>MetaM</code>. Unless I'm doing something wrong</p>



<a name="275581832"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275581832" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275581832">(Mar 16 2022 at 21:47)</a>:</h4>
<p>At least in lean 3, opening another tactic block via <code>have : foo := by { }</code> instead of <code>have : foo, { }</code> meant that the two blocks could not share metavariables - everything has to be solved in the nested block</p>



<a name="275582188"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275582188" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275582188">(Mar 16 2022 at 21:50)</a>:</h4>
<p>This is already happening:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">Nat</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">:</span> <span class="n">Nat</span>
  <span class="bp">·</span> <span class="k">let</span> <span class="n">q</span> <span class="o">:=</span> <span class="mi">5</span>
    <span class="n">exact</span> <span class="mi">5</span>
  <span class="k">let</span> <span class="n">a</span> <span class="o">:=</span> <span class="n">q</span> <span class="c1">-- unknown identifier 'q'</span>
  <span class="n">exact</span> <span class="n">h</span>
</code></pre></div>



<a name="275582230"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275582230" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275582230">(Mar 16 2022 at 21:51)</a>:</h4>
<p>what are you showing?</p>



<a name="275582387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275582387" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275582387">(Mar 16 2022 at 21:52)</a>:</h4>
<p>I'm not sure if <code>withMainContext</code> needs to be called before the <code>elabTerm</code>; to test that you should try referencing a variable in another goal..?</p>



<a name="275582548"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275582548" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275582548">(Mar 16 2022 at 21:54)</a>:</h4>
<p>but also, you should be using the original syntax with <code>haveIdLhs</code> instead of <code>"have " ident " : " term</code></p>



<a name="275582576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275582576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275582576">(Mar 16 2022 at 21:54)</a>:</h4>
<p>those produce different syntax trees</p>



<a name="275582908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275582908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275582908">(Mar 16 2022 at 21:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities/near/275582387">said</a>:</p>
<blockquote>
<p>I'm not sure if <code>withMainContext</code> needs to be called before the <code>elabTerm</code>; to test that you should try referencing a variable in another goal..?</p>
</blockquote>
<p>The variables don't seem to be shared among goals:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">true</span> <span class="bp">∧</span> <span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">constructor</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">:</span> <span class="n">Nat</span>
  <span class="k">have</span> <span class="n">w</span> <span class="o">:</span> <span class="n">String</span>
  <span class="c">/-</span><span class="cm"></span>
<span class="cm">  ⊢ String</span>
<span class="cm">  w : String</span>
<span class="cm">  ⊢ ℕ</span>
<span class="cm">  case left</span>
<span class="cm">  h : ℕ</span>
<span class="cm">  ⊢ true = true</span>
<span class="cm">  case right</span>
<span class="cm">  ⊢ true = true</span>
<span class="cm">  -/</span>
  <span class="n">simp</span>
  <span class="n">simp</span>
</code></pre></div>



<a name="275583485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275583485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275583485">(Mar 16 2022 at 22:03)</a>:</h4>
<p>I think I am misunderstanding what you're saying</p>



<a name="275584403"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275584403" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275584403">(Mar 16 2022 at 22:15)</a>:</h4>
<p>The question is whether the elaboration of the type is occurring in the right context, because tactics operate on a bunch of goals and different goals have different variables in them and hence elaborate terms differently</p>



<a name="275584782"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275584782" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275584782">(Mar 16 2022 at 22:19)</a>:</h4>
<p>Hmm, even with <code>withMainContext</code> it's still possible to do:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"have "</span> <span class="n">id</span><span class="o">:</span><span class="n">ident</span> <span class="s2">" : "</span> <span class="n">t</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="n">withMainContext</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="n">none</span>
    <span class="k">let</span> <span class="n">name</span> <span class="o">:=</span> <span class="n">id.getId</span>
    <span class="n">liftMetaTactic</span> <span class="k">fun</span> <span class="n">mvarId</span> <span class="bp">=&gt;</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">p</span> <span class="bp">←</span> <span class="n">mkFreshExprMVar</span> <span class="o">(</span><span class="n">userName</span> <span class="o">:=</span> <span class="n">name</span><span class="o">)</span> <span class="n">t</span>
      <span class="k">let</span> <span class="n">mvarIdNew</span> <span class="bp">←</span> <span class="n">assert</span> <span class="n">mvarId</span> <span class="n">name</span> <span class="n">t</span> <span class="n">p</span>
      <span class="k">let</span> <span class="o">(</span><span class="n">_</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">)</span> <span class="bp">←</span> <span class="n">intro1P</span> <span class="n">mvarIdNew</span>
      <span class="n">return</span> <span class="o">[</span><span class="n">p.mvarId</span><span class="bp">!</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">]</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">true</span> <span class="bp">∧</span> <span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">constructor</span>
  <span class="k">have</span> <span class="n">h1</span> <span class="o">:</span> <span class="n">String</span>
  <span class="k">have</span> <span class="n">h2</span> <span class="o">:</span> <span class="n">String</span>
  <span class="n">case</span> <span class="n">h1</span> <span class="bp">=&gt;</span>
    <span class="n">exact</span> <span class="n">h2</span> <span class="c1">-- this works, but is it desired?</span>
  <span class="n">case</span> <span class="n">h2</span> <span class="bp">=&gt;</span>
    <span class="n">exact</span> <span class="s2">""</span>
  <span class="n">simp</span>
  <span class="n">simp</span>
</code></pre></div>



<a name="275585415"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275585415" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275585415">(Mar 16 2022 at 22:27)</a>:</h4>
<p>I will upgrade the syntax to <code>haveIdLhs</code> after I get this POC working nicely</p>



<a name="275587379"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275587379" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275587379">(Mar 16 2022 at 22:52)</a>:</h4>
<p>That all seems to be working as intended</p>



<a name="275587392"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275587392" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275587392">(Mar 16 2022 at 22:53)</a>:</h4>
<p><code>withMainContext</code> doesn't seem to make a difference</p>



<a name="275587410"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275587410" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275587410">(Mar 16 2022 at 22:53)</a>:</h4>
<p>the question is about free variables in <code>t</code> and where they come from</p>



<a name="275587426"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275587426" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275587426">(Mar 16 2022 at 22:53)</a>:</h4>
<p>so you need an example with a dependent type instead of just <code>String</code></p>



<a name="275587536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275587536" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275587536">(Mar 16 2022 at 22:55)</a>:</h4>
<p>like this</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>
<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Meta</span> <span class="n">Elab</span> <span class="n">Tactic</span>

<span class="n">elab</span> <span class="s2">"have "</span> <span class="n">id</span><span class="o">:</span><span class="n">ident</span> <span class="s2">" : "</span> <span class="n">t</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="c1">-- withMainContext do</span>
    <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="n">none</span>
    <span class="k">let</span> <span class="n">name</span> <span class="o">:=</span> <span class="n">id.getId</span>
    <span class="n">liftMetaTactic</span> <span class="k">fun</span> <span class="n">mvarId</span> <span class="bp">=&gt;</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">p</span> <span class="bp">←</span> <span class="n">mkFreshExprMVar</span> <span class="o">(</span><span class="n">userName</span> <span class="o">:=</span> <span class="n">name</span><span class="o">)</span> <span class="n">t</span>
      <span class="k">let</span> <span class="n">mvarIdNew</span> <span class="bp">←</span> <span class="n">assert</span> <span class="n">mvarId</span> <span class="n">name</span> <span class="n">t</span> <span class="n">p</span>
      <span class="k">let</span> <span class="o">(</span><span class="n">_</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">)</span> <span class="bp">←</span> <span class="n">intro1P</span> <span class="n">mvarIdNew</span>
      <span class="n">return</span> <span class="o">[</span><span class="n">p.mvarId</span><span class="bp">!</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">]</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">True</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h1</span> <span class="o">:</span> <span class="n">String</span> <span class="o">:=</span> <span class="gr">sorry</span>
  <span class="k">have</span> <span class="n">h2</span> <span class="o">:</span> <span class="n">h1</span> <span class="bp">=</span> <span class="n">h1</span> <span class="c1">-- fail</span>
</code></pre></div>



<a name="275596339"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275596339" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275596339">(Mar 17 2022 at 00:59)</a>:</h4>
<p>More progress:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="s2">"have "</span> <span class="o">(</span><span class="n">ident</span><span class="o">)</span><span class="bp">?</span> <span class="s2">" this "</span><span class="bp">?</span> <span class="s2">" : "</span> <span class="n">term</span> <span class="o">(</span><span class="s2">" as "</span> <span class="n">ident</span><span class="o">)</span><span class="bp">?</span> <span class="o">:</span> <span class="n">tactic</span>

<span class="kn">private</span> <span class="kd">def</span> <span class="n">haveDef</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="n">Name</span><span class="o">)</span> <span class="o">(</span><span class="n">t</span> <span class="o">:</span> <span class="n">Syntax</span><span class="o">)</span> <span class="o">(</span><span class="n">i</span><span class="bp">?</span> <span class="o">:</span> <span class="n">Option</span> <span class="n">Syntax</span><span class="o">)</span> <span class="o">:</span> <span class="n">TacticM</span> <span class="n">Unit</span> <span class="o">:=</span>
  <span class="n">withMainContext</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="n">none</span>
    <span class="k">let</span> <span class="n">caseName</span> <span class="o">:=</span> <span class="k">match</span> <span class="n">i</span><span class="bp">?</span> <span class="k">with</span>
      <span class="bp">|</span> <span class="n">none</span>   <span class="bp">=&gt;</span> <span class="n">name</span>
      <span class="bp">|</span> <span class="n">some</span> <span class="n">i</span> <span class="bp">=&gt;</span> <span class="n">i.getId</span>
    <span class="n">liftMetaTactic</span> <span class="k">fun</span> <span class="n">mvarId</span> <span class="bp">=&gt;</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">p</span> <span class="bp">←</span> <span class="n">mkFreshExprMVar</span> <span class="o">(</span><span class="n">userName</span> <span class="o">:=</span> <span class="n">caseName</span><span class="o">)</span> <span class="n">t</span>
      <span class="k">let</span> <span class="n">mvarIdNew</span> <span class="bp">←</span> <span class="n">assert</span> <span class="n">mvarId</span> <span class="n">name</span> <span class="n">t</span> <span class="n">p</span>
      <span class="k">let</span> <span class="o">(</span><span class="n">_</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">)</span> <span class="bp">←</span> <span class="n">intro1P</span> <span class="n">mvarIdNew</span>
      <span class="n">return</span> <span class="o">[</span><span class="n">p.mvarId</span><span class="bp">!</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">]</span>

<span class="n">elab_rules</span> <span class="o">:</span> <span class="n">tactic</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span><span class="k">have</span> <span class="bp">$</span><span class="n">h</span><span class="o">:</span><span class="n">ident</span> <span class="o">:</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span> <span class="bp">$</span><span class="o">[</span><span class="n">as</span> <span class="bp">$</span><span class="n">i</span><span class="o">:</span><span class="n">ident</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">haveDef</span> <span class="n">h.getId</span> <span class="n">t</span> <span class="n">i</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span><span class="k">have</span> <span class="bp">$</span><span class="o">[</span><span class="n">this</span><span class="o">]</span><span class="bp">?</span> <span class="o">:</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span> <span class="bp">$</span><span class="o">[</span><span class="n">as</span> <span class="bp">$</span><span class="n">i</span><span class="o">:</span><span class="n">ident</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">haveDef</span> <span class="bp">`</span><span class="n">this</span>   <span class="n">t</span> <span class="n">i</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">2</span> <span class="bp">*</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">h</span><span class="o">]</span>
  <span class="k">have</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">+</span> <span class="n">b</span> <span class="n">as</span> <span class="n">h_two_mul</span>
  <span class="n">on_goal</span> <span class="bp">-</span><span class="mi">1</span>     <span class="bp">=&gt;</span> <span class="n">rw</span> <span class="o">[</span><span class="n">this</span><span class="o">,</span> <span class="n">Nat.add_assoc</span><span class="o">]</span> <span class="c1">-- targeting the final goal</span>
  <span class="n">case</span> <span class="n">h_two_mul</span> <span class="bp">=&gt;</span> <span class="n">ring</span>
</code></pre></div>
<p>With this syntax it's possible to name the subgoals with <code>as &lt;name&gt;</code></p>



<a name="275596509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275596509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275596509">(Mar 17 2022 at 01:01)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> Seems like <code>have h this : foo</code> is legal syntax</p>



<a name="275596586"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275596586" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275596586">(Mar 17 2022 at 01:02)</a>:</h4>
<p>I don't think the <code>as</code> thing is necessary, people won't be using the case name in most cases and the given identifier seems as good a name as any</p>



<a name="275596608"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275596608" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275596608">(Mar 17 2022 at 01:02)</a>:</h4>
<p>not to mention that it's not entirely clear if it will play well with the <code>haveIdLhs</code> parser</p>



<a name="275596644"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275596644" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275596644">(Mar 17 2022 at 01:03)</a>:</h4>
<p>Btw I'm having some troubles with the <code>haveIdLhs</code> parser</p>



<a name="275596834"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275596834" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275596834">(Mar 17 2022 at 01:06)</a>:</h4>
<p>care to share?</p>



<a name="275596954"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275596954" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275596954">(Mar 17 2022 at 01:09)</a>:</h4>
<p>Apparently it's not allowed to say <code>have this : Nat</code> with it</p>



<a name="275597035"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597035" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597035">(Mar 17 2022 at 01:10)</a>:</h4>
<p>that's true, although it's not obvious we need to do anything about it</p>



<a name="275597040"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597040" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597040">(Mar 17 2022 at 01:10)</a>:</h4>
<p>you can just write <code>have : </code> instead</p>



<a name="275597063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597063">(Mar 17 2022 at 01:11)</a>:</h4>
<p>If you want to make <code>this</code> acceptable in that position then probably it should be a lean core change</p>



<a name="275597157"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597157" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597157">(Mar 17 2022 at 01:13)</a>:</h4>
<p>I'm not really sure why <code>this</code> became a keyword in the first place, besides perhaps some tactic that forgot to use <code>&amp;"this"</code> instead of <code>"this"</code> in the syntax. <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> do you know?</p>



<a name="275597335"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597335" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597335">(Mar 17 2022 at 01:16)</a>:</h4>
<p>Alright, this works:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="s2">"have "</span> <span class="n">Parser.Term.haveIdLhs</span> <span class="o">:</span> <span class="n">tactic</span>

<span class="kn">private</span> <span class="kd">def</span> <span class="n">haveDef</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="n">Name</span><span class="o">)</span> <span class="o">(</span><span class="n">t</span> <span class="o">:</span> <span class="n">Syntax</span><span class="o">)</span> <span class="o">:</span> <span class="n">TacticM</span> <span class="n">Unit</span> <span class="o">:=</span>
  <span class="n">withMainContext</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="n">none</span>
    <span class="n">liftMetaTactic</span> <span class="k">fun</span> <span class="n">mvarId</span> <span class="bp">=&gt;</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">p</span> <span class="bp">←</span> <span class="n">mkFreshExprMVar</span> <span class="o">(</span><span class="n">userName</span> <span class="o">:=</span> <span class="n">name</span><span class="o">)</span> <span class="n">t</span>
      <span class="k">let</span> <span class="n">mvarIdNew</span> <span class="bp">←</span> <span class="n">assert</span> <span class="n">mvarId</span> <span class="n">name</span> <span class="n">t</span> <span class="n">p</span>
      <span class="k">let</span> <span class="o">(</span><span class="n">_</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">)</span> <span class="bp">←</span> <span class="n">intro1P</span> <span class="n">mvarIdNew</span>
      <span class="n">return</span> <span class="o">[</span><span class="n">p.mvarId</span><span class="bp">!</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">]</span>

<span class="n">elab_rules</span> <span class="o">:</span> <span class="n">tactic</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span><span class="k">have</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">h</span><span class="bp">?</span><span class="o">:</span><span class="n">ident</span><span class="o">]</span><span class="bp">?</span> <span class="o">:</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">)</span> <span class="bp">=&gt;</span>
    <span class="k">match</span> <span class="n">h</span><span class="bp">?</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="n">none</span>   <span class="bp">=&gt;</span> <span class="n">haveDef</span> <span class="bp">`</span><span class="n">this</span> <span class="n">t</span>
    <span class="bp">|</span> <span class="n">some</span> <span class="n">h</span> <span class="bp">=&gt;</span> <span class="n">haveDef</span> <span class="n">h.getId</span> <span class="n">t</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">+</span> <span class="o">(</span><span class="mi">2</span> <span class="bp">*</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">h</span><span class="o">]</span>
  <span class="k">have</span> <span class="n">h'</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">+</span> <span class="n">b</span>
  <span class="n">on_goal</span> <span class="bp">-</span><span class="mi">1</span> <span class="bp">=&gt;</span> <span class="n">rw</span> <span class="o">[</span><span class="n">h'</span><span class="o">,</span> <span class="n">Nat.add_assoc</span><span class="o">]</span> <span class="c1">-- targeting the final goal</span>
  <span class="n">case</span> <span class="n">h'</span>    <span class="bp">=&gt;</span> <span class="n">ring</span>
</code></pre></div>
<p>Is that <code>elab_rule</code> enough?</p>



<a name="275597364"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597364" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597364">(Mar 17 2022 at 01:16)</a>:</h4>
<p>you aren't covering the <code>have $[$h?:ident]?</code> case</p>



<a name="275597457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597457" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597457">(Mar 17 2022 at 01:18)</a>:</h4>
<p>Without expliciting a type?</p>



<a name="275597461"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597461" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597461">(Mar 17 2022 at 01:18)</a>:</h4>
<p>right</p>



<a name="275597473"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597473" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597473">(Mar 17 2022 at 01:18)</a>:</h4>
<p>What is supposed to happen in this case?</p>



<a name="275597505"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597505" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597505">(Mar 17 2022 at 01:19)</a>:</h4>
<p>the type is a metavariable (not added as a goal)</p>



<a name="275597591"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597591" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597591">(Mar 17 2022 at 01:21)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="k">have</span> <span class="n">h</span><span class="o">,</span>
  <span class="c1">-- 2 goals</span>
  <span class="c1">-- ⊢ ?m_1</span>

  <span class="c1">-- h : ?m_1</span>
  <span class="c1">-- ⊢ true</span>
<span class="kd">end</span>
</code></pre></div>



<a name="275597623"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275597623" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275597623">(Mar 17 2022 at 01:21)</a>:</h4>
<p>the lean 4 syntax also allows binders between the identifier and the colon, although it is lower priority since lean 3 doesn't support this</p>



<a name="275601252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275601252" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275601252">(Mar 17 2022 at 02:33)</a>:</h4>
<p>How come it's not added as a goal? I see "2 goals" in your example after <code>have h</code></p>



<a name="275603522"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275603522" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275603522">(Mar 17 2022 at 03:23)</a>:</h4>
<p>This seems to work, but for some reason I'm being required to put a semicolon after <code>have</code>:<br>
<a href="https://github.com/leanprover-community/mathlib4/pull/232">https://github.com/leanprover-community/mathlib4/pull/232</a></p>
<p>Help is appreciated <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="275603649"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275603649" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275603649">(Mar 17 2022 at 03:25)</a>:</h4>
<p>FYI you can match both cases of have at once using <code>   | `(tactic|have $[$n:ident]? $[: $t:term]?) =&gt; haveDef n t</code></p>



<a name="275603723"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275603723" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275603723">(Mar 17 2022 at 03:26)</a>:</h4>
<p>I tried that, but it gave me an error</p>



<a name="275603744"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275603744" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275603744">(Mar 17 2022 at 03:27)</a>:</h4>
<p>I think it's related to the semicolon issue. The syntax tree might have some issue</p>



<a name="275603814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275603814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275603814">(Mar 17 2022 at 03:28)</a>:</h4>
<p>We might need a way to say "no line break allowed". Something similar to <code>noWs</code>, which forbids spaces</p>



<a name="275603921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275603921" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275603921">(Mar 17 2022 at 03:30)</a>:</h4>
<p>Most parsers use <code>colGt</code> when parsing trailing idents for exactly this reason. This fixes the issue:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>

<span class="kd">def</span> <span class="n">Lean.Parser.Term.haveIdLhs'</span> <span class="o">:=</span>
  <span class="n">optional</span> <span class="o">(</span><span class="n">ident</span> <span class="bp">&gt;&gt;</span> <span class="n">many</span> <span class="o">(</span><span class="n">ppSpace</span> <span class="bp">&gt;&gt;</span>
    <span class="n">checkColGt</span> <span class="s2">"expected to be indented"</span> <span class="bp">&gt;&gt;</span>
    <span class="o">(</span><span class="n">simpleBinderWithoutType</span> <span class="bp">&lt;|&gt;</span> <span class="n">bracketedBinder</span><span class="o">)))</span> <span class="bp">&gt;&gt;</span> <span class="n">optType</span>

<span class="kn">namespace</span> <span class="n">Mathlib.Tactic</span>

<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Elab.Tactic</span> <span class="n">Meta</span> <span class="n">Parser.Term</span>

<span class="n">syntax</span> <span class="s2">"have "</span> <span class="n">haveIdLhs'</span> <span class="o">:</span> <span class="n">tactic</span>

<span class="n">elab_rules</span> <span class="o">:</span> <span class="n">tactic</span>
<span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span><span class="k">have</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">n</span><span class="o">:</span><span class="n">ident</span><span class="o">]</span><span class="bp">?</span> <span class="bp">$</span><span class="o">[:</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span> <span class="bp">=&gt;</span>
  <span class="n">withMainContext</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">name</span> <span class="o">:</span> <span class="n">Name</span> <span class="o">:=</span> <span class="k">match</span> <span class="n">n</span> <span class="k">with</span>
      <span class="bp">|</span> <span class="n">none</span>   <span class="bp">=&gt;</span> <span class="bp">`</span><span class="n">this</span>
      <span class="bp">|</span> <span class="n">some</span> <span class="n">n</span> <span class="bp">=&gt;</span> <span class="n">n.getId</span>
    <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="n">none</span>   <span class="bp">=&gt;</span> <span class="n">mkFreshTypeMVar</span>
    <span class="bp">|</span> <span class="n">some</span> <span class="n">t</span> <span class="bp">=&gt;</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="n">none</span>
    <span class="n">liftMetaTactic</span> <span class="k">fun</span> <span class="n">mvarId</span> <span class="bp">=&gt;</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">p</span> <span class="bp">←</span> <span class="n">mkFreshExprMVar</span> <span class="o">(</span><span class="n">userName</span> <span class="o">:=</span> <span class="n">name</span><span class="o">)</span> <span class="n">t</span>
      <span class="k">let</span> <span class="n">mvarIdNew</span> <span class="bp">←</span> <span class="n">assert</span> <span class="n">mvarId</span> <span class="n">name</span> <span class="n">t</span> <span class="n">p</span>
      <span class="k">let</span> <span class="o">(</span><span class="n">_</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">)</span> <span class="bp">←</span> <span class="n">intro1P</span> <span class="n">mvarIdNew</span>
      <span class="n">return</span> <span class="o">[</span><span class="n">p.mvarId</span><span class="bp">!</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">]</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">True</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h</span>
  <span class="n">exact</span> <span class="mi">5</span>
  <span class="n">simp</span>
</code></pre></div>



<a name="275604062"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275604062" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275604062">(Mar 17 2022 at 03:34)</a>:</h4>
<p>Hmm, I don't understand it yet but I'm glad it solved the issue!<br>
Will adjust the PR tomorrow</p>



<a name="275604099"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275604099" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275604099">(Mar 17 2022 at 03:35)</a>:</h4>
<p>Thank you :D</p>



<a name="275604102"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275604102" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275604102">(Mar 17 2022 at 03:35)</a>:</h4>
<p>The problem is that</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">True</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h</span>
    <span class="n">simp</span>
</code></pre></div>
<p>is interpreted as</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">True</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">(</span><span class="n">simp</span> <span class="o">:</span> <span class="n">_</span><span class="o">)</span> <span class="o">:</span> <span class="n">_</span>
</code></pre></div>



<a name="275604119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275604119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275604119">(Mar 17 2022 at 03:35)</a>:</h4>
<p>and without the indentation fix,</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">True</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h</span>
  <span class="n">simp</span>
</code></pre></div>
<p>is also interpreted that way</p>



<a name="275604202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275604202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275604202">(Mar 17 2022 at 03:37)</a>:</h4>
<p>Can't we just forbid linebreaks after <code>haveIdLhs</code>?</p>



<a name="275604255"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275604255" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275604255">(Mar 17 2022 at 03:38)</a>:</h4>
<p>(is it even possible to do so?)</p>



<a name="275604266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275604266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275604266">(Mar 17 2022 at 03:38)</a>:</h4>
<p>This way we wouldn't need to redefine the whole syntax</p>



<a name="275605202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275605202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275605202">(Mar 17 2022 at 04:01)</a>:</h4>
<p>well, this is arguably an issue in core</p>



<a name="275605222"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275605222" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275605222">(Mar 17 2022 at 04:01)</a>:</h4>
<p>it's also not a good idea to forbid linebreaks generally because not all uses  fit on a line</p>



<a name="275624485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275624485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275624485">(Mar 17 2022 at 09:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities/near/275597157">said</a>:</p>
<blockquote>
<p>I'm not really sure why <code>this</code> became a keyword in the first place, besides perhaps some tactic that forgot to use <code>&amp;"this"</code> instead of <code>"this"</code> in the syntax. <span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> do you know?</p>
</blockquote>
<p>I don't think you can use <code>&amp;</code> in leading position. But it also looks like a bad idea, since it would make it easy to introduce a variable <code>this</code> that then can't be referenced.</p>



<a name="275668319"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275668319" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275668319">(Mar 17 2022 at 15:14)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I can't understand your comment. Why is <code>this</code> not like any other ident name? You should be able to just use it like <code>this + 2</code>.</p>



<a name="275668549"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275668549" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275668549">(Mar 17 2022 at 15:15)</a>:</h4>
<p><a href="https://github.com/leanprover/lean4/issues/821">https://github.com/leanprover/lean4/issues/821</a></p>



<a name="275670310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275670310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275670310">(Mar 17 2022 at 15:25)</a>:</h4>
<p>In short, because <code>this</code> bindings are not regular, it cannot be a regular identifier</p>



<a name="275672464"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275672464" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275672464">(Mar 17 2022 at 15:37)</a>:</h4>
<p>I remember times in which the well-behaved metavariable names helped me make sense of what was going on:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="k">have</span> <span class="n">h</span><span class="o">,</span>
  <span class="c1">-- 2 goals</span>
  <span class="c1">-- ⊢ ?m_1</span>

  <span class="c1">-- h : ?m_1</span>
  <span class="c1">-- ⊢ true</span>
<span class="kd">end</span>
</code></pre></div>
<p>But with this implementation in Lean 4, they are named after some "arbitrarily" high number:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">True</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h</span>
  <span class="c">/-</span><span class="cm"></span>
<span class="cm">  case h</span>
<span class="cm">  ⊢ ?m.2156</span>
<span class="cm">  h : ?m.2156</span>
<span class="cm">  ⊢ True</span>
<span class="cm">  -/</span>
</code></pre></div>
<p>Should I worry about this?</p>



<a name="275672876"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275672876" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275672876">(Mar 17 2022 at 15:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities/near/275670310">said</a>:</p>
<blockquote>
<p>In short, because <code>this</code> bindings are not regular, it cannot be a regular identifier</p>
</blockquote>
<p>I don't really understand the hygiene system, but can't <code>have := ...; this</code> be treated exactly like <code>have this := ...; this</code>? That is, the <code>have</code> introduces an invisible <code>this</code> token suitably marked up with hygiene stuff so that the second <code>this</code> resolves</p>



<a name="275673128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275673128" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275673128">(Mar 17 2022 at 15:42)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> No, that's a general issue with mvar printing not related to <code>have</code></p>



<a name="275673448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275673448" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275673448">(Mar 17 2022 at 15:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities/near/275672876">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities/near/275670310">said</a>:</p>
<blockquote>
<p>In short, because <code>this</code> bindings are not regular, it cannot be a regular identifier</p>
</blockquote>
<p>I don't really understand the hygiene system, but can't <code>have := ...; this</code> be treated exactly like <code>have this := ...; this</code>? That is, the <code>have</code> introduces an invisible <code>this</code> token suitably marked up with hygiene stuff so that the second <code>this</code> resolves</p>
</blockquote>
<p>Hygiene happens when the quotation is evaluated, i.e. when the syntax tree is constructed. The <code>this</code> binding does not exist at that point in any form.</p>



<a name="275673486"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275673486" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275673486">(Mar 17 2022 at 15:43)</a>:</h4>
<p>I think there are other tactics that want to have this "invisible <code>this</code>" behavior for other names too</p>



<a name="275673621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275673621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275673621">(Mar 17 2022 at 15:44)</a>:</h4>
<p>The <code>have</code> exists though, can't it be marked up somehow?</p>



<a name="275673691"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275673691" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275673691">(Mar 17 2022 at 15:44)</a>:</h4>
<p>that is, we are syntactically at a point where we know it is <code>have</code> and that it needs a <code>this</code></p>



<a name="275674013"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275674013" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275674013">(Mar 17 2022 at 15:46)</a>:</h4>
<p>Well, this is a specific property of the Lean hygiene algorithm that is different in e.g. Racket: only identifiers are annotated with hygiene information, so we can't just say "introduce <code>this</code> with the same scope as the <code>have</code> keyword"</p>



<a name="275674075"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275674075" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275674075">(Mar 17 2022 at 15:46)</a>:</h4>
<p>I'm relatively happy with the <code>this</code> design so far, it makes it completely clear that it does not follow the standard identifier scoping</p>



<a name="275674080"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275674080" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275674080">(Mar 17 2022 at 15:46)</a>:</h4>
<p>I'm not sure the original issue is all that important though. Is there a reason I should care if I don't write things like that in syntax quotations? i.e. as a regular user how does this affect me?</p>



<a name="275674259"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275674259" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275674259">(Mar 17 2022 at 15:47)</a>:</h4>
<p><code>let this := 1</code> is a syntax error. This makes me unhappy as a user</p>



<a name="275674357"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275674357" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275674357">(Mar 17 2022 at 15:48)</a>:</h4>
<p>and there are lots of other places that accept every ident but not <code>this</code></p>



<a name="275674568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275674568" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275674568">(Mar 17 2022 at 15:49)</a>:</h4>
<p><code>let this</code> is not a syntax error</p>



<a name="275674693"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275674693" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275674693">(Mar 17 2022 at 15:50)</a>:</h4>
<p>I thought it was, perhaps <code>fun this =&gt; ...</code>?</p>



<a name="275674815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275674815" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275674815">(Mar 17 2022 at 15:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities/near/275674259">said</a>:</p>
<blockquote>
<p><code>let this := 1</code> is a syntax error. This makes me unhappy as a user</p>
</blockquote>
<p>I had made it possible with a <a href="https://github.com/leanprover-community/mathlib4/blob/f626009af06d8e4d6f29ed20af10c60279dbfd0b/Mathlib/Tactic/Replace.lean#L12">custom syntax</a> for the <code>replace</code> tactic: <a href="https://github.com/leanprover-community/mathlib4/blob/f626009af06d8e4d6f29ed20af10c60279dbfd0b/test/Replace.lean#L45">link</a></p>



<a name="275674831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275674831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275674831">(Mar 17 2022 at 15:51)</a>:</h4>
<p><code>#check fun this =&gt; 1</code> results in a weird error</p>



<a name="275675107"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275675107" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275675107">(Mar 17 2022 at 15:52)</a>:</h4>
<p>Hah, that should probably be a special case in the <code>match</code> elaborator. We shouldn't even elaborate a match in this case.</p>



<a name="275675366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275675366" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275675366">(Mar 17 2022 at 15:54)</a>:</h4>
<p>But going back to the question of why you should care about the fix: in Lean 3 you assume that you can lift arbitrary tactic snippets into a helper tactic, no? In Lean 4 that would involve a syntax quotation, so the fix makes sure <code>this</code> still works in the helper.</p>



<a name="275675588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275675588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275675588">(Mar 17 2022 at 15:55)</a>:</h4>
<p>Now Lean 4 actually doesn't let you lift <em>arbitrary</em> snippets exactly because of hygiene, but without the fix, using <code>this</code> even completely internal to the helper would not work.</p>



<a name="275675589"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275675589" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275675589">(Mar 17 2022 at 15:55)</a>:</h4>
<p>I find that using identifiers of any kinds in syntax quotations does the wrong thing and I always use <code>$(mkIdent `foo)</code></p>



<a name="275675629"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275675629" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275675629">(Mar 17 2022 at 15:55)</a>:</h4>
<p>which probably makes me a bad person</p>



<a name="275676015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275676015" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275676015">(Mar 17 2022 at 15:57)</a>:</h4>
<p>I guess you don't perceive them as separate scopes then. Which makes sense coming from Lean 3, but I'd hope that's not the natural assumption to make without that background.</p>



<a name="275676126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275676126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275676126">(Mar 17 2022 at 15:58)</a>:</h4>
<p>I don't really know what that means. I want a <code>foo</code> in my expression</p>



<a name="275676152"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275676152" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275676152">(Mar 17 2022 at 15:58)</a>:</h4>
<p>and writing <code>foo</code> doesn't give me that</p>



<a name="275676196"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275676196" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275676196">(Mar 17 2022 at 15:58)</a>:</h4>
<p>Such that it is visible to the outside?</p>



<a name="275676218"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275676218" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275676218">(Mar 17 2022 at 15:58)</a>:</h4>
<p>such that the identifier is called <code>foo</code></p>



<a name="275676595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275676595" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275676595">(Mar 17 2022 at 16:00)</a>:</h4>
<p>my model of identifiers is probably not hygienic, I just think of them as names and everything else scares me</p>



<a name="275676778"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275676778" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275676778">(Mar 17 2022 at 16:00)</a>:</h4>
<p>(I exaggerate, but hygienic identifiers are significantly more complex to deal with as a tactic author)</p>



<a name="275677669"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275677669" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275677669">(Mar 17 2022 at 16:03)</a>:</h4>
<p>I think that hygiene is most important for macro tactics and other "simple" expansions where you aren't doing anything except shuffling syntax around and using syntax quotations</p>



<a name="275677681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275677681" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275677681">(Mar 17 2022 at 16:03)</a>:</h4>
<p>I can't say much without a specific example. But the whole point of hygiene is to make scoping in metaprograms behave like you would expect in regular programs. If a variable reference in a helper function doesn't bind to a variable of that name in the caller, then the same should be true for a helper tactic.</p>



<a name="275677881"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275677881" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275677881">(Mar 17 2022 at 16:04)</a>:</h4>
<p>I am usually writing <code>elab</code> tactics where very little is done using syntax quotations, and there it seems that hygiene is only an interference</p>



<a name="275678446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275678446" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275678446">(Mar 17 2022 at 16:05)</a>:</h4>
<p>An example might be Arthur's <code>have</code> tactic above; what does it need to do to handle <code>this</code> correctly?</p>



<a name="275678921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275678921" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275678921">(Mar 17 2022 at 16:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities/near/275678446">said</a>:</p>
<blockquote>
<p>An example might be Arthur's <code>have</code> tactic above; what does it need to do to handle <code>this</code> correctly?</p>
</blockquote>
<p><a href="https://github.com/leanprover-community/mathlib4/blob/f626009af06d8e4d6f29ed20af10c60279dbfd0b/Mathlib/Tactic/Replace.lean#L14">This code</a> did it. But it relied on that custom syntax</p>



<a name="275679189"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275679189" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275679189">(Mar 17 2022 at 16:07)</a>:</h4>
<p>Here's a proposal: an <code>invisibleThis</code> parser that parses nothing and yields a hygienic <code>this</code> ident</p>



<a name="275679417"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275679417" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275679417">(Mar 17 2022 at 16:08)</a>:</h4>
<p>then <code>have</code> and friends can use <code>"have" (ident &lt;|&gt; invisibleThis) ...</code></p>



<a name="275679574"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275679574" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275679574">(Mar 17 2022 at 16:09)</a>:</h4>
<p>(or better yet, <code>invisible(`this)</code> since that way you can use other names too)</p>



<a name="275680274"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275680274" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275680274">(Mar 17 2022 at 16:10)</a>:</h4>
<p>That would make <code>have := 1; this</code> and <code>have this := 1; this</code> produce the exact same <code>Syntax</code></p>



<a name="275680329"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275680329" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275680329">(Mar 17 2022 at 16:11)</a>:</h4>
<p>(which is not currently the case btw, the second one adds a match)</p>



<a name="275680732"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275680732" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275680732">(Mar 17 2022 at 16:12)</a>:</h4>
<p><code>implicit(`this)</code> also works as a name</p>



<a name="275682429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275682429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275682429">(Mar 17 2022 at 16:20)</a>:</h4>
<p>You can use <code>(ident &lt;|&gt; Lean.termThis)</code>, though perhaps you had something different in mind</p>



<a name="275682583"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275682583" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275682583">(Mar 17 2022 at 16:20)</a>:</h4>
<p>I'm talking about making the binder special and making <code>this</code> a regular identifier again</p>



<a name="275683003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275683003" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275683003">(Mar 17 2022 at 16:22)</a>:</h4>
<p>The reason <code>have := 1; this</code> doesn't work is because the second <code>this</code> gets marked up with hygiene information local to the scope and the first one doesn't, because it doesn't exist. To fix this we can have a parser that inserts a <code>this</code> token exactly as though the extra characters <code> this</code> were present in the original string</p>



<a name="275683531"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275683531" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275683531">(Mar 17 2022 at 16:24)</a>:</h4>
<p>The one fundamental rule of the parser is that the token sequence in the returned syntax tree is identical to the input</p>



<a name="275683858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275683858" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275683858">(Mar 17 2022 at 16:25)</a>:</h4>
<p>Okay, then it's not a proper token but instead a <code>node Parser.implicit._0.metadata #[]</code> or something</p>



<a name="275683911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275683911" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275683911">(Mar 17 2022 at 16:25)</a>:</h4>
<p>it's your choice where you want to stuff the metadata</p>



<a name="275686909"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275686909" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275686909">(Mar 17 2022 at 16:36)</a>:</h4>
<p>That would work for the parser, but we would have to adjust the hygiene algorithm. It sounds a bit messy.</p>



<a name="275691529"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275691529" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275691529">(Mar 17 2022 at 16:53)</a>:</h4>
<p>For what it's worth, it would be nice if the desired tactic could be implemented purely as a macro. This comes close, but the case with the missing type adds it as an additional goal.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="s2">"have "</span> <span class="o">(</span><span class="n">colGt</span> <span class="n">term</span><span class="o">)</span><span class="bp">?</span> <span class="o">(</span><span class="s2">" : "</span> <span class="n">colGt</span> <span class="n">term</span><span class="o">)</span><span class="bp">?</span> <span class="o">:</span> <span class="n">tactic</span>
<span class="n">macro_rules</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="k">have</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">id</span><span class="o">:</span><span class="n">ident</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="k">have</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">id</span><span class="o">:</span><span class="n">ident</span><span class="o">]</span><span class="bp">?</span> <span class="o">:</span> <span class="bp">?</span><span class="n">_</span> <span class="o">:=</span> <span class="bp">?</span><span class="n">_</span><span class="o">)</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="k">have</span> <span class="o">:</span> <span class="bp">$</span><span class="n">h</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="k">have</span> <span class="o">:</span> <span class="bp">$</span><span class="n">h</span> <span class="o">:=</span> <span class="bp">?</span><span class="n">_</span><span class="o">)</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="k">have</span> <span class="bp">$</span><span class="n">e</span><span class="o">:</span><span class="n">term</span> <span class="bp">$</span><span class="o">[:</span> <span class="bp">$</span><span class="n">h</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="k">have</span> <span class="bp">$</span><span class="n">e</span><span class="o">:</span><span class="n">term</span> <span class="bp">$</span><span class="o">[:</span> <span class="bp">$</span><span class="n">h</span><span class="o">]</span><span class="bp">?</span> <span class="o">:=</span> <span class="bp">?</span><span class="n">_</span><span class="o">)</span>
</code></pre></div>



<a name="275693516"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275693516" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275693516">(Mar 17 2022 at 17:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities/near/275691529">said</a>:</p>
<blockquote>
<p>but the case with the missing type adds it as an additional goal</p>
</blockquote>
<p>How come? Even if I provide the term? I would like Lean to elaborate the type for me in that case</p>



<a name="275693920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275693920" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275693920">(Mar 17 2022 at 17:04)</a>:</h4>
<p>No, only if it can't be inferred</p>



<a name="275694084"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275694084" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275694084">(Mar 17 2022 at 17:05)</a>:</h4>
<p>Wait, I thought the point of the tactic was that you <em>don't</em> provide the term <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="275694973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275694973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275694973">(Mar 17 2022 at 17:08)</a>:</h4>
<p>This no longer works <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">True</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">h</span>
  <span class="n">exact</span> <span class="mi">5</span> <span class="c1">-- invalid universe level, ?u.2348 is not greater than 0</span>
  <span class="n">simp</span>
</code></pre></div>



<a name="275695743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275695743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275695743">(Mar 17 2022 at 17:13)</a>:</h4>
<p>Ah, the goals are in the wrong order</p>



<a name="275698085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275698085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275698085">(Mar 17 2022 at 17:29)</a>:</h4>
<p>(deleted)</p>



<a name="275706181"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275706181" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275706181">(Mar 17 2022 at 18:30)</a>:</h4>
<p>Let's bring <a href="https://github.com/leanprover-community/mathlib4/pull/232#discussion_r829252422">the discussion</a> here.<br>
What should I do with the syntax?</p>



<a name="275706410"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275706410" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275706410">(Mar 17 2022 at 18:32)</a>:</h4>
<p>Do you know how to support the binders?</p>



<a name="275706453"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275706453" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275706453">(Mar 17 2022 at 18:33)</a>:</h4>
<p>I still don't know what binders are <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="275706464"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275706464" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275706464">(Mar 17 2022 at 18:33)</a>:</h4>
<p>if  you can support the entire tactic that would be ideal</p>



<a name="275706550"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275706550" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275706550">(Mar 17 2022 at 18:33)</a>:</h4>
<p>The idea is that <code>have foo x := x + 1</code> should define a function like <code>have foo := fun x =&gt; x + 1</code></p>



<a name="275706721"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275706721" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275706721">(Mar 17 2022 at 18:35)</a>:</h4>
<p><code>have foo x : x &lt; x + 1</code> would produce a proof of <code>foo : (x : Nat) -&gt; x &lt; x + 1</code> on one branch and a proof obligation <code>x : nat |- x &lt; x + 1</code> on the other (note that <code>x</code> is already introduced)</p>



<a name="275706948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275706948" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275706948">(Mar 17 2022 at 18:36)</a>:</h4>
<p>So If i have more than one identifier it will always define a function?</p>



<a name="275707030"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707030" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707030">(Mar 17 2022 at 18:37)</a>:</h4>
<p>(using the first identifier as the function name and the others as parameters)</p>



<a name="275707087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707087">(Mar 17 2022 at 18:37)</a>:</h4>
<p>yes, the syntax is an ident followed by a list of <code>x</code> or <code>(x)</code> or <code>(x : ty)</code></p>



<a name="275707231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707231" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707231">(Mar 17 2022 at 18:38)</a>:</h4>
<p>1 ident =&gt; current behavior<br>
2+ ident =&gt; function</p>



<a name="275707243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707243">(Mar 17 2022 at 18:38)</a>:</h4>
<p>I can do that</p>



<a name="275707257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707257" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707257">(Mar 17 2022 at 18:38)</a>:</h4>
<p>it's not a separate case, really</p>



<a name="275707314"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707314" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707314">(Mar 17 2022 at 18:39)</a>:</h4>
<p>the <code>haveIdLhs</code> parser gives you the list of binders and the name separately</p>



<a name="275707534"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707534" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707534">(Mar 17 2022 at 18:41)</a>:</h4>
<p><code>have foo := x + 1</code><br>
<code>have foo x := x + 1</code><br>
Are those the same case?</p>



<a name="275707570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707570" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707570">(Mar 17 2022 at 18:41)</a>:</h4>
<p>yes, the first one has binders <code>[]</code> and the second has binders <code>[x]</code></p>



<a name="275707592"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707592" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707592">(Mar 17 2022 at 18:41)</a>:</h4>
<p>and <code>have foo x y</code> would have binders <code>[x, y]</code></p>



<a name="275707705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707705">(Mar 17 2022 at 18:42)</a>:</h4>
<p>and <code>have (x : ty)</code> would have binders <code>[(x : ty)]</code> and no ident (i.e. <code>this</code>)</p>



<a name="275707720"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707720" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707720">(Mar 17 2022 at 18:42)</a>:</h4>
<p>the parser handles all this already</p>



<a name="275707769"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707769" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707769">(Mar 17 2022 at 18:43)</a>:</h4>
<p>I will try it later</p>



<a name="275707837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275707837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275707837">(Mar 17 2022 at 18:43)</a>:</h4>
<p>is there an example of these binders handling?</p>



<a name="275708351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275708351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275708351">(Mar 17 2022 at 18:47)</a>:</h4>
<p><code>intro</code> tactic, or <code>let</code></p>



<a name="275708443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275708443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275708443">(Mar 17 2022 at 18:48)</a>:</h4>
<p>you might just be able to delegate to regular <code>have</code></p>



<a name="275807046"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275807046" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275807046">(Mar 18 2022 at 14:07)</a>:</h4>
<p>delegating to regular <code>have</code> has the same issue from Sebastian's macro</p>



<a name="275846647"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275846647" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275846647">(Mar 18 2022 at 18:48)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I'm not sure I fully understood what you meant in the lean4 stream. This is my current code:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>

<span class="kd">def</span> <span class="n">Lean.Parser.Term.haveIdLhs'</span> <span class="o">:</span> <span class="n">Parser</span> <span class="o">:=</span>
  <span class="n">optional</span> <span class="o">(</span><span class="n">ident</span> <span class="bp">&gt;&gt;</span> <span class="n">many</span> <span class="o">(</span><span class="n">ppSpace</span> <span class="bp">&gt;&gt;</span>
    <span class="n">checkColGt</span> <span class="s2">"expected to be indented"</span> <span class="bp">&gt;&gt;</span>
    <span class="o">(</span><span class="n">simpleBinderWithoutType</span> <span class="bp">&lt;|&gt;</span> <span class="n">bracketedBinder</span><span class="o">)))</span> <span class="bp">&gt;&gt;</span> <span class="n">optType</span>

<span class="kd">def</span> <span class="n">Lean.Parser.Term.letIdLhs'</span> <span class="o">:</span> <span class="n">Parser</span> <span class="o">:=</span>
  <span class="n">ident</span> <span class="bp">&gt;&gt;</span> <span class="n">notFollowedBy</span> <span class="o">(</span><span class="n">checkNoWsBefore</span> <span class="s2">""</span> <span class="bp">&gt;&gt;</span> <span class="s2">"["</span><span class="o">)</span>
    <span class="s2">"space is required before instance '[...]' binders to distinguish them from array updates `let x[i] := e; ...`"</span> <span class="bp">&gt;&gt;</span>
      <span class="n">many</span> <span class="o">(</span><span class="n">ppSpace</span> <span class="bp">&gt;&gt;</span> <span class="n">checkColGt</span> <span class="s2">"expected to be indented"</span> <span class="bp">&gt;&gt;</span>
        <span class="o">(</span><span class="n">simpleBinderWithoutType</span> <span class="bp">&lt;|&gt;</span> <span class="n">bracketedBinder</span><span class="o">))</span> <span class="bp">&gt;&gt;</span> <span class="n">optType</span>

<span class="kn">namespace</span> <span class="n">Mathlib.Tactic</span>

<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Elab.Tactic</span> <span class="n">Meta</span>

<span class="n">syntax</span> <span class="s2">"have "</span> <span class="n">Parser.Term.haveIdLhs'</span> <span class="o">:</span> <span class="n">tactic</span>
<span class="n">syntax</span> <span class="s2">"let "</span>  <span class="n">Parser.Term.letIdLhs'</span>  <span class="o">:</span> <span class="n">tactic</span>

<span class="kn">private</span> <span class="kd">def</span> <span class="n">addToContext</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="n">Name</span><span class="o">)</span> <span class="o">(</span><span class="n">t</span> <span class="o">:</span> <span class="n">Expr</span><span class="o">)</span> <span class="o">(</span><span class="n">keepTerm</span> <span class="o">:</span> <span class="n">Bool</span><span class="o">)</span> <span class="o">:</span> <span class="n">TacticM</span> <span class="n">Unit</span> <span class="o">:=</span>
  <span class="k">let</span> <span class="n">declFn</span> <span class="o">:=</span> <span class="k">if</span> <span class="n">keepTerm</span> <span class="k">then</span> <span class="n">define</span> <span class="k">else</span> <span class="n">assert</span>
  <span class="n">liftMetaTactic</span> <span class="k">fun</span> <span class="n">mvarId</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">p</span> <span class="bp">←</span> <span class="n">mkFreshExprMVar</span> <span class="o">(</span><span class="n">userName</span> <span class="o">:=</span> <span class="n">name</span><span class="o">)</span> <span class="n">t</span>
    <span class="k">let</span> <span class="n">mvarIdNew</span> <span class="bp">←</span> <span class="n">declFn</span> <span class="n">mvarId</span> <span class="n">name</span> <span class="n">t</span> <span class="n">p</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">_</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">)</span> <span class="bp">←</span> <span class="n">intro1P</span> <span class="n">mvarIdNew</span>
    <span class="n">return</span> <span class="o">[</span><span class="n">p.mvarId</span><span class="bp">!</span><span class="o">,</span> <span class="n">mvarIdNew</span><span class="o">]</span>

<span class="kn">private</span> <span class="kd">def</span> <span class="n">elabType</span> <span class="o">(</span><span class="n">t</span> <span class="o">:</span> <span class="n">Option</span> <span class="n">Syntax</span><span class="o">)</span> <span class="o">:</span> <span class="n">Elab.TermElabM</span> <span class="n">Expr</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">none</span>   <span class="bp">=&gt;</span> <span class="n">mkFreshTypeMVar</span>
  <span class="bp">|</span> <span class="n">some</span> <span class="n">t</span> <span class="bp">=&gt;</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="n">none</span>

<span class="n">elab_rules</span> <span class="o">:</span> <span class="n">tactic</span>
<span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span><span class="k">have</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">n</span><span class="o">:</span><span class="n">ident</span><span class="o">]</span><span class="bp">?</span> <span class="bp">$</span><span class="o">[:</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span>  <span class="bp">=&gt;</span> <span class="n">withMainContext</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">name</span> <span class="o">:=</span> <span class="k">match</span> <span class="n">n</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="n">none</span>   <span class="bp">=&gt;</span> <span class="bp">`</span><span class="n">this</span>
    <span class="bp">|</span> <span class="n">some</span> <span class="n">n</span> <span class="bp">=&gt;</span> <span class="n">n.getId</span>
  <span class="n">addToContext</span> <span class="n">name</span> <span class="o">(</span><span class="bp">←</span> <span class="n">elabType</span> <span class="n">t</span><span class="o">)</span> <span class="n">false</span>
<span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span><span class="k">have</span> <span class="bp">$</span><span class="n">n</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">bs</span><span class="bp">*</span> <span class="bp">$</span><span class="o">[:</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">withMainContext</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">e</span> <span class="bp">←</span> <span class="n">Elab.Term.elabBinders</span> <span class="n">bs</span> <span class="bp">$</span>
      <span class="k">fun</span> <span class="n">es</span> <span class="bp">=&gt;</span> <span class="k">do</span> <span class="n">mkForallFVars</span> <span class="n">es</span> <span class="o">(</span><span class="bp">←</span> <span class="n">elabType</span> <span class="n">t</span><span class="o">)</span>
    <span class="n">addToContext</span> <span class="n">n.getId</span> <span class="n">e</span> <span class="n">false</span>
<span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span><span class="k">let</span> <span class="bp">$</span><span class="n">n</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="o">[:</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span>       <span class="bp">=&gt;</span> <span class="n">withMainContext</span> <span class="k">do</span>
  <span class="n">addToContext</span> <span class="n">n.getId</span> <span class="o">(</span><span class="bp">←</span> <span class="n">elabType</span> <span class="n">t</span><span class="o">)</span> <span class="n">true</span>
<span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span><span class="k">let</span> <span class="bp">$</span><span class="n">n</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">bs</span><span class="bp">*</span> <span class="bp">$</span><span class="o">[:</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span>  <span class="bp">=&gt;</span> <span class="n">withMainContext</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">e</span> <span class="bp">←</span> <span class="n">Elab.Term.elabBinders</span> <span class="n">bs</span> <span class="bp">$</span>
      <span class="k">fun</span> <span class="n">es</span> <span class="bp">=&gt;</span> <span class="k">do</span> <span class="n">mkForallFVars</span> <span class="n">es</span> <span class="o">(</span><span class="bp">←</span> <span class="n">elabType</span> <span class="n">t</span><span class="o">)</span>
    <span class="n">addToContext</span> <span class="n">n.getId</span> <span class="n">e</span> <span class="n">true</span>
</code></pre></div>



<a name="275846687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275846687" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275846687">(Mar 18 2022 at 18:49)</a>:</h4>
<p>I'm tackling <code>let</code> and <code>have</code> in the same file because there's a lot of code that can be reused</p>



<a name="275846839"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275846839" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275846839">(Mar 18 2022 at 18:50)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">have</span> <span class="n">f</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">x</span> <span class="bp">+</span> <span class="mi">1</span>
</code></pre></div>
<p>should produce goals</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">case</span> <span class="n">f</span>
<span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span>
<span class="bp">|-</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">x</span> <span class="bp">+</span> <span class="mi">1</span>

<span class="n">f</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="bp">-&gt;</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">x</span> <span class="bp">+</span> <span class="mi">1</span>
<span class="bp">|-</span> <span class="n">goal</span>
</code></pre></div>



<a name="275846963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275846963" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275846963">(Mar 18 2022 at 18:51)</a>:</h4>
<p>I think that means that you have to inline <code>addToContext</code> and move some things around</p>



<a name="275847406"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275847406" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275847406">(Mar 18 2022 at 18:55)</a>:</h4>
<p>Alright. Another question: is there another elab_rule I am missing?</p>



<a name="275848492"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275848492" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275848492">(Mar 18 2022 at 19:03)</a>:</h4>
<p>IIRC the behavior is different if you put more than one symtax node in the same elab_rules</p>



<a name="275848533"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275848533" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275848533">(Mar 18 2022 at 19:03)</a>:</h4>
<p>so I think you want <code>have</code> and <code>let</code> to be separate</p>



<a name="275848730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275848730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275848730">(Mar 18 2022 at 19:05)</a>:</h4>
<p>also I think you should be matching <code>(tactic| have $[$n:ident $bs*]? $[: $t:term]?)</code></p>



<a name="275848878"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275848878" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275848878">(Mar 18 2022 at 19:06)</a>:</h4>
<p>which is the only case</p>



<a name="275848937"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275848937" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275848937">(Mar 18 2022 at 19:07)</a>:</h4>
<p>Nice, tyvm <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="275869429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275869429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275869429">(Mar 18 2022 at 22:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities/near/275846839">said</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">have</span> <span class="n">f</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">x</span> <span class="bp">+</span> <span class="mi">1</span>
</code></pre></div>
<p>should produce goals</p>
<p><div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">case</span> <span class="n">f</span>
<span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span>
<span class="bp">|-</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">x</span> <span class="bp">+</span> <span class="mi">1</span>

<span class="n">f</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="bp">-&gt;</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">x</span> <span class="bp">+</span> <span class="mi">1</span>
<span class="bp">|-</span> <span class="n">goal</span>
</code></pre></div><br>
</p>
</blockquote>
<p>I don't know how to make it possible. I thought about a hacky solution performing <code>intro x</code> multiple times (depending on the number of binders and their types)</p>



<a name="275869485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275869485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275869485">(Mar 18 2022 at 22:19)</a>:</h4>
<p>Hmm, maybe not "hacky", but kinda inefficient</p>



<a name="275876322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/expand%20%60have%60%20capabilities/near/275876322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/expand.20.60have.60.20capabilities.html#275876322">(Mar 18 2022 at 23:56)</a>:</h4>
<p>Okay I think it turned out pretty good actually: <a href="https://github.com/leanprover-community/mathlib4/pull/232">mathlib4#232</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>