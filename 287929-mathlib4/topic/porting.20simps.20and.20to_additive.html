---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html">porting simps and to_additive</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="263142355"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263142355" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263142355">(Nov 30 2021 at 13:20)</a>:</h4>
<p>I want to start porting some meta code to Lean 4, and I want to start with the things I'm most familiar with, which are <code>@[simps]</code> and <code>@[to_additive]</code>.</p>
<p>I'll have to ask a bunch of questions along the way, so to start:<br>
If in Lean 3 we used an attribute with a cache value, how do we do this in Lean 4? With a <code>PersistentEnvExtension</code> directly?</p>



<a name="263144012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263144012" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263144012">(Nov 30 2021 at 13:31)</a>:</h4>
<p>Although I guess that most cache-attributes like that just stored the <code>name_map</code> of parameters, which seems to be handled automatically by the attribute.</p>



<a name="263148546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263148546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263148546">(Nov 30 2021 at 14:03)</a>:</h4>
<p>How hard would it be to use mathport to already port all files that are <em>below</em> all/most tactic files in the file hierarchy? Things like <code>data.list.defs</code> and <code>data.string.defs</code>? That would be useful for tactic writing.</p>



<a name="263148984"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263148984" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263148984">(Nov 30 2021 at 14:06)</a>:</h4>
<p>Starting from the end: you can look at the ported files here: <a href="https://github.com/leanprover-community/mathlib3port/blob/master/Mathbin/Data/String/Defs.lean">https://github.com/leanprover-community/mathlib3port/blob/master/Mathbin/Data/String/Defs.lean</a></p>
<p>But particularly strings are probably a bad thing to port directly.  These should be rewritten.</p>



<a name="263149358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263149358" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263149358">(Nov 30 2021 at 14:09)</a>:</h4>
<blockquote>
<p>Although I guess that most cache-attributes like that just stored the name_map of parameters, which seems to be handled automatically by the attribute.</p>
</blockquote>
<p>There are various kinds of attributes that store (and compute) different kinds of state.  I suggest reading through <a href="https://github.com/leanprover/lean4/blob/f01a124f187793cdf09788b0cc102eba156b1c60/src/Lean/Attributes.lean">https://github.com/leanprover/lean4/blob/f01a124f187793cdf09788b0cc102eba156b1c60/src/Lean/Attributes.lean</a> to get an idea of the available attribute types.  You almost certainly shouldn't create a PersistentEnvExtension manually.</p>



<a name="263149464"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263149464" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263149464">(Nov 30 2021 at 14:10)</a>:</h4>
<p>We also have another cache API here: <a href="https://github.com/leanprover-community/mathlib4/blob/8fe680846b7f4dd1b93688a6355c1c1a0cba7f06/Mathlib/Tactic/Cache.lean">https://github.com/leanprover-community/mathlib4/blob/8fe680846b7f4dd1b93688a6355c1c1a0cba7f06/Mathlib/Tactic/Cache.lean</a>  But I don't think this is applicable for simps/toAdditive.</p>



<a name="263150334"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263150334" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263150334">(Nov 30 2021 at 14:15)</a>:</h4>
<p>Thanks for the pointers!</p>



<a name="263154720"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263154720" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263154720">(Nov 30 2021 at 14:44)</a>:</h4>
<p>In Lean 3 there is <code>has_attribute</code> which takes the <em>name</em> of an attribute, which is convenient if your attribute has not defined yet (e.g. the implementation of <code>to_additive</code> checks whether other declarations are marked as <code>to_additive</code>). How to do this in Lean 4? I can only find <code>ParametricAttribute.getParam</code> and <code>isAttribute</code> which are somewhat similar.</p>



<a name="263154924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263154924" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263154924">(Nov 30 2021 at 14:46)</a>:</h4>
<p>I don't think this exists in general.  But for to_additive, you could just look in the state of the attribute.</p>



<a name="263155291"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263155291" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263155291">(Nov 30 2021 at 14:48)</a>:</h4>
<p>I guess I could do that, but then I have to inline the definition <a href="https://leanprover-community.github.io/mathlib_docs/find/to_additive.first_multiplicative_arg/src">src#to_additive.first_multiplicative_arg</a>.</p>



<a name="263155670"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263155670" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263155670">(Nov 30 2021 at 14:51)</a>:</h4>
<p>I mean you can still write a <code>has_attribute' `to_additive</code> function, it will just be specific to toAdditive (and won't work for other attributes).</p>



<a name="263156507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263156507" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263156507">(Nov 30 2021 at 14:57)</a>:</h4>
<p>before I declare the attribute? I don't see how.</p>



<a name="263156822"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263156822" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263156822">(Nov 30 2021 at 15:00)</a>:</h4>
<p>Also, am I correct that I cannot tag a declaration with an attribute in the file where I define that attribute?</p>



<a name="263163764"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263163764" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263163764">(Nov 30 2021 at 15:48)</a>:</h4>
<blockquote>
<p>before I declare the attribute? I don't see how.</p>
</blockquote>
<p>Ah yes, the easiest thing is probably to just pass the state around.  You could also try to apply the <code>@[init]</code> attribute afterwards (not sure if that works):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">constant</span> <span class="n">myAttr</span> <span class="o">:</span> <span class="n">ParametricAttribute</span> <span class="n">Foo</span>

<span class="c1">-- here you can already refer to myAttr</span>

<span class="kd">def</span> <span class="n">myAttrInit</span> <span class="o">:</span> <span class="n">IO</span> <span class="o">(</span><span class="n">ParametricAttribute</span> <span class="n">Foo</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">registerParametricAttribute</span> <span class="o">{</span> <span class="bp">...</span> <span class="o">}</span>

<span class="kn">attribute</span> <span class="o">[</span><span class="n">init</span> <span class="n">myAttrInit</span><span class="o">]</span> <span class="n">myAttr</span>
</code></pre></div>



<a name="263163837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263163837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263163837">(Nov 30 2021 at 15:49)</a>:</h4>
<blockquote>
<p>Also, am I correct that I cannot tag a declaration with an attribute in the file where I define that attribute?</p>
</blockquote>
<p>Yes, depending on the attribute type you can also only tag declarations in the same file.</p>



<a name="263278328"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263278328" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263278328">(Dec 01 2021 at 11:52)</a>:</h4>
<p>Thanks, that is helpful!</p>
<p>Two more questions about attributes.</p>
<ul>
<li>If I define an attribute like this</li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">foo</span><span class="o">)</span> <span class="s2">"foo"</span> <span class="n">num</span><span class="bp">*</span> <span class="o">:</span> <span class="n">attr</span>
<span class="n">initialize</span> <span class="n">fooAttr</span> <span class="o">:</span> <span class="n">ParametricAttribute</span> <span class="o">(</span><span class="n">List</span> <span class="n">Nat</span><span class="o">)</span> <span class="bp">←</span>
  <span class="n">registerParametricAttribute</span> <span class="o">{</span>
    <span class="n">name</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">foo</span>
    <span class="n">descr</span> <span class="o">:=</span> <span class="s2">"foo desc."</span>
    <span class="n">getParam</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">decl</span> <span class="n">stx</span> <span class="bp">=&gt;</span>
      <span class="k">match</span> <span class="n">stx</span> <span class="k">with</span>
        <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">attr</span><span class="bp">|</span><span class="n">foo</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">ns</span><span class="o">]</span><span class="bp">*</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="o">(</span><span class="n">ns.map</span> <span class="o">(</span><span class="bp">·.</span><span class="n">toNat</span><span class="o">))</span><span class="bp">.</span><span class="n">toList</span>
        <span class="bp">|</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">throwError</span> <span class="s2">"unexpected foo syntax {stx}"</span>
  <span class="o">}</span>
</code></pre></div>
<p>I don't have to check that <code>ns</code> is a list of identifiers, because the parser will already complain if this is not the case, right?<br>
Also, can I actually get to the <code>throwError</code> line? It seems like the parser will not even run this code if the syntax does not match the first case.</p>
<ul>
<li>Suppose I have two syntax declarations </li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">bar</span><span class="o">)</span> <span class="s2">"bar"</span> <span class="n">num</span><span class="bp">*</span> <span class="o">:</span> <span class="n">attr</span>
<span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">bar</span><span class="bp">!</span><span class="o">)</span> <span class="s2">"bar!"</span> <span class="n">num</span><span class="bp">*</span> <span class="o">:</span> <span class="n">attr</span>
</code></pre></div>
<p>(this is in the <code>Mathport.Syntax</code> file for e.g. <code>toAdditive</code>). How do I make a single attribute that is triggered on both these parses? I tried something like</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">initialize</span> <span class="n">barAttr</span> <span class="o">:</span> <span class="n">ParametricAttribute</span> <span class="o">(</span><span class="n">List</span> <span class="n">Nat</span><span class="o">)</span> <span class="bp">←</span>
  <span class="n">registerParametricAttribute</span> <span class="o">{</span>
    <span class="n">name</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">bar</span>
    <span class="n">descr</span> <span class="o">:=</span> <span class="s2">"bar desc."</span>
    <span class="n">getParam</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">decl</span> <span class="n">stx</span> <span class="bp">=&gt;</span>
      <span class="k">match</span> <span class="n">stx</span> <span class="k">with</span>
        <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">attr</span><span class="bp">|</span><span class="n">bar</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">ns</span><span class="o">]</span><span class="bp">*</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="o">(</span><span class="n">ns.map</span> <span class="o">(</span><span class="bp">·.</span><span class="n">toNat</span><span class="o">))</span><span class="bp">.</span><span class="n">toList</span>
        <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">attr</span><span class="bp">|</span><span class="n">bar</span><span class="bp">!</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">ns</span><span class="o">]</span><span class="bp">*</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="o">(</span><span class="n">ns.map</span> <span class="o">(</span><span class="bp">·.</span><span class="n">toNat</span><span class="o">))</span><span class="bp">.</span><span class="n">toList</span>
        <span class="bp">|</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">throwError</span> <span class="s2">"unexpected bar syntax {stx}"</span>
  <span class="o">}</span>
</code></pre></div>
<p>but that doesn't work for <code>bar!</code> (I get <code>unknown attribute [bar!]</code>)</p>



<a name="263281160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263281160" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263281160">(Dec 01 2021 at 12:22)</a>:</h4>
<blockquote>
<p>I don't have to check that ns is a list of identifiers, because the parser will already complain if this is not the case, right?</p>
</blockquote>
<p>It's an <em>array</em> of <em>numbers</em>, but otherwise you're correct.</p>



<a name="263281271"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263281271" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263281271">(Dec 01 2021 at 12:24)</a>:</h4>
<blockquote>
<p>How do I make a single attribute that is triggered on both these parses?</p>
</blockquote>
<p>I don't think you can.  I would just either make two attributes or turn the parser into <code>"bar" "!"?</code>.</p>



<a name="263281601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263281601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263281601">(Dec 01 2021 at 12:26)</a>:</h4>
<p>does that actually work? I would have expected it to parse <code>bar!</code> as an ident anyway</p>



<a name="263281786"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263281786" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263281786">(Dec 01 2021 at 12:28)</a>:</h4>
<p>You're right.  Writing <code>bar!</code> doesn't work, but <code>bar !</code> works, which is almost as good.</p>



<a name="263281791"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263281791" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263281791">(Dec 01 2021 at 12:28)</a>:</h4>
<p>For a lot of attributes, I think we want to separate the data storage from the syntax/parsing part. In this case we have two syntax-level attributes but only one data storage component</p>



<a name="263281840"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263281840" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263281840">(Dec 01 2021 at 12:29)</a>:</h4>
<p>I think the built in mechanisms like <code>TagAttribute</code> tie the two parts together, so we don't want to use that</p>



<a name="263281865"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263281865" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263281865">(Dec 01 2021 at 12:29)</a>:</h4>
<p>not sure about <code>ParametricAttribute</code></p>



<a name="263282056"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263282056" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263282056">(Dec 01 2021 at 12:31)</a>:</h4>
<p>It also has a storage part, but we can just ignore it (or use <code>registerBuiltinAttribute</code> directly).</p>



<a name="263282363"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263282363" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263282363">(Dec 01 2021 at 12:34)</a>:</h4>
<p>yeah, I think <code>registerBuiltinAttribute</code> is the way to go, most of the things done in the function <code>registerParametricAttribute</code> passes to it are not needed for a generic attribute definition</p>



<a name="263282599"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263282599" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263282599">(Dec 01 2021 at 12:36)</a>:</h4>
<p>In fact, I think we rarely want a simple <code>PersistentEnvExtension</code> that just tracks applications of the attribute. Usually the actual data store is somewhat derived from this</p>



<a name="263283302"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263283302" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263283302">(Dec 01 2021 at 12:42)</a>:</h4>
<p>I've defined a custom attribute like this for Aesop. Code: <a href="https://github.com/JLimperg/aesop/blob/55c0d71da597d540b51703afc13f488503ac2885/Aesop/Config.lean#L542">https://github.com/JLimperg/aesop/blob/55c0d71da597d540b51703afc13f488503ac2885/Aesop/Config.lean#L542</a></p>



<a name="263283517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263283517" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263283517">(Dec 01 2021 at 12:44)</a>:</h4>
<p>What's the reason for holding on to the <code>impl</code> after passing it to <code>registerBuiltinAttribute</code>?</p>



<a name="263284352"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263284352" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263284352">(Dec 01 2021 at 12:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive/near/263282599">said</a>:</p>
<blockquote>
<p>In fact, I think we rarely want a simple <code>PersistentEnvExtension</code> that just tracks applications of the attribute. Usually the actual data store is somewhat derived from this</p>
</blockquote>
<p>One way we can do this with <code>ParametricAttribute</code> is to let the <code>getParam</code> function compute the data we want to store, right?</p>



<a name="263284673"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263284673" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263284673">(Dec 01 2021 at 12:54)</a>:</h4>
<p>That assumes that what we want to build is a <code>NameMap A</code> for some <code>A</code>, where the key is the name of the definition we are putting the attribute on. Sometimes we want that, other times the key is not this definition but one of the parameters of the attribute or something else altogether, or perhaps it's not a <code>NameMap</code> at all but rather a discrimination tree or other data structure</p>



<a name="263284731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263284731" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263284731">(Dec 01 2021 at 12:54)</a>:</h4>
<p>Ok, that's fair.</p>



<a name="263284784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263284784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263284784">(Dec 01 2021 at 12:55)</a>:</h4>
<p>In this case, we also don't want to build two <code>NameMap</code>s, one for the <code>toAdditive</code> lemmas and one for <code>toAdditive!</code></p>



<a name="263284899"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263284899" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263284899">(Dec 01 2021 at 12:56)</a>:</h4>
<p>So shall I make a variant of <code>ParametricAttribute</code> that</p>
<ul>
<li>has a list/array of attribute names instead of 1 (e.g. <code>toAdditive</code> and <code>toAdditive!</code>; it will declare <code>BuiltinAttribute</code>s for each of them</li>
<li>It has a custom type of what data it stores (generalizing <code>NameMap α</code> from <code>ParametricAttribute</code>). This data is "shared" among the different names of the attribute</li>
</ul>



<a name="263284906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263284906" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263284906">(Dec 01 2021 at 12:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive/near/263283517">said</a>:</p>
<blockquote>
<p>What's the reason for holding on to the <code>impl</code> after passing it to <code>registerBuiltinAttribute</code>?</p>
</blockquote>
<p>Not sure there is one now that I look at it.</p>



<a name="263284998"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263284998" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263284998">(Dec 01 2021 at 12:57)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> Is <code>PersistentEnvExtension</code> sufficient, or too general for you?</p>



<a name="263285087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263285087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263285087">(Dec 01 2021 at 12:57)</a>:</h4>
<p>basically, I'm suggesting that you adapt the code of <code>registerParametricAttribute</code> instead of calling it directly</p>



<a name="263285240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263285240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263285240">(Dec 01 2021 at 12:59)</a>:</h4>
<p>I could  work with that directly. But I expect that we will have multiple similar uses (for other attributes), and I thought a less general interface could be helpful.</p>



<a name="263285293"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263285293" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263285293">(Dec 01 2021 at 12:59)</a>:</h4>
<p>you are probably right, but it might be helpful to have 1 or 2 examples first</p>



<a name="263285308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263285308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263285308">(Dec 01 2021 at 12:59)</a>:</h4>
<p>sounds reasonable</p>



<a name="263293125"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263293125" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263293125">(Dec 01 2021 at 13:55)</a>:</h4>
<p>Am I correct that this function does not exist yet?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="sd">/-- Parse a string. -/</span>
<span class="kd">def</span> <span class="n">toString</span><span class="bp">!</span> <span class="o">:</span> <span class="n">Syntax</span> <span class="bp">→</span> <span class="n">String</span>
<span class="bp">|</span> <span class="n">node</span> <span class="n">_</span> <span class="n">strLitKind</span> <span class="n">stxs</span> <span class="bp">=&gt;</span> <span class="n">stxs</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="bp">.</span><span class="n">getAtomVal</span><span class="bp">!</span>
<span class="bp">|</span> <span class="n">stx</span> <span class="bp">=&gt;</span> <span class="n">panic</span><span class="bp">!</span><span class="s2">"String expected"</span>
</code></pre></div>



<a name="263293631"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263293631" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263293631">(Dec 01 2021 at 13:58)</a>:</h4>
<p>I don't think that is correct, since the stored atom includes the quotation marks</p>



<a name="263293679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263293679" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263293679">(Dec 01 2021 at 13:59)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#eval</span> <span class="k">show</span> <span class="n">TermElabM</span> <span class="n">_</span> <span class="k">from</span> <span class="k">do</span> <span class="n">toString</span><span class="bp">!</span> <span class="o">(</span><span class="bp">←</span> <span class="bp">`</span><span class="o">(</span><span class="s2">"foo"</span><span class="o">))</span>
<span class="c1">-- "\"foo\""</span>
</code></pre></div>



<a name="263294011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263294011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263294011">(Dec 01 2021 at 14:00)</a>:</h4>
<p>There is <code>Syntax.isStrLit?</code>.</p>



<a name="263298042"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263298042" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263298042">(Dec 01 2021 at 14:27)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> in my PR you mentioned to use <code>forallTelescope</code>. Am I correct that I need to be in <code>MetaM</code> to do that? I believe that means I cannot execute this during <code>AttributeImpl.add</code> (which is in <code>AttrM</code> a.k.a. <code>CoreM</code>)</p>



<a name="263298190"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263298190" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263298190">(Dec 01 2021 at 14:28)</a>:</h4>
<p>Yes, <code>forallTelescope</code> is in Meta.  You can use <code>MetaM.run'</code> to call a MetaM function in CoreM.</p>



<a name="263298401"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263298401" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263298401">(Dec 01 2021 at 14:30)</a>:</h4>
<p>Thanks!</p>



<a name="263316383"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263316383" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263316383">(Dec 01 2021 at 16:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="111080">Floris van Doorn</span> <a href="#narrow/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive/near/263278328">said</a>:</p>
<blockquote>
<ul>
<li>Suppose I have two syntax declarations </li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">bar</span><span class="o">)</span> <span class="s2">"bar"</span> <span class="n">num</span><span class="bp">*</span> <span class="o">:</span> <span class="n">attr</span>
<span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">bar</span><span class="bp">!</span><span class="o">)</span> <span class="s2">"bar!"</span> <span class="n">num</span><span class="bp">*</span> <span class="o">:</span> <span class="n">attr</span>
</code></pre></div>
<p>(this is in the <code>Mathport.Syntax</code> file for e.g. <code>toAdditive</code>). How do I make a single attribute that is triggered on both these parses? </p>
</blockquote>
<p>Does this not work?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">bar</span><span class="o">)</span> <span class="o">(</span><span class="s2">"bar"</span> <span class="bp">&lt;|&gt;</span> <span class="s2">"bar!"</span><span class="o">)</span> <span class="n">num</span><span class="bp">*</span> <span class="o">:</span> <span class="n">attr</span>
</code></pre></div>



<a name="263316676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263316676" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263316676">(Dec 01 2021 at 16:27)</a>:</h4>
<p>Or, if you want to discriminate between them:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="n">bar</span> <span class="o">:=</span> <span class="s2">"bar"</span> <span class="n">num</span><span class="bp">*</span>
<span class="n">syntax</span> <span class="n">bar</span><span class="bp">!</span> <span class="o">:=</span>  <span class="s2">"bar!"</span> <span class="n">num</span><span class="bp">*</span>
<span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">barAttr</span><span class="o">)</span> <span class="o">(</span><span class="n">bar</span> <span class="bp">&lt;|&gt;</span> <span class="n">bar</span><span class="bp">!</span><span class="o">)</span> <span class="o">:</span> <span class="n">attr</span>
</code></pre></div>



<a name="263317585"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263317585" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263317585">(Dec 01 2021 at 16:33)</a>:</h4>
<p>Oh, that does seem to work as well.</p>



<a name="263318877"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263318877" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263318877">(Dec 01 2021 at 16:40)</a>:</h4>
<p>Another question about auxiliary definitions (needed for <code>toAdditive</code>).<br>
In Lean 3, a <code>def</code> or <code>lemma</code> <code>foo</code> could generate a couple of automatically generated declarations. On the top of my head we have the following, but there are probably more.</p>
<ul>
<li><code>foo._proof_i</code> and <code>foo._match_i</code> which occur in the value of <code>foo</code>.</li>
<li><code>foo.eqn_i</code> for the equations generated by <code>foo</code>.</li>
</ul>
<p>What is the status in Lean 4? I already see <code>foo._cstagei</code>, <code>foo._sunfold</code>, <code>foo._unsafe_rec</code>, <code>foo.match_i</code>. Are there methods of getting some/all auxiliary declarations for <code>foo</code> (something like <a href="https://leanprover-community.github.io/mathlib_docs/find/tactic.get_eqn_lemmas_for">docs#tactic.get_eqn_lemmas_for</a>)?</p>



<a name="263320043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263320043" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263320043">(Dec 01 2021 at 16:48)</a>:</h4>
<p>I don't know enough about how to <code>to_additive</code> works in Lean 3 to know if this is reasonable, but is there any reason you just can't do the transformation on the ~syntax<code> rather than the elaborated </code>Expr`? That way you don't have to worry about the assorted of auxiliary definitions the elaborator may generate (which I don't think is actually bounded in Lean 4).</p>



<a name="263322747"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263322747" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263322747">(Dec 01 2021 at 17:04)</a>:</h4>
<p>Getting all the features of <code>toAdditive</code> on Syntax might be hard. For example, <code>toAdditive</code> checks for each occurrence of a declaration whether it is applied to <code>Nat</code> (or some other fixed type), and if so, don't change that occurrence. This information is usually implicit in the user input.</p>



<a name="263323319"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263323319" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263323319">(Dec 01 2021 at 17:09)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> You could have the elaborator repeat <em>some</em> of the work without starting at <code>Syntax</code>, e.g. using <code>Lean.Elab.addPreDefinitions</code>. It takes a list of (mutually recursive) <code>PreDefinition</code>s and generates the final definition and these helper defs from them.</p>



<a name="263325882"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263325882" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263325882">(Dec 01 2021 at 17:26)</a>:</h4>
<p><span class="user-mention" data-user-id="315577">@Mac</span> I think using <code>syntax (name := bar) ("bar" &lt;|&gt; "bar!") num* : attr</code> leads to poor indexing of the syntax, since it doesn't start with a constant. If you have a lot of these then they all end up in a grab bag at the end</p>



<a name="263326109"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263326109" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263326109">(Dec 01 2021 at 17:28)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> yeah, hence my second example.</p>



<a name="263326172"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263326172" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263326172">(Dec 01 2021 at 17:28)</a>:</h4>
<p>that still has the same problem though, for <code>barAttr</code></p>



<a name="263326202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263326202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263326202">(Dec 01 2021 at 17:28)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> how so?</p>



<a name="263326243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263326243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263326243">(Dec 01 2021 at 17:29)</a>:</h4>
<p><code>barAttr</code> doesn't start with a constant, so it can't be indexed like one</p>



<a name="263326245"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263326245" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263326245">(Dec 01 2021 at 17:29)</a>:</h4>
<p>the <code>firstTokens</code> system does account for nested parsers.</p>



<a name="263326281"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263326281" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263326281">(Dec 01 2021 at 17:29)</a>:</h4>
<p>it doesn't require the start to literally be a token</p>



<a name="263326627"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263326627" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263326627">(Dec 01 2021 at 17:31)</a>:</h4>
<p>The problem with <code>("bar" &lt;|&gt; "bar!") num* </code> is not that it won't be indexed properly (it will still have as its <code>firstTokens</code> <code>bar</code> and <code>bar!</code> and be indexed accordingly). The problem is that you will no be easily able to distinguish between <code>bar</code> and <code>bar!</code> syntaxes (as they do not have separate node kinds).</p>



<a name="263326740"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263326740" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263326740">(Dec 01 2021 at 17:32)</a>:</h4>
<p>At least, that is my understanding.</p>



<a name="263327179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263327179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263327179">(Dec 01 2021 at 17:35)</a>:</h4>
<p>That's not necessarily a problem; in this case we actually want them to have the same node kind since they are morally the same tactic/attr</p>



<a name="263327299"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263327299" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263327299">(Dec 01 2021 at 17:36)</a>:</h4>
<p>for example, that would allow us to have only one <code>@[elab]</code> for the corresponding tactic, or only one name for the attr</p>



<a name="263327503"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263327503" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263327503">(Dec 01 2021 at 17:36)</a>:</h4>
<p>(This is all working around the fact that <code>"bar" "!"?</code> doesn't work)</p>



<a name="263327902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263327902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263327902">(Dec 01 2021 at 17:38)</a>:</h4>
<p>What's the block to using noWs between "bar" and "!"?</p>



<a name="263328317"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263328317" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263328317">(Dec 01 2021 at 17:41)</a>:</h4>
<p>I would put the keywords only in syntax defs:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="n">bar</span> <span class="o">:=</span> <span class="s2">"bar"</span>
<span class="n">syntax</span> <span class="n">bar</span><span class="bp">!</span> <span class="o">:=</span>  <span class="s2">"bar!"</span>
<span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">barAttr</span><span class="o">)</span> <span class="o">(</span><span class="n">bar</span> <span class="bp">&lt;|&gt;</span> <span class="n">bar</span><span class="bp">!</span><span class="o">)</span> <span class="n">num</span><span class="bp">*</span> <span class="o">:</span> <span class="n">attr</span>
</code></pre></div>
<p>That way semantically different tactic invocations are structurally syntactically different and thus work with pattern matching</p>



<a name="263328478"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263328478" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263328478">(Dec 01 2021 at 17:42)</a>:</h4>
<p><span class="user-mention" data-user-id="308899">@Yakov Pechersky</span> The issue is that <code>!</code> is an identifier char so <code>bar!</code> always gets lexed as an identifier</p>



<a name="263328676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263328676" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263328676">(Dec 01 2021 at 17:44)</a>:</h4>
<p>Maybe a different character then to differentiate simps from simps with reporting of output lemmas?</p>



<a name="263329387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263329387" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263329387">(Dec 01 2021 at 17:48)</a>:</h4>
<p>this issue comes up <em>a lot</em> in mathlib tactics. It's a popular character for tactic modifiers and there aren't any good replacements</p>



<a name="263329780"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263329780" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263329780">(Dec 01 2021 at 17:52)</a>:</h4>
<p>I'd rather investigate why it got turned into an identifier character in the first place but I don't want to burn social capital in the process, so I'm sticking with workarounds for now</p>



<a name="263330100"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263330100" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263330100">(Dec 01 2021 at 17:54)</a>:</h4>
<p>Innocent newbie question: does this also mean that we can't use <code>n!</code> notation for factorials?</p>



<a name="263330111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263330111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263330111">(Dec 01 2021 at 17:54)</a>:</h4>
<p>yes</p>



<a name="263330155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263330155" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263330155">(Dec 01 2021 at 17:54)</a>:</h4>
<p>we'll need to pull out an inverted turkish dotted I or something</p>



<a name="263330231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263330231" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263330231">(Dec 01 2021 at 17:55)</a>:</h4>
<p>or use <code>n !</code> or <code>(n)!</code></p>



<a name="263330993"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263330993" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263330993">(Dec 01 2021 at 18:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive/near/263329780">said</a>:</p>
<blockquote>
<p>I'd rather investigate why it got turned into an identifier character in the first place but I don't want to burn social capital in the process, so I'm sticking with workarounds for now</p>
</blockquote>
<p>The short answer: <code>Array.get!</code>/<code>Array.get?</code>/<code>Array.get</code> etc.. I'm afraid it's a very useful convention for programming.</p>



<a name="263331513"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263331513" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263331513">(Dec 01 2021 at 18:04)</a>:</h4>
<p>Those are good examples, but I would still be inclined toward a convention like <code>getE</code>/<code>getO</code>/<code>getD</code>/<code>get</code> for that, considering the tradeoff</p>



<a name="263332013"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263332013" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263332013">(Dec 01 2021 at 18:07)</a>:</h4>
<p>There definitely was some amount of regret when we figured out this would prevent <code>syntax "foo" ident?</code>. But it's also really hard to imagine giving it up at this point.</p>



<a name="263332642"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263332642" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263332642">(Dec 01 2021 at 18:11)</a>:</h4>
<p>Is there no way to combine the two use cases using some clever macros or such?</p>



<a name="263333562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263333562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263333562">(Dec 01 2021 at 18:17)</a>:</h4>
<p>It would definitely be possible to e.g. turn off parsing <code>?</code> as part of the ident in <code>syntax</code>, I'm relatively sure we will do that at some point. For <code>bar!</code> custom parsing would be a bit more problematic because of the mentioned indexing, i.e. the token is parsed before this specific parser is even run. And for factorials... you <em>could</em> write a custom <code>ident</code> elaborator that tries to resolve the name including the <code>!</code> or else interpret it as a factorial application right now (edit: ah, hygiene might be a problem here though).</p>



<a name="263366837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263366837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263366837">(Dec 01 2021 at 22:27)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Would it be possible to flip this idea on its head and remove <code>!</code>/<code>?</code> from the ident <em>token</em> and just make a composite ident plus punctuation syntax that expands to identifier with the symbol at the end? That is something like:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean.Syntax</span>

<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Syntax</span>

<span class="n">syntax</span> <span class="n">ident'</span> <span class="o">:=</span> <span class="n">ident</span> <span class="n">noWs</span> <span class="o">(</span><span class="s2">"!"</span> <span class="bp">&lt;|&gt;</span> <span class="s2">"?"</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">expandIdent'</span> <span class="o">(</span><span class="n">stx</span> <span class="o">:</span> <span class="n">Syntax</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">mkIdentFrom</span> <span class="n">stx</span> <span class="bp">&lt;|</span> <span class="n">stx</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="bp">.</span><span class="n">getId.appendAfter</span> <span class="n">stx</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="bp">.</span><span class="n">getAtomVal</span><span class="bp">!</span>

<span class="n">macro</span><span class="o">:</span><span class="n">max</span> <span class="n">id</span><span class="o">:</span><span class="n">ident'</span> <span class="o">:</span> <span class="n">term</span> <span class="bp">=&gt;</span> <span class="n">expandIdent'</span> <span class="n">id</span>

<span class="k">#check</span> <span class="bp">«</span><span class="n">foo</span><span class="bp">»!</span> <span class="c1">-- unknown identifier 'foo!'</span>
</code></pre></div>



<a name="263367190"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263367190" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263367190">(Dec 01 2021 at 22:31)</a>:</h4>
<p>This would allow for the <code>!</code>/<code>?</code> to be used as identifiers in standard programming context (as is currently convenient) while making it easier to do something different in DSLs.</p>



<a name="263462534"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263462534" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263462534">(Dec 02 2021 at 16:21)</a>:</h4>
<p><span class="user-mention" data-user-id="315577">@Mac</span> Same issue as with the flipped idea: it will fail in macros because hygiene doesn't like ident manipulation</p>



<a name="263466866"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263466866" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263466866">(Dec 02 2021 at 16:51)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> isn't there <code>modifyBase</code>  and other such methods to modify identifier names in a hygiene-preserving manner? Or I am misunderstanding how those work?</p>



<a name="263467106"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/263467106" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#263467106">(Dec 02 2021 at 16:52)</a>:</h4>
<p>(deleted <code>modifyBase</code> example -- <code>appendAfter</code> apparently already uses <code>modifyBase</code>)</p>



<a name="264290309"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264290309" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264290309">(Dec 09 2021 at 11:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive/near/263323319">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="111080">Floris van Doorn</span> You could have the elaborator repeat <em>some</em> of the work without starting at <code>Syntax</code>, e.g. using <code>Lean.Elab.addPreDefinitions</code>. It takes a list of (mutually recursive) <code>PreDefinition</code>s and generates the final definition and these helper defs from them.</p>
</blockquote>
<p>Thank you for this suggestion <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span>! That is very useful.</p>
<p>So just checking that I understand this: If I add the <code>@[toAdditive]</code> attribute to a definition, theorem or opaque decl (is that <code>constant</code>?) then I'll use that <code>Declaration</code> to compute a new <code>PreDefinition</code>, and then use <code>Lean.Elab.addPreDefinitions</code> to add this declaration to the environment.</p>
<p>Some questions:</p>
<ul>
<li>Do I just flatten out all the sub-definitions (like <code>foo._cstagei</code>) in the <code>value</code>, and then <code>addPreDefinitions</code> will add them in for the new declaration? Or should I do what we did in Lean 3: first additivize the sub-definitions and then finally process <code>foo</code>?</li>
<li>Is all the <code>Modifiers</code> information of a <code>PreDefinition</code> still obtainable from the environment when executing the attribute code? For example, can I check whether a declaration is computable?</li>
<li>Is the corresponding commands for inductives/structures  <code>Lean.Elab.Command.elabInductiveViews</code> and <code>Lean.Elab.Command.elabStructure</code>?</li>
</ul>



<a name="264295682"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264295682" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264295682">(Dec 09 2021 at 12:51)</a>:</h4>
<blockquote>
<p>opaque decl (is that constant?)</p>
</blockquote>
<p>Yes.</p>
<blockquote>
<p>Do I just flatten out all the sub-definitions (like foo._cstagei) in the value</p>
</blockquote>
<p><code>_cstage</code> should not occur in <code>value</code>, but for recursive definitions going back to the <code>PreDefinition.value</code> might be a bit problematic now that I think about it. If it was possible to access the pre-definitions in the attribute hook, that might yield a more feasible solution, but it is not, currently.</p>



<a name="264296681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264296681" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264296681">(Dec 09 2021 at 12:59)</a>:</h4>
<p>The other alternative I can see is to do the translation syntactically after all, but with type information taking from the info tree... which is not currently enabled outside of the server, but that might change soon</p>



<a name="264297353"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264297353" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264297353">(Dec 09 2021 at 13:05)</a>:</h4>
<p>I see. I indeed also see that <code>_cstage</code> does not occur in the value.<br>
It would indeed be nice if the predefinition value is still obtainable somehow.<br>
I could indeed also try to do the translation on the syntax: the main functionality still works without any type information/information about implicit arguments.</p>



<a name="264300942"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264300942" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264300942">(Dec 09 2021 at 13:32)</a>:</h4>
<p>Note that the <code>_cstage</code> are not even valid Lean terms but compiler IRs at various stages of type erasure... it might be possible to translate them as well, but personally I would try to avoid that</p>



<a name="264302591"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264302591" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264302591">(Dec 09 2021 at 13:45)</a>:</h4>
<p>I see. It seems like the main options are:<br>
(1) From a declaration, make a predefinition and translate that (disadvantage: predefinition value might be different than the declaration value)<br>
(2) From the syntax, build the additive syntax (disadvantage: no information about implicit arguments when translating)<br>
(3) Wait until there is better support for either (1) or (2).</p>
<p>Is the problem with (1) <em>only</em> with recursive (or unsafe) definitions? If the predefinition value and the declaration value is the same for all safe nonrecursive definitions, then I think I'll go with (1). Almost all definitions involving <code>toAdditive</code> are not recursive.</p>



<a name="264305742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264305742" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264305742">(Dec 09 2021 at 14:07)</a>:</h4>
<p>Yes, I believe so - <a href="https://github.com/leanprover/lean4/blob/265c18accd055c59e00afa837ab3469141b5ebd9/src/Lean/Elab/PreDefinition/Basic.lean#L99">https://github.com/leanprover/lean4/blob/265c18accd055c59e00afa837ab3469141b5ebd9/src/Lean/Elab/PreDefinition/Basic.lean#L99</a></p>



<a name="264309105"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264309105" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264309105">(Dec 09 2021 at 14:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive/near/263466866">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> isn't there <code>modifyBase</code>  and other such methods to modify identifier names in a hygiene-preserving manner? Or I am misunderstanding how those work?</p>
</blockquote>
<p>References to global declarations are detected at macro <em>declaration time</em> (when the syntax quotation is processed), since hygiene says that the macro's definition site, not its use site should provide the scope. When the macro runs, the information is already lost.</p>



<a name="264317060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264317060" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264317060">(Dec 09 2021 at 15:28)</a>:</h4>
<p>Am I correct that the Environment doesn't store whether a definition <code>foo</code> is computable? Is a semireliable way to check this by looking at whether <code>foo._cstage1</code> exists?</p>



<a name="264322395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264322395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264322395">(Dec 09 2021 at 16:03)</a>:</h4>
<p>That sounds like a quite reliable method to me :)</p>



<a name="264326313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264326313" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264326313">(Dec 09 2021 at 16:27)</a>:</h4>
<p>Am I correct that Lean 4 does not have variants of <a href="https://leanprover-community.github.io/mathlib_docs/find/expr.replace/src">src#expr.replace</a> and <a href="https://leanprover-community.github.io/mathlib_docs/find/expr.fold/src">src#expr.fold</a> yet? Is <code>Lean.Expr.foldConsts</code> a good implementation to mimic if I want to define similar functions on <code>Expr</code> (in such a way that they only visit each subexpression once)?</p>



<a name="264326531"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264326531" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264326531">(Dec 09 2021 at 16:28)</a>:</h4>
<p>There is an <code>Expr.replace</code> function.</p>



<a name="264326693"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264326693" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264326693">(Dec 09 2021 at 16:29)</a>:</h4>
<p>Oh thanks! I missed that before.</p>



<a name="264371603"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/porting%20simps%20and%20to_additive/near/264371603" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/porting.20simps.20and.20to_additive.html#264371603">(Dec 09 2021 at 21:48)</a>:</h4>
<p><span class="user-mention" data-user-id="111080">@Floris van Doorn</span> We also have <a href="https://github.com/leanprover/lean4/blob/master/src/Lean/Meta/Transform.lean">https://github.com/leanprover/lean4/blob/master/src/Lean/Meta/Transform.lean</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>