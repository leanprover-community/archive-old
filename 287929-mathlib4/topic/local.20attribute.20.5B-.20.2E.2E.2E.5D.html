---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html">local attribute [- ...]</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="319128813"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319128813" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319128813">(Jan 03 2023 at 05:11)</a>:</h4>
<p>Is there a way of spelling <code>local attribute [-...]</code> in Lean 4?  I used to be able to do</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic.norm_num</span>

<span class="kn">local</span> <span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="n">norm_num</span><span class="o">]</span> <span class="n">norm_num.eval_nat_int_ext</span>
</code></pre></div>
<p>to disable a <code>norm_num</code> extension, this doesn't seem to work in mathlib 4 or maybe I have the wrong syntax?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Tactic.NormNum.Basic</span>

<span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="n">norm_num</span><span class="o">]</span> <span class="n">Mathlib.Meta.NormNum.evalPow</span>
<span class="c1">-- attribute cannot be erased</span>
</code></pre></div>



<a name="319128827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319128827" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319128827">(Jan 03 2023 at 05:11)</a>:</h4>
<p>That one's for teaching, but there are also a number of uses of <code>local attribute [-instance]</code> in mathlib.</p>



<a name="319129569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319129569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319129569">(Jan 03 2023 at 05:24)</a>:</h4>
<p>This seems to be spelled <code>attribute [-foo]</code> now; erasing is only supported locally so there is no syntax like <code>attribute [local -foo]</code></p>



<a name="319129673"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319129673" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319129673">(Jan 03 2023 at 05:25)</a>:</h4>
<p>the reason it doesn't work for <code>norm_num</code> is because attributes have to explicitly opt-in to being erased and you have to write some extra code to support it. Most mathlib4 tactics don't support erasing right now</p>



<a name="319129970"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319129970" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319129970">(Jan 03 2023 at 05:29)</a>:</h4>
<p>Ah great.  Indeed instance erasing works just fine (I guess the fact that it was <code>local</code> automatically is what I hadn't realised):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Data.Int.Order.Basic</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">a</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">}</span> <span class="o">{</span><span class="n">b</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">}</span> <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">&lt;</span> <span class="n">b</span> <span class="bp">↔</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">&lt;</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">b</span> <span class="o">:=</span>
  <span class="n">mul_self_lt_mul_self_iff</span> <span class="n">h1</span> <span class="n">h2</span> <span class="c1">-- works</span>

<span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="kd">instance</span><span class="o">]</span> <span class="n">Int.linearOrderedCommRing</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">a</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">}</span> <span class="o">{</span><span class="n">b</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">}</span> <span class="o">(</span><span class="n">h1</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">&lt;</span> <span class="n">b</span> <span class="bp">↔</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">&lt;</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">b</span> <span class="o">:=</span>
  <span class="n">mul_self_lt_mul_self_iff</span> <span class="n">h1</span> <span class="n">h2</span> <span class="c1">-- fails</span>
</code></pre></div>



<a name="319130076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319130076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319130076">(Jan 03 2023 at 05:30)</a>:</h4>
<p>How hard would it be to make <code>norm_num</code> erasable?  Is there any similar example already implemented that could serve as a model?</p>



<a name="319130141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319130141" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319130141">(Jan 03 2023 at 05:31)</a>:</h4>
<p>Do you mind if I add this as an issue?  (If there's no reason in principle why it couldn't be done?)</p>



<a name="319134938"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319134938" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319134938">(Jan 03 2023 at 06:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="260507">Heather Macbeth</span> <a href="#narrow/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D/near/319130141">said</a>:</p>
<blockquote>
<p>Do you mind if I add this as an issue?  (If there's no reason in principle why it couldn't be done?)</p>
</blockquote>
<p>Yes please, there is no fundamental issue with implementation. A similar example might be <code>simp</code>: you keep a map for erased norm_num extensions in addition to the regular map, and if the regular map produces a result, we first check the erased map to make sure the extension has not been erased, and if it is we skip it</p>



<a name="319145118"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319145118" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319145118">(Jan 03 2023 at 08:21)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1308">mathlib4#1308</a>, feel free to make any corrections.</p>



<a name="319705152"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319705152" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319705152">(Jan 06 2023 at 01:37)</a>:</h4>
<p><span class="user-mention" data-user-id="504487">@Sarah Smith</span> reached out to me about trying this—I'm going to give it a shot, if that's alright :) I'll open a branch + PR for it and start committing!</p>



<a name="319726206"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319726206" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319726206">(Jan 06 2023 at 06:43)</a>:</h4>
<p>If anyone has some good simple examples of <code>norm_num</code> erasure (cases where something can't be proved when something is erased) for the test file, they're welcome here :)</p>



<a name="319726448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319726448" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319726448">(Jan 06 2023 at 06:46)</a>:</h4>
<p>Also, for anyone familiar with the existing code: is there a reason we don't keep track of the <code>Entry</code> list when we use <code>addImportedFn</code>? Currently it returns <code>pure ⟨[], dt⟩</code>.</p>
<p>I'm a little unsure of when we actually use the list of <code>Entry</code>s, to be honest...</p>



<a name="319726545"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319726545" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319726545">(Jan 06 2023 at 06:47)</a>:</h4>
<p>Here's one:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="mi">3</span> <span class="bp">^</span> <span class="mi">3</span> <span class="bp">+</span> <span class="mi">4</span> <span class="bp">=</span> <span class="mi">31</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">norm_num1</span>
  <span class="n">with_reducible</span> <span class="n">rfl</span>
</code></pre></div>
<p>fails if you put it before the <code>evalPow</code> extension, succeds if you put it after.</p>



<a name="319726615"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319726615" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319726615">(Jan 06 2023 at 06:48)</a>:</h4>
<p>So you'd like it to fail if you disable the <code>evalPow</code> extension.</p>



<a name="319728174"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319728174" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319728174">(Jan 06 2023 at 07:06)</a>:</h4>
<p>It works! :) Up to the above details about the <code>Entry</code> list.</p>



<a name="319728280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319728280" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319728280">(Jan 06 2023 at 07:07)</a>:</h4>
<p>Is there a way to restore an attribute after erasing it? I would have expected</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">attribute</span> <span class="o">[</span><span class="n">norm_num</span><span class="o">]</span> <span class="n">Mathlib.Meta.NormNum.evalPow</span>
</code></pre></div>
<p>but that doesn't work.</p>



<a name="319728567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319728567" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319728567">(Jan 06 2023 at 07:10)</a>:</h4>
<p>Can you mark the erasure with</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="n">norm_num</span><span class="o">]</span> <span class="k">in</span>
<span class="kd">lemma</span> <span class="bp">....</span>
</code></pre></div>
<p>to make it local to that lemma?</p>



<a name="319728610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319728610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319728610">(Jan 06 2023 at 07:10)</a>:</h4>
<p>Or enclose the erasure in <code>section</code>/<code>end</code>?</p>



<a name="319728853"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319728853" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319728853">(Jan 06 2023 at 07:12)</a>:</h4>
<p>Hmmm...I would have expected both of those to work, but neither of them do.</p>



<a name="319728921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319728921" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319728921">(Jan 06 2023 at 07:13)</a>:</h4>
<p>Interestingly it doesn't complain about <code>attribute [-norm_num] ... in</code>, but nonetheless it doesn't work as expected. I wonder if that's something I can fix inside <code>norm_num</code> or if it has to do with how <code>[-_]</code> is elaborated...</p>



<a name="319729324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319729324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319729324">(Jan 06 2023 at 07:18)</a>:</h4>
<p>I have no idea, hopefully an expert will comment.</p>



<a name="319732835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319732835" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319732835">(Jan 06 2023 at 07:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="548935">Thomas Murrills</span> <a href="#narrow/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D/near/319726448">said</a>:</p>
<blockquote>
<p>Also, for anyone familiar with the existing code: is there a reason we don't keep track of the <code>Entry</code> list when we use <code>addImportedFn</code>? Currently it returns <code>pure ⟨[], dt⟩</code>.</p>
<p>I'm a little unsure of when we actually use the list of <code>Entry</code>s, to be honest...</p>
</blockquote>
<p><code>addImportedFn</code> is responsible for setting up the initial state of the attribute after importing upstream modules (i.e. just after all the <code>import</code> lines). The first component of the pair is the list of entries defined in the current file, so it starts out empty. The list component is pushed to in <code>addEntryFn</code>, which is called when a new entry is added in the current file, and the list of entries is serialized into an array for future <code>import</code>s in <code>exportEntriesFn</code></p>



<a name="319733169"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319733169" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319733169">(Jan 06 2023 at 07:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="548935">Thomas Murrills</span> <a href="#narrow/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D/near/319728280">said</a>:</p>
<blockquote>
<p>Is there a way to restore an attribute after erasing it? I would have expected</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">attribute</span> <span class="o">[</span><span class="n">norm_num</span><span class="o">]</span> <span class="n">Mathlib.Meta.NormNum.evalPow</span>
</code></pre></div>
<p>but that doesn't work.</p>
</blockquote>
<p>No, the only way to restore an erased attribute is to do it in a section and pop the scope</p>



<a name="319735266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319735266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319735266">(Jan 06 2023 at 08:15)</a>:</h4>
<p>Gotcha, makes sense!</p>



<a name="319735371"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319735371" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319735371">(Jan 06 2023 at 08:16)</a>:</h4>
<p>BTW is "erased" the official word for this? It has an unrelated, more common meaning in theorem proving/programming...</p>



<a name="319735724"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319735724" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319735724">(Jan 06 2023 at 08:19)</a>:</h4>
<p>I need a way to check if a name has <code>[norm_num]</code>, though. I can't simply check if it's <code>NormNumExt</code>, because that doesn't account for already-erased attributes. The three options I can see are</p>
<ol>
<li>get all <code>NormNumExt</code> nodes of the <code>DiscrTree</code> (yikes?)</li>
<li>add a field to the state that keeps track of active <code>norm_nums</code></li>
<li>check if the name is<code>NormNumExt</code> by looking at the environment and check if not already <code>erased</code></li>
</ol>
<p>Which of these is best (or should I do something else)?</p>



<a name="319735885"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319735885" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319735885">(Jan 06 2023 at 08:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D/near/319735371">said</a>:</p>
<blockquote>
<p>BTW is "erased" the official word for this? It has an unrelated, more common meaning in theorem proving/programming...</p>
</blockquote>
<p>Yep: <code>-</code> in e.g. <code>[-norm_num]</code> is secretly an <code>eraseAttr</code> syntax node, and the functionality for erasing an attribute is given by including the field <code>erase</code> when registering it :)</p>



<a name="319738366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738366" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738366">(Jan 06 2023 at 08:42)</a>:</h4>
<p>I'm okay with saying that the usage of the word "erase" in this context is dev-only though</p>



<a name="319738430"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738430" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738430">(Jan 06 2023 at 08:43)</a>:</h4>
<p>not that I have a better naming suggestion</p>



<a name="319738580"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738580" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738580">(Jan 06 2023 at 08:44)</a>:</h4>
<p><span class="user-mention" data-user-id="548935">@Thomas Murrills</span> in what context do you need to know if a name is <code>@[norm_num]</code> tagged?</p>



<a name="319738612"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738612" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738612">(Jan 06 2023 at 08:44)</a>:</h4>
<p>In defining the function <code>erase</code></p>



<a name="319738636"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738636" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738636">(Jan 06 2023 at 08:44)</a>:</h4>
<p>to give an error message if it's not already tagged?</p>



<a name="319738644"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738644" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738644">(Jan 06 2023 at 08:44)</a>:</h4>
<p>It should throw an error if the name doesn't have <code>[norm_num]</code>, yeah</p>



<a name="319738684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738684" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738684">(Jan 06 2023 at 08:45)</a>:</h4>
<p>At least, patterning off existing <code>erase</code>s</p>



<a name="319738711"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738711" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738711">(Jan 06 2023 at 08:45)</a>:</h4>
<p>what does <code>simp</code> do?</p>



<a name="319738863"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738863" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738863">(Jan 06 2023 at 08:46)</a>:</h4>
<p><code>simp</code> carries around all of the lemma names it's using in the state, I think?</p>



<a name="319738893"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738893" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738893">(Jan 06 2023 at 08:46)</a>:</h4>
<p>My guess is that it has other reasons to do so, though</p>



<a name="319738937"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738937" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738937">(Jan 06 2023 at 08:47)</a>:</h4>
<p>oh I see, it's the <code>lemmaNames</code> field</p>



<a name="319738966"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738966" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738966">(Jan 06 2023 at 08:47)</a>:</h4>
<p>nope, it is used nowhere else</p>



<a name="319738974"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319738974" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319738974">(Jan 06 2023 at 08:47)</a>:</h4>
<p>except in a test</p>



<a name="319739161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319739161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319739161">(Jan 06 2023 at 08:49)</a>:</h4>
<p>oh! well how about that</p>



<a name="319739194"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319739194" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319739194">(Jan 06 2023 at 08:49)</a>:</h4>
<p>but would (3) work? it seems more lightweight</p>



<a name="319739215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319739215" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319739215">(Jan 06 2023 at 08:49)</a>:</h4>
<p>plus we need to access the environment in the course of giving the <code>erase</code> field anyway, so it's available</p>



<a name="319739558"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319739558" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319739558">(Jan 06 2023 at 08:51)</a>:</h4>
<p>being a <code>NormNumExt</code> is technically unrelated to being a norm num extension, you could always just define a random def with that type</p>



<a name="319739709"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319739709" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319739709">(Jan 06 2023 at 08:52)</a>:</h4>
<p>If you want to avoid the extra state I would prefer (1)</p>



<a name="319739772"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319739772" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319739772">(Jan 06 2023 at 08:53)</a>:</h4>
<p>if it's a rare operation then a linear time operation over the discr tree seems fine, there is a small finite number of norm num extensions anyway</p>



<a name="319740027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319740027" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319740027">(Jan 06 2023 at 08:54)</a>:</h4>
<p>Ok, nice; do you happen to know of a function to get all such nodes out of the <code>DiscrTree</code> or should I write it? I couldn't see it in <code>DiscrTree.lean</code>.</p>



<a name="319740433"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319740433" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319740433">(Jan 06 2023 at 08:57)</a>:</h4>
<p>(Also just to be clear the only reason I want to err on the side of avoiding the extra state is performance, which I don't have great intuition for—if it's fine to add to the state, that's probably easier, tbh.)</p>



<a name="319740692"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319740692" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319740692">(Jan 06 2023 at 08:59)</a>:</h4>
<p>Jannis had some DiscrTree operations in a PR to std I think</p>



<a name="319740999"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319740999" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319740999">(Jan 06 2023 at 09:01)</a>:</h4>
<p><a href="https://github.com/leanprover-community/std4/pull/56">std4#56</a></p>



<a name="319741071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319741071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319741071">(Jan 06 2023 at 09:01)</a>:</h4>
<p>you can steal the operations out of that and we can clean it up later</p>



<a name="319741555"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319741555" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319741555">(Jan 06 2023 at 09:05)</a>:</h4>
<p>sounds good! :) I'll leave a note.</p>



<a name="319869182"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319869182" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319869182">(Jan 06 2023 at 21:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D/near/319733169">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="548935">Thomas Murrills</span> <a href="#narrow/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D/near/319728280">said</a>:</p>
<blockquote>
<p>Is there a way to restore an attribute after erasing it? I would have expected</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">attribute</span> <span class="o">[</span><span class="n">norm_num</span><span class="o">]</span> <span class="n">Mathlib.Meta.NormNum.evalPow</span>
</code></pre></div>
<p>but that doesn't work.</p>
</blockquote>
<p>No, the only way to restore an erased attribute is to do it in a section and pop the scope</p>
</blockquote>
<p>How exactly do you spell the scope pop? I was expecting maybe</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">namespace</span> <span class="n">norm_num_erase</span>
<span class="n">scoped</span><span class="o">[</span><span class="n">norm_num_erase</span><span class="o">]</span> <span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="n">norm_num</span><span class="o">]</span> <span class="bp">...</span>
</code></pre></div>
<p>but that doesn't seem to be right.</p>



<a name="319886518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319886518" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319886518">(Jan 07 2023 at 00:32)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">section</span> <span class="n">stuff</span>
<span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="n">norm_num</span><span class="o">]</span> <span class="n">Mathlib.Meta.NormNum.evalPow</span>

<span class="bp">...</span>

<span class="kd">end</span> <span class="n">stuff</span>
<span class="c1">-- Mathlib.Meta.NormNum.evalPow is not erased</span>
</code></pre></div>



<a name="319886595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319886595" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319886595">(Jan 07 2023 at 00:33)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="n">norm_num</span><span class="o">]</span> <span class="n">Mathlib.Meta.NormNum.evalPow</span> <span class="k">in</span>
<span class="kd">example</span> <span class="o">:</span> <span class="n">bla</span> <span class="o">:=</span> <span class="bp">...</span>
</code></pre></div>
<p>should have the same effect, if you just want to erase the attribute in one declaration</p>



<a name="319888552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319888552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319888552">(Jan 07 2023 at 00:53)</a>:</h4>
<p>Those are what <span class="user-mention" data-user-id="260507">@Heather Macbeth</span> originally suggested, but neither work for some reason</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">section</span> <span class="n">stuff</span>
<span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="n">norm_num</span><span class="o">]</span> <span class="n">Mathlib.Meta.NormNum.evalPow</span>
<span class="kd">end</span> <span class="n">stuff</span>

<span class="kd">example</span> <span class="o">:</span> <span class="mi">3</span> <span class="bp">^</span> <span class="mi">3</span> <span class="bp">+</span> <span class="mi">4</span> <span class="bp">=</span> <span class="mi">31</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">norm_num1</span>
  <span class="n">guard_target</span> <span class="bp">=ₛ</span> <span class="mi">3</span> <span class="bp">^</span> <span class="mi">3</span> <span class="bp">+</span> <span class="mi">4</span> <span class="bp">=</span> <span class="mi">31</span> <span class="c1">-- no change; still erased</span>
  <span class="n">rfl</span>
</code></pre></div>



<a name="319888689"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319888689" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319888689">(Jan 07 2023 at 00:55)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">attribute</span> <span class="o">[</span><span class="bp">-</span><span class="n">norm_num</span><span class="o">]</span> <span class="n">Mathlib.Meta.NormNum.evalPow</span> <span class="k">in</span>
<span class="kd">example</span> <span class="o">:=</span> <span class="n">true</span>

<span class="kd">example</span> <span class="o">:</span> <span class="mi">3</span> <span class="bp">^</span> <span class="mi">3</span> <span class="bp">+</span> <span class="mi">4</span> <span class="bp">=</span> <span class="mi">31</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">norm_num1</span>
  <span class="n">guard_target</span> <span class="bp">=ₛ</span> <span class="mi">3</span> <span class="bp">^</span> <span class="mi">3</span> <span class="bp">+</span> <span class="mi">4</span> <span class="bp">=</span> <span class="mi">31</span> <span class="c1">-- no change; still erased</span>
  <span class="n">rfl</span>
</code></pre></div>



<a name="319891050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319891050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319891050">(Jan 07 2023 at 01:24)</a>:</h4>
<p>It could be an issue in how you implemented the erase function? That is how erasing attributes is supposed to work from the user side</p>



<a name="319892132"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319892132" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319892132">(Jan 07 2023 at 01:41)</a>:</h4>
<p>Maybe—I tried to pattern it pretty closely after existing ones, but I’ll poke around and see if I can figure it out.</p>



<a name="319892986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319892986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319892986">(Jan 07 2023 at 01:55)</a>:</h4>
<p>Update: really weird (to me): when I try to erase an imported <code>norm_num</code>, it works, but exhibits the above bad behavior. When i try to erase a <code>norm_num</code> extension defined in the same file, I get the error <code>attribute cannot be erased</code>—apparently <code>AttributeImpl.erase</code> is being called.</p>



<a name="319895390"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319895390" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319895390">(Jan 07 2023 at 02:30)</a>:</h4>
<p>My guess currently is that e.g. <code>simp</code> uses a <code>ScopedEnvExtension</code> whereas <code>norm_num</code> just uses a <code>PersistentEnvExtension</code>?</p>



<a name="319895420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319895420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319895420">(Jan 07 2023 at 02:31)</a>:</h4>
<p>A <code>ScopedEnvExtension</code> is just a <code>PersistentEnvExtension</code> with extra logic that has been inlined into the norm_num extension</p>



<a name="319895578"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319895578" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319895578">(Jan 07 2023 at 02:33)</a>:</h4>
<p>...Which I guess means that <code>erase</code> needs that extra logic to be inlined as well in order to work correctly? Or am I misinterpreting</p>



<a name="319895601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319895601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319895601">(Jan 07 2023 at 02:33)</a>:</h4>
<p>yes, most likely</p>



<a name="319895677"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319895677" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319895677">(Jan 07 2023 at 02:34)</a>:</h4>
<p>Ok, thanks, that's helpful...I think I know where to look now</p>



<a name="319904258"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319904258" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319904258">(Jan 07 2023 at 04:47)</a>:</h4>
<p>Hmm, I'm not totally sure the norm_num attribute <em>does</em> inline that extra logic yet. <code>ScopedEnvExtension</code> uses a <code>StateStack</code> which comes with <code>pushScope</code> and <code>popScope</code> functionality, but I don't see any circumlocutions for the state stack and scopes etc. in <code>norm_num</code>.</p>



<a name="319904262"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319904262" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319904262">(Jan 07 2023 at 04:47)</a>:</h4>
<p>Am I correct in thinking that it's these functions which are responsible for managing the relevant scopes when e.g. <code>section</code>/<code>end</code> occurs?</p>



<a name="319904281"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319904281" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319904281">(Jan 07 2023 at 04:47)</a>:</h4>
<p>yes</p>



<a name="319904713"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319904713" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319904713">(Jan 07 2023 at 04:52)</a>:</h4>
<p>Cool. Given that the extra logic doesn't exist yet, is it still a good idea to inline the necessary logic, or is it better to just switch to a <code>ScopedEnvExtension</code>?</p>



<a name="319904719"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319904719" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319904719">(Jan 07 2023 at 04:52)</a>:</h4>
<p>still not sure what's going on with <code>AttributeImpl.erase</code>, though, and I wonder if it would be magically solved by using a <code>ScopedEnvExtension</code>.</p>



<a name="319904751"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319904751" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319904751">(Jan 07 2023 at 04:53)</a>:</h4>
<p>I saw something about calling <code>.erase</code> on the list of erased attributes on your PR, which seems wrong</p>



<a name="319904865"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319904865" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319904865">(Jan 07 2023 at 04:55)</a>:</h4>
<p>That's when a norm_num extension is added (to make sure it's no longer erased). Not sure it really would ever apply, though.</p>



<a name="319904922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319904922" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319904922">(Jan 07 2023 at 04:56)</a>:</h4>
<p>Also it's just the hash map <code>.erase</code>, not the attribute's <code>erase</code></p>



<a name="319904951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319904951" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319904951">(Jan 07 2023 at 04:57)</a>:</h4>
<p>It's patterned off of what <code>SimpTheorems.addConst</code> does</p>



<a name="319905361"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905361" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905361">(Jan 07 2023 at 05:03)</a>:</h4>
<p>that should never happen because you can't add the norm_num attribute to a definition twice</p>



<a name="319905506"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905506" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905506">(Jan 07 2023 at 05:05)</a>:</h4>
<p>Yeah, that's what I thought, but I didn't want to fail to account for some edge case I couldn't anticipate</p>



<a name="319905528"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905528" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905528">(Jan 07 2023 at 05:05)</a>:</h4>
<p>I mean, it doesn't have anything to do with solving this scoping problem, though, right?</p>



<a name="319905664"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905664" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905664">(Jan 07 2023 at 05:06)</a>:</h4>
<p>I thought you were trying to do scopes that way</p>



<a name="319905705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905705">(Jan 07 2023 at 05:07)</a>:</h4>
<p>I don't follow—which way?</p>



<a name="319905711"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905711" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905711">(Jan 07 2023 at 05:07)</a>:</h4>
<p>by erasing things from the map</p>



<a name="319905721"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905721" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905721">(Jan 07 2023 at 05:07)</a>:</h4>
<p>which is wrong and explains the issues you were having earlier</p>



<a name="319905793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905793" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905793">(Jan 07 2023 at 05:08)</a>:</h4>
<p>Currently I don't do scopes, is the point, I think.</p>



<a name="319905837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905837">(Jan 07 2023 at 05:09)</a>:</h4>
<p>to answer your question from before, using <code>ScopedEnvExtension</code> would make sense; the reason I avoided it before was because we didn't need scopes</p>



<a name="319905950"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905950" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905950">(Jan 07 2023 at 05:10)</a>:</h4>
<p>Would it make sense to implement scopes just for the hash set <code>erased</code> in the state somehow, without scoping the whole state?</p>



<a name="319905955"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319905955" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319905955">(Jan 07 2023 at 05:10)</a>:</h4>
<p>if there is a way to implement scopes in a more lightweight way which takes advantage of the fact that norm num erasure is very rare and <code>@[norm_num]</code> itself can't be scoped, then that would be good too</p>



<a name="319906037"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906037" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906037">(Jan 07 2023 at 05:11)</a>:</h4>
<p>Hmm. Can I inspect the current scope?</p>



<a name="319906051"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906051" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906051">(Jan 07 2023 at 05:11)</a>:</h4>
<p>From within <code>IO Unit</code></p>



<a name="319906052"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906052" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906052">(Jan 07 2023 at 05:11)</a>:</h4>
<p>no</p>



<a name="319906059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906059">(Jan 07 2023 at 05:12)</a>:</h4>
<p>certainly not just with that</p>



<a name="319906124"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906124" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906124">(Jan 07 2023 at 05:12)</a>:</h4>
<p>all of lean's state is up in some monad's <code>Context</code> or <code>State</code> type</p>



<a name="319906158"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906158" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906158">(Jan 07 2023 at 05:13)</a>:</h4>
<p>Right, I noticed it in e.g. <code>CommandElabM</code>'s state, iirc—I wasn't sure if <code>IO</code> extended it or something (or not)</p>



<a name="319906178"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906178" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906178">(Jan 07 2023 at 05:13)</a>:</h4>
<p>no it's the other way around, <code>IO</code> is at the very bottom of the monad hierarchy</p>



<a name="319906237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906237" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906237">(Jan 07 2023 at 05:14)</a>:</h4>
<p>ahh</p>



<a name="319906240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906240">(Jan 07 2023 at 05:14)</a>:</h4>
<p>Hmm. <code>erase</code> operates in <code>AttrM</code>. Is that enough?</p>



<a name="319906248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906248">(Jan 07 2023 at 05:14)</a>:</h4>
<p>Wait</p>



<a name="319906249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906249">(Jan 07 2023 at 05:14)</a>:</h4>
<p>Let me read that type again</p>



<a name="319906252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906252" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906252">(Jan 07 2023 at 05:14)</a>:</h4>
<p>AttrM is CoreM, which has a decent amount of state</p>



<a name="319906265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906265">(Jan 07 2023 at 05:15)</a>:</h4>
<p>but I think you are asking the wrong question</p>



<a name="319906284"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906284" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906284">(Jan 07 2023 at 05:15)</a>:</h4>
<p>all of an extension's state has to live inside the <code>EnvExtension</code></p>



<a name="319906329"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906329" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906329">(Jan 07 2023 at 05:16)</a>:</h4>
<p>so if your attribute has a scoping effect then it needs to have a scope stack of some kind</p>



<a name="319906335"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906335" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906335">(Jan 07 2023 at 05:16)</a>:</h4>
<p>Ok, makes sense</p>



<a name="319906338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906338" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906338">(Jan 07 2023 at 05:16)</a>:</h4>
<p>But what sort of things can implement that?</p>



<a name="319906341"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906341" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906341">(Jan 07 2023 at 05:17)</a>:</h4>
<p>what do you mean?</p>



<a name="319906348"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906348" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906348">(Jan 07 2023 at 05:17)</a>:</h4>
<p>How can I get the scope state into the <code>EnvExtension</code> state?</p>



<a name="319906351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906351">(Jan 07 2023 at 05:17)</a>:</h4>
<p>Or, is that not quite how things flow?</p>



<a name="319906355"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906355" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906355">(Jan 07 2023 at 05:17)</a>:</h4>
<p>it's the type variables in <code>PersistentEnvExtension</code></p>



<a name="319906366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906366" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906366">(Jan 07 2023 at 05:17)</a>:</h4>
<p>(see the doc comment too: <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PersistentEnvExtension#doc">docs4#Lean.PersistentEnvExtension</a>)</p>



<a name="319906552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906552">(Jan 07 2023 at 05:21)</a>:</h4>
<p>Right, ok...so, hmm. Let's say a <code>section</code> or <code>end</code> is encountered. some <code>pushScope</code> or <code>popScope</code> occurs, right? Is that meant to reach in and affect the state somehow?</p>



<a name="319906584"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906584" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906584">(Jan 07 2023 at 05:21)</a>:</h4>
<p>hm, looks like <code>ScopedEnvExtension</code>s do have an extra bit of magic: <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.pushScope#src">src4#Lean.pushScope</a></p>



<a name="319906638"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906638" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906638">(Jan 07 2023 at 05:22)</a>:</h4>
<p>I saw that! I was wondering how that worked</p>



<a name="319906645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906645" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906645">(Jan 07 2023 at 05:22)</a>:</h4>
<p><code>section</code> calls that function, which checks a global list of all <code>ScopedEnvExtension</code>s which is pushed to in <code>registerScopedEnvExtension</code></p>



<a name="319906657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906657">(Jan 07 2023 at 05:23)</a>:</h4>
<p>so that means that even if you make a scoping-like <code>PersistentEnvExtension</code> you won't get a callback so you can't detect scopes</p>



<a name="319906676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906676" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906676">(Jan 07 2023 at 05:23)</a>:</h4>
<p>I seee</p>



<a name="319906924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319906924" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319906924">(Jan 07 2023 at 05:28)</a>:</h4>
<p>Hmmm. So is the best option really to turn the whole thing into a <code>ScopedEnvExtension</code>? Or is there some tricky way we could, I don't know, set up a separate scoped extension just for keeping track of erased norm_nums, which the <code>PersistentEnvExtension</code> can keep a reference to? I'm not sure if that's possible, though. It seems like the persistent state can't access any of the information needed.</p>



<a name="319907040"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319907040" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319907040">(Jan 07 2023 at 05:31)</a>:</h4>
<p>Unless—could the auxiliary scoped extension reach in and update a field of the persistent extension when it encountered a new scope?</p>



<a name="319907097"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319907097" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319907097">(Jan 07 2023 at 05:32)</a>:</h4>
<p>you still have a fair amount of control with a scoped env extension, the interface is a little different though</p>



<a name="319907110"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319907110" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319907110">(Jan 07 2023 at 05:32)</a>:</h4>
<p>I don't think it should be a problem to scope only what you want to</p>



<a name="319907130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319907130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319907130">(Jan 07 2023 at 05:33)</a>:</h4>
<p>Ok, neat—one thing I noticed was that <code>addImportedFn</code> didn't seem to have a direct analogue type-wise</p>



<a name="319907213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319907213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319907213">(Jan 07 2023 at 05:34)</a>:</h4>
<p>This is in the<code>Descr</code> argument to <code>registerScopedEnvExtension</code></p>



<a name="319907423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319907423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319907423">(Jan 07 2023 at 05:37)</a>:</h4>
<p>I thought the <code>OLean</code> fields might be related, but they don't quite do the same thing...</p>



<a name="319907487"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319907487" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319907487">(Jan 07 2023 at 05:38)</a>:</h4>
<p>you can see how they relate in <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.ScopedEnvExtension.addImportedFn#src">src4#Lean.ScopedEnvExtension.addImportedFn</a></p>



<a name="319907823"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/319907823" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#319907823">(Jan 07 2023 at 05:44)</a>:</h4>
<p>Oh I see! That looks like it makes sense. Tyvm for taking the time to explain all this. I'm going to pick this back up sometime tomorrow if I can :)</p>



<a name="320334541"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/320334541" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#320334541">(Jan 09 2023 at 21:29)</a>:</h4>
<p>Ok, I think I got this working! <a href="https://github.com/leanprover-community/mathlib4/pull/1364">mathlib4#1364</a></p>



<a name="320335816"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/320335816" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#320335816">(Jan 09 2023 at 21:37)</a>:</h4>
<p>(A bit worried about the necessary switch from two <code>foldlM</code>'s to <code>ScopedEnvExtension</code>'s nested <code>for ... in</code>'s when building the tree on import, but I don't know—maybe it's the same behind the scenes?)</p>



<a name="320336251"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/local%20attribute%20%5B-%20...%5D/near/320336251" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Thomas Murrills <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/local.20attribute.20.5B-.20.2E.2E.2E.5D.html#320336251">(Jan 09 2023 at 21:40)</a>:</h4>
<p>Also, as I'm guessing scoped extensions should be, it's now localizable—though I doubt that will get much, if any, use :)</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>