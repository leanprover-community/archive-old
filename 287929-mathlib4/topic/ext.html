---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/ext.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html">ext</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="320078948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320078948" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320078948">(Jan 08 2023 at 13:53)</a>:</h4>
<p>In <a href="https://github.com/leanprover-community/mathlib4/pull/1353">mathlib4#1353</a>, we need to prove at some point that two <code>FreeMagma.hom</code> are equal (line 119). With lean3, it was done using <code>ext, rfl</code>. It fails in lean4. The reason appears to be that, with lean4, <code>ext</code> is not using the ext lemma defined just a few lines above (line 78)</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[ext, to_additive]</span>
<span class="kd">theorem</span> <span class="n">hom_ext</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">β</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→ₙ*</span> <span class="n">β</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">f</span> <span class="bp">∘</span> <span class="n">of</span> <span class="bp">=</span> <span class="n">g</span> <span class="bp">∘</span> <span class="n">of</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">g</span> <span class="o">:=</span>
</code></pre></div>
<p>Indeed, replacing <code>ext</code> in the proof by an explicit call to <code>FreeMagma.hom_ext</code> enables <code>rfl</code> to close the goal. </p>
<p>Something similar is happening on line 479 where it is necessary to replace <code>ext</code> by  <code>FreeSemigroup.ext</code> to finish the proof.</p>
<p>Is this normal? Is  the use of generic <code>ext</code> deprecated and one needs to call instead the specific ext lemma?</p>



<a name="320088738"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320088738" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320088738">(Jan 08 2023 at 15:24)</a>:</h4>
<p>There are more failing <code>rfl</code> in this PR and all are following an <code>ext</code> or an <code>ext1</code>: see lines 746, 773 and 776</p>



<a name="320090370"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320090370" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320090370">(Jan 08 2023 at 15:41)</a>:</h4>
<p>I remember <code>ext</code> in Lean3 depended chose the <code>ext</code> lemma based on the order they were declared in so they had to be declared in the right order. This is a bad design and probably the cause of the breakages in Lean4</p>



<a name="320093009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320093009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320093009">(Jan 08 2023 at 16:06)</a>:</h4>
<p>I don't agree that it was bad design; in practice the right order was the one that always occurred naturally</p>



<a name="320093140"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320093140" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320093140">(Jan 08 2023 at 16:08)</a>:</h4>
<p>Does it work here if you disable the default ext lemma that it <em>is</em> finding?</p>



<a name="320093285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320093285" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320093285">(Jan 08 2023 at 16:09)</a>:</h4>
<p>How do I that?</p>



<a name="320093795"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320093795" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320093795">(Jan 08 2023 at 16:13)</a>:</h4>
<p>Something like <code>attribute [-ext] MulHom.ext</code></p>



<a name="320093923"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320093923" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320093923">(Jan 08 2023 at 16:14)</a>:</h4>
<p>lean doesn't like that: <code>attribute cannot be erased</code></p>



<a name="320094431"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320094431" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320094431">(Jan 08 2023 at 16:19)</a>:</h4>
<p>Then you might need to make a mwe by copying out the two ext lemmas and basic theory into a new file</p>



<a name="320094585"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320094585" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320094585">(Jan 08 2023 at 16:20)</a>:</h4>
<p>Or we should teach lean how to erase it</p>



<a name="320096776"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320096776" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320096776">(Jan 08 2023 at 16:42)</a>:</h4>
<p>Here is a mwe (well, maybe more a we)</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Algebra.Hom.Equiv.Basic</span>

<span class="kd">universe</span> <span class="n">u</span> <span class="n">v</span> <span class="n">l</span>

<span class="kd">inductive</span> <span class="n">FreeMagma</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span>
  <span class="bp">|</span> <span class="n">of</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">FreeMagma</span> <span class="n">α</span>
  <span class="bp">|</span> <span class="n">mul</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">FreeMagma</span> <span class="n">α</span>
  <span class="n">deriving</span> <span class="n">DecidableEq</span>

<span class="kn">namespace</span> <span class="n">FreeMagma</span>

<span class="kd">variable</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span>  <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">β</span><span class="o">]</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">Mul</span> <span class="o">(</span><span class="n">FreeMagma</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span> <span class="o">⟨</span><span class="n">FreeMagma.mul</span><span class="o">⟩</span>

<span class="kd">theorem</span> <span class="n">mul_eq</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">mul</span> <span class="n">x</span> <span class="n">y</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">y</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">@[elab_as_elim]</span>
<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">recOnMul</span> <span class="o">{</span><span class="n">C</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Sort</span> <span class="n">l</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">ih1</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">C</span> <span class="o">(</span><span class="n">of</span> <span class="n">x</span><span class="o">))</span>
    <span class="o">(</span><span class="n">ih2</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">C</span> <span class="n">x</span> <span class="bp">→</span> <span class="n">C</span> <span class="n">y</span> <span class="bp">→</span> <span class="n">C</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">))</span> <span class="o">:</span> <span class="n">C</span> <span class="n">x</span> <span class="o">:=</span>
  <span class="n">FreeMagma.recOn</span> <span class="n">x</span> <span class="n">ih1</span> <span class="n">ih2</span>

<span class="kd">@[ext]</span>
<span class="kd">theorem</span> <span class="n">hom_ext</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">β</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→ₙ*</span> <span class="n">β</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">f</span> <span class="bp">∘</span> <span class="n">of</span> <span class="bp">=</span> <span class="n">g</span> <span class="bp">∘</span> <span class="n">of</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">g</span> <span class="o">:=</span>
  <span class="o">(</span><span class="n">FunLike.ext</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span> <span class="k">fun</span> <span class="n">x</span> <span class="bp">↦</span>
    <span class="n">recOnMul</span> <span class="n">x</span> <span class="o">(</span><span class="n">congr_fun</span> <span class="n">h</span><span class="o">)</span> <span class="bp">&lt;|</span> <span class="kd">by</span>
      <span class="n">intros</span>
      <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">map_mul</span><span class="o">,</span> <span class="bp">*</span><span class="o">]</span>

<span class="kd">def</span> <span class="n">liftAux</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">β</span><span class="o">]</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span>
  <span class="bp">|</span> <span class="n">FreeMagma.of</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">x</span>
  <span class="bp">|</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">y</span> <span class="bp">=&gt;</span> <span class="n">liftAux</span> <span class="n">f</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">liftAux</span> <span class="n">f</span> <span class="n">y</span>

<span class="kd">def</span> <span class="n">lift</span> <span class="o">:</span> <span class="o">(</span><span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="bp">≃</span> <span class="o">(</span><span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→ₙ*</span> <span class="n">β</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">toFun</span> <span class="n">f</span> <span class="o">:=</span>
    <span class="o">{</span> <span class="n">toFun</span> <span class="o">:=</span> <span class="n">liftAux</span> <span class="n">f</span>
      <span class="n">map_mul'</span> <span class="o">:=</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="bp">↦</span> <span class="n">rfl</span> <span class="o">}</span>
  <span class="n">invFun</span> <span class="n">F</span> <span class="o">:=</span> <span class="n">F</span> <span class="bp">∘</span> <span class="n">of</span>
  <span class="n">left_inv</span> <span class="n">f</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">rfl</span>
  <span class="n">right_inv</span> <span class="n">F</span> <span class="o">:=</span> <span class="kd">by</span>
    <span class="n">ext</span> <span class="c1">-- fails</span>
    <span class="c1">-- refine hom_ext ?_ -- works</span>
    <span class="n">rfl</span>

<span class="kd">end</span> <span class="n">FreeMagma</span>
</code></pre></div>



<a name="320096992"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320096992" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320096992">(Jan 08 2023 at 16:45)</a>:</h4>
<p>Does it give any useful message?</p>



<a name="320097116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320097116" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320097116">(Jan 08 2023 at 16:47)</a>:</h4>
<p>I am not sure it is useful but here is the error message </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">type</span> <span class="n">mismatch</span>
  <span class="n">HEq.rfl</span>
<span class="n">has</span> <span class="n">type</span>
  <span class="n">HEq</span> <span class="bp">?</span><span class="n">m.4713</span> <span class="bp">?</span><span class="n">m.4713</span> <span class="o">:</span> <span class="kt">Prop</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="bp">↑</span><span class="o">((</span><span class="k">fun</span> <span class="n">f</span> <span class="bp">=&gt;</span> <span class="o">{</span> <span class="n">toFun</span> <span class="o">:=</span> <span class="n">liftAux</span> <span class="n">f</span><span class="o">,</span> <span class="n">map_mul'</span> <span class="o">:=</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span><span class="o">),</span> <span class="n">liftAux</span> <span class="n">f</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">liftAux</span> <span class="n">f</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">))</span> <span class="o">})</span>
          <span class="o">((</span><span class="k">fun</span> <span class="n">F</span> <span class="bp">=&gt;</span> <span class="bp">↑</span><span class="n">F</span> <span class="bp">∘</span> <span class="n">of</span><span class="o">)</span> <span class="n">F</span><span class="o">))</span>
      <span class="n">x</span><span class="bp">✝</span> <span class="bp">=</span>
    <span class="bp">↑</span><span class="n">F</span> <span class="n">x</span><span class="bp">✝</span> <span class="o">:</span> <span class="kt">Prop</span>
</code></pre></div>



<a name="320097314"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320097314" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320097314">(Jan 08 2023 at 16:49)</a>:</h4>
<p>So I guess it is using <code>FunLike.ext</code> instead of <code>hom_ext</code></p>



<a name="320099657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320099657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320099657">(Jan 08 2023 at 17:15)</a>:</h4>
<p>Is the error on the <code>ext</code> or the <code>rfl</code>?</p>



<a name="320099726"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320099726" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320099726">(Jan 08 2023 at 17:15)</a>:</h4>
<blockquote>
<p>Here is a mwe (well, maybe more a we)</p>
</blockquote>
<p>You need to put your own version of <code>MulHom</code> in that MWE too, that doesn't implement <code>FunLike</code></p>



<a name="320099797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320099797" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320099797">(Jan 08 2023 at 17:16)</a>:</h4>
<p>(What I'm trying to work out here is whether <code>hom_ext</code> is even a valid ext lemma in Lean4)</p>



<a name="320099903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320099903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320099903">(Jan 08 2023 at 17:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/287929-mathlib4/topic/ext/near/320099657">said</a>:</p>
<blockquote>
<p>Is the error on the <code>ext</code> or the <code>rfl</code>?</p>
</blockquote>
<p>The <code>rfl</code> fails to close the goal (see the error message above). The <code>ext</code> does not cause any error.</p>



<a name="320100186"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320100186" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320100186">(Jan 08 2023 at 17:20)</a>:</h4>
<p>Oh, I assumed <code>ext</code> did cause an error because you wrote <code>ext -- fails</code>!</p>



<a name="320100313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320100313" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320100313">(Jan 08 2023 at 17:22)</a>:</h4>
<p>Sorry, I was not clear. The proof does not complete with <code>ext</code> but completes when you replace it with <code>refine hom_ext ?_</code></p>



<a name="320100665"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320100665" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320100665">(Jan 08 2023 at 17:26)</a>:</h4>
<p>Here's a better mwe:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Algebra.Group.Basic</span>
<span class="kn">import</span> <span class="n">Mathlib.Logic.Equiv.Basic</span>

<span class="kd">universe</span> <span class="n">u</span> <span class="n">v</span> <span class="n">l</span>

<span class="kd">structure</span> <span class="n">MulHom</span> <span class="o">(</span><span class="n">M</span> <span class="n">N</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">)</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">N</span><span class="o">]</span> <span class="n">where</span>
  <span class="n">toFun</span> <span class="o">:</span> <span class="n">M</span> <span class="bp">→</span> <span class="n">N</span>
  <span class="n">map_mul</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">toFun</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">toFun</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">toFun</span> <span class="n">b</span>

<span class="c1">-- fails if you uncomment this line</span>
<span class="c1">-- @[ext]</span>
<span class="kd">lemma</span> <span class="n">MulHom.ext</span> <span class="o">{</span><span class="n">M</span> <span class="n">N</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">}</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">N</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">MulHom</span> <span class="n">M</span> <span class="n">N</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">f.toFun</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">g.toFun</span> <span class="n">x</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">g</span> <span class="o">:=</span>
  <span class="gr">sorry</span>

<span class="kd">inductive</span> <span class="n">FreeMagma</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span>
  <span class="bp">|</span> <span class="n">of</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">FreeMagma</span> <span class="n">α</span>
  <span class="bp">|</span> <span class="n">mul</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">FreeMagma</span> <span class="n">α</span>
  <span class="n">deriving</span> <span class="n">DecidableEq</span>

<span class="kn">namespace</span> <span class="n">FreeMagma</span>

<span class="kd">variable</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span>  <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">β</span><span class="o">]</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">Mul</span> <span class="o">(</span><span class="n">FreeMagma</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span> <span class="o">⟨</span><span class="n">FreeMagma.mul</span><span class="o">⟩</span>

<span class="kd">theorem</span> <span class="n">mul_eq</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">mul</span> <span class="n">x</span> <span class="n">y</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">y</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">@[elab_as_elim]</span>
<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">recOnMul</span> <span class="o">{</span><span class="n">C</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Sort</span> <span class="n">l</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">ih1</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">C</span> <span class="o">(</span><span class="n">of</span> <span class="n">x</span><span class="o">))</span>
    <span class="o">(</span><span class="n">ih2</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">C</span> <span class="n">x</span> <span class="bp">→</span> <span class="n">C</span> <span class="n">y</span> <span class="bp">→</span> <span class="n">C</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">))</span> <span class="o">:</span> <span class="n">C</span> <span class="n">x</span> <span class="o">:=</span>
  <span class="n">FreeMagma.recOn</span> <span class="n">x</span> <span class="n">ih1</span> <span class="n">ih2</span>

<span class="kd">@[ext]</span>
<span class="kd">theorem</span> <span class="n">hom_ext</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">β</span><span class="o">]</span> <span class="o">{</span><span class="n">f</span> <span class="n">g</span> <span class="o">:</span> <span class="n">MulHom</span> <span class="o">(</span><span class="n">FreeMagma</span> <span class="n">α</span><span class="o">)</span> <span class="n">β</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">f.toFun</span> <span class="bp">∘</span> <span class="n">of</span> <span class="bp">=</span> <span class="n">g.toFun</span> <span class="bp">∘</span> <span class="n">of</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">g</span> <span class="o">:=</span>
  <span class="gr">sorry</span>

<span class="kd">def</span> <span class="n">liftAux</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">Mul</span> <span class="n">β</span><span class="o">]</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">FreeMagma</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span>
  <span class="bp">|</span> <span class="n">FreeMagma.of</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">x</span>
  <span class="bp">|</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">y</span> <span class="bp">=&gt;</span> <span class="n">liftAux</span> <span class="n">f</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">liftAux</span> <span class="n">f</span> <span class="n">y</span>

<span class="kd">def</span> <span class="n">lift</span> <span class="o">:</span> <span class="o">(</span><span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="bp">≃</span> <span class="o">(</span><span class="n">MulHom</span> <span class="o">(</span><span class="n">FreeMagma</span> <span class="n">α</span><span class="o">)</span> <span class="n">β</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">toFun</span> <span class="n">f</span> <span class="o">:=</span>
    <span class="o">{</span> <span class="n">toFun</span> <span class="o">:=</span> <span class="n">liftAux</span> <span class="n">f</span>
      <span class="n">map_mul</span> <span class="o">:=</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="bp">↦</span> <span class="n">rfl</span> <span class="o">}</span>
  <span class="n">invFun</span> <span class="n">F</span> <span class="o">:=</span> <span class="n">F.toFun</span> <span class="bp">∘</span> <span class="n">of</span>
  <span class="n">left_inv</span> <span class="n">f</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">rfl</span>
  <span class="n">right_inv</span> <span class="n">F</span> <span class="o">:=</span> <span class="kd">by</span>
    <span class="n">ext</span> <span class="c1">-- works?</span>
    <span class="n">rfl</span>

<span class="kd">end</span> <span class="n">FreeMagma</span>
</code></pre></div>



<a name="320100684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320100684" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320100684">(Jan 08 2023 at 17:27)</a>:</h4>
<p>(deleted)</p>



<a name="320100724"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320100724" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320100724">(Jan 08 2023 at 17:27)</a>:</h4>
<p>So this does seem to be a priority problem of some kind</p>



<a name="320130321"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320130321" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320130321">(Jan 08 2023 at 23:54)</a>:</h4>
<p>Same story as with simp lemmas I think.  The order of the lemmas in the files no longer reliably influences the order they're tried in.  I think we should add a priority argument to the ext attribute.</p>



<a name="320130593"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320130593" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320130593">(Jan 08 2023 at 23:59)</a>:</h4>
<p>It looks to me like <code>ext</code> doesn't understand priority at all?</p>



<a name="320155914"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320155914" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320155914">(Jan 09 2023 at 06:26)</a>:</h4>
<p>Can you do <code>show_term { ext }</code> or <code>ext?</code> in Lean 4?<br>
I'd expect some goals previously closed by <code>by { ext, refl }</code> might be closed by <code>rfl</code> alone due to eta defeq.</p>



<a name="320171460"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320171460" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320171460">(Jan 09 2023 at 08:38)</a>:</h4>
<p>yes (it's <code>show_term ext</code>)</p>



<a name="320171733"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320171733" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320171733">(Jan 09 2023 at 08:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224323">Junyan Xu</span> <a href="#narrow/stream/287929-mathlib4/topic/ext/near/320155914">said</a>:</p>
<blockquote>
<p>I'd expect some goals previously closed by <code>by { ext, refl }</code> might be closed by <code>rfl</code> alone due to eta defeq.</p>
</blockquote>
<p>This is not the case in <a href="https://github.com/leanprover-community/mathlib/pull/1353">mathlib#1353</a> (unfortunately).</p>



<a name="320389699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320389699" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xavier Roblot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320389699">(Jan 10 2023 at 07:25)</a>:</h4>
<blockquote>
<p>Same story as with simp lemmas I think.  The order of the lemmas in the files no longer reliably influences the order they're tried in.  I think we should add a priority argument to the ext attribute.</p>
</blockquote>
<p>In the meantime, what should I do about <a href="https://github.com/leanprover-community/mathlib/pull/1353">mathlib#1353</a>? Should I just replace every <code>ext</code> by the explicit <code>ext</code> lemma that should be used?</p>
<p>Or just wait for <code>ext</code> to be fixed...</p>



<a name="320394863"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320394863" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320394863">(Jan 10 2023 at 08:07)</a>:</h4>
<p>Replacing <code>ext</code> by the <code>ext</code> lemmas and leaving porting notes where that happened is fine, I would say.</p>



<a name="320410949"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320410949" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320410949">(Jan 10 2023 at 09:48)</a>:</h4>
<p>I think it's worth opening an issue about and referencing that in the porting note</p>



<a name="320410999"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320410999" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320410999">(Jan 10 2023 at 09:48)</a>:</h4>
<p>That way it's easy to clean everything up if we fix it</p>



<a name="320411130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320411130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320411130">(Jan 10 2023 at 09:49)</a>:</h4>
<p>This problem will likely bite us for every lemma tagged with the "partially applied ext lemma" note.</p>



<a name="320534119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/ext/near/320534119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/ext.html#320534119">(Jan 10 2023 at 19:59)</a>:</h4>
<p><a href="https://github.com/leanprover/std4/pull/84">std4#84</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>