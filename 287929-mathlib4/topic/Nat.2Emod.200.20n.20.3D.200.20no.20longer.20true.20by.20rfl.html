---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html">Nat.mod 0 n = 0 no longer true by rfl</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="319691067"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319691067" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319691067">(Jan 05 2023 at 23:18)</a>:</h4>
<p>Lean 4 has special kernel support for computation with <code>Nat.mod</code> (as well as special extern functions for VM computation), so it shouldn't make a big difference if we change the <code>Nat.mod</code> definition.</p>



<a name="319691487"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319691487" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319691487">(Jan 05 2023 at 23:22)</a>:</h4>
<p>That said, it's a huge coincidence that <code>nat.mod 0 n</code> reduces in Lean 3.  If I had picked a different value for the initial fuel, then we wouldn't have that defeq (because <code>0 &lt; n ∧ n ≤ 0</code> doesn't reduce).</p>



<a name="319691625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319691625" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319691625">(Jan 05 2023 at 23:23)</a>:</h4>
<p>Given a fair bit of mathlib builds upon that coincidence, it seems a shame to throw away the coincidence without a compelling reason</p>



<a name="319692774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319692774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319692774">(Jan 05 2023 at 23:32)</a>:</h4>
<p>20 messages were moved from this topic to <a class="stream-topic" data-stream-id="287929" href="/#narrow/stream/287929-mathlib4/topic/Porting.20Nat.2Emod_def">#mathlib4 &gt; Porting Nat.mod_def</a> by <span class="user-mention silent" data-user-id="310045">Eric Wieser</span>.</p>



<a name="319695131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319695131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319695131">(Jan 05 2023 at 23:54)</a>:</h4>
<p>24 messages were moved here from <a class="stream-topic" data-stream-id="287929" href="/#narrow/stream/287929-mathlib4/topic/Data.2EFin.2EBasic.20.28mathlib4.231084.29">#mathlib4 &gt; Data.Fin.Basic (mathlib4#1084)</a> by <span class="user-mention silent" data-user-id="310045">Eric Wieser</span>.</p>



<a name="319695433"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319695433" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319695433">(Jan 05 2023 at 23:57)</a>:</h4>
<p>I've created <a href="https://github.com/leanprover/lean4/pull/2014">https://github.com/leanprover/lean4/pull/2014</a> as a draft, mainly to see if CI is happy. What are your thoughts on this, <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span>?</p>



<a name="319696330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696330">(Jan 06 2023 at 00:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl/near/319691067">said</a>:</p>
<blockquote>
<p>Lean 4 has special kernel support for computation with <code>Nat.mod</code> (as well as special extern functions for VM computation), so it shouldn't make a big difference if we change the <code>Nat.mod</code> definition.</p>
</blockquote>
<p>Oh, so I guess that means that the kernel would have to change to match the new implementation?</p>



<a name="319696351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696351">(Jan 06 2023 at 00:05)</a>:</h4>
<p>the kernel implementation is only for literals</p>



<a name="319696416"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696416" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696416">(Jan 06 2023 at 00:06)</a>:</h4>
<p>I get a pretty weird error in CI from my change above</p>



<a name="319696432"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696432" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696432">(Jan 06 2023 at 00:06)</a>:</h4>
<p>A downstream <code>simp</code> call produces an invalid term</p>



<a name="319696458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696458">(Jan 06 2023 at 00:06)</a>:</h4>
<p>so as long as you haven't actually changed the value of the definition (and since you proved the same defining equation I think it's safe to say this is not the case) the kernel doesn't have to change</p>



<a name="319696530"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696530" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696530">(Jan 06 2023 at 00:07)</a>:</h4>
<p>This proof:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[simp]</span> <span class="kd">theorem</span> <span class="n">gcd_zero_right</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">gcd</span> <span class="n">n</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">n</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">cases</span> <span class="n">n</span> <span class="bp">&lt;;&gt;</span> <span class="n">simp</span> <span class="o">[</span><span class="n">gcd_succ</span><span class="o">]</span>
</code></pre></div>
<p>fails with</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">application</span> <span class="n">type</span> <span class="n">mismatch</span>
  <span class="bp">@</span><span class="n">Eq.ndrec</span> <span class="n">Nat</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="bp">✝</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">n</span> <span class="bp">=&gt;</span> <span class="n">gcd</span> <span class="n">n</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">n</span><span class="o">)</span>
    <span class="o">(</span><span class="n">of_eq_true</span>
      <span class="o">(</span><span class="n">Eq.trans</span> <span class="o">(</span><span class="n">congrFun</span> <span class="o">(</span><span class="n">congrArg</span> <span class="n">Eq</span> <span class="o">(</span><span class="n">congrFun</span> <span class="o">(</span><span class="n">congrArg</span> <span class="n">gcd</span> <span class="o">(</span><span class="n">zero_mod</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="bp">✝</span><span class="o">)))</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="bp">✝</span><span class="o">)))</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="bp">✝</span><span class="o">))</span>
        <span class="o">(</span><span class="n">eq_self</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="bp">✝</span><span class="o">))))</span>
<span class="n">argument</span> <span class="n">has</span> <span class="n">type</span>
  <span class="n">gcd</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">%</span> <span class="n">succ</span> <span class="n">n</span><span class="bp">✝</span><span class="o">)</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="bp">✝</span><span class="o">)</span> <span class="bp">=</span> <span class="n">succ</span> <span class="n">n</span><span class="bp">✝</span>
<span class="n">but</span> <span class="n">function</span> <span class="n">has</span> <span class="n">type</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">n</span> <span class="bp">=&gt;</span> <span class="n">gcd</span> <span class="n">n</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="bp">✝</span><span class="o">)</span> <span class="bp">→</span> <span class="bp">∀</span> <span class="o">{</span><span class="n">b</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">},</span> <span class="n">succ</span> <span class="n">n</span><span class="bp">✝</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">→</span> <span class="o">(</span><span class="k">fun</span> <span class="n">n</span> <span class="bp">=&gt;</span> <span class="n">gcd</span> <span class="n">n</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">n</span><span class="o">)</span> <span class="n">b</span>
</code></pre></div>



<a name="319696608"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696608" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696608">(Jan 06 2023 at 00:08)</a>:</h4>
<p>Which is scary because the term which has a type mismatch is being produced by <code>simp</code></p>



<a name="319696796"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696796" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696796">(Jan 06 2023 at 00:10)</a>:</h4>
<p>it works fine as</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[simp]</span> <span class="kd">theorem</span> <span class="n">gcd_zero_right</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">gcd</span> <span class="n">n</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">n</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">cases</span> <span class="n">n</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">zero</span> <span class="bp">=&gt;</span> <span class="n">simp</span> <span class="o">[</span><span class="n">gcd_succ</span><span class="o">]</span>
  <span class="bp">|</span> <span class="n">succ</span> <span class="n">n</span> <span class="bp">=&gt;</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">gcd_succ</span><span class="o">]</span>
    <span class="n">exact</span> <span class="n">gcd_zero_left</span> <span class="n">_</span>
</code></pre></div>



<a name="319696819"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696819" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696819">(Jan 06 2023 at 00:10)</a>:</h4>
<p>But I feel like the failure might be a warning sign</p>



<a name="319696895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696895" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696895">(Jan 06 2023 at 00:11)</a>:</h4>
<p>does <code>simp only [gcd_succ]; sorry</code> work in the second branch?</p>



<a name="319696990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319696990" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319696990">(Jan 06 2023 at 00:12)</a>:</h4>
<p>No, with</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">application</span> <span class="n">type</span> <span class="n">mismatch</span>
  <span class="n">id</span> <span class="o">(</span><span class="n">sorryAx</span> <span class="o">(</span><span class="n">gcd</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">%</span> <span class="n">succ</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span> <span class="n">succ</span> <span class="n">n</span><span class="o">))</span>
<span class="n">argument</span> <span class="n">has</span> <span class="n">type</span>
  <span class="n">gcd</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">%</span> <span class="n">succ</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span> <span class="n">succ</span> <span class="n">n</span>
<span class="n">but</span> <span class="n">function</span> <span class="n">has</span> <span class="n">type</span>
  <span class="n">gcd</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="o">)</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">succ</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">gcd</span> <span class="o">(</span><span class="n">succ</span> <span class="n">n</span><span class="o">)</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">succ</span> <span class="n">n</span>
</code></pre></div>



<a name="319697042"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319697042" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319697042">(Jan 06 2023 at 00:12)</a>:</h4>
<p>Can you replicate this outside core?</p>



<a name="319697124"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319697124" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319697124">(Jan 06 2023 at 00:13)</a>:</h4>
<p>If I  stupidly edited things in <code>.elean/toolchains/...</code>, how do I wipe them and start afresh?</p>



<a name="319697407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319697407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319697407">(Jan 06 2023 at 00:16)</a>:</h4>
<p>I think you can use <code>elan toolchain uninstall bla</code></p>



<a name="319697618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319697618" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319697618">(Jan 06 2023 at 00:19)</a>:</h4>
<p>I think this image is toast, I'll spin up a new one</p>



<a name="319698001"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319698001" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319698001">(Jan 06 2023 at 00:23)</a>:</h4>
<p>Yes, it reproduces outside core</p>
<div class="spoiler-block"><div class="spoiler-header">
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Init.WF</span>
<span class="kn">import</span> <span class="n">Init.WFTactics</span>
<span class="kn">import</span> <span class="n">Init.Data.Nat.Basic</span>
<span class="kn">namespace</span> <span class="n">Nat</span>

<span class="kn">protected</span> <span class="kd">def</span> <span class="n">modCore</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">Nat</span> <span class="bp">→</span> <span class="n">Nat</span> <span class="bp">→</span> <span class="n">Nat</span>
  <span class="bp">|</span> <span class="n">Nat.zero</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">x</span>
  <span class="bp">|</span> <span class="n">Nat.succ</span> <span class="n">fuel</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="k">if</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="n">y</span> <span class="bp">∧</span> <span class="n">y</span> <span class="bp">≤</span> <span class="n">x</span> <span class="k">then</span> <span class="n">Nat.modCore</span> <span class="n">y</span> <span class="n">fuel</span> <span class="o">(</span><span class="n">x</span> <span class="bp">-</span> <span class="n">y</span><span class="o">)</span> <span class="k">else</span> <span class="n">x</span>

<span class="kn">protected</span> <span class="kd">def</span> <span class="n">mod'</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="bp">@&amp;</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">Nat</span> <span class="o">:=</span>
<span class="n">Nat.modCore</span> <span class="n">y</span> <span class="n">x</span> <span class="n">x</span>

<span class="kd">@[simp]</span> <span class="kd">theorem</span> <span class="n">zero_mod'</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">Nat.mod'</span> <span class="mi">0</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kd">end</span> <span class="n">Nat</span>

<span class="kn">namespace</span> <span class="n">Nat</span>

<span class="kn">private</span> <span class="kd">def</span> <span class="n">gcdF'</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">x₁</span><span class="o">,</span> <span class="n">x₁</span> <span class="bp">&lt;</span> <span class="n">x</span> <span class="bp">→</span> <span class="n">Nat</span> <span class="bp">→</span> <span class="n">Nat</span><span class="o">)</span> <span class="bp">→</span> <span class="n">Nat</span> <span class="bp">→</span> <span class="n">Nat</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="mi">0</span>      <span class="bp">=&gt;</span> <span class="k">fun</span> <span class="n">_</span> <span class="n">y</span> <span class="bp">=&gt;</span> <span class="n">y</span>
  <span class="bp">|</span> <span class="n">succ</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="k">fun</span> <span class="n">f</span> <span class="n">y</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">Nat.mod'</span> <span class="n">y</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">))</span> <span class="gr">sorry</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span>

<span class="kd">noncomputable</span> <span class="kd">def</span> <span class="n">gcd'</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">Nat</span> <span class="o">:=</span>
  <span class="n">WellFounded.fix</span> <span class="o">(</span><span class="n">measure</span> <span class="n">id</span><span class="o">)</span><span class="bp">.</span><span class="n">wf</span> <span class="n">gcdF'</span> <span class="n">a</span> <span class="n">b</span>

<span class="kd">@[simp]</span> <span class="kd">theorem</span> <span class="n">gcd'_zero_left</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">gcd'</span> <span class="mi">0</span> <span class="n">y</span> <span class="bp">=</span> <span class="n">y</span> <span class="o">:=</span>
  <span class="n">rfl</span>

<span class="kd">theorem</span> <span class="n">gcd'_succ</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">gcd'</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="n">y</span> <span class="bp">=</span> <span class="n">gcd'</span> <span class="o">(</span><span class="n">Nat.mod'</span> <span class="n">y</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">))</span> <span class="o">(</span><span class="n">succ</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">rfl</span>
<span class="c1">--              VVVVVVVVVVVVVVV error here</span>
<span class="kd">@[simp]</span> <span class="kd">theorem</span> <span class="n">gcd'_zero_right</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">gcd'</span> <span class="n">n</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">n</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">cases</span> <span class="n">n</span> <span class="bp">&lt;;&gt;</span> <span class="n">simp</span> <span class="o">[</span><span class="n">gcd'_succ</span><span class="o">]</span>

<span class="kd">end</span> <span class="n">Nat</span>
</code></pre></div>
</div></div>



<a name="319698617"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319698617" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319698617">(Jan 06 2023 at 00:29)</a>:</h4>
<p>(deleted)</p>



<a name="319698784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319698784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319698784">(Jan 06 2023 at 00:31)</a>:</h4>
<p>Oh I meant using <code>mod'</code>, no <code>prelude</code></p>



<a name="319698964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319698964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319698964">(Jan 06 2023 at 00:32)</a>:</h4>
<p>Edited above</p>



<a name="319699216"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319699216" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319699216">(Jan 06 2023 at 00:35)</a>:</h4>
<p>Shall I make a lean4 bug report?</p>



<a name="319699338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319699338" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319699338">(Jan 06 2023 at 00:36)</a>:</h4>
<p>great, now I can use <code>show_term</code> on the simp call:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Std.Tactic.Basic</span>
<span class="bp">...</span>
<span class="kd">@[simp]</span> <span class="kd">theorem</span> <span class="n">gcd'_zero_right</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">gcd'</span> <span class="n">n</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">n</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">cases</span> <span class="n">n</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">zero</span> <span class="bp">=&gt;</span> <span class="n">simp</span> <span class="o">[</span><span class="n">gcd'_succ</span><span class="o">]</span>
  <span class="bp">|</span> <span class="n">succ</span> <span class="n">n</span> <span class="bp">=&gt;</span> <span class="n">show_term</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">gcd'_succ</span><span class="o">]</span><span class="bp">;</span> <span class="gr">sorry</span>
<span class="c1">-- @id (gcd' (succ n) 0 = succ n) (sorryAx (gcd' (Nat.mod' 0 (succ n)) (succ n) = succ n))</span>
</code></pre></div>



<a name="319699364"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319699364" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319699364">(Jan 06 2023 at 00:36)</a>:</h4>
<p>it seems that something was marked as a dsimp lemma that isn't rfl</p>



<a name="319699506"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319699506" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319699506">(Jan 06 2023 at 00:38)</a>:</h4>
<p>Changing <code>gcd'_succ</code>  to be proved by <code>id rfl</code> makes the error go away</p>



<a name="319700120"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319700120" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319700120">(Jan 06 2023 at 00:45)</a>:</h4>
<p>this could be one of those rare instances of non-transitivity of defeq</p>



<a name="319700184"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/319700184" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#319700184">(Jan 06 2023 at 00:45)</a>:</h4>
<p>It is surprising that <code>gcd'_succ</code> is provable by <code>rfl</code> in the first place, so using <code>id rfl</code> seems reasonable</p>



<a name="320068370"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Nat.mod%200%20n%20%3D%200%20no%20longer%20true%20by%20rfl/near/320068370" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Nat.2Emod.200.20n.20.3D.200.20no.20longer.20true.20by.20rfl.html#320068370">(Jan 08 2023 at 12:14)</a>:</h4>
<p>Filed as <a href="https://github.com/leanprover/lean4/pull/2021">leanprover/lean4#2021</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>