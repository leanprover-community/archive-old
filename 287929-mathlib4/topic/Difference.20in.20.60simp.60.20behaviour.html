---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html">Difference in `simp` behaviour</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="314474914"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314474914" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314474914">(Dec 07 2022 at 14:56)</a>:</h4>
<p>The following proof works in Lean3 but not Lean4. I'm a bit surprised that it does work in Lean3, but the fact that it doesn't work breaks a bunch of proofs in <code>Data.Set.Basic</code>. What's the best fix to this?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">logic.basic</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">p</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">p</span><span class="o">),</span> <span class="n">q</span> <span class="n">h2</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">h</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">h</span><span class="o">,</span> <span class="n">forall_true_left</span><span class="o">]</span>
</code></pre></div>



<a name="314521054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314521054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314521054">(Dec 07 2022 at 17:54)</a>:</h4>
<p>The problem seems to be the following:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">logic.basic</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">p</span><span class="o">)</span> <span class="o">:</span>
    <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">p</span><span class="o">),</span> <span class="n">q</span> <span class="n">h2</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">h</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="k">have</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">=</span> <span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">h</span><span class="o">],</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">foo</span><span class="o">],</span> <span class="c1">-- `⊢ (∀ (h : true), q _) ↔ q h`</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">iff_self</span><span class="o">,</span> <span class="n">forall_true_left</span><span class="o">],</span>
<span class="kd">end</span>
</code></pre></div>
<p>The <code>simp only [foo]</code> line works in Lean 3, but does nothing in Lean 4:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Logic.Basic</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">p</span><span class="o">)</span> <span class="o">:</span>
    <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">p</span><span class="o">),</span> <span class="n">q</span> <span class="n">h2</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">h</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">=</span> <span class="n">True</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">h</span><span class="o">]</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">foo</span><span class="o">]</span> <span class="c1">-- no change in goal in Lean 4</span>
  <span class="c1">-- rw [foo] -- motive not type correct :-/</span>
  <span class="n">subst</span> <span class="n">foo</span>
  <span class="n">simp</span> <span class="c1">-- works fine now</span>
</code></pre></div>



<a name="314521377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314521377" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314521377">(Dec 07 2022 at 17:55)</a>:</h4>
<p>This vaguely reminds me of <a href="https://github.com/leanprover/lean4/issues/1549">https://github.com/leanprover/lean4/issues/1549</a></p>



<a name="314521479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314521479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314521479">(Dec 07 2022 at 17:56)</a>:</h4>
<p>I wonder if there's a way to add a type annotation to make it work (like <a href="https://github.com/leanprover/lean4/issues/1549#issuecomment-1241105330">this workaround</a>).</p>



<a name="314572132"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314572132" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314572132">(Dec 07 2022 at 22:39)</a>:</h4>
<p>Can we <a href="https://leanprover-community.github.io/mwe.html">#mwe</a> this for an issue on the Lean 4 repo?</p>



<a name="314576058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314576058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314576058">(Dec 07 2022 at 23:09)</a>:</h4>
<p>slightly shorter but not much</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">=</span> <span class="n">True</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h'</span> <span class="o">:</span> <span class="bp">∀</span><span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">True</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">),</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">q</span> <span class="n">x</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">True.intro</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">h'</span><span class="o">,</span> <span class="n">q</span> <span class="n">h'</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="o">(</span><span class="n">h.symm</span> <span class="bp">▸</span> <span class="n">trivial</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">h</span><span class="o">,</span> <span class="n">h'</span><span class="o">]</span> <span class="c1">-- no change in goal in Lean 4</span>
  <span class="c1">-- rw [h] -- motive not type correct :-/</span>
  <span class="n">subst</span> <span class="n">h</span>
  <span class="n">simp</span> <span class="o">[</span><span class="n">h'</span><span class="o">]</span> <span class="c1">-- works fine now</span>
</code></pre></div>



<a name="314576236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314576236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314576236">(Dec 07 2022 at 23:10)</a>:</h4>
<p>I'll file it. I noticed this a few months ago as well but thought it was just a lack of <code>@[simp]</code>s</p>



<a name="314576311"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314576311" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314576311">(Dec 07 2022 at 23:11)</a>:</h4>
<p>It would be best if you can minimise this so it doesn't include Mathlib at all</p>



<a name="314576335"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314576335" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314576335">(Dec 07 2022 at 23:11)</a>:</h4>
<p>Just copy-paste anything needed from Logic.Basic. The Lean 4 devs will need a test case.</p>



<a name="314576924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314576924" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314576924">(Dec 07 2022 at 23:16)</a>:</h4>
<p>Right, edited</p>



<a name="314583517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314583517" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314583517">(Dec 08 2022 at 00:24)</a>:</h4>
<p>Just adding the link to Jakob's issue here: <a href="https://github.com/leanprover/lean4/issues/1926">https://github.com/leanprover/lean4/issues/1926</a></p>



<a name="314679238"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314679238" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314679238">(Dec 08 2022 at 13:46)</a>:</h4>
<p>In <a href="https://github.com/leanprover-community/mathlib/pull/903">#903</a> I encountered a bug which I think is related.  If someone can sanity-check this then I'll add it to the <a href="https://github.com/leanprover/lean4/issues/1926">issue Jakob opened</a>.  The following fails in Lean 4 but works in Lean 3:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">P</span> <span class="n">Q</span> <span class="n">R</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">hQ</span> <span class="o">:</span> <span class="n">Q</span> <span class="bp">=</span> <span class="n">False</span><span class="o">)</span> <span class="o">(</span><span class="n">hR</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">=</span> <span class="n">False</span><span class="o">)</span> <span class="o">:</span> <span class="n">P</span> <span class="bp">∨</span> <span class="n">Q</span> <span class="bp">↔</span> <span class="n">P</span> <span class="bp">∨</span> <span class="n">R</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">hQ</span><span class="o">,</span> <span class="n">hR</span><span class="o">]</span>
</code></pre></div>



<a name="314684770"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314684770" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314684770">(Dec 08 2022 at 14:13)</a>:</h4>
<p>Does adding <a href="https://leanprover-community.github.io/mathlib_docs/find/iff_self">docs#iff_self</a> to the list help?</p>



<a name="314686514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314686514" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314686514">(Dec 08 2022 at 14:20)</a>:</h4>
<p>It does, but that doesn't seem to explain the difference between the Lean 3 and Lean 4 behaviour?</p>



<a name="314689025"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314689025" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314689025">(Dec 08 2022 at 14:32)</a>:</h4>
<p>Lean 3:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">trace.simplify.rewrite</span> <span class="n">true</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">P</span> <span class="n">Q</span> <span class="n">R</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">hQ</span> <span class="o">:</span> <span class="n">Q</span> <span class="bp">=</span> <span class="n">false</span><span class="o">)</span> <span class="o">(</span><span class="n">hR</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">=</span> <span class="n">false</span><span class="o">)</span> <span class="o">:</span> <span class="n">P</span> <span class="bp">∨</span> <span class="n">Q</span> <span class="bp">↔</span> <span class="n">P</span> <span class="bp">∨</span> <span class="n">R</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">hQ</span><span class="o">,</span> <span class="n">hR</span><span class="o">]</span> <span class="c1">-- works</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">debugging output:</span>

<span class="cm">0. [simplify.rewrite] [hQ]: Q ==&gt; false</span>
<span class="cm">0. [simplify.rewrite] [hR]: R ==&gt; false</span>
<span class="cm">-/</span>

<span class="c1">-- but</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">P</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">:</span> <span class="n">P</span> <span class="bp">∨</span> <span class="n">false</span> <span class="bp">↔</span> <span class="n">P</span> <span class="bp">∨</span> <span class="n">false</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="c1">-- fails</span>
</code></pre></div>
<p>Lean 3 <code>simp</code> is doing some kind of magic. Is it trying <code>refl</code> if a rewrite succeeds or something?</p>



<a name="314689826"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314689826" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314689826">(Dec 08 2022 at 14:37)</a>:</h4>
<p>It's strange because <code>P ∨ false ↔ P ∨ false</code> isn't even true by refl!</p>



<a name="314689940"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314689940" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314689940">(Dec 08 2022 at 14:37)</a>:</h4>
<p>Or more precisely, it's true <code>by refl</code> but not with <code>rfl</code>.  Maybe that's an important difference.</p>



<a name="314690045"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314690045" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314690045">(Dec 08 2022 at 14:38)</a>:</h4>
<p>It's true by <a href="https://leanprover-community.github.io/mathlib_docs/find/iff.rfl">docs#iff.rfl</a></p>



<a name="314690117"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314690117" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314690117">(Dec 08 2022 at 14:38)</a>:</h4>
<p>Maybe a missing <code>@[refl]</code> tag on <code>Iff.rfl</code>?</p>



<a name="314690217"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314690217" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314690217">(Dec 08 2022 at 14:38)</a>:</h4>
<p><del>Oh i guess not, because <code>refl</code> works here.</del> Sorry, got Lean 3 and Lean 4 confused.</p>



<a name="314690324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314690324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314690324">(Dec 08 2022 at 14:39)</a>:</h4>
<p>I think that lean 3 <code>rw</code> tries tactic <code>refl</code> if it succeeds.</p>



<a name="314690679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314690679" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314690679">(Dec 08 2022 at 14:41)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">P</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">:</span> <span class="n">P</span> <span class="bp">∨</span> <span class="n">False</span> <span class="bp">↔</span> <span class="n">P</span> <span class="bp">∨</span> <span class="n">False</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">rfl</span>
</code></pre></div>
<p>fails in Lean 4, but</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">P</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">:</span> <span class="n">P</span> <span class="bp">∨</span> <span class="n">false</span> <span class="bp">↔</span> <span class="n">P</span> <span class="bp">∨</span> <span class="n">false</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">refl</span>
</code></pre></div>
<p>succeeds in Lean 3.</p>



<a name="314695212"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314695212" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314695212">(Dec 08 2022 at 15:01)</a>:</h4>
<p>Regarding the initial issue of rewriting under binders: the minimised example in the github issue doesn't work in lean 3 either without imports. In fact it seems that <code>import logic.basic</code> changes the behaviour of <code>simp only</code>. This surprised me! Lean 3 code:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">logic.basic</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">p</span><span class="o">)</span> <span class="o">:</span>
    <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">p</span><span class="o">),</span> <span class="n">q</span> <span class="n">h2</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">h</span> <span class="o">:=</span> <span class="kd">by</span> <span class="o">{</span>
  <span class="k">have</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">=</span> <span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">h</span><span class="o">],</span>
                   <span class="c1">-- goal currently  `⊢ (∀ (h2 : p), q h2) ↔ q h`</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">foo</span><span class="o">],</span> <span class="c1">-- goal changes to `⊢ (∀ (h : true), q _) ↔ q h`</span>
  <span class="gr">sorry</span><span class="o">,</span>
    <span class="o">}</span>
</code></pre></div>
<p>If you comment out the mathlib3 import, <code>simp only [foo]</code> fails to make progress. So the <em>mathlib import</em> is changing the behaviour of <code>simp only</code>.  How?? Note that this means that the original issue in this conversation might not be a Lean 4 issue at all, perhaps mathlib3 is doing something clever which mathlib4 isn't doing. Note in particular that the claim in the lean 4 issue that lean 3 does something different is incorrect as it stands, and also the original issue Chris posted is behaving the same way in bare lean 3 and bare lean 4; it's only when mathlib gets involved that <code>simp only</code> becomes more powerful in lean 3.</p>



<a name="314696547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314696547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314696547">(Dec 08 2022 at 15:07)</a>:</h4>
<p>Got it: (again this is Lean 3 code)</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c1">-- comment out this lemma to make `simp only [foo]` fail below</span>
<span class="kd">@[congr]</span> <span class="kd">lemma</span> <span class="n">forall_prop_congr'</span> <span class="o">{</span><span class="n">p</span> <span class="n">p'</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">q</span> <span class="n">q'</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span>
  <span class="o">(</span><span class="n">hq</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">h</span><span class="o">,</span> <span class="n">q</span> <span class="n">h</span> <span class="bp">↔</span> <span class="n">q'</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">↔</span> <span class="n">p'</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">h</span><span class="o">,</span> <span class="n">q</span> <span class="n">h</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">∀</span> <span class="n">h</span> <span class="o">:</span> <span class="n">p'</span><span class="o">,</span> <span class="n">q'</span> <span class="o">(</span><span class="n">hp.2</span> <span class="n">h</span><span class="o">)</span> <span class="o">:=</span>
<span class="gr">sorry</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">p</span><span class="o">)</span> <span class="o">:</span>
    <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">p</span><span class="o">),</span> <span class="n">q</span> <span class="n">h2</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">h</span> <span class="o">:=</span> <span class="kd">by</span> <span class="o">{</span>
  <span class="k">have</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">=</span> <span class="n">true</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">h</span><span class="o">],</span>
                   <span class="c1">-- goal currently  `⊢ (∀ (h2 : p), q h2) ↔ q h`</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">foo</span><span class="o">],</span> <span class="c1">-- goal changes to `⊢ (∀ (h : true), q _) ↔ q h`</span>
  <span class="gr">sorry</span><span class="o">,</span>
    <span class="o">}</span>
</code></pre></div>
<p>So adding a <code>congr</code> lemma can change the behaviour of <code>simp only</code> in Lean 3 and this is perhaps the real cause of the original issue.</p>



<a name="314697087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314697087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314697087">(Dec 08 2022 at 15:09)</a>:</h4>
<p>Nice detective work.  Inter alia, you're saying that my issue is not related to Jakob's issue, right?</p>



<a name="314697499"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314697499" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314697499">(Dec 08 2022 at 15:11)</a>:</h4>
<p>Tactic <code>rfl</code> in Lean 4 only tries <code>eq.refl</code> because it was written before the <code>@[refl]</code> attribute. I haven't got back to your issue yet but I'll get there :-)</p>



<a name="314697773"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314697773" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314697773">(Dec 08 2022 at 15:12)</a>:</h4>
<p>Chris' original issue in Lean 3:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">forall_true_left</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">true</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">p</span> <span class="n">x</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">p</span> <span class="n">true.intro</span> <span class="o">:=</span>
<span class="gr">sorry</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">p</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">p</span><span class="o">),</span> <span class="n">q</span> <span class="n">h2</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">h</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">h</span><span class="o">,</span> <span class="n">forall_true_left</span><span class="o">]</span> <span class="c1">-- fails</span>


<span class="kd">@[congr]</span> <span class="kd">lemma</span> <span class="n">forall_prop_congr'</span> <span class="o">{</span><span class="n">p</span> <span class="n">p'</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">q</span> <span class="n">q'</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span>
  <span class="o">(</span><span class="n">hq</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">h</span><span class="o">,</span> <span class="n">q</span> <span class="n">h</span> <span class="bp">↔</span> <span class="n">q'</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">↔</span> <span class="n">p'</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">h</span><span class="o">,</span> <span class="n">q</span> <span class="n">h</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">∀</span> <span class="n">h</span> <span class="o">:</span> <span class="n">p'</span><span class="o">,</span> <span class="n">q'</span> <span class="o">(</span><span class="n">hp.2</span> <span class="n">h</span><span class="o">)</span> <span class="o">:=</span>
<span class="gr">sorry</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">p</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">p</span><span class="o">),</span> <span class="n">q</span> <span class="n">h2</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">h</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">h</span><span class="o">,</span> <span class="n">forall_true_left</span><span class="o">]</span> <span class="c1">-- works</span>
</code></pre></div>



<a name="314697783"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314697783" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314697783">(Dec 08 2022 at 15:12)</a>:</h4>
<p>16 messages were moved here from <a class="stream-topic" data-stream-id="287929" href="/#narrow/stream/287929-mathlib4/topic/Difference.20in.20.02klzzwxh.3A0000.03.20behaviour">#mathlib4 &gt; Difference in <code>simp</code> behaviour</a> by <span class="user-mention silent" data-user-id="260507">Heather Macbeth</span>.</p>



<a name="314697784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314697784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314697784">(Dec 08 2022 at 15:12)</a>:</h4>
<p>16 messages were moved from this topic to <a class="stream-topic" data-stream-id="287929" href="/#narrow/stream/287929-mathlib4/topic/.02klzzwxh.3A0000.03.20.28or.20.02klzzwxh.3A0001.03.3F.29.20difference.20Lean.203.2F4">#mathlib4 &gt; <code>simp</code> (or <code>refl</code>?) difference Lean 3/4</a> by <span class="user-mention silent" data-user-id="260507">Heather Macbeth</span>.</p>



<a name="314698128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314698128" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314698128">(Dec 08 2022 at 15:14)</a>:</h4>
<p>OK, I think I disaggregated the messages :)</p>



<a name="314698333"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314698333" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314698333">(Dec 08 2022 at 15:15)</a>:</h4>
<p>So do we want to be tagging every <code>congr</code> lemma in mathlib4 with <code>simp</code>?  Or is there a better fix?</p>



<a name="314698458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314698458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314698458">(Dec 08 2022 at 15:15)</a>:</h4>
<p>What is weirding me out is that this congr lemma is changing the behaviour of simp <em>only</em>!</p>



<a name="314698730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314698730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314698730">(Dec 08 2022 at 15:17)</a>:</h4>
<p>From mathlib4:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c1">-- Porting note: `@[congr]` commented out for now.</span>
<span class="c1">-- @[congr]</span>
<span class="kd">theorem</span> <span class="n">forall_prop_congr'</span> <span class="o">{</span><span class="n">p</span> <span class="n">p'</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">q</span> <span class="n">q'</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">(</span><span class="n">hq</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">h</span><span class="o">,</span> <span class="n">q</span> <span class="n">h</span> <span class="bp">↔</span> <span class="n">q'</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">↔</span> <span class="n">p'</span><span class="o">)</span> <span class="o">:</span>
    <span class="o">(</span><span class="bp">∀</span> <span class="n">h</span><span class="o">,</span> <span class="n">q</span> <span class="n">h</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">∀</span> <span class="n">h</span> <span class="o">:</span> <span class="n">p'</span><span class="o">,</span> <span class="n">q'</span> <span class="o">(</span><span class="n">hp.2</span> <span class="n">h</span><span class="o">)</span> <span class="o">:=</span>
  <span class="n">propext</span> <span class="o">(</span><span class="n">forall_prop_congr</span> <span class="n">hq</span> <span class="n">hp</span><span class="o">)</span>
</code></pre></div>
<p>;-)</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">attribute</span> <span class="o">[</span><span class="n">congr</span><span class="o">]</span> <span class="n">forall_prop_congr'</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">invalid 'congr' theorem, equality left/right-hand sides must be applications of the same function</span>
<span class="cm">  (∀ (h : ?p), ?q h) = ∀ (h : ?p'), ?q' (_ : ?p)</span>
<span class="cm">-/</span>
</code></pre></div>
<p>:-(</p>



<a name="314700475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314700475" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314700475">(Dec 08 2022 at 15:25)</a>:</h4>
<p>congr lemmas are not selected by simp only, it always uses all of them</p>



<a name="314701330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314701330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314701330">(Dec 08 2022 at 15:29)</a>:</h4>
<p>Do you have any idea why we can't tag <code>forall_prop_congr'</code> with <code>@[congr]</code> in Lean 4 whereas we could in Lean 3? Are we doomed to a life of <code>simp [...] with lean_3_congr_simps_which_arent_congr_in_lean_4</code>?</p>



<a name="314701898"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314701898" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314701898">(Dec 08 2022 at 15:31)</a>:</h4>
<p>because no one has filed a bug report for this yet</p>



<a name="314701964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314701964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314701964">(Dec 08 2022 at 15:31)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c1">-- lean 3</span>

<span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">forall_true_left</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">true</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">p</span> <span class="n">x</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">p</span> <span class="n">true.intro</span> <span class="o">:=</span>
<span class="gr">sorry</span>

<span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">forall_prop_congr'</span> <span class="o">{</span><span class="n">p</span> <span class="n">p'</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">q</span> <span class="n">q'</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span>
  <span class="o">(</span><span class="n">hq</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">h</span><span class="o">,</span> <span class="n">q</span> <span class="n">h</span> <span class="bp">↔</span> <span class="n">q'</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">↔</span> <span class="n">p'</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">h</span><span class="o">,</span> <span class="n">q</span> <span class="n">h</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">∀</span> <span class="n">h</span> <span class="o">:</span> <span class="n">p'</span><span class="o">,</span> <span class="n">q'</span> <span class="o">(</span><span class="n">hp.2</span> <span class="n">h</span><span class="o">)</span> <span class="o">:=</span>
<span class="gr">sorry</span>

<span class="c1">-- uncomment to fix</span>
<span class="c1">-- attribute [congr] forall_prop_congr'</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">p</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">p</span><span class="o">),</span> <span class="n">q</span> <span class="n">h2</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">h</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">h</span><span class="o">,</span> <span class="n">forall_true_left</span><span class="o">,</span> <span class="n">forall_prop_congr'</span><span class="o">]</span> <span class="c1">-- still fails</span>
</code></pre></div>



<a name="314702068"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314702068" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314702068">(Dec 08 2022 at 15:32)</a>:</h4>
<p>It's more than "just add this as a <code>simp</code> lemma"</p>



<a name="314702282"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314702282" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314702282">(Dec 08 2022 at 15:33)</a>:</h4>
<p>yeah simp doesn't take congr lemmas as input at all</p>



<a name="314702285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314702285" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314702285">(Dec 08 2022 at 15:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour/near/314701898">said</a>:</p>
<blockquote>
<p>because no one has filed a bug report for this yet</p>
</blockquote>
<p>I added some comments at <a href="https://github.com/leanprover/lean4/issues/1926">https://github.com/leanprover/lean4/issues/1926</a> -- does that count as filing a bug report?</p>



<a name="314702347"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314702347" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314702347">(Dec 08 2022 at 15:33)</a>:</h4>
<p>if you put them in the simp list they will be treated as simp lemmas, not congr lemmas</p>



<a name="314702677"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314702677" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314702677">(Dec 08 2022 at 15:35)</a>:</h4>
<p>I think so... you just have to make sure that the issue being solved implies this problem is also solved</p>



<a name="314702693"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314702693" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314702693">(Dec 08 2022 at 15:35)</a>:</h4>
<p>because leo likes closing issues :)</p>



<a name="314706365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314706365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314706365">(Dec 08 2022 at 15:53)</a>:</h4>
<p>Who doesn't?</p>



<a name="314878843"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/314878843" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#314878843">(Dec 09 2022 at 11:58)</a>:</h4>
<p>As soon as I find the time I'll try to see what happens if one just disables the check <a href="https://github.com/leanprover/lean4/blob/7034e64b4fcc0dada766c176d6aa748c71d05a50/src/Lean/Meta/Tactic/Simp/SimpCongrTheorems.lean#L59">here</a> which prevents <code>forall_prop_congr'</code> to be marked as <code>[congr]</code>...</p>



<a name="315274019"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315274019" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315274019">(Dec 12 2022 at 01:20)</a>:</h4>
<p><span class="user-mention" data-user-id="110789">@Jakob von Raumer</span>, I disabled it in a branch: <a href="https://github.com/leanprover/lean4/compare/master...semorrison:lean4:disable_congr_check?expand=1">https://github.com/leanprover/lean4/compare/master...semorrison:lean4:disable_congr_check?expand=1</a></p>
<p>We would need to include a test including <code>@[congr] theorem forall_prop_congr` </code>.</p>



<a name="315275691"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315275691" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315275691">(Dec 12 2022 at 01:46)</a>:</h4>
<p>It's funny that for most purposes, <code>∀</code> behaves like a normal function <code>Forall : (α : Type) → (α → Prop) → Prop</code></p>



<a name="315276113"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315276113" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315276113">(Dec 12 2022 at 01:54)</a>:</h4>
<p>I added the test, which failed:</p>



<a name="315276141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315276141" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315276141">(Dec 12 2022 at 01:54)</a>:</h4>
<p><a href="https://github.com/leanprover/lean4/pull/1942">https://github.com/leanprover/lean4/pull/1942</a></p>



<a name="315276158"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315276158" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315276158">(Dec 12 2022 at 01:54)</a>:</h4>
<p>Oh, that's unfortunate, closing the PR deleted the CI outputs?</p>



<a name="315276213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315276213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315276213">(Dec 12 2022 at 01:55)</a>:</h4>
<p>Ah, here it is:</p>



<a name="315276214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315276214" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315276214">(Dec 12 2022 at 01:55)</a>:</h4>
<p><a href="https://github.com/leanprover/lean4/actions/runs/3671852401/jobs/6207473096#step:11:1914">https://github.com/leanprover/lean4/actions/runs/3671852401/jobs/6207473096#step:11:1914</a></p>



<a name="315276230"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315276230" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315276230">(Dec 12 2022 at 01:55)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">050441</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span>  <span class="mi">664</span><span class="bp">/</span><span class="mi">1623</span> <span class="n">Test</span>  <span class="bp">#</span><span class="mi">664</span><span class="o">:</span> <span class="n">leanruntest_1926.lean</span> <span class="bp">.....................................***</span><span class="n">Failed</span>    <span class="mi">0</span><span class="bp">.</span><span class="mi">13</span> <span class="n">sec</span>
<span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">000713</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span> <span class="n">Unexpected</span> <span class="n">return</span> <span class="n">code</span> <span class="mi">1</span> <span class="n">executing</span> <span class="bp">'</span><span class="n">lean</span> <span class="bp">-</span><span class="n">j</span> <span class="mi">0</span> <span class="bp">-</span><span class="n">Dlinter.all</span><span class="bp">=</span><span class="n">false</span> <span class="mi">1926</span><span class="bp">.</span><span class="n">lean'</span><span class="bp">;</span> <span class="n">expected</span> <span class="mi">0</span><span class="bp">.</span> <span class="n">Output</span><span class="o">:</span>
<span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">000481</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span> <span class="mi">1926</span><span class="bp">.</span><span class="n">lean</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">declaration</span> <span class="n">uses</span> <span class="bp">'</span><span class="gr">sorry</span><span class="bp">'</span>
<span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">000441</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span> <span class="mi">1926</span><span class="bp">.</span><span class="n">lean</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">declaration</span> <span class="n">uses</span> <span class="bp">'</span><span class="gr">sorry</span><span class="bp">'</span>
<span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">000451</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span> <span class="mi">1926</span><span class="bp">.</span><span class="n">lean</span><span class="o">:</span><span class="mi">7</span><span class="o">:</span><span class="mi">11</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">invalid</span> <span class="bp">'</span><span class="n">congr'</span> <span class="kd">theorem</span><span class="o">,</span> <span class="n">argument</span> <span class="bp">#</span><span class="mi">1</span> <span class="n">of</span> <span class="kd">parameter</span> <span class="bp">#</span><span class="mi">5</span> <span class="n">contains</span> <span class="n">unresolved</span> <span class="kd">parameter</span>
<span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">000655</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span>   <span class="bp">?</span><span class="n">p</span>
<span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">000768</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span> <span class="mi">1926</span><span class="bp">.</span><span class="n">lean</span><span class="o">:</span><span class="mi">11</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">unsolved</span> <span class="n">goals</span>
<span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">000384</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span> <span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span>
<span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">000408</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span> <span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span>
<span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">000429</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span> <span class="n">h</span> <span class="o">:</span> <span class="n">p</span>
<span class="o">[</span><span class="mi">02</span><span class="o">:</span><span class="mi">15</span> <span class="o">(</span><span class="mi">00</span><span class="bp">.</span><span class="mi">000446</span><span class="o">)]</span> <span class="n">lean</span><span class="bp">-</span><span class="n">test</span><span class="bp">-</span><span class="n">stage1</span><span class="bp">&gt;</span> <span class="bp">⊢</span> <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">p</span><span class="o">),</span> <span class="n">q</span> <span class="n">h2</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">h</span>
</code></pre></div>



<a name="315276285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315276285" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315276285">(Dec 12 2022 at 01:56)</a>:</h4>
<p>So there's still a later step where this lemma would be rejected by <code>@[congr]</code>.</p>



<a name="315328702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315328702" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315328702">(Dec 12 2022 at 10:09)</a>:</h4>
<p>Would this not be a way around it?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">propForall</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span> <span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">q</span> <span class="n">x</span>

<span class="kd">@[simp]</span> <span class="kd">theorem</span> <span class="n">forall_eq_forall_iff</span> <span class="o">{</span><span class="n">p</span> <span class="n">p'</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">q'</span> <span class="o">:</span> <span class="n">p'</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">:</span>
  <span class="o">((</span><span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">q</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">q'</span> <span class="n">x</span><span class="o">))</span> <span class="bp">↔</span> <span class="n">propForall</span> <span class="n">q</span> <span class="bp">=</span> <span class="n">propForall</span> <span class="n">q'</span> <span class="o">:=</span>
<span class="o">⟨(</span><span class="bp">·</span><span class="o">),</span> <span class="o">(</span><span class="bp">·</span><span class="o">)⟩</span>

<span class="kd">@[congr]</span> <span class="kd">theorem</span> <span class="n">propForall_prop_congr'</span> <span class="o">{</span><span class="n">p</span> <span class="n">p'</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">q</span> <span class="n">q'</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span>
  <span class="o">(</span><span class="n">hq</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">h</span><span class="o">,</span> <span class="n">q</span> <span class="n">h</span> <span class="bp">↔</span> <span class="n">q'</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">↔</span> <span class="n">p'</span><span class="o">)</span> <span class="o">:</span>
    <span class="n">propForall</span> <span class="n">q</span> <span class="bp">=</span> <span class="n">propForall</span> <span class="o">(</span><span class="k">fun</span> <span class="n">h</span> <span class="bp">=&gt;</span> <span class="n">q'</span> <span class="o">(</span><span class="n">hp.2</span> <span class="n">h</span><span class="o">))</span> <span class="o">:=</span>
<span class="gr">sorry</span> <span class="c1">--propext (forall_prop_congr hq hp)</span>
</code></pre></div>



<a name="315329500"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315329500" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315329500">(Dec 12 2022 at 10:13)</a>:</h4>
<p>I'm out of time for now: would you mind editing my PR to use that test?</p>



<a name="315330671"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315330671" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315330671">(Dec 12 2022 at 10:20)</a>:</h4>
<p>Will do</p>



<a name="315330684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315330684" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315330684">(Dec 12 2022 at 10:20)</a>:</h4>
<p>So this works:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">propForall</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span> <span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">q</span> <span class="n">x</span>

<span class="kd">@[simp]</span> <span class="kd">theorem</span> <span class="n">forall_eq_propForall</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">x</span><span class="o">,</span> <span class="n">q</span> <span class="n">x</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">propForall</span> <span class="n">q</span> <span class="o">:=</span>
<span class="n">Iff.rfl</span>

<span class="kd">@[simp]</span> <span class="kd">theorem</span> <span class="n">propForall_true_left</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">True</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">),</span> <span class="n">propForall</span> <span class="n">p</span> <span class="bp">↔</span> <span class="n">p</span> <span class="n">True.intro</span> <span class="o">:=</span>
<span class="gr">sorry</span>

<span class="kd">@[congr]</span> <span class="kd">theorem</span> <span class="n">propForall_prop_congr'</span> <span class="o">{</span><span class="n">p</span> <span class="n">p'</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">q</span> <span class="n">q'</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span>
  <span class="o">(</span><span class="n">hq</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">h</span><span class="o">,</span> <span class="n">q</span> <span class="n">h</span> <span class="bp">↔</span> <span class="n">q'</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="n">hp</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">↔</span> <span class="n">p'</span><span class="o">)</span> <span class="o">:</span>
    <span class="n">propForall</span> <span class="n">q</span> <span class="bp">=</span> <span class="n">propForall</span> <span class="o">(</span><span class="k">fun</span> <span class="n">h</span> <span class="bp">=&gt;</span> <span class="n">q'</span> <span class="o">(</span><span class="n">hp.2</span> <span class="n">h</span><span class="o">))</span> <span class="o">:=</span>
<span class="gr">sorry</span> <span class="c1">--propext (forall_prop_congr hq hp)</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">q</span> <span class="o">:</span> <span class="n">p</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">p</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="bp">∀</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="n">p</span><span class="o">),</span> <span class="n">q</span> <span class="n">h2</span><span class="o">)</span> <span class="bp">↔</span> <span class="n">q</span> <span class="n">h</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">forall_eq_propForall</span><span class="o">,</span> <span class="n">h</span><span class="o">,</span> <span class="n">propForall_true_left</span><span class="o">,</span> <span class="n">iff_self</span><span class="o">]</span>
</code></pre></div>



<a name="315330803"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315330803" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315330803">(Dec 12 2022 at 10:21)</a>:</h4>
<p>So maybe this is better than tweaking <code>SimpCongrTheorems.lean</code>? I don't know <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="315496752"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315496752" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315496752">(Dec 13 2022 at 01:37)</a>:</h4>
<p>Then you're leaving <code>propForall</code> in people's goal after non-terminal <code>simp</code>. I know non-terminal <code>simp</code> is bad but it's still not ideal.</p>



<a name="315539004"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/315539004" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#315539004">(Dec 13 2022 at 08:57)</a>:</h4>
<p>Yea, would be better if we could engineer it in a way that only triggers the <code>[simp]</code> if the <code>[congr]</code> is applicable</p>



<a name="316011706"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Difference%20in%20%60simp%60%20behaviour/near/316011706" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Difference.20in.20.60simp.60.20behaviour.html#316011706">(Dec 15 2022 at 11:08)</a>:</h4>
<p>As a temporary hack for when these come up, I've been using the lemmas <code>forall_prop_of_true</code> and <code>forall_prop_of_false</code></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>