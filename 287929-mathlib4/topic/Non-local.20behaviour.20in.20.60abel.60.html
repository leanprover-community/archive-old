---
layout: archive
title: Zulip Chat Archive
permalink: /stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/index.html">mathlib4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html">Non-local behaviour in `abel`</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="319724302"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319724302" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319724302">(Jan 06 2023 at 06:19)</a>:</h4>
<p>I am experiencing seemingly non-local behaviour in <code>abel</code>, and wondered if anyone else could reproduce it.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Tactic.Abel</span>

<span class="kd">variable</span> <span class="o">[</span><span class="n">Ring</span> <span class="n">α</span><span class="o">]</span>

<span class="kd">lemma</span> <span class="n">foo</span> <span class="o">(</span><span class="n">a</span> <span class="n">c</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span>
    <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">abel</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hz</span> <span class="o">:</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">Int.cast</span> <span class="n">α</span> <span class="n">Ring.toIntCast</span> <span class="n">z</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hy</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
    <span class="bp">∃</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">,</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">))</span> <span class="bp">=</span> <span class="bp">↑</span><span class="n">z</span> <span class="o">:=</span> <span class="kd">by</span> <span class="c1">-- HERE</span>
  <span class="n">use</span> <span class="n">z</span> <span class="bp">-</span> <span class="n">y</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Nat.cast_succ</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Int.cast_sub</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hz</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hy</span><span class="o">]</span>
  <span class="n">exact</span> <span class="n">foo</span> <span class="n">a</span> <span class="n">c</span> <span class="n">f</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hz</span> <span class="o">:</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">Int.cast</span> <span class="n">α</span> <span class="n">Ring.toIntCast</span> <span class="n">z</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hy</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
    <span class="bp">∃</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">,</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">))</span> <span class="bp">=</span> <span class="n">z</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">use</span> <span class="n">z</span> <span class="bp">-</span> <span class="n">y</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Nat.cast_succ</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Int.cast_sub</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hz</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hy</span><span class="o">]</span>
  <span class="n">abel</span> <span class="c1">-- fails with "Try this ..."</span>
  <span class="n">done</span>
</code></pre></div>



<a name="319724375"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319724375" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319724375">(Jan 06 2023 at 06:20)</a>:</h4>
<p>Where marked <code>-- HERE</code>, change <code>↑z</code> to <code>z</code>.  On my machine this makes the failure in the <em>next</em> example go away.</p>



<a name="319831213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319831213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319831213">(Jan 06 2023 at 17:56)</a>:</h4>
<p><span aria-label="ping pong" class="emoji emoji-1f3d3" role="img" title="ping pong">:ping_pong:</span> This behaviour persists for me today on fresh mathlib.  Can anyone else reproduce it?</p>



<a name="319838925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319838925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319838925">(Jan 06 2023 at 18:38)</a>:</h4>
<p>I can reproduce. Whatever is going on?</p>



<a name="319839052"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319839052" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319839052">(Jan 06 2023 at 18:38)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> any ideas?  This bug is pretty weird ...</p>



<a name="319839424"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319839424" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319839424">(Jan 06 2023 at 18:41)</a>:</h4>
<p>I tracked it down as a test case for something experienced by <span class="user-mention" data-user-id="268315">@Anatole Dedecker</span> and me in <a href="https://github.com/leanprover-community/mathlib4/pull/1304">mathlib4#1304</a>.</p>



<a name="319848039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319848039" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319848039">(Jan 06 2023 at 19:30)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Tactic.Abel</span>

<span class="kd">variable</span> <span class="o">[</span><span class="n">Ring</span> <span class="n">α</span><span class="o">]</span>

<span class="c1">-- -- the evil example: uncomment me to break your definition!</span>
<span class="c1">-- example (a : α) (c : ℕ) (y z : ℤ) (f : α → α) :</span>
<span class="c1">--     f a * ↑c + f a - f (a * ↑c + a) = ↑(z - y) := by</span>
<span class="c1">--   sorry</span>

<span class="kd">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hz</span> <span class="o">:</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">Int.cast</span> <span class="n">α</span> <span class="n">Ring.toIntCast</span> <span class="n">z</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hy</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
    <span class="bp">∃</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">,</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">))</span> <span class="bp">=</span> <span class="n">z</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">use</span> <span class="n">z</span> <span class="bp">-</span> <span class="n">y</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Nat.cast_succ</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Int.cast_sub</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hz</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hy</span><span class="o">]</span>
  <span class="n">abel</span>
  <span class="n">done</span>
</code></pre></div>
<p>Live streaming on the discord</p>



<a name="319849262"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319849262" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319849262">(Jan 06 2023 at 19:37)</a>:</h4>
<p>this can't happen, right?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Tactic.Abel</span>

<span class="kd">variable</span> <span class="o">[</span><span class="n">Ring</span> <span class="n">α</span><span class="o">]</span>

<span class="c1">-- -- the evil example: uncomment me to break your definition!</span>
<span class="c1">-- example (a : α) (c : ℕ) (y z : ℤ) (f : α → α) :</span>
<span class="c1">--     f a * ↑c + f a - f (a * ↑c + a) = ↑(z - y) := by</span>
<span class="c1">--   sorry</span>

<span class="c1">-- -- I am the antidote -- uncomment me and your definition will work again!</span>
<span class="c1">-- def antidote (a : α) (c : ℕ) (y z : ℤ) (f : α → α)</span>
<span class="c1">--     (hy: f (a * ↑c + a) - f (a * ↑c) - f a = ↑y)</span>
<span class="c1">--     (hz: f a * ↑c - f (a * ↑c) = ↑z) :</span>
<span class="c1">--     f a * ↑c + f a - f (a * ↑c + a) = ↑(z - y) := by</span>
<span class="c1">--    rw [Int.cast_sub, ← hz, ← hy]</span>
<span class="c1">--    abel</span>

<span class="kd">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hz</span> <span class="o">:</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">Int.cast</span> <span class="n">α</span> <span class="n">Ring.toIntCast</span> <span class="n">z</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hy</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
    <span class="bp">∃</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">,</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">))</span> <span class="bp">=</span> <span class="n">z</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">use</span> <span class="n">z</span> <span class="bp">-</span> <span class="n">y</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Nat.cast_succ</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Int.cast_sub</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hz</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hy</span><span class="o">]</span>
  <span class="n">abel</span>
  <span class="n">done</span>
</code></pre></div>



<a name="319849443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319849443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319849443">(Jan 06 2023 at 19:38)</a>:</h4>
<p>I'm assuming others can reproduce. I'm on Ubuntu 20.04.5 LTS</p>



<a name="319849600"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319849600" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319849600">(Jan 06 2023 at 19:38)</a>:</h4>
<p><code>Lean (version 4.0.0-nightly-2023-01-04, commit 905d3204ae08, Release)</code></p>



<a name="319850527"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319850527" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319850527">(Jan 06 2023 at 19:44)</a>:</h4>
<p>I can reproduce the problem too.</p>



<a name="319850870"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319850870" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319850870">(Jan 06 2023 at 19:46)</a>:</h4>
<p>Same behavior with just <code>able_nf</code>, with narrows it down a bit I think.</p>



<a name="319853779"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319853779" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319853779">(Jan 06 2023 at 20:03)</a>:</h4>
<p>I'm trying looking at the output after doing</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">trace.abel</span> <span class="n">true</span>
<span class="kd">set_option</span> <span class="n">trace.abel.detail</span> <span class="n">true</span>
</code></pre></div>



<a name="319853932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319853932" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319853932">(Jan 06 2023 at 20:04)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Tactic.Abel</span>

<span class="kd">variable</span> <span class="o">[</span><span class="n">Ring</span> <span class="n">α</span><span class="o">]</span>

<span class="c1">-- theorem uncommenting_me_breaks_foo (a : α) (c : ℕ) (f : α → α) : f a * ↑c + f a - f (a * ↑c + a)</span>
<span class="c1">--     = f a * ↑c - f (a * ↑c) - (f (a * ↑c + a) - f (a * ↑c) - f a) :=</span>
<span class="c1">-- Eq.trans</span>
<span class="c1">--   (sorry)</span>
<span class="c1">--   (Eq.symm</span>
<span class="c1">--     (Mathlib.Tactic.Abel.unfold_sub (f a * ↑c - f (a * ↑c)) (f (a * ↑c + a) - f (a * ↑c) - f a)</span>
<span class="c1">--       (Mathlib.Tactic.Abel.termg (-1) (f (a * ↑c + a))</span>
<span class="c1">--         (Mathlib.Tactic.Abel.termg 1 (f a) (Mathlib.Tactic.Abel.termg 1 (f a * ↑c) 0)))</span>
<span class="c1">--       (Mathlib.Tactic.Abel.subst_into_addg (f a * ↑c - f (a * ↑c)) (-(f (a * ↑c + a) - f (a * ↑c) - f a))</span>
<span class="c1">--         (Mathlib.Tactic.Abel.termg (-1) (f (a * ↑c)) (Mathlib.Tactic.Abel.termg 1 (f a * ↑c) 0))</span>
<span class="c1">--         (Mathlib.Tactic.Abel.termg (-1) (f (a * ↑c + a))</span>
<span class="c1">--           (Mathlib.Tactic.Abel.termg 1 (f (a * ↑c)) (Mathlib.Tactic.Abel.termg 1 (f a) 0)))</span>
<span class="c1">--         (Mathlib.Tactic.Abel.termg (-1) (f (a * ↑c + a))</span>
<span class="c1">--           (Mathlib.Tactic.Abel.termg 1 (f a) (Mathlib.Tactic.Abel.termg 1 (f a * ↑c) 0)))</span>
<span class="c1">--         (Mathlib.Tactic.Abel.unfold_sub (f a * ↑c) (f (a * ↑c))</span>
<span class="c1">--           (Mathlib.Tactic.Abel.termg (-1) (f (a * ↑c)) (Mathlib.Tactic.Abel.termg 1 (f a * ↑c) 0))</span>
<span class="c1">--           (Mathlib.Tactic.Abel.subst_into_addg (f a * ↑c) (-f (a * ↑c)) (Mathlib.Tactic.Abel.termg 1 (f a * ↑c) 0)</span>
<span class="c1">--             (Mathlib.Tactic.Abel.termg (-1) (f (a * ↑c)) 0)</span>
<span class="c1">--             (Mathlib.Tactic.Abel.termg (-1) (f (a * ↑c)) (Mathlib.Tactic.Abel.termg 1 (f a * ↑c) 0))</span>
<span class="c1">--             (Mathlib.Tactic.Abel.term_atomg (f a * ↑c))</span>
<span class="c1">--             (Mathlib.Tactic.Abel.subst_into_negg (f (a * ↑c)) (Mathlib.Tactic.Abel.termg 1 (f (a * ↑c)) 0)</span>
<span class="c1">--               (Mathlib.Tactic.Abel.termg (-1) (f (a * ↑c)) 0) (Mathlib.Tactic.Abel.term_atomg (f (a * ↑c)))</span>
<span class="c1">--               (Mathlib.Tactic.Abel.term_neg 1 (f (a * ↑c)) 0 (-1) 0 (Eq.refl (-1)) neg_zero))</span>
<span class="c1">--             (Mathlib.Tactic.Abel.const_add_termg (Mathlib.Tactic.Abel.termg 1 (f a * ↑c) 0) (-1) (f (a * ↑c)) 0</span>
<span class="c1">--               (Mathlib.Tactic.Abel.termg 1 (f a * ↑c) 0) (add_zero (Mathlib.Tactic.Abel.termg 1 (f a * ↑c) 0)))))</span>
<span class="c1">--         (sorry)</span>
<span class="c1">--         (sorry))))</span>


<span class="kd">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hz</span> <span class="o">:</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">Int.cast</span> <span class="n">α</span> <span class="n">Ring.toIntCast</span> <span class="n">z</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hy</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
    <span class="bp">∃</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">,</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">))</span> <span class="bp">=</span> <span class="n">z</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">use</span> <span class="n">z</span> <span class="bp">-</span> <span class="n">y</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Nat.cast_succ</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Int.cast_sub</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hz</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hy</span><span class="o">]</span>
  <span class="n">abel</span>
  <span class="n">done</span>
</code></pre></div>
<p>I need to go now. I took the other route and tried to see which part of the term it was generating was causing the problem. Maybe the above helps? I need to go and make dinner for 4 now though, so I'll be gone a while.</p>



<a name="319854310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319854310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319854310">(Jan 06 2023 at 20:06)</a>:</h4>
<p>Last few things: when <code>abel</code> fails the goal becomes</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="bp">+</span> <span class="bp">-</span><span class="mi">1</span> <span class="bp">•</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">))</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">+</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="bp">-</span><span class="mi">1</span> <span class="bp">•</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">))</span>
</code></pre></div>
<p>so some <code>simp</code> lemma might have kicked in or not kicked in? And even better, <code>abel</code> suggests <code>abel_nf</code>, which closes the goal ;-)</p>



<a name="319868720"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319868720" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319868720">(Jan 06 2023 at 21:47)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Tactic.Abel</span>

<span class="kd">variable</span> <span class="o">[</span><span class="n">Ring</span> <span class="n">α</span><span class="o">]</span>

<span class="c1">-- theorem uncommenting_me_breaks_foo (x : α) :</span>
<span class="c1">--   -x = (-1 : ℤ) • (x) + (0 : α) := sorry</span>

<span class="kd">def</span> <span class="n">foo</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hz</span> <span class="o">:</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">Int.cast</span> <span class="n">α</span> <span class="n">Ring.toIntCast</span> <span class="n">z</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hy</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span>
    <span class="bp">∃</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℤ</span><span class="o">,</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="o">(</span><span class="n">Nat.succ</span> <span class="n">c</span><span class="o">))</span> <span class="bp">=</span> <span class="n">z</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">use</span> <span class="n">z</span> <span class="bp">-</span> <span class="n">y</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Nat.cast_succ</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">Int.cast_sub</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hz</span><span class="o">,</span> <span class="bp">←</span> <span class="n">hy</span><span class="o">]</span>
  <span class="n">abel</span>
  <span class="n">done</span>
</code></pre></div>



<a name="319869420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319869420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319869420">(Jan 06 2023 at 21:53)</a>:</h4>
<p>So <code>abel</code> seems to be using the theorem <code>uncommenting_me_breaks_foo</code>. It turns the goal</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span><span class="o">)</span>
</code></pre></div>
<p>into the goal</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="bp">+</span> <span class="bp">-</span><span class="mi">1</span> <span class="bp">•</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">))</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">+</span> <span class="o">(</span><span class="bp">-</span><span class="mi">1</span> <span class="bp">•</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">+</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span>
</code></pre></div>
<p>if <code>uncommenting_me_breaks_foo : -x = (-1 : ℤ) • (x) + (0 : α)</code> is declared, and then it gets lost. It would be interesting to check which tags <code>uncommenting_me_breaks_foo</code> has, I'm assuming none, but you never can tell with Lean 4. I think that now someone who knows something about <code>linarith</code> has to take over.</p>



<a name="319870039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319870039" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319870039">(Jan 06 2023 at 21:57)</a>:</h4>
<p>what does this have to do with <code>linarith</code>?</p>



<a name="319870193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319870193" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319870193">(Jan 06 2023 at 21:58)</a>:</h4>
<p>Probably a typo for <code>abel</code>?  <span class="user-mention" data-user-id="110038">@Kevin Buzzard</span></p>



<a name="319881310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319881310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319881310">(Jan 06 2023 at 23:31)</a>:</h4>
<p><code>abel</code>, unlike <code>ring</code>, does not use a list of atoms as state to deduplicate defeq terms, it uses <code>Expr.quickLt</code> which compares the hashes of the expressions. In particular, this makes it sensitive to changes in FVarId naming, which makes atom ordering nondeterministic. So this explains why a change in an unrelated <code>example</code> can cause the tactic to behave differently.</p>



<a name="319881404"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319881404" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319881404">(Jan 06 2023 at 23:32)</a>:</h4>
<p>What it doesn't explain is why it doesn't always find the proof, because even if atom ordering is nondeterministic it should still be consistent over a given run</p>



<a name="319881566"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319881566" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319881566">(Jan 06 2023 at 23:34)</a>:</h4>
<p>Here's the trace from the working invocation (edited for clarity):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">abel</span><span class="o">]</span> <span class="n">running</span> <span class="n">on</span> <span class="n">an</span> <span class="n">equality</span> <span class="bp">`</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span><span class="o">)</span><span class="bp">`.</span>

<span class="o">[</span><span class="n">abel</span><span class="o">]</span> <span class="n">found</span> <span class="n">a</span> <span class="n">proof</span> <span class="n">that</span> <span class="bp">`</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span>
    <span class="n">Mathlib.Tactic.Abel.termg</span> <span class="o">(</span><span class="bp">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">))</span>
      <span class="o">(</span><span class="n">Mathlib.Tactic.Abel.termg</span> <span class="mi">1</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="o">(</span><span class="n">Mathlib.Tactic.Abel.termg</span> <span class="mi">1</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">)</span> <span class="mi">0</span><span class="o">))</span><span class="bp">`</span>

<span class="o">[</span><span class="n">abel</span><span class="o">]</span> <span class="n">found</span> <span class="n">a</span> <span class="n">proof</span> <span class="n">that</span> <span class="bp">`</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span>
    <span class="n">Mathlib.Tactic.Abel.termg</span> <span class="o">(</span><span class="bp">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">))</span>
      <span class="o">(</span><span class="n">Mathlib.Tactic.Abel.termg</span> <span class="mi">1</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="o">(</span><span class="n">Mathlib.Tactic.Abel.termg</span> <span class="mi">1</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">)</span> <span class="mi">0</span><span class="o">))</span><span class="bp">`</span>

<span class="o">[</span><span class="n">abel</span><span class="o">]</span> <span class="n">verified</span> <span class="n">that</span> <span class="n">the</span> <span class="n">simplified</span> <span class="n">forms</span> <span class="n">are</span> <span class="n">identical</span>
</code></pre></div>
<p>and the trace from the failing version:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">abel</span><span class="o">]</span> <span class="n">running</span> <span class="n">on</span> <span class="n">an</span> <span class="n">equality</span> <span class="bp">`</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span><span class="o">)</span><span class="bp">`.</span>

<span class="o">[</span><span class="n">abel</span><span class="o">]</span> <span class="n">found</span> <span class="n">a</span> <span class="n">proof</span> <span class="n">that</span> <span class="bp">`</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span>
    <span class="n">Mathlib.Tactic.Abel.termg</span> <span class="mi">1</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span>
      <span class="o">(</span><span class="n">Mathlib.Tactic.Abel.termg</span> <span class="o">(</span><span class="bp">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">))</span> <span class="o">(</span><span class="n">Mathlib.Tactic.Abel.termg</span> <span class="mi">1</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">)</span> <span class="mi">0</span><span class="o">))</span><span class="bp">`</span>

<span class="o">[</span><span class="n">abel</span><span class="o">]</span> <span class="n">found</span> <span class="n">a</span> <span class="n">proof</span> <span class="n">that</span> <span class="bp">`</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="n">f</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span>
    <span class="n">Mathlib.Tactic.Abel.termg</span> <span class="mi">1</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span><span class="o">)</span>
      <span class="o">(</span><span class="n">Mathlib.Tactic.Abel.termg</span> <span class="mi">1</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">Mathlib.Tactic.Abel.termg</span> <span class="o">(</span><span class="bp">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="bp">↑</span><span class="n">c</span> <span class="bp">+</span> <span class="n">a</span><span class="o">))</span> <span class="mi">0</span><span class="o">))</span><span class="bp">`</span>
</code></pre></div>
<p>As you can see, the atom ordering is different in the two cases, but the weird part is that the atom ordering is different even just for the two sides of the second equation.</p>



<a name="319885841"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319885841" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319885841">(Jan 07 2023 at 00:24)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/pull/1394">mathlib4#1394</a></p>



<a name="319889163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/Non-local%20behaviour%20in%20%60abel%60/near/319889163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/Non-local.20behaviour.20in.20.60abel.60.html#319889163">(Jan 07 2023 at 01:00)</a>:</h4>
<p>Thank you Mario.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>