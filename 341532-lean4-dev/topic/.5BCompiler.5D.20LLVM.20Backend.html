---
layout: archive
title: Zulip Chat Archive
permalink: /stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/index.html">lean4 dev</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html">[Compiler] LLVM Backend</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="301563442"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/301563442" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#301563442">(Sep 30 2022 at 02:43)</a>:</h4>
<p>The previously working windows build for LLVM 14 fails on <a href="https://github.com/bollu/lean4/actions/runs/3155790042/jobs/5134833368#step:8:4066">LLVM 15</a>, this time thanks to not knowing <code>nullptr_t</code>?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">D</span><span class="o">:</span><span class="bp">/</span><span class="n">a</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">/</span><span class="kn">include</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">__memory</span><span class="bp">/</span><span class="n">unique_ptr.h</span><span class="o">:</span><span class="mi">594</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">unknown</span> <span class="n">type</span> <span class="n">name</span> <span class="bp">'</span><span class="n">nullptr_t'</span>
<span class="n">operator</span><span class="bp">==</span><span class="o">(</span><span class="n">const</span> <span class="n">unique_ptr</span><span class="bp">&lt;</span><span class="n">_T1</span><span class="o">,</span> <span class="n">_D1</span><span class="bp">&gt;&amp;</span> <span class="n">__x</span><span class="o">,</span> <span class="n">nullptr_t</span><span class="o">)</span> <span class="n">_NOEXCEPT</span>
</code></pre></div>



<a name="301563444"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/301563444" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#301563444">(Sep 30 2022 at 02:43)</a>:</h4>
<p>CC <span class="user-mention" data-user-id="122318">@Tobias Grosser</span></p>



<a name="301592564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/301592564" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#301592564">(Sep 30 2022 at 08:17)</a>:</h4>
<p>I've seen similarly puzzling errors before, it's usually due to (order of) include directories. The relevant setup line is <a href="https://github.com/leanprover/lean4/blob/9e6814b09e7ca9cdfbce219d6181ce5cf19cc63a/script/prepare-llvm-mingw.sh#L38">https://github.com/leanprover/lean4/blob/9e6814b09e7ca9cdfbce219d6181ce5cf19cc63a/script/prepare-llvm-mingw.sh#L38</a></p>



<a name="301656098"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/301656098" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#301656098">(Sep 30 2022 at 14:10)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I need another flag for the macOS build: <code>DLLVM_ENABLE_ZLIB=OFF</code>. I started a build against <code>bollu/lean-llvm</code>:<br>
<a href="https://github.com/bollu/lean-llvm/pull/5">https://github.com/bollu/lean-llvm/pull/5</a></p>
<p>The PR against <code>lean4/lean-llvm</code> is here: <a href="https://github.com/leanprover/lean-llvm/pull/6">https://github.com/leanprover/lean-llvm/pull/6</a></p>



<a name="301679714"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/301679714" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#301679714">(Sep 30 2022 at 15:55)</a>:</h4>
<p><span class="user-mention" data-user-id="130575">@Siddharth Bhat</span> As I've written before, there was a specific issue or feature that led me to include zlib. Unfortunately I don't remember the specifics.</p>



<a name="301682046"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/301682046" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#301682046">(Sep 30 2022 at 16:04)</a>:</h4>
<p>Ah, I see, so you'd like to keep <code>zlib</code> around. Very well, I'll investigate how we can get zlib working</p>



<a name="301701168"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/301701168" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#301701168">(Sep 30 2022 at 17:42)</a>:</h4>
<ul>
<li>nix - llvm 15 WIP  <a href="https://github.com/NixOS/nixpkgs/issues/191132">https://github.com/NixOS/nixpkgs/issues/191132</a></li>
<li>macos: zlib dependency (add to CMake?)</li>
<li>windows: <code>nullptr_t</code> error showed up suddenly (<a href="https://github.com/leanprover/lean4/actions/runs/3160293349/jobs/5144580974#step:8:3197">https://github.com/leanprover/lean4/actions/runs/3160293349/jobs/5144580974#step:8:3197</a>). </li>
<li>linux release: <em>should</em> work now (<code>llvm/lib</code> changed the shipping location of libraries like <code>libunwind</code>, so the loader was unable to find the dependency when we try to run <code>clang</code>.</li>
</ul>



<a name="301704791"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/301704791" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#301704791">(Sep 30 2022 at 18:02)</a>:</h4>
<p><strong>Plan for this week</strong></p>
<ul>
<li>See how Rust handles the pain of LLVM shipping.</li>
<li>Make slides for LLVM dev meeting in November. <strong>Everyone:</strong> If we have questions about how best to use LLVM in Lean, this is a great time to ask! I can add the questions to my slides, and chat with folks at <code>llvm-dev</code> for answers.</li>
<li>Get the builds working (<span class="user-mention" data-user-id="515083">@Tom</span>  's spare cycles for debugging the window failure is super appreciated!)</li>
</ul>



<a name="301925118"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/301925118" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#301925118">(Oct 02 2022 at 11:50)</a>:</h4>
<p>The <code>llvm-config</code> tool on macOS, when queried for system libraries, asks for <code>zstd</code> as well as <code>zlib</code>, and it's these dependencies which are breaking the macOS build.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="mi">2022</span><span class="bp">-</span><span class="mi">09</span><span class="bp">-</span><span class="mi">30</span><span class="n">T17</span><span class="o">:</span><span class="mi">04</span><span class="o">:</span><span class="mi">28</span><span class="bp">.</span><span class="mi">3690430</span><span class="n">Z</span> <span class="n">llvm</span><span class="bp">-</span><span class="n">config</span><span class="o">:</span> <span class="n">libdir</span> <span class="bp">'/</span><span class="n">Users</span><span class="bp">/</span><span class="n">runner</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib'</span> <span class="bp">|</span> <span class="n">ldflags</span> <span class="bp">''</span> <span class="bp">|</span> <span class="n">libs</span> <span class="bp">'-</span><span class="n">lLLVMWindowsManifest</span> <span class="bp">-</span><span class="n">lLLVMWindowsDriver</span> <span class="bp">-</span><span class="n">lLLVMXRay</span> <span class="bp">-</span><span class="n">lLLVMLibDriver</span> <span class="bp">-</span><span class="n">lLLVMDlltoolDriver</span> <span class="bp">-</span><span class="n">lLLVMCoverage</span> <span class="bp">-</span><span class="n">lLLVMLineEditor</span> <span class="bp">-</span><span class="n">lLLVMX86TargetMCA</span> <span class="bp">-</span><span class="n">lLLVMX86Disassembler</span> <span class="bp">-</span><span class="n">lLLVMX86AsmParser</span> <span class="bp">-</span><span class="n">lLLVMX86CodeGen</span> <span class="bp">-</span><span class="n">lLLVMX86Desc</span> <span class="bp">-</span><span class="n">lLLVMX86Info</span> <span class="bp">-</span><span class="n">lLLVMWebAssemblyDisassembler</span> <span class="bp">-</span><span class="n">lLLVMWebAssemblyAsmParser</span> <span class="bp">-</span><span class="n">lLLVMWebAssemblyCodeGen</span> <span class="bp">-</span><span class="n">lLLVMWebAssemblyDesc</span> <span class="bp">-</span><span class="n">lLLVMWebAssemblyUtils</span> <span class="bp">-</span><span class="n">lLLVMWebAssemblyInfo</span> <span class="bp">-</span><span class="n">lLLVMAArch64Disassembler</span> <span class="bp">-</span><span class="n">lLLVMAArch64AsmParser</span> <span class="bp">-</span><span class="n">lLLVMAArch64CodeGen</span> <span class="bp">-</span><span class="n">lLLVMAArch64Desc</span> <span class="bp">-</span><span class="n">lLLVMAArch64Utils</span> <span class="bp">-</span><span class="n">lLLVMAArch64Info</span> <span class="bp">-</span><span class="n">lLLVMOrcJIT</span> <span class="bp">-</span><span class="n">lLLVMMCJIT</span> <span class="bp">-</span><span class="n">lLLVMJITLink</span> <span class="bp">-</span><span class="n">lLLVMInterpreter</span> <span class="bp">-</span><span class="n">lLLVMExecutionEngine</span> <span class="bp">-</span><span class="n">lLLVMRuntimeDyld</span> <span class="bp">-</span><span class="n">lLLVMOrcTargetProcess</span> <span class="bp">-</span><span class="n">lLLVMOrcShared</span> <span class="bp">-</span><span class="n">lLLVMDWP</span> <span class="bp">-</span><span class="n">lLLVMDebugInfoGSYM</span> <span class="bp">-</span><span class="n">lLLVMOption</span> <span class="bp">-</span><span class="n">lLLVMObjectYAML</span> <span class="bp">-</span><span class="n">lLLVMObjCopy</span> <span class="bp">-</span><span class="n">lLLVMMCA</span> <span class="bp">-</span><span class="n">lLLVMMCDisassembler</span> <span class="bp">-</span><span class="n">lLLVMLTO</span> <span class="bp">-</span><span class="n">lLLVMPasses</span> <span class="bp">-</span><span class="n">lLLVMCFGuard</span> <span class="bp">-</span><span class="n">lLLVMCoroutines</span> <span class="bp">-</span><span class="n">lLLVMObjCARCOpts</span> <span class="bp">-</span><span class="n">lLLVMipo</span> <span class="bp">-</span><span class="n">lLLVMVectorize</span> <span class="bp">-</span><span class="n">lLLVMLinker</span> <span class="bp">-</span><span class="n">lLLVMInstrumentation</span> <span class="bp">-</span><span class="n">lLLVMFrontendOpenMP</span> <span class="bp">-</span><span class="n">lLLVMFrontendOpenACC</span> <span class="bp">-</span><span class="n">lLLVMExtensions</span> <span class="bp">-</span><span class="n">lLLVMDWARFLinker</span> <span class="bp">-</span><span class="n">lLLVMGlobalISel</span> <span class="bp">-</span><span class="n">lLLVMMIRParser</span> <span class="bp">-</span><span class="n">lLLVMAsmPrinter</span> <span class="bp">-</span><span class="n">lLLVMSelectionDAG</span> <span class="bp">-</span><span class="n">lLLVMCodeGen</span> <span class="bp">-</span><span class="n">lLLVMIRReader</span> <span class="bp">-</span><span class="n">lLLVMAsmParser</span> <span class="bp">-</span><span class="n">lLLVMInterfaceStub</span> <span class="bp">-</span><span class="n">lLLVMFileCheck</span> <span class="bp">-</span><span class="n">lLLVMFuzzMutate</span> <span class="bp">-</span><span class="n">lLLVMTarget</span> <span class="bp">-</span><span class="n">lLLVMScalarOpts</span> <span class="bp">-</span><span class="n">lLLVMInstCombine</span> <span class="bp">-</span><span class="n">lLLVMAggressiveInstCombine</span> <span class="bp">-</span><span class="n">lLLVMTransformUtils</span> <span class="bp">-</span><span class="n">lLLVMBitWriter</span> <span class="bp">-</span><span class="n">lLLVMAnalysis</span> <span class="bp">-</span><span class="n">lLLVMProfileData</span> <span class="bp">-</span><span class="n">lLLVMSymbolize</span> <span class="bp">-</span><span class="n">lLLVMDebugInfoPDB</span> <span class="bp">-</span><span class="n">lLLVMDebugInfoMSF</span> <span class="bp">-</span><span class="n">lLLVMDebugInfoDWARF</span> <span class="bp">-</span><span class="n">lLLVMObject</span> <span class="bp">-</span><span class="n">lLLVMTextAPI</span> <span class="bp">-</span><span class="n">lLLVMMCParser</span> <span class="bp">-</span><span class="n">lLLVMMC</span> <span class="bp">-</span><span class="n">lLLVMDebugInfoCodeView</span> <span class="bp">-</span><span class="n">lLLVMBitReader</span> <span class="bp">-</span><span class="n">lLLVMFuzzerCLI</span> <span class="bp">-</span><span class="n">lLLVMCore</span> <span class="bp">-</span><span class="n">lLLVMRemarks</span> <span class="bp">-</span><span class="n">lLLVMBitstreamReader</span> <span class="bp">-</span><span class="n">lLLVMBinaryFormat</span> <span class="bp">-</span><span class="n">lLLVMTableGen</span> <span class="bp">-</span><span class="n">lLLVMSupport</span> <span class="bp">-</span><span class="n">lLLVMDemangle'</span> <span class="bp">|</span> <span class="n">system</span> <span class="n">libs</span> <span class="bp">'-</span><span class="n">lm</span> <span class="bp">-</span><span class="n">lz</span> <span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="kn">local</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">libzstd.1.5.2.dylib'</span> <span class="bp">|</span> <span class="n">cxxflags</span><span class="o">:</span> <span class="bp">-</span><span class="n">I</span><span class="bp">/</span><span class="n">Users</span><span class="bp">/</span><span class="n">runner</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="kn">include</span> <span class="bp">-</span><span class="n">std</span><span class="bp">=</span><span class="n">c</span><span class="bp">++</span><span class="mi">14</span> <span class="bp">-</span><span class="n">stdlib</span><span class="bp">=</span><span class="n">libc</span><span class="bp">++</span>  <span class="bp">-</span><span class="n">fno</span><span class="bp">-</span><span class="n">exceptions</span> <span class="bp">-</span><span class="n">fno</span><span class="bp">-</span><span class="n">rtti</span> <span class="bp">-</span><span class="n">D__STDC_CONSTANT_MACROS</span> <span class="bp">-</span><span class="n">D__STDC_FORMAT_MACROS</span> <span class="bp">-</span><span class="n">D__STDC_LIMIT_MACROS</span> <span class="bp">|</span> <span class="n">includedir</span><span class="o">:</span> <span class="bp">/</span><span class="n">Users</span><span class="bp">/</span><span class="n">runner</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="kn">include</span>
</code></pre></div>
<p>Notice the presence of</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">system</span> <span class="n">libs</span> <span class="bp">'-</span><span class="n">lm</span> <span class="bp">-</span><span class="n">lz</span> <span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="kn">local</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">libzstd.1.5.2.dylib'</span>
</code></pre></div>
<p>This leads to the build to break at :</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="mi">2022</span><span class="bp">-</span><span class="mi">09</span><span class="bp">-</span><span class="mi">30</span><span class="n">T17</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mi">59</span><span class="bp">.</span><span class="mi">2815460</span><span class="n">Z</span> <span class="n">ld64.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">library</span> <span class="n">not</span> <span class="n">found</span> <span class="n">for</span> <span class="bp">-</span><span class="n">lz</span>

<span class="bp">...</span>
<span class="mi">2022</span><span class="bp">-</span><span class="mi">09</span><span class="bp">-</span><span class="mi">30</span><span class="n">T17</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mi">59</span><span class="bp">.</span><span class="mi">4247420</span><span class="n">Z</span> <span class="n">ld64.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">_ZSTD_isError</span>

<span class="bp">...</span>
<span class="mi">2022</span><span class="bp">-</span><span class="mi">09</span><span class="bp">-</span><span class="mi">30</span><span class="n">T17</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mi">59</span><span class="bp">.</span><span class="mi">4250370</span><span class="n">Z</span> <span class="n">ld64.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">_ZSTD_compress</span>
</code></pre></div>
<p>Logs taken from: <a href="https://github.com/leanprover/lean4/actions/runs/3160293349/jobs/5144580776">https://github.com/leanprover/lean4/actions/runs/3160293349/jobs/5144580776</a></p>



<a name="302171306"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302171306" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302171306">(Oct 04 2022 at 00:16)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span>  A confusion I have about Lean4's build system: Why does <code>lean4</code> manually configure linker flags via <code>LEAN_EXTRA_LINKER_FLAGS</code>?</p>
<p>In my little contact with CMake, I have more commonly seen a use of <code>find_package</code> + <code>target_link_libraries</code>to setup linker options, rather than "manually" passing linker flags.</p>



<a name="302172104"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302172104" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302172104">(Oct 04 2022 at 00:25)</a>:</h4>
<p><span class="user-mention" data-user-id="515083">@Tom</span> It seems that the windows bug shows up by just bumping up the LLVM release to LLVM 15, with none of the other changes related to linking LLVM, etc: <a href="https://github.com/bollu/lean4/actions/runs/3178356182/jobs/5179754689">https://github.com/bollu/lean4/actions/runs/3178356182/jobs/5179754689</a></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">D</span><span class="o">:</span><span class="bp">/</span><span class="n">a</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">/</span><span class="kn">include</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">__type_traits</span><span class="bp">/</span><span class="n">is_null_pointer.h</span><span class="o">:</span><span class="mi">24</span><span class="o">:</span><span class="mi">49</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">use</span> <span class="n">of</span> <span class="n">undeclared</span> <span class="n">identifier</span> <span class="bp">'</span><span class="n">nullptr_t'</span><span class="bp">;</span> <span class="n">did</span> <span class="n">you</span> <span class="n">mean</span> <span class="bp">'</span><span class="n">nullptr'</span><span class="bp">?</span>
<span class="n">template</span> <span class="bp">&lt;&gt;</span>          <span class="n">struct</span> <span class="n">__is_nullptr_t_impl</span><span class="bp">&lt;</span><span class="n">nullptr_t</span><span class="bp">&gt;</span> <span class="o">:</span> <span class="n">public</span> <span class="n">true_type</span> <span class="o">{}</span><span class="bp">;</span>
                                                <span class="bp">^</span>
<span class="n">D</span><span class="o">:</span><span class="bp">/</span><span class="n">a</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">/</span><span class="kn">include</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">__type_traits</span><span class="bp">/</span><span class="n">is_null_pointer.h</span><span class="o">:</span><span class="mi">24</span><span class="o">:</span><span class="mi">49</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">template</span> <span class="n">argument</span> <span class="n">for</span> <span class="n">template</span> <span class="n">type</span> <span class="kd">parameter</span> <span class="n">must</span> <span class="n">be</span> <span class="n">a</span> <span class="n">type</span>
<span class="n">template</span> <span class="bp">&lt;&gt;</span>          <span class="n">struct</span> <span class="n">__is_nullptr_t_impl</span><span class="bp">&lt;</span><span class="n">nullptr_t</span><span class="bp">&gt;</span> <span class="o">:</span> <span class="n">public</span> <span class="n">true_type</span> <span class="o">{}</span><span class="bp">;</span>
                                                <span class="bp">^~~~~~~~~</span>
<span class="n">D</span><span class="o">:</span><span class="bp">/</span><span class="n">a</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">/</span><span class="kn">include</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">__type_traits</span><span class="bp">/</span><span class="n">is_null_pointer.h</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span> <span class="n">note</span><span class="o">:</span> <span class="n">template</span> <span class="kd">parameter</span> <span class="n">is</span> <span class="n">declared</span> <span class="n">here</span>
<span class="n">template</span> <span class="bp">&lt;</span><span class="kd">class</span> <span class="n">_Tp</span><span class="bp">&gt;</span> <span class="n">struct</span> <span class="n">__is_nullptr_t_impl</span>       <span class="o">:</span> <span class="n">public</span> <span class="n">false_type</span> <span class="o">{}</span><span class="bp">;</span>
<span class="bp">...</span>
</code></pre></div>



<a name="302176235"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302176235" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tom <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302176235">(Oct 04 2022 at 01:13)</a>:</h4>
<p>Is there any way you could send me the full command line of one of the files which is failing to compile?  You can do <code>cmake --build build --verbose</code> but don't run it in parallel.<br>
The error is coming from the clang's implementation of the C++ standard library (libc++), so it's unlikely that's broken <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="302209211"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302209211" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302209211">(Oct 04 2022 at 08:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="130575">Siddharth Bhat</span> <a href="#narrow/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend/near/302171306">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span>  A confusion I have about Lean4's build system: Why does <code>lean4</code> manually configure linker flags via <code>LEAN_EXTRA_LINKER_FLAGS</code>?</p>
<p>In my little contact with CMake, I have more commonly seen a use of <code>find_package</code> + <code>target_link_libraries</code>to setup linker options, rather than "manually" passing linker flags.</p>
</blockquote>
<p>We already do all linking outside of CMake, so does it really matter?</p>



<a name="302336496"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302336496" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302336496">(Oct 04 2022 at 19:56)</a>:</h4>
<p><span class="user-mention" data-user-id="130575">@Siddharth Bhat</span> <a href="https://github.com/leanprover/lean-llvm/releases/tag/15.0.1">https://github.com/leanprover/lean-llvm/releases/tag/15.0.1</a> now should have releases without zstd</p>



<a name="302549905"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302549905" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302549905">(Oct 05 2022 at 21:41)</a>:</h4>
<p>I opened a new PR: <a href="https://github.com/leanprover/lean4/pull/1691">https://github.com/leanprover/lean4/pull/1691</a> , which isolates the windows build problem to just bumping up LLVM 15. This should be a clean jumping off point for debugging.</p>



<a name="302605971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302605971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302605971">(Oct 06 2022 at 08:40)</a>:</h4>
<p>I can take a look this evening, though I'm not looking forward to it <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> . I guess the first step would be to compare the include path order from <code>clang -v</code> to a successful standard build</p>



<a name="302613614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302613614" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tobias Grosser <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302613614">(Oct 06 2022 at 09:29)</a>:</h4>
<p>I tried a couple of things, but without success. Difficult to debug this further without a windows machine / VM.</p>



<a name="302616415"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302616415" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tobias Grosser <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302616415">(Oct 06 2022 at 09:46)</a>:</h4>
<p>See comments in the PR</p>



<a name="302742437"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302742437" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302742437">(Oct 06 2022 at 21:16)</a>:</h4>
<p>Yeah, include order, more specifically <code>stdlib.h</code>: <a href="/user_uploads/3121/GyJpLTtm029qJ0tYF30eamsD/image.png">image.png</a> <br>
Since <code>-isystem-after</code> apparently doesn't do what I want (??? <code>clang++: warning: argument unused during compilation: '-isystem-after C:/msys64/clang64/include/'</code>), I've had some success locally with just repeating the relevant implicit sysroot include dir before it: <a href="https://github.com/Kha/lean4/commit/06366815114601b4b4451c6d4ed2d3ab8ef39216#diff-5377d1dbc10b07eebe77acc2e4b55ddced6a480d3717d0586ba4e14ce2b28617R38">https://github.com/Kha/lean4/commit/06366815114601b4b4451c6d4ed2d3ab8ef39216#diff-5377d1dbc10b07eebe77acc2e4b55ddced6a480d3717d0586ba4e14ce2b28617R38</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/GyJpLTtm029qJ0tYF30eamsD/image.png" title="image.png"><img src="/user_uploads/3121/GyJpLTtm029qJ0tYF30eamsD/image.png"></a></div>



<a name="302744380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302744380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302744380">(Oct 06 2022 at 21:29)</a>:</h4>
<p>All tests pass now on my machine</p>



<a name="302791590"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302791590" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tobias Grosser <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302791590">(Oct 07 2022 at 07:05)</a>:</h4>
<p>Thank you <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span>, this was really helpful. I think this got us a step forward. Let's see if this build goes through: <a href="https://github.com/tobiasgrosser/lean4/pull/5">https://github.com/tobiasgrosser/lean4/pull/5</a></p>



<a name="302807875"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302807875" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tobias Grosser <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302807875">(Oct 07 2022 at 09:06)</a>:</h4>
<p>Perfect. <span class="user-mention" data-user-id="130575">@Siddharth Bhat</span>'s changes also fix the linux build. So the LLVM upgrade to 15.1 seems to go through (modulo arch64).</p>



<a name="302807941"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302807941" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tobias Grosser <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302807941">(Oct 07 2022 at 09:06)</a>:</h4>
<p>I am currently rerunning the patches that link with LLVM: <a href="https://github.com/tobiasgrosser/lean4/pull/6">https://github.com/tobiasgrosser/lean4/pull/6</a></p>



<a name="302808074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302808074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tobias Grosser <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302808074">(Oct 07 2022 at 09:07)</a>:</h4>
<p>Windows already passed, Linux is in stage 3, and MacOS just started. <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>



<a name="302810930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302810930" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302810930">(Oct 07 2022 at 09:27)</a>:</h4>
<p>As for <code>-lz</code> on macOS: if we make sure that we link against LLVM dynamically, I'm pretty sure we can just ignore <code>--system-libs</code></p>



<a name="302812878"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302812878" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302812878">(Oct 07 2022 at 09:39)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> This leads to an interesting workflow question for me. </p>
<p>I work on LLVM HEAD locally, and I was considering linking against LLVM HEAD while I work on lean4. The last time  I tried this, I needed <code>--system-libs</code> for the link to succeed (I don't remember what dependency was missing).</p>
<p>I guess the best course of action is to have a separate worktree of LLVM for Lean4, where I mimic <code>script/prepare-llvm-linux.sh</code> to build LLVM.</p>
<p>EDIT: No, it's much easier. I just pass <code>$(llvm-config --system-libs)</code> when configuring Lean4 :) Thanks for rubber ducking!</p>



<a name="302813473"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302813473" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302813473">(Oct 07 2022 at 09:43)</a>:</h4>
<p>I want to add a link to the discussion on the commit message. However, the link on the  zulip archive (<a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html">https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html</a>) seems to be dead. It's unclear to me why this is the case. </p>
<p>Shall I add a non-archive link to the commit message? (<a href="#narrow/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend/near/301563442">https://leanprover.zulipchat.com/#narrow/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend/near/301563442</a>)</p>



<a name="302819426"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302819426" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302819426">(Oct 07 2022 at 10:24)</a>:</h4>
<p>Yeah, this stream is world-readable now</p>



<a name="302820001"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302820001" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302820001">(Oct 07 2022 at 10:28)</a>:</h4>
<p>Btw, I wanted to quickly test what <code>llvm-config --system-libs --link-shared</code> even outputs on macOS and the result is... puzzling</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">-</span><span class="n">config</span> <span class="c1">--system-libs --link-shared</span>
<span class="n">llvm</span><span class="bp">-</span><span class="n">config</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">libLLVM</span><span class="bp">-</span><span class="mi">15</span><span class="bp">.</span><span class="n">dylib</span> <span class="n">is</span> <span class="n">missing</span>
</code></pre></div>



<a name="302820161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302820161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302820161">(Oct 07 2022 at 10:29)</a>:</h4>
<p>Ok, this looks better</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="o">(</span><span class="n">cd</span> <span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lib</span><span class="bp">;</span> <span class="n">ln</span> <span class="bp">-</span><span class="n">s</span> <span class="n">libLLVM.dylib</span> <span class="n">libLLVM</span><span class="bp">-</span><span class="mi">15</span><span class="bp">.</span><span class="n">dylib</span><span class="o">)</span>
<span class="bp">$</span> <span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">-</span><span class="n">config</span> <span class="c1">--system-libs --link-shared</span>

<span class="bp">$</span> <span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">-</span><span class="n">config</span> <span class="c1">--libs --link-shared</span>
<span class="bp">-</span><span class="n">lLLVM</span><span class="bp">-</span><span class="mi">15</span>
<span class="bp">$</span>
</code></pre></div>



<a name="302826805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302826805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302826805">(Oct 07 2022 at 11:14)</a>:</h4>
<p>The build that adds LLVM 15 succeeds: <a href="https://github.com/leanprover/lean4/pull/1691">https://github.com/leanprover/lean4/pull/1691</a>, modulo <code>aarch64</code>.</p>



<a name="302827265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302827265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302827265">(Oct 07 2022 at 11:17)</a>:</h4>
<p>Great. I assume you are confident by now that lean-llvm now contains everything you need? <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> Do you still have an aarch64-linux machine you could use for building lean-llvm?</p>



<a name="302830757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302830757" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302830757">(Oct 07 2022 at 11:39)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I'd like to wait, until <a href="https://github.com/leanprover/lean4/pull/1497">https://github.com/leanprover/lean4/pull/1497</a>  succeeds on macOS after removing <code>--system-libs</code> from the CMake configuration.</p>



<a name="302850053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302850053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302850053">(Oct 07 2022 at 13:19)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> do you have an account on the GCC compile farm (<a href="https://gcc.gnu.org/wiki/CompileFarm">https://gcc.gnu.org/wiki/CompileFarm</a>)? I think they have aarch64 build machines you can use for testing lean builds.<br>
Alternatively if you like I can try and find my account details there and run some builds there (if given precise instructions).</p>



<a name="302850449"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302850449" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302850449">(Oct 07 2022 at 13:21)</a>:</h4>
<p>I don't, first time I've heard of it!</p>



<a name="302947959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/302947959" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#302947959">(Oct 07 2022 at 23:24)</a>:</h4>
<p>I've stopped the VM a while ago, but I can start one again.  Not sure if I have time until next week though.</p>



<a name="303221055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303221055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303221055">(Oct 10 2022 at 08:56)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> The commit that adds C bindings now passes on <code>macOS</code> (<a href="https://github.com/leanprover/lean4/pull/1497">https://github.com/leanprover/lean4/pull/1497</a>). Could you verify for me that the <code>cmake</code> and <code>prepare-llvm-macos.sh</code> makes sense to you?</p>
<p>I'm now confident that can build releases of <code>leanprover/lean-llvm</code> for  <code>aarch64</code>, since the above commit is green on CI for all platforms except aarch64.</p>



<a name="303223763"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303223763" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303223763">(Oct 10 2022 at 09:13)</a>:</h4>
<p><span class="user-mention" data-user-id="130575">@Siddharth Bhat</span> Cool!<br>
Could you please double-check the diff between the old and new "List Install Tree" CI step? Should anything new but <code>libLLVM.so</code> appear there?</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- 829M used in 160 directories, 2130 files</span><span class="w"></span>
<span class="gi">+ 1.2G used in 359 directories, 5865 files</span><span class="w"></span>
</code></pre></div>



<a name="303224000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303224000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303224000">(Oct 10 2022 at 09:15)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Interesting, I'll take a look. Could you give me a link to the precise "List Install Tree" step you're talking about? (which machine, which commit...)</p>



<a name="303224313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303224313" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303224313">(Oct 10 2022 at 09:17)</a>:</h4>
<p>(I'm looking at the macOS build, which seems to still be 820M? <a href="https://github.com/leanprover/lean4/actions/runs/3203793716/jobs/5234311940#step:10:131">https://github.com/leanprover/lean4/actions/runs/3203793716/jobs/5234311940#step:10:131</a>)</p>



<a name="303224414"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303224414" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303224414">(Oct 10 2022 at 09:18)</a>:</h4>
<p>Ah, I see, you meant this build: <a href="https://github.com/leanprover/lean4/actions/runs/3214208813/jobs/5254435666#step:10:1352">https://github.com/leanprover/lean4/actions/runs/3214208813/jobs/5254435666#step:10:1352</a></p>



<a name="303224489"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303224489" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303224489">(Oct 10 2022 at 09:19)</a>:</h4>
<p>Yes!</p>



<a name="303226026"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303226026" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303226026">(Oct 10 2022 at 09:32)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I believe the size delta is because the macOS build copies in headers, and the library directory wholesale. The offending lines are:</p>
<ol>
<li><a href="https://github.com/leanprover/lean4/pull/1497/files#diff-0d112c28beff241f98979d3807483fed193e94d8e0e9db9df7d2f5bd878a6cb8R42">https://github.com/leanprover/lean4/pull/1497/files#diff-0d112c28beff241f98979d3807483fed193e94d8e0e9db9df7d2f5bd878a6cb8R42</a></li>
</ol>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gi">+# includes (for LLVM backend)</span><span class="w"></span>
<span class="gi">+cp -r llvm/include/* stage1/include/</span><span class="w"></span>
</code></pre></div>
<ol start="2">
<li><a href="https://github.com/leanprover/lean4/pull/1497/files#diff-0d112c28beff241f98979d3807483fed193e94d8e0e9db9df7d2f5bd878a6cb8R35">https://github.com/leanprover/lean4/pull/1497/files#diff-0d112c28beff241f98979d3807483fed193e94d8e0e9db9df7d2f5bd878a6cb8R35</a></li>
</ol>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-$CP llvm/lib/lib{clang-cpp,LLVM}*.so* stage1/lib/</span><span class="w"></span>
<span class="gi">+$CP -r llvm/lib/* stage1/lib/</span><span class="w"></span>
</code></pre></div>



<a name="303278292"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303278292" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303278292">(Oct 10 2022 at 15:12)</a>:</h4>
<p><span class="user-mention" data-user-id="130575">@Siddharth Bhat</span> Note the following part in <a href="http://prepare-llvm-macos.sh">prepare-llvm-macos.sh</a>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">#</span> <span class="k">do</span> <span class="n">not</span> <span class="n">change</span> <span class="n">C</span><span class="bp">++</span> <span class="n">compiler</span><span class="bp">;</span> <span class="n">libc</span><span class="bp">++</span> <span class="n">etc.</span> <span class="n">being</span> <span class="n">system</span> <span class="n">libraries</span> <span class="n">means</span> <span class="n">there's</span> <span class="n">no</span> <span class="n">danger</span> <span class="n">of</span> <span class="n">conflicts</span><span class="o">,</span>
<span class="bp">#</span> <span class="n">and</span> <span class="n">the</span> <span class="n">custom</span> <span class="n">clang</span><span class="bp">++</span> <span class="n">outputs</span> <span class="n">a</span> <span class="n">myriad</span> <span class="n">of</span> <span class="n">warnings</span> <span class="n">when</span> <span class="n">consuming</span> <span class="n">the</span> <span class="n">SDK</span>
<span class="n">echo</span> <span class="bp">-</span><span class="n">n</span> <span class="s2">" -DLEAN_EXTRA_CXX_FLAGS='${EXTRA_FLAGS:-} -I$PWD/stage1/include/'"</span>
</code></pre></div>
<p>On the other platforms, we use <code>--sysroot $PWD/llvm</code>, which presumably makes them find <code>include/llvm</code> automatically. If the above workaround is still necessary, we probably need to add <code>$PWD/llvm/include</code> to the macOS include path, though with <code>-isystem</code> we may be back to include order issues...</p>



<a name="303392118"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303392118" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303392118">(Oct 11 2022 at 09:43)</a>:</h4>
<p>I uploaded the macOS aarch64 release to <a href="https://github.com/leanprover/lean-llvm/releases/tag/15.0.1">https://github.com/leanprover/lean-llvm/releases/tag/15.0.1</a>. <span class="user-mention" data-user-id="130575">@Siddharth Bhat</span> mentioned that he now has access to the GCC compile farm as well.</p>



<a name="303433451"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303433451" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tobias Grosser <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303433451">(Oct 11 2022 at 13:07)</a>:</h4>
<p>This is lovely</p>



<a name="303436237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303436237" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303436237">(Oct 11 2022 at 13:22)</a>:</h4>
<p>It turns out the GCC farm build machines don't have an LLVM toolchain, and the LLVM releases don't have a binary build of clang for aarch64 (<a href="https://github.com/llvm/llvm-project/releases/tag/llvmorg-15.0.2">https://github.com/llvm/llvm-project/releases/tag/llvmorg-15.0.2</a>). Thus, I have to build <code>clang</code> from source, so I have a <code>clang</code> which I can use to build <code>leanprover/lean-llvm</code></p>
<p>Why does <code>leanprover/lean-llvm</code> build specifically ask for <code>-DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++</code>? (is it  for name-mangling consistency?) Can  I switch the compiler over to <code>gcc/g++</code>?</p>



<a name="303438054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303438054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303438054">(Oct 11 2022 at 13:30)</a>:</h4>
<p>15.0.1 has a binary though? <a href="https://github.com/llvm/llvm-project/releases/download/llvmorg-15.0.1/clang+llvm-15.0.1-aarch64-linux-gnu.tar.xz">https://github.com/llvm/llvm-project/releases/download/llvmorg-15.0.1/clang+llvm-15.0.1-aarch64-linux-gnu.tar.xz</a></p>



<a name="303438552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303438552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303438552">(Oct 11 2022 at 13:33)</a>:</h4>
<p>I don't know what's going on with the set of available binary releases, it looks almost random</p>



<a name="303439009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303439009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303439009">(Oct 11 2022 at 13:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="130575">Siddharth Bhat</span> <a href="#narrow/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend/near/303436237">said</a>:</p>
<blockquote>
<p>Why does <code>leanprover/lean-llvm</code> build specifically ask for <code>-DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++</code> for name-mangling consistency? Can  I switch the compiler over to <code>gcc/g++</code>?</p>
</blockquote>
<p>I think that would work too if we do a proper two-stage build where the runtimes are built using the stage 1 clang. We're essentially taking a shortcut in lean-llvm by using the upstream binary releases as the first stage. Which might also explain why a new LLVM version in MSYS2 broke it.</p>



<a name="303440635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303440635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303440635">(Oct 11 2022 at 13:44)</a>:</h4>
<p>I don't follow. What in Lean's build process is sensitive to whether the LLVM toolchain used to build Lean is a <code>stage1</code> or <code>stage2</code> build of the toolchain?</p>



<a name="303441170"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303441170" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303441170">(Oct 11 2022 at 13:46)</a>:</h4>
<p>Oh, I think I got it backwards - it's clang/libLLVM that we want to be built against the LLVM runtimes. Which I think is only possible using clang, so we need two stages/clangs.</p>



<a name="303441674"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303441674" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303441674">(Oct 11 2022 at 13:49)</a>:</h4>
<p>Specifically the shortcut consists of not using <code>LLVM_ENABLE_RUNTIMES</code>, which says</p>
<blockquote>
<p>Build libc++, libc++abi, libunwind or compiler-rt using the <strong>just-built compiler</strong>. This is the correct way to build runtimes when putting together a toolchain.</p>
</blockquote>



<a name="303447055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303447055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303447055">(Oct 11 2022 at 14:14)</a>:</h4>
<blockquote>
<p>clang/libLLVM that we want to be built against the LLVM runtimes</p>
</blockquote>
<p>Why do we need this? (I'm trying to understand where this requirement comes from).</p>



<a name="303459193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303459193" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303459193">(Oct 11 2022 at 15:09)</a>:</h4>
<p>Because that's the runtimes we use for building Lean binaries, and there's no sense in shipping two variant runtimes</p>



<a name="303459877"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303459877" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303459877">(Oct 11 2022 at 15:13)</a>:</h4>
<p>This is because <code>leanc</code> is a wrapper around <code>clang++</code>?</p>



<a name="303471016"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303471016" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303471016">(Oct 11 2022 at 16:08)</a>:</h4>
<p>It is, but I'm not sure I understand the connection to the discussion. We have to ship a runtime for linking against and we have to ship executables linked against a runtime, and there's no sense in having the two be different, no?</p>



<a name="303476248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303476248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303476248">(Oct 11 2022 at 16:36)</a>:</h4>
<p>Ah, okay, now I see what you mean :) Right, it makes sense to re-use the same C(++) runtime for lean's builds as well as the executables that lean produces.</p>



<a name="303476427"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303476427" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303476427">(Oct 11 2022 at 16:37)</a>:</h4>
<p>And it probably becomes even more important when we link LLVM parts into <code>lean</code>. It might have worked either way for the standalone <code>clang</code>.</p>



<a name="303681754"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303681754" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303681754">(Oct 12 2022 at 17:01)</a>:</h4>
<p>New error just dropped, in trying to get the <code>aarch64</code> build working: </p>
<p><a href="https://github.com/leanprover/lean4/actions/runs/3235490234/jobs/5299994236#step:8:905">https://github.com/leanprover/lean4/actions/runs/3235490234/jobs/5299994236#step:8:905</a></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">In</span> <span class="n">file</span> <span class="n">included</span> <span class="k">from</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">runner</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">-</span><span class="n">host</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/../</span><span class="kn">include</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">__assert</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span>
<span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">runner</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">-</span><span class="n">host</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/../</span><span class="kn">include</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">__config</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span> <span class="n">fatal</span> <span class="n">error</span><span class="o">:</span> <span class="bp">'</span><span class="n">__config_site'</span> <span class="n">file</span> <span class="n">not</span> <span class="n">found</span>
<span class="bp">#</span><span class="kn">include</span> <span class="bp">&lt;</span><span class="n">__config_site</span><span class="bp">&gt;</span>
</code></pre></div>



<a name="303687976"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303687976" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303687976">(Oct 12 2022 at 17:35)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">bollu</span><span class="bp">@</span><span class="n">gcc118</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">test</span><span class="bp">-</span><span class="n">upstream</span><span class="bp">-</span><span class="n">copy</span><span class="bp">/</span><span class="n">aarch64</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">&gt;</span> <span class="n">find</span> <span class="bp">.</span> <span class="bp">|</span> <span class="n">grep</span> <span class="n">__config_site</span>
<span class="bp">./</span><span class="kn">include</span><span class="bp">/</span><span class="n">aarch64</span><span class="bp">-</span><span class="n">unknown</span><span class="bp">-</span><span class="n">linux</span><span class="bp">-</span><span class="n">gnu</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">__config_site</span>
</code></pre></div>
<p>The requisite include seems to be at a path that's prefixed by the triple..</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">bollu</span><span class="bp">@</span><span class="n">gcc118</span><span class="o">:</span><span class="bp">~/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">test</span><span class="bp">-</span><span class="n">upstream</span><span class="bp">-</span><span class="n">copy</span><span class="bp">/</span><span class="n">x86_64</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">&gt;</span> <span class="n">find</span> <span class="bp">.</span> <span class="bp">|</span> <span class="n">grep</span> <span class="n">__config_site</span>
<span class="bp">./</span><span class="kn">include</span><span class="bp">/</span><span class="n">x86_64</span><span class="bp">-</span><span class="n">unknown</span><span class="bp">-</span><span class="n">linux</span><span class="bp">-</span><span class="n">gnu</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">__config_site</span>
</code></pre></div>



<a name="303695148"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303695148" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303695148">(Oct 12 2022 at 18:15)</a>:</h4>
<p>They sure have been moving things around between releases, huh...</p>



<a name="303698452"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303698452" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303698452">(Oct 12 2022 at 18:35)</a>:</h4>
<p><a href="https://github.com/llvm/llvm-project/issues/57104">https://github.com/llvm/llvm-project/issues/57104</a></p>



<a name="303710016"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303710016" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303710016">(Oct 12 2022 at 19:47)</a>:</h4>
<p>A final(?) error: <a href="https://github.com/leanprover/lean4/actions/runs/3237093374/jobs/5303732640#step:8:2510">https://github.com/leanprover/lean4/actions/runs/3237093374/jobs/5303732640#step:8:2510</a></p>
<blockquote>
<p>ld.lld: error: cannot open Scrt1.o: No such file or directory<br>
clang-15: error: linker command failed with exit code 1 (use -v to see invocation)</p>
</blockquote>
<p>I can't even _find_ <code>Scrti1.o</code> in the build tree:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>bollu@gcc118:~/lean-llvm/lean-llvm&gt; find . <span class="p">|</span> grep -i scrt <span class="c1"># nothing</span>
bollu@gcc118:~/lean-llvm/lean-llvm&gt; find . <span class="p">|</span> grep -i crt
./include/llvm/ExecutionEngine/Orc/EPCGenericRTDyldMemoryManager.h
./include/llvm/ExecutionEngine/Orc/Shared/OrcRTBridge.h
./lib/cmake/llvm/ChooseMSVCCRT.cmake
./lib/clang/15.0.1/lib/aarch64-unknown-linux-gnu/clang_rt.crtbegin.o
./lib/clang/15.0.1/lib/aarch64-unknown-linux-gnu/clang_rt.crtend.o
</code></pre></div>



<a name="303710549"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303710549" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303710549">(Oct 12 2022 at 19:51)</a>:</h4>
<p>Not sure it's because of that, but setting the sysroot to the host compiler is definitely wrong. How is it supposed to find the arm runtimes that way?</p>



<a name="303830625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303830625" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303830625">(Oct 13 2022 at 13:18)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I am clearly confused about the different components at play here.<br>
We use the <code>host</code> compiler (which is going to be <code>x86_64</code>), while linking against the <code>target</code>runtime (which is <code>aarch64</code>) to produce the Lean toolchain, correct?</p>
<p>The <code>sysroot</code> option sets the path for the <code>host</code> compiler to pickup the runtimes for the <code>target</code>? So in our case, the <code>sysroot</code> should point to the <code>aarch64</code> runtime?</p>



<a name="303830793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303830793" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303830793">(Oct 13 2022 at 13:20)</a>:</h4>
<p>Yes, exactly!</p>



<a name="303832009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303832009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303832009">(Oct 13 2022 at 13:26)</a>:</h4>
<p>I think you have to adapt your include fix to that as well :) . The host include files should be irrelevant.</p>



<a name="303914045"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303914045" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303914045">(Oct 13 2022 at 20:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="130575">Siddharth Bhat</span> <a href="#narrow/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend/near/303710016">said</a>:</p>
<blockquote>
<p>I can't even _find_ <code>Scrti1.o</code> in the build tree:</p>
</blockquote>
<p>I have no idea how this is breaking now, but this file is from glibc. We need to add it to the <code>cp $GLIBC</code>.</p>



<a name="303987952"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303987952" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303987952">(Oct 14 2022 at 08:53)</a>:</h4>
<p>And that did it, whoo <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="303989523"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303989523" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303989523">(Oct 14 2022 at 09:02)</a>:</h4>
<p>This was quite an adventure :D</p>



<a name="303990919"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303990919" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tobias Grosser <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303990919">(Oct 14 2022 at 09:11)</a>:</h4>
<p>Nice. Congratulations!</p>



<a name="303991714"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303991714" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303991714">(Oct 14 2022 at 09:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="130575">Siddharth Bhat</span> <a href="#narrow/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend/near/303989523">said</a>:</p>
<blockquote>
<p>This was quite an adventure :D</p>
</blockquote>
<p>And here I hoped that only the initial bundling would be such an adventure, haha... looking forward to LLVM 16</p>



<a name="303992657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303992657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303992657">(Oct 14 2022 at 09:23)</a>:</h4>
<p>So... can someone summarize what was done? Perhaps in the code generator meeting today.</p>



<a name="303994463"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303994463" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303994463">(Oct 14 2022 at 09:33)</a>:</h4>
<p><span class="user-mention" data-user-id="130575">@Siddharth Bhat</span> Why is it using header files from the host compiler? That still sounds wrong.</p>



<a name="303994798"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303994798" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303994798">(Oct 14 2022 at 09:35)</a>:</h4>
<p>I think I just screwed up the <code>cp</code></p>



<a name="303994916"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/303994916" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#303994916">(Oct 14 2022 at 09:36)</a>:</h4>
<p>Ah, right, that's fair.</p>



<a name="304002164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304002164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304002164">(Oct 14 2022 at 10:26)</a>:</h4>
<p><span class="user-mention" data-user-id="130575">@Siddharth Bhat</span> Could you rebase on master for the auto-cancellation logic? ...I feel like we might need a few more runs to figure this one out</p>



<a name="304003831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304003831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304003831">(Oct 14 2022 at 10:38)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Just rebased.</p>



<a name="304004041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304004041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304004041">(Oct 14 2022 at 10:39)</a>:</h4>
<p>Hmm, now my last commit is gone</p>



<a name="304004076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304004076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304004076">(Oct 14 2022 at 10:39)</a>:</h4>
<p>Let's see if I remember it</p>



<a name="304050886"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304050886" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304050886">(Oct 14 2022 at 14:56)</a>:</h4>
<p>Thanks for the heroic push that led to this, <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> ! <a href="https://github.com/leanprover/lean4/pull/1691">https://github.com/leanprover/lean4/pull/1691</a></p>



<a name="304467045"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304467045" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304467045">(Oct 17 2022 at 13:55)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> How do you suggest giving <code>/path/to/libLLVM-15.so</code> to the  executables we build with <code>leanc</code>? Currently, the <a href="https://github.com/leanprover/lean4/actions/runs/3265474545/jobs/5367751084#step:15:3524">linux release tests</a> fails in trying to find <code>libLLVM-15.so</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">++</span> <span class="n">hello</span><span class="bp">-</span><span class="n">world</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">hello</span><span class="bp">-</span><span class="n">world</span>
<span class="n">hello</span><span class="bp">-</span><span class="n">world</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">hello</span><span class="bp">-</span><span class="n">world</span><span class="o">:</span> <span class="n">error</span> <span class="n">while</span> <span class="n">loading</span> <span class="n">shared</span> <span class="n">libraries</span><span class="o">:</span>
<span class="n">libLLVM</span><span class="bp">-</span><span class="mi">15</span><span class="bp">.</span><span class="n">so</span><span class="o">:</span> <span class="n">cannot</span> <span class="kn">open</span> <span class="n">shared</span> <span class="n">object</span> <span class="n">file</span><span class="o">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span>

          <span class="n">Start</span> <span class="mi">1591</span><span class="o">:</span> <span class="n">leanlaketest_targets</span>
<span class="mi">1588</span><span class="bp">/</span><span class="mi">1591</span> <span class="n">Test</span> <span class="bp">#</span><span class="mi">1586</span><span class="o">:</span> <span class="n">leanlaketest_ffi</span> <span class="bp">...................***</span><span class="n">Failed</span>    <span class="mi">8</span><span class="bp">.</span><span class="mi">50</span> <span class="n">sec</span>
</code></pre></div>
<p>In a prior version of the build script, I had appended to <code>LD_LIBRARY_PATH</code>, which I now recognize is quite hacky. </p>
<p>I'm considering adding a <code>runpath</code>option to <code>LEANC_EXTRA_FLAGS </code>. I don't know if this is janky, so I'm hoping you have a better idea of what the ideal way to set this up is.</p>



<a name="304467573"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304467573" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304467573">(Oct 17 2022 at 13:57)</a>:</h4>
<p>Let's take a step or two back here, why would arbitrary executable be linked against libLLVM?</p>



<a name="304468851"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304468851" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304468851">(Oct 17 2022 at 14:02)</a>:</h4>
<p>Indeed, that's fair. I was far too focused on getting <code>LLVM</code> to link against  _one_ executable we build with <code>leanc</code> (the compiler itself), that I did not take into account the implications of enabling this <em>everywhere</em> <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="304469495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304469495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304469495">(Oct 17 2022 at 14:05)</a>:</h4>
<p>More specifically, it should be <code>libleanshared</code> that's linked against libLLVM I assume, not <code>lean</code></p>



<a name="304469564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304469564" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304469564">(Oct 17 2022 at 14:05)</a>:</h4>
<p>Right.</p>



<a name="304470064"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304470064" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304470064">(Oct 17 2022 at 14:07)</a>:</h4>
<p>Should end-users of the lean compiler have the ability to optionally link against the LLVM we ship with Lean? Concretely, should <code>leanc</code> learn a new flag, like <code>--print-llvm-{cxx,ld}flags</code> to allow end-users to easily link against Lean's bundled LLVM?</p>
<p>I won't block <a href="https://github.com/leanprover/lean4/pull/1497">https://github.com/leanprover/lean4/pull/1497</a> on this, but it would be useful for me to know if this is part of the story of shipping LLVM with Lean.</p>



<a name="304475779"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304475779" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304475779">(Oct 17 2022 at 14:32)</a>:</h4>
<p>I don't think that's necessary if we decide not to ship LLVM's headers</p>



<a name="304475847"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304475847" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304475847">(Oct 17 2022 at 14:33)</a>:</h4>
<p>People can just download <code>lean-llvm</code> instead, it doesn't change that often :)</p>



<a name="304521580"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304521580" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304521580">(Oct 17 2022 at 17:51)</a>:</h4>
<p><strong>Offshoot from Monday call</strong></p>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Since I've been looking around the build system, I have some questions about some <code>CMake</code> flags, and some build architecture questions. It would be super useful if we could work through this in the next call <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> </p>
<ol>
<li>Why do we have a <code>leanshared</code> library and a <code>lean</code> executable?</li>
<li>What is <code>LEAN_STANDALONE</code>?</li>
<li><code>LEANC_INTERNAL_LINKER_FLAGS</code> ? (What is the difference between INTERNAL versus EXTRA?)</li>
<li><code>LEANC_INTERNAL_FLAGS</code>? What is the difference between <code>INTERNAL_</code> versus <code>EXTRA_</code>?)</li>
<li><code>LEAN_EXTRA_LINKER_FLAGS</code>: Linker flags that are passed to lld after the other linker flags, allows overriding? </li>
<li>What is <code>src/bin/leanmake</code>?</li>
<li>What is <code>src/lean.mk.in</code>?</li>
</ol>



<a name="304522173"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304522173" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304522173">(Oct 17 2022 at 17:54)</a>:</h4>
<p>Here's a larger google doc (<a href="https://docs.google.com/document/d/107TYPF6zhyAVQtOPWoxG97UQ9Qhorr8T8pjbYl8F4Xo/edit">https://docs.google.com/document/d/107TYPF6zhyAVQtOPWoxG97UQ9Qhorr8T8pjbYl8F4Xo/edit</a>), with everything I was unsure about. I plan on sending a documentation PR once I'm sure the definitions are correct.</p>



<a name="304532967"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304532967" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304532967">(Oct 17 2022 at 18:44)</a>:</h4>
<p>Thanks, more docs are always great. I tend to program and document CMake like Latex and bash: as soon as it works, I want to get out of there</p>



<a name="304535864"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304535864" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304535864">(Oct 17 2022 at 18:58)</a>:</h4>
<p>Some quick hints:</p>
<blockquote>
<ol>
<li>Why do we have a <code>leanshared</code> library and a <code>lean</code> executable?</li>
</ol>
</blockquote>
<p><a href="https://github.com/leanprover/lean4/issues/466">https://github.com/leanprover/lean4/issues/466</a></p>
<blockquote>
<ol start="2">
<li>What is <code>LEAN_STANDALONE</code>?</li>
</ol>
</blockquote>
<p>set by the <code>prepare-*</code> scripts building standalone toolchains</p>
<blockquote>
<ol start="3">
<li><code>LEANC_INTERNAL_LINKER_FLAGS</code> ? (What is the difference between INTERNAL versus EXTRA?)</li>
</ol>
</blockquote>
<p>Extra flags are always appended, internal flags are used only when using the bundled clang. This distinction will likely vanish with the LLVM backend.</p>
<blockquote>
<ol start="7">
<li>What is <code>src/bin/leanmake</code>?</li>
</ol>
</blockquote>
<p>Did you see the docs in it? :)</p>



<a name="304933104"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304933104" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304933104">(Oct 19 2022 at 11:37)</a>:</h4>
<p>Looking at the remaining failures:</p>
<ul>
<li>Nix Linux: did the Nix changes vanish?</li>
<li>Linux: we should not link against LLVM in stage 0 (see many <code>${STAGE} GREATER 0</code>)</li>
<li>aarch64: regarding the issue mentioned in <a href="https://github.com/leanprover/lean4/pull/1497/commits/f5e0bfbaa26dc1a8746f1a83162d3190a7b3c73a">https://github.com/leanprover/lean4/pull/1497/commits/f5e0bfbaa26dc1a8746f1a83162d3190a7b3c73a</a>, should we simply specify <code>LLVM_CONFIG_LDFLGAS</code> (sic) manually in the cross-compile/any release build? Linking manually against a single shared library can't be that hard/fragile, right?</li>
</ul>



<a name="304946739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304946739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304946739">(Oct 19 2022 at 12:42)</a>:</h4>
<p>It's pretty weird that LLVM now has these target-specific directories, but <code>llvm-config</code> has no way to actually select a different target</p>



<a name="304960991"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304960991" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304960991">(Oct 19 2022 at 13:57)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> </p>
<ul>
<li>we need more dependencies for <code>nix</code>, whichever nix package it is that supplies <code>llvm-config</code>. I'll backport the <code>nix</code> changes.</li>
<li>Can you explain the <code>stage0</code> change to me? I don't understand the rationale. Is the idea this: we only use <code>stage0</code> to compile <code>stage1</code>, and we can use <code>stage0</code>'s C backend to compile <code>stage1</code>. Thus, <code>stage0</code> does not need LLVM support?</li>
<li>I am mildly reluctant to not use <code>llvm-config</code>, as it is the "best practice" path. Let me experiment and see what happens?</li>
</ul>



<a name="304962387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/304962387" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#304962387">(Oct 19 2022 at 14:03)</a>:</h4>
<blockquote>
<p>we need more dependencies for nix, whichever nix package it is that supplies llvm-config. I'll backport the nix changes.</p>
</blockquote>
<p>It's <code>llvmPackages.llvm.dev</code>. Sorry if that was one of the packages I removed!</p>
<blockquote>
<p>Is the idea this: we only use stage0 to compile stage1, and we can use stage0's C backend to compile stage1. Thus, stage0 does not need LLVM support?</p>
</blockquote>
<p>Yes. Maybe we want to change that in the future, but we would need a ccache replacement first.</p>



<a name="305060877"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/305060877" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#305060877">(Oct 20 2022 at 00:02)</a>:</h4>
<p>Putting this down here as something to understand tomorrow:</p>
<ul>
<li><a href="https://github.com/leanprover/lean4/actions/runs/3285800077/jobs/5413244431">Link to action from which raw log was taken</a></li>
<li><a href="https://pipelines.actions.githubusercontent.com/serviceHosts/a478744f-d04e-4945-ab82-85221d8ba2f1/_apis/pipelines/1/runs/14982/signedlogcontent/8?urlExpires=2022-10-20T00%3A00%3A41.8141355Z&amp;urlSigningMethod=HMACV1&amp;urlSignature=onb%2BUV2Z1zK9aXttNA8LOYr346Bk802AW04bKUYBIJk%3D">Link to action log</a></li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="mi">2022</span><span class="bp">-</span><span class="mi">10</span><span class="bp">-</span><span class="mi">19</span><span class="n">T23</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">11</span><span class="bp">.</span><span class="mi">7291777</span><span class="n">Z</span> <span class="c1">-- Found 'llvm-config' as /home/runner/work/lean4/lean4/build/llvm-host/bin/llvm-config</span>
<span class="mi">2022</span><span class="bp">-</span><span class="mi">10</span><span class="bp">-</span><span class="mi">19</span><span class="n">T23</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mi">11</span><span class="bp">.</span><span class="mi">7517658</span><span class="n">Z</span> <span class="n">TODO</span><span class="o">:</span> <span class="n">change</span> <span class="n">to</span> <span class="n">debug</span> <span class="bp">|</span> <span class="n">llvm</span><span class="bp">-</span><span class="n">config</span><span class="o">:</span> <span class="n">libdir</span> <span class="bp">'/</span><span class="n">home</span><span class="bp">/</span><span class="n">runner</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lib'</span>
</code></pre></div>
<p>Even if the <code>llvm-config</code> was found at <code>llvm-host/...</code>, it still claims the path to the <code>libdir</code> is (correctly!) <code>llvm/lib</code>. How? Is the path somehow "baked into" the <code>llvm-config</code> binary at install time? And since we move <code>llvm</code> to <code>llvm-host</code>, it still points to the right path?</p>



<a name="305097175"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/305097175" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#305097175">(Oct 20 2022 at 07:55)</a>:</h4>
<p>Recall that <code>llvm-host</code> is just a symlink to <code>llvm</code> in this configuration, so this is probably just path normalization</p>



<a name="305861101"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/305861101" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#305861101">(Oct 24 2022 at 16:39)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I am confused about an error when linking against the LLVM in the <code>macos-aarch64</code> configuration: (<a href="https://github.com/bollu/lean4/actions/runs/3314239163/jobs/5473328326#step:8:3025">https://github.com/bollu/lean4/actions/runs/3314239163/jobs/5473328326#step:8:3025</a>)</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">ld64.lld</span><span class="o">:</span> <span class="n">warning</span><span class="o">:</span> <span class="bp">/</span><span class="n">Users</span><span class="bp">/</span><span class="n">runner</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">libLLVMX86AsmParser.a</span><span class="o">(</span><span class="n">X86AsmParser.cpp.o</span><span class="o">)</span> <span class="n">has</span> <span class="n">architecture</span> <span class="n">x86_64</span> <span class="n">which</span> <span class="n">is</span> <span class="n">incompatible</span> <span class="k">with</span> <span class="n">target</span> <span class="n">architecture</span> <span class="n">arm64</span>
</code></pre></div>
<p>I downloaded the file <a href="https://github.com/leanprover/lean-llvm/releases/tag/15.0.1"><code>lean-llvm-aarch64-apple-darwin.tar.zst </code></a>, and I get:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code> <span class="bp"></span> <span class="bp"></span> <span class="n">bollu</span><span class="bp">@</span><span class="n">NC</span> <span class="bp">~/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">aarch64</span><span class="bp">-</span><span class="n">apple</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lib</span> <span class="bp">$</span> <span class="n">file</span> <span class="n">libLLVM.dylib</span>
<span class="n">libLLVM.dylib</span><span class="o">:</span> <span class="n">Mach</span><span class="bp">-</span><span class="n">O</span> <span class="mi">64</span><span class="bp">-</span><span class="n">bit</span> <span class="n">x86_64</span> <span class="n">dynamically</span> <span class="n">linked</span> <span class="n">shared</span> <span class="n">library</span><span class="o">,</span> <span class="n">flags</span><span class="o">:</span><span class="bp">&lt;</span><span class="n">NOUNDEFS</span><span class="bp">|</span><span class="n">DYLDLINK</span><span class="bp">|</span><span class="n">TWOLEVEL</span><span class="bp">|</span><span class="n">WEAK_DEFINES</span><span class="bp">|</span><span class="n">BINDS_TO_WEAK</span><span class="bp">|</span><span class="n">NO_REEXPORTED_DYLIBS</span><span class="bp">|</span><span class="n">HAS_TLV_DESCRIPTORS</span><span class="bp">&gt;</span>
</code></pre></div>
<p>In particular, note:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">libLLVM.dylib</span><span class="o">:</span> <span class="n">Mach</span><span class="bp">-</span><span class="n">O</span> <span class="mi">64</span><span class="bp">-</span><span class="n">bit</span> <span class="n">x86_64</span>
</code></pre></div>
<p>I would have expected it to be <code>aarch64</code>? Could you cross check for me that the release <code>lean-llvm-aarch64-apple-darwin.tar.zst</code> does indeed have an <code>aarch64</code> build? I may well be overlooking something obvious!</p>



<a name="305863618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/305863618" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#305863618">(Oct 24 2022 at 16:53)</a>:</h4>
<p>Oops that doesn't look good</p>



<a name="306012288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/306012288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#306012288">(Oct 25 2022 at 12:03)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Indeed. Could you upload a fresh version of the binaries for me, so I can test that mac build does indeed pass? Thanks!</p>



<a name="306111669"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/306111669" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#306111669">(Oct 25 2022 at 20:01)</a>:</h4>
<p>Unfortunately I'm out of office until next week, but I'll take a look then</p>



<a name="307000400"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307000400" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307000400">(Oct 30 2022 at 19:36)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Quick ping on the PR. The failing build on linux <a href="https://github.com/leanprover/lean4/actions/runs/3356388873/jobs/5561420465">https://github.com/leanprover/lean4/actions/runs/3356388873/jobs/5561420465</a> fails at rebootstrap, since it doesn't pick up the correct version of the bundled LLVM when rebootstrapping. I considered editing the rebootstrap in the <code>.github/ci/workflows.yml</code> to pass the <code>LLVM_CONFIG</code> path, but I do not know what the correct solution is. </p>
<ul>
<li>I wonder if this is the case where we should not even link against LLVM during the rebootstrap, since it only rebuilds stage0?</li>
<li>What ought to happen, in terms of how we pick up the location of LLVM during rebootstrap?</li>
</ul>



<a name="307019197"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307019197" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307019197">(Oct 30 2022 at 23:56)</a>:</h4>
<p>If <code>LLVM_CONFIG</code> should be forwarded to the stage 0 build, it should be whitelisted at <a href="https://github.com/leanprover/lean4/blob/8b9fe9b6c2714b51dc8b25c3f90304e488ec29a6/CMakeLists.txt#L14">https://github.com/leanprover/lean4/blob/8b9fe9b6c2714b51dc8b25c3f90304e488ec29a6/CMakeLists.txt#L14</a></p>



<a name="307019355"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307019355" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307019355">(Oct 30 2022 at 23:59)</a>:</h4>
<p>But your first question raises a more fundamental question to me: how is <code>-DLLVM=OFF</code> even supposed to work? <code>llvm.cpp</code> is compiled in unconditionally, no?</p>



<a name="307021075"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307021075" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307021075">(Oct 31 2022 at 00:29)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> We have <code>LEAN_LLVM</code> preprocessor flag. I was considering using it to <code>#ifdef</code> the entire implementation. I think this was how it used to work in <code>src/util/shell.cpp</code> </p>
<p>I wonder if it's cleaner to configure this at the <code>CMake</code> level, by choosing whether we include the <code>llvm.cpp</code> file?</p>



<a name="307021437"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307021437" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307021437">(Oct 31 2022 at 00:34)</a>:</h4>
<p>That merely seems to move the issue around, do we conditionally include <code>LLVMBindings.lean</code> as well then? There is no such concept yet in our build system.</p>



<a name="307022165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307022165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307022165">(Oct 31 2022 at 00:49)</a>:</h4>
<p>We <code>ifdef</code> the implementations to be empty/stubs. We'll still have the signatures.</p>



<a name="307022223"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307022223" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307022223">(Oct 31 2022 at 00:50)</a>:</h4>
<p>That ought to work, right?</p>



<a name="307027332"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307027332" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307027332">(Oct 31 2022 at 02:22)</a>:</h4>
<p>And otherwise we panic? That sounds workable, yeah!</p>



<a name="307079442"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307079442" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307079442">(Oct 31 2022 at 11:13)</a>:</h4>
<p>Two more questions:</p>
<ol>
<li>Setting up the <a href="https://github.com/leanprover/lean4/pull/1497/commits/32cae3a34ff0dafcb2414dda7ed585bcf3ce8340">argument forwarding</a> did not <a href="https://github.com/leanprover/lean4/actions/runs/3357711982/jobs/5563741186">help with rebootstrap on linux</a>. Do you have a quick guess about what might have gone wrong?</li>
<li>Which builds do we want with <code>-DLLVM=ON</code> and which with <code>-DLLVM=OFF</code>? Should we add another Nix runner, one for each flavor?</li>
</ol>



<a name="307132246"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307132246" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307132246">(Oct 31 2022 at 15:15)</a>:</h4>
<blockquote>
<p>Setting up the argument forwarding did not help with rebootstrap on linux. Do you have a quick guess about what might have gone wrong?</p>
</blockquote>
<p>You'll probably want to remove the <code>${STAGE} GREATER 0</code> check now, no?</p>
<blockquote>
<p>Which builds do we want with -DLLVM=ON and which with -DLLVM=OFF? Should we add another Nix runner, one for each flavor?</p>
</blockquote>
<p>I don't think we need a dedicated LLVM=OFF CI build. Though I wonder what the default experience for building Lean locally should be. Do we expect the code to work with most LLVM versions out there? Should LLVM support silently be deactivated if it is not found?</p>



<a name="307165444"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307165444" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307165444">(Oct 31 2022 at 17:47)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I am unsure what the default should be. I would prefer we are conservatively correct, and do not attempt to use LLVM unless explicitly asked for. </p>
<p>We can still ensure that the releases have LLVM enabled, because we control the build environment.</p>



<a name="307173048"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/307173048" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#307173048">(Oct 31 2022 at 18:26)</a>:</h4>
<p>Sounds good to me. So I guess we won't have to worry about stage 0 after all if it defaults to <code>LLVM=OFF</code>.</p>



<a name="308424729"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/308424729" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#308424729">(Nov 07 2022 at 16:28)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Thanks for the review. I'm currently working towards a PLDI deadline, so I'll need a week before I can check that making everything <code>USize</code> works out fine and dandy <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="311537272"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/311537272" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#311537272">(Nov 22 2022 at 08:03)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> any quick insight on how to build <code>libleanrt.bc</code> correctly? (<a href="https://github.com/leanprover/lean4/pull/1871">https://github.com/leanprover/lean4/pull/1871</a>) I'm not sure what CMake incantation I need to invoke to get my hands on the correct <code>clang</code> flags to invoke it on this line: </p>
<p><a href="https://github.com/leanprover/lean4/pull/1871/files#diff-b54200773c0b5ab32237121a90d2145324228571bce9b10a4c16e1f5361902baR32">https://github.com/leanprover/lean4/pull/1871/files#diff-b54200773c0b5ab32237121a90d2145324228571bce9b10a4c16e1f5361902baR32</a></p>



<a name="311547056"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/311547056" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#311547056">(Nov 22 2022 at 09:03)</a>:</h4>
<p>Can we use <code>leanc</code> for that?</p>



<a name="311557663"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/311557663" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#311557663">(Nov 22 2022 at 10:06)</a>:</h4>
<p>Now I'm confused as to why we included all runtime files in libleanrt.bc before, when all we want is the inlines</p>



<a name="311572156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/311572156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#311572156">(Nov 22 2022 at 11:34)</a>:</h4>
<p>This seems to work: <a href="https://github.com/Kha/lean4/commit/7504fc6514433e50c1cc6a2a82a34df835e8371d">https://github.com/Kha/lean4/commit/7504fc6514433e50c1cc6a2a82a34df835e8371d</a></p>



<a name="311572190"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/311572190" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#311572190">(Nov 22 2022 at 11:35)</a>:</h4>
<p>I took the liberty to rename the file as it didn't fit the old name anymore</p>



<a name="312097614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/312097614" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#312097614">(Nov 24 2022 at 23:52)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span>  I'm debugging  link failures of executables that <code>import Lean</code> complain about missing LLVM symbols:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">bollu</span> <span class="bp"></span> <span class="bp"></span> <span class="n">cat</span> <span class="n">bar.lean</span>
<span class="kn">import</span> <span class="n">Lean</span>
<span class="kn">open</span> <span class="n">Lean</span>

<span class="kd">def</span> <span class="n">main</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span> <span class="o">:=</span> <span class="n">return</span> <span class="o">()</span>
<span class="n">bollu</span> <span class="bp"></span> <span class="bp"></span> <span class="n">lean</span> <span class="n">bar.lean</span> <span class="bp">-</span><span class="n">c</span> <span class="n">bar.cpp</span>

<span class="n">bollu</span> <span class="bp"></span> <span class="bp"></span> <span class="n">leanc</span> <span class="n">bar.cpp</span> <span class="bp">-</span><span class="n">o</span> <span class="n">bar</span>
<span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">libleancpp.a</span><span class="o">(</span><span class="n">llvmxx.cpp.o</span><span class="o">):</span> <span class="k">in</span> <span class="n">function</span>
<span class="n">llvmxx.cpp</span><span class="o">:(</span><span class="bp">.</span><span class="n">text</span><span class="bp">+</span><span class="mi">0x74</span><span class="o">):</span> <span class="n">undefined</span> <span class="n">reference</span> <span class="n">to</span> <span class="bp">`</span><span class="n">LLVMPrintTypeToString'</span>
</code></pre></div>
<ul>
<li>
<p><code>import Lean</code> causes <code>lean_initialize();</code> to be emitted in the <code>c++</code> code, instead of <code>lean_initialize_runtime_module</code>.<br>
    Disabling <code>lean_initialize</code> removes the missing symbols errors.</p>
</li>
<li>
<p><code>lean_initialize</code> is defined at <code>src/initialize/init.cpp</code></p>
</li>
</ul>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="n">initialize</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">cpp</span><span class="w"></span>
<span class="mi">26</span><span class="o">:</span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">lean_initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="mi">52</span><span class="o">:</span><span class="w">    </span><span class="n">lean_initialize</span><span class="p">();</span><span class="w"></span>
<span class="mi">55</span><span class="o">:</span><span class="w">    </span><span class="n">See</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="err">`</span><span class="n">lean_initialize</span><span class="err">`</span><span class="p">.</span><span class="w"> </span><span class="o">*/</span><span class="w"></span>
</code></pre></div>
<ul>
<li>This shows up due to <code>libleancpp.a</code>:</li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">libleancpp.a</span><span class="o">(</span><span class="n">llvm.cpp.o</span><span class="o">):</span> <span class="k">in</span> <span class="n">function</span> <span class="bp">`</span><span class="n">lean_llvm_type_of'</span><span class="o">:</span>
<span class="n">llvm.cpp</span><span class="o">:(</span><span class="bp">.</span><span class="n">text</span><span class="bp">+</span><span class="mi">0x31ca</span><span class="o">):</span> <span class="n">undefined</span> <span class="n">reference</span> <span class="n">to</span> <span class="bp">`</span><span class="n">LLVMPrintValueToString'</span>
</code></pre></div>
<ul>
<li><code>leanc --print-ldflags</code> tells us that <code>libleancpp.a</code> is included by _every_ executable that <code>leanc</code> builds:</li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">bollu</span> <span class="bp"></span> <span class="bp"></span> <span class="n">leanc</span> <span class="c1">--print-ldflags</span>
<span class="bp">-</span><span class="n">I</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="kn">include</span> <span class="bp">-</span><span class="n">fPIC</span> <span class="bp">-</span><span class="n">fvisibility</span><span class="bp">=</span><span class="n">hidden</span> <span class="bp">-</span><span class="n">L</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">lean</span> <span class="bp">-</span><span class="n">Wl</span><span class="o">,</span><span class="c1">--start-group -lleancpp -lLean -Wl,--end-group -Wl,--start-group -lInit -lleanrt -Wl,--end-group -lstdc++ -lm  /usr/lib/libgmp.so -ldl -pthread</span>
</code></pre></div>
<ul>
<li>Option (1) treat <code>LLVM</code> like <code>gmp</code>, and add the flags to link LLVM into every executable we build via <code>leanc</code></li>
<li>Option (2) add LLVM and the associated bindings as a library which is only included by <code>lean</code>, and nobody else.</li>
<li>I assume we prefer Option (2)? It's not clear to me yet where in the CMake I ought to build the LLVM bindings and<br>
  link them <em>only</em> into <code>lean</code>.</li>
</ul>



<a name="312140458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/312140458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#312140458">(Nov 25 2022 at 09:00)</a>:</h4>
<p><span class="user-mention" data-user-id="130575">@Siddharth Bhat</span> I think you misunderstand static archives. An archive file (even more precisely, a section of it) is included only if it is needed. Could you post the output of linking such a binary with <code>--trace-symbol=lean_llvm_type_of</code>?</p>



<a name="312141676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/312141676" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#312141676">(Nov 25 2022 at 09:07)</a>:</h4>
<p>Oh I see you added a new initializer called by <code>lean_initialize</code>, that certainly explains it</p>



<a name="312143758"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/312143758" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#312143758">(Nov 25 2022 at 09:21)</a>:</h4>
<p>I would suggest to instead call the LLVM initializer directly in <code>shell.cpp</code>. We probably shouldn't worry about external users of the LLVM modules for now.</p>



<a name="312309905"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/312309905" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#312309905">(Nov 26 2022 at 08:59)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> , <a href="https://gist.github.com/bollu/44089723e6782ff2eee50fb710417bfc">here's the output from trace-symbol</a></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">bollu</span>  <span class="bp"></span> <span class="n">leanc</span> <span class="bp">-</span><span class="n">Wl</span><span class="o">,</span><span class="c1">--trace-symbol=lean_llvm_type_of bar.cpp -o bar.out</span>
<span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">libleancpp.a</span><span class="o">(</span><span class="n">llvm.cpp.o</span><span class="o">):</span> <span class="kd">definition</span> <span class="n">of</span> <span class="n">lean_llvm_type_of</span>
<span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">libLean.a</span><span class="o">(</span><span class="n">LLVMBindings.o</span><span class="o">):</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">lean_llvm_type_of</span>
<span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">libleancpp.a</span><span class="o">(</span><span class="n">llvm.cpp.o</span><span class="o">):</span> <span class="k">in</span> <span class="n">function</span> <span class="bp">`</span><span class="n">lean_llvm_create_context'</span><span class="o">:</span>
<span class="n">llvm.cpp</span><span class="o">:(</span><span class="bp">.</span><span class="n">text</span><span class="bp">+</span><span class="mi">0x1c5</span><span class="o">):</span> <span class="n">undefined</span> <span class="n">reference</span> <span class="n">to</span> <span class="bp">`</span><span class="n">LLVMContextCreate'</span>
<span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">libleancpp.a</span><span class="o">(</span><span class="n">llvm.cpp.o</span><span class="o">):</span> <span class="k">in</span> <span class="n">function</span> <span class="bp">`</span><span class="n">lean_llvm_create_module'</span><span class="o">:</span>
<span class="n">llvm.cpp</span><span class="o">:(</span><span class="bp">.</span><span class="n">text</span><span class="bp">+</span><span class="mi">0x22f</span><span class="o">):</span> <span class="n">undefined</span> <span class="n">reference</span> <span class="n">to</span> <span class="bp">`</span><span class="n">LLVMModuleCreateWithNameInContext'</span>
<span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">libleancpp.a</span><span class="o">(</span><span class="n">llvm.cpp.o</span><span class="o">):</span> <span class="k">in</span> <span class="n">function</span> <span class="bp">`</span><span class="n">lean_llvm_write_bitcode_to_file'</span><span class="o">:</span>
<span class="n">llvm.cpp</span><span class="o">:(</span><span class="bp">.</span><span class="n">text</span><span class="bp">+</span><span class="mi">0x299</span><span class="o">):</span> <span class="n">undefined</span> <span class="n">reference</span> <span class="n">to</span> <span class="bp">`</span><span class="n">LLVMWriteBitcodeToFile'</span>
<span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">libleancpp.a</span><span class="o">(</span><span class="n">llvm.cpp.o</span><span class="o">):</span> <span class="k">in</span> <span class="n">function</span> <span class="bp">`</span><span class="n">lean_llvm_module_to_string'</span><span class="o">:</span>
<span class="n">llvm.cpp</span><span class="o">:(</span><span class="bp">.</span><span class="n">text</span><span class="bp">+</span><span class="mi">0x335</span><span class="o">):</span> <span class="n">undefined</span> <span class="n">reference</span> <span class="n">to</span> <span class="bp">`</span><span class="n">LLVMPrintModuleToString'</span>
<span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">bollu</span><span class="bp">/</span><span class="n">work</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">stage1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">libleancpp.a</span><span class="o">(</span><span class="n">llvm.cpp.o</span><span class="o">):</span> <span class="k">in</span> <span class="n">function</span> <span class="bp">`</span><span class="n">lean_llvm_add_function'</span><span class="o">:</span>
<span class="bp">...</span>
</code></pre></div>



<a name="312311553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/312311553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#312311553">(Nov 26 2022 at 09:14)</a>:</h4>
<p>Hmm, I guess we have to continue with <code>LLVMBindings.o</code> then :) ? Not sure how to best do that since the flag expects a symbol, not a whole file. But looking at your code again, I assume the reason is that you reference <code>lean_ir_emit_llvm</code> in <code>src/library/compiler/ir.cpp</code>. You should probably move that to <code>llvm.cpp</code> so that only <code>shell.cpp</code> depends on it.</p>



<a name="312312737"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/312312737" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#312312737">(Nov 26 2022 at 09:27)</a>:</h4>
<p>Just to reiterate, yes, separating the LLVM parts into separate libraries on both the Lean and C++ side might have been a nicer approach! More setup but less guessing. But I think we're close now.</p>



<a name="314523092"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/314523092" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#314523092">(Dec 07 2022 at 18:03)</a>:</h4>
<p><a href="https://github.com/leanprover/lean4/actions/runs/3641124687/jobs/6146687901">https://github.com/leanprover/lean4/actions/runs/3641124687/jobs/6146687901</a></p>
<ul>
<li>Linux{Debug, aarch64, fsanitize}: now compiles successfully</li>
<li>Linux release/Windows: Segfaults </li>
<li>Macos: LLVM includes broke again, need to figure out what's going on.</li>
<li>Nix: Due to the way the nix artifact is built, the path to <code>lib.h.bc</code> isn't resolved correctly. <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> , I'll send a more coherent explanation tomorrow, it would be nice to resolve this particular build issue.</li>
</ul>



<a name="314660003"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/314660003" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#314660003">(Dec 08 2022 at 12:01)</a>:</h4>
<p>The Nix build is green now. Does the non-Nix build segfault for you locally as well or only on CI?</p>



<a name="314728881"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/314728881" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#314728881">(Dec 08 2022 at 17:38)</a>:</h4>
<p><span class="user-mention" data-user-id="130575">@Siddharth Bhat</span> :)</p>



<a name="314730561"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/314730561" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#314730561">(Dec 08 2022 at 17:47)</a>:</h4>
<p>I can repro the segfault locally as well. I had to b aw q QQ 1ump up my local LLVM version to 15. LLVM 15 changed how pointers in LLVM work, which means the code I wrote based on old style pointers segfaults. Updating it to the new style now!</p>



<a name="314730623"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/314730623" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#314730623">(Dec 08 2022 at 17:47)</a>:</h4>
<p>I wonder what happens now with nix, since IIRC, we only have LLVM 14 on nix</p>



<a name="314732552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/314732552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#314732552">(Dec 08 2022 at 17:56)</a>:</h4>
<p>Oops. Either we'll have to disable LLVM support for Nix or I'll make it use lean-llvm (though weren't there some <code>patchelf</code> issues... <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> ). I guess the latter would have to happen anyway if we ever go serious and fork LLVM like Rust does.</p>



<a name="314737530"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/314737530" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Bving <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#314737530">(Dec 08 2022 at 18:04)</a>:</h4>
<p>"I had to b aw q QQ 1ump"</p>
<p>You what? :D</p>



<a name="314756151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/314756151" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#314756151">(Dec 08 2022 at 19:38)</a>:</h4>
<p>I think some rogue pointers wrote some extra data into that message.</p>



<a name="315348209"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/315348209" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#315348209">(Dec 12 2022 at 11:51)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Looks like the CI is green: <a href="https://github.com/leanprover/lean4/actions/runs/3674916789/jobs/6213714189">https://github.com/leanprover/lean4/actions/runs/3674916789/jobs/6213714189</a></p>



<a name="315348553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/315348553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#315348553">(Dec 12 2022 at 11:53)</a>:</h4>
<p>Time to clean up the patch :)</p>



<a name="315348618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/315348618" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#315348618">(Dec 12 2022 at 11:53)</a>:</h4>
<p>Yay!</p>



<a name="315350276"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/315350276" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#315350276">(Dec 12 2022 at 12:02)</a>:</h4>
<p>I just realised -- I've never tested <code>stage2</code> with <code>-DLLVM=ON</code>, <del>and furthermore, this would fail, because the lean compiler has uses of <code>extern c inline</code> in a bunch of places which the LLVM backend cannot reasonably support, as it would require code generation of arbitrary C expressions into LLVM. </del> EDIT: that's not true, it would only fail if we invoke the stage2 build with the LLVM backend, which we don't have any support for anyway...  </p>
<p>I propose we think about supporting <code>stage2</code> builds of LLVM, if we want it, <em>after</em> we merge this patch, please? <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="315352422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/315352422" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#315352422">(Dec 12 2022 at 12:14)</a>:</h4>
<p>Sure, as long as users are not expected to use it yet anyway :)</p>



<a name="318755941"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/318755941" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tobias Grosser <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#318755941">(Dec 31 2022 at 15:53)</a>:</h4>
<p>This had been merged. Thank you all for this great effort so far. <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span><span aria-label="clap" class="emoji emoji-1f44f" role="img" title="clap">:clap:</span></p>



<a name="320796727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/320796727" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#320796727">(Jan 11 2023 at 21:01)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> : We have 15 occurrences of <code>extern c inline</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">~/</span><span class="n">work</span><span class="bp">/</span><span class="n">new</span><span class="bp">/</span><span class="n">lean</span><span class="bp">-</span><span class="n">llvm</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">build</span> <span class="n">rg</span> <span class="s2">"extern c inline"</span> <span class="bp">../</span><span class="n">src</span>
<span class="bp">../</span><span class="n">src</span><span class="bp">/</span><span class="n">Lean</span><span class="bp">/</span><span class="n">Expr.lean</span>
<span class="mi">155</span><span class="o">:</span><span class="kd">@[extern c inline "(uint64_t)#1"]</span>
<span class="mi">462</span><span class="o">:</span>  <span class="kd">@[computed_field, extern c inline "lean_ctor_get_uint64(#1, lean_ctor_num_objs(#1)*sizeof(void*))"]</span>

<span class="bp">../</span><span class="n">src</span><span class="bp">/</span><span class="n">Lean</span><span class="bp">/</span><span class="n">Compiler</span><span class="bp">/</span><span class="n">IR</span><span class="bp">/</span><span class="n">Checker.lean</span>
<span class="mi">11</span><span class="o">:</span><span class="kd">@[extern c inline "lean_box(LEAN_MAX_CTOR_FIELDS)"]</span>
<span class="mi">15</span><span class="o">:</span><span class="kd">@[extern c inline "lean_box(LEAN_MAX_CTOR_SCALARS_SIZE)"]</span>
<span class="mi">19</span><span class="o">:</span><span class="kd">@[extern c inline "lean_box(sizeof(size_t))"]</span>

<span class="bp">../</span><span class="n">src</span><span class="bp">/</span><span class="n">Init</span><span class="bp">/</span><span class="n">Core.lean</span>
<span class="mi">467</span><span class="o">:</span><span class="kd">@[extern c inline "#1 || #2"]</span> <span class="kd">def</span> <span class="n">strictOr</span>  <span class="o">(</span><span class="n">b</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Bool</span><span class="o">)</span> <span class="o">:=</span> <span class="n">b</span> <span class="bp">||</span> <span class="n">b</span>
<span class="mi">473</span><span class="o">:</span><span class="kd">@[extern c inline "#1 &amp;&amp; #2"]</span> <span class="kd">def</span> <span class="n">strictAnd</span> <span class="o">(</span><span class="n">b</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Bool</span><span class="o">)</span> <span class="o">:=</span> <span class="n">b</span> <span class="bp">&amp;&amp;</span> <span class="n">b</span>

<span class="bp">../</span><span class="n">src</span><span class="bp">/</span><span class="n">Init</span><span class="bp">/</span><span class="n">Meta.lean</span>
<span class="mi">14</span><span class="o">:</span><span class="kd">@[extern c inline "lean_box(LEAN_VERSION_MAJOR)"]</span>
<span class="mi">18</span><span class="o">:</span><span class="kd">@[extern c inline "lean_box(LEAN_VERSION_MINOR)"]</span>
<span class="mi">22</span><span class="o">:</span><span class="kd">@[extern c inline "lean_box(LEAN_VERSION_PATCH)"]</span>
<span class="mi">30</span><span class="o">:</span><span class="kd">@[extern c inline "LEAN_VERSION_IS_RELEASE"]</span>
<span class="mi">35</span><span class="o">:</span><span class="kd">@[extern c inline "lean_mk_string(LEAN_SPECIAL_VERSION_DESC)"]</span>
<span class="mi">64</span><span class="o">:</span><span class="kd">@[extern c inline "LEAN_IS_STAGE0"]</span>

<span class="bp">../</span><span class="n">src</span><span class="bp">/</span><span class="n">Lean</span><span class="bp">/</span><span class="n">Data</span><span class="bp">/</span><span class="n">HashSet.lean</span>
<span class="mi">30</span><span class="o">:</span><span class="kd">@[extern c inline "(size_t)(#2) &amp; (lean_unbox(#1) - 1)"]</span>

<span class="bp">../</span><span class="n">src</span><span class="bp">/</span><span class="n">Init</span><span class="bp">/</span><span class="n">Prelude.lean</span>
<span class="mi">1595</span><span class="o">:</span><span class="kd">@[extern c inline "lean_nat_sub(#1, lean_box(1))"]</span>
</code></pre></div>
<p>Recall that I had moved one of the <code>extern c inline</code> definitions into <code>src/include/lean/lean.h</code>. I plan on moving all the rest as well for the <code>stage2</code> build. Does that sound sensible to you?</p>



<a name="320798344"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/320798344" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#320798344">(Jan 11 2023 at 21:11)</a>:</h4>
<p>Yes, I don't think <code>lean.h</code> is inappropriate here</p>



<a name="320956257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/320956257" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#320956257">(Jan 12 2023 at 14:49)</a>:</h4>
<p>I'm noting down a concern I have with moving inline <code>extern</code> definitions to become out-of-line, though I can't think of a good solution.</p>
<p>As I port some of the <code>extern c inline</code> definitions we have, I see that an inductive such as <code>BinderInfo</code> which is a pure C style enumeration is compiled down to <code>uint8</code> </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">BinderInfo</span> <span class="n">where</span>
  <span class="sd">/-- Default binder annotation, e.g. `(x : )` -/</span>
  <span class="bp">|</span> <span class="n">default</span>
  <span class="sd">/-- Implicit binder annotation, e.g., `{x : }` -/</span>
  <span class="bp">|</span> <span class="n">implicit</span>
  <span class="sd">/-- Strict implict binder annotation, e.g., `{{ x :   }}` -/</span>
  <span class="bp">|</span> <span class="n">strictImplicit</span>
  <span class="sd">/-- Local instance binder annotataion, e.g., `[Decidable ]` -/</span>
  <span class="bp">|</span> <span class="n">instImplicit</span>
  <span class="n">deriving</span> <span class="n">Inhabited</span><span class="o">,</span> <span class="n">BEq</span><span class="o">,</span> <span class="n">Repr</span>
</code></pre></div>
<p>I am now concerned that changing the definition from:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern c inline "(uint64_t)#1"]</span>
<span class="kd">def</span> <span class="n">BinderInfo.toUInt64</span> <span class="o">:</span> <span class="n">BinderInfo</span> <span class="bp"></span> <span class="n">UInt64</span>
  <span class="bp">|</span> <span class="bp">.</span><span class="n">default</span>        <span class="bp">=&gt;</span> <span class="mi">0</span>
  <span class="bp">|</span> <span class="bp">.</span><span class="n">implicit</span>       <span class="bp">=&gt;</span> <span class="mi">1</span>
  <span class="bp">|</span> <span class="bp">.</span><span class="n">strictImplicit</span> <span class="bp">=&gt;</span> <span class="mi">2</span>
  <span class="bp">|</span> <span class="bp">.</span><span class="n">instImplicit</span>   <span class="bp">=&gt;</span> <span class="mi">3</span>
</code></pre></div>
<p>to:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "lean_expr_binderinfo_to_uint64"]</span>
<span class="kd">def</span> <span class="n">BinderInfo.toUInt64</span> <span class="o">:</span> <span class="n">BinderInfo</span> <span class="bp"></span> <span class="n">UInt64</span>
  <span class="bp">|</span> <span class="bp">.</span><span class="n">default</span>        <span class="bp">=&gt;</span> <span class="mi">0</span>
  <span class="bp">|</span> <span class="bp">.</span><span class="n">implicit</span>       <span class="bp">=&gt;</span> <span class="mi">1</span>
  <span class="bp">|</span> <span class="bp">.</span><span class="n">strictImplicit</span> <span class="bp">=&gt;</span> <span class="mi">2</span>
  <span class="bp">|</span> <span class="bp">.</span><span class="n">instImplicit</span>   <span class="bp">=&gt;</span> <span class="mi">3</span>
</code></pre></div>
<p>with the function <code>lean_expr_binderinfo_to_uint64</code> defined in <code>lean.h</code>  could lead to hard to debug errors when the ABI changes.</p>



<a name="320964288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/320964288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#320964288">(Jan 12 2023 at 15:21)</a>:</h4>
<p>I think we're just missing better code generation for <code>toCtorIdx</code> to make this inline obsolete, so consider the move temporary</p>



<a name="320969658"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/341532-lean4%20dev/topic/%5BCompiler%5D%20LLVM%20Backend/near/320969658" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/341532-lean4-dev/topic/.5BCompiler.5D.20LLVM.20Backend.html#320969658">(Jan 12 2023 at 15:43)</a>:</h4>
<p>Huh, this code generation is surprisingly bad for clang. But they both do the right thing when <code>toCtorIdx</code> is just <code>return lean_unsigned_to_nat(x_1)</code> <a href="https://godbolt.org/z/4ddrvoW8x">https://godbolt.org/z/4ddrvoW8x</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>