---
layout: archive
title: Zulip Chat Archive
permalink: /stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/index.html">Is there code for X?</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html">Rewrite once</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="311717700"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311717700" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ben <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311717700">(Nov 22 2022 at 22:02)</a>:</h4>
<p>Is there a way to rewrite a pattern once. Say I have <code>d : 0 = 0 + 0</code> if I <code>rw</code> that on goal <code>0 = 0</code> I end up with new goal <code>0 + 0 = 0 + 0</code>. Is there a way to apply it to only get <code>0 + 0 = 0</code>?</p>



<a name="311717952"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311717952" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ben <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311717952">(Nov 22 2022 at 22:04)</a>:</h4>
<p>Even better a rewrite if I can choose what side of the equality to apply it to</p>



<a name="311719914"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311719914" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311719914">(Nov 22 2022 at 22:19)</a>:</h4>
<p>Check out the following tactics: <a href="https://leanprover-community.github.io/mathlib_docs/tactics.html#conv_lhs">tactic#conv_lhs</a> , <a href="https://leanprover-community.github.io/mathlib_docs/tactics.html#conv_rhs">tactic#conv_rhs</a> and <a href="https://leanprover-community.github.io/mathlib_docs/tactics.html#nth_rewrite">tactic#nth_rewrite</a> .  In short there are several ways to do it :-)</p>



<a name="311720258"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311720258" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311720258">(Nov 22 2022 at 22:22)</a>:</h4>
<p>Did I dream the first two tactics? I can't find them in the docs</p>



<a name="311720643"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311720643" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311720643">(Nov 22 2022 at 22:24)</a>:</h4>
<p>They are part of <a href="https://leanprover-community.github.io/mathlib_docs/tactics.html#conv">tactic#conv</a>. So it's <a href="https://leanprover-community.github.io/mathlib_docs/find/tactic.conv.conv_lhs">docs#tactic.conv.conv_lhs</a>. Also worth mentioning <a href="https://leanprover-community.github.io/mathlib_docs/tactics.html#nth_rewrite_lhs">tactic#nth_rewrite_lhs</a>, <a href="https://leanprover-community.github.io/mathlib_docs/tactics.html#nth_rewrite_rhs">tactic#nth_rewrite_rhs</a>.</p>



<a name="311784061"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311784061" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311784061">(Nov 23 2022 at 09:26)</a>:</h4>
<p><code>rw</code> has some configuration options too. One is for specifying which occurrences should be rewritten.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">d</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">+</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">↔</span> <span class="gr">sorry</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">d</span><span class="o">]</span> <span class="o">{</span> <span class="n">occs</span> <span class="o">:=</span> <span class="n">occurrences.pos</span> <span class="o">[</span><span class="mi">1</span><span class="o">]},</span>
  <span class="c1">-- ⊢ 0 + 0 = 0 ↔ sorry</span>
<span class="kd">end</span>
</code></pre></div>
<p>(I put the <code>iff sorry</code> in there to prevent <code>rw</code> from closing the <code>0 = 0</code> goal automatically with <code>refl</code>!)</p>



<a name="311784123"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311784123" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311784123">(Nov 23 2022 at 09:27)</a>:</h4>
<p><a href="https://leanprover-community.github.io/mathlib_docs/find/occurrences">docs#occurrences</a> gives some explanation. The default is <code>occurrences.all</code></p>



<a name="311821458"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311821458" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311821458">(Nov 23 2022 at 13:06)</a>:</h4>
<p>There is a pretty weird bug/feature in <code>occurrences</code>: if the rule you're rewriting by has variables, they will get "stuck" when traversing the expression, and so it will not find later rewrites with different values of the variables.</p>
<p>Thus:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">foo</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">(</span><span class="n">d</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">i</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="mi">2</span> <span class="bp">≠</span> <span class="n">f</span> <span class="mi">3</span> <span class="o">:=</span> <span class="kd">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">d</span><span class="o">]</span> <span class="o">{</span> <span class="n">occs</span> <span class="o">:=</span> <span class="n">occurrences.pos</span> <span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">},</span>
<span class="kd">end</span>
</code></pre></div>
<p>fails. This is why <code>nth_rewrite</code> exists, essentially.</p>



<a name="311821519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311821519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311821519">(Nov 23 2022 at 13:07)</a>:</h4>
<p>I haven't got around to checking how this behaves in Lean 4, however.</p>



<a name="311822490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311822490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ben <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311822490">(Nov 23 2022 at 13:11)</a>:</h4>
<p>Wow that is cool, didn't know you could provide arguments to tactics like that! nth_rewrite is also perfect + more readable, but good to know it is possible outside of mathlib</p>



<a name="311822731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311822731" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311822731">(Nov 23 2022 at 13:12)</a>:</h4>
<p>Just to explain this bug/feature (based on my understanding), the <code>occurrences.pos</code>/<code>occurrences.neg</code> is configuring which positions are being rewritten with respect to the positions it would have rewritten without that configuration option. That <code>lemma foo</code> example fails because <code>rw [d]</code> would have only rewritten the <code>f 2</code> ==&gt; <code>2</code>.</p>



<a name="311822997"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311822997" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311822997">(Nov 23 2022 at 13:14)</a>:</h4>
<p>This is because <code>rw</code> works by (1) finding something it can rewrite to specialize all the variables in the rewrite lemma then (2) looks for all occurrences, then (3) rewrites all the occurrences (configured by <code>occs</code>) simultaneously using a single <code>eq.rec</code>.</p>



<a name="311823051"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311823051" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311823051">(Nov 23 2022 at 13:14)</a>:</h4>
<p>Maybe I should have called it a feature/bug rather than a bug/feature. Kyle's description makes is sound much more reasonable, but this behaviour can be annoying when you're trying to do a "weird" rewrite.</p>



<a name="311823204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311823204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311823204">(Nov 23 2022 at 13:15)</a>:</h4>
<p>This is a good gotcha for <code>occs</code>. I have to admit I've never used it, only <code>nth_rewrite</code> or <code>conv</code> mode!</p>



<a name="311823310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/Rewrite%20once/near/311823310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/Rewrite.20once.html#311823310">(Nov 23 2022 at 13:16)</a>:</h4>
<p>It seems like <code>rw</code> should have an extra configuration for how it finds the thing to rewrite in the first place...</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>