---
layout: archive
title: Zulip Chat Archive
permalink: /stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/index.html">Is there code for X?</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html">equality in sigma-types</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="260538849"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260538849" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260538849">(Nov 06 2021 at 22:05)</a>:</h4>
<p>I haven't worked with sigma-types before.  How do I rewrite a fact by an equality in the type?  Something like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">{</span><span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="n">ι</span> <span class="bp">→</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">(</span><span class="n">P</span> <span class="o">:</span> <span class="o">(</span><span class="bp">Σ</span> <span class="n">i</span><span class="o">,</span> <span class="n">α</span> <span class="n">i</span><span class="o">)</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">{</span><span class="n">i</span> <span class="n">i'</span> <span class="o">:</span> <span class="n">ι</span><span class="o">}</span> <span class="o">(</span><span class="n">hi</span> <span class="o">:</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">i'</span><span class="o">)</span>
  <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="o">:</span> <span class="n">α</span> <span class="n">i</span><span class="o">,</span> <span class="n">P</span> <span class="o">⟨</span><span class="n">i</span><span class="o">,</span> <span class="n">a</span><span class="o">⟩)</span>  <span class="o">:</span>
  <span class="bp">∀</span> <span class="n">a</span> <span class="o">:</span> <span class="n">α</span> <span class="n">i'</span><span class="o">,</span> <span class="n">P</span> <span class="o">⟨</span><span class="n">i'</span><span class="o">,</span> <span class="n">a</span><span class="o">⟩</span> <span class="o">:=</span>
<span class="gr">sorry</span>
</code></pre></div>



<a name="260538929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260538929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260538929">(Nov 06 2021 at 22:06)</a>:</h4>
<p><code>subst hi</code>?</p>



<a name="260538947"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260538947" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260538947">(Nov 06 2021 at 22:06)</a>:</h4>
<p>Aha!  Thank you!</p>



<a name="260538957"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260538957" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yury G. Kudryashov <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260538957">(Nov 06 2021 at 22:07)</a>:</h4>
<p>This only works if <code>i</code> or <code>i'</code> is a variable, not an expression.</p>



<a name="260539076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260539076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260539076">(Nov 06 2021 at 22:09)</a>:</h4>
<p>It works in my use case, anyway.</p>



<a name="260539745"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260539745" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260539745">(Nov 06 2021 at 22:25)</a>:</h4>
<p><code>cases hi</code> is sometimes useful, too.</p>



<a name="260541060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260541060" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260541060">(Nov 06 2021 at 22:59)</a>:</h4>
<p>nice trick! (spoiler alert: turns <code>i = i'</code> into <code>i = i</code>)</p>



<a name="260541140"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260541140" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260541140">(Nov 06 2021 at 23:00)</a>:</h4>
<p>In fact is this how <code>subst</code> works? I always imagined it would be super-complicated!</p>



<a name="260541208"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260541208" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260541208">(Nov 06 2021 at 23:01)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">meta</span> <span class="kd">def</span> <span class="n">subst</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">expr</span><span class="o">)</span> <span class="o">:</span> <span class="n">tactic</span> <span class="n">unit</span> <span class="o">:=</span>
<span class="o">(</span><span class="k">do</span> <span class="n">guard</span> <span class="n">h.is_local_constant</span><span class="o">,</span>
    <span class="n">some</span> <span class="o">(</span><span class="n">α</span><span class="o">,</span> <span class="n">lhs</span><span class="o">,</span> <span class="n">β</span><span class="o">,</span> <span class="n">rhs</span><span class="o">)</span> <span class="bp">←</span> <span class="n">expr.is_heq</span> <span class="bp">&lt;$&gt;</span> <span class="n">infer_type</span> <span class="n">h</span><span class="o">,</span>
    <span class="n">is_def_eq</span> <span class="n">α</span> <span class="n">β</span><span class="o">,</span>
    <span class="n">new_h_type</span> <span class="bp">←</span> <span class="n">mk_app</span> <span class="bp">`</span><span class="n">eq</span> <span class="o">[</span><span class="n">lhs</span><span class="o">,</span> <span class="n">rhs</span><span class="o">],</span>
    <span class="n">new_h_pr</span>   <span class="bp">←</span> <span class="n">mk_app</span> <span class="bp">`</span><span class="n">eq_of_heq</span> <span class="o">[</span><span class="n">h</span><span class="o">],</span>
    <span class="n">new_h</span> <span class="bp">←</span> <span class="n">assertv</span> <span class="n">h.local_pp_name</span> <span class="n">new_h_type</span> <span class="n">new_h_pr</span><span class="o">,</span>
    <span class="n">try</span> <span class="o">(</span><span class="n">clear</span> <span class="n">h</span><span class="o">),</span>
    <span class="n">subst_core</span> <span class="n">new_h</span><span class="o">)</span>
<span class="bp">&lt;|&gt;</span> <span class="n">subst_core</span> <span class="n">h</span>
<span class="kd">end</span> <span class="n">tactic</span>
</code></pre></div>
<p>(this is <code>tactic.subst</code>, what <code>tactic.interactive.subst</code> uses). It's at this point I wish I understood meta stuff :-/</p>



<a name="260541341"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260541341" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260541341">(Nov 06 2021 at 23:04)</a>:</h4>
<p>Note that <a href="https://leanprover-community.github.io/mathlib_docs/tactics.html#subst">tactic#subst</a> can also often be replaced with a pattern-match, in this case by moving <code>i i' h</code> right of the colon and matching on <code>_ _ rfl</code></p>



<a name="260541711"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260541711" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260541711">(Nov 06 2021 at 23:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110038">Kevin Buzzard</span> <a href="#narrow/stream/217875-Is-there.20code.20for.20X.3F/topic/equality.20in.20sigma-types/near/260541140">said</a>:</p>
<blockquote>
<p>In fact is this how <code>subst</code> works? I always imagined it would be super-complicated!</p>
</blockquote>
<p>I had the same question, and I got as far as finding it ends up being written in C++, which these <code>meta constant</code>s all are:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c">/-</span><span class="cm"> Given a local constant t, if t has type (lhs = rhs) apply substitution.</span>
<span class="cm">   Otherwise, try to find a local constant that has type of the form (t = t') or (t' = t).</span>
<span class="cm">   The tactic fails if the given expression is not a local constant. -/</span>
<span class="kd">meta</span> <span class="kd">constant</span> <span class="n">subst_core</span>     <span class="o">:</span> <span class="n">expr</span> <span class="bp">→</span> <span class="n">tactic</span> <span class="n">unit</span>
</code></pre></div>



<a name="260541920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260541920" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260541920">(Nov 06 2021 at 23:17)</a>:</h4>
<p>lol <a href="https://github.com/leanprover-community/lean/issues/646">lean#646</a></p>



<a name="260542041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260542041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260542041">(Nov 06 2021 at 23:20)</a>:</h4>
<p>So where can we see the actual definition <code>subst_core</code> in the repo? I've never gone this deep before.</p>



<a name="260542065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260542065" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260542065">(Nov 06 2021 at 23:21)</a>:</h4>
<p>found it, thanks git grep -- it's presumably <a href="https://github.com/leanprover-community/lean/blob/63dc257c30d0a71f91c1e706e447256f53139be7/src/library/tactic/subst_tactic.cpp#L124">this</a></p>



<a name="260542186"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260542186" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260542186">(Nov 06 2021 at 23:24)</a>:</h4>
<p>actually judging by <a href="https://github.com/leanprover-community/lean/blob/63dc257c30d0a71f91c1e706e447256f53139be7/src/library/tactic/subst_tactic.cpp#L187">this</a> it's actually <a href="https://github.com/leanprover-community/lean/blob/63dc257c30d0a71f91c1e706e447256f53139be7/src/library/tactic/subst_tactic.cpp#L136">this</a>?</p>



<a name="260542269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260542269" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260542269">(Nov 06 2021 at 23:27)</a>:</h4>
<p>right so i <em>think</em> it's a C++ program which literally recurses into the expression and replaces one term by the other? Is this part of the fabled "kernel" I've heard so much about? Or are we not there yet?</p>



<a name="260542407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260542407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260542407">(Nov 06 2021 at 23:31)</a>:</h4>
<p>This is the elaborator -- there are things like <code>mk_eq_drec</code> to create the rewrites that show up in the proof term that the tactic proof creates. This all gets shipped off to the kernel to do a final check that everything was created correctly.</p>



<a name="260542510"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260542510" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260542510">(Nov 06 2021 at 23:35)</a>:</h4>
<p>(I'm not actually sure how to classify which part of Lean this is, other than we're not at the kernel yet.  This is specifically some C++ code implementing a tactic, and I think in principle it could be written in Lean.)</p>



<a name="260542888"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/equality%20in%20sigma-types/near/260542888" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/equality.20in.20sigma-types.html#260542888">(Nov 06 2021 at 23:45)</a>:</h4>
<p>And indeed is written <a href="https://github.com/leanprover/lean4/blob/master/stage0/src/Lean/Meta/Tactic/Subst.lean#L122">in Lean</a> in Lean 4.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>