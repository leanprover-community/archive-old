---
layout: archive
title: Zulip Chat Archive
permalink: /stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/index.html">Is there code for X?</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html">sum.elim (f ∘ sum.inl) (f ∘ sum.inr) = f</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="217891929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217891929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217891929">(Nov 25 2020 at 14:35)</a>:</h4>
<p>Proof is:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">what</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="o">:</span> <span class="kt">Sort</span><span class="bp">*</span><span class="o">}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">⊕</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">:</span> <span class="n">sum.elim</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">sum.inl</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">sum.inr</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="o">:=</span>
<span class="n">funext</span> <span class="bp">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">sum.cases_on</span> <span class="n">x</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">_</span><span class="o">,</span> <span class="kd">by</span> <span class="n">rw</span> <span class="n">sum.elim_inl</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">_</span><span class="o">,</span> <span class="kd">by</span> <span class="n">rw</span> <span class="n">sum.elim_inr</span><span class="o">)</span>
</code></pre></div>
<p>This looks like an obvious candidate for a simp lemma, but I don't know what to call it</p>



<a name="217892069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217892069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217892069">(Nov 25 2020 at 14:36)</a>:</h4>
<p>it seems vanishingly unlikely that this left hand side would ever appear again</p>



<a name="217892163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217892163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217892163">(Nov 25 2020 at 14:37)</a>:</h4>
<p>Is that an argument against inclusion into mathlib, or just an argument against being a simp lemma?</p>



<a name="217892223"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217892223" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217892223">(Nov 25 2020 at 14:37)</a>:</h4>
<p>and the proof <code>ext (_|_); refl</code> is easier than knowing that this lemma exists</p>



<a name="217892349"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217892349" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217892349">(Nov 25 2020 at 14:38)</a>:</h4>
<p>I had no idea <code>ext</code> took rcases-style patterns</p>



<a name="217892386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217892386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217892386">(Nov 25 2020 at 14:38)</a>:</h4>
<p>I think that might be a somewhat recent feature</p>



<a name="217892450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217892450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217892450">(Nov 25 2020 at 14:39)</a>:</h4>
<p><code>tidy</code> can prove it too</p>



<a name="217892471"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217892471" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217892471">(Nov 25 2020 at 14:39)</a>:</h4>
<p>Ah, but you can't use that proof if your goal state  is actually <code>sum.elim (f ∘ sum.inl) (f ∘ sum.inr) x = f x</code></p>



<a name="217892569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217892569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217892569">(Nov 25 2020 at 14:40)</a>:</h4>
<p>And in general <code>ext</code> only works on top level goals, you can't use it to simplify subexpressions</p>



<a name="217892574"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217892574" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217892574">(Nov 25 2020 at 14:40)</a>:</h4>
<p>then <code>cases x; refl</code> instead</p>



<a name="217894125"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217894125" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217894125">(Nov 25 2020 at 14:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/217875-Is-there.20code.20for.20X.3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f/near/217892569">said</a>:</p>
<blockquote>
<p>And in general <code>ext</code> only works on top level goals, you can't use it to simplify subexpressions</p>
</blockquote>
<p>If this is a problem it might mean that you haven't fully decomposed your task into its parts.</p>



<a name="217894959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217894959" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217894959">(Nov 25 2020 at 14:59)</a>:</h4>
<p>But in any case, I don't think it is a good simp lemma because that is effectively just action at a distance</p>



<a name="217895035"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895035" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895035">(Nov 25 2020 at 15:00)</a>:</h4>
<p>What do you mean by it being action at a distance?</p>



<a name="217895119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895119">(Nov 25 2020 at 15:00)</a>:</h4>
<p>If you rely on it to make <code>simp</code> work then there's an implicit long-range dependency</p>



<a name="217895151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895151" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895151">(Nov 25 2020 at 15:00)</a>:</h4>
<p>That's true of all simp lemmas though!</p>



<a name="217895156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895156">(Nov 25 2020 at 15:00)</a>:</h4>
<p>imagine the import structure changes somehow to make the lemma not imported, then someone in the future will have no idea why the proof broke</p>



<a name="217895205"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895205" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895205">(Nov 25 2020 at 15:01)</a>:</h4>
<p>That's moot if the lemma is in the same file as the definitions it simplifies</p>



<a name="217895224"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895224" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895224">(Nov 25 2020 at 15:01)</a>:</h4>
<p>right but most simp lemmas are obvious things that don't contain things like <code>sum.elim</code> or function composition or repeated occurrences of a variable on the left hand side</p>



<a name="217895227"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895227" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895227">(Nov 25 2020 at 15:01)</a>:</h4>
<p>Which it is in <a href="https://github.com/leanprover-community/mathlib/issues/5112">#5112</a>, which I just opened</p>



<a name="217895266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895266">(Nov 25 2020 at 15:01)</a>:</h4>
<p>If it's in the same file then there's even less reason to make it a simp lemma</p>



<a name="217895341"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895341" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895341">(Nov 25 2020 at 15:02)</a>:</h4>
<p>oh, you mean the thing it simplifies in the sense of appearing in the lemma</p>



<a name="217895418"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895418" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895418">(Nov 25 2020 at 15:02)</a>:</h4>
<p>Regarding "left hand sides don't contain composition", <a href="#narrow/stream/113489-new-members/topic/Fully.20applied.20lemmas/near/217828890">https://leanprover.zulipchat.com/#narrow/stream/113489-new-members/topic/Fully.20applied.20lemmas/near/217828890</a> is relevant</p>



<a name="217895610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217895610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217895610">(Nov 25 2020 at 15:04)</a>:</h4>
<p>It's still the case that the lemma is likely to get used exactly once in which case marking it <code>simp</code> is just a way to hide a dependency which is better made explicit</p>



<a name="217897803"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217897803" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217897803">(Nov 25 2020 at 15:20)</a>:</h4>
<p>Isn't hiding "obvious" dependencies fine though?</p>



<a name="217897863"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217897863" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217897863">(Nov 25 2020 at 15:21)</a>:</h4>
<p>IMO these lemmas fall in the same category as <code>prod.mk.eta</code>, as proving something that you would  expect to go away by itself</p>



<a name="217916676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217916676" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217916676">(Nov 25 2020 at 17:38)</a>:</h4>
<p>This rule is sometimes called the co-eta rule for sums. It seems like a very basic rule that is nice to have in mathlib.<br>
I think it's fine to make it a simp-lemma. I think that often when it applies the LHS is not exactly of this form (for example if the function composition is unfolded), which might make it tricky to use.</p>



<a name="217917500"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217917500" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217917500">(Nov 25 2020 at 17:46)</a>:</h4>
<p>I'm not sure this would be a good simp-lemma.  Remember that <code>function.comp</code> is still reducible, so this quickly becomes a higher-order matching problem.</p>



<a name="217918434"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217918434" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217918434">(Nov 25 2020 at 17:55)</a>:</h4>
<p>Does that argument apply to other simp lemmas involving <code>function.comp</code>?</p>



<a name="217919135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217919135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217919135">(Nov 25 2020 at 18:01)</a>:</h4>
<p>I'm a bit uneasy about <code>function.comp</code> in simp lemmas, yes.  I don't think this lemma is actively harmful, but lemmas like <code>list.comp_map</code> shouldn't be marked simp.</p>



<a name="217921612"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217921612" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217921612">(Nov 25 2020 at 18:25)</a>:</h4>
<p>I added a couple more lemmas to the PR (<a href="https://github.com/leanprover-community/mathlib/issues/5112">#5112</a>)on top of what is discussed here, would appreciate comments on which ones are good and which ones aren't</p>



<a name="217942485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217942485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217942485">(Nov 25 2020 at 21:36)</a>:</h4>
<p>Is <code>sum.elim f g ∘ inr = g</code> any worse a simp lemma than <code>f ∘ id = f</code> (<a href="https://leanprover-community.github.io/mathlib_docs/find/function.comp.right_id">docs#function.comp.right_id</a>) or <code>[involutive f] f ∘ f = id</code> (<a href="https://leanprover-community.github.io/mathlib_docs/find/function.involutive.comp_self">docs#function.involutive.comp_self</a>)?</p>



<a name="217942560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217942560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217942560">(Nov 25 2020 at 21:37)</a>:</h4>
<p>A Lean 3 simp expert (who probably wrote the <code>simp</code> linter) has expressed their unease about <code>function.comp</code> in <code>simp</code> lemmas.</p>



<a name="217942649"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217942649" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217942649">(Nov 25 2020 at 21:39)</a>:</h4>
<p>Would this problem go away if <code>simp</code> unfolded <code>comp</code>?</p>



<a name="217942703"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217942703" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217942703">(Nov 25 2020 at 21:39)</a>:</h4>
<p><code>comp</code> is really weird. I used to use it a lot, and now I avoid it like the plague.</p>



<a name="217942767"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217942767" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217942767">(Nov 25 2020 at 21:40)</a>:</h4>
<p>You would imagine that if it could be easily fixed, it would have been fixed a while ago.</p>



<a name="217943002"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943002" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943002">(Nov 25 2020 at 21:43)</a>:</h4>
<p>How about making <code>function.comp</code> <code>[reducible]</code>?</p>



<a name="217943012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943012" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943012">(Nov 25 2020 at 21:43)</a>:</h4>
<p>Isn't it already?</p>



<a name="217943074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943074">(Nov 25 2020 at 21:44)</a>:</h4>
<p>Oh yes it is! I looked in the docs and it didn't mention it, but it's in the source.</p>



<a name="217943131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943131">(Nov 25 2020 at 21:45)</a>:</h4>
<p>It's also inlined. What about <code>comp</code> do you avoid? <code>f * id = f</code> seems like that should be "simpable" without applying, since <code>id</code> is the unit in that "multiplication", no?</p>



<a name="217943152"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943152" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943152">(Nov 25 2020 at 21:45)</a>:</h4>
<p>today I learnt : docs show stuff tagged as <code>@[simp]</code> but not <code>@[reducible]</code></p>



<a name="217943164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943164">(Nov 25 2020 at 21:45)</a>:</h4>
<p>What does <code>@[inline]</code> mean?</p>



<a name="217943285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943285" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943285">(Nov 25 2020 at 21:47)</a>:</h4>
<p>If function.comp is reducible, does Gabriel also get uneasy about lambdas in simp lemmas? simp can see through reducible stuff, right?</p>



<a name="217943322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943322">(Nov 25 2020 at 21:47)</a>:</h4>
<p>In compsci, inline usually means, "when you encounter this function, don't place it in the function call stack, which involves jumping in memory... just unwrap it and place the body of it in the current context, to avoid the jumps"</p>



<a name="217943390"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943390" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943390">(Nov 25 2020 at 21:48)</a>:</h4>
<p>So here, it might mean, just generate the underlying VM code if you can?</p>



<a name="217943617"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943617" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943617">(Nov 25 2020 at 21:51)</a>:</h4>
<p>Reducible or not, <code>simp</code> does not reduce <a href="https://leanprover-community.github.io/mathlib_docs/find/function.comp">docs#function.comp</a>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">constant</span> <span class="n">f</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span>
<span class="kd">constant</span> <span class="n">g</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span>

<span class="kd">@[simp]</span>
<span class="kd">axiom</span> <span class="n">fg</span> <span class="o">:</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">))</span> <span class="bp">=</span> <span class="n">id</span>

<span class="kd">example</span> <span class="o">:</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">g</span><span class="o">)</span> <span class="bp">=</span> <span class="n">id</span> <span class="o">:=</span> <span class="kd">by</span> <span class="o">{</span><span class="n">unfold</span> <span class="n">function.comp</span><span class="o">,</span> <span class="n">simp</span><span class="o">}</span> <span class="c1">-- ok</span>
<span class="kd">example</span> <span class="o">:</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">g</span><span class="o">)</span> <span class="bp">=</span> <span class="n">id</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span>  <span class="c1">-- fail</span>
</code></pre></div>



<a name="217943755"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943755" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943755">(Nov 25 2020 at 21:53)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">f</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">x</span> <span class="bp">+</span> <span class="mi">3</span>
<span class="kd">def</span> <span class="n">g</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="mi">2</span> <span class="bp">*</span> <span class="n">x</span>

<span class="kd">@[simp]</span> <span class="kd">lemma</span> <span class="n">fg</span> <span class="o">:</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">))</span> <span class="bp">=</span> <span class="n">id</span> <span class="o">:=</span> <span class="n">sorry</span>

<span class="kd">example</span> <span class="o">:</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">g</span><span class="o">)</span> <span class="bp">=</span> <span class="n">id</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span> <span class="o">[</span><span class="n">function.comp</span><span class="o">]</span> <span class="c1">-- works</span>
</code></pre></div>
<p>(constants and axioms and sorrying data scares me). OK so maybe the issue is that we don't see function.comp in the wild so much?</p>



<a name="217943839"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943839" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943839">(Nov 25 2020 at 21:54)</a>:</h4>
<p>hmm, thousands of occurrences in mathlib...</p>



<a name="217943910"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217943910" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217943910">(Nov 25 2020 at 21:55)</a>:</h4>
<p>It would be good to see an example of an obviously harmful comp simp lemma.</p>



<a name="217949822"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217949822" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217949822">(Nov 25 2020 at 23:12)</a>:</h4>
<p>I don't have a feeling what a harmful simp lemma could look like, but perhaps one could argue that a simp lemma which never fires is harmful because it's making simp run more slowly for no good reason</p>



<a name="217982701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217982701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217982701">(Nov 26 2020 at 09:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/217875-Is-there.20code.20for.20X.3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f/near/217943910">said</a>:</p>
<blockquote>
<p>It would be good to see an example of an obviously harmful comp simp lemma.</p>
</blockquote>
<p>We've had quite a few such problems with type class instances (such as <code>is_monoid_hom</code> instances for composition), that's why I'm careful.  Translated to a simp lemma, this would be a problematic example:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">data.list.basic</span>
<span class="kn">import</span> <span class="n">tactic.simp_command</span>

<span class="kn">open</span> <span class="n">list</span>

<span class="kd">@[simp]</span>
<span class="kd">lemma</span> <span class="n">comp_map'</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="n">γ</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">l</span> <span class="o">:</span> <span class="n">list</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">map</span> <span class="o">(</span><span class="n">h</span> <span class="bp">∘</span> <span class="n">g</span><span class="o">)</span> <span class="n">l</span> <span class="bp">=</span> <span class="n">map</span> <span class="n">h</span> <span class="o">(</span><span class="n">map</span> <span class="n">g</span> <span class="n">l</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">map_map</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span>

<span class="bp">#</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">comp_map'</span><span class="o">]</span> <span class="o">[</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">]</span><span class="bp">.</span><span class="n">map</span> <span class="o">(</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="c1">-- works 🤷</span>
<span class="bp">#</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">comp_map'</span><span class="o">]</span> <span class="o">[</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">]</span><span class="bp">.</span><span class="n">map</span> <span class="n">id</span>   <span class="c1">-- loops</span>
</code></pre></div>
<p>At first glance the <code>comp_map'</code> lemma looks fine because it reduces the number of <code>∘</code> in the first argument of map.<br>
But the reason it loops is that <code>h ∘ g</code> can match any function because <code>∘</code> is reducible and then Lean uses higher-order matching to match the resulting lambdas.  (BTW, I would've expected it to match <code>(+1)</code> as well, but apparently it doesn't.)</p>



<a name="217985510"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217985510" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217985510">(Nov 26 2020 at 10:24)</a>:</h4>
<p>Thanks for the example - I assume the issue is that lean matches <code>id</code> against <code>id ∘ id</code>. Is there any way to tell it to only match against non-trivial patterns?</p>



<a name="217985557"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/217985557" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#217985557">(Nov 26 2020 at 10:25)</a>:</h4>
<p>Eg, have the pattern <code>P a</code> not match against <code>a</code> as <code>id a</code></p>



<a name="218012701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/218012701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#218012701">(Nov 26 2020 at 15:15)</a>:</h4>
<p>But if there was a lemma that simplified <code>f ∘ id = f</code>, <code>comp_map'</code> wouldn't even need to fire. The discussion on <a href="https://github.com/leanprover-community/mathlib/pull/5030">https://github.com/leanprover-community/mathlib/pull/5030</a> suggests that anyway, <code>map_map</code> should be the simp direction, and not <code>comp_map</code>.</p>



<a name="218014468"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/218014468" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#218014468">(Nov 26 2020 at 15:33)</a>:</h4>
<p>I'm suspicious about this <code>map_map</code> direction</p>



<a name="218014480"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/218014480" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#218014480">(Nov 26 2020 at 15:33)</a>:</h4>
<p>You wouldn't want a simp lemma that says <code>x = option.map id x</code></p>



<a name="218015082"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/218015082" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#218015082">(Nov 26 2020 at 15:39)</a>:</h4>
<p>for example <a href="https://leanprover-community.github.io/mathlib_docs/find/mul_hom.map_mul">docs#mul_hom.map_mul</a> goes in the direction I expect: f of a product turns into product of fs</p>



<a name="218015157"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/218015157" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#218015157">(Nov 26 2020 at 15:40)</a>:</h4>
<p>Maybe it's one of those cases where the grass looks greener on both sides</p>



<a name="218016848"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/sum.elim%20%28f%20%E2%88%98%20sum.inl%29%20%28f%20%E2%88%98%20sum.inr%29%20%3D%20f/near/218016848" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/sum.2Eelim.20(f.20.E2.88.98.20sum.2Einl).20(f.20.E2.88.98.20sum.2Einr).20.3D.20f.html#218016848">(Nov 26 2020 at 15:57)</a>:</h4>
<p><span class="user-mention" data-user-id="308899">@Yakov Pechersky</span> </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">#</span><span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">comp_map'</span><span class="o">]</span> <span class="o">[</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">]</span><span class="bp">.</span><span class="n">map</span> <span class="o">(</span><span class="n">nat.add</span> <span class="mi">1</span><span class="o">)</span>   <span class="c1">-- loops as well</span>
</code></pre></div>
<p>IMHO, the only solution is to make <code>∘</code> semireducible.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>