---
layout: archive
title: Zulip Chat Archive
permalink: /stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/index.html">Is there code for X?</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html">`field_simp` for units</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="286896891"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/286896891" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#286896891">(Jun 21 2022 at 11:06)</a>:</h4>
<p>Currently I have a few goals of the form</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">ha</span> <span class="o">:</span> <span class="n">is_unit</span> <span class="n">a</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">b</span> <span class="bp">*</span> <span class="o">(</span><span class="bp">↑</span><span class="o">(</span><span class="n">ha.unit</span><span class="o">)</span><span class="bp">⁻¹</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">c</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="gr">sorry</span>
<span class="kd">end</span>
</code></pre></div>
<p>which I just proof by endless manual blocks of <code>rw mul_comm</code> and rw <code>mul_assoc</code> along with the key input <code>(h : ↑(ha.unit)⁻¹ * a = 1)</code>. Is there any tactic that would help doing that?</p>
<p>Basically multiplying both sides of an equality with <code>a</code> if there is a hypothesis like <code>h</code> present and cancel them out.<br>
<code>field_simp</code> does something very similar, for example it solves</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">:</span> <span class="n">ℚ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">≠</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">b</span> <span class="bp">*</span> <span class="o">(</span><span class="n">a</span><span class="bp">⁻¹</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">c</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">field_simp</span><span class="o">,</span> <span class="n">ring</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>so I had the idea of copying the <code>field_simp</code> tactic and modifying it slightly, but haven't been successful so far.</p>



<a name="286922661"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/286922661" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#286922661">(Jun 21 2022 at 14:34)</a>:</h4>
<p><a href="https://leanprover-community.github.io/mathlib_docs/tactics.html#assoc_rw">tactic#assoc_rw</a> can be helpful here, it rewrites up to associativity</p>



<a name="286922695"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/286922695" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#286922695">(Jun 21 2022 at 14:35)</a>:</h4>
<p>So you can just do:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.char_p.basic</span>
<span class="kd">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">ha</span> <span class="o">:</span> <span class="n">is_unit</span> <span class="n">a</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">b</span> <span class="bp">*</span> <span class="o">(</span><span class="bp">↑</span><span class="o">(</span><span class="n">ha.unit</span><span class="o">)</span><span class="bp">⁻¹</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">c</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">assoc_rw</span> <span class="o">[</span><span class="n">mul_comm</span> <span class="n">_</span> <span class="n">b</span><span class="o">,</span> <span class="n">is_unit.mul_coe_inv</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>
</code></pre></div>



<a name="286923709"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/286923709" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#286923709">(Jun 21 2022 at 14:42)</a>:</h4>
<p>I was hoping that</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="n">lift</span> <span class="n">a</span> <span class="n">to</span> <span class="n">R</span><span class="bp">ˣ</span> <span class="n">using</span> <span class="n">id</span> <span class="n">ha</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">is_unit.unit_of_coe_units</span><span class="o">,</span> <span class="n">clear</span> <span class="n">ha</span><span class="o">,</span>
</code></pre></div>
<p>would be useful here, as then the goal becomes <code>↑a * b * (↑a⁻¹ * c) = b * c</code>. It's pretty trick to extend the simp set of <code>field_simps</code> though to work with coerced units like this though</p>



<a name="286959000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/286959000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#286959000">(Jun 21 2022 at 18:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="385895">Jon Eugster</span> has marked this topic as unresolved.</p>



<a name="286959018"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/286959018" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#286959018">(Jun 21 2022 at 18:54)</a>:</h4>
<p>If I add a <code>field_simps</code>-lemma</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[field_simps]</span> <span class="kd">lemma</span> <span class="n">inv_eq_one_divp'</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="bp">ˣ</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">((</span><span class="mi">1</span> <span class="bp">/</span> <span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="bp">ˣ</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">1</span> <span class="bp">/ₚ</span> <span class="n">x</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">one_div</span><span class="o">,</span> <span class="n">one_divp</span><span class="o">]</span>
</code></pre></div>
<p>remove <code>one_divp</code> (which says<code>1 /ₚ x = ↑x⁻¹</code>), and mark a few pdiv-lemmas as <code>@[field_simp]</code> then <code>field_simp</code> can handle partial division <code>/ₚ</code> just like normal division. <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
<p>Still need your <code>lift</code> trick first, <span class="user-mention" data-user-id="310045">@Eric Wieser</span>,  to get all the <code>is_unit</code> hypotheses into the correct shape before calling <code>field_simp, ring,</code> then to do all the calculation.</p>



<a name="286959600"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/286959600" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#286959600">(Jun 21 2022 at 18:59)</a>:</h4>
<p>(The lemma has this weird form instead of </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[field_simps]</span> <span class="kd">lemma</span> <span class="n">inv_eq_one_divp</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="bp">ˣ</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">↑</span><span class="n">x</span><span class="bp">⁻¹</span> <span class="bp">=</span> <span class="mi">1</span> <span class="bp">/ₚ</span> <span class="n">x</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">rw</span> <span class="n">one_divp</span>
</code></pre></div>
<p>because <code>field_simp</code> uses <code>inv_eq_one_div</code> always first and turns <code>↑x⁻¹</code> directly into <code>↑(1 / x)</code> for any <code>x : αˣ</code>.)</p>



<a name="286975052"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/286975052" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#286975052">(Jun 21 2022 at 21:11)</a>:</h4>
<p>The in-development <code>polyrith</code> tactic <a href="https://github.com/leanprover-community/mathlib/pull/14878">#14878</a> should do this after you add all relevant <code>(h : ↑(ha.unit)⁻¹ * a = 1)</code> to the list of hypotheses.</p>



<a name="286975211"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/286975211" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#286975211">(Jun 21 2022 at 21:13)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="452188">@Dhruv Bhatia</span> <span class="user-mention" data-user-id="110596">@Rob Lewis</span></p>



<a name="287198450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287198450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287198450">(Jun 23 2022 at 14:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="385895">Jon Eugster</span> has marked this topic as unresolved.</p>



<a name="287199281"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287199281" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287199281">(Jun 23 2022 at 14:34)</a>:</h4>
<p>(deleted)</p>



<a name="287214832"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287214832" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287214832">(Jun 23 2022 at 16:25)</a>:</h4>
<p>Related to this, can anybody explain what happens here? I think something to do with instances <code>units.group</code> and <code>units.comm_group</code>, maybe simply some instance priority?</p>
<p>The following example times out, unless I specify a group instance manually</p>
<p><a href="https://leanprover-community.github.io/mwe.html">#mwe</a> on the current master:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.ring.basic</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">c</span> <span class="n">d</span> <span class="o">:</span> <span class="n">R</span><span class="bp">ˣ</span><span class="o">)</span> <span class="o">:</span> <span class="n">d</span> <span class="bp">*</span> <span class="o">(</span><span class="n">c</span> <span class="bp">/</span> <span class="n">d</span><span class="o">)</span> <span class="bp">=</span> <span class="n">c</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">convert</span> <span class="n">mul_div_cancel'_right</span> <span class="n">d</span> <span class="n">c</span><span class="o">,</span> <span class="c1">-- times out. same for `simp`</span>
  <span class="c1">-- works if one replaces [comm_ring R] with [comm_monoid R]</span>
<span class="kd">end</span>

<span class="c1">-- My instance</span>
<span class="kd">instance</span> <span class="n">myinst</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span> <span class="n">group</span> <span class="n">R</span><span class="bp">ˣ</span> <span class="o">:=</span> <span class="n">comm_group.to_group</span> <span class="n">R</span><span class="bp">ˣ</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">c</span> <span class="n">d</span> <span class="o">:</span> <span class="n">R</span><span class="bp">ˣ</span><span class="o">)</span> <span class="o">:</span> <span class="n">d</span> <span class="bp">*</span> <span class="o">(</span><span class="n">c</span> <span class="bp">/</span> <span class="n">d</span><span class="o">)</span> <span class="bp">=</span> <span class="n">c</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">convert</span> <span class="n">mul_div_cancel'_right</span> <span class="n">d</span> <span class="n">c</span><span class="o">,</span> <span class="c1">-- works</span>
<span class="kd">end</span>
</code></pre></div>



<a name="287215009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287215009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287215009">(Jun 23 2022 at 16:26)</a>:</h4>
<p>Outsmarted myself, but I think the problem above exists indeed. Any help?</p>



<a name="287215909"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287215909" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287215909">(Jun 23 2022 at 16:32)</a>:</h4>
<p>investigating this a bit I see sometimes <code>comm_ring.to_ring</code> and then <code>ring.to_monoid</code> and in other terms <code>comm_ring.to_comm_monoid</code> and then <code>comm_monoid.to_monoid</code>...</p>



<a name="287216398"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287216398" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287216398">(Jun 23 2022 at 16:35)</a>:</h4>
<p>Another data point; <code>: _</code> fixes it:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.ring.basic</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">c</span> <span class="n">d</span> <span class="o">:</span> <span class="n">R</span><span class="bp">ˣ</span><span class="o">)</span> <span class="o">:</span> <span class="n">d</span> <span class="bp">*</span> <span class="o">(</span><span class="n">c</span> <span class="bp">/</span> <span class="n">d</span><span class="o">)</span> <span class="bp">=</span> <span class="n">c</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="c1">-- works</span>
  <span class="n">exact</span> <span class="o">(</span><span class="n">mul_div_cancel'_right</span> <span class="n">d</span> <span class="n">c</span> <span class="o">:</span> <span class="n">_</span><span class="o">),</span>
<span class="kd">end</span>
</code></pre></div>



<a name="287223708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287223708" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287223708">(Jun 23 2022 at 17:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/217875-Is-there-code-for-X.3F/topic/.60field_simp.60.20for.20units/near/287216398">said</a>:</p>
<blockquote>
<p>Another data point; <code>: _</code> fixes it:</p>
</blockquote>
<p>I'm closing in on this, I think I'll get there when I look at it tomorrow, the following works (writing Eric's example more explicitely with the help of <code>show_term</code>):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">(</span><span class="n">c</span> <span class="n">d</span> <span class="o">:</span> <span class="n">R</span><span class="bp">ˣ</span><span class="o">)</span> <span class="o">:</span> <span class="n">d</span> <span class="bp">*</span> <span class="o">(</span><span class="n">c</span> <span class="bp">/</span> <span class="n">d</span><span class="o">)</span> <span class="bp">=</span> <span class="n">c</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">exact</span> <span class="bp">@</span><span class="n">mul_div_cancel'_right</span>
    <span class="n">R</span><span class="bp">ˣ</span> <span class="c1">-- (@units R (@ring.to_monoid R (@comm_ring.to_ring R _inst_1)))</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">units.comm_group</span> <span class="n">R</span> <span class="n">_</span><span class="o">)</span> <span class="c1">-- (@comm_ring.to_comm_monoid R _inst_1)</span>
    <span class="n">d</span>
    <span class="n">c</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>So it really seems like <code>simp</code> goes down the wrong instances when trying to find this second argument <code>[comm_group Rˣ]</code>...</p>



<a name="287223962"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287223962" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287223962">(Jun 23 2022 at 17:37)</a>:</h4>
<p><code>simp</code> isn't relevant here, it fails in term mode without the explicit arguments too - this is a unification problem</p>



<a name="287230958"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287230958" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287230958">(Jun 23 2022 at 18:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/217875-Is-there-code-for-X.3F/topic/.60field_simp.60.20for.20units/near/287223962">said</a>:</p>
<blockquote>
<p><code>simp</code> isn't relevant here, it fails in term mode without the explicit arguments too - this is a unification problem</p>
</blockquote>
<p>You are right, sorry. What I meant with <code>simp</code> is that <code>mul_div_cancel'_right</code> is a <code>simp</code>-lemma, so my original problem was of the form <code>example (R : Type*) [comm_ring R] (c d : Rˣ) : d * (c / d) = c := by simp</code> and that should work ideally after finding this issue.</p>



<a name="287311675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287311675" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287311675">(Jun 24 2022 at 10:00)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span> <br>
The solution to this is</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">attribute</span> <span class="o">[</span><span class="kd">instance</span><span class="o">,</span> <span class="n">priority</span> <span class="mi">400</span><span class="o">]</span> <span class="n">ring.to_monoid</span>
<span class="kn">attribute</span> <span class="o">[</span><span class="kd">instance</span><span class="o">,</span> <span class="n">priority</span> <span class="mi">600</span><span class="o">]</span> <span class="n">comm_monoid.to_monoid</span>
</code></pre></div>
<p>to prefer the commutative monoid way of going <code>comm_ring → ring/comm_monoid → monoid</code>. Are there any specific numbers that the priorities should be and where would you put these two statements? Underneath the definitions <code>ring</code> and <code>comm_ring</code> respectively?</p>



<a name="287311737"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287311737" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287311737">(Jun 24 2022 at 10:01)</a>:</h4>
<p>That's probably not a good idea; there are likely other bits of mathlib that rely on the priorities being in the reverse order</p>



<a name="287312209"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287312209" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287312209">(Jun 24 2022 at 10:06)</a>:</h4>
<p>Hmm what could be another approach then?</p>



<a name="287312392"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287312392" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287312392">(Jun 24 2022 at 10:08)</a>:</h4>
<p>If you are just looking at <code>(R, *)</code>, what could be a problem where you would want to forget commutativity first before forgetting the <code>+</code> <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="287313146"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287313146" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287313146">(Jun 24 2022 at 10:18)</a>:</h4>
<p>Interestingly just the one line <code>attribute [instance, priority 100] comm_monoid.to_monoid</code> (without anything for <code>ring.to_monoid</code>) makes it work while <code>attribute [instance, priority 99] comm_monoid.to_monoid</code> makes it fail.</p>



<a name="287323136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287323136" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287323136">(Jun 24 2022 at 12:17)</a>:</h4>
<p>Does <code>attribute [-instance] ring.to_monoid</code> work?</p>



<a name="287323156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287323156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287323156">(Jun 24 2022 at 12:17)</a>:</h4>
<p>There's no actual need for that instance, lean can work it out via <code>ring.to_semiring.to_monoid</code></p>



<a name="287323452"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287323452" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287323452">(Jun 24 2022 at 12:20)</a>:</h4>
<p>(for others: <a href="https://github.com/leanprover-community/mathlib/pull/14923">#14923</a> was created based on an earlier message)</p>



<a name="287325381"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287325381" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287325381">(Jun 24 2022 at 12:41)</a>:</h4>
<p>Not in my quick test, what's the difference between <code>attribute</code> and <code>local attribute</code>? It always wants me to write the latter and then times out again</p>



<a name="287326021"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287326021" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287326021">(Jun 24 2022 at 12:47)</a>:</h4>
<p>How about <code>attribute [instance, priority 0] ring.to_monoid</code>?</p>



<a name="287333119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287333119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287333119">(Jun 24 2022 at 13:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/217875-Is-there-code-for-X.3F/topic/.60field_simp.60.20for.20units/near/287326021">said</a>:</p>
<blockquote>
<p>How about <code>attribute [instance, priority 0] ring.to_monoid</code>?</p>
</blockquote>
<p>The following works:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">attribute</span> <span class="o">[</span><span class="kd">instance</span><span class="o">,</span> <span class="n">priority</span> <span class="mi">99</span><span class="o">]</span> <span class="n">ring.to_monoid</span>
<span class="kn">attribute</span> <span class="o">[</span><span class="kd">instance</span><span class="o">,</span> <span class="n">priority</span> <span class="mi">99</span><span class="o">]</span> <span class="n">monoid_with_zero.to_monoid</span>
</code></pre></div>
<p>Looks like <code>ring.to_monoid</code>, <code>monoid_with_zero.to_monoid</code> and <code>comm_monoid.to_monoid</code> have all priority <code>100</code>, therefore this example works as soon as you tell it which of the three to use first.</p>



<a name="287333633"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287333633" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287333633">(Jun 24 2022 at 13:55)</a>:</h4>
<p>Note that the default in case of a tie is to use the most-recently-declared one</p>



<a name="287334056"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287334056" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287334056">(Jun 24 2022 at 13:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/217875-Is-there-code-for-X.3F/topic/.60field_simp.60.20for.20units/near/287333633">said</a>:</p>
<blockquote>
<p>Note that the default in case of a tie is to use the most-recently-declared one</p>
</blockquote>
<p>That's why writing <code>attribute [instance, priority 100] comm_monoid.to_monoid</code> into my file made it work too: it moves <code>comm_monoid.to_monoid</code> back on top of the stack <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="287335110"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287335110" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287335110">(Jun 24 2022 at 14:07)</a>:</h4>
<p>Huh, I didn't know it worked that way, but I guess that makes sense</p>



<a name="287335151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287335151" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287335151">(Jun 24 2022 at 14:07)</a>:</h4>
<p>I still think that <code>ring.to_monoid</code> should have priority 0</p>



<a name="287335164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287335164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287335164">(Jun 24 2022 at 14:07)</a>:</h4>
<p>(like <code>algebra.to_has_scalar</code>)</p>



<a name="287335284"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287335284" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287335284">(Jun 24 2022 at 14:08)</a>:</h4>
<p>It's rather harder to argue which of <code>monoid_with_zero.to_monoid</code> and <code>comm_monoid.to_monoid</code> should take preference</p>



<a name="287338355"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287338355" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287338355">(Jun 24 2022 at 14:32)</a>:</h4>
<p><a href="/user_uploads/3121/pl6gcxnGU1qH3Svqdvuu331f/c4319d2b-cb63-400e-90c2-647b5d67907f.jpg">c4319d2b-cb63-400e-90c2-647b5d67907f.jpg</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/pl6gcxnGU1qH3Svqdvuu331f/c4319d2b-cb63-400e-90c2-647b5d67907f.jpg" title="c4319d2b-cb63-400e-90c2-647b5d67907f.jpg"><img src="/user_uploads/3121/pl6gcxnGU1qH3Svqdvuu331f/c4319d2b-cb63-400e-90c2-647b5d67907f.jpg"></a></div>



<a name="287338503"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287338503" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jon Eugster <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287338503">(Jun 24 2022 at 14:33)</a>:</h4>
<p>Looks like there is this kind of square, all have priority 100. After removing <code>ring.to_monoid</code> I wonder if all the horizontal ones should have higher priority?</p>



<a name="287345471"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287345471" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287345471">(Jun 24 2022 at 15:25)</a>:</h4>
<p>It's more of a hypercube than a square, but you're certainly thinking about this the right way</p>



<a name="287345500"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/217875-Is%20there%20code%20for%20X%3F/topic/%60field_simp%60%20for%20units/near/287345500" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/217875-Is-there-code-for-X%3F/topic/.60field_simp.60.20for.20units.html#287345500">(Jun 24 2022 at 15:25)</a>:</h4>
<p>(the other dimensions remove associativity and 1)</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>