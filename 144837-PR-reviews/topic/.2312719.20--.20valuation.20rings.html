---
layout: archive
title: Zulip Chat Archive
permalink: /stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/index.html">PR reviews</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html">#12719 -- valuation rings</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="275566513"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/275566513" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#275566513">(Mar 16 2022 at 19:38)</a>:</h4>
<p>It seems that the <code>fails_quickly</code> linter is unhappy with <a href="https://github.com/leanprover-community/mathlib/pull/12719">#12719</a> </p>
<p>I checked the typeclass trace to the best of my ability, and didn't see anything too suspicious.<br>
I think it would be worthwhile to ask for input from someone who knows the inner workings better than I do before trying to increase thee limit in the <code>fails_quickly</code> linter.</p>
<p>Any thoughts?</p>



<a name="275579259"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/275579259" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#275579259">(Mar 16 2022 at 21:23)</a>:</h4>
<p>Actually, there may actually be an issue.</p>



<a name="275666867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/275666867" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#275666867">(Mar 17 2022 at 15:05)</a>:</h4>
<p>After some troubleshooting, it seems that the instance</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">variables</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">A</span><span class="o">]</span> <span class="o">[</span><span class="n">is_domain</span> <span class="n">A</span><span class="o">]</span> <span class="o">[</span><span class="n">discrete_valuation_ring</span> <span class="n">A</span><span class="o">]</span>

<span class="kd">@[priority 100]</span>
<span class="kd">instance</span> <span class="n">of_discrete_valuation_ring</span> <span class="o">:</span> <span class="n">valuation_ring</span> <span class="n">A</span> <span class="o">:=</span> <span class="bp">...</span>
</code></pre></div>
<p>was causing some issues with <code>witt_vector</code>. </p>
<p>I have no idea why, and it seems to me that we want the <code>DVR -&gt; valuation_ring</code> instance to be an actual instance as opposed to a mere lemma. Any help in troubleshooting this would be greatly appreciated! </p>
<p>For now I have changed the instance to a lemma in the PR.</p>



<a name="275668961"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/275668961" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#275668961">(Mar 17 2022 at 15:18)</a>:</h4>
<p><span class="user-mention" data-user-id="110596">@Rob Lewis</span> could you debug this instance issue?</p>



<a name="275669173"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/275669173" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Riccardo Brasca <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#275669173">(Mar 17 2022 at 15:19)</a>:</h4>
<p>With</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="sd">/-- A DVR is a valuation ring. -/</span>
<span class="kd">@[priority 100]</span>
<span class="kd">instance</span> <span class="n">of_discrete_valuation_ring</span> <span class="o">:</span> <span class="n">valuation_ring</span> <span class="n">A</span> <span class="o">:=</span>
</code></pre></div>
<p>I don't get any error. Should I change some import too see it?</p>



<a name="275669211"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/275669211" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#275669211">(Mar 17 2022 at 15:19)</a>:</h4>
<p>It's the <code>fails_quickly</code> linter that complains</p>



<a name="275669321"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/275669321" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#275669321">(Mar 17 2022 at 15:20)</a>:</h4>
<p>Doing the <code>import all</code> test, it seems that there is some loop happening, but I don't know how to debug beyond that.</p>



<a name="275669807"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/275669807" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#275669807">(Mar 17 2022 at 15:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/275668961">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110596">Rob Lewis</span> could you debug this instance issue?</p>
</blockquote>
<p>Probably not today, I'm afraid</p>



<a name="275670925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/275670925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#275670925">(Mar 17 2022 at 15:29)</a>:</h4>
<p>There's no rush at all! I'll be busy all day today with teaching anyway.</p>



<a name="276655960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/276655960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#276655960">(Mar 25 2022 at 17:50)</a>:</h4>
<p><span aria-label="ping pong" class="emoji emoji-1f3d3" role="img" title="ping pong">:ping_pong:</span> <br>
I would like to get this PR moving again (as well as the followup <a href="https://github.com/leanprover-community/mathlib/pull/12741">#12741</a> ).</p>
<p>I'm happy to leave <code>of_discrete_valuation_ring</code>as a non-instance lemma for now, but if there is a quick fix to the <code>fails_quickly</code> linter failing, that would be preferable.</p>



<a name="276657890"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/276657890" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jireh Loreaux <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#276657890">(Mar 25 2022 at 18:05)</a>:</h4>
<p>It may not be connected, but does your branch have Gabriel's removal of the path connected instance? This was causing a bunch of issues and that fix resolved two PRs for me.</p>



<a name="276658582"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/276658582" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#276658582">(Mar 25 2022 at 18:10)</a>:</h4>
<p>I don't think that's the issue --- I suspect it has something to do with the DVR instance for Witt vectors.<br>
Anyway, let me merge master just in case.</p>



<a name="276685463"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/276685463" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#276685463">(Mar 25 2022 at 22:08)</a>:</h4>
<p>Okay, it seems that we have the same issue with the instance as before, even after merging master.</p>



<a name="276685490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/276685490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#276685490">(Mar 25 2022 at 22:09)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/runs/5697987432?check_suite_focus=true">https://github.com/leanprover-community/mathlib/runs/5697987432?check_suite_focus=true</a></p>



<a name="276727659"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/276727659" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#276727659">(Mar 26 2022 at 14:03)</a>:</h4>
<p><span class="user-mention" data-user-id="112680">@Johan Commelin</span> you delegated this PR, but are you happy to have the DVR-&gt;valuation instance be a lemma to make the linter happy? If so, I'll change it to a non-instance and call on bors.</p>



<a name="276728920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/276728920" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#276728920">(Mar 26 2022 at 14:33)</a>:</h4>
<p><span class="user-mention" data-user-id="243562">@Adam Topaz</span> hmm, I don't know what the problem is here. It would be nice if we can keep it as an instance</p>



<a name="276728961"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/276728961" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#276728961">(Mar 26 2022 at 14:34)</a>:</h4>
<p>Yeah I agree</p>



<a name="276728971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/276728971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#276728971">(Mar 26 2022 at 14:34)</a>:</h4>
<p>And everything is a prop... It's strange</p>



<a name="276729039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/276729039" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#276729039">(Mar 26 2022 at 14:36)</a>:</h4>
<p>Unfortunately I don't know much about debugging such things</p>



<a name="277093738"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277093738" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277093738">(Mar 30 2022 at 04:35)</a>:</h4>
<p>I stripped it down to a <a href="https://leanprover-community.github.io/mwe.html">#mwe</a></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">ring_theory.valuation.valuation_ring</span>
<span class="c1">--import ring_theory.witt_vector.basic -- import this doesn't yield timeout</span>
<span class="kn">import</span> <span class="n">ring_theory.witt_vector.discrete_valuation_ring</span> <span class="c1">-- must import this to get timeout</span>
<span class="c1">--set_option trace.class_instances true</span>
<span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">nontrivial</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">apply_instance</span>
</code></pre></div>
<p>looks like the <code>valuation_ring.local_ring</code> introduced by this PR is also involved:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="bp">?</span><span class="n">x_7</span> <span class="o">:</span> <span class="n">nontrivial</span> <span class="n">R</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">local_ring.to_nontrivial</span> <span class="bp">?</span><span class="n">x_142</span> <span class="bp">?</span><span class="n">x_143</span> <span class="bp">?</span><span class="n">x_144</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="bp">?</span><span class="n">x_144</span> <span class="o">:</span> <span class="bp">@</span><span class="n">local_ring</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_143</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">valuation_ring.local_ring</span> <span class="bp">?</span><span class="n">x_145</span> <span class="bp">?</span><span class="n">x_146</span> <span class="bp">?</span><span class="n">x_147</span> <span class="bp">?</span><span class="n">x_148</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="bp">?</span><span class="n">x_148</span> <span class="o">:</span> <span class="bp">@</span><span class="n">valuation_ring</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_146</span> <span class="bp">?</span><span class="n">x_147</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">valuation_ring.of_discrete_valuation_ring</span> <span class="bp">?</span><span class="n">x_149</span> <span class="bp">?</span><span class="n">x_150</span> <span class="bp">?</span><span class="n">x_151</span> <span class="bp">?</span><span class="n">x_152</span>
</code></pre></div>
<p>and finally instance inference is stuck at <code>field R</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="n">caching</span> <span class="n">failure</span> <span class="n">for</span> <span class="n">field</span> <span class="n">R</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="n">cached</span> <span class="n">failure</span> <span class="n">for</span> <span class="n">field</span> <span class="n">R</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="n">cached</span> <span class="n">failure</span> <span class="n">for</span> <span class="n">field</span> <span class="n">R</span>
<span class="bp">...</span>
</code></pre></div>
<p>Full trace at <a href="https://gist.github.com/alreadydone/cd9fd4abf86dedae861884724586fc30">https://gist.github.com/alreadydone/cd9fd4abf86dedae861884724586fc30</a> if anyone wants to take a look</p>



<a name="277096884"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277096884" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277096884">(Mar 30 2022 at 05:44)</a>:</h4>
<p>Thanks! <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> do you think you can understand what the issue is here?</p>



<a name="277110793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277110793" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277110793">(Mar 30 2022 at 08:36)</a>:</h4>
<p>The repeated <code>cached failure for field R</code> messages suggest that there's a unification problem hitting some exponential case.</p>



<a name="277110880"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277110880" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277110880">(Mar 30 2022 at 08:37)</a>:</h4>
<p>With <code>set_option trace.type_context.is_def_eq_detail true</code> we get a trace like:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="n">caching</span> <span class="n">failure</span> <span class="n">for</span> <span class="n">field</span> <span class="n">R</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">3</span><span class="o">]:</span> <span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="bp">?</span><span class="n">x_135</span> <span class="bp">?</span><span class="n">x_136</span> <span class="bp">=?=</span> <span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="n">hp</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)))</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="n">cached</span> <span class="n">failure</span> <span class="n">for</span> <span class="n">field</span> <span class="n">R</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">4</span><span class="o">]:</span> <span class="bp">@</span><span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="n">hp</span> <span class="n">_inst_1</span> <span class="bp">=?=</span> <span class="bp">@</span><span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="n">hp</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="n">cached</span> <span class="n">failure</span> <span class="n">for</span> <span class="n">field</span> <span class="n">R</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">5</span><span class="o">]:</span> <span class="n">_inst_1</span> <span class="bp">=?=</span> <span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">_inst_1</span> <span class="bp">=?=</span> <span class="bp">@</span><span class="n">comm_ring.mk</span> <span class="n">R</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">has_add.add</span> <span class="n">R</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">distrib.to_has_add</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_distrib</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)))))</span>
  <span class="n">_</span>
  <span class="mi">0</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">field.nsmul</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">has_neg.neg</span> <span class="n">R</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">sub_neg_monoid.to_has_neg</span> <span class="n">R</span>
        <span class="o">(</span><span class="bp">@</span><span class="n">add_group.to_sub_neg_monoid</span> <span class="n">R</span>
           <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_group</span> <span class="n">R</span>
              <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)))))))</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">field.sub</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)</span>
  <span class="n">_</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">field.zsmul</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">has_mul.mul</span> <span class="n">R</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">distrib.to_has_mul</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_distrib</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)))))</span>
  <span class="n">_</span>
  <span class="mi">1</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">field.npow</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="n">on</span> <span class="n">failure</span><span class="o">:</span> <span class="n">_inst_1</span> <span class="bp">=?=</span> <span class="bp">@</span><span class="n">comm_ring.mk</span> <span class="n">R</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">has_add.add</span> <span class="n">R</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">distrib.to_has_add</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_distrib</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)))))</span>
  <span class="n">_</span>
  <span class="mi">0</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">field.nsmul</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">has_neg.neg</span> <span class="n">R</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">sub_neg_monoid.to_has_neg</span> <span class="n">R</span>
        <span class="o">(</span><span class="bp">@</span><span class="n">add_group.to_sub_neg_monoid</span> <span class="n">R</span>
           <span class="o">(</span><span class="bp">@</span><span class="n">add_comm_group.to_add_group</span> <span class="n">R</span>
              <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_add_comm_group</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)))))))</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">field.sub</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)</span>
  <span class="n">_</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">field.zsmul</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">has_mul.mul</span> <span class="n">R</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">distrib.to_has_mul</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_distrib</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">division_ring.to_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_division_ring</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)))))</span>
  <span class="n">_</span>
  <span class="mi">1</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">field.npow</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">left</span><span class="bp">&amp;</span><span class="n">right</span><span class="o">:</span> <span class="n">witt_vector.comm_ring</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">5</span><span class="o">]:</span> <span class="bp">@</span><span class="n">function.surjective.comm_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial</span> <span class="n">R</span> <span class="n">ℤ</span> <span class="n">int.comm_semiring</span><span class="o">))</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring_aux₂</span> <span class="n">p</span> <span class="n">R</span> <span class="n">hp</span> <span class="n">_inst_1</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_zero</span> <span class="n">p</span> <span class="n">R</span> <span class="n">_inst_1</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_one</span> <span class="n">p</span> <span class="n">R</span> <span class="n">_inst_1</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_add</span> <span class="n">p</span> <span class="n">R</span> <span class="n">_inst_1</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_mul</span> <span class="n">p</span> <span class="n">R</span> <span class="n">_inst_1</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_neg</span> <span class="n">p</span> <span class="n">R</span> <span class="n">_inst_1</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_sub</span> <span class="n">p</span> <span class="n">R</span> <span class="n">_inst_1</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_nat_scalar</span> <span class="n">p</span> <span class="n">R</span> <span class="n">_inst_1</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_int_scalar</span> <span class="n">p</span> <span class="n">R</span> <span class="n">_inst_1</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_nat_pow</span> <span class="n">p</span> <span class="n">R</span> <span class="n">_inst_1</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.map_fun</span> <span class="n">p</span> <span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial</span> <span class="n">R</span> <span class="n">ℤ</span> <span class="n">int.comm_semiring</span><span class="o">)</span> <span class="n">R</span> <span class="bp">⇑</span><span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span> <span class="n">_inst_1</span><span class="o">))</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span> <span class="bp">=?=</span> <span class="bp">@</span><span class="n">function.surjective.comm_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial</span> <span class="n">R</span> <span class="n">ℤ</span> <span class="n">int.comm_semiring</span><span class="o">))</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring_aux₂</span> <span class="n">p</span> <span class="n">R</span> <span class="n">hp</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)))</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_zero</span> <span class="n">p</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_one</span> <span class="n">p</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_add</span> <span class="n">p</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_mul</span> <span class="n">p</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_neg</span> <span class="n">p</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_sub</span> <span class="n">p</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_nat_scalar</span> <span class="n">p</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_int_scalar</span> <span class="n">p</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.has_nat_pow</span> <span class="n">p</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span> <span class="n">hp</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">witt_vector.map_fun</span> <span class="n">p</span> <span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial</span> <span class="n">R</span> <span class="n">ℤ</span> <span class="n">int.comm_semiring</span><span class="o">)</span> <span class="n">R</span>
     <span class="bp">⇑</span><span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))))</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
  <span class="n">_</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="bp">@</span><span class="n">witt_vector.map_fun</span> <span class="n">p</span> <span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial</span> <span class="n">R</span> <span class="n">ℤ</span> <span class="n">int.comm_semiring</span><span class="o">)</span> <span class="n">R</span> <span class="bp">⇑</span><span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="bp">=?=</span> <span class="bp">@</span><span class="n">witt_vector.map_fun</span> <span class="n">p</span> <span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial</span> <span class="n">R</span> <span class="n">ℤ</span> <span class="n">int.comm_semiring</span><span class="o">)</span> <span class="n">R</span>
  <span class="bp">⇑</span><span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)))</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">7</span><span class="o">]:</span> <span class="bp">⇑</span><span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span> <span class="n">_inst_1</span><span class="o">)</span> <span class="bp">=?=</span> <span class="bp">⇑</span><span class="o">(</span><span class="bp">@</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">)))</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">8</span><span class="o">]:</span> <span class="bp">@</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span> <span class="n">_inst_1</span> <span class="bp">=?=</span> <span class="bp">@</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span>
<span class="o">[</span><span class="n">class_instances</span><span class="o">]</span> <span class="n">cached</span> <span class="n">failure</span> <span class="n">for</span> <span class="n">field</span> <span class="n">R</span>
</code></pre></div>



<a name="277112059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277112059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277112059">(Mar 30 2022 at 08:46)</a>:</h4>
<p>Somehow, the system has decided that the <code>comm_ring R</code> instance derives from a hypothetical <code>field R</code> instance (rather than using <code>_inst_1</code> from the context). The rules for unification where a metavariable is in the place of an instance are basically:</p>
<ul>
<li>try to synthesize the instance (which fails here, leading to the "cached failure for field R" messages)</li>
<li>failing that, treat it as a normal metavariable, and hope that unification will solve the metavariable (which means here to unfold everything and try unifying the subterms, leading to the blowup)</li>
</ul>



<a name="277113273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277113273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277113273">(Mar 30 2022 at 08:57)</a>:</h4>
<p>What I don't quite understand is the following behaviour:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">discrete_valuation_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">apply_instance</span> <span class="c1">-- Fails quickly because there is no `is_domain (witt_vector p R)` instance in the context</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:=</span>
<span class="n">valuation_ring.of_discrete_valuation_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span> <span class="c1">-- Times out on `discrete_valuation_ring (witt_vector p R)`</span>
</code></pre></div>



<a name="277141588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277141588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277141588">(Mar 30 2022 at 13:09)</a>:</h4>
<p>It's also suspicious that <code>field R</code> failure is cached twice (line 165 and 490). Is that normal? <del>Maybe the two <code>field R</code> have different inferred implicit arguments?</del> (<code>field R</code> doesn't have any implicit arguments...)</p>



<a name="277142275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277142275" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277142275">(Mar 30 2022 at 13:14)</a>:</h4>
<p>It's possible that the first failure occurs in a temporary context that doesn't get reused in the second search. This is supposed to ensure that the elaborator making a wrong guess the first time won't cause issues when it tries the correct path.</p>



<a name="277142413"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277142413" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277142413">(Mar 30 2022 at 13:15)</a>:</h4>
<p><a href="https://leanprover-community.github.io/mathlib_docs/find/field">docs#field</a> doesn't have any other parameters than <code>R</code>, so the only reason I can think of that they differ is that <code>R</code> has a different universe which is defeq. But that's probably not the case.</p>



<a name="277144781"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277144781" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277144781">(Mar 30 2022 at 13:33)</a>:</h4>
<p>The issues seem to be there even if we switch everything to <code>Type</code>.</p>



<a name="277149390"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277149390" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277149390">(Mar 30 2022 at 14:04)</a>:</h4>
<p>Here's the trace with <code>set_option pp.universes true</code>: <a href="https://gist.github.com/alreadydone/01a2048941a3d31088fbfc96be92b76a">https://gist.github.com/alreadydone/01a2048941a3d31088fbfc96be92b76a</a> Indeed the two <code>field R</code> are <code>field.{?u_61} R</code> and <code>field.{?u_60} R</code> respectively, and <code>u_60</code> also appears in the cached <code>comm_ring.{?u_60} R</code> instance, while <code>u_61</code> seems "free".</p>



<a name="277151406"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277151406" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277151406">(Mar 30 2022 at 14:17)</a>:</h4>
<p>I'm not sure what the mwe is for this, but I expect this last bit is another instance of "<code>Type*</code> considered harmful"</p>



<a name="277212755"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277212755" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277212755">(Mar 30 2022 at 22:47)</a>:</h4>
<p>Thanks everyone for all the help with this! <br>
Unfortunately, I still don't understand the issue, but, for now, I removed all <code>Type*</code> and replaced them with explicit universe parameters.<br>
This probably won't fix anything considering Kevin's comment above, but it might be worth a shot anyway.</p>
<p>Unfortunately, I'm quite busy at the moment as it's near the end of our semester right now, so I won't have much time for lean for the next 1-2 weeks.</p>
<p>BTW, if anyone wants to push to this branch, please feel free!</p>



<a name="277248322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277248322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277248322">(Mar 31 2022 at 08:31)</a>:</h4>
<p>Looks like explicit universes didn't work either <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="277273751"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/277273751" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#277273751">(Mar 31 2022 at 12:40)</a>:</h4>
<p>They should at least simplify/clarify the instance trace though.</p>



<a name="278021918"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278021918" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278021918">(Apr 06 2022 at 13:20)</a>:</h4>
<p>I have extracted the following MWE</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">ring_theory.witt_vector.discrete_valuation_ring</span>

<span class="kd">universe</span> <span class="n">u</span>

<span class="kd">lemma</span> <span class="n">foobar</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">A</span><span class="o">]</span> <span class="o">[</span><span class="n">is_domain</span> <span class="n">A</span><span class="o">]</span> <span class="o">[</span><span class="n">discrete_valuation_ring</span> <span class="n">A</span><span class="o">]</span> <span class="o">:</span>
  <span class="n">true</span> <span class="o">:=</span> <span class="n">trivial</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span>
  <span class="o">[</span><span class="n">is_domain</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)]</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="k">have</span> <span class="o">:=</span> <span class="n">foobar</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">),</span> <span class="c1">-- &lt;-- this causes a timeout.</span>
  <span class="gr">sorry</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>
<p>In any case, it seems that this is not really related to the <code>dvr -&gt; valuation_ring</code> instance introduced by the PR in question.<br>
How should we proceed? I would like to get this PR merged soon as it's blocking some other stuff I have planned.</p>
<p>Option 1) Make <a href="https://leanprover-community.github.io/mathlib_docs/find/witt_vector.discrete_valuation_ring">docs#witt_vector.discrete_valuation_ring</a> a noninstance<br>
Option 2) Make <code>valuation_ring.of_discrete_valuation_ring</code> (which is part of this PR) a noninstance<br>
Option 3) Actually fix the problem (I don't know how to do this).</p>



<a name="278022130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278022130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278022130">(Apr 06 2022 at 13:21)</a>:</h4>
<p>Ping <span class="user-mention" data-user-id="112680">@Johan Commelin</span> <span class="user-mention" data-user-id="238446">@Anne Baanen</span></p>



<a name="278029402"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278029402" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278029402">(Apr 06 2022 at 14:13)</a>:</h4>
<p>I also extracted the MWE</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="n">p.prime</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">is_domain</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)]</span> <span class="o">:</span>
<span class="n">discrete_valuation_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">apply_instance</span>
</code></pre></div>
<p>which is roughly the same. The timeout happens during checking the following defeq with a hypothetical <code>field R</code> instance:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="n">p.prime</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">field</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="n">hp</span> <span class="n">field.to_euclidean_domain.to_comm_ring</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">refl</span>
</code></pre></div>
<p>The above code however doesn't yield a timeout, though it takes a long time (many seconds) to check, as <code>witt_vector</code> is complicated and not <code>irreducible</code>. This is because <code>field R</code> isn't a metavariable here; during instance inference where <code>field R</code> is metavariable, when Lean unfold down to a field of a structure that actually use the <code>field R</code> instance, it will hit the cache failure, but it doesn't just declare not defeq, but will try to unify further to somehow make up/synthesize the instance, which seems hopeless and bad behavior, and that seems to be what's causing the exponential blowup.</p>



<a name="278031279"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278031279" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278031279">(Apr 06 2022 at 14:26)</a>:</h4>
<p><a href="https://gist.github.com/alreadydone/22805c29bcc5f5e29469004e183ed993#file-instance_is_def_eq_detail-lean-L6637">As an example</a>, here Lean tries to unify</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.mk</span> <span class="n">R</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_ring.add</span> <span class="n">R</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_ring.to_non_unital_non_assoc_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_non_assoc_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="n">R</span> <span class="n">_inst_1</span><span class="o">))))</span> <span class="bp">...</span>
</code></pre></div>
<p>(notice the third line, which will appear again below)<br>
with the same thing with <code>_inst_ 1: comm_ring R</code> replaced by</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain.to_comm_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">field.to_euclidean_domain</span> <span class="n">R</span> <span class="bp">?</span><span class="n">x_159</span><span class="o">))</span>
</code></pre></div>
<p>with <code>?x_159 : field R</code>. It proceeds to unify the <code>@non_unital_non_assoc_ring.add</code> field, but hits cached failure for  <code>field R</code>. It doesn't immediately declare unification/defeq failure, but proceeds to</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">27</span><span class="o">]:</span> <span class="bp">@</span><span class="n">non_assoc_ring.to_non_unital_non_assoc_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_non_assoc_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="n">R</span> <span class="n">_inst_1</span><span class="o">))</span> <span class="bp">=?=</span>
</code></pre></div>
<p>leading to exponential blowup.</p>



<a name="278031598"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278031598" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278031598">(Apr 06 2022 at 14:28)</a>:</h4>
<p>So what's the conclusion? Is this a bug in TC resolution?</p>



<a name="278031916"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278031916" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278031916">(Apr 06 2022 at 14:31)</a>:</h4>
<p>I would say it's a bug since I don't see how this behavior could ever be helpful, and I doubt it's used under the hood anywhere in mathlib, but I guess I should ping experts like <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> to determine if there's an easy fix. I think the instances are all reasonable and wouldn't like to be forced to give up one of them. It seems that some caching mechanism for such unifications could avoid the exponential blowup?</p>



<a name="278032195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278032195" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278032195">(Apr 06 2022 at 14:32)</a>:</h4>
<p>(continued) In contrast, when <code>field R</code> isn't a metavariable, Lean doesn't try to unify further and direct proceed to unfold the next level:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">left</span><span class="bp">&amp;</span><span class="n">right</span><span class="o">:</span> <span class="n">non_unital_non_assoc_ring.to_non_unital_non_assoc_semiring</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">23</span><span class="o">]:</span> <span class="o">{</span><span class="n">add</span> <span class="o">:=</span> <span class="n">non_unital_non_assoc_ring.add</span> <span class="o">(</span><span class="n">non_assoc_ring.to_non_unital_non_assoc_ring</span> <span class="n">R</span><span class="o">),</span> <span class="bp">...</span><span class="o">}</span> <span class="bp">=?=</span> <span class="bp">...</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">24</span><span class="o">]:</span> <span class="n">non_unital_non_assoc_ring.add</span> <span class="bp">=?=</span> <span class="n">non_unital_non_assoc_ring.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">25</span><span class="o">]:</span> <span class="n">non_assoc_ring.add</span> <span class="bp">=?=</span> <span class="n">non_assoc_ring.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">26</span><span class="o">]:</span> <span class="n">ring.add</span> <span class="bp">=?=</span> <span class="n">ring.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">27</span><span class="o">]:</span> <span class="n">comm_ring.add</span> <span class="bp">=?=</span> <span class="n">comm_ring.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">28</span><span class="o">]:</span> <span class="n">comm_ring.add</span> <span class="bp">=?=</span> <span class="n">has_add.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">29</span><span class="o">]:</span> <span class="n">comm_ring.add</span> <span class="bp">=?=</span> <span class="n">distrib.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">30</span><span class="o">]:</span> <span class="n">comm_ring.add</span> <span class="bp">=?=</span> <span class="n">ring.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">31</span><span class="o">]:</span> <span class="n">comm_ring.add</span> <span class="bp">=?=</span> <span class="n">division_ring.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">32</span><span class="o">]:</span> <span class="n">comm_ring.add</span> <span class="bp">=?=</span> <span class="n">field.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">33</span><span class="o">]:</span> <span class="n">comm_ring.add</span> <span class="bp">=?=</span> <span class="n">field.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="n">on</span> <span class="n">failure</span><span class="o">:</span> <span class="n">comm_ring.add</span> <span class="bp">=?=</span> <span class="n">field.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="n">on</span> <span class="n">failure</span><span class="o">:</span> <span class="n">comm_ring.add</span> <span class="bp">=?=</span> <span class="n">field.add</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="n">on</span> <span class="n">failure</span><span class="o">:</span> <span class="o">{</span><span class="n">add</span> <span class="o">:=</span> <span class="n">non_unital_non_assoc_ring.add</span> <span class="o">(</span><span class="n">non_assoc_ring.to_non_unital_non_assoc_ring</span> <span class="n">R</span><span class="o">),</span> <span class="bp">...</span><span class="o">}</span> <span class="bp">=?=</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">left</span><span class="bp">&amp;</span><span class="n">right</span><span class="o">:</span> <span class="n">non_unital_non_assoc_semiring.to_mul_zero_class</span>
</code></pre></div>
<p>More: <a href="https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f">https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f</a></p>



<a name="278034248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278034248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278034248">(Apr 06 2022 at 14:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224323">Junyan Xu</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/278029402">said</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="n">p.prime</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">field</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="n">hp</span> <span class="n">field.to_euclidean_domain.to_comm_ring</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">refl</span>
</code></pre></div>
<p>The above code however doesn't yield a timeout, though it takes a long time (many seconds) to check, as <code>witt_vector</code> is complicated and not <code>irreducible</code>.</p>
</blockquote>
<p>I initially suspected the same, but if we check <a href="https://leanprover-community.github.io/mathlib_docs/find/witt_vector">docs#witt_vector</a>, we see it's already a <code>structure</code>.</p>



<a name="278034619"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278034619" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278034619">(Apr 06 2022 at 14:49)</a>:</h4>
<p>So what? It still get unfolded during defeq check as it's not <code>@[irreducible]</code>.</p>



<a name="278034663"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278034663" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278034663">(Apr 06 2022 at 14:49)</a>:</h4>
<p>By the way,<br>
<span class="user-mention silent" data-user-id="238446">Anne Baanen</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/277113273">said</a>:</p>
<blockquote>
<p>What I don't quite understand is the following behaviour:</p>
<p><div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">discrete_valuation_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">apply_instance</span> <span class="c1">-- Fails quickly because there is no `is_domain (witt_vector p R)` instance in the context</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:=</span>
<span class="n">valuation_ring.of_discrete_valuation_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span> <span class="c1">-- Times out on `discrete_valuation_ring (witt_vector p R)`</span>
</code></pre></div><br>
</p>
</blockquote>
<p>Both fail quickly on my machine.</p>



<a name="278034668"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278034668" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278034668">(Apr 06 2022 at 14:49)</a>:</h4>
<p>What exactly are you talking about being unfolded?</p>



<a name="278034996"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278034996" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278034996">(Apr 06 2022 at 14:51)</a>:</h4>
<p>Here's my full file:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">ring_theory.valuation.valuation_ring</span>
<span class="c1">--import ring_theory.witt_vector.basic -- import this doesn't yield timeout</span>
<span class="kn">import</span> <span class="n">ring_theory.witt_vector.discrete_valuation_ring</span> <span class="c1">-- must import this to get timeout</span>

<span class="kd">set_option</span> <span class="n">profiler</span> <span class="n">true</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:=</span>
<span class="n">valuation_ring.of_discrete_valuation_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">local_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="n">valuation_ring.local_ring</span> <span class="n">_</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">local_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">apply_instance</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">nontrivial</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">apply_instance</span>
</code></pre></div>



<a name="278035142"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278035142" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278035142">(Apr 06 2022 at 14:52)</a>:</h4>
<p>Conversely, your example fails quickly on my machine:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">ring_theory.valuation.valuation_ring</span>
<span class="c1">--import ring_theory.witt_vector.basic -- import this doesn't yield timeout</span>
<span class="kn">import</span> <span class="n">ring_theory.witt_vector.discrete_valuation_ring</span> <span class="c1">-- must import this to get timeout</span>

<span class="kd">set_option</span> <span class="n">profiler</span> <span class="n">true</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="n">p.prime</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">field</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="n">hp</span> <span class="n">field.to_euclidean_domain.to_comm_ring</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">refl</span> <span class="c1">-- less than 100 ms</span>
</code></pre></div>



<a name="278035248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278035248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278035248">(Apr 06 2022 at 14:52)</a>:</h4>
<p><code>witt_vector</code> gets unfolded like this in <a href="https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f">https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f</a></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">2</span><span class="o">]:</span> <span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="bp">=?=</span> <span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span>
<span class="bp">...</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">3</span><span class="o">]:</span> <span class="n">function.surjective.comm_ring</span> <span class="o">(</span><span class="n">witt_vector.map_fun</span> <span class="bp">⇑</span><span class="o">(</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span><span class="o">))</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="bp">=?=</span> <span class="n">function.surjective.comm_ring</span> <span class="o">(</span><span class="n">witt_vector.map_fun</span> <span class="bp">⇑</span><span class="o">(</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span><span class="o">))</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">4</span><span class="o">]:</span> <span class="n">witt_vector.map_fun</span> <span class="bp">⇑</span><span class="o">(</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span><span class="o">)</span> <span class="bp">=?=</span> <span class="n">witt_vector.map_fun</span> <span class="bp">⇑</span><span class="o">(</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span><span class="o">)</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">5</span><span class="o">]:</span> <span class="bp">⇑</span><span class="o">(</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span><span class="o">)</span> <span class="bp">=?=</span> <span class="bp">⇑</span><span class="o">(</span><span class="n">mv_polynomial.counit</span> <span class="n">R</span><span class="o">)</span>
<span class="o">[</span><span class="n">type_context.is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">mv_polynomial.counit</span> <span class="n">R</span> <span class="bp">=?=</span> <span class="n">mv_polynomial.counit</span> <span class="n">R</span>
<span class="bp">...</span>
</code></pre></div>



<a name="278035472"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278035472" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278035472">(Apr 06 2022 at 14:54)</a>:</h4>
<p>Looks like you're seeing the unfulding of the instance <code>witt_vector.comm_ring</code>, not the structure <code>witt_vector</code>.</p>



<a name="278035529"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278035529" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278035529">(Apr 06 2022 at 14:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="238446">Anne Baanen</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/278035142">said</a>:</p>
<blockquote>
<p>Conversely, your example fails quickly on my machine:</p>
<p><div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">ring_theory.valuation.valuation_ring</span>
<span class="c1">--import ring_theory.witt_vector.basic -- import this doesn't yield timeout</span>
<span class="kn">import</span> <span class="n">ring_theory.witt_vector.discrete_valuation_ring</span> <span class="c1">-- must import this to get timeout</span>

<span class="kd">set_option</span> <span class="n">profiler</span> <span class="n">true</span>

<span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="n">p.prime</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">field</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">witt_vector.comm_ring</span> <span class="n">p</span> <span class="n">R</span> <span class="n">hp</span> <span class="n">field.to_euclidean_domain.to_comm_ring</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">refl</span> <span class="c1">-- less than 100 ms</span>
</code></pre></div><br>
</p>
</blockquote>
<p>Yes, I said it doesn't yield a timeout:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">The</span> <span class="n">above</span> <span class="n">code</span> <span class="n">however</span> <span class="n">doesn't</span> <span class="n">yield</span> <span class="n">a</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">though</span> <span class="n">it</span> <span class="n">takes</span> <span class="n">a</span> <span class="n">long</span> <span class="n">time</span> <span class="o">(</span><span class="n">many</span> <span class="n">seconds</span><span class="o">)</span> <span class="n">to</span> <span class="n">check</span><span class="o">,</span> <span class="n">as</span> <span class="n">witt_vector</span> <span class="n">is</span> <span class="n">complicated</span> <span class="n">and</span> <span class="n">not</span> <span class="n">irreducible.</span>
</code></pre></div>



<a name="278035620"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278035620" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278035620">(Apr 06 2022 at 14:55)</a>:</h4>
<p>Line 65 of your gist says which definition is being unfolded: <code>[type_context.is_def_eq_detail] unfold left&amp;right: witt_vector.comm_ring</code></p>



<a name="278035684"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278035684" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278035684">(Apr 06 2022 at 14:55)</a>:</h4>
<p>Oh yes, that's my confusion. So making <code>witt_vector</code> irreducible won't help, making <code>witt_vector.comm_ring</code> irreducible might?</p>



<a name="278035974"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278035974" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278035974">(Apr 06 2022 at 14:57)</a>:</h4>
<p>Unfortunately, it will have to be somewhat reducible so that <a href="https://leanprover-community.github.io/mathlib_docs/find/witt_vector.has_zero">docs#witt_vector.has_zero</a> can unify with <code>comm_ring.to_has_zero witt_vector.comm_ring</code></p>



<a name="278036194"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278036194" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278036194">(Apr 06 2022 at 14:58)</a>:</h4>
<p>I don't think making typeclasses irreducible is a good idea at all (it's important for different paths to the same instance to be defeq, and irreducibility blocks that)</p>



<a name="278036236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278036236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278036236">(Apr 06 2022 at 14:58)</a>:</h4>
<p>Elsewhere we've just made the value of the <code>add</code> field (and the others) irreducible</p>



<a name="278036320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278036320" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278036320">(Apr 06 2022 at 14:59)</a>:</h4>
<p>But I get the feeling that might not fix the problem here</p>



<a name="278036382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278036382" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278036382">(Apr 06 2022 at 14:59)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Yes</span><span class="o">,</span> <span class="n">I</span> <span class="n">said</span> <span class="n">it</span> <span class="n">doesn't</span> <span class="n">yield</span> <span class="n">a</span> <span class="n">timeout</span><span class="o">:</span>
</code></pre></div>
<p>Oh, I see you're saying it takes 100ms on your machine but several seconds on mine.</p>



<a name="278036657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278036657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278036657">(Apr 06 2022 at 15:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224323">Junyan Xu</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/278036382">said</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Yes</span><span class="o">,</span> <span class="n">I</span> <span class="n">said</span> <span class="n">it</span> <span class="n">doesn't</span> <span class="n">yield</span> <span class="n">a</span> <span class="n">timeout</span><span class="o">:</span>
</code></pre></div>
<p>Oh, I see you're saying it takes 100ms on your machine but several seconds on mine.</p>
</blockquote>
<p>Perhaps you are running it with a lot of trace options on? That has slowed down elaboration dramatically for me before.</p>



<a name="278036745"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278036745" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278036745">(Apr 06 2022 at 15:01)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:</span>
<span class="n">local_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span> <span class="o">:=</span> <span class="n">valuation_ring.local_ring</span> <span class="n">_</span>
</code></pre></div>
<p>yields a timeout but</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">{</span><span class="n">p</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">}</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">hp</span> <span class="o">:</span> <span class="n">fact</span> <span class="o">(</span><span class="n">nat.prime</span> <span class="n">p</span><span class="o">)]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">:=</span>
<span class="n">valuation_ring.of_discrete_valuation_ring</span> <span class="o">(</span><span class="n">witt_vector</span> <span class="n">p</span> <span class="n">R</span><span class="o">)</span>
</code></pre></div>
<p>still does not.</p>



<a name="278037034"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278037034" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278037034">(Apr 06 2022 at 15:02)</a>:</h4>
<p>Yes probably, it takes several seconds to produce the trace <a href="https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f">https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f</a> , not just checking the defeq.</p>



<a name="278037130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278037130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278037130">(Apr 06 2022 at 15:03)</a>:</h4>
<p>Just the two options though</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">trace.class_instances</span> <span class="n">true</span>
<span class="kd">set_option</span> <span class="n">trace.type_context.is_def_eq_detail</span> <span class="n">true</span>
</code></pre></div>



<a name="278037293"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278037293" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278037293">(Apr 06 2022 at 15:04)</a>:</h4>
<p>I also observed the slowdown:<br>
Adding <code>set_option trace.type_context.is_def_eq_detail true</code> slow down Lean by a lot: without defeq detail, Lean outputs 75,312 lines with 74,828 lines of <code>[class_instances] cached failure for field R</code> before timeout; with defeq detail, the output has 36,117 lines with merely 411 lines of <code>field R</code> cache failures. If I increase the time limit to 10x, the output has 228,871 lines with 2676 lines of <code>field R</code> cache failures.</p>



<a name="278038416"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278038416" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278038416">(Apr 06 2022 at 15:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/278036236">said</a>:</p>
<blockquote>
<p>Elsewhere we've just made the value of the <code>add</code> field (and the others) irreducible</p>
</blockquote>
<p>The equivalent here would be to make <code>witt_vector.map_fun</code> irreducible, which unfortunately doesn't seem to help here.</p>



<a name="278045138"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278045138" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278045138">(Apr 06 2022 at 15:54)</a>:</h4>
<p>(<a href="https://leanprover-community.github.io/mathlib_docs/find/witt_vector.map_fun">docs#witt_vector.map_fun</a>)</p>



<a name="278045243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278045243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278045243">(Apr 06 2022 at 15:54)</a>:</h4>
<p>I'm not convinced, all the typeclass stuff happens in its argument</p>



<a name="278445918"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278445918" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278445918">(Apr 10 2022 at 03:41)</a>:</h4>
<p>I've produced a truly minimal example exhibiting 2^n exponential blowup: </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">trace.class_instances</span> <span class="n">true</span>
<span class="kd">set_option</span> <span class="n">trace.type_context.is_def_eq_detail</span> <span class="n">true</span>

<span class="kd">class</span> <span class="n">cls11</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u11</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls10</span> <span class="kd">extends</span> <span class="n">cls11</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u10</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls9</span> <span class="kd">extends</span> <span class="n">cls10</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u9</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls8</span> <span class="kd">extends</span> <span class="n">cls9</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u8</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls7</span> <span class="kd">extends</span> <span class="n">cls8</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u7</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls6</span> <span class="kd">extends</span> <span class="n">cls7</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u6</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls5</span> <span class="kd">extends</span> <span class="n">cls6</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u5</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls4</span> <span class="kd">extends</span> <span class="n">cls5</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u4</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls3</span> <span class="kd">extends</span> <span class="n">cls4</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u3</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls2</span> <span class="kd">extends</span> <span class="n">cls3</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u2</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls1</span> <span class="kd">extends</span> <span class="n">cls2</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u1</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls0</span> <span class="kd">extends</span> <span class="n">cls1</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u0</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>

<span class="kd">variable</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span>
<span class="kn">include</span> <span class="n">n</span>
<span class="kd">class</span> <span class="n">comm_ring</span> <span class="kd">extends</span> <span class="n">cls0</span> <span class="o">:=</span> <span class="o">(</span><span class="n">ucr</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">field</span> <span class="kd">extends</span> <span class="n">comm_ring</span> <span class="n">n</span> <span class="o">:=</span> <span class="o">(</span><span class="n">uf</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">dvr</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">n</span><span class="o">]</span> <span class="o">:=</span> <span class="o">(</span><span class="n">udvr</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>

<span class="kd">instance</span> <span class="o">[</span><span class="n">c</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">n.succ</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">ucr</span> <span class="o">:=</span> <span class="n">c.u11</span> <span class="o">}</span>
<span class="kd">instance</span> <span class="o">[</span><span class="n">field</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">dvr</span> <span class="n">n.succ</span> <span class="o">:=</span> <span class="o">⟨()⟩</span>
<span class="k">#print</span> <span class="n">nat.succ.comm_ring</span>
<span class="kn">omit</span> <span class="n">n</span>

<span class="kd">example</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="mi">0</span><span class="o">]</span> <span class="o">:</span> <span class="n">dvr</span> <span class="mi">1</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">apply_instance</span>

<span class="c">/-</span><span class="cm"> ucr := c.u11 : 67416 lines -/</span>
<span class="c">/-</span><span class="cm"> ... -/</span>
<span class="c">/-</span><span class="cm"> ucr := c.u5 : 1062 lines, diff = 524 -/</span>
<span class="c">/-</span><span class="cm"> ucr := c.u4 : 538 lines, diff = 264 -/</span>
<span class="c">/-</span><span class="cm"> ucr := c.u3 : 274 lines, diff = 130 -/</span>
<span class="c">/-</span><span class="cm"> ucr := c.u2 : 144 lines, diff = 64 -/</span>
<span class="c">/-</span><span class="cm"> ucr := c.u1 : 80 lines, diff = 32 -/</span>
<span class="c">/-</span><span class="cm"> ucr := c.u0 : 48 lines, diff = 16 -/</span>
<span class="c">/-</span><span class="cm"> ucr := c.ucr : 32 lines -/</span>
</code></pre></div>
<p>Here <code>instance [c : comm_ring n] : comm_ring n.succ</code> is the analogue of <code>witt_vector.comm_ring</code> (which is more complicated and possibly leads to faster blowup), and <code>instance [field n] : dvr n.succ</code> is the analogue of <code>witt_vector.discrete_valuation_ring</code>. The cls0, cls1, cls2, ... hierarchy is the analogue of the algebraic hierarchy, showing up in the trace like</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">@</span><span class="n">has_zero.mk</span> <span class="n">R</span>
  <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_class.zero</span> <span class="n">R</span>
     <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_semiring.to_mul_zero_class</span> <span class="n">R</span>
        <span class="o">(</span><span class="bp">@</span><span class="n">non_unital_non_assoc_ring.to_non_unital_non_assoc_semiring</span> <span class="n">R</span>
           <span class="o">(</span><span class="bp">@</span><span class="n">non_assoc_ring.to_non_unital_non_assoc_ring</span> <span class="n">R</span>
              <span class="o">(</span><span class="bp">@</span><span class="n">ring.to_non_assoc_ring</span> <span class="n">R</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_ring.to_ring</span> <span class="n">R</span> <span class="n">_inst_1</span><span class="o">))))))</span>
</code></pre></div>



<a name="278446041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278446041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278446041">(Apr 10 2022 at 03:45)</a>:</h4>
<p>Can someone reproduce this in Lean 4?</p>



<a name="278446405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278446405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278446405">(Apr 10 2022 at 03:57)</a>:</h4>
<p>Indeed changing <code>ucr</code> to something more complicated like <code>ucr := if c.u11 then c.u10 else c.u9</code> (with <code>u11 : unit</code> changed to <code>u11 : bool</code>) generates 9x larger output.</p>



<a name="278446904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278446904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278446904">(Apr 10 2022 at 04:09)</a>:</h4>
<p>It appears that the exponential blowup is caused by certain defeq/unification problems being solved exponentially many times, so a caching mechanism would likely help. We just want find a way to fail quickly in this case to safisfy the linter. <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Are you interested in looking into this? Should I open an issue at the Lean3 repo?</p>



<a name="278458413"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278458413" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278458413">(Apr 10 2022 at 09:35)</a>:</h4>
<p>there are several known exponential blowup issues in lean 3 typeclass inference, this is one of the major motivations for the rewrite in lean 4 (<a href="https://arxiv.org/abs/2001.04301">https://arxiv.org/abs/2001.04301</a>) and I don't expect things to get fundamentally better in lean 3</p>



<a name="278459373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278459373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278459373">(Apr 10 2022 at 09:59)</a>:</h4>
<p>Here's the lean 4 version</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">trace.Meta.synthInstance</span> <span class="n">true</span>

<span class="kd">class</span> <span class="n">cls11</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u11</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls10</span> <span class="kd">extends</span> <span class="n">cls11</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u10</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls9</span> <span class="kd">extends</span> <span class="n">cls10</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u9</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls8</span> <span class="kd">extends</span> <span class="n">cls9</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u8</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls7</span> <span class="kd">extends</span> <span class="n">cls8</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u7</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls6</span> <span class="kd">extends</span> <span class="n">cls7</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u6</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls5</span> <span class="kd">extends</span> <span class="n">cls6</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u5</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls4</span> <span class="kd">extends</span> <span class="n">cls5</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u4</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls3</span> <span class="kd">extends</span> <span class="n">cls4</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u3</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls2</span> <span class="kd">extends</span> <span class="n">cls3</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u2</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls1</span> <span class="kd">extends</span> <span class="n">cls2</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u1</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">cls0</span> <span class="kd">extends</span> <span class="n">cls1</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u0</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>

<span class="kd">variable</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">CommRing</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">cls0</span> <span class="o">:=</span> <span class="o">(</span><span class="n">ucr</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">Field</span> <span class="kd">extends</span> <span class="n">CommRing</span> <span class="n">n</span> <span class="o">:=</span> <span class="o">(</span><span class="n">uf</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">DVR</span> <span class="o">[</span><span class="n">CommRing</span> <span class="n">n</span><span class="o">]</span> <span class="o">:=</span> <span class="o">(</span><span class="n">udvr</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span>

<span class="kd">instance</span> <span class="o">[</span><span class="n">c</span> <span class="o">:</span> <span class="n">CommRing</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">CommRing</span> <span class="n">n.succ</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">ucr</span> <span class="o">:=</span> <span class="n">c.u11</span> <span class="o">}</span>
<span class="kd">instance</span> <span class="o">[</span><span class="n">Field</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">DVR</span> <span class="n">n.succ</span> <span class="o">:=</span> <span class="o">⟨()⟩</span>
<span class="k">#print</span> <span class="n">instCommRingSucc</span>

<span class="kd">example</span> <span class="o">[</span><span class="n">CommRing</span> <span class="mi">0</span><span class="o">]</span> <span class="o">:</span> <span class="n">DVR</span> <span class="mi">1</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
</code></pre></div>
<p>The last line fails, but it seems like it is supposed to from the test?</p>



<a name="278467790"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278467790" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278467790">(Apr 10 2022 at 13:18)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Thanks for pointing to the paper. Yes it's supposed to fail as there's no hope to synthesize the <code>field 0</code> instance (especially if you replace <code>uf : unit</code> by <code>uf : empty</code>), so we'd like it to fail quickly, but Lean3 keeps trying to unify, as if it might come up with the instance somehow.<br>
Do you see the expoential blowup from the trace in Lean4? For example, replace <code>ucr := c.u11</code> by <code>ucr := c.u10</code> and check whether the output shrink to 1/2. I should probably set up Lean4 on my machine sometime ... or is there a web editor?<br>
If Lean4 doesn't have the exponential blowup, maybe we should find a workaround for the current PR, instead of backporting to Lean3 (which would be too hard)?</p>



<a name="278467800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278467800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278467800">(Apr 10 2022 at 13:19)</a>:</h4>
<p>it's almost instant so I don't think the issue manifests</p>



<a name="278468127"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278468127" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278468127">(Apr 10 2022 at 13:27)</a>:</h4>
<p>Okay, so what should I do about <a href="https://github.com/leanprover-community/mathlib/pull/12719">#12719</a> ? (I'll make a poll)</p>



<a name="278468202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278468202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278468202">(Apr 10 2022 at 13:29)</a>:</h4>
<p>/poll What should we do about <a href="https://github.com/leanprover-community/mathlib/pull/12719">#12719</a><br>
Make DVR -&gt; valuation ring a noninstance.<br>
Make the discrete valuation ring instance on Witt vectors a noninstance.</p>



<a name="278468256"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278468256" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278468256">(Apr 10 2022 at 13:30)</a>:</h4>
<p>In any case, I would add a <code>TODO</code> comment saying that the instance could be added back after the port to Lean4</p>



<a name="278470842"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278470842" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278470842">(Apr 10 2022 at 14:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings/near/278467800">said</a>:</p>
<blockquote>
<p>it's almost instant so I don't think the issue manifests</p>
</blockquote>
<p>Actually in Lean3 I also need <code>ucr := c.u20</code> to get (deterministic) timeout without tracing options, and for <code>c.u11</code> it's also almost instant. So it would be nice if someone can confirm there's no exponential blowup in Lean4. (The max depth is 53 in the case of <a href="https://gist.github.com/alreadydone/ececa418633ff174346b84f1007f5a0f">witt_vector.comm_ring</a> even though there seems to be no <code>extends</code> chain as long as 20; the max depth is only 17 in the <code>c.u11</code> MWE.)</p>
<p>(<a href="https://gist.github.com/alreadydone/1b52f7ea9edf00b7a1fb83f90efd8a33">Lean3 MWE with <code>c.u20</code></a>)</p>



<a name="278476507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278476507" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278476507">(Apr 10 2022 at 16:23)</a>:</h4>
<p>Wow, I find that adding an <code>id</code> before <code>c.u11</code> has the effect of making the trace 4x as large, but adding two <code>id</code>s only makes it 8x as large. So we may replace the <code>extends</code> chain by <code>id $ id $ ...</code>.</p>



<a name="278477059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278477059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278477059">(Apr 10 2022 at 16:33)</a>:</h4>
<p>Now we just need three typeclasses and three instances (one from <code>extends</code>) to produce the exponential blowup!</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">class</span> <span class="n">comm_ring</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">ucr</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>
<span class="kd">variable</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">field</span> <span class="kd">extends</span> <span class="n">comm_ring</span> <span class="n">n</span> <span class="o">:=</span> <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="n">empty</span><span class="o">)</span>
<span class="kd">class</span> <span class="n">dvr</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">n</span><span class="o">]</span> <span class="o">:=</span> <span class="o">(</span><span class="n">u</span> <span class="o">:</span> <span class="n">unit</span><span class="o">)</span>

<span class="kd">instance</span> <span class="o">[</span><span class="n">c</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">n.succ</span> <span class="o">:=</span> <span class="o">⟨</span><span class="n">id</span><span class="bp">^</span><span class="o">[</span><span class="mi">19</span><span class="o">]</span> <span class="n">c.ucr</span><span class="o">⟩</span>
<span class="kd">instance</span> <span class="o">[</span><span class="n">field</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">dvr</span> <span class="n">n.succ</span> <span class="o">:=</span> <span class="o">⟨()⟩</span>

<span class="kd">example</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="mi">0</span><span class="o">]</span> <span class="o">:</span> <span class="n">dvr</span> <span class="mi">1</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">apply_instance</span>
</code></pre></div>



<a name="278478115"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278478115" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278478115">(Apr 10 2022 at 16:55)</a>:</h4>
<p>(In lean 4) Using a deep hierarchy on its own does not make it take very long, but using <code>c.u20</code> it hits the timeout. Using <code>Nat.repeat id 19 c.ucr</code> as in your last example still works fine</p>



<a name="278478327"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278478327" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278478327">(Apr 10 2022 at 16:59)</a>:</h4>
<p>Thanks for testing! I wonder how long the current longest <code>extends</code> chain in mathlib is? If it's ~10 then maybe we need not worry about Lean4 according to your test.</p>



<a name="278478569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278478569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278478569">(Apr 10 2022 at 17:03)</a>:</h4>
<p>reported as <a href="https://github.com/leanprover/lean4/pull/1102">lean4#1102</a></p>



<a name="278478651"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278478651" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278478651">(Apr 10 2022 at 17:05)</a>:</h4>
<p>Maybe not just <code>extends</code> chains, but also arbitrary instance chain; e.g. <a href="https://leanprover-community.github.io/mathlib_docs/find/ring.to_non_assoc_ring/src">src#ring.to_non_assoc_ring</a> isn't from <code>extends</code> in the witt_vector example.</p>



<a name="278479215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2312719%20--%20valuation%20rings/near/278479215" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2312719.20--.20valuation.20rings.html#278479215">(Apr 10 2022 at 17:16)</a>:</h4>
<p>You said in the issue that the example is a bit artificial, and I'd agree in the sense that the linter is a bit artificial, since it works by dropping assumptions from mathlib instances and checking they fail quickly. In <a href="https://github.com/leanprover-community/mathlib/runs/5855466421?check_suite_focus=true">the instance that triggered the whole discusssion</a>, the <code>[nontrivial R]</code> assumption is dropped, while in practice maybe you'd never try to synthesize that instance when <code>[nontrivial R]</code> is not in the context?</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>