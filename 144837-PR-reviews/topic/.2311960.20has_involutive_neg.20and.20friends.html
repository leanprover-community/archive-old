---
layout: archive
title: Zulip Chat Archive
permalink: /stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/index.html">PR reviews</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html">#11960 has_involutive_neg and friends</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="271803027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271803027" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271803027">(Feb 14 2022 at 09:39)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/pull/11960">#11960</a> introduces a <code>has_involutive_neg</code> typeclass modeled after <a href="https://leanprover-community.github.io/mathlib_docs/find/has_involutive_star">docs#has_involutive_star</a>, that allows us to merge together all our <code>neg_neg</code> lemmas (and same for <code>inv_inv</code>).</p>
<p>I'm worried this will go stale quite quickly, as a lot of commonly-used lemmas like <a href="https://leanprover-community.github.io/mathlib_docs/find/inv">docs#inv</a>_inv₀ have been made redundant and removed.</p>
<p>Do these new typeclasses seem reasonable?</p>



<a name="271806507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271806507" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271806507">(Feb 14 2022 at 10:14)</a>:</h4>
<p>You're missing <code>has_distrib_neg (set α)</code>. cf <a href="https://leanprover-community.github.io/mathlib_docs/find/set.neg_smul">docs#set.neg_smul</a> although we seem to be missing the <code>mul</code> version?</p>



<a name="271807298"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271807298" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271807298">(Feb 14 2022 at 10:22)</a>:</h4>
<p>If the lemmas aren't already there then I'd lean towards leaving that instance to a follow-up</p>



<a name="271807367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271807367" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271807367">(Feb 14 2022 at 10:23)</a>:</h4>
<p>I only added the instances for <code>unitary</code>, <code>special_linear_group</code>, and <code>GL_pos</code> as part of that PR (where there were no existing lemmas) because they were trivial applications of <code>subtype.ext</code>.</p>



<a name="271807477"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271807477" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271807477">(Feb 14 2022 at 10:24)</a>:</h4>
<p>However that points out the shortcomings of <code>has_distrib_neg</code>: it only talks about distributivity of <code>mul</code>, not of <code>smul</code>.</p>



<a name="271807518"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271807518" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271807518">(Feb 14 2022 at 10:24)</a>:</h4>
<p>Yes, <code>neg_smul</code> I very deliberately left to a follow-up PR</p>



<a name="271807546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271807546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yaël Dillies <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271807546">(Feb 14 2022 at 10:24)</a>:</h4>
<p>What's the plan?</p>



<a name="271807626"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271807626" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271807626">(Feb 14 2022 at 10:25)</a>:</h4>
<p>"Snipe <span class="user-mention" data-user-id="387244">@Yaël Dillies</span> with generalization ideas and leave them to explore those after my PR is merged" seems like a workable plan right now ;)</p>



<a name="271807749"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271807749" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271807749">(Feb 14 2022 at 10:26)</a>:</h4>
<p>My plan stopped at "<code>has_distrib_neg</code> will deduplicate around 25 lemmas", and accidentally expanded to "<code>has_involutive_neg</code> will deduplicate another 20 more"</p>



<a name="271956212"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271956212" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271956212">(Feb 15 2022 at 10:51)</a>:</h4>
<p>The one downside of this PR is that <a href="https://github.com/leanprover-community/mathlib/pull/11960#discussion_r806436692">it means <code>simp</code> now times out when trying to find a 3x3 determinant</a>. <span class="user-mention" data-user-id="308899">@Yakov Pechersky</span>, <span class="user-mention" data-user-id="238446">@Anne Baanen</span>, do we care about that? We have <a href="https://leanprover-community.github.io/mathlib_docs/find/matrix.det_fin_three">docs#matrix.det_fin_three</a> anyway.</p>



<a name="271957519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271957519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271957519">(Feb 15 2022 at 11:02)</a>:</h4>
<p>I don't think <code>simp</code> is the best tool to solve this problem, so as long as this doesn't indicate a <code>simp</code> loop (it doesn't, right?), I wouldn't block the PR on that.</p>



<a name="271957537"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271957537" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anne Baanen <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271957537">(Feb 15 2022 at 11:02)</a>:</h4>
<p>Does the <code>simp only</code> form in the comments still work, or does that also time out now?</p>



<a name="271957722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271957722" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271957722">(Feb 15 2022 at 11:04)</a>:</h4>
<p>I think that's not good. That sounds like a typeclass search is happening too often</p>



<a name="271957763"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271957763" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271957763">(Feb 15 2022 at 11:05)</a>:</h4>
<p>could someone summarize the relevant changes? Is <code>neg_neg</code> using an extra typeclass assumption now?</p>



<a name="271957835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271957835" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271957835">(Feb 15 2022 at 11:05)</a>:</h4>
<p>the quick fix is to not make the general <code>neg_neg</code> a simp lemma and instead reinstate the original one just for simp</p>



<a name="271958428"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271958428" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271958428">(Feb 15 2022 at 11:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends/near/271957763">said</a>:</p>
<blockquote>
<p>could someone summarize the relevant changes? Is <code>neg_neg</code> using an extra typeclass assumption now?</p>
</blockquote>
<p><code>neg_neg</code> now has a dedicated typeclass, and there is a similar typeclass that extends it for (<code>neg_mul</code>, <code>mul_neg</code>, <code>neg_mul_neg</code>, ...)</p>



<a name="271958922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271958922" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271958922">(Feb 15 2022 at 11:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="238446">Anne Baanen</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends/near/271957537">said</a>:</p>
<blockquote>
<p>Does the <code>simp only</code> form in the comments still work, or does that also time out now?</p>
</blockquote>
<p>Yes, that still works</p>



<a name="271959696"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271959696" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271959696">(Feb 15 2022 at 11:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="238446">Anne Baanen</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends/near/271957519">said</a>:</p>
<blockquote>
<p>I don't think <code>simp</code> is the best tool to solve this problem, so as long as this doesn't indicate a <code>simp</code> loop (it doesn't, right?), I wouldn't block the PR on that.</p>
</blockquote>
<p>I assume it doesn't indicate a loop, because there's no such problem on the 2x2 matrix</p>



<a name="271960320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271960320" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271960320">(Feb 15 2022 at 11:28)</a>:</h4>
<p>I've gone ahead and changed it to use the <code>simp only</code> instead. I have no real idea how to debug the timeout - <code>trace.simplify.rewrites</code> doesn't seem to be showing anything obvious</p>



<a name="271960567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271960567" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271960567">(Feb 15 2022 at 11:31)</a>:</h4>
<p>Does <code>squeeze_simp</code> give you the same set of rewrites?</p>



<a name="271960645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271960645" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271960645">(Feb 15 2022 at 11:31)</a>:</h4>
<p>you can increase the timeout or run it in the console (which has infinite timeout) to see it complete</p>



<a name="271960983"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271960983" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271960983">(Feb 15 2022 at 11:35)</a>:</h4>
<p>That's <code>-T</code>, right?</p>



<a name="271961087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271961087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271961087">(Feb 15 2022 at 11:36)</a>:</h4>
<p>Oh sorry, you mean in the console I don't even need to pass the argument because the default is no limit</p>



<a name="271961373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271961373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271961373">(Feb 15 2022 at 11:39)</a>:</h4>
<p>The output is pretty similar - here's what's in the comment at the moment:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">det_succ_row_zero</span><span class="o">,</span> <span class="n">fin.sum_univ_succ</span><span class="o">,</span> <span class="n">neg_mul</span><span class="o">,</span> <span class="n">cons_append</span><span class="o">,</span>
    <span class="n">mul_one</span><span class="o">,</span> <span class="n">fin.default_eq_zero</span><span class="o">,</span> <span class="n">fin.coe_zero</span><span class="o">,</span> <span class="n">cons_vec_bit0_eq_alt0</span><span class="o">,</span> <span class="n">one_mul</span><span class="o">,</span> <span class="n">cons_val_one</span><span class="o">,</span>
    <span class="n">cons_vec_alt0</span><span class="o">,</span> <span class="n">fin.succ_succ_above_one</span><span class="o">,</span> <span class="n">fin.coe_succ</span><span class="o">,</span> <span class="n">finset.univ_unique</span><span class="o">,</span> <span class="n">minor_apply</span><span class="o">,</span> <span class="n">pow_one</span><span class="o">,</span>
    <span class="n">fin.zero_succ_above</span><span class="o">,</span> <span class="n">fin.succ_zero_eq_one</span><span class="o">,</span> <span class="n">fin.succ_succ_above_zero</span><span class="o">,</span> <span class="n">nat.neg_one_sq</span><span class="o">,</span>
    <span class="n">finset.sum_singleton</span><span class="o">,</span> <span class="n">cons_val_zero</span><span class="o">,</span> <span class="n">cons_val_succ</span><span class="o">,</span> <span class="n">det_fin_zero</span><span class="o">,</span> <span class="n">head_cons</span><span class="o">,</span> <span class="n">pow_zero</span><span class="o">],</span>
</code></pre></div>
<p>vs with this PR:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">det_succ_row_zero</span><span class="o">,</span> <span class="n">fin.sum_univ_succ</span><span class="o">,</span> <span class="n">cons_val_zero</span><span class="o">,</span> <span class="n">minor_apply</span><span class="o">,</span> <span class="n">fin.succ_zero_eq_one</span><span class="o">,</span> <span class="n">cons_val_one</span><span class="o">,</span>
    <span class="n">head_cons</span><span class="o">,</span> <span class="n">fintype.univ_of_subsingleton</span><span class="o">,</span> <span class="n">fin.mk_eq_subtype_mk</span><span class="o">,</span> <span class="n">fin.mk_zero</span><span class="o">,</span> <span class="n">det_fin_zero</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span>
    <span class="n">finset.sum_singleton</span><span class="o">,</span> <span class="n">fin.coe_zero</span><span class="o">,</span> <span class="n">pow_zero</span><span class="o">,</span> <span class="n">one_mul</span><span class="o">,</span> <span class="n">fin.zero_succ_above</span><span class="o">,</span> <span class="n">fin.coe_succ</span><span class="o">,</span> <span class="n">fin.succ_succ_above_zero</span><span class="o">,</span>
    <span class="n">pow_one</span><span class="o">,</span> <span class="n">neg_mul</span><span class="o">,</span> <span class="n">cons_val_succ</span><span class="o">,</span> <span class="n">fin.succ_succ_above_one</span><span class="o">,</span> <span class="n">nat.neg_one_sq</span><span class="o">],</span>
</code></pre></div>



<a name="271961439"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271961439" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271961439">(Feb 15 2022 at 11:40)</a>:</h4>
<p>does that <code>simp only</code> run with regular timeout?</p>



<a name="271961450"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271961450" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271961450">(Feb 15 2022 at 11:40)</a>:</h4>
<p>Yes</p>



<a name="271961473"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271961473" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271961473">(Feb 15 2022 at 11:40)</a>:</h4>
<p>(and very quickly too)</p>



<a name="271961481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271961481" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271961481">(Feb 15 2022 at 11:40)</a>:</h4>
<p>so the problem is likely in the failed rewrites</p>



<a name="271961496"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271961496" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271961496">(Feb 15 2022 at 11:40)</a>:</h4>
<p>there is a trace option for that too</p>



<a name="271961520"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271961520" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271961520">(Feb 15 2022 at 11:41)</a>:</h4>
<p><code>set_option trace.simp_lemmas.failure true</code></p>



<a name="271961585"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271961585" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271961585">(Feb 15 2022 at 11:41)</a>:</h4>
<p>you can probably do it on the 2x2 assuming that you get a similar simp only list</p>



<a name="271962119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271962119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271962119">(Feb 15 2022 at 11:47)</a>:</h4>
<p>Do you have any ideas about why the simp only lists are different?</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gu">@@ -1,24 +1,26 @@</span><span class="w"></span>
<span class="gi">+cons_append</span><span class="w"></span>
<span class="w"> </span>cons_val_one<span class="w"></span>
<span class="w"> </span>cons_val_succ<span class="w"></span>
<span class="w"> </span>cons_val_zero<span class="w"></span>
<span class="gi">+cons_vec_alt0</span><span class="w"></span>
<span class="gi">+cons_vec_bit0_eq_alt0</span><span class="w"></span>
<span class="w"> </span>det_fin_zero<span class="w"></span>
<span class="w"> </span>det_succ_row_zero<span class="w"></span>
<span class="w"> </span>fin.coe_succ<span class="w"></span>
<span class="w"> </span>fin.coe_zero<span class="w"></span>
<span class="gd">-fin.mk_eq_subtype_mk</span><span class="w"></span>
<span class="gd">-fin.mk_zero</span><span class="w"></span>
<span class="gi">+fin.default_eq_zero</span><span class="w"></span>
<span class="w"> </span>finset.sum_singleton<span class="w"></span>
<span class="gi">+finset.univ_unique</span><span class="w"></span>
<span class="w"> </span>fin.succ_succ_above_one<span class="w"></span>
<span class="w"> </span>fin.succ_succ_above_zero<span class="w"></span>
<span class="w"> </span>fin.succ_zero_eq_one<span class="w"></span>
<span class="w"> </span>fin.sum_univ_succ<span class="w"></span>
<span class="gd">-fintype.univ_of_subsingleton</span><span class="w"></span>
<span class="w"> </span>fin.zero_succ_above<span class="w"></span>
<span class="w"> </span>head_cons<span class="w"></span>
<span class="w"> </span>minor_apply<span class="w"></span>
<span class="w"> </span>mul_one<span class="w"></span>
<span class="w"> </span>nat.neg_one_sq<span class="w"></span>
<span class="w"> </span>neg_mul<span class="w"></span>
<span class="w"> </span>one_mul<span class="w"></span>
<span class="w"> </span>pow_one<span class="w"></span>
<span class="w"> </span>pow_zero<span class="w"></span>
</code></pre></div>



<a name="271962320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271962320" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271962320">(Feb 15 2022 at 11:49)</a>:</h4>
<p><del>docs#finset.univ_unique probably isn't simp any more</del></p>



<a name="271962396"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271962396" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271962396">(Feb 15 2022 at 11:50)</a>:</h4>
<p>Here's the diff in the <code>rewrite_failures</code> output: <a href="/user_uploads/3121/SoTONud-9pqKs3y8SoB_ormr/traces.diff">traces.diff</a></p>



<a name="271962588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271962588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271962588">(Feb 15 2022 at 11:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends/near/271962320">said</a>:</p>
<blockquote>
<p><a href="https://leanprover-community.github.io/mathlib_docs/find/finset.univ_unique">docs#finset.univ_unique</a> probably isn't simp any more</p>
</blockquote>
<p>it still is and you don't seem to have touched it in your PR</p>



<a name="271962635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271962635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271962635">(Feb 15 2022 at 11:52)</a>:</h4>
<p>I think the <code>simp only</code> line in the comment is out of date. Here's the regenerated <code>simp only</code> list on master:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">matrix.det_succ_row_zero</span><span class="o">,</span> <span class="n">fin.sum_univ_succ</span><span class="o">,</span> <span class="n">cons_val_zero</span><span class="o">,</span> <span class="n">minor_apply</span><span class="o">,</span> <span class="n">fin.succ_zero_eq_one</span><span class="o">,</span> <span class="n">cons_val_one</span><span class="o">,</span>
  <span class="n">head_cons</span><span class="o">,</span> <span class="n">fintype.univ_of_subsingleton</span><span class="o">,</span> <span class="n">fin.mk_eq_subtype_mk</span><span class="o">,</span> <span class="n">fin.mk_zero</span><span class="o">,</span> <span class="n">det_fin_zero</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span>
  <span class="n">finset.sum_singleton</span><span class="o">,</span> <span class="n">fin.coe_zero</span><span class="o">,</span> <span class="n">pow_zero</span><span class="o">,</span> <span class="n">one_mul</span><span class="o">,</span> <span class="n">fin.zero_succ_above</span><span class="o">,</span> <span class="n">fin.coe_succ</span><span class="o">,</span> <span class="n">fin.succ_succ_above_zero</span><span class="o">,</span>
  <span class="n">pow_one</span><span class="o">,</span> <span class="n">neg_mul</span><span class="o">,</span> <span class="n">cons_val_succ</span><span class="o">,</span> <span class="n">fin.succ_succ_above_one</span><span class="o">,</span> <span class="n">nat.neg_one_sq</span><span class="o">]</span>
</code></pre></div>



<a name="271962687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271962687" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271962687">(Feb 15 2022 at 11:53)</a>:</h4>
<p>Which as far as I can tell is identical</p>



<a name="271962793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271962793" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271962793">(Feb 15 2022 at 11:54)</a>:</h4>
<p>Notably, <code>squeeze_simp</code> also times out on master</p>



<a name="271962805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271962805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271962805">(Feb 15 2022 at 11:54)</a>:</h4>
<p>So I think this might just be really close to the timeout threshold already</p>



<a name="271963142"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271963142" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271963142">(Feb 15 2022 at 11:57)</a>:</h4>
<p><code>try_for 53000 { simp [matrix.det_succ_row_zero, fin.sum_univ_succ] },</code> times out on the 3x3 case on master (54000 is ok)</p>



<a name="271963357"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271963357" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271963357">(Feb 15 2022 at 11:59)</a>:</h4>
<p>what about on the PR? (Increase the timeout using <code>set_option timeout</code> and then play with <code>try_for N</code>)</p>



<a name="271963746"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271963746" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271963746">(Feb 15 2022 at 12:03)</a>:</h4>
<p>It looks like <code>try_for</code> overrides the default timeout?</p>



<a name="271963759"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271963759" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271963759">(Feb 15 2022 at 12:03)</a>:</h4>
<p>So actually, any slow proof can be fixed by just locally using <code>try_for</code></p>



<a name="271963893"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271963893" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271963893">(Feb 15 2022 at 12:04)</a>:</h4>
<p><code>136000</code> fails, <code>137000</code> succeeds - so about 2.5x slower with this PR</p>



<a name="271964085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271964085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271964085">(Feb 15 2022 at 12:06)</a>:</h4>
<p>can you capture and diff the rewrite failure output? My main worry is that simp is 2.5x slower across the board</p>



<a name="271964126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271964126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271964126">(Feb 15 2022 at 12:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends/near/271962396">said</a>:</p>
<blockquote>
<p>Here's the diff in the <code>rewrite_failures</code> output: <a href="/user_uploads/3121/SoTONud-9pqKs3y8SoB_ormr/traces.diff">traces.diff</a></p>
</blockquote>
<p>I did so here</p>



<a name="271964133"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271964133" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271964133">(Feb 15 2022 at 12:07)</a>:</h4>
<p>and determinant calculation is just an especially bad case because of all the multiplication and subtraction</p>



<a name="271964365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271964365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271964365">(Feb 15 2022 at 12:09)</a>:</h4>
<p>I'll try tracing typeclass instances at the same time</p>



<a name="271964632"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271964632" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271964632">(Feb 15 2022 at 12:12)</a>:</h4>
<p>I don't see anything especially incriminating in the rewrite failure list, if anything there are fewer lemmas to look at. So it's probably the typeclasses</p>



<a name="271964903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271964903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271964903">(Feb 15 2022 at 12:14)</a>:</h4>
<p>Weirdly I can't seem to get output from both traces at the same time.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">trace.simp_lemmas.failure</span> <span class="n">true</span>
<span class="kd">set_option</span> <span class="n">trace.class_instances</span> <span class="n">true</span>
</code></pre></div>
<p>only traces the second</p>



<a name="271965135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271965135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271965135">(Feb 15 2022 at 12:17)</a>:</h4>
<p>Either way: on a 2x2 matrix, there are <code>5352</code> failures to find <code>division_ring a</code>, whereas on the PR there are <code>139127</code> failures to find the same</p>



<a name="271966032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271966032" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271966032">(Feb 15 2022 at 12:25)</a>:</h4>
<p>I've tried adjusting the priority of <code>has_involutive_inv.to_has_inv</code> to see if it helps</p>



<a name="271966120"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271966120" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271966120">(Feb 15 2022 at 12:26)</a>:</h4>
<p>Removing <code>group.to_has_inv</code> and <code>group_with_zero.to_has_inv</code> instead might also help</p>



<a name="271966811"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/271966811" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#271966811">(Feb 15 2022 at 12:32)</a>:</h4>
<p>I agree that simp isn't the best tool for proving this lemma. But it's a good canary in the coal mine -- a first time user of mathlib might reach for simp to prove this, and it'd be unfortunate if it couldn't.</p>



<a name="272030445"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/272030445" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#272030445">(Feb 15 2022 at 20:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends/near/271966032">said</a>:</p>
<blockquote>
<p>I've tried adjusting the priority of <code>has_involutive_inv.to_has_inv</code> to see if it helps</p>
</blockquote>
<p>This seems to have solved the problem</p>



<a name="272091519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%2311960%20has_involutive_neg%20and%20friends/near/272091519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.2311960.20has_involutive_neg.20and.20friends.html#272091519">(Feb 16 2022 at 09:29)</a>:</h4>
<p>When I was a first time user of mathlib I'd reach for <code>simp</code> to solve <em>everything</em></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>