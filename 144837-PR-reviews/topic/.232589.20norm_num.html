---
layout: archive
title: Zulip Chat Archive
permalink: /stream/144837-PR-reviews/topic/.232589.20norm_num.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/index.html">PR reviews</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html">#2589 norm_num</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="196054075"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196054075" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196054075">(May 02 2020 at 14:24)</a>:</h4>
<p>This sets up the basics of the new <code>norm_num</code>. It passes the basic tests, but I haven't benchmarked it yet.</p>



<a name="196056270"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196056270" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196056270">(May 02 2020 at 15:20)</a>:</h4>
<p>Thanks :-)</p>



<a name="196104973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196104973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196104973">(May 03 2020 at 14:07)</a>:</h4>
<p>So I've been benchmarking <code>norm_num</code> on Floris's solution to the pi approximation problem, and the results are... not good. I'm not running both versions side by side, but <code>pi_gt_31415</code> was remarked to run for 9 seconds, and now it takes 34 seconds. Many of the other scripts time out, and I'm still trying to figure out how to test them correctly in case something is going wrong.</p>
<p>The question now is what to do about it. Should we move forward with it anyway? Most problems are not bottlenecked on large arithmetic. Alternatively, we could scope down the C++ <code>tactic.norm_num</code> to only include the "hot path" theorems on addition and multiplication of natural numbers and leave everything else for the mathlib version. Thoughts?</p>



<a name="196105056"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105056" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105056">(May 03 2020 at 14:10)</a>:</h4>
<p>That's much less bad than what I would have expected, just 3x slowdown.</p>



<a name="196105126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105126">(May 03 2020 at 14:11)</a>:</h4>
<p>there are some minor algorithmic improvements over the C++ version, I'm not sure how much of that is showing</p>



<a name="196105128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105128" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105128">(May 03 2020 at 14:11)</a>:</h4>
<p>Note that we need to keep some functions like <code>mk_nat_val_ne_proof</code> anyhow for the equation compiler.  We can add functions for addition there as well.</p>



<a name="196105190"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105190" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105190">(May 03 2020 at 14:12)</a>:</h4>
<p>I'm also wondering whether it would be worthwhile to try Karatsuba multiplication. It would be nice to do an analysis on the cutoff where it becomes worthwhile in terms of proof length</p>



<a name="196105191"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105191" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105191">(May 03 2020 at 14:12)</a>:</h4>
<p>Personally, I would say go for it.  We have more to gain by moving the algebraic hierarchy from core to mathlib than the slight performance loss here.  If somebody wants to do serious computation, they can probably wait a few months.</p>



<a name="196105204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105204">(May 03 2020 at 14:13)</a>:</h4>
<blockquote>
<p>Karatsuba multiplication</p>
</blockquote>
<p>Just how large are the numbers we are talking about here?</p>



<a name="196105208"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105208" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105208">(May 03 2020 at 14:13)</a>:</h4>
<p>probably up to 10^10</p>



<a name="196105252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105252" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105252">(May 03 2020 at 14:14)</a>:</h4>
<p>this is tiny by computer standards, but everything is more expensive when each bit costs a theorem application</p>



<a name="196105269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105269" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105269">(May 03 2020 at 14:14)</a>:</h4>
<p>Oh, so just 30 bits?  And that takes half a minute?</p>



<a name="196105287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105287">(May 03 2020 at 14:14)</a>:</h4>
<p>something like <code>2 + 11482 / 8119 ≤ (5401 / 2923) ^ 2</code> takes about 3 seconds</p>



<a name="196105345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105345">(May 03 2020 at 14:16)</a>:</h4>
<p>that's a lie, let me get a real example</p>



<a name="196105356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105356">(May 03 2020 at 14:16)</a>:</h4>
<p>The old <code>norm_num.derive</code> takes 50ms on that "example".</p>



<a name="196105412"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105412" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105412">(May 03 2020 at 14:18)</a>:</h4>
<p>actually it's more like 6 seconds in situ, but almost instant (19ms) on its own. Hm...</p>



<a name="196105421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105421">(May 03 2020 at 14:18)</a>:</h4>
<p>And the new one takes 26ms.</p>



<a name="196105425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105425" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105425">(May 03 2020 at 14:19)</a>:</h4>
<p>That's a 2x speed-up?</p>



<a name="196105431"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105431" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105431">(May 03 2020 at 14:19)</a>:</h4>
<p>benchmarking lean is so hard</p>



<a name="196105432"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105432" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105432">(May 03 2020 at 14:19)</a>:</h4>
<p>Both tactics spend most of the time in the simplifier.</p>



<a name="196105479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105479">(May 03 2020 at 14:20)</a>:</h4>
<p>And not just in the simplifier, <em>creating the damn simp set</em> takes most of the runtime, a few hundred milliseconds.</p>



<a name="196105481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105481" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105481">(May 03 2020 at 14:20)</a>:</h4>
<p>ffs</p>



<a name="196105497"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105497" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105497">(May 03 2020 at 14:21)</a>:</h4>
<p>Does <code>norm_num1</code> have the same behavior?</p>



<a name="196105501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105501">(May 03 2020 at 14:21)</a>:</h4>
<p>I believe it uses an empty simp set</p>



<a name="196105543"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105543" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105543">(May 03 2020 at 14:22)</a>:</h4>
<p>Old and new <code>norm_num1</code> both take 50ms in total.</p>



<a name="196105547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105547">(May 03 2020 at 14:22)</a>:</h4>
<p>well, if it's 50ms I'm not worried. 3 seconds is the problem</p>



<a name="196105556"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105556" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105556">(May 03 2020 at 14:23)</a>:</h4>
<p>Ok, do you have some other small examples where the performance is very different?</p>



<a name="196105620"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105620" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105620">(May 03 2020 at 14:24)</a>:</h4>
<p>Here is the example I'm playing with:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">real</span><span class="bp">.</span><span class="n">pi</span>

<span class="kn">set_option</span> <span class="n">profiler</span> <span class="n">true</span>

<span class="kn">namespace</span> <span class="n">real</span>

<span class="kn">lemma</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">{</span><span class="n">x</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">(</span><span class="n">hz</span> <span class="o">:</span> <span class="n">sqrt_two_add_series</span> <span class="n">y</span> <span class="n">n</span> <span class="bp">≤</span> <span class="n">z</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">+</span> <span class="n">x</span> <span class="bp">≤</span> <span class="n">y</span> <span class="bp">^</span> <span class="mi">2</span><span class="o">)</span> <span class="o">(</span><span class="n">h2</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">≤</span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span> <span class="n">sqrt_two_add_series</span> <span class="n">x</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="bp">≤</span> <span class="n">z</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="n">le_trans</span> <span class="bp">_</span> <span class="n">hz</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">sqrt_two_add_series_succ</span><span class="o">],</span> <span class="n">apply</span> <span class="n">sqrt_two_add_series_monotone_left</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">sqrt_le_left</span><span class="o">],</span> <span class="n">exact</span> <span class="n">h</span><span class="o">,</span> <span class="n">exact</span> <span class="n">h2</span>
<span class="kn">end</span>

<span class="kn">lemma</span> <span class="n">sqrt_two_add_series_step_down&#39;</span> <span class="o">{</span><span class="n">x</span> <span class="n">z</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">}</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="o">(</span><span class="n">hz</span> <span class="o">:</span> <span class="n">z</span> <span class="bp">≤</span> <span class="n">sqrt_two_add_series</span> <span class="n">y</span> <span class="n">n</span><span class="o">)</span>
  <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">y</span> <span class="bp">^</span> <span class="mi">2</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">+</span> <span class="n">x</span><span class="o">)</span> <span class="o">:</span> <span class="n">z</span> <span class="bp">≤</span> <span class="n">sqrt_two_add_series</span> <span class="n">x</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">le_trans</span> <span class="n">hz</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">sqrt_two_add_series_succ</span><span class="o">],</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_monotone_left</span><span class="o">,</span> <span class="n">exact</span> <span class="n">le_sqrt_of_sqr_le</span> <span class="n">h</span>
<span class="kn">end</span>

<span class="c">/-</span><span class="cm"> currently we use the &quot;slow&quot; certificates (using real computation instead of nat computation),</span>
<span class="cm">  because the certificates for nat raise errors during type-checking -/</span>

<span class="c1">-- the following lemma takes about 9 seconds</span>
<span class="kn">lemma</span> <span class="n">pi_gt_31415</span> <span class="o">:</span> <span class="n">pi</span> <span class="bp">&gt;</span> <span class="mi">3</span><span class="bp">.</span><span class="mi">1415</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="n">lt_of_le_of_lt</span> <span class="bp">_</span> <span class="o">(</span><span class="n">pi_gt_sqrt_two_add_series</span> <span class="mi">6</span><span class="o">),</span> <span class="n">rw</span> <span class="o">[</span><span class="n">mul_comm</span><span class="o">],</span>
  <span class="n">apply</span> <span class="n">le_mul_of_div_le</span><span class="o">,</span> <span class="n">norm_num</span><span class="o">,</span> <span class="n">apply</span> <span class="n">le_sqrt_of_sqr_le</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">le_sub</span><span class="o">],</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">11482</span><span class="bp">/</span><span class="mi">8119</span><span class="o">),</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">5401</span><span class="bp">/</span><span class="mi">2923</span><span class="o">),</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">2348</span><span class="bp">/</span><span class="mi">1197</span><span class="o">),</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">11367</span><span class="bp">/</span><span class="mi">5711</span><span class="o">),</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">25705</span><span class="bp">/</span><span class="mi">12868</span><span class="o">),</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">23235</span><span class="bp">/</span><span class="mi">11621</span><span class="o">),</span>
  <span class="n">rw</span> <span class="n">sqrt_two_add_series</span><span class="o">,</span>
  <span class="n">all_goals</span> <span class="o">{</span><span class="n">tactic</span><span class="bp">.</span><span class="n">timetac</span> <span class="s2">&quot;norm_num&quot;</span> <span class="bp">`</span><span class="o">[</span><span class="n">norm_num1</span><span class="o">]},</span>
<span class="kn">end</span>
</code></pre></div>



<a name="196105621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105621">(May 03 2020 at 14:24)</a>:</h4>
<p>For example, this takes 330ms (of which 300ms are spent on <code>mk_app</code>...):</p>
<div class="codehilite"><pre><span></span><code><span class="kn">example</span> <span class="o">:</span> <span class="mi">999999999</span><span class="bp">*</span><span class="mi">9999999999</span> <span class="bp">=</span> <span class="mi">9999999999999999</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">norm_num1</span>
</code></pre></div>



<a name="196105635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105635">(May 03 2020 at 14:25)</a>:</h4>
<p>I include the full context because it seems to be playing a role in the runtime (unfortunately...)</p>



<a name="196105640"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105640" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105640">(May 03 2020 at 14:25)</a>:</h4>
<p>Your example doesn't build at the moment (specific_limits is broken atm).</p>



<a name="196105681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105681" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105681">(May 03 2020 at 14:26)</a>:</h4>
<p>fixed</p>



<a name="196105760"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105760" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105760">(May 03 2020 at 14:28)</a>:</h4>
<p>/me is compiling half of mathlib <span aria-label="coffee" class="emoji emoji-2615" role="img" title="coffee">:coffee:</span></p>



<a name="196105810"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105810" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105810">(May 03 2020 at 14:30)</a>:</h4>
<p>This requires slightly less than half of mathlib and is also quite slow:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">example</span> <span class="o">:</span>
  <span class="o">(</span><span class="mi">23235</span> <span class="bp">/</span> <span class="mi">11621</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">2</span> <span class="bp">-</span> <span class="o">(</span><span class="mi">6283</span> <span class="bp">/</span> <span class="mi">2000</span> <span class="bp">/</span> <span class="mi">2</span> <span class="bp">^</span> <span class="o">(</span><span class="mi">6</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="bp">^</span> <span class="mi">2</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">2</span> <span class="bp">+</span> <span class="mi">25705</span> <span class="bp">/</span> <span class="mi">12868</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="o">(</span><span class="mi">23235</span> <span class="bp">/</span> <span class="mi">11621</span><span class="o">)</span> <span class="bp">^</span> <span class="mi">2</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">23235</span> <span class="bp">/</span> <span class="mi">11621</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">2</span> <span class="bp">+</span> <span class="mi">11367</span> <span class="bp">/</span> <span class="mi">5711</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="o">(</span><span class="mi">25705</span> <span class="bp">/</span> <span class="mi">12868</span><span class="o">)</span> <span class="bp">^</span> <span class="mi">2</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">25705</span> <span class="bp">/</span> <span class="mi">12868</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">2</span> <span class="bp">+</span> <span class="mi">2348</span> <span class="bp">/</span> <span class="mi">1197</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="o">(</span><span class="mi">11367</span> <span class="bp">/</span> <span class="mi">5711</span><span class="o">)</span> <span class="bp">^</span> <span class="mi">2</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">11367</span> <span class="bp">/</span> <span class="mi">5711</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">2</span> <span class="bp">+</span> <span class="mi">5401</span> <span class="bp">/</span> <span class="mi">2923</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="o">(</span><span class="mi">2348</span> <span class="bp">/</span> <span class="mi">1197</span><span class="o">)</span> <span class="bp">^</span> <span class="mi">2</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">2348</span> <span class="bp">/</span> <span class="mi">1197</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">2</span> <span class="bp">+</span> <span class="mi">11482</span> <span class="bp">/</span> <span class="mi">8119</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="o">(</span><span class="mi">5401</span> <span class="bp">/</span> <span class="mi">2923</span><span class="o">)</span> <span class="bp">^</span> <span class="mi">2</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">5401</span> <span class="bp">/</span> <span class="mi">2923</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">2</span> <span class="bp">+</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="o">(</span><span class="mi">11482</span> <span class="bp">/</span> <span class="mi">8119</span><span class="o">)</span> <span class="bp">^</span> <span class="mi">2</span> <span class="bp">∧</span>
  <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">ℝ</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">11482</span> <span class="bp">/</span> <span class="mi">8119</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">norm_num</span>
</code></pre></div>



<a name="196105821"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105821" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105821">(May 03 2020 at 14:30)</a>:</h4>
<p>36 seconds</p>



<a name="196105892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105892" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105892">(May 03 2020 at 14:32)</a>:</h4>
<p>and if I replace <code>real</code> with <code>A</code> then it takes 11ms <span aria-label="cry" class="emoji emoji-1f622" role="img" title="cry">:cry:</span></p>



<a name="196105904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105904">(May 03 2020 at 14:33)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="mi">13240</span><span class="n">ms</span>    <span class="mi">93</span><span class="bp">.</span><span class="mi">7</span><span class="err">%</span>   <span class="n">tactic</span><span class="bp">.</span><span class="n">mk_app</span>
</code></pre></div>


<p><span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span></p>



<a name="196105959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105959" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105959">(May 03 2020 at 14:34)</a>:</h4>
<p>HOW?? It's like a zombie that refuses to die</p>



<a name="196105986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105986">(May 03 2020 at 14:34)</a>:</h4>
<p>Your last example takes 1.27s on my crappy laptop, what are your imports?</p>



<a name="196105995"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105995" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105995">(May 03 2020 at 14:35)</a>:</h4>
<p>same as before, <code>data.real.pi</code></p>



<a name="196105997"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196105997" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196105997">(May 03 2020 at 14:35)</a>:</h4>
<p>i.e. everything</p>



<a name="196106037"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196106037" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196106037">(May 03 2020 at 14:36)</a>:</h4>
<p>With only <code>data.real.basic</code> imported, it's 10x faster. <span aria-label="sunglasses" class="emoji emoji-1f60e" role="img" title="sunglasses">:sunglasses:</span></p>



<a name="196106050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196106050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196106050">(May 03 2020 at 14:36)</a>:</h4>
<p>Of course this is to be expected, given the difference between <code>real</code> and <code>A</code> it's obviously type class inference taking up the time, and so more mathlib = more pain</p>



<a name="196106065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196106065" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196106065">(May 03 2020 at 14:37)</a>:</h4>
<p>Interesting: with <code>data.real.pi</code> I get <code>12961ms    84.1%   tactic.mk_app</code>, but with <code>data.real.basic</code> it's much better: <code>425ms    34.3%   tactic.mk_app</code></p>



<a name="196106198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196106198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196106198">(May 03 2020 at 14:41)</a>:</h4>
<p>I'm wondering how I could identify which calls to <code>mk_app</code> are taking up the time. If I made <code>def mk_app' := mk_app</code> and then replace all calls to <code>mk_app</code> to <code>mk_app'</code>, I hope it will show up in the profiler</p>



<a name="196106247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196106247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196106247">(May 03 2020 at 14:42)</a>:</h4>
<p>Did you know that <code>expr.of_nat</code> uses <code>mk_app</code>?</p>
<div class="codehilite"><pre><span></span><code><span class="mi">13804</span><span class="n">ms</span>    <span class="mi">87</span><span class="bp">.</span><span class="mi">9</span><span class="err">%</span>   <span class="n">expr</span><span class="bp">.</span><span class="n">of_nat</span><span class="bp">._</span><span class="n">lambda_1</span>
</code></pre></div>



<a name="196106249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196106249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196106249">(May 03 2020 at 14:42)</a>:</h4>
<p>ugh, yes</p>



<a name="196106259"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196106259" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196106259">(May 03 2020 at 14:42)</a>:</h4>
<p>it shouldn't be hard to make a <code>instance_cache</code> version of <code>expr.of_nat</code></p>



<a name="196106261"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196106261" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196106261">(May 03 2020 at 14:43)</a>:</h4>
<p>I'll try that</p>



<a name="196140831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196140831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196140831">(May 04 2020 at 05:18)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Thanks a lot for diving in to this!</p>



<a name="196213743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196213743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196213743">(May 04 2020 at 17:32)</a>:</h4>
<p>What is the status of this PR? Do you need help with fixing mathlib? Or is the main concern the slowdown?</p>



<a name="196213831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196213831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196213831">(May 04 2020 at 17:32)</a>:</h4>
<p>Is this one of those tactics that could have a <code>norm_num?</code> version that outputs a reasonably short certificate that is faster to check than regenerating the proof?</p>



<a name="196306650"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196306650" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196306650">(May 05 2020 at 13:23)</a>:</h4>
<p>I'm now going to benchmark how long it takes to build this PR with <code>lean-3.10.0</code>.</p>



<a name="196314145"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196314145" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196314145">(May 05 2020 at 14:21)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="nb">time</span> nice leanpkg build <span class="c1">### building the norm_num branch</span>
real    43m2.154s
user    531m57.718s
sys     7m33.007s
</code></pre></div>



<a name="196314243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196314243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196314243">(May 05 2020 at 14:22)</a>:</h4>
<p>Seems to be a speedup (-;</p>



<a name="196314986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196314986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196314986">(May 05 2020 at 14:27)</a>:</h4>
<p>This is great, the expected slowdowns are speedups and expected speedups are slowdowns</p>



<a name="196317389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196317389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196317389">(May 05 2020 at 14:43)</a>:</h4>
<p>In maths when the unexpected happens it usually means that you're about to learn something interesting</p>



<a name="196727728"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/196727728" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#196727728">(May 07 2020 at 05:09)</a>:</h4>
<p>Is the speedup exciting enough to get <code>norm_num</code> out of core in the next release?</p>



<a name="197006333"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/197006333" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#197006333">(May 09 2020 at 18:50)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- the following lemma takes about 9 seconds</span>
<span class="kn">lemma</span> <span class="n">pi_gt_31415</span> <span class="o">:</span> <span class="n">pi</span> <span class="bp">&gt;</span> <span class="mi">3</span><span class="bp">.</span><span class="mi">1415</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="n">lt_of_le_of_lt</span> <span class="bp">_</span> <span class="o">(</span><span class="n">pi_gt_sqrt_two_add_series</span> <span class="mi">6</span><span class="o">),</span> <span class="n">rw</span> <span class="o">[</span><span class="n">mul_comm</span><span class="o">],</span>
  <span class="n">apply</span> <span class="n">le_mul_of_div_le</span><span class="o">,</span> <span class="n">norm_num</span><span class="o">,</span> <span class="n">apply</span> <span class="n">le_sqrt_of_sqr_le</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">le_sub</span><span class="o">],</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">11482</span><span class="bp">/</span><span class="mi">8119</span><span class="o">),</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">5401</span><span class="bp">/</span><span class="mi">2923</span><span class="o">),</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">2348</span><span class="bp">/</span><span class="mi">1197</span><span class="o">),</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">11367</span><span class="bp">/</span><span class="mi">5711</span><span class="o">),</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">25705</span><span class="bp">/</span><span class="mi">12868</span><span class="o">),</span>
  <span class="n">apply</span> <span class="n">sqrt_two_add_series_step_up&#39;</span> <span class="o">(</span><span class="mi">23235</span><span class="bp">/</span><span class="mi">11621</span><span class="o">),</span>
  <span class="n">rw</span> <span class="n">sqrt_two_add_series</span><span class="o">,</span>
  <span class="n">all_goals</span> <span class="o">{</span><span class="n">norm_num</span><span class="o">}</span>
<span class="kn">end</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="n">parsing</span> <span class="n">took</span> <span class="mi">65</span><span class="bp">.</span><span class="mi">4</span><span class="n">ms</span>
<span class="n">type</span> <span class="n">checking</span> <span class="n">of</span> <span class="n">pi_gt_31415</span> <span class="n">took</span> <span class="mi">0</span><span class="bp">.</span><span class="mi">151</span><span class="n">ms</span>
<span class="n">decl</span> <span class="n">post</span><span class="bp">-</span><span class="n">processing</span> <span class="n">of</span> <span class="n">pi_gt_31415</span> <span class="n">took</span> <span class="mi">0</span><span class="bp">.</span><span class="mi">00408</span><span class="n">ms</span>
<span class="n">elaboration</span> <span class="n">of</span> <span class="n">pi_gt_31415</span> <span class="n">took</span> <span class="mi">1</span><span class="bp">.</span><span class="mi">14</span><span class="n">s</span>
</code></pre></div>


<p>From 9 seconds to 1.14 with the new <code>norm_num</code>!</p>



<a name="197006408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/197006408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#197006408">(May 09 2020 at 18:53)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- the following lemma took about 15 seconds</span>
<span class="kn">lemma</span> <span class="n">pi_gt_3141592</span> <span class="o">:</span> <span class="n">pi</span> <span class="bp">&gt;</span> <span class="mi">3</span><span class="bp">.</span><span class="mi">141592</span>  <span class="o">:=</span> <span class="bp">...</span>
<span class="c1">-- elaboration of pi_gt_3141592 took 3.17s</span>

<span class="c1">-- the following lemma took about 19 seconds</span>
<span class="kn">lemma</span> <span class="n">pi_lt_3141593</span> <span class="o">:</span> <span class="n">pi</span> <span class="bp">&lt;</span> <span class="mi">3</span><span class="bp">.</span><span class="mi">141593</span> <span class="o">:=</span> <span class="bp">...</span>
<span class="c1">-- elaboration of pi_lt_3141593 took 3.52s</span>
</code></pre></div>



<a name="197006842"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/197006842" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#197006842">(May 09 2020 at 19:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/144837-PR-reviews/topic/.232589.20norm_num/near/196213831" title="#narrow/stream/144837-PR-reviews/topic/.232589.20norm_num/near/196213831">said</a>:</p>
<blockquote>
<p>Is this one of those tactics that could have a <code>norm_num?</code> version that outputs a reasonably short certificate that is faster to check than regenerating the proof?</p>
</blockquote>
<p>Not particularly. If you know a way to prove correctness of multiplication faster than evaluating it, I'd like to know (I think this is still an open problem). For non-primality there are efficient certificates, of course, but <code>norm_num</code> already generates short proofs when it can (on the assumption that the corresponding VM functions are fast enough that their contribution is negligible). The only case where this is probably not true is in non-primality of large numbers, since the VM does the search for a factor using trial division, which is not good for large numbers.</p>



<a name="197006856"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/197006856" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#197006856">(May 09 2020 at 19:05)</a>:</h4>
<p>There are also short certificates for prime numbers but they are complicated and don't really pay off until you get really large</p>



<a name="197006920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/197006920" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#197006920">(May 09 2020 at 19:06)</a>:</h4>
<p>I guess it is time to move these statements about the digits of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span></span></span></span> to mathlib, then! (They used to be in a gist as they were too slow for mathlib, right?)</p>



<a name="197006922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/197006922" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#197006922">(May 09 2020 at 19:06)</a>:</h4>
<p>right</p>



<a name="197010805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/197010805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#197010805">(May 09 2020 at 20:20)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/2641" title="https://github.com/leanprover-community/mathlib/issues/2641">#2641</a></p>



<a name="197012555"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/197012555" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#197012555">(May 09 2020 at 20:59)</a>:</h4>
<p>I'm really excited that this PR is now on the merge queue!</p>



<a name="197012614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/144837-PR%20reviews/topic/%232589%20norm_num/near/197012614" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/144837-PR-reviews/topic/.232589.20norm_num.html#197012614">(May 09 2020 at 21:00)</a>:</h4>
<p>Once it's merged we can have a big PR moving lots of algebra out of core and into mathlib</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>