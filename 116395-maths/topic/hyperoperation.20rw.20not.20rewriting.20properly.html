---
layout: archive
title: Zulip Chat Archive
permalink: /stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/116395-maths/index.html">maths</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html">hyperoperation rw not rewriting properly</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="320276938"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320276938" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mark Andrew Gerads <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320276938">(Jan 09 2023 at 17:01)</a>:</h4>
<p>Can anyone tell me why the commented <code>rw</code> is not rewriting, and what work-around there might be?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.group_with_zero.defs</span>

<span class="kd">def</span> <span class="n">hyperoperation</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="n">_</span> <span class="n">b</span> <span class="o">:=</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">b</span>
<span class="bp">|</span> <span class="mi">1</span> <span class="n">a</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">a</span>
<span class="bp">|</span> <span class="mi">2</span> <span class="n">_</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="bp">|</span> <span class="n">_</span> <span class="n">_</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="n">hyperoperation</span> <span class="n">n</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_1_addition</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">1</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">induction</span> <span class="n">b</span> <span class="k">with</span> <span class="n">bn</span> <span class="n">bih</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">nat_add_zero</span> <span class="n">a</span><span class="o">,</span> <span class="n">hyperoperation</span><span class="o">],</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">h1</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">=</span> <span class="mi">1</span><span class="o">,</span>
    <span class="n">exact</span> <span class="n">rfl</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">h1</span><span class="o">,</span><span class="n">bih</span><span class="o">],</span>
    <span class="c1">-- rw hyperoperation, --should work; does not work</span>
    <span class="gr">sorry</span><span class="o">,</span>
  <span class="o">},</span>
<span class="kd">end</span>
</code></pre></div>



<a name="320280167"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320280167" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex J. Best <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320280167">(Jan 09 2023 at 17:14)</a>:</h4>
<p>I guess the issue is somehow caused by having all these overlapping patterns, maybe lean gives up generating all the equation lemmas or something:<br>
If I change your definition like this I think it means the same thing and lean is now happy to rewrite, but of course you should make sure the function still does what you intend</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.group_with_zero.defs</span>

<span class="kd">def</span> <span class="n">hyperoperation</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="n">_</span> <span class="n">b</span> <span class="o">:=</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">b</span>
<span class="bp">|</span> <span class="mi">1</span> <span class="n">a</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">a</span>
<span class="bp">|</span> <span class="mi">2</span> <span class="n">_</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">a</span> <span class="bp">+</span> <span class="mi">3</span><span class="o">)</span> <span class="n">_</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="n">hyperoperation</span> <span class="n">n</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_1_addition</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">1</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">induction</span> <span class="n">b</span> <span class="k">with</span> <span class="n">bn</span> <span class="n">bih</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">nat_add_zero</span> <span class="n">a</span><span class="o">,</span> <span class="n">hyperoperation</span><span class="o">],</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">h1</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">=</span> <span class="mi">1</span><span class="o">,</span>
    <span class="n">exact</span> <span class="n">rfl</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">h1</span><span class="o">,</span><span class="n">bih</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">hyperoperation</span><span class="o">],</span>
  <span class="o">},</span>
<span class="kd">end</span>
</code></pre></div>



<a name="320285587"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320285587" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320285587">(Jan 09 2023 at 17:40)</a>:</h4>
<p>You can have a look at the rewrite rules it generated with <code>#print prefix hyperoperation</code></p>



<a name="320295266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320295266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mark Andrew Gerads <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320295266">(Jan 09 2023 at 18:25)</a>:</h4>
<p>I found another case where it does not rewrite correctly.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.group_with_zero.defs</span>
<span class="kn">import</span> <span class="n">tactic</span>

<span class="kd">def</span> <span class="n">hyperoperation</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="n">_</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="mi">1</span> <span class="n">a</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">a</span>
<span class="bp">|</span> <span class="mi">2</span> <span class="n">_</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">3</span><span class="o">)</span> <span class="n">_</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="n">hyperoperation</span> <span class="n">n</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_1_addition</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">1</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">induction</span> <span class="n">b</span> <span class="k">with</span> <span class="n">bn</span> <span class="n">bih</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">nat_add_zero</span> <span class="n">a</span><span class="o">,</span> <span class="n">hyperoperation</span><span class="o">],</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">(</span><span class="k">show</span> <span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">=</span> <span class="mi">1</span><span class="o">,</span> <span class="kd">by</span> <span class="n">refl</span><span class="o">),</span>
    <span class="n">rw</span> <span class="n">bih</span><span class="o">,</span>
    <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">(</span><span class="k">show</span> <span class="n">bn.succ</span> <span class="bp">=</span> <span class="n">bn</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">,</span> <span class="kd">by</span> <span class="n">refl</span><span class="o">),</span>
    <span class="n">exact</span> <span class="n">nat.add_assoc</span> <span class="n">a</span> <span class="n">bn</span> <span class="mi">1</span><span class="o">,</span>
  <span class="o">},</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_2_multiplication</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">2</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">b</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">induction</span> <span class="n">b</span> <span class="k">with</span> <span class="n">bn</span> <span class="n">bih</span><span class="o">,</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
    <span class="n">exact</span> <span class="o">(</span><span class="n">nat.mul_zero</span> <span class="n">a</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
  <span class="o">},</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">hyperoperation</span><span class="o">,</span><span class="n">hyperoperation_1_addition</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">(</span><span class="k">show</span> <span class="mi">1</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">=</span> <span class="mi">2</span><span class="o">,</span> <span class="kd">by</span> <span class="n">refl</span><span class="o">),</span>
    <span class="n">rw</span> <span class="n">bih</span><span class="o">,</span>
    <span class="n">ring</span><span class="o">,</span>
  <span class="o">},</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_succn_2_2_eq_4</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="mi">2</span> <span class="mi">2</span> <span class="bp">=</span> <span class="mi">4</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">induction</span> <span class="n">n</span> <span class="k">with</span> <span class="n">nn</span> <span class="n">nih</span><span class="o">,</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="o">(</span><span class="k">show</span> <span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">=</span> <span class="mi">1</span><span class="o">,</span> <span class="kd">by</span> <span class="n">refl</span><span class="o">),</span>
    <span class="n">rw</span> <span class="n">hyperoperation_1_addition</span><span class="o">,</span>
  <span class="o">},</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="o">(</span><span class="k">show</span> <span class="n">nn.succ</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">=</span> <span class="n">nn</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">,</span> <span class="kd">by</span> <span class="n">refl</span><span class="o">),</span>
    <span class="c1">-- rw hyperoperation, --should work, fails to work</span>
    <span class="gr">sorry</span><span class="o">,</span>
  <span class="o">},</span>
<span class="kd">end</span>
</code></pre></div>



<a name="320326791"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320326791" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320326791">(Jan 09 2023 at 20:40)</a>:</h4>
<p>I would recommend adding an intermediate layer of lemmas, that explicitly state the equation lemmas you are expecting/hoping the equation compiler is going to produce for you, and rewrite via those rather than by <code>hyperoperation</code> directly. That will hopefully be easier to debug and more stable to changes to the definition / moving to Lean 4.</p>



<a name="320357755"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320357755" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mark Andrew Gerads <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320357755">(Jan 10 2023 at 00:30)</a>:</h4>
<p>I added all the intermediate lemmas, yet 1 of them (the one I need) stubbornly resists my attempt to unsorry it.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">algebra.group_with_zero.defs</span>
<span class="kn">import</span> <span class="n">tactic</span>

<span class="kd">def</span> <span class="n">hyperoperation</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="n">_</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="mi">1</span> <span class="n">a</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">a</span>
<span class="bp">|</span> <span class="mi">2</span> <span class="n">_</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">3</span><span class="o">)</span> <span class="n">_</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="n">hyperoperation</span> <span class="n">n</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="c1">-- Basic hyperoperation lemmas</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_0ab_b.succ</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">0</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_1a0_a</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">1</span> <span class="n">a</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">a</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_2a0_0</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">2</span> <span class="n">a</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_n3a0_1</span> <span class="o">(</span><span class="n">n</span> <span class="n">a</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">3</span><span class="o">)</span> <span class="n">a</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_n1ab1_recurse</span> <span class="o">(</span><span class="n">n</span> <span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">=</span> <span class="n">hyperoperation</span> <span class="n">n</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="c1">-- rw hyperoperation, -- does not work; should work</span>
  <span class="gr">sorry</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="320362033"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320362033" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320362033">(Jan 10 2023 at 01:13)</a>:</h4>
<p>You simply need to do some <code>cases</code>; since <code>(n+1)</code> overlaps with other cases where <code>n = 1</code> or <code>2</code>, Lean breaks equations into multiple cases, which you can see using <code>#print prefix hyperoperation</code>.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">lemma</span> <span class="n">hyperoperation_n1ab1_recurse</span> <span class="o">(</span><span class="n">n</span> <span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">=</span> <span class="n">hyperoperation</span> <span class="n">n</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">cases</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
  <span class="n">cases</span> <span class="n">n</span><span class="bp">;</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
<span class="kd">end</span>
</code></pre></div>



<a name="320362220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320362220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320362220">(Jan 10 2023 at 01:16)</a>:</h4>
<p>The relevant ones used in the above proof are</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">hyperoperation.equations._eqn_3</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">),</span> <span class="n">hyperoperation</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">=</span> <span class="n">hyperoperation</span> <span class="mi">0</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>
<span class="n">hyperoperation.equations._eqn_5</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">),</span> <span class="n">hyperoperation</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">=</span> <span class="n">hyperoperation</span> <span class="mi">1</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>
<span class="n">hyperoperation.equations._eqn_7</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">n</span> <span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">),</span>
  <span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n.succ.succ</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">=</span> <span class="n">hyperoperation</span> <span class="n">n.succ.succ</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n.succ.succ</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>
</code></pre></div>



<a name="320365656"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320365656" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mark Andrew Gerads <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320365656">(Jan 10 2023 at 01:58)</a>:</h4>
<p>Okay, thank you. I think I have all the interesting hyperoperation lemmas now.<br>
Any help or advice on getting it added to mathlib would be appreciated. I do not know what would be the best place to add the file (maybe data.nat.hyperoperation ?), for example, and I am unsure how to make the branch for the pull request. Also, I do not know if my lemma names are good enough.<br>
Here is the completed hyperoperation file:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">tactic</span>

<span class="kd">def</span> <span class="n">hyperoperation</span> <span class="o">:</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span> <span class="bp">→</span> <span class="n">ℕ</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="n">_</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="mi">1</span> <span class="n">a</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">a</span>
<span class="bp">|</span> <span class="mi">2</span> <span class="n">_</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">3</span><span class="o">)</span> <span class="n">_</span> <span class="mi">0</span> <span class="o">:=</span> <span class="mi">1</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="n">hyperoperation</span> <span class="n">n</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="c1">-- Basic hyperoperation lemmas</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_0ab_b.succ</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">0</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_1a0_a</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">1</span> <span class="n">a</span> <span class="mi">0</span> <span class="bp">=</span> <span class="n">a</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_2a0_0</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">2</span> <span class="n">a</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_n3a0_1</span> <span class="o">(</span><span class="n">n</span> <span class="n">a</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">3</span><span class="o">)</span> <span class="n">a</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_n1ab1_recurse</span> <span class="o">(</span><span class="n">n</span> <span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">=</span> <span class="n">hyperoperation</span> <span class="n">n</span> <span class="n">a</span> <span class="o">(</span><span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">cases</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
  <span class="n">cases</span> <span class="n">n</span><span class="bp">;</span>
  <span class="n">rw</span> <span class="n">hyperoperation</span><span class="o">,</span>
<span class="kd">end</span>

<span class="c1">-- Interesting hyperoperation lemmas</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_1_addition</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">1</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">b</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">induction</span> <span class="n">b</span> <span class="k">with</span> <span class="n">bn</span> <span class="n">bih</span><span class="o">,</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">nat_add_zero</span> <span class="n">a</span><span class="o">,</span> <span class="n">hyperoperation_1a0_a</span><span class="o">],</span>
  <span class="o">},</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">hyperoperation_n1ab1_recurse</span><span class="o">,</span><span class="n">bih</span><span class="o">,</span><span class="n">hyperoperation_0ab_b.succ</span><span class="o">],</span>
    <span class="n">exact</span> <span class="n">nat.add_assoc</span> <span class="n">a</span> <span class="n">bn</span> <span class="mi">1</span><span class="o">,</span>
  <span class="o">},</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_2_multiplication</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">2</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">b</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">induction</span> <span class="n">b</span> <span class="k">with</span> <span class="n">bn</span> <span class="n">bih</span><span class="o">,</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="n">hyperoperation_2a0_0</span><span class="o">,</span>
    <span class="n">exact</span> <span class="o">(</span><span class="n">nat.mul_zero</span> <span class="n">a</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
  <span class="o">},</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">hyperoperation_n1ab1_recurse</span><span class="o">,</span><span class="n">hyperoperation_1_addition</span><span class="o">,</span><span class="n">bih</span><span class="o">],</span>
    <span class="n">ring</span><span class="o">,</span>
  <span class="o">},</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_3_exponentiation</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="mi">3</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">^</span> <span class="n">b</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">induction</span> <span class="n">b</span> <span class="k">with</span> <span class="n">bn</span> <span class="n">bih</span><span class="o">,</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="n">hyperoperation_n3a0_1</span><span class="o">,</span>
    <span class="n">exact</span> <span class="o">(</span><span class="n">pow_zero</span> <span class="n">a</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
  <span class="o">},</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">hyperoperation_n1ab1_recurse</span><span class="o">,</span><span class="n">hyperoperation_2_multiplication</span><span class="o">,</span><span class="n">bih</span><span class="o">],</span>
    <span class="n">exact</span> <span class="o">(</span><span class="n">pow_succ</span> <span class="n">a</span> <span class="n">bn</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span>
  <span class="o">},</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_n2a1_a</span> <span class="o">(</span><span class="n">n</span> <span class="n">a</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">2</span><span class="o">)</span> <span class="n">a</span> <span class="mi">1</span> <span class="bp">=</span> <span class="n">a</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">induction</span> <span class="n">n</span> <span class="k">with</span> <span class="n">nn</span> <span class="n">nih</span><span class="o">,</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="n">hyperoperation_2_multiplication</span><span class="o">,</span>
    <span class="n">ring</span><span class="o">,</span>
  <span class="o">},</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">hyperoperation_n1ab1_recurse</span><span class="o">,</span><span class="n">hyperoperation_n3a0_1</span><span class="o">,</span><span class="n">nih</span><span class="o">],</span>
  <span class="o">},</span>
<span class="kd">end</span>

<span class="kd">lemma</span> <span class="n">hyperoperation_succn_2_2_eq_4</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">hyperoperation</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="mi">2</span> <span class="mi">2</span> <span class="bp">=</span> <span class="mi">4</span> <span class="o">:=</span>
<span class="kd">begin</span>
  <span class="n">induction</span> <span class="n">n</span> <span class="k">with</span> <span class="n">nn</span> <span class="n">nih</span><span class="o">,</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="n">hyperoperation_1_addition</span><span class="o">,</span>
  <span class="o">},</span>
  <span class="o">{</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">hyperoperation_n1ab1_recurse</span><span class="o">,</span><span class="n">hyperoperation_n2a1_a</span><span class="o">,</span><span class="n">nih</span><span class="o">],</span>
  <span class="o">},</span>
<span class="kd">end</span>
</code></pre></div>



<a name="320367456"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320367456" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mark Andrew Gerads <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320367456">(Jan 10 2023 at 02:22)</a>:</h4>
<p>After reading <a href="https://leanprover-community.github.io/contribute/style.html">https://leanprover-community.github.io/contribute/style.html</a> , I supposed I should replace a and b with m and k.</p>



<a name="320370415"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320370415" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Junyan Xu <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320370415">(Jan 10 2023 at 03:07)</a>:</h4>
<p>I think the next challenge is to show <code>monotone</code> and <code>strict_mono</code> w.r.t. the three arguments, whenever applicable. And the relationship with the Ackermann function which is already in mathlib as <a href="https://leanprover-community.github.io/mathlib_docs/find/ack">docs#ack</a>. There's also <a href="https://en.wikipedia.org/wiki/Ackermann_function#Definition:_as_m-ary_function">relationship with Knuth's up-arrow</a> and <a href="https://en.wikipedia.org/wiki/Knuth%27s_up-arrow_notation#Generalizations">Conway's chained arrow notation</a>, which however aren't in mathlib yet.  (Personally, I have <a href="https://github.com/alreadydone/fusible/blob/master/computation.pdf">some computation</a> using Knuth's arrows that I may formalize sometime ...)</p>



<a name="320374105"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/hyperoperation%20rw%20not%20rewriting%20properly/near/320374105" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mark Andrew Gerads <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/hyperoperation.20rw.20not.20rewriting.20properly.html#320374105">(Jan 10 2023 at 04:07)</a>:</h4>
<p>PR now awaiting review.<br>
<a href="https://github.com/leanprover-community/mathlib/pull/18116">https://github.com/leanprover-community/mathlib/pull/18116</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>