---
layout: archive
title: Zulip Chat Archive
permalink: /stream/116395-maths/topic/coeff_mul.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/116395-maths/index.html">maths</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html">coeff_mul</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="170428019"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170428019" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170428019">(Jul 09 2019 at 06:42)</a>:</h4>
<p>I have just finished the proof of <code>coeff_mul</code> for `mv_polynomial:<br>
<a href="https://gist.github.com/jcommelin/add8c8df8b3479c435d3f5ac34cdb1f7#file-mv_polynomial_coeff_mul-lean-L189-L298" target="_blank" title="https://gist.github.com/jcommelin/add8c8df8b3479c435d3f5ac34cdb1f7#file-mv_polynomial_coeff_mul-lean-L189-L298">https://gist.github.com/jcommelin/add8c8df8b3479c435d3f5ac34cdb1f7#file-mv_polynomial_coeff_mul-lean-L189-L298</a></p>



<a name="170428029"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170428029" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170428029">(Jul 09 2019 at 06:43)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">coeff_mul</span> <span class="o">(</span><span class="n">φ</span> <span class="n">ψ</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span>
<span class="n">coeff</span> <span class="n">n</span> <span class="o">(</span><span class="n">φ</span> <span class="bp">*</span> <span class="n">ψ</span><span class="o">)</span> <span class="bp">=</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">nat_downset</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">m</span><span class="o">,</span> <span class="n">coeff</span> <span class="n">m</span> <span class="n">φ</span> <span class="bp">*</span> <span class="n">coeff</span> <span class="o">(</span><span class="n">n</span> <span class="bp">-</span> <span class="n">m</span><span class="o">)</span> <span class="n">ψ</span><span class="o">)</span> <span class="o">:=</span>
</pre></div>



<a name="170428038"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170428038" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170428038">(Jul 09 2019 at 06:43)</a>:</h4>
<p>I think this would fill a little gap in the API for polynomials.</p>



<a name="170428087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170428087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170428087">(Jul 09 2019 at 06:44)</a>:</h4>
<p>Question: what should <code>finsupp.nat_downset</code> be called? Does this somehow generalise? Is there something like "partial orders with downsets that are finsets"?</p>



<a name="170428094"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170428094" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170428094">(Jul 09 2019 at 06:44)</a>:</h4>
<p>Also... if people want a golfing challenge... currently the proof is a whopping 120 lines...</p>



<a name="170428168"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170428168" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170428168">(Jul 09 2019 at 06:46)</a>:</h4>
<p>Another option is to <code>sum</code> over a finset in the product, so that we are even closer to mimicking <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mo>∑</mo><mrow><mi>i</mi><mo>+</mo><mi>j</mi><mo>=</mo><mi>n</mi></mrow></msub><msub><mi>c</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>ϕ</mi><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>c</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>ψ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum_{i + j = n} c_i(\phi) \cdot c_j(\psi)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.185818em;vertical-align:-0.43581800000000004em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16195399999999993em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">ϕ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">ψ</span><span class="mclose">)</span></span></span></span>.</p>



<a name="170428841"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170428841" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170428841">(Jul 09 2019 at 07:02)</a>:</h4>
<p>It already exists, it's called <code>multiset.diagonal</code> I think</p>



<a name="170428881"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170428881" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170428881">(Jul 09 2019 at 07:03)</a>:</h4>
<p>(actually that's the subtraction free version - <code>nat_downset</code> is <code>multiset.powerset</code>)</p>



<a name="170428959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170428959" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170428959">(Jul 09 2019 at 07:05)</a>:</h4>
<p>Just like with <code>nat</code>, I recommend avoiding subtraction here and indeed I suggest using a finset over the product as you've indicated</p>



<a name="170429624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170429624" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170429624">(Jul 09 2019 at 07:19)</a>:</h4>
<p>Ok, but <code>multiset X</code> is not defeq to <code>finsupp X nat</code></p>



<a name="170429751"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170429751" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170429751">(Jul 09 2019 at 07:22)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I think <code>multiset.diagonal</code> is very nice. But how should I apply it in the context of <code>mv_polynomial</code>? There is no obvious analogue for arbitrary <code>finsupp</code>s. Should I use glue between <code>multiset X</code> and <code>finsupp X nat</code>?</p>



<a name="170429834"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170429834" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170429834">(Jul 09 2019 at 07:24)</a>:</h4>
<p>The analogue I think is to axiomatize it</p>



<a name="170429857"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170429857" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170429857">(Jul 09 2019 at 07:25)</a>:</h4>
<p>there are other examples, but I don't know a better way to say it than "the set of all elements below x is finite"</p>



<a name="170429936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170429936" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170429936">(Jul 09 2019 at 07:26)</a>:</h4>
<p>In the case of <code>finsupp X nat</code> specifically, I think I would just prove it by transferring from <code>multiset X</code></p>



<a name="170429962"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170429962" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170429962">(Jul 09 2019 at 07:27)</a>:</h4>
<p>I'm still confused about what you would want the <em>statement</em> of <code>coeff_mul</code> to look like...</p>



<a name="170430022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170430022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170430022">(Jul 09 2019 at 07:28)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">coeff_mul</span> <span class="o">(</span><span class="n">φ</span> <span class="n">ψ</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span>
<span class="n">coeff</span> <span class="n">n</span> <span class="o">(</span><span class="n">φ</span> <span class="bp">*</span> <span class="n">ψ</span><span class="o">)</span> <span class="bp">=</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">diagonal</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="n">coeff</span> <span class="n">p</span><span class="bp">.</span><span class="mi">1</span> <span class="n">φ</span> <span class="bp">*</span> <span class="n">coeff</span> <span class="n">p</span><span class="bp">.</span><span class="mi">2</span> <span class="n">ψ</span><span class="o">)</span> <span class="o">:=</span>
</pre></div>



<a name="170430153"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170430153" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170430153">(Jul 09 2019 at 07:30)</a>:</h4>
<p>here <code>finsupp.diagonal n</code> is something like <code>(multiset.diagonal n.support).map (prod.map f f)</code> where <code>f m = \lam x, count x m</code></p>



<a name="170430228"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170430228" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170430228">(Jul 09 2019 at 07:32)</a>:</h4>
<p>and <code>f</code> is then shown to be one half of an order isomorphism, so that <code>mem_diagonal</code> holds also for finsupp</p>



<a name="170430265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170430265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170430265">(Jul 09 2019 at 07:33)</a>:</h4>
<p>Aha... thanks for the suggestions!</p>



<a name="170430334"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170430334" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170430334">(Jul 09 2019 at 07:34)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> It's not a problem that <code>finsupp.diagonal</code> is only defined for <code>ℕ</code>?</p>



<a name="170430368"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170430368" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170430368">(Jul 09 2019 at 07:35)</a>:</h4>
<p>The generalization, like I said, is to have a typeclass for types that have a <code>diagonal</code> function; this is the instance for <code>nat</code></p>



<a name="170430546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170430546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170430546">(Jul 09 2019 at 07:38)</a>:</h4>
<p>Another example of a type with this property (let's say "downward finite") is <code>finsupp X A</code> itself, when A is downward finite</p>



<a name="170430700"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170430700" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170430700">(Jul 09 2019 at 07:41)</a>:</h4>
<blockquote>
<p>Ok, but <code>multiset X</code> is not defeq to <code>finsupp X nat</code></p>
</blockquote>
<p>hey we have a natural isomorphism</p>



<a name="170430821"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170430821" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170430821">(Jul 09 2019 at 07:43)</a>:</h4>
<p>I would have thought you would be the first to point out that it's not constructively provable</p>



<a name="170430933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170430933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170430933">(Jul 09 2019 at 07:45)</a>:</h4>
<p>which direction?</p>



<a name="170431015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170431015" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170431015">(Jul 09 2019 at 07:46)</a>:</h4>
<p>finsupp -&gt; multiset</p>



<a name="170431080"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170431080" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170431080">(Jul 09 2019 at 07:47)</a>:</h4>
<p>but you have the support</p>



<a name="170431163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170431163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170431163">(Jul 09 2019 at 07:48)</a>:</h4>
<p>Oh you're right. As long as X is decidable both directions work</p>



<a name="170431171"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170431171" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170431171">(Jul 09 2019 at 07:48)</a>:</h4>
<p>looks like I need to bring up my special category</p>



<a name="170439996"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170439996" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170439996">(Jul 09 2019 at 10:12)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> </p>
<div class="codehilite"><pre><span></span><span class="c1">-- ⟨s.to_finset, λ x, s.count x, λ x, multiset.mem_to_finset.trans $ multiset.count_pos.symm.trans $ nat.pos_iff_ne_zero⟩</span>
<span class="c1">-- faster but less idiomatic</span>
<span class="n">def</span> <span class="n">Multiset_Finsupp_nat</span> <span class="o">:</span> <span class="n">Multiset</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="err">≅</span> <span class="n">Finsupp_nat</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">hom</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="n">app</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">s</span><span class="o">,</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span><span class="o">,</span>
</pre></div>



<a name="170440002"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170440002" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170440002">(Jul 09 2019 at 10:12)</a>:</h4>
<p>which one would you choose?</p>



<a name="170444077"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170444077" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170444077">(Jul 09 2019 at 11:20)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">multiset</span> <span class="n">data</span><span class="bp">.</span><span class="n">finsupp</span>
<span class="kn">import</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">natural_isomorphism</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">types</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">opposites</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">concrete_category</span>

<span class="kn">universe</span> <span class="n">u</span>

<span class="kn">open</span> <span class="n">category_theory</span>

<span class="kn">namespace</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">instances</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span> <span class="n">def</span> <span class="n">DecEq</span> <span class="o">:=</span> <span class="n">bundled</span> <span class="n">decidable_eq</span>

<span class="kn">instance</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">DecEq</span><span class="o">)</span> <span class="o">:</span> <span class="n">decidable_eq</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">x</span><span class="bp">.</span><span class="n">str</span>

<span class="kn">instance</span> <span class="n">DecEq_category</span> <span class="o">:</span> <span class="n">category</span> <span class="n">DecEq</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">hom</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">x</span> <span class="bp">→</span> <span class="n">y</span><span class="o">,</span>
  <span class="n">id</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span>
  <span class="n">comp</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">g</span> <span class="err">∘</span> <span class="n">f</span> <span class="o">}</span>

<span class="kn">end</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">instances</span>

<span class="kn">open</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">instances</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span> <span class="n">def</span> <span class="n">Multiset</span> <span class="o">:</span> <span class="n">DecEq</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="err">⥤</span> <span class="kt">Type</span> <span class="n">u</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">multiset</span> <span class="n">α</span><span class="o">,</span>
  <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map</span><span class="o">,</span>
  <span class="n">map_id&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">funext</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_id</span><span class="o">,</span>
  <span class="n">map_comp&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">map_map</span> <span class="n">g</span> <span class="n">f</span> <span class="n">s</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span> <span class="o">}</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span> <span class="n">def</span> <span class="n">Finsupp_nat</span> <span class="o">:</span> <span class="n">DecEq</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="err">⥤</span> <span class="kt">Type</span> <span class="n">u</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">α</span> <span class="bp">→</span><span class="err">₀</span> <span class="bp">ℕ</span><span class="o">,</span>
  <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain</span><span class="o">,</span>
  <span class="n">map_id&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_id</span><span class="o">,</span>
  <span class="n">map_comp&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_comp</span> <span class="o">}</span>

<span class="kn">theorem</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_repeat</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">multiset</span><span class="bp">.</span><span class="n">map</span> <span class="n">f</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="n">x</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="n">rfl</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_succ</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_succ</span><span class="o">]</span>

<span class="kn">theorem</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_add</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="n">x</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="n">x</span> <span class="n">m</span> <span class="bp">+</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="n">x</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="o">(</span><span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_zero</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">])</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_succ</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">add_succ</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_succ</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">add_cons</span><span class="o">,</span> <span class="n">ih</span><span class="o">]</span>

<span class="c1">-- ⟨s.to_finset, λ x, s.count x, λ x, multiset.mem_to_finset.trans $ multiset.count_pos.symm.trans $ nat.pos_iff_ne_zero⟩</span>
<span class="c1">-- faster but less idiomatic</span>
<span class="n">def</span> <span class="n">Multiset_Finsupp_nat</span> <span class="o">:</span> <span class="n">Multiset</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="err">≅</span> <span class="n">Finsupp_nat</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">hom</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="n">app</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">s</span><span class="o">,</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span><span class="o">,</span>
    <span class="n">naturality&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span>
      <span class="k">show</span> <span class="o">((</span><span class="n">multiset</span><span class="bp">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">s</span><span class="o">)</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain</span> <span class="n">f</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="n">x</span><span class="o">,</span>
      <span class="k">from</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">s</span> <span class="n">rfl</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">s</span> <span class="n">ih</span><span class="o">,</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">x</span>
      <span class="k">then</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_cons</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">h</span><span class="o">,</span>
          <span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_cons</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_add</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_single</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">h</span><span class="o">,</span> <span class="n">ih</span><span class="o">]</span>
      <span class="k">else</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_cons</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_neg</span> <span class="n">h</span><span class="o">,</span>
          <span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_cons</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_add</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_single</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_neg</span> <span class="n">h</span><span class="o">,</span> <span class="n">ih</span><span class="o">]</span> <span class="o">},</span>
  <span class="n">inv</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="n">app</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">s</span><span class="o">,</span> <span class="n">s</span><span class="bp">.</span><span class="n">sum</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span><span class="o">,</span>
    <span class="n">naturality&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span>
      <span class="k">show</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">map_domain</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="bp">=</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">sum</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span><span class="o">)</span><span class="bp">.</span><span class="n">map</span> <span class="n">f</span><span class="o">,</span>
      <span class="k">from</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">induction</span> <span class="n">s</span> <span class="n">rfl</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">n</span> <span class="n">s</span> <span class="n">hsx</span> <span class="n">hn</span> <span class="n">ih</span><span class="o">,</span> <span class="k">begin</span>
        <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_add</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_add_index</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_single</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span>
            <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_add_index</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_repeat</span><span class="o">,</span> <span class="n">ih</span><span class="o">],</span>
        <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">rw</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_add</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">rw</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_add</span> <span class="o">}</span>
      <span class="kn">end</span> <span class="o">},</span>
  <span class="n">hom_inv_id&#39;</span> <span class="o">:=</span> <span class="n">nat_trans</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="k">by</span> <span class="n">skip</span><span class="o">,</span>
  <span class="n">inv_hom_id&#39;</span> <span class="o">:=</span> <span class="n">nat_trans</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="k">by</span> <span class="n">skip</span> <span class="o">}</span>
</pre></div>



<a name="170444082"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170444082" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170444082">(Jul 09 2019 at 11:20)</a>:</h4>
<p>that's it for now</p>



<a name="170452502"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170452502" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170452502">(Jul 09 2019 at 13:25)</a>:</h4>
<p>I think I was just aware of <code>finsupp.of_multiset</code></p>



<a name="170452978"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170452978" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170452978">(Jul 09 2019 at 13:31)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">multiset</span> <span class="n">data</span><span class="bp">.</span><span class="n">finsupp</span>
<span class="kn">import</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">natural_isomorphism</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">types</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">opposites</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">concrete_category</span>

<span class="kn">universe</span> <span class="n">u</span>

<span class="kn">open</span> <span class="n">category_theory</span>

<span class="kn">namespace</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">instances</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span> <span class="n">def</span> <span class="n">DecEq</span> <span class="o">:=</span> <span class="n">bundled</span> <span class="n">decidable_eq</span>

<span class="kn">instance</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">DecEq</span><span class="o">)</span> <span class="o">:</span> <span class="n">decidable_eq</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">x</span><span class="bp">.</span><span class="n">str</span>

<span class="kn">instance</span> <span class="n">DecEq_category</span> <span class="o">:</span> <span class="n">category</span> <span class="n">DecEq</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">hom</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">x</span> <span class="bp">→</span> <span class="n">y</span><span class="o">,</span>
  <span class="n">id</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span>
  <span class="n">comp</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">g</span> <span class="err">∘</span> <span class="n">f</span> <span class="o">}</span>

<span class="kn">end</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">instances</span>

<span class="kn">open</span> <span class="n">category_theory</span><span class="bp">.</span><span class="n">instances</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span> <span class="n">def</span> <span class="n">Multiset</span> <span class="o">:</span> <span class="n">DecEq</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="err">⥤</span> <span class="kt">Type</span> <span class="n">u</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">multiset</span> <span class="n">α</span><span class="o">,</span>
  <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map</span><span class="o">,</span>
  <span class="n">map_id&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">funext</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_id</span><span class="o">,</span>
  <span class="n">map_comp&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">map_map</span> <span class="n">g</span> <span class="n">f</span> <span class="n">s</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span> <span class="o">}</span>

<span class="bp">@</span><span class="o">[</span><span class="kn">reducible</span><span class="o">]</span> <span class="n">def</span> <span class="n">Finsupp_nat</span> <span class="o">:</span> <span class="n">DecEq</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="err">⥤</span> <span class="kt">Type</span> <span class="n">u</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">obj</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">α</span> <span class="bp">→</span><span class="err">₀</span> <span class="bp">ℕ</span><span class="o">,</span>
  <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain</span><span class="o">,</span>
  <span class="n">map_id&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_id</span><span class="o">,</span>
  <span class="n">map_comp&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="n">f</span> <span class="n">g</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_comp</span> <span class="o">}</span>

<span class="kn">theorem</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_repeat</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">multiset</span><span class="bp">.</span><span class="n">map</span> <span class="n">f</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="n">x</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="n">rfl</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_succ</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_succ</span><span class="o">]</span>

<span class="kn">theorem</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_add</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">m</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="n">x</span> <span class="o">(</span><span class="n">m</span> <span class="bp">+</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="n">x</span> <span class="n">m</span> <span class="bp">+</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="n">x</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">nat</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">n</span> <span class="o">(</span><span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_zero</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">])</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_succ</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">add_succ</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_succ</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">add_cons</span><span class="o">,</span> <span class="n">ih</span><span class="o">]</span>

<span class="c1">-- ⟨s.to_finset, λ x, s.count x, λ x, multiset.mem_to_finset.trans $ multiset.count_pos.symm.trans $ nat.pos_iff_ne_zero⟩</span>
<span class="c1">-- faster but less idiomatic</span>
<span class="n">def</span> <span class="n">Multiset_Finsupp_nat</span> <span class="o">:</span> <span class="n">Multiset</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="err">≅</span> <span class="n">Finsupp_nat</span><span class="bp">.</span><span class="o">{</span><span class="n">u</span><span class="o">}</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">hom</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="n">app</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">s</span><span class="o">,</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span><span class="o">,</span>
    <span class="n">naturality&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span>
      <span class="k">show</span> <span class="o">((</span><span class="n">multiset</span><span class="bp">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">s</span><span class="o">)</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain</span> <span class="n">f</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="n">x</span><span class="o">,</span>
      <span class="k">from</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">s</span> <span class="n">rfl</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">s</span> <span class="n">ih</span><span class="o">,</span> <span class="k">if</span> <span class="n">h</span> <span class="o">:</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">x</span>
      <span class="k">then</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_cons</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">h</span><span class="o">,</span>
          <span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_cons</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_add</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_single</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">h</span><span class="o">,</span> <span class="n">ih</span><span class="o">]</span>
      <span class="k">else</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_cons</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_neg</span> <span class="n">h</span><span class="o">,</span>
          <span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_cons</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_add</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_single</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_neg</span> <span class="n">h</span><span class="o">,</span> <span class="n">ih</span><span class="o">]</span> <span class="o">},</span>
  <span class="n">inv</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="n">app</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">s</span><span class="o">,</span> <span class="n">s</span><span class="bp">.</span><span class="n">sum</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span><span class="o">,</span>
    <span class="n">naturality&#39;</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">α</span> <span class="n">β</span> <span class="n">f</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span>
      <span class="k">show</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">map_domain</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="bp">=</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">sum</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span><span class="o">)</span><span class="bp">.</span><span class="n">map</span> <span class="n">f</span><span class="o">,</span>
      <span class="k">from</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">induction</span> <span class="n">s</span> <span class="n">rfl</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">n</span> <span class="n">s</span> <span class="n">hsx</span> <span class="n">hn</span> <span class="n">ih</span><span class="o">,</span> <span class="k">begin</span>
        <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_add</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_add_index</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">map_domain_single</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span>
            <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_add_index</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_repeat</span><span class="o">,</span> <span class="n">ih</span><span class="o">],</span>
        <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">rw</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_add</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">rw</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_add</span> <span class="o">}</span>
      <span class="kn">end</span> <span class="o">},</span>
  <span class="n">hom_inv_id&#39;</span> <span class="o">:=</span> <span class="n">nat_trans</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span>
    <span class="k">show</span> <span class="o">(</span><span class="n">s</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span><span class="bp">.</span><span class="n">sum</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span> <span class="bp">=</span> <span class="n">s</span><span class="o">,</span>
    <span class="k">from</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">s</span> <span class="n">rfl</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">s</span> <span class="n">ih</span><span class="o">,</span> <span class="k">begin</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">map_cons</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_cons</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_add_index</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_one</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">cons_add</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">],</span>
      <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">rw</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_add</span> <span class="o">}</span>
    <span class="kn">end</span><span class="o">,</span>
  <span class="n">inv_hom_id&#39;</span> <span class="o">:=</span> <span class="n">nat_trans</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">α</span><span class="o">,</span> <span class="n">funext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span>
    <span class="k">show</span> <span class="o">((</span><span class="n">s</span><span class="bp">.</span><span class="n">sum</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat</span><span class="o">)</span><span class="bp">.</span><span class="n">map</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="bp">=</span> <span class="n">s</span><span class="o">,</span>
    <span class="k">from</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">induction</span> <span class="n">s</span> <span class="n">rfl</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">y</span> <span class="n">n</span> <span class="n">s</span> <span class="n">hsy</span> <span class="n">hn</span> <span class="n">ih</span><span class="o">,</span> <span class="k">begin</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_add_index</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_add</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">map_repeat</span><span class="o">],</span>
      <span class="o">{</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span> <span class="n">clear</span> <span class="n">hn</span><span class="o">,</span> <span class="n">induction</span> <span class="n">n</span> <span class="k">with</span> <span class="n">n</span> <span class="n">ih</span><span class="o">,</span>
        <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_zero</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_zero</span><span class="o">]</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_succ</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">sum_cons</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="err">←</span> <span class="n">nat</span><span class="bp">.</span><span class="n">one_add</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_add</span><span class="o">]</span> <span class="o">}</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">refl</span> <span class="o">},</span> <span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">rw</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">repeat_add</span> <span class="o">}</span>
    <span class="kn">end</span> <span class="o">}</span>
</pre></div>



<a name="170457179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170457179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170457179">(Jul 09 2019 at 14:20)</a>:</h4>
<p>Stuff got 90 lines shorter after <span class="user-mention" data-user-id="110049">@Mario Carneiro</span>'s suggestions: <a href="https://gist.github.com/jcommelin/add8c8df8b3479c435d3f5ac34cdb1f7" target="_blank" title="https://gist.github.com/jcommelin/add8c8df8b3479c435d3f5ac34cdb1f7">https://gist.github.com/jcommelin/add8c8df8b3479c435d3f5ac34cdb1f7</a></p>



<a name="170457204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170457204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170457204">(Jul 09 2019 at 14:20)</a>:</h4>
<p>Still using <code>-</code> to subtract <code>single s 1</code> but I think that can't be avoided.</p>



<a name="170457460"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170457460" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170457460">(Jul 09 2019 at 14:23)</a>:</h4>
<p>This is still pretty frightening. It's really baffling to think the definition of multiplication does not make this lemma obvious...</p>



<a name="170457487"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170457487" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170457487">(Jul 09 2019 at 14:23)</a>:</h4>
<p>Of course people shouldn't be discouraged to golf this down to a 5 line proof</p>



<a name="170459748"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170459748" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170459748">(Jul 09 2019 at 14:46)</a>:</h4>
<p>I really feel like making this the definition of multiplication.</p>



<a name="170459801"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170459801" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170459801">(Jul 09 2019 at 14:46)</a>:</h4>
<p>But I guess <code>mv_polynomial</code> inherits multiplication in a crazy way from <code>ℕ</code> being a <code>add_monoid</code>.</p>



<a name="170460727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170460727" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170460727">(Jul 09 2019 at 14:56)</a>:</h4>
<p>I'm surprised you didn't use <code>multiset.count</code> anywhere.</p>



<a name="170460793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170460793" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170460793">(Jul 09 2019 at 14:57)</a>:</h4>
<p>Maybe I should not have proven it by induction on the polynomials...</p>



<a name="170460798"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170460798" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170460798">(Jul 09 2019 at 14:57)</a>:</h4>
<p>I don't know.</p>



<a name="170460821"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170460821" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170460821">(Jul 09 2019 at 14:57)</a>:</h4>
<p>It seemed like an obvious thing to do. Maybe it is obviously bad.</p>



<a name="170616065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170616065" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170616065">(Jul 11 2019 at 09:19)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">coeff_mul</span> <span class="o">(</span><span class="n">φ</span> <span class="n">ψ</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">σ</span> <span class="bp">→</span><span class="err">₀</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">coeff</span> <span class="n">n</span> <span class="o">(</span><span class="n">φ</span> <span class="bp">*</span> <span class="n">ψ</span><span class="o">)</span> <span class="bp">=</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="n">diagonal</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="n">coeff</span> <span class="n">p</span><span class="bp">.</span><span class="mi">1</span> <span class="n">φ</span> <span class="bp">*</span> <span class="n">coeff</span> <span class="n">p</span><span class="bp">.</span><span class="mi">2</span> <span class="n">ψ</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="n">mul_def</span><span class="o">,</span>
  <span class="k">have</span> <span class="o">:=</span> <span class="bp">@</span><span class="n">finset</span><span class="bp">.</span><span class="n">sum_sigma</span> <span class="o">(</span><span class="n">σ</span> <span class="bp">→</span><span class="err">₀</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="n">α</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">φ</span><span class="bp">.</span><span class="n">support</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="n">ψ</span><span class="bp">.</span><span class="n">support</span><span class="o">)</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="bp">.</span><span class="mi">1</span> <span class="bp">+</span> <span class="n">x</span><span class="bp">.</span><span class="mi">2</span> <span class="bp">=</span> <span class="n">n</span><span class="o">)</span> <span class="k">then</span> <span class="n">coeff</span> <span class="n">x</span><span class="bp">.</span><span class="mi">1</span> <span class="n">φ</span> <span class="bp">*</span> <span class="n">coeff</span> <span class="n">x</span><span class="bp">.</span><span class="mi">2</span> <span class="n">ψ</span> <span class="k">else</span> <span class="mi">0</span><span class="o">),</span>
  <span class="n">convert</span> <span class="n">this</span><span class="bp">.</span><span class="n">symm</span> <span class="kn">using</span> <span class="mi">1</span><span class="bp">;</span> <span class="n">clear</span> <span class="n">this</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">coeff</span><span class="o">],</span>
    <span class="n">repeat</span> <span class="o">{</span><span class="n">rw</span> <span class="n">sum_apply</span><span class="o">,</span> <span class="n">apply</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_congr</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">intros</span><span class="o">,</span> <span class="n">dsimp</span> <span class="n">only</span><span class="o">},</span>
    <span class="n">exact</span> <span class="n">single_apply</span> <span class="o">},</span>
  <span class="o">{</span> <span class="k">have</span> <span class="o">:</span> <span class="o">(</span><span class="n">diagonal</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="n">filter</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">x</span><span class="bp">.</span><span class="mi">1</span> <span class="err">∈</span> <span class="n">φ</span><span class="bp">.</span><span class="n">support</span> <span class="bp">∧</span> <span class="n">x</span><span class="bp">.</span><span class="mi">2</span> <span class="err">∈</span> <span class="n">ψ</span><span class="bp">.</span><span class="n">support</span><span class="o">)</span> <span class="err">⊆</span> <span class="o">(</span><span class="n">diagonal</span> <span class="n">n</span><span class="o">)</span> <span class="o">:=</span>
      <span class="n">finset</span><span class="bp">.</span><span class="n">filter_subset</span> <span class="bp">_</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="err">←</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_sdiff</span> <span class="n">this</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">],</span> <span class="n">swap</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span> <span class="n">hx</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_sdiff</span><span class="o">,</span> <span class="n">not_iff_not_of_iff</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_filter</span><span class="o">),</span>
        <span class="n">not_and</span><span class="o">,</span> <span class="n">not_and</span><span class="o">,</span> <span class="n">not_mem_support_iff</span><span class="o">]</span> <span class="n">at</span> <span class="n">hx</span><span class="o">,</span>
      <span class="n">by_cases</span> <span class="n">H</span> <span class="o">:</span> <span class="n">x</span><span class="bp">.</span><span class="mi">1</span> <span class="err">∈</span> <span class="n">φ</span><span class="bp">.</span><span class="n">support</span><span class="o">,</span>
      <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">coeff</span><span class="o">,</span> <span class="n">coeff</span><span class="o">,</span> <span class="n">hx</span><span class="bp">.</span><span class="mi">2</span> <span class="n">hx</span><span class="bp">.</span><span class="mi">1</span> <span class="n">H</span><span class="o">,</span> <span class="n">mul_zero</span><span class="o">]</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">rw</span> <span class="n">not_mem_support_iff</span> <span class="n">at</span> <span class="n">H</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">coeff</span><span class="o">,</span> <span class="n">H</span><span class="o">,</span> <span class="n">zero_mul</span><span class="o">]</span> <span class="o">}</span> <span class="o">},</span>
    <span class="n">symmetry</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="err">←</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_sdiff</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">filter_subset</span> <span class="bp">_</span><span class="o">),</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">],</span> <span class="n">swap</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span> <span class="n">hx</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_sdiff</span><span class="o">,</span> <span class="n">not_iff_not_of_iff</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_filter</span><span class="o">),</span> <span class="n">not_and</span><span class="o">]</span> <span class="n">at</span> <span class="n">hx</span><span class="o">,</span>
      <span class="n">replace</span> <span class="n">hx</span> <span class="o">:=</span> <span class="n">hx</span><span class="bp">.</span><span class="mi">2</span> <span class="n">hx</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="n">rw</span> <span class="n">if_neg</span><span class="o">,</span> <span class="n">exact</span> <span class="n">hx</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">apply</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_bij</span><span class="o">,</span> <span class="n">swap</span> <span class="mi">5</span><span class="o">,</span> <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span> <span class="n">hx</span><span class="o">,</span> <span class="n">exact</span> <span class="o">(</span><span class="n">x</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="n">x</span><span class="bp">.</span><span class="mi">2</span><span class="o">)</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span> <span class="n">hx</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_filter</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">mem_sigma</span><span class="o">]</span> <span class="n">at</span> <span class="n">hx</span><span class="o">,</span>
        <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_filter</span><span class="o">,</span> <span class="n">mem_diagonal</span><span class="o">],</span>
        <span class="n">dsimp</span><span class="o">,</span> <span class="n">exact</span> <span class="n">hx</span><span class="bp">.</span><span class="n">symm</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span> <span class="n">hx</span><span class="o">,</span> <span class="n">rw</span> <span class="n">finset</span><span class="bp">.</span><span class="n">mem_filter</span> <span class="n">at</span> <span class="n">hx</span><span class="o">,</span> <span class="n">rw</span> <span class="n">if_pos</span> <span class="n">hx</span><span class="bp">.</span><span class="mi">2</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">i</span><span class="o">,</span><span class="n">j</span><span class="bp">⟩</span> <span class="bp">⟨</span><span class="n">k</span><span class="o">,</span><span class="n">l</span><span class="bp">⟩</span> <span class="n">hij</span> <span class="n">hkl</span><span class="o">,</span> <span class="n">simpa</span> <span class="kn">using</span> <span class="n">and</span><span class="bp">.</span><span class="n">intro</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">i</span><span class="o">,</span><span class="n">j</span><span class="bp">⟩</span> <span class="n">hij</span><span class="o">,</span> <span class="n">refine</span> <span class="bp">⟨⟨</span><span class="n">i</span><span class="o">,</span><span class="n">j</span><span class="bp">⟩</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span> <span class="o">{</span> <span class="n">apply_instance</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_filter</span><span class="o">,</span> <span class="n">mem_diagonal</span><span class="o">]</span> <span class="n">at</span> <span class="n">hij</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_filter</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">mem_sigma</span><span class="o">],</span>
          <span class="n">exact</span> <span class="n">hij</span><span class="bp">.</span><span class="n">symm</span> <span class="o">},</span>
        <span class="o">{</span> <span class="n">refl</span> <span class="o">}</span> <span class="o">}</span> <span class="o">},</span>
    <span class="n">all_goals</span> <span class="o">{</span> <span class="n">apply_instance</span> <span class="o">}</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>



<a name="170616076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/coeff_mul/near/170616076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/coeff_mul.html#170616076">(Jul 11 2019 at 09:19)</a>:</h4>
<p>I hope this is a more reasonable length.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>