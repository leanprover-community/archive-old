---
layout: archive
title: Zulip Chat Archive
permalink: /stream/116395-maths/topic/witt.20vectors.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/116395-maths/index.html">maths</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html">witt vectors</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="130216141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130216141" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130216141">(Jul 24 2018 at 14:52)</a>:</h4>
<p>Anyone interested in sharpening his teeth on polynomials is encouraged to look here: <a href="https://gist.github.com/jcommelin/77240367c2815ca0c45da188ba78be19" target="_blank" title="https://gist.github.com/jcommelin/77240367c2815ca0c45da188ba78be19">https://gist.github.com/jcommelin/77240367c2815ca0c45da188ba78be19</a></p>



<a name="130216160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130216160" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130216160">(Jul 24 2018 at 14:52)</a>:</h4>
<p>A bunch of stuff from the preamble will be obsolete as soon as Mario pushes his latest mathlib edits.</p>



<a name="130216186"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130216186" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130216186">(Jul 24 2018 at 14:53)</a>:</h4>
<p>In the final lemma there are a bunch of <code>sorry</code>s. The proof is extremely slow, and I am continuously struggling with deterministic timeouts.</p>



<a name="130216194"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130216194" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130216194">(Jul 24 2018 at 14:53)</a>:</h4>
<p>I have no idea why. It didn't feel to me like I was pushing limits.</p>



<a name="130216304"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130216304" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130216304">(Jul 24 2018 at 14:55)</a>:</h4>
<p>So there is about 180 lines of preamble. And then about 50 lines of interesting stuff <span class="emoji emoji-1f609" title="wink">:wink:</span></p>



<a name="130216538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130216538" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130216538">(Jul 24 2018 at 14:58)</a>:</h4>
<p>(A bit of motivation for these crazy polynomials: They are useful for defining rings of Witt vectors, and those show up all over the place in number theory. For example, the ring of p-adic integers turns out to be the ring of Witt vectors of the finite field with p elements.)</p>



<a name="130220198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130220198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130220198">(Jul 24 2018 at 16:07)</a>:</h4>
<blockquote>
<p>In the final lemma there are a bunch of <code>sorry</code>s. The proof is extremely slow, and I am continuously struggling with deterministic timeouts.</p>
</blockquote>
<p>There is sometimes a reason for this ("your code is crappy for a reason which you didn't realise") but typically you have to get lucky with an expert looking at it and spotting what you did wrong. My valuation stuff got slow recently and I don't know why, but I didn't even bother posting 200 lines of Lean code and saying "why does this take three seconds to compile and I had to put some type class thing up to 100 to make it work?" because it's such a boring question; if I really cared I would try and minimise; currently I just grit my teeth and work around it.</p>



<a name="130221163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130221163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130221163">(Jul 24 2018 at 16:26)</a>:</h4>
<p>So how do you work around deterministic timeouts? What determines such a timeout? Can I set some option to let Lean work harder?</p>



<a name="130221200"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130221200" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130221200">(Jul 24 2018 at 16:27)</a>:</h4>
<p>Did you see the <code>1 &lt;= k &lt;= n</code> example? That one seemed to debate some discussion from the experts</p>



<a name="130221240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130221240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130221240">(Jul 24 2018 at 16:28)</a>:</h4>
<p>Here's a conjecture: these things are almost always caused by the type class inference system. <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> what do you think about my conjecture?</p>



<a name="130259324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130259324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130259324">(Jul 25 2018 at 07:13)</a>:</h4>
<p>that's a bit of a general claim. Another way to make lean take a long time is to use lots of definitional equality or kernel computation, possibly on accident; and elaboration can often take a suspiciously long time to complete (not crazy but like 10-15 seconds for a term proof) for reasons I don't well understand</p>



<a name="130263224"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/130263224" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#130263224">(Jul 25 2018 at 08:53)</a>:</h4>
<p>There's a file in the perfectoid repo which takes 10 seconds to compile and I was half-thinking about trying to work out why so really I was looking for clues here.</p>



<a name="131034587"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131034587" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131034587">(Aug 07 2018 at 10:07)</a>:</h4>
<p>Anyone care to take a look at <a href="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L107" target="_blank" title="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L107">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L107</a> ? That file is self-contained, but depends on the latest mathlib.</p>



<a name="131036884"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131036884" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131036884">(Aug 07 2018 at 11:00)</a>:</h4>
<p>I don't know what the type of anything is, but the lemma you're applying needs that the things you're applying it to are in a multiplicative group and the elements you're talking about look suspicious to me</p>



<a name="131036897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131036897" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131036897">(Aug 07 2018 at 11:01)</a>:</h4>
<p>A field is not a group under multiplication. Are you using the right lemma?</p>



<a name="131037022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131037022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131037022">(Aug 07 2018 at 11:03)</a>:</h4>
<p>oh, good call</p>



<a name="131037035"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131037035" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131037035">(Aug 07 2018 at 11:03)</a>:</h4>
<p>there are mirror versions of all the group lemmas for fields with namespace <code>division_ring</code> or <code>field</code></p>



<a name="131037136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131037136" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131037136">(Aug 07 2018 at 11:06)</a>:</h4>
<p>This has happened to me so many times :-)</p>



<a name="131037218"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131037218" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131037218">(Aug 07 2018 at 11:07)</a>:</h4>
<p>"I can't find an instance of exactly what it says in the goal" usually for me means "the thing you want me to match with doesn't match because of something in square brackets"</p>



<a name="131037272"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131037272" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131037272">(Aug 07 2018 at 11:08)</a>:</h4>
<p>heh, I remember so many questions from you like that</p>



<a name="131038606"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131038606" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131038606">(Aug 07 2018 at 11:36)</a>:</h4>
<p>I'm slowly making progress... <code>conv</code> is still confusing me.</p>



<a name="131038649"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131038649" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131038649">(Aug 07 2018 at 11:37)</a>:</h4>
<p><code>conv in (λ _, _)</code> gives an error:</p>
<div class="codehilite"><pre><span></span><span class="n">invalid</span> <span class="n">mk_pattern</span><span class="o">,</span> <span class="bp">#</span><span class="mi">1</span> <span class="n">expr</span> <span class="kn">parameter</span> <span class="n">does</span> <span class="n">not</span> <span class="n">occur</span> <span class="k">in</span> <span class="n">the</span> <span class="n">target</span> <span class="n">or</span> <span class="o">(</span><span class="n">other</span><span class="o">)</span> <span class="n">expr</span> <span class="kn">parameter</span> <span class="n">types</span>
<span class="n">state</span><span class="o">:</span>
<span class="bp">_</span><span class="n">inst_1</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">Prime</span><span class="o">,</span>
<span class="n">n</span> <span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span>
<span class="n">H</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">m</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">→</span> <span class="n">eval₂</span> <span class="n">C</span> <span class="n">witt_polynomial</span> <span class="o">(</span><span class="n">X_in_terms_of_W</span> <span class="n">m</span><span class="o">)</span> <span class="bp">=</span> <span class="n">X</span> <span class="n">m</span>
<span class="err">⊢</span> <span class="n">witt_polynomial</span> <span class="n">n</span> <span class="bp">=</span>
      <span class="n">C</span> <span class="o">(</span><span class="err">↑</span><span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="bp">*</span> <span class="n">X</span> <span class="n">n</span> <span class="bp">+</span>
        <span class="n">finset</span><span class="bp">.</span><span class="n">sum</span> <span class="n">finset</span><span class="bp">.</span><span class="n">univ</span>
          <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">fin</span> <span class="n">n</span><span class="o">),</span>
             <span class="n">eval₂</span> <span class="n">C</span> <span class="n">witt_polynomial</span> <span class="o">(</span><span class="n">C</span> <span class="err">↑</span><span class="n">p</span> <span class="err">^</span> <span class="n">x</span><span class="bp">.</span><span class="n">val</span><span class="o">)</span> <span class="bp">*</span>
               <span class="n">eval₂</span> <span class="n">C</span> <span class="n">witt_polynomial</span> <span class="o">(</span><span class="n">X_in_terms_of_W</span> <span class="o">(</span><span class="n">x</span><span class="bp">.</span><span class="n">val</span><span class="o">)</span> <span class="err">^</span> <span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">-</span> <span class="n">x</span><span class="bp">.</span><span class="n">val</span><span class="o">)))</span> <span class="bp">=</span>
    <span class="err">?</span><span class="n">m_1</span>
</pre></div>



<a name="131038700"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131038700" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131038700">(Aug 07 2018 at 11:38)</a>:</h4>
<p>But there is clearly a lambda in there...</p>



<a name="131039097"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131039097" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131039097">(Aug 07 2018 at 11:46)</a>:</h4>
<p>Ok, I navigated to the lambda by hand.</p>



<a name="131039113"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131039113" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131039113">(Aug 07 2018 at 11:47)</a>:</h4>
<p>Then I did some rewrites using ring homomorphisms, but Lean couldn't find an instance for them, nor for some rings.</p>



<a name="131039123"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131039123" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131039123">(Aug 07 2018 at 11:47)</a>:</h4>
<p>Outside the <code>conv</code>, Lean found those instances without any trouble.</p>



<a name="131039128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131039128" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131039128">(Aug 07 2018 at 11:47)</a>:</h4>
<p>Is this a known issue?</p>



<a name="131041397"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131041397" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131041397">(Aug 07 2018 at 12:34)</a>:</h4>
<p>I have this gut feeling that I've gone from never using <code>conv</code> (because I had no idea how it worked or what it did, before Patrick and I pushed the experts to explain it and then Patrick wrote <code>conv.md</code>) to over-using it. I tend to use it to do rewrites under a lambda -- but remember that <code>simp</code> does this too, so perhaps <code>simp only</code> will do what you're trying to do without having to use <code>conv</code>. One problem with <code>conv</code> is that if you're trying to find <code>f x = g x</code> in some <code>lam x, f x = g x</code> then <code>conv</code> won't match <code>f x</code> because it complains it doesn't know what <code>x</code> is. I don't know what your problem is but I look at pretty much every Lean function and it's some sort of lambda, so trying to match a lambda with so many holes sounds a bit scary to me, and trying to fill in the holes also looks hard for the reason I just mentioned above. Will <code>simp</code> not work for you?</p>



<a name="131041784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131041784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131041784">(Aug 07 2018 at 12:42)</a>:</h4>
<p>"I worked my way around it..."</p>



<a name="131042169"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042169" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042169">(Aug 07 2018 at 12:50)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I have the feeling that I can not extract sublemmas for this proof. Yet I'm constantly plagued with deterministic timeouts. <a href="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L108" target="_blank" title="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L108">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L108</a></p>



<a name="131042206"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042206" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042206">(Aug 07 2018 at 12:51)</a>:</h4>
<p>I fought the mess (and the mess won)</p>



<a name="131042285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042285" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042285">(Aug 07 2018 at 12:52)</a>:</h4>
<p>I wanted to ask: why are you using a <code>finset.univ.sum</code> over <code>fin n</code> when the function to sum over does not depend on the assumption <code>x.2</code>?</p>



<a name="131042296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042296" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042296">(Aug 07 2018 at 12:53)</a>:</h4>
<p>It would be much easier to use <code>(finset.range n).sum (\lam x, ...)</code></p>



<a name="131042395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042395">(Aug 07 2018 at 12:55)</a>:</h4>
<p>Ok. The answer is: I've never used <code>finset.range</code> before, and didn't know about it.</p>



<a name="131042772"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042772" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042772">(Aug 07 2018 at 13:02)</a>:</h4>
<p>deterministic time-outs usually mean that you've made a mistake in your code and Lean, instead of saying "look an error", is trying to coerce an int into a nat or something else that it can't do but is unfortunately bad at spotting that it can't do.</p>



<a name="131042792"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042792" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042792">(Aug 07 2018 at 13:03)</a>:</h4>
<p>bad coercions, and trying to prove things which aren't refl by refl, are sometimes the cause</p>



<a name="131042797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042797" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042797">(Aug 07 2018 at 13:03)</a>:</h4>
<p>(even if they look refl)</p>



<a name="131042913"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042913" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042913">(Aug 07 2018 at 13:05)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Ok, in the definition after the <code>witt_polynomial</code> I am using <code>i.2</code>.</p>



<a name="131042956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042956" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042956">(Aug 07 2018 at 13:06)</a>:</h4>
<p>So now I need some hackery to make that recursive definition work.</p>



<a name="131042975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131042975" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131042975">(Aug 07 2018 at 13:06)</a>:</h4>
<p>I see that... I'm working on the hackery</p>



<a name="131043298"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131043298" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131043298">(Aug 07 2018 at 13:12)</a>:</h4>
<p>This should get you started:</p>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">range_sum_eq_fin_univ_sum</span> <span class="o">{</span><span class="n">α</span><span class="o">}</span> <span class="o">[</span><span class="n">add_comm_monoid</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">range</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">finset</span><span class="bp">.</span><span class="n">univ</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span> <span class="o">:</span> <span class="n">fin</span> <span class="n">n</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="bp">.</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">show</span> <span class="bp">_</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">multiset</span><span class="bp">.</span><span class="n">sum</span> <span class="n">α</span> <span class="bp">_</span> <span class="err">↑</span><span class="o">(</span><span class="n">list</span><span class="bp">.</span><span class="n">map</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">list</span><span class="bp">.</span><span class="n">map_pmap</span><span class="o">,</span> <span class="n">list</span><span class="bp">.</span><span class="n">pmap_eq_map</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span>

<span class="n">def</span> <span class="n">witt_polynomial</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="bp">ℕ</span> <span class="n">R</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">range</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">))</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">C</span> <span class="n">p</span> <span class="err">^</span> <span class="n">i</span> <span class="bp">*</span> <span class="n">X</span> <span class="n">i</span> <span class="err">^</span> <span class="o">(</span><span class="n">p</span><span class="err">^</span><span class="o">(</span><span class="n">n</span><span class="bp">-</span><span class="n">i</span><span class="o">))))</span>

<span class="n">def</span> <span class="n">X_in_terms_of_W</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">mv_polynomial</span> <span class="bp">ℕ</span> <span class="n">ℚ</span>
<span class="bp">|</span> <span class="n">n</span> <span class="o">:=</span> <span class="o">(</span><span class="n">X</span> <span class="n">n</span> <span class="bp">-</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">sum</span> <span class="n">finset</span><span class="bp">.</span><span class="n">univ</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span> <span class="o">:</span> <span class="n">fin</span> <span class="n">n</span><span class="o">,</span>
  <span class="k">have</span> <span class="bp">_</span> <span class="o">:=</span> <span class="n">i</span><span class="bp">.</span><span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="n">C</span> <span class="n">p</span><span class="err">^</span><span class="n">i</span><span class="bp">.</span><span class="n">val</span> <span class="bp">*</span> <span class="o">(</span><span class="n">X_in_terms_of_W</span> <span class="n">i</span><span class="bp">.</span><span class="n">val</span><span class="o">)</span><span class="err">^</span><span class="o">(</span><span class="n">p</span><span class="err">^</span><span class="o">(</span><span class="n">n</span><span class="bp">-</span><span class="n">i</span><span class="bp">.</span><span class="n">val</span><span class="o">))))))</span> <span class="bp">*</span> <span class="n">C</span> <span class="o">(</span><span class="mi">1</span><span class="bp">/</span><span class="n">p</span><span class="err">^</span><span class="n">n</span><span class="o">)</span>

<span class="kn">lemma</span> <span class="n">X_in_terms_of_W_eq</span> <span class="o">{</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">}</span> <span class="o">:</span> <span class="n">X_in_terms_of_W</span> <span class="n">n</span> <span class="bp">=</span>
    <span class="o">(</span><span class="n">X</span> <span class="n">n</span> <span class="bp">-</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">range</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="n">C</span> <span class="n">p</span> <span class="err">^</span> <span class="n">i</span> <span class="bp">*</span> <span class="n">X_in_terms_of_W</span> <span class="n">i</span> <span class="err">^</span> <span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">-</span> <span class="n">i</span><span class="o">)))</span> <span class="bp">*</span>
      <span class="n">C</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">/</span> <span class="err">↑</span><span class="n">p</span> <span class="err">^</span> <span class="n">n</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">X_in_terms_of_W</span><span class="o">,</span> <span class="n">range_sum_eq_fin_univ_sum</span><span class="o">]</span>
</pre></div>



<a name="131043305"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131043305" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131043305">(Aug 07 2018 at 13:12)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> Hey look, a nontrivial equation lemma</p>



<a name="131043423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131043423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131043423">(Aug 07 2018 at 13:14)</a>:</h4>
<p>Thanks!</p>



<a name="131043492"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131043492" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131043492">(Aug 07 2018 at 13:15)</a>:</h4>
<p>That's a really sweet example of equation lemma hackery!</p>



<a name="131046126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046126">(Aug 07 2018 at 14:02)</a>:</h4>
<p><code>finset.sum finset.univ (λ i : fin (n+1), (C p^i.val * (X i.val)^(p^(n-i.val))))</code></p>
<p>Is this really still the best way to sum from 0 to n? It's the constant mentioning of <code>.val</code> which is a bit irritating. Is there some big operator or something which makes this better-looking?</p>



<a name="131046219"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046219" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046219">(Aug 07 2018 at 14:03)</a>:</h4>
<p>No, the best way is <code>(range (n+1)).sum ...</code></p>



<a name="131046245"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046245" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046245">(Aug 07 2018 at 14:04)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> Mario suggested a better way. I'll push my current file.</p>



<a name="131046341"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046341" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046341">(Aug 07 2018 at 14:05)</a>:</h4>
<p>Oh yes I see the post now. I ignored it initially because I'd not even begun to look at the file, but I have WiFi for the next 10 minutes so I downloaded the version on GH and am now looking through it.</p>



<a name="131046344"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046344" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046344">(Aug 07 2018 at 14:05)</a>:</h4>
<p><a href="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L114" target="_blank" title="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L114">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L114</a></p>



<a name="131046356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046356">(Aug 07 2018 at 14:05)</a>:</h4>
<p>Ok, make sure you download again (-;</p>



<a name="131046430"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046430" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046430">(Aug 07 2018 at 14:06)</a>:</h4>
<p>I've all sorts of rewrites that are failing, and it is beyond me why they fail...</p>



<a name="131046616"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046616" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046616">(Aug 07 2018 at 14:09)</a>:</h4>
<p>I see! Range is nice to look at, but summing over <code>fin n</code> is cool because <code>i.2</code> is exactly what you need to make the equation compiler swallow it. Then you switch back to get the equation lemma you really want.</p>



<a name="131046705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046705">(Aug 07 2018 at 14:10)</a>:</h4>
<p>Yes. Pretty cool stuff, right? Kudos to Mario.</p>



<a name="131046716"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046716" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046716">(Aug 07 2018 at 14:11)</a>:</h4>
<p>I feel I've made progress today.</p>



<a name="131046727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046727" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046727">(Aug 07 2018 at 14:11)</a>:</h4>
<p>But the proof is still extremely slow. And it is fragile beyond imagination.</p>



<a name="131046820"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046820" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046820">(Aug 07 2018 at 14:12)</a>:</h4>
<p>on line 135 or so you have two different <code>n</code>'s.</p>



<a name="131046849"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046849" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046849">(Aug 07 2018 at 14:13)</a>:</h4>
<p>that's from the first two lines. You can ignore the first <code>n</code> after the first line</p>



<a name="131046851"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046851" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046851">(Aug 07 2018 at 14:13)</a>:</h4>
<p>Yes, I don't know why <code>strong_induction</code> introduces a new <code>n</code></p>



<a name="131046859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131046859" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131046859">(Aug 07 2018 at 14:13)</a>:</h4>
<p>I'll clear the first one</p>



<a name="131047007"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047007" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047007">(Aug 07 2018 at 14:16)</a>:</h4>
<p>Inserting <code>repeat {sorry},end #exit</code> on line 124 and the proof still takes forever to compile (a second or two). I can't work with Lean when it's like this. Something you're doing is taking far longer than it should, and rather than biting the bullet nowadays I try to fix it.</p>



<a name="131047028"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047028" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047028">(Aug 07 2018 at 14:17)</a>:</h4>
<p>It's line 119</p>



<a name="131047040"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047040" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047040">(Aug 07 2018 at 14:17)</a>:</h4>
<p><code>  simp only [eval₂_mul, eval₂_add, eval₂_sub, eval₂_neg, eval₂_C, eval₂_X],</code></p>



<a name="131047098"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047098" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047098">(Aug 07 2018 at 14:18)</a>:</h4>
<p>How do you figure out which line it is?</p>



<a name="131047100"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047100" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047100">(Aug 07 2018 at 14:18)</a>:</h4>
<p><code>elaboration: tactic execution took 3.44s</code>.</p>



<a name="131047112"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047112" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047112">(Aug 07 2018 at 14:18)</a>:</h4>
<p>I just keep cutting and pasting <code>repeat {sorry}, end #exit</code> higher and higher up the file until I find it</p>



<a name="131047125"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047125" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047125">(Aug 07 2018 at 14:18)</a>:</h4>
<p>Nowadays when I write Lean code I notice it straight away and deal with the problem when it appears.</p>



<a name="131047143"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047143" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047143">(Aug 07 2018 at 14:19)</a>:</h4>
<p>Ok... so somehow I need to speed up that line...</p>



<a name="131047196"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047196" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047196">(Aug 07 2018 at 14:20)</a>:</h4>
<p>In mathspeak it says that the <code>eval2</code> is a ring homomorphism, and that it therefore commutes with mul and add.</p>



<a name="131047210"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047210" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047210">(Aug 07 2018 at 14:20)</a>:</h4>
<p>And thus the ring hom can be moved "inside".</p>



<a name="131047369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047369" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047369">(Aug 07 2018 at 14:23)</a>:</h4>
<div class="codehilite"><pre><span></span>  <span class="n">rw</span> <span class="o">[</span><span class="n">eval₂_mul</span><span class="o">,</span> <span class="n">eval₂_C</span><span class="o">],</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">eval₂_sub</span><span class="o">],</span>
  <span class="n">rw</span> <span class="n">eval₂_X</span><span class="o">,</span>
</pre></div>



<a name="131047376"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131047376" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131047376">(Aug 07 2018 at 14:23)</a>:</h4>
<p>Somehow <code>simp only</code> succeeds, while <code>rw</code> doesn't...</p>



<a name="131050069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131050069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131050069">(Aug 07 2018 at 15:11)</a>:</h4>
<p>Ok, it is still really ugly... but progress: <a href="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L115" target="_blank" title="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L115">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L115</a></p>



<a name="131050137"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131050137" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131050137">(Aug 07 2018 at 15:12)</a>:</h4>
<p>Now I need <code>i.property</code> but I no longer have access to it <span class="emoji emoji-2639" title="sad">:sad:</span></p>



<a name="131050148"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131050148" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131050148">(Aug 07 2018 at 15:12)</a>:</h4>
<p>And the proof is still relatively slow.</p>



<a name="131050156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131050156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131050156">(Aug 07 2018 at 15:12)</a>:</h4>
<p>Anyway, I need to go home now. See you later!</p>



<a name="131050849"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131050849" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131050849">(Aug 07 2018 at 15:24)</a>:</h4>
<p>After lots of testing, I think I know the problem: <code>eval₂_*</code> is a bad simp lemma, not because it is written incorrectly, but because it is too expensive to instantiate. It takes a second or so to figure out if one of these rules even applies, and simp has to go through tons of them at all parts of the expression</p>



<a name="131051808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131051808" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131051808">(Aug 07 2018 at 15:39)</a>:</h4>
<p>I've just been dropping these <code>sorry,end #exit</code> lines in near the beginning and even the rewrites are taking time. <code>simp only [eval₂_sub]</code> seems to take about 200ms but <code>rw @eval₂_sub _ _ _ _ _ _ (X n) (finset.sum (finset.range n) (λ (i : ℕ), C ↑p ^ i * X_in_terms_of_W i ^ p ^ (n - i))) _ _ C _ witt_polynomial</code> also takes about 200ms</p>



<a name="131051831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131051831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131051831">(Aug 07 2018 at 15:39)</a>:</h4>
<p>and then <code>rw eval₂_X</code> takes about 600ms</p>



<a name="131053242"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131053242" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131053242">(Aug 07 2018 at 16:01)</a>:</h4>
<p>For me the <code>eval2_sub</code> proof works provided I have the <code>foobar</code> instance:</p>
<div class="codehilite"><pre><span></span>instance foobar : comm_ring (mv_polynomial ℕ ℚ) := by apply_instance
</pre></div>



<a name="131054040"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131054040" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131054040">(Aug 07 2018 at 16:15)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">definition</span> <span class="n">inst_1</span> <span class="o">:</span> <span class="n">decidable_eq</span> <span class="bp">ℕ</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
<span class="kn">definition</span> <span class="n">inst_2</span> <span class="o">:</span> <span class="n">decidable_eq</span> <span class="n">ℚ</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
<span class="kn">definition</span> <span class="n">inst_3</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="n">ℚ</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
<span class="kn">definition</span> <span class="n">inst_4</span> <span class="o">:</span> <span class="n">decidable_eq</span> <span class="o">(</span><span class="n">mv_polynomial</span> <span class="bp">ℕ</span> <span class="n">ℚ</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
<span class="kn">definition</span> <span class="n">inst_5</span> <span class="o">:</span> <span class="n">comm_ring</span> <span class="o">(</span><span class="n">mv_polynomial</span> <span class="bp">ℕ</span> <span class="n">ℚ</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
<span class="kn">definition</span> <span class="n">inst_6</span> <span class="o">:</span> <span class="n">is_ring_hom</span> <span class="o">(</span><span class="n">C</span> <span class="o">:</span> <span class="n">ℚ</span> <span class="bp">→</span> <span class="o">(</span><span class="n">mv_polynomial</span> <span class="bp">ℕ</span> <span class="n">ℚ</span><span class="o">))</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>

<span class="kn">lemma</span> <span class="n">X_in_terms_of_W_prop</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">X_in_terms_of_W</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="n">eval₂</span> <span class="n">C</span> <span class="n">witt_polynomial</span> <span class="bp">=</span> <span class="n">X</span> <span class="n">n</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">nat</span><span class="bp">.</span><span class="n">strong_induction_on</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">clear</span> <span class="n">n</span><span class="o">,</span>
  <span class="n">intros</span> <span class="n">n</span> <span class="n">H</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">X_in_terms_of_W_eq</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">eval₂_mul</span><span class="o">,</span> <span class="n">eval₂_C</span><span class="o">],</span>
  <span class="n">rw</span> <span class="bp">@</span><span class="n">eval₂_sub</span> <span class="n">ℚ</span> <span class="o">(</span><span class="n">mv_polynomial</span> <span class="bp">ℕ</span> <span class="n">ℚ</span><span class="o">)</span> <span class="bp">ℕ</span> <span class="n">inst_1</span> <span class="n">inst_2</span> <span class="n">inst_3</span>
    <span class="o">(</span><span class="n">X</span> <span class="n">n</span><span class="o">)</span>
    <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">range</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">C</span> <span class="err">↑</span><span class="n">p</span> <span class="err">^</span> <span class="n">i</span> <span class="bp">*</span> <span class="n">X_in_terms_of_W</span> <span class="n">i</span> <span class="err">^</span> <span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">-</span> <span class="n">i</span><span class="o">)))</span>
    <span class="n">inst_4</span> <span class="n">inst_5</span> <span class="n">C</span> <span class="n">inst_6</span> <span class="n">witt_polynomial</span><span class="o">,</span>
  <span class="n">sorry</span><span class="o">,</span><span class="kn">end</span> <span class="bp">#</span><span class="kn">exit</span>
</pre></div>


<p>That last rw is taking 150ms. Is that a long time for a rewrite?</p>



<a name="131054089"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131054089" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131054089">(Aug 07 2018 at 16:16)</a>:</h4>
<p>I filled in every field.</p>



<a name="131054347"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131054347" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131054347">(Aug 07 2018 at 16:23)</a>:</h4>
<p>and <code>rw @eval₂_X ℚ (mv_polynomial ℕ ℚ) ℕ inst_1 inst_2 inst_3' inst_4' C inst_5' witt_polynomial n</code> (the line after) is taking over 300ms.</p>



<a name="131054427"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131054427" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131054427">(Aug 07 2018 at 16:25)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">definition</span> <span class="n">inst_3&#39;</span> <span class="o">:</span> <span class="n">comm_semiring</span> <span class="n">ℚ</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
<span class="kn">definition</span> <span class="n">inst_4&#39;</span> <span class="o">:</span> <span class="n">comm_semiring</span> <span class="o">(</span><span class="n">mv_polynomial</span> <span class="bp">ℕ</span> <span class="n">ℚ</span><span class="o">)</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
<span class="kn">definition</span> <span class="n">inst_5&#39;</span> <span class="o">:</span> <span class="n">is_semiring_hom</span> <span class="o">(</span><span class="n">C</span> <span class="o">:</span> <span class="n">ℚ</span> <span class="bp">→</span> <span class="o">(</span><span class="n">mv_polynomial</span> <span class="bp">ℕ</span> <span class="n">ℚ</span><span class="o">))</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span>
</pre></div>


<p>I thought that <code>rw</code> looked at the head of the expression, and it's not hard to find <code>eval_2</code>, there's only two possibilities, and one of them fits perfectly. I don't understand why these rewrites are taking so long.</p>



<a name="131054652"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131054652" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131054652">(Aug 07 2018 at 16:30)</a>:</h4>
<p>That's exactly what I was thinking.</p>



<a name="131054696"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131054696" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131054696">(Aug 07 2018 at 16:31)</a>:</h4>
<p>By the way, in the expression <code>(X_in_terms_of_W n).eval₂ C witt_polynomial = X n</code> are you aware that the <code>R</code> variable of <code>witt_polynomial</code> is instantiated as <code>Q</code>?</p>



<a name="131054768"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131054768" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131054768">(Aug 07 2018 at 16:33)</a>:</h4>
<p>if you try to assert that it has type <code>mv_polynomial ℕ R</code> it doesn't typecheck</p>



<a name="131055665"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131055665" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131055665">(Aug 07 2018 at 16:54)</a>:</h4>
<p>Oh wow, this has a 1000% improvement in speed:</p>
<div class="codehilite"><pre><span></span>generalize e : eval₂ C witt_polynomial = f,
haveI : is_ring_hom f := by subst f; apply eval₂.is_ring_hom,
</pre></div>


<p>Most of the proof only uses that <code>f</code> is a ring hom. For the rest, you can use the equality to recover the eval</p>



<a name="131056663"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131056663" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131056663">(Aug 07 2018 at 17:13)</a>:</h4>
<p>Mario, yes, I was aware of that. In the end, we want some identity over <code>\Z</code>. I only wrote the general definition of <code>witt_polynomial</code> so that I didn't constantly have to <code>map</code> them to other rings.</p>



<a name="131056734"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131056734" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131056734">(Aug 07 2018 at 17:14)</a>:</h4>
<p>Ok, so I put that bit of code somewhere in the beginning of my proof? And then I get massive speedups, and afterwards it is recovered/unfolded towards the end?</p>



<a name="131058032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131058032" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131058032">(Aug 07 2018 at 17:36)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Does your suggestion classify as best practice or is it a fragile hack? Is this a sign that we need to improve <code>eval2</code>, or is there nothing to worry about?</p>



<a name="131082758"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131082758" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131082758">(Aug 08 2018 at 02:32)</a>:</h4>
<p>It is a hack, although not that fragile, it's just a weird workaround for inexplicable slowdown</p>



<a name="131082897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131082897" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131082897">(Aug 08 2018 at 02:36)</a>:</h4>
<p>I found another weird way to speed things up:</p>
<div class="codehilite"><pre><span></span>set_option profiler true

instance eval_witt_hom : is_ring_hom (eval₂ C (witt_polynomial R)) :=
@mv_polynomial.eval₂.is_ring_hom _ _ _ _ _ _ _ _ _
  (@C.is_ring_hom R ℕ _ (λ a b, _inst_2 a b) _) _

lemma X_in_terms_of_W_prop (n : ℕ) : (X_in_terms_of_W n).eval₂ C (witt_polynomial ℚ) = X n :=
begin
  apply nat.strong_induction_on n,
  intros n H,
  rw [X_in_terms_of_W_eq],
  simp,
end
</pre></div>


<p>the <code>simp</code> application runs fine as long as you have that instance. The elaboration of <code>eval_witt_hom</code> takes about 500 ms written like this, but if I write <code>_inst_2</code> instead of eta expanded, elaboration jumps to 8.3 s. If I use <code>by apply_instance</code> it takes about 1 s</p>



<a name="131082996"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131082996" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131082996">(Aug 08 2018 at 02:39)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> This stuff is closer to your area of expertise than mine, although I am not sure how easy it is to separate mathlib from this issue</p>



<a name="131087058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131087058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131087058">(Aug 08 2018 at 04:22)</a>:</h4>
<p>Okay, here's a complete proof with no unreasonable slowdowns:</p>
<div class="codehilite"><pre><span></span>instance eval_witt_hom : is_ring_hom (eval₂ C (witt_polynomial R)) :=
@mv_polynomial.eval₂.is_ring_hom _ _ _ _ _ _ _ _ _
  (@C.is_ring_hom R ℕ _ (λ a b, _inst_2 a b) _) _

lemma X_in_terms_of_W_prop&#39;
  (f : mv_polynomial ℕ ℚ → mv_polynomial ℕ ℚ) [is_ring_hom f]
  (fC : ∀ (a : ℚ), f (C a) = C a)
  (fX : ∀ (n : ℕ), f (X n) = witt_polynomial ℚ n)
  (n : ℕ) : f (X_in_terms_of_W n) = X n :=
begin
  apply nat.strong_induction_on n,
  clear n, intros n H,
  rw [X_in_terms_of_W_eq],
  simp only [is_ring_hom.map_mul f, is_ring_hom.map_sub f, fC, fX, ring_hom_sum.finset f],
  rw [finset.sum_congr rfl, (_ : witt_polynomial ℚ n -
    (finset.range n).sum (λ i, C p ^ i * X i ^ p ^ (n - i)) = C (p ^ n) * X n)],
  { rw [mul_right_comm, ← C_mul, mul_one_div_cancel, C_1, one_mul],
    exact pow_ne_zero _ (nat.cast_ne_zero.2 $ ne_of_gt pp.pos) },
  { simp [witt_polynomial, nat.sub_self],
    rw ring_hom_powers (@C ℚ ℕ _ _ _) },
  { intros i h,
    simp [is_ring_hom.map_mul f, ring_hom_powers f, fC] at h ⊢,
    rw H _ h }
end

lemma X_in_terms_of_W_prop (n : ℕ) : (X_in_terms_of_W n).eval₂ C (witt_polynomial ℚ) = X n :=
begin
  letI : is_ring_hom (@C ℚ ℕ _ _ _) := by apply_instance,
  haveI H := @eval_witt_hom _ ℚ _ _,
  have fC := eval₂_C C (witt_polynomial ℚ),
  have fX := eval₂_X C (witt_polynomial ℚ),
  revert H fC fX, generalize : eval₂ C (witt_polynomial ℚ) = f,
  introsI, exact X_in_terms_of_W_prop&#39; f fC fX n
end
</pre></div>



<a name="131088141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131088141" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131088141">(Aug 08 2018 at 05:00)</a>:</h4>
<p>Wow! Thanks for your help Mario! I wouldn't have been able to come up with this myself.</p>



<a name="131088204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131088204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131088204">(Aug 08 2018 at 05:03)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Is it ok that your proof explicitly mentions <code>_inst_2</code>? I always assumed that was "forbidden".</p>



<a name="131088256"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131088256" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131088256">(Aug 08 2018 at 05:05)</a>:</h4>
<p>You should see if <code>λ a b, by apply_instance</code> also works without slowdown. If not, you can just name the instance and refer to it</p>



<a name="131088298"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131088298" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131088298">(Aug 08 2018 at 05:06)</a>:</h4>
<p>Ok, I'll merge this into my file as soon as I'm back at work.</p>



<a name="131091024"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131091024" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131091024">(Aug 08 2018 at 06:32)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> You also changed the definition of <code>witt_polynomial</code> to make the ring <code>R</code> explicit, didn't you?</p>



<a name="131091040"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131091040" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131091040">(Aug 08 2018 at 06:32)</a>:</h4>
<p>I did, it was making things a bit confusing. You don't have to</p>



<a name="131092231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131092231" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131092231">(Aug 08 2018 at 07:10)</a>:</h4>
<p>Is there a way to tease more information out of Lean when it gives the error <code>command expected</code>?</p>



<a name="131092296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131092296" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131092296">(Aug 08 2018 at 07:13)</a>:</h4>
<p>that means that the parser was reset, you are between definitions or something, and you give a non-keyword</p>



<a name="131092301"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131092301" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131092301">(Aug 08 2018 at 07:13)</a>:</h4>
<p>Or it means you have <code>checking visible lines</code> mode enabled and you should scroll down to refresh the parser</p>



<a name="131092457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131092457" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131092457">(Aug 08 2018 at 07:19)</a>:</h4>
<p>I see... a very descriptive error message <span class="emoji emoji-1f923" title="rolling on the floor laughing">:rolling_on_the_floor_laughing:</span></p>



<a name="131095998"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131095998" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131095998">(Aug 08 2018 at 09:00)</a>:</h4>
<blockquote>
<p>Or it means you have <code>checking visible lines</code> mode enabled and you should scroll down to refresh the parser</p>
</blockquote>
<p>Johan -- we're talking about the little message in the blue bar at the bottom of the VS Code window which says something like "checking visible lines and above". I constantly refer to this as "evil mode" and it used to be the case that whenever I see a student whose blue bar said this, I would tell them to click on the blue bar and change it to "checking visible files". There is a place for the "visible lines and above" choice, but for my users it causes more trouble than it solves, because it means that sometimes the answer to "there's a red line -- what is wrong with my code?" is "nothing is wrong with your code, it's just that Lean isn't reading all of it". Nowadays I just show my students how to make it say "checking visible files" by selecting File-&gt;Preferences-&gt;Settings (ctrl-, on linux), then searching for <code>linesandabove</code> in the default user settings, hovering over <code>"lean.roiModeDefault": "linesAndAbove"</code> (if it says that -- you want it to say <code>visible</code>, clicking the little pencil just to the left of it [thus moving the variable into the part of the settings which you can edit], and then making sure it says <code>"lean.roiModeDefault": "visible"</code> in user settings.</p>



<a name="131096086"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131096086" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131096086">(Aug 08 2018 at 09:03)</a>:</h4>
<blockquote>
<p>Nowadays I just show my students how to make it say "checking visible files"</p>
</blockquote>
<p>BTW, this is the default now.</p>



<a name="131096702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131096702" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131096702">(Aug 08 2018 at 09:19)</a>:</h4>
<p>Thanks for switching it back Gabriel. It's fine if you know what you're doing, but experience indicated that it was confusing for new users. I love the way that you just sit there in the background occasionally making things better for me.</p>



<a name="131097020"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131097020" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131097020">(Aug 08 2018 at 09:25)</a>:</h4>
<p>Thanks for the explanation Kevin!</p>



<a name="131101387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131101387" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131101387">(Aug 08 2018 at 11:14)</a>:</h4>
<p>Aaaaahrg. I'm completely stuck again!</p>
<div class="codehilite"><pre><span></span><span class="kn">lemma</span> <span class="n">quux</span> <span class="o">{</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">A</span><span class="o">]</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">A</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">range</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">))</span><span class="bp">.</span><span class="n">sum</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">n</span> <span class="bp">+</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">range</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="n">f</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">simp</span>

<span class="kn">lemma</span> <span class="n">X_in_terms_of_W_prop₂</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">witt_polynomial</span> <span class="n">k</span><span class="o">)</span><span class="bp">.</span><span class="kn">eval</span> <span class="n">X_in_terms_of_W</span> <span class="bp">=</span> <span class="n">X</span> <span class="n">k</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">nat</span><span class="bp">.</span><span class="n">strong_induction_on</span> <span class="n">k</span><span class="o">,</span>
  <span class="n">clear</span> <span class="n">k</span><span class="o">,</span> <span class="n">intros</span> <span class="n">k</span> <span class="n">H</span><span class="o">,</span>
  <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[</span><span class="n">witt_polynomial</span><span class="o">],</span>
  <span class="n">conv</span>
  <span class="k">begin</span>
    <span class="n">to_lhs</span><span class="o">,</span>
    <span class="n">congr</span><span class="o">,</span> <span class="n">skip</span><span class="o">,</span>
    <span class="n">rw</span> <span class="n">quux</span> <span class="n">k</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">C</span> <span class="err">↑</span><span class="n">p</span> <span class="err">^</span> <span class="n">i</span> <span class="bp">*</span> <span class="n">X</span> <span class="n">i</span> <span class="err">^</span> <span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">k</span> <span class="bp">-</span> <span class="n">i</span><span class="o">)),</span>
  <span class="kn">end</span><span class="o">,</span>
  <span class="c1">-- generalize e : eval X_in_terms_of_W = f,</span>
  <span class="c1">-- haveI : is_ring_hom f := by subst f; apply eval.is_ring_hom,</span>
  <span class="c1">-- simp only [ring_hom_sum.finset f],</span>
  <span class="c1">-- repeat {sorry}, end #exit</span>
  <span class="n">sorry</span>
<span class="kn">end</span>
</pre></div>



<a name="131101390"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131101390" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131101390">(Aug 08 2018 at 11:14)</a>:</h4>
<p>Yesterday's trick isn't working.</p>



<a name="131101554"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131101554" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131101554">(Aug 08 2018 at 11:18)</a>:</h4>
<p><del>After this sorry is removed, I think we are mostly good to go for the definition of witt vectors.</del> Meh... I forgot that I still need to convince Lean that I actually get a polynomial over <code>\Z</code> instead of <code>\Q</code>.</p>



<a name="131101563"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131101563" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131101563">(Aug 08 2018 at 11:19)</a>:</h4>
<p>But maybe we first need to figure out why Lean is misbehaving like a toddler...</p>



<a name="131101710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131101710" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131101710">(Aug 08 2018 at 11:22)</a>:</h4>
<p>I pushed the stuff that I have right now: <a href="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L135" target="_blank" title="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L135">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L135</a></p>



<a name="131102445"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131102445" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131102445">(Aug 08 2018 at 11:40)</a>:</h4>
<p>Ok, so I have polynomials over <code>\Q</code>, but actually all their coefficients lie in <code>\Z</code>. What is the best way to extract this polynomial over <code>\Z</code>? I currently have the following:</p>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">witt_structure_int</span> <span class="o">(</span><span class="err">Φ</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">bool</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="o">(</span><span class="n">bool</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="bp">ℤ</span> <span class="o">:=</span>
<span class="n">finsupp</span><span class="bp">.</span><span class="n">map_range</span> <span class="n">rat</span><span class="bp">.</span><span class="n">num</span> <span class="o">(</span><span class="n">rat</span><span class="bp">.</span><span class="n">coe_int_num</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">witt_structure_rat</span> <span class="o">(</span><span class="n">map</span> <span class="n">int</span><span class="bp">.</span><span class="n">cast</span> <span class="err">Φ</span><span class="o">)</span> <span class="n">n</span><span class="o">)</span>
</pre></div>



<a name="131103604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131103604" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131103604">(Aug 08 2018 at 12:02)</a>:</h4>
<p>Your rewrite on line 144 is, for me, trying to rewrite when the goal is <code>| X_in_terms_of_W</code>. But if I add another <code>skip</code> then I see Lean trying to do this:</p>
<div class="codehilite"><pre><span></span>_inst_1 : nat.Prime,
k : ℕ,
H : ∀ (m : ℕ), m &lt; k → eval₂ C X_in_terms_of_W (witt_polynomial m) = X m
| finset.sum (finset.range (k + 1)) (λ (i : ℕ), C ↑p ^ i * X i ^ p ^ (k - i))
scratch6.lean:145:4: error

rewrite tactic failed, did not find instance of the pattern in the target expression
  finset.sum (finset.range (k + 1)) (λ (i : ℕ), C ↑p ^ i * X i ^ p ^ (k - i))
state:
10 goals
_inst_1 : nat.Prime,
k : ℕ,
H : ∀ (m : ℕ), m &lt; k → eval₂ C X_in_terms_of_W (witt_polynomial m) = X m
⊢ finset.sum (finset.range (k + 1)) (λ (i : ℕ), C ↑p ^ i * X i ^ p ^ (k - i)) = ?m_1
</pre></div>


<p>But when you <code>set_option pp.all true</code> I see a whole bunch of typeclass inference stuff which doesn't look like it matches up. The thing you're trying to rewrite has a whole bunch of unsolved metavariables. Your goal looks like this: </p>
<div class="codehilite"><pre><span></span> (@finset.sum.{0 0} nat
       (@mv_polynomial.{0 0} nat rat
...
</pre></div>


<p>and the thing you're trying to rewrite looks like this:</p>
<div class="codehilite"><pre><span></span>  @finset.sum.{0 ?l_1} nat (@mv_polynomial.{0 ?l_1} nat ?m_2 ?m_3) ...
</pre></div>


<p>Maybe if you are more precise with your rewrite it might help, i.e. throw in some <code>@</code>s and say exactly what the type of some more things are. I am kind of wondering whether the type class inference system doesn't know enough about what your types are, and is making some bad guesses about what instances it should use.</p>



<a name="131105049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131105049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131105049">(Aug 08 2018 at 12:29)</a>:</h4>
<p><a href="https://gist.github.com/kbuzzard/5254103e5f33b022636a9491fb6719e9" target="_blank" title="https://gist.github.com/kbuzzard/5254103e5f33b022636a9491fb6719e9">https://gist.github.com/kbuzzard/5254103e5f33b022636a9491fb6719e9</a></p>
<p>That's the beginning of the <code>set_option pp.all true</code> output. The <code>quux</code> thing is the thing at the top. The goal is the much longer thing at the bottom, most of which I've truncated. The much longer thing at the bottom corresponds to just the first three lines of the top. Lines 3 and 50 match perfectly. Lines 1 and 2 are supposed to match with lines 16 to 49. We have a universe metavariable <code>?l_1</code> which can be zero, then a term metavariable <code>?m_2</code> which can be <code>rat</code>. What I'm worried about is line 2, which says that type class inference wants to prove something is an add_comm_monoid, and it's going to do this by showing it's an add_comm_group and then it will use an instance called <code>add_comm_group.to_add_comm_monoid</code>. But lines 25 to 42 seem to be showing that the rationals are an add_comm_monoid by showing that they're a field, and then a comm_ring, and then a comm_semiring (note that we have now diverged from the plan, because a comm_semiring isn't an add_comm_group) and then an add_comm_monoid.</p>
<p>Now this might not be the problem, but somehow it looks to me like it <em>might</em> be an obstruction to the rewrite succeeding. Can you somehow tell Lean that you're not working with <code>?m_2</code> but with <code>rat</code>?</p>



<a name="131105249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131105249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131105249">(Aug 08 2018 at 12:32)</a>:</h4>
<p>Like so?</p>
<div class="codehilite"><pre><span></span><span class="n">rw</span> <span class="n">quux</span> <span class="n">k</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="o">((</span><span class="n">C</span> <span class="err">↑</span><span class="n">p</span> <span class="err">^</span> <span class="n">i</span> <span class="bp">*</span> <span class="n">X</span> <span class="n">i</span> <span class="err">^</span> <span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">k</span> <span class="bp">-</span> <span class="n">i</span><span class="o">))</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="bp">ℕ</span> <span class="n">ℚ</span><span class="o">)),</span>
</pre></div>


<p>Alas, that still fails.</p>



<a name="131105757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131105757" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131105757">(Aug 08 2018 at 12:41)</a>:</h4>
<p>Hmm, now the output of <code>pp.all</code> shows an insane amount of similarities between the goal and what the rewrite offers.</p>



<a name="131105807"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131105807" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131105807">(Aug 08 2018 at 12:42)</a>:</h4>
<p>But it is not enough. The <code>rw</code> is using modules <span class="emoji emoji-1f631" title="scream">:scream:</span> whereas the goal is sane, and just works with rings.</p>



<a name="131105895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131105895" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131105895">(Aug 08 2018 at 12:44)</a>:</h4>
<p>What you're trying to rewrite: <a href="https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503" target="_blank" title="https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503">https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503</a></p>
<p>Goal: <a href="https://gist.github.com/kbuzzard/f515877383946b5eb84f03e31cb988c3" target="_blank" title="https://gist.github.com/kbuzzard/f515877383946b5eb84f03e31cb988c3">https://gist.github.com/kbuzzard/f515877383946b5eb84f03e31cb988c3</a></p>
<p>They're not the same. The question perhaps is which differences are superficial and which ones are stopping the rewrite</p>



<a name="131106029"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131106029" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131106029">(Aug 08 2018 at 12:46)</a>:</h4>
<p>I'm scared by <a href="https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503#file-pattern-lean-L21" target="_blank" title="https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503#file-pattern-lean-L21">https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503#file-pattern-lean-L21</a></p>



<a name="131106164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131106164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131106164">(Aug 08 2018 at 12:49)</a>:</h4>
<p>Sorry!!! I messed up. I did not have enough <code>skip</code>s in the <code>conv</code>. <span class="emoji emoji-1f62d" title="sob">:sob:</span></p>



<a name="131106990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131106990" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131106990">(Aug 08 2018 at 13:03)</a>:</h4>
<p>Didn't I mention that? ;-)</p>



<a name="131108053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131108053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131108053">(Aug 08 2018 at 13:21)</a>:</h4>
<p>Hmmm, it seems to me that whenever I make any progress using <code>simp</code> or <code>dsimp</code>, afterwards everything breaks, because it cleans up to much.</p>



<a name="131108058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131108058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131108058">(Aug 08 2018 at 13:21)</a>:</h4>
<p>So I find my self doing long chains of <code>rw</code>s</p>



<a name="131108116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131108116" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131108116">(Aug 08 2018 at 13:22)</a>:</h4>
<p>And now I have <code>(\lam i, f i) i</code>. And I need <code>f i</code>. How do I do that without <code>dsimp</code>?</p>



<a name="131108302"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131108302" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131108302">(Aug 08 2018 at 13:25)</a>:</h4>
<p>Ok, so I think this is called beta-reduction. Is there a tactic that will do beta-reduction, and nothing else?</p>



<a name="131108886"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131108886" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131108886">(Aug 08 2018 at 13:34)</a>:</h4>
<p>Ok! "I worked my way around it."</p>



<a name="131108907"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131108907" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131108907">(Aug 08 2018 at 13:35)</a>:</h4>
<p>All sorries are gone in this part! <span class="emoji emoji-1f419" title="octopus">:octopus:</span></p>



<a name="131108917"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131108917" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131108917">(Aug 08 2018 at 13:35)</a>:</h4>
<p>Now I need to figure out how to get some polynomials that are defined over Q to believe that they actually live over Z.</p>



<a name="131108918"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131108918" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131108918">(Aug 08 2018 at 13:35)</a>:</h4>
<p><a href="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L218" target="_blank" title="https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L218">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L218</a></p>



<a name="131109022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131109022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131109022">(Aug 08 2018 at 13:37)</a>:</h4>
<p>You can have a look at <a href="https://github.com/leanprover/lean/blob/28f4143be31b7aa3c63a907be5443ca100025ef1/library/init/meta/simp_tactic.lean#L71" target="_blank" title="https://github.com/leanprover/lean/blob/28f4143be31b7aa3c63a907be5443ca100025ef1/library/init/meta/simp_tactic.lean#L71">https://github.com/leanprover/lean/blob/28f4143be31b7aa3c63a907be5443ca100025ef1/library/init/meta/simp_tactic.lean#L71</a></p>



<a name="131109042"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131109042" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131109042">(Aug 08 2018 at 13:37)</a>:</h4>
<p>turning off everything but beta</p>



<a name="131109241"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131109241" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131109241">(Aug 08 2018 at 13:40)</a>:</h4>
<p>I think you only need to specify that beta is turned on</p>



<a name="131109276"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131109276" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131109276">(Aug 08 2018 at 13:41)</a>:</h4>
<p>but I'm not sure</p>



<a name="131109373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/131109373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#131109373">(Aug 08 2018 at 13:42)</a>:</h4>
<p>I think we could have a tactic doing only this and unfolding composition (ie <code>rw comp_app</code>)</p>



<a name="168051078"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168051078" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168051078">(Jun 13 2019 at 14:39)</a>:</h4>
<p>After almost a year I took another look at this code. I've almost proven the fundamental theorem about witt polynomials: <a href="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean</a></p>



<a name="168051161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168051161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168051161">(Jun 13 2019 at 14:40)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">witt_structure_int_exists_unique</span> <span class="o">(</span><span class="err">Φ</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">bool</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span>
  <span class="bp">∃!</span> <span class="o">(</span><span class="n">φ</span> <span class="o">:</span> <span class="bp">ℕ</span> <span class="bp">→</span> <span class="n">mv_polynomial</span> <span class="o">(</span><span class="n">bool</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="bp">ℤ</span><span class="o">),</span>
  <span class="bp">∀</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="o">(</span><span class="n">witt_polynomial</span> <span class="n">p</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="n">eval₂</span> <span class="n">C</span> <span class="n">φ</span> <span class="bp">=</span>
<span class="err">Φ</span><span class="bp">.</span><span class="n">eval₂</span> <span class="n">C</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">b</span> <span class="o">:</span> <span class="n">bool</span><span class="o">,</span> <span class="o">((</span><span class="n">witt_polynomial</span> <span class="n">p</span> <span class="n">n</span><span class="o">)</span><span class="bp">.</span><span class="n">rename</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span> <span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="n">i</span><span class="o">))))</span> <span class="o">:=</span>
</pre></div>



<a name="168051182"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168051182" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168051182">(Jun 13 2019 at 14:40)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1199" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1199">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1199</a></p>



<a name="168051204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168051204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168051204">(Jun 13 2019 at 14:40)</a>:</h4>
<p><a href="https://arxiv.org/abs/1906.03583" target="_blank" title="https://arxiv.org/abs/1906.03583">https://arxiv.org/abs/1906.03583</a></p>
<p>If you want a goal which looks accessible ;-)</p>



<a name="168051264"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168051264" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168051264">(Jun 13 2019 at 14:41)</a>:</h4>
<p>The only sorry on which that proof depends is on <a href="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L921" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L921">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L921</a> and it says:</p>
<div class="codehilite"><pre><span></span><span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_3</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">,</span>
<span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_1</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_6</span> <span class="o">:</span> <span class="n">decidable_eq</span> <span class="n">ι</span><span class="o">,</span>
<span class="n">n</span> <span class="o">:</span> <span class="bp">ℤ</span>
<span class="err">⊢</span> <span class="o">(</span><span class="n">C</span> <span class="n">n</span> <span class="n">modₑ</span> <span class="err">↑</span><span class="n">p</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">C</span> <span class="n">n</span> <span class="err">^</span> <span class="n">p</span> <span class="n">modₑ</span> <span class="err">↑</span><span class="n">p</span><span class="o">)</span>
</pre></div>



<a name="168051353"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168051353" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168051353">(Jun 13 2019 at 14:42)</a>:</h4>
<p>In other words, I need little Fermat for integers that are viewed as constant polynomials in an arbitrary multi-variate polynomial ring over the integers.</p>



<a name="168051408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168051408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168051408">(Jun 13 2019 at 14:42)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> I think it makes more sense to first show that Witt vectors form a ring (-;</p>



<a name="168051423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168051423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168051423">(Jun 13 2019 at 14:42)</a>:</h4>
<p>(And to clean up the file.)</p>



<a name="168051468"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168051468" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168051468">(Jun 13 2019 at 14:43)</a>:</h4>
<p>There are some extremely crazy things going on, where type class search completely messes up.</p>



<a name="168051570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168051570" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168051570">(Jun 13 2019 at 14:44)</a>:</h4>
<p>And what is annoying is that you can't even easily switch it off using <code>@</code>s. I wish I could tell Lean:<br>
"Hey, I want to apply this lemma. Try to do that without caring about the type class instances. Just give them to me as goals."<br>
But I'm not sure if it is easy to say that to Lean.</p>



<a name="168053571"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168053571" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168053571">(Jun 13 2019 at 15:04)</a>:</h4>
<p>If you want Lean to say that then does this mean that some things are classes which shouldn't be classes?</p>



<a name="168054494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168054494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168054494">(Jun 13 2019 at 15:14)</a>:</h4>
<p>Things like <code>add_comm_monoid</code> <span aria-label="stuck out tongue wink" class="emoji emoji-1f61c" role="img" title="stuck out tongue wink">:stuck_out_tongue_wink:</span></p>



<a name="168054563"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168054563" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168054563">(Jun 13 2019 at 15:15)</a>:</h4>
<p>It can't figure out that quotient rings are <code>add_comm_monoid</code>, or that <code>quotient.mk</code> is a semiring hom, etc.. etc...</p>



<a name="168054588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168054588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168054588">(Jun 13 2019 at 15:15)</a>:</h4>
<p>Probably these issues go away with proper proof engineering... But I'm not a proof engineer.</p>



<a name="168056875"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168056875" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168056875">(Jun 13 2019 at 15:40)</a>:</h4>
<p>I use <code>by apply</code> when I get the pesky issue with inferred != unified</p>



<a name="168067220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168067220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168067220">(Jun 13 2019 at 17:38)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> With underscores? As in, do you then manually have to fill in the typeclasses? Or does it usually figure out all the type classes itself?</p>



<a name="168072838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168072838" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168072838">(Jun 13 2019 at 18:35)</a>:</h4>
<p>no underscores</p>



<a name="168072910"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168072910" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168072910">(Jun 13 2019 at 18:36)</a>:</h4>
<p>just <code>by apply foo</code> instead of <code>foo _ _</code> or <code>@foo _ _ _ _</code> or whatever</p>



<a name="168073697"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168073697" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168073697">(Jun 13 2019 at 18:44)</a>:</h4>
<p>I'll test this</p>



<a name="168073959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168073959" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168073959">(Jun 13 2019 at 18:48)</a>:</h4>
<p>In the course of this file, I prove:</p>
<div class="codehilite"><pre><span></span><span class="kn">variables</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">]</span>

<span class="kn">lemma</span> <span class="n">dvd_sub_pow_of_dvd_sub</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="err">∣</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span>
<span class="o">(</span><span class="n">p</span><span class="err">^</span><span class="o">(</span><span class="n">k</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="err">∣</span> <span class="n">a</span><span class="err">^</span><span class="o">(</span><span class="n">p</span><span class="err">^</span><span class="n">k</span><span class="o">)</span> <span class="bp">-</span> <span class="n">b</span><span class="err">^</span><span class="o">(</span><span class="n">p</span><span class="err">^</span><span class="n">k</span><span class="o">)</span> <span class="o">:=</span>
</pre></div>


<p><a href="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L261" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L261">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L261</a></p>



<a name="168074014"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168074014" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168074014">(Jun 13 2019 at 18:48)</a>:</h4>
<p>This proof is currently quite long and slow.</p>



<a name="168074029"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168074029" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168074029">(Jun 13 2019 at 18:48)</a>:</h4>
<p>But it is completely elementary maths...</p>



<a name="168074096"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168074096" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168074096">(Jun 13 2019 at 18:49)</a>:</h4>
<p>Here is what I currently have:</p>
<div class="codehilite"><pre><span></span><span class="n">local</span> <span class="n">attribute</span> <span class="o">[</span><span class="n">class</span><span class="o">]</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">]</span>

<span class="kn">lemma</span> <span class="n">dvd_sub_pow_of_dvd_sub</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="err">∣</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">p</span><span class="err">^</span><span class="o">(</span><span class="n">k</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="err">∣</span> <span class="n">a</span><span class="err">^</span><span class="o">(</span><span class="n">p</span><span class="err">^</span><span class="n">k</span><span class="o">)</span> <span class="bp">-</span> <span class="n">b</span><span class="err">^</span><span class="o">(</span><span class="n">p</span><span class="err">^</span><span class="n">k</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">induction</span> <span class="n">k</span> <span class="k">with</span> <span class="n">k</span> <span class="n">ih</span><span class="o">,</span> <span class="o">{</span> <span class="n">simpa</span> <span class="kn">using</span> <span class="n">h</span> <span class="o">},</span> <span class="n">clear</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">succ_eq_add_one</span><span class="o">],</span>
  <span class="n">rcases</span> <span class="n">ih</span> <span class="k">with</span> <span class="bp">⟨</span><span class="n">c</span><span class="o">,</span> <span class="n">hc</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">sub_eq_iff_eq_add&#39;</span> <span class="n">at</span> <span class="n">hc</span><span class="o">,</span>
  <span class="n">replace</span> <span class="n">hc</span> <span class="o">:=</span> <span class="n">congr_arg</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">x</span><span class="o">,</span> <span class="n">x</span><span class="err">^</span><span class="n">p</span><span class="o">)</span> <span class="n">hc</span><span class="o">,</span>
  <span class="n">dsimp</span> <span class="n">only</span> <span class="n">at</span> <span class="n">hc</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="err">←</span> <span class="n">pow_mul</span><span class="o">,</span> <span class="n">add_pow</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_range_succ</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">choose_self</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">cast_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span>
    <span class="n">nat</span><span class="bp">.</span><span class="n">sub_self</span><span class="o">,</span> <span class="n">pow_zero</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span> <span class="n">at</span> <span class="n">hc</span><span class="o">,</span>
  <span class="n">conv</span> <span class="o">{</span> <span class="n">congr</span><span class="o">,</span> <span class="n">skip</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">pow_succ</span><span class="o">]</span> <span class="o">},</span>
  <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">pow_eq_pow</span><span class="o">]</span> <span class="n">at</span> <span class="n">hc</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">hc</span><span class="o">,</span> <span class="n">pow_mul</span><span class="o">,</span> <span class="n">add_sub_cancel&#39;</span><span class="o">],</span> <span class="n">clear</span> <span class="n">hc</span> <span class="n">a</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">dvd_sum</span><span class="o">,</span>
  <span class="n">intros</span> <span class="n">i</span> <span class="n">hi</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">finset</span><span class="bp">.</span><span class="n">mem_range</span> <span class="n">at</span> <span class="n">hi</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">mul_pow</span><span class="o">,</span>
  <span class="n">conv</span> <span class="o">{</span> <span class="n">congr</span><span class="o">,</span> <span class="n">skip</span><span class="o">,</span> <span class="n">congr</span><span class="o">,</span> <span class="n">congr</span><span class="o">,</span> <span class="n">skip</span><span class="o">,</span> <span class="n">rw</span> <span class="n">mul_comm</span> <span class="o">},</span>
  <span class="n">repeat</span> <span class="o">{</span> <span class="n">rw</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="n">apply</span> <span class="n">dvd_mul_of_dvd_right</span> <span class="o">},</span> <span class="n">clear</span> <span class="n">c</span> <span class="n">b</span><span class="o">,</span>
  <span class="n">norm_cast</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">coe_nat_dvd</span><span class="o">,</span>
  <span class="n">by_cases</span> <span class="n">H</span> <span class="o">:</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">subst</span> <span class="n">H</span><span class="o">,</span>
    <span class="n">suffices</span> <span class="o">:</span> <span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">k</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="err">∣</span> <span class="o">(</span><span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">k</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="err">^</span> <span class="n">p</span><span class="o">,</span> <span class="k">by</span> <span class="n">simpa</span><span class="o">,</span>
    <span class="n">rw</span> <span class="err">←</span> <span class="n">nat</span><span class="bp">.</span><span class="n">pow_mul</span><span class="o">,</span>
    <span class="n">apply</span> <span class="n">nat</span><span class="bp">.</span><span class="n">pow_dvd_pow</span><span class="o">,</span>
    <span class="n">refine</span> <span class="n">le_trans</span> <span class="o">(</span><span class="n">add_le_add_left&#39;</span> <span class="err">$</span> <span class="n">le_add_left</span> <span class="err">$</span> <span class="n">le_refl</span> <span class="bp">_</span> <span class="o">:</span> <span class="n">k</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">≤</span> <span class="n">k</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">+</span> <span class="o">(</span><span class="n">k</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="bp">_</span><span class="o">,</span>
    <span class="n">refine</span> <span class="n">le_trans</span> <span class="o">(</span><span class="n">le_of_eq</span> <span class="bp">_</span><span class="o">)</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">mul_le_mul_left</span> <span class="o">(</span><span class="n">k</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="err">$</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">ge_two</span> <span class="err">‹</span><span class="bp">_</span><span class="err">›</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">≤</span> <span class="n">p</span><span class="o">)),</span>
    <span class="n">rw</span> <span class="n">mul_two</span> <span class="o">},</span>
  <span class="k">have</span> <span class="n">i_pos</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">pos_of_ne_zero</span> <span class="n">H</span><span class="o">,</span> <span class="n">clear</span> <span class="n">H</span><span class="o">,</span>
  <span class="n">rw</span> <span class="n">nat</span><span class="bp">.</span><span class="n">pow_succ</span><span class="o">,</span>
  <span class="n">apply</span> <span class="n">mul_dvd_mul</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">generalize</span> <span class="n">H</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span><span class="err">^</span><span class="o">(</span><span class="n">k</span><span class="bp">+</span><span class="mi">1</span><span class="o">))</span> <span class="bp">=</span> <span class="n">b</span><span class="o">,</span>
    <span class="k">have</span> <span class="o">:=</span> <span class="n">nat</span><span class="bp">.</span><span class="n">sub_pos_of_lt</span> <span class="n">hi</span><span class="o">,</span>
    <span class="n">conv</span> <span class="o">{</span><span class="n">congr</span><span class="o">,</span> <span class="n">rw</span> <span class="err">←</span> <span class="n">nat</span><span class="bp">.</span><span class="n">pow_one</span> <span class="n">b</span><span class="o">},</span>
    <span class="n">apply</span> <span class="n">nat</span><span class="bp">.</span><span class="n">pow_dvd_pow</span><span class="o">,</span>
    <span class="n">exact</span> <span class="n">this</span> <span class="o">},</span>
  <span class="n">exact</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span><span class="bp">.</span><span class="n">dvd_choose</span> <span class="n">i_pos</span> <span class="n">hi</span> <span class="err">‹</span><span class="bp">_</span><span class="err">›</span>
<span class="kn">end</span>
</pre></div>



<a name="168074136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168074136" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168074136">(Jun 13 2019 at 18:49)</a>:</h4>
<p>If someone is looking for a golfing challenge... voila <span aria-label="up" class="emoji emoji-2b06" role="img" title="up">:up:</span></p>



<a name="168080734"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168080734" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168080734">(Jun 13 2019 at 20:10)</a>:</h4>
<blockquote>
<p>It can't figure out that quotient rings are <code>add_comm_monoid</code></p>
</blockquote>
<p>This one in particular seems alarming</p>



<a name="168218364"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168218364" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168218364">(Jun 15 2019 at 18:32)</a>:</h4>
<p>I've done some refactoring, and removed a bunch of sorries.</p>



<a name="168218367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168218367" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168218367">(Jun 15 2019 at 18:32)</a>:</h4>
<p>Witt vectors are now a <code>comm_ring</code>:<br>
<a href="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1339" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1339">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1339</a></p>



<a name="168376810"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168376810" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168376810">(Jun 18 2019 at 07:40)</a>:</h4>
<blockquote>
<p>I use <code>by apply</code> when I get the pesky issue with inferred != unified</p>
</blockquote>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I've been trying this but is doesn't seem to work.</p>
<p>I've cleaned up the code quite a bit. In the course of this, those sorries returned. I have no idea what is wrong, but for some weird reason I'm pushing Leans limits.<br>
If you could take a look at <a href="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L577" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L577">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L577</a> that would be great.</p>



<a name="168376951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168376951" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168376951">(Jun 18 2019 at 07:43)</a>:</h4>
<p>This branch only changes <code>mv_polynomial.lean</code> and the new file <code>witt_vector.lean</code>.</p>
<div class="codehilite"><pre><span></span>git pull
git checkout 38d5c12022e001a221e279f035e3cc0734c4a189 <span class="c1"># the lean-3.4.2 of yesterday</span>
cache-olean --fetch
git checkout witt-vectors
</pre></div>


<p>That should give one a working version of the branch pretty quickly.</p>



<a name="168378405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168378405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168378405">(Jun 18 2019 at 08:05)</a>:</h4>
<p>To give an idea of how weird the situation is:</p>
<div class="codehilite"><pre><span></span><span class="mi">4</span> <span class="n">goals</span>
<span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_3</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">,</span>
<span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span>
<span class="err">⊢</span> <span class="n">distrib</span><span class="bp">.</span><span class="n">to_has_add</span> <span class="o">(</span><span class="n">ideal</span><span class="bp">.</span><span class="n">quotient</span> <span class="o">(</span><span class="n">ideal</span><span class="bp">.</span><span class="n">span</span> <span class="o">{</span><span class="n">C</span> <span class="err">↑</span><span class="o">(</span><span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))}))</span> <span class="bp">=</span>
    <span class="n">add_semigroup</span><span class="bp">.</span><span class="n">to_has_add</span> <span class="o">(</span><span class="n">ideal</span><span class="bp">.</span><span class="n">quotient</span> <span class="o">(</span><span class="n">ideal</span><span class="bp">.</span><span class="n">span</span> <span class="o">{</span><span class="n">C</span> <span class="err">↑</span><span class="o">(</span><span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))}))</span>

<span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_3</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">,</span>
<span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span>
<span class="err">⊢</span> <span class="mi">0</span> <span class="bp">*</span> <span class="o">(</span><span class="n">X</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)</span> <span class="err">^</span> <span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">-</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))</span> <span class="n">modₑ</span> <span class="n">C</span> <span class="err">↑</span><span class="o">(</span><span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">)))</span> <span class="bp">=</span> <span class="mi">0</span>

<span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_3</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">,</span>
<span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span>
<span class="err">⊢</span> <span class="n">is_add_monoid_hom</span> <span class="o">(</span><span class="n">ideal</span><span class="bp">.</span><span class="n">quotient</span><span class="bp">.</span><span class="n">mk</span> <span class="o">(</span><span class="n">ideal</span><span class="bp">.</span><span class="n">span</span> <span class="o">{</span><span class="n">C</span> <span class="err">↑</span><span class="o">(</span><span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))}))</span>

<span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_3</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">,</span>
<span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span>
<span class="err">⊢</span> <span class="n">is_add_monoid_hom</span> <span class="o">(</span><span class="n">ideal</span><span class="bp">.</span><span class="n">quotient</span><span class="bp">.</span><span class="n">mk</span> <span class="o">(</span><span class="n">ideal</span><span class="bp">.</span><span class="n">span</span> <span class="o">{</span><span class="n">C</span> <span class="err">↑</span><span class="o">(</span><span class="n">p</span> <span class="err">^</span> <span class="o">(</span><span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">))}))</span>
</pre></div>


<p>For none of these goals the "obvious" proof works. I.e. no <code>apply_instance</code> or <code>zero_mul</code> etc...</p>



<a name="168378474"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168378474" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168378474">(Jun 18 2019 at 08:06)</a>:</h4>
<p>does rfl work for the first?</p>



<a name="168379641"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168379641" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168379641">(Jun 18 2019 at 08:24)</a>:</h4>
<p>It does. But Johan you can see something is funny about this code. The 20 or so lines of proof of <code>witt_polynomial_mod_pow_p</code> are taking forever to compile on my machine. There is perhaps some gigantic monster term somewhere in there which needs to be tamed, or something is timing out somewhere...</p>



<a name="168379816"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168379816" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168379816">(Jun 18 2019 at 08:27)</a>:</h4>
<div class="codehilite"><pre><span></span>1 goal
p : nat,
n : nat
⊢ @eq.{1}
    (@ideal.quotient.{0}
       (@mv_polynomial.{0 0} nat int
          (@comm_ring.to_comm_semiring.{0} int
             (@nonzero_comm_ring.to_comm_ring.{0} int
                (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))
       (@mv_polynomial.comm_ring.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)
          (λ (a b : int), int.decidable_eq a b)
          (@nonzero_comm_ring.to_comm_ring.{0} int
             (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))
       (@ideal.span.{0}
          (@mv_polynomial.{0 0} nat int
             (@comm_ring.to_comm_semiring.{0} int
                (@nonzero_comm_ring.to_comm_ring.{0} int
                   (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))
          (@mv_polynomial.comm_ring.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)
             (λ (a b : int), int.decidable_eq a b)
             (@nonzero_comm_ring.to_comm_ring.{0} int
                (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))
          (@singleton.{0 0}
             (@mv_polynomial.{0 0} nat int
                (@nonzero_comm_semiring.to_comm_semiring.{0} int
                   (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                      (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))
             (set.{0}
                (@mv_polynomial.{0 0} nat int
                   (@comm_ring.to_comm_semiring.{0} int
                      (@nonzero_comm_ring.to_comm_ring.{0} int
                         (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))
             (@set.has_emptyc.{0}
                (@mv_polynomial.{0 0} nat int
                   (@comm_ring.to_comm_semiring.{0} int
                      (@nonzero_comm_ring.to_comm_ring.{0} int
                         (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))
             (@set.has_insert.{0}
                (@mv_polynomial.{0 0} nat int
                   (@comm_ring.to_comm_semiring.{0} int
                      (@nonzero_comm_ring.to_comm_ring.{0} int
                         (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))
             (@mv_polynomial.C.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)
                (λ (a b : int), int.decidable_eq a b)
                (@nonzero_comm_semiring.to_comm_semiring.{0} int
                   (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                      (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))
                (@coe.{1 1} nat int
                   (@coe_to_lift.{1 1} nat int
                      (@coe_base.{1 1} nat int
                         (@nat.cast_coe.{0} int
                            (@mul_zero_class.to_has_zero.{0} int
                               (@semiring.to_mul_zero_class.{0} int
                                  (@comm_semiring.to_semiring.{0} int
                                     (@nonzero_comm_semiring.to_comm_semiring.{0} int
                                        (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                                           (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))))
                            (@monoid.to_has_one.{0} int
                               (@semiring.to_monoid.{0} int
                                  (@comm_semiring.to_semiring.{0} int
                                     (@nonzero_comm_semiring.to_comm_semiring.{0} int
                                        (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                                           (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))))
                            (@distrib.to_has_add.{0} int
                               (@semiring.to_distrib.{0} int
                                  (@comm_semiring.to_semiring.{0} int
                                     (@nonzero_comm_semiring.to_comm_semiring.{0} int
                                        (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                                           (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))))))
                   (@has_pow.pow.{0 0} nat nat nat.has_pow p
                      (@has_add.add.{0} nat nat.has_add n (@has_one.one.{0} nat nat.has_one))))))))
    (@has_mul.mul.{0}
       (@ideal.quotient.{0}
          (@mv_polynomial.{0 0} nat int
             (@comm_ring.to_comm_semiring.{0} int
                (@nonzero_comm_ring.to_comm_ring.{0} int
                   (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))
          (@mv_polynomial.comm_ring.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)
             (λ (a b : int), int.decidable_eq a b)
             (@nonzero_comm_ring.to_comm_ring.{0} int
                (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))
          (@ideal.span.{0}
             (@mv_polynomial.{0 0} nat int
                (@comm_ring.to_comm_semiring.{0} int
                   (@nonzero_comm_ring.to_comm_ring.{0} int
                      (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))
             (@mv_polynomial.comm_ring.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)
                (λ (a b : int), int.decidable_eq a b)
                (@nonzero_comm_ring.to_comm_ring.{0} int
                   (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))
             (@singleton.{0 0}
                (@mv_polynomial.{0 0} nat int
                   (@nonzero_comm_semiring.to_comm_semiring.{0} int
                      (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                         (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))
                (set.{0}
                   (@mv_polynomial.{0 0} nat int
                      (@comm_ring.to_comm_semiring.{0} int
                         (@nonzero_comm_ring.to_comm_ring.{0} int
                            (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))
                (@set.has_emptyc.{0}
                   (@mv_polynomial.{0 0} nat int
                      (@comm_ring.to_comm_semiring.{0} int
                         (@nonzero_comm_ring.to_comm_ring.{0} int
                            (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))
                (@set.has_insert.{0}
                   (@mv_polynomial.{0 0} nat int
                      (@comm_ring.to_comm_semiring.{0} int
                         (@nonzero_comm_ring.to_comm_ring.{0} int
                            (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))
                (@mv_polynomial.C.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)
                   (λ (a b : int), int.decidable_eq a b)
                   (@nonzero_comm_semiring.to_comm_semiring.{0} int
                      (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                         (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))
                   (@coe.{1 1} nat int
                      (@coe_to_lift.{1 1} nat int
                         (@coe_base.{1 1} nat int
                            (@nat.cast_coe.{0} int
                               (@mul_zero_class.to_has_zero.{0} int
                                  (@semiring.to_mul_zero_class.{0} int
                                     (@comm_semiring.to_semiring.{0} int
                                        (@nonzero_comm_semiring.to_comm_semiring.{0} int
                                           (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                                              (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))))
[many more lines cut]
</pre></div>



<a name="168379924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168379924" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168379924">(Jun 18 2019 at 08:29)</a>:</h4>
<p><a href="https://gist.github.com/kbuzzard/33fe4da55bcc83199306c133f6c4d865" target="_blank" title="https://gist.github.com/kbuzzard/33fe4da55bcc83199306c133f6c4d865">https://gist.github.com/kbuzzard/33fe4da55bcc83199306c133f6c4d865</a> The goal is nearly 1000 lines long. Is this inevitable when dealing with complex algebraic types or is this an indication that something is wrong?</p>



<a name="168379932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168379932" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168379932">(Jun 18 2019 at 08:29)</a>:</h4>
<p>omg we need deduplicating pretty printer so much</p>



<a name="168379996"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168379996" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168379996">(Jun 18 2019 at 08:30)</a>:</h4>
<p>this definitely isn't inevitable in the abstract</p>



<a name="168380009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380009">(Jun 18 2019 at 08:30)</a>:</h4>
<p>not sure how inevitable it is in lean, with the existing typeclass inference mechanism</p>



<a name="168380015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380015" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380015">(Jun 18 2019 at 08:30)</a>:</h4>
<p>This subterm</p>
<div class="codehilite"><pre><span></span>                            (@coe.{1 1} nat int
                               (@coe_to_lift.{1 1} nat int
                                  (@coe_base.{1 1} nat int
                                     (@nat.cast_coe.{0} int
                                        (@mul_zero_class.to_has_zero.{0} int
                                           (@semiring.to_mul_zero_class.{0} int
                                              (@comm_semiring.to_semiring.{0} int
                                                 (@nonzero_comm_semiring.to_comm_semiring.{0} int
                                                    (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                                                       (@euclidean_domain.to_nonzero_comm_ring.{0} int
int.euclidean_domain))))))
</pre></div>


<p>comes up around 10 times.</p>



<a name="168380041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380041">(Jun 18 2019 at 08:31)</a>:</h4>
<p>that's just <code>int.of_nat</code></p>



<a name="168380050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380050">(Jun 18 2019 at 08:31)</a>:</h4>
<p>It's about 10% of the term in terms of lines of output</p>



<a name="168380105"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380105" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380105">(Jun 18 2019 at 08:32)</a>:</h4>
<p>I don't know why it's fixated on <code>int.euclidean_domain</code> for deriving everything</p>



<a name="168380143"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380143" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380143">(Jun 18 2019 at 08:32)</a>:</h4>
<p>I thought the whole point of <code>int.of_nat</code> was that it was some primitive which was supposed to be fast</p>



<a name="168380152"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380152" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380152">(Jun 18 2019 at 08:32)</a>:</h4>
<p>it is</p>



<a name="168380170"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380170" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380170">(Jun 18 2019 at 08:33)</a>:</h4>
<p>but that doesn't stop lean from taking a gratuitous path to get there</p>



<a name="168380189"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380189" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380189">(Jun 18 2019 at 08:33)</a>:</h4>
<div class="codehilite"><pre><span></span>                  (@coe.{1 1} nat int
                      (@coe_to_lift.{1 1} nat int
                         (@coe_base.{1 1} nat int
                            (@nat.cast_coe.{0} int
                               (@mul_zero_class.to_has_zero.{0} int
                                  (@semiring.to_mul_zero_class.{0} int
                                     (@comm_semiring.to_semiring.{0} int
                                        (@nonzero_comm_semiring.to_comm_semiring.{0} int
                                           (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                                              (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))))
                               (@monoid.to_has_one.{0} int
                                  (@semiring.to_monoid.{0} int
                                     (@comm_semiring.to_semiring.{0} int
                                        (@nonzero_comm_semiring.to_comm_semiring.{0} int
                                           (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                                              (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))))
                               (@distrib.to_has_add.{0} int
                                  (@semiring.to_distrib.{0} int
                                     (@comm_semiring.to_semiring.{0} int
                                        (@nonzero_comm_semiring.to_comm_semiring.{0} int
                                           (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int
                                              (@euclidean_domain.to_nonzero_comm_ring.{0} int
int.euclidean_domain)))))))))
</pre></div>


<p>In fact there's something even bigger which is coming up a lot.</p>



<a name="168380247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380247">(Jun 18 2019 at 08:34)</a>:</h4>
<p>oh wait, actually this isn't <code>int.of_nat</code></p>



<a name="168380254"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380254" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380254">(Jun 18 2019 at 08:34)</a>:</h4>
<p>this is the "wrong" coe from nat to int</p>



<a name="168380255"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380255" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380255">(Jun 18 2019 at 08:34)</a>:</h4>
<p><code>nat.cast</code></p>



<a name="168380263"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380263" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380263">(Jun 18 2019 at 08:34)</a>:</h4>
<p>both of them are <code>nat.cast</code></p>



<a name="168380272"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380272" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380272">(Jun 18 2019 at 08:34)</a>:</h4>
<p>try simp?</p>



<a name="168380273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380273">(Jun 18 2019 at 08:34)</a>:</h4>
<div class="codehilite"><pre><span></span>                                  <span class="o">(</span><span class="bp">@</span><span class="n">coe</span><span class="bp">.</span><span class="o">{</span><span class="mi">1</span> <span class="mi">1</span><span class="o">}</span> <span class="n">nat</span> <span class="n">int</span>
                                     <span class="o">(</span><span class="bp">@</span><span class="n">coe_to_lift</span><span class="bp">.</span><span class="o">{</span><span class="mi">1</span> <span class="mi">1</span><span class="o">}</span> <span class="n">nat</span> <span class="n">int</span>
                                        <span class="o">(</span><span class="bp">@</span><span class="n">coe_base</span><span class="bp">.</span><span class="o">{</span><span class="mi">1</span> <span class="mi">1</span><span class="o">}</span> <span class="n">nat</span> <span class="n">int</span>
                                           <span class="o">(</span><span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_coe</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                              <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_class</span><span class="bp">.</span><span class="n">to_has_zero</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                 <span class="o">(</span><span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_mul_zero_class</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                    <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                       <span class="o">(</span><span class="bp">@</span><span class="n">nonzero_comm_semiring</span><span class="bp">.</span><span class="n">to_comm_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                          <span class="o">(</span><span class="bp">@</span><span class="n">nonzero_comm_ring</span><span class="bp">.</span><span class="n">to_nonzero_comm_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                             <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain</span><span class="bp">.</span><span class="n">to_nonzero_comm_ring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                                <span class="n">int</span><span class="bp">.</span><span class="n">euclidean_domain</span><span class="o">))))))</span>
                                              <span class="o">(</span><span class="bp">@</span><span class="n">monoid</span><span class="bp">.</span><span class="n">to_has_one</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                 <span class="o">(</span><span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_monoid</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                    <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                       <span class="o">(</span><span class="bp">@</span><span class="n">nonzero_comm_semiring</span><span class="bp">.</span><span class="n">to_comm_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                          <span class="o">(</span><span class="bp">@</span><span class="n">nonzero_comm_ring</span><span class="bp">.</span><span class="n">to_nonzero_comm_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                             <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain</span><span class="bp">.</span><span class="n">to_nonzero_comm_ring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                                <span class="n">int</span><span class="bp">.</span><span class="n">euclidean_domain</span><span class="o">))))))</span>
                                              <span class="o">(</span><span class="bp">@</span><span class="n">distrib</span><span class="bp">.</span><span class="n">to_has_add</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                 <span class="o">(</span><span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_distrib</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                    <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring</span><span class="bp">.</span><span class="n">to_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                       <span class="o">(</span><span class="bp">@</span><span class="n">nonzero_comm_semiring</span><span class="bp">.</span><span class="n">to_comm_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                          <span class="o">(</span><span class="bp">@</span><span class="n">nonzero_comm_ring</span><span class="bp">.</span><span class="n">to_nonzero_comm_semiring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                             <span class="o">(</span><span class="bp">@</span><span class="n">euclidean_domain</span><span class="bp">.</span><span class="n">to_nonzero_comm_ring</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">int</span>
                                                                <span class="n">int</span><span class="bp">.</span><span class="n">euclidean_domain</span><span class="o">)))))))))</span>
                                     <span class="o">(</span><span class="bp">@</span><span class="n">has_pow</span><span class="bp">.</span><span class="n">pow</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span> <span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat</span> <span class="n">nat</span><span class="bp">.</span><span class="n">has_pow</span> <span class="n">p</span>
                                        <span class="o">(</span><span class="bp">@</span><span class="n">has_add</span><span class="bp">.</span><span class="n">add</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat</span><span class="bp">.</span><span class="n">has_add</span> <span class="n">n</span>
                                           <span class="o">(</span><span class="bp">@</span><span class="n">has_one</span><span class="bp">.</span><span class="n">one</span><span class="bp">.</span><span class="o">{</span><span class="mi">0</span><span class="o">}</span> <span class="n">nat</span> <span class="n">nat</span><span class="bp">.</span><span class="n">has_one</span><span class="o">)))))))))))))</span>
</pre></div>


<p>There's something slightly bigger. This shows up again and again in the term.</p>



<a name="168380297"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380297" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380297">(Jun 18 2019 at 08:35)</a>:</h4>
<blockquote>
<p>try simp?</p>
</blockquote>
<p>[waits 10 seconds] fails to simplify.</p>



<a name="168380496"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380496" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380496">(Jun 18 2019 at 08:38)</a>:</h4>
<p>are there dependencies? What is the pp form of the goal?</p>



<a name="168380538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168380538" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168380538">(Jun 18 2019 at 08:39)</a>:</h4>
<p>The gist I posted above is the pp form of the goal.</p>



<a name="168381467"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168381467" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168381467">(Jun 18 2019 at 08:55)</a>:</h4>
<p>I mean with regular printing</p>



<a name="168381482"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168381482" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168381482">(Jun 18 2019 at 08:56)</a>:</h4>
<p>Sorry, I got distracted by teaching duties... I've tried <code>dsimp</code>, <code>simp</code>, <code>erw</code>, <code>congr</code>, etc... everything times out.</p>



<a name="168381537"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168381537" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168381537">(Jun 18 2019 at 08:56)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="mi">1</span> <span class="n">goal</span>
<span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_3</span> <span class="o">:</span> <span class="n">nat</span><span class="bp">.</span><span class="n">prime</span> <span class="n">p</span><span class="o">,</span>
<span class="n">idx</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u_4</span><span class="o">,</span>
<span class="bp">_</span><span class="n">inst_10</span> <span class="o">:</span> <span class="n">decidable_eq</span> <span class="n">idx</span><span class="o">,</span>
<span class="err">Φ</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">idx</span> <span class="bp">ℤ</span><span class="o">,</span>
<span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">,</span>
<span class="n">IH</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">m</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">m</span> <span class="bp">&lt;</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span> <span class="bp">→</span> <span class="n">map</span> <span class="n">coe</span> <span class="o">(</span><span class="n">witt_structure_int</span> <span class="n">p</span> <span class="err">Φ</span> <span class="n">m</span><span class="o">)</span> <span class="bp">=</span> <span class="n">witt_structure_rat</span> <span class="n">p</span> <span class="o">(</span><span class="n">map</span> <span class="n">coe</span> <span class="err">Φ</span><span class="o">)</span> <span class="n">m</span><span class="o">,</span>
<span class="n">this</span> <span class="o">:</span>
  <span class="n">eval₂</span> <span class="n">C</span> <span class="o">(</span><span class="n">witt_structure_rat</span> <span class="n">p</span> <span class="o">(</span><span class="n">map</span> <span class="n">coe</span> <span class="err">Φ</span><span class="o">))</span> <span class="o">(</span><span class="n">witt_polynomial</span> <span class="n">p</span> <span class="n">n</span><span class="o">)</span> <span class="bp">=</span>
    <span class="n">eval₂</span> <span class="n">C</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">t</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">map</span> <span class="n">coe</span> <span class="o">(</span><span class="n">witt_structure_int</span> <span class="n">p</span> <span class="err">Φ</span> <span class="n">t</span><span class="o">))</span> <span class="o">(</span><span class="n">witt_polynomial</span> <span class="n">p</span> <span class="n">n</span><span class="o">)</span>
<span class="err">⊢</span> <span class="n">eval₂</span> <span class="n">C</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">idx</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">map</span> <span class="n">coe</span> <span class="o">(</span><span class="n">X</span> <span class="n">x</span> <span class="err">^</span> <span class="n">p</span><span class="o">))</span>
      <span class="o">(</span><span class="n">eval₂</span> <span class="n">C</span> <span class="o">(</span><span class="n">witt_structure_rat</span> <span class="n">p</span> <span class="o">(</span><span class="n">map</span> <span class="n">coe</span> <span class="err">Φ</span><span class="o">))</span> <span class="o">(</span><span class="n">witt_polynomial</span> <span class="n">p</span> <span class="n">n</span><span class="o">))</span> <span class="bp">=</span>
    <span class="n">eval₂</span> <span class="n">C</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">idx</span> <span class="bp">×</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">map</span> <span class="n">coe</span> <span class="o">(</span><span class="n">X</span> <span class="n">x</span> <span class="err">^</span> <span class="n">p</span><span class="o">))</span>
      <span class="o">(</span><span class="n">eval₂</span> <span class="n">C</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">t</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">map</span> <span class="n">coe</span> <span class="o">(</span><span class="n">witt_structure_int</span> <span class="n">p</span> <span class="err">Φ</span> <span class="n">t</span><span class="o">))</span> <span class="o">(</span><span class="n">witt_polynomial</span> <span class="n">p</span> <span class="n">n</span><span class="o">))</span>
</pre></div>



<a name="168381546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168381546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168381546">(Jun 18 2019 at 08:56)</a>:</h4>
<p>I posted the other 4 goals somewhere upstairs.</p>



<a name="168381567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168381567" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168381567">(Jun 18 2019 at 08:56)</a>:</h4>
<p>You are right that the first one could be closed by <code>refl</code>. Which is weird, because it was produced by <code>congr</code>, I think.</p>



<a name="168382302"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168382302" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168382302">(Jun 18 2019 at 09:10)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I feel like I'm bitten by having to work explicitly with integers. But that cannot be avoided. It's crucial to show that these polynomials are defined over <code>int</code>, because <code>int</code> is the initial object in <code>CommRing</code>. And one cannot simply write down these polynomials over an arbitrary ring. Their coefficients are rational numbers that after a lot of work turn out to actually be integers.</p>



<a name="168382313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168382313" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168382313">(Jun 18 2019 at 09:11)</a>:</h4>
<p>I have no idea how to make the code faster, more well-behaved.</p>



<a name="168382803"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168382803" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168382803">(Jun 18 2019 at 09:19)</a>:</h4>
<p><code>mod_e</code> should be a definition</p>



<a name="168382881"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168382881" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168382881">(Jun 18 2019 at 09:20)</a>:</h4>
<p>Can you explain why?</p>



<a name="168382923"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168382923" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168382923">(Jun 18 2019 at 09:21)</a>:</h4>
<p>you should not make a notation for a very complex term. This increases the difference between what you see and what lean sees</p>



<a name="168382925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168382925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168382925">(Jun 18 2019 at 09:21)</a>:</h4>
<p>Do you think it is a reasonable "concept" or is there a better way to do "calculations modulo [ideal/element]"</p>



<a name="168382944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168382944" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168382944">(Jun 18 2019 at 09:21)</a>:</h4>
<p>You could use an equivalence relation</p>



<a name="168383010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383010" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383010">(Jun 18 2019 at 09:22)</a>:</h4>
<p>but I don't know if I should tweak the mathematics aspects too heavily</p>



<a name="168383022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383022">(Jun 18 2019 at 09:22)</a>:</h4>
<p>if you need ideals, so be it</p>



<a name="168383069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383069">(Jun 18 2019 at 09:23)</a>:</h4>
<p>I think it should be a general definition though; <code>a = b [MOD n]</code> should be generalized</p>



<a name="168383147"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383147" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383147">(Jun 18 2019 at 09:24)</a>:</h4>
<blockquote>
<p>I think it should be a general definition though; <code>a = b [MOD n]</code> should be generalized</p>
</blockquote>
<p>You mean from <code>ℤ</code> to an arbitrary ring?</p>



<a name="168383169"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383169" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383169">(Jun 18 2019 at 09:24)</a>:</h4>
<p>yes</p>



<a name="168383175"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383175" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383175">(Jun 18 2019 at 09:24)</a>:</h4>
<p>and possibly to ideals</p>



<a name="168383189"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383189" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383189">(Jun 18 2019 at 09:25)</a>:</h4>
<p>I see you needed a few variations on this</p>



<a name="168383270"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383270" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383270">(Jun 18 2019 at 09:26)</a>:</h4>
<p>Do you think that <code>mod_e</code> is one of the reasons that the file is slow?</p>



<a name="168383303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383303" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383303">(Jun 18 2019 at 09:26)</a>:</h4>
<p>it's a factor in the huge pp.all terms</p>



<a name="168383320"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383320" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383320">(Jun 18 2019 at 09:26)</a>:</h4>
<p>because <code>mod_e</code> hides an <code>ideal.span</code> and <code>quotient.mk</code> and each of these takes a bunch of typeclass args</p>



<a name="168383329"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383329" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383329">(Jun 18 2019 at 09:27)</a>:</h4>
<p>But <code>blur</code> doesn't even use it. And there the <code>rw this</code> still fails... <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="168383351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383351">(Jun 18 2019 at 09:27)</a>:</h4>
<p>where do you start sensing problems?</p>



<a name="168383373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383373" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383373">(Jun 18 2019 at 09:27)</a>:</h4>
<p>Should we also build <code>eval_c</code> which is <code>eval₂ C</code>? I'm using <code>eval₂ C</code> a lot.</p>



<a name="168383435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383435" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383435">(Jun 18 2019 at 09:28)</a>:</h4>
<p>I noticed</p>



<a name="168383440"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383440" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383440">(Jun 18 2019 at 09:28)</a>:</h4>
<p><code>witt_structure_rat_rec_aux</code> is slow</p>



<a name="168383444"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383444" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383444">(Jun 18 2019 at 09:28)</a>:</h4>
<p>I thought that this was one of the eval functions</p>



<a name="168383476"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383476" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383476">(Jun 18 2019 at 09:29)</a>:</h4>
<p>And <code>dvd_sub_pow_of_dvd_sub</code> is also incredibly slow, but I think that's completely orthogonal to the others.</p>



<a name="168383572"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383572" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383572">(Jun 18 2019 at 09:30)</a>:</h4>
<p>Lines 554–735 are very slow. And that's exactly the part that is hard for mathematicians. The rest is all "math-trivial".</p>



<a name="168383596"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383596" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383596">(Jun 18 2019 at 09:30)</a>:</h4>
<p>It is the part where we show that the polynomials have integral coefficients. It takes most textbooks half a page <span aria-label="shock" class="emoji emoji-1f628" role="img" title="shock">:shock:</span></p>



<a name="168383698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383698" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383698">(Jun 18 2019 at 09:32)</a>:</h4>
<blockquote>
<p>I thought that this was one of the eval functions</p>
</blockquote>
<p>No, we don't have a wrapper for <code>eval₂ C</code>.</p>



<a name="168383940"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168383940" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168383940">(Jun 18 2019 at 09:35)</a>:</h4>
<p>Is it the bind operation for mv_polynomial as a monad that you're using?</p>



<a name="168385933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168385933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168385933">(Jun 18 2019 at 10:01)</a>:</h4>
<p>I think it is, yes.</p>



<a name="168396534"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168396534" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168396534">(Jun 18 2019 at 12:45)</a>:</h4>
<p>Well, it's not exactly <code>bind</code>. Because I think:</p>
<div class="codehilite"><pre><span></span><span class="n">bind</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="o">(</span><span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">R</span><span class="o">)</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">R</span>
</pre></div>


<p>whereas</p>
<div class="codehilite"><pre><span></span><span class="n">eval₂</span> <span class="n">C</span> <span class="o">:</span> <span class="o">(</span><span class="n">σ</span> <span class="bp">→</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">R</span><span class="o">)</span> <span class="bp">→</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">R</span> <span class="bp">→</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">R</span>
</pre></div>



<a name="168396855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168396855" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168396855">(Jun 18 2019 at 12:49)</a>:</h4>
<p>It is exactly <code>bind</code>. You're thinking of <code>join</code></p>



<a name="168396858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168396858" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168396858">(Jun 18 2019 at 12:49)</a>:</h4>
<p>Aah...</p>



<a name="168396867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168396867" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168396867">(Jun 18 2019 at 12:49)</a>:</h4>
<p>Crazy names</p>



<a name="168396875"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168396875" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168396875">(Jun 18 2019 at 12:49)</a>:</h4>
<p>(Or actually it's <code>bind</code> with the arguments flipped)</p>



<a name="168397001"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168397001" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168397001">(Jun 18 2019 at 12:51)</a>:</h4>
<p>The idea is you are binding the result of the non-function argument to the input variable of the function argument</p>



<a name="168397011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168397011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168397011">(Jun 18 2019 at 12:51)</a>:</h4>
<p><code>join</code> joins two layers of the monad</p>



<a name="168397204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168397204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168397204">(Jun 18 2019 at 12:53)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Does this mean we should define <code>bind</code> and <code>join</code> and prove a whole bunch of API about them?</p>



<a name="168397278"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168397278" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168397278">(Jun 18 2019 at 12:54)</a>:</h4>
<p>sure</p>



<a name="168397308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168397308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168397308">(Jun 18 2019 at 12:54)</a>:</h4>
<p>Are there other ways in which I can make my code workable?</p>



<a name="168397309"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168397309" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168397309">(Jun 18 2019 at 12:54)</a>:</h4>
<p><code>bind</code> or <code>join</code> - they are interdefinable</p>



<a name="168397325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168397325" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168397325">(Jun 18 2019 at 12:55)</a>:</h4>
<p>They are all special cases of <code>eval₂</code></p>



<a name="168397448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168397448" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168397448">(Jun 18 2019 at 12:56)</a>:</h4>
<p>I don't think this will do that much to solve the problem, but it seems like a nice definition</p>



<a name="168397524"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168397524" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168397524">(Jun 18 2019 at 12:57)</a>:</h4>
<p>But I also don't think <code>mod_e</code> is the main culprit. The code is also slow in parts where I don't use that.</p>



<a name="168401087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168401087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168401087">(Jun 18 2019 at 13:36)</a>:</h4>
<p>Okay, so here's a minimized version of the first suspiciously slow tactic, on <a href="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L301" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L301">L301</a>:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast</span> <span class="n">algebra</span><span class="bp">.</span><span class="n">group_power</span>

<span class="kn">lemma</span> <span class="n">foo</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span>
  <span class="o">(</span><span class="n">P</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span>
  <span class="o">(</span><span class="n">hc</span> <span class="o">:</span> <span class="n">P</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span>
    <span class="o">(</span><span class="bp">@</span><span class="n">coe</span> <span class="n">nat</span> <span class="n">α</span>
      <span class="o">(</span><span class="bp">@</span><span class="n">coe_to_lift</span> <span class="n">nat</span> <span class="n">α</span>
        <span class="o">(</span><span class="bp">@</span><span class="n">coe_base</span> <span class="n">nat</span> <span class="n">α</span>
          <span class="o">(</span><span class="bp">@</span><span class="n">nat</span><span class="bp">.</span><span class="n">cast_coe</span> <span class="n">α</span>
            <span class="o">(</span><span class="bp">@</span><span class="n">mul_zero_class</span><span class="bp">.</span><span class="n">to_has_zero</span> <span class="n">α</span>
              <span class="o">(</span><span class="bp">@</span><span class="n">semiring</span><span class="bp">.</span><span class="n">to_mul_zero_class</span> <span class="n">α</span>
                  <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="o">)))</span>
            <span class="bp">_</span> <span class="bp">_</span><span class="o">)))</span>
      <span class="n">p</span><span class="o">)))</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">try_for</span> <span class="mi">10000</span> <span class="o">{</span><span class="n">simp</span> <span class="n">only</span> <span class="n">at</span> <span class="n">hc</span><span class="o">}</span><span class="bp">;</span> <span class="n">sorry</span>
</pre></div>



<a name="168403526"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168403526" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168403526">(Jun 18 2019 at 14:00)</a>:</h4>
<p>The profiler says all the time (about 22s) is spent in <code>mk_eq_mp</code>. Here's a minimized tactic from the core of <code>simp</code> that triggers the long running <code>mk_eq_mp</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">by</span> <span class="n">do</span>
  <span class="n">h</span> <span class="err">←</span> <span class="n">get_local</span> <span class="bp">`</span><span class="n">hc</span><span class="o">,</span>
  <span class="n">h_type</span> <span class="err">←</span> <span class="n">infer_type</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">pr&#39;</span> <span class="err">←</span> <span class="n">mk_app</span> <span class="bp">`</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="o">[</span><span class="n">h_type</span><span class="o">],</span>
  <span class="o">(</span><span class="bp">_</span><span class="o">,</span> <span class="n">pr</span><span class="o">)</span> <span class="err">←</span> <span class="n">simplify</span> <span class="n">simp_lemmas</span><span class="bp">.</span><span class="n">mk</span> <span class="o">[]</span> <span class="n">h_type</span> <span class="o">{}</span> <span class="bp">`</span><span class="n">eq</span> <span class="n">failed</span><span class="o">,</span>
  <span class="n">trace</span> <span class="n">pr&#39;</span><span class="o">,</span> <span class="n">trace</span> <span class="n">pr</span><span class="o">,</span> <span class="n">trace</span> <span class="n">h</span><span class="o">,</span>
  <span class="n">mk_eq_mp</span> <span class="n">pr</span> <span class="n">h</span>
</pre></div>


<p>Replacing <code>pr</code> with the identical hand-rolled proof <code>pr'</code> takes no time at all. Perhaps metavariable instantiations are involved?</p>



<a name="168404475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168404475" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168404475">(Jun 18 2019 at 14:10)</a>:</h4>
<p>I am totally lost at how you debug these things. The particular lemma that contains L301 seems very innocent. No weird universes or whatever.</p>



<a name="168404522"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168404522" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168404522">(Jun 18 2019 at 14:11)</a>:</h4>
<p><code>mk_eq_mp</code> is defined in terms of <code>mk_app</code>, which is also slow along with <code>mk_mapp</code>. Even this is long running:</p>
<div class="codehilite"><pre><span></span><span class="n">mk_mapp</span> <span class="bp">`</span><span class="n">eq</span><span class="bp">.</span><span class="n">mp</span> <span class="o">[</span><span class="n">h_type</span><span class="o">,</span> <span class="n">h_type</span><span class="o">,</span> <span class="n">pr</span><span class="o">,</span> <span class="n">h</span><span class="o">]</span>
</pre></div>


<p>It's not doing any inference! It's just typechecking</p>



<a name="168404605"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168404605" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168404605">(Jun 18 2019 at 14:12)</a>:</h4>
<p>I debug this by finding the part that is slow and then delete everything that doesn't matter until almost nothing is left</p>



<a name="168404676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168404676" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168404676">(Jun 18 2019 at 14:13)</a>:</h4>
<p>Is there an obvious code smell, if you look at that proof?</p>



<a name="168404731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168404731" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168404731">(Jun 18 2019 at 14:14)</a>:</h4>
<p>I'm still at the stage where I figure out why lean is stupid. Once I have that I can probably derive an appropriate code smell</p>



<a name="168404814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168404814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168404814">(Jun 18 2019 at 14:14)</a>:</h4>
<p>I'm sure I've hit this bug before but I haven't investigated it in depth</p>



<a name="168404851"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168404851" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168404851">(Jun 18 2019 at 14:15)</a>:</h4>
<p>the operative aspect here seems to be a slightly noncanonical typeclass path</p>



<a name="168404870"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168404870" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168404870">(Jun 18 2019 at 14:15)</a>:</h4>
<p>Thanks a lot for taking a look. I'm completely handicapped when it comes to debugging things like this. And I'm glad your thinking that Lean is stupid, instead of me being stupid <span aria-label="stuck out tongue wink" class="emoji emoji-1f61c" role="img" title="stuck out tongue wink">:stuck_out_tongue_wink:</span></p>



<a name="168404984"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168404984" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168404984">(Jun 18 2019 at 14:16)</a>:</h4>
<p>Feel free to push speed-ups upstream by the way.</p>



<a name="168405056"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168405056" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168405056">(Jun 18 2019 at 14:17)</a>:</h4>
<p>I don't know how useful adding workarounds on every line will be. I suspect that this issue comes up many many times in the file and that's the major problem</p>



<a name="168405090"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168405090" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168405090">(Jun 18 2019 at 14:17)</a>:</h4>
<p>Ok</p>



<a name="168405144"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168405144" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168405144">(Jun 18 2019 at 14:18)</a>:</h4>
<p>Feel free to push structural speed-ups upstream <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="168407094"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168407094" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168407094">(Jun 18 2019 at 14:39)</a>:</h4>
<p>Okay, it's completely barebones now. The problem arises when <code>mk_app</code> and friends are passed a non-canonical instance and asked to unify the results. <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Do you know what's happening here?</p>
<div class="codehilite"><pre><span></span><span class="kn">set_option</span> <span class="n">profiler</span> <span class="n">true</span>
<span class="kn">open</span> <span class="n">tactic</span>

<span class="n">def</span> <span class="n">bar</span> <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">[</span><span class="n">semiring</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">α</span> <span class="o">:=</span> <span class="n">sorry</span>

<span class="kn">lemma</span> <span class="n">foo</span> <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span>
  <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">bar</span> <span class="n">α</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">bar</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="o">))</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">do</span>
  <span class="n">h</span> <span class="err">←</span> <span class="n">get_local</span> <span class="bp">`</span><span class="n">h</span><span class="o">,</span>
  <span class="n">ht</span> <span class="err">←</span> <span class="n">infer_type</span> <span class="n">h</span><span class="o">,</span>
  <span class="bp">`</span><span class="o">(</span><span class="err">%%</span><span class="n">h1</span> <span class="bp">=</span> <span class="err">%%</span><span class="n">h2</span><span class="o">)</span> <span class="err">←</span> <span class="n">return</span> <span class="n">ht</span><span class="o">,</span>
  <span class="n">ht&#39;</span> <span class="err">←</span> <span class="n">to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="err">%%</span><span class="n">h2</span> <span class="bp">=</span> <span class="err">%%</span><span class="n">h2</span><span class="o">),</span>
  <span class="n">pr</span> <span class="err">←</span> <span class="n">mk_app</span> <span class="bp">`</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="o">[</span><span class="n">ht</span><span class="o">],</span>
  <span class="n">pr&#39;</span> <span class="err">←</span> <span class="n">mk_app</span> <span class="bp">`</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="o">[</span><span class="n">ht&#39;</span><span class="o">],</span>
  <span class="n">trace</span> <span class="o">[</span><span class="n">ht</span><span class="o">,</span> <span class="n">ht</span><span class="o">,</span> <span class="n">pr&#39;</span><span class="o">,</span> <span class="n">h</span><span class="o">],</span>
  <span class="n">mk_mapp</span> <span class="bp">`</span><span class="n">eq</span><span class="bp">.</span><span class="n">mp</span> <span class="o">[</span><span class="n">ht</span><span class="o">,</span> <span class="n">ht</span><span class="o">,</span> <span class="n">pr&#39;</span><span class="o">,</span> <span class="n">h</span><span class="o">]</span> <span class="c1">-- takes 23s</span>
</pre></div>



<a name="168407212"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168407212" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168407212">(Jun 18 2019 at 14:40)</a>:</h4>
<p>What is <code>P</code> doing in your example?</p>



<a name="168407501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168407501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168407501">(Jun 18 2019 at 14:43)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Thanks a lot for stripping this down to a MWE. I would have never managed to do that.</p>



<a name="168407546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168407546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168407546">(Jun 18 2019 at 14:43)</a>:</h4>
<p>oops, don't need P</p>



<a name="168408145"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168408145" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168408145">(Jun 18 2019 at 14:50)</a>:</h4>
<p>Mario, if you're in a debugging mood, chasing stupid Lean behavior, you might have fun looking at <a href="https://github.com/leanprover-community/mathlib/blob/d8d25e9adb01c87c355ae1358bba431c1237e2eb/src/analysis/normed_space/operator_norm.lean#L211" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/d8d25e9adb01c87c355ae1358bba431c1237e2eb/src/analysis/normed_space/operator_norm.lean#L211">https://github.com/leanprover-community/mathlib/blob/d8d25e9adb01c87c355ae1358bba431c1237e2eb/src/analysis/normed_space/operator_norm.lean#L211</a> (that I already mentioned some time ago, but it was in a private branch then): it looks really strange to me that Lean is not able to infer the instance.</p>



<a name="168415168"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168415168" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168415168">(Jun 18 2019 at 16:00)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> No idea. Does the defeq trace show something interesting, or does that blow up Lean?</p>



<a name="168449670"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168449670" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168449670">(Jun 18 2019 at 19:57)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Do I understand correctly that it's not actually type class inference that is creating the problem? Lean should check that certain things are defeq, but it doesn't try hard enough. Is that right?</p>



<a name="168451494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168451494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168451494">(Jun 18 2019 at 20:17)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Aha, it does show something interesting:</p>
<div class="codehilite"><pre><span></span><span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">5</span><span class="o">]:</span> <span class="o">{</span><span class="n">add</span> <span class="o">:=</span> <span class="n">ring</span><span class="bp">.</span><span class="n">add</span> <span class="o">(</span><span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_ring</span> <span class="n">α</span><span class="o">),</span>
 <span class="n">add_assoc</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">zero</span> <span class="o">:=</span> <span class="n">ring</span><span class="bp">.</span><span class="n">zero</span> <span class="n">α</span> <span class="o">(</span><span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_ring</span> <span class="n">α</span><span class="o">),</span>
 <span class="n">zero_add</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">add_zero</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">add_comm</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">mul</span> <span class="o">:=</span> <span class="n">ring</span><span class="bp">.</span><span class="n">mul</span> <span class="o">(</span><span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_ring</span> <span class="n">α</span><span class="o">),</span>
 <span class="n">mul_assoc</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">one</span> <span class="o">:=</span> <span class="n">ring</span><span class="bp">.</span><span class="n">one</span> <span class="n">α</span> <span class="o">(</span><span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_ring</span> <span class="n">α</span><span class="o">),</span>
 <span class="n">one_mul</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">mul_one</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">left_distrib</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">right_distrib</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">zero_mul</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">mul_zero</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">}</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="o">{</span><span class="n">add</span> <span class="o">:=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">add</span> <span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_comm_semiring</span><span class="o">,</span>
 <span class="n">add_assoc</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">zero</span> <span class="o">:=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">zero</span> <span class="n">α</span> <span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_comm_semiring</span><span class="o">,</span>
 <span class="n">zero_add</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">add_zero</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">add_comm</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">mul</span> <span class="o">:=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">mul</span> <span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_comm_semiring</span><span class="o">,</span>
 <span class="n">mul_assoc</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">one</span> <span class="o">:=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">one</span> <span class="n">α</span> <span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_comm_semiring</span><span class="o">,</span>
 <span class="n">one_mul</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">mul_one</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">left_distrib</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">right_distrib</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">zero_mul</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">,</span>
 <span class="n">mul_zero</span> <span class="o">:=</span> <span class="bp">_</span><span class="o">}</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">add</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">add</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">add_assoc</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">add_assoc</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">zero</span> <span class="n">α</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">zero</span> <span class="n">α</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">zero_add</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">zero_add</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">add_zero</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">add_zero</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">add_comm</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">add_comm</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">mul</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">mul</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">mul_assoc</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">mul_assoc</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">one</span> <span class="n">α</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">one</span> <span class="n">α</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">one_mul</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">one_mul</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">mul_one</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">mul_one</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">left_distrib</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">left_distrib</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">right_distrib</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">right_distrib</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">6</span><span class="o">]:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">zero_mul</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">zero_mul</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">left</span><span class="o">:</span> <span class="n">ring</span><span class="bp">.</span><span class="n">zero_mul</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">7</span><span class="o">]:</span> <span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span>
  <span class="k">have</span> <span class="n">this</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">,</span> <span class="k">from</span>
    <span class="n">eq</span><span class="bp">.</span><span class="n">trans</span>
      <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">mpr</span>
         <span class="o">(</span><span class="n">id</span>
            <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">trans</span>
               <span class="o">((</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="n">a_1</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">e_1</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a_1</span><span class="o">)</span> <span class="o">(</span><span class="n">a_2</span> <span class="n">a_3</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">e_2</span> <span class="o">:</span> <span class="n">a_2</span> <span class="bp">=</span> <span class="n">a_3</span><span class="o">),</span> <span class="n">congr</span> <span class="o">(</span><span class="n">congr_arg</span> <span class="n">eq</span> <span class="n">e_1</span><span class="o">)</span> <span class="n">e_2</span><span class="o">)</span>
                  <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span><span class="o">)</span>
                  <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">)</span>
                  <span class="o">(</span><span class="n">add_zero</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">))</span>
                  <span class="o">((</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">0</span><span class="o">)</span> <span class="bp">*</span> <span class="n">a</span><span class="o">)</span>
                  <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">)</span>
                  <span class="o">((</span><span class="bp">λ</span> <span class="o">[</span><span class="n">c</span> <span class="o">:</span> <span class="n">has_mul</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="n">a_1</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">e_2</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a_1</span><span class="o">)</span> <span class="o">(</span><span class="n">a_2</span> <span class="n">a_3</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">e_3</span> <span class="o">:</span> <span class="n">a_2</span> <span class="bp">=</span> <span class="n">a_3</span><span class="o">),</span>
                      <span class="n">congr</span> <span class="o">(</span><span class="n">congr_arg</span> <span class="n">has_mul</span><span class="bp">.</span><span class="n">mul</span> <span class="n">e_2</span><span class="o">)</span> <span class="n">e_3</span><span class="o">)</span>
                     <span class="o">(</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">0</span><span class="o">)</span>
                     <span class="mi">0</span>
                     <span class="o">(</span><span class="n">add_zero</span> <span class="mi">0</span><span class="o">)</span>
                     <span class="n">a</span>
                     <span class="n">a</span>
                     <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="n">a</span><span class="o">)))</span>
               <span class="o">(</span><span class="n">propext</span> <span class="o">(</span><span class="n">eq_self_iff_true</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">)))))</span>
         <span class="n">trivial</span><span class="o">)</span>
      <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">mpr</span> <span class="o">(</span><span class="n">id</span> <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">rec</span> <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="o">((</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">0</span><span class="o">)</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">))</span> <span class="o">(</span><span class="n">right_distrib</span> <span class="mi">0</span> <span class="mi">0</span> <span class="n">a</span><span class="o">)))</span> <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">))),</span>
  <span class="k">show</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="k">from</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">add_left_cancel</span> <span class="n">this</span><span class="o">)</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_semiring</span><span class="bp">.</span><span class="n">zero_mul</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="o">[</span><span class="mi">8</span><span class="o">]:</span> <span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">),</span>
  <span class="k">have</span> <span class="n">this</span> <span class="o">:</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">,</span> <span class="k">from</span>
    <span class="n">eq</span><span class="bp">.</span><span class="n">trans</span>
      <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">mpr</span>
         <span class="o">(</span><span class="n">id</span>
            <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">trans</span>
               <span class="o">((</span><span class="bp">λ</span> <span class="o">(</span><span class="n">a</span> <span class="n">a_1</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">e_1</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a_1</span><span class="o">)</span> <span class="o">(</span><span class="n">a_2</span> <span class="n">a_3</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">e_2</span> <span class="o">:</span> <span class="n">a_2</span> <span class="bp">=</span> <span class="n">a_3</span><span class="o">),</span> <span class="n">congr</span> <span class="o">(</span><span class="n">congr_arg</span> <span class="n">eq</span> <span class="n">e_1</span><span class="o">)</span> <span class="n">e_2</span><span class="o">)</span>
                  <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span><span class="o">)</span>
                  <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">)</span>
                  <span class="o">(</span><span class="n">add_zero</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">))</span>
                  <span class="o">((</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">0</span><span class="o">)</span> <span class="bp">*</span> <span class="n">a</span><span class="o">)</span>
                  <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">)</span>
                  <span class="o">((</span><span class="bp">λ</span> <span class="o">[</span><span class="n">c</span> <span class="o">:</span> <span class="n">has_mul</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="n">a_1</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">e_2</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a_1</span><span class="o">)</span> <span class="o">(</span><span class="n">a_2</span> <span class="n">a_3</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">e_3</span> <span class="o">:</span> <span class="n">a_2</span> <span class="bp">=</span> <span class="n">a_3</span><span class="o">),</span>
                      <span class="n">congr</span> <span class="o">(</span><span class="n">congr_arg</span> <span class="n">has_mul</span><span class="bp">.</span><span class="n">mul</span> <span class="n">e_2</span><span class="o">)</span> <span class="n">e_3</span><span class="o">)</span>
                     <span class="o">(</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">0</span><span class="o">)</span>
                     <span class="mi">0</span>
                     <span class="o">(</span><span class="n">add_zero</span> <span class="mi">0</span><span class="o">)</span>
                     <span class="n">a</span>
                     <span class="n">a</span>
                     <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="n">a</span><span class="o">)))</span>
               <span class="o">(</span><span class="n">propext</span> <span class="o">(</span><span class="n">eq_self_iff_true</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">)))))</span>
         <span class="n">trivial</span><span class="o">)</span>
      <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">mpr</span> <span class="o">(</span><span class="n">id</span> <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">rec</span> <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="o">((</span><span class="mi">0</span> <span class="bp">+</span> <span class="mi">0</span><span class="o">)</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">))</span> <span class="o">(</span><span class="n">right_distrib</span> <span class="mi">0</span> <span class="mi">0</span> <span class="n">a</span><span class="o">)))</span> <span class="o">(</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span><span class="o">))),</span>
  <span class="k">show</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span> <span class="k">from</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">add_left_cancel</span> <span class="n">this</span><span class="o">)</span> <span class="bp">=</span><span class="err">?</span><span class="bp">=</span> <span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_comm_semiring</span><span class="bp">._</span><span class="n">proof_1</span>
<span class="o">[</span><span class="n">type_context</span><span class="bp">.</span><span class="n">is_def_eq_detail</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">right</span><span class="o">:</span> <span class="n">comm_ring</span><span class="bp">.</span><span class="n">to_comm_semiring</span><span class="bp">._</span><span class="n">proof_1</span>
<span class="bp">...</span>
</pre></div>


<p>The trace goes for a very long time, but I think this is the important part. It needs to solve <code>@ring.to_semiring α (@comm_ring.to_ring α _inst_1) =?= @comm_semiring.to_semiring α (@comm_ring.to_comm_semiring α _inst_1)</code>, so it unfolds both structures, so far so good. It starts confirming each of the fields is equal, until it hits <code>ring.zero_mul =?= comm_semiring.zero_mul</code>, whereupon it decides to unfold both proofs and the subproofs and so on with no end in sight.</p>



<a name="168483774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168483774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168483774">(Jun 19 2019 at 07:35)</a>:</h4>
<p>Can anyone explain to me how this can happen? I thought that proofs were discarded right away, and that in any case they are irrelevant so that Lean should never have to check that two proofs are the same. Does it mean that there is a bug in Lean where in some exotic situations proof irrelevance is not used while it should?</p>



<a name="168484215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168484215" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168484215">(Jun 19 2019 at 07:42)</a>:</h4>
<p>proofs are not discarded, but under almost all circumstances defeq problems involving them are trivial</p>



<a name="168484243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168484243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168484243">(Jun 19 2019 at 07:42)</a>:</h4>
<p>I think there is a bug in lean somewhere here</p>



<a name="168485596"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168485596" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168485596">(Jun 19 2019 at 08:04)</a>:</h4>
<p>Can this be debugged further inside Lean, or is the next step to run lean in some debugger like <code>gdb</code>?</p>



<a name="168485769"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168485769" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168485769">(Jun 19 2019 at 08:06)</a>:</h4>
<p>it goes to C++ from here</p>



<a name="168485785"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168485785" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168485785">(Jun 19 2019 at 08:06)</a>:</h4>
<p>we have to find out why the defeq trace is going into proof terms</p>



<a name="168764526"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168764526" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168764526">(Jun 22 2019 at 20:41)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Do you think the issues in this file can be reasonable fixed with some version of Lean 3? Or will we not have Witt vectors before Lean 4? (That is certainly an acceptable answer to me.)</p>



<a name="168958570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168958570" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168958570">(Jun 25 2019 at 17:29)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Just to get expectations right. Is there any hope/reason to investigate these issues in Lean 3? Or should we just wait till Lean 4?</p>



<a name="168958645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/168958645" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#168958645">(Jun 25 2019 at 17:30)</a>:</h4>
<p>More specifically, will Lean 3 have Witt vectors, or should I give up?</p>



<a name="169124238"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/169124238" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#169124238">(Jun 27 2019 at 11:05)</a>:</h4>
<p><span class="user-mention" data-user-id="112680">@Johan Commelin</span> <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Okay, I took a look at this issue and found the following nice comment: <a href="https://github.com/leanprover/lean/blob/e6764047a14ce4383d29b2858fa9e2e246d4f13b/src/library/type_context.cpp#L1978" target="_blank" title="https://github.com/leanprover/lean/blob/e6764047a14ce4383d29b2858fa9e2e246d4f13b/src/library/type_context.cpp#L1978">https://github.com/leanprover/lean/blob/e6764047a14ce4383d29b2858fa9e2e246d4f13b/src/library/type_context.cpp#L1978</a><br>
It looks like Leo independently found a performance issue with this code and fixed it for Lean 4: <a href="https://github.com/kha/lean4/commit/d85c30fde186b75dd00e04242fb8b05450a8daf8#diff-f56a907e917690c6815e55e0fe8540e9R798" target="_blank" title="https://github.com/kha/lean4/commit/d85c30fde186b75dd00e04242fb8b05450a8daf8#diff-f56a907e917690c6815e55e0fe8540e9R798">https://github.com/kha/lean4/commit/d85c30fde186b75dd00e04242fb8b05450a8daf8#diff-f56a907e917690c6815e55e0fe8540e9R798</a><br>
You could try porting it to Lean 3 (using this version: <a href="https://github.com/kha/lean4/commit/f8cedb33e70c9d90c9d81a542340bba0b504f8e6" target="_blank" title="https://github.com/kha/lean4/commit/f8cedb33e70c9d90c9d81a542340bba0b504f8e6">https://github.com/kha/lean4/commit/f8cedb33e70c9d90c9d81a542340bba0b504f8e6</a>), would be interesting to see if anything breaks. But I don't think it can be worked around without changing Lean.</p>



<a name="169124744"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/169124744" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#169124744">(Jun 27 2019 at 11:14)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Thanks for looking into this!</p>



<a name="169128149"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/169128149" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#169128149">(Jun 27 2019 at 12:08)</a>:</h4>
<p>Yes, many thanks Sebastian.</p>



<a name="196093021"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196093021" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196093021">(May 03 2020 at 09:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/116395-maths/topic/witt.20vectors/near/168407094" title="#narrow/stream/116395-maths/topic/witt.20vectors/near/168407094">said</a>:</p>
<blockquote>
<p>Okay, it's completely barebones now. The problem arises when <code>mk_app</code> and friends are passed a non-canonical instance and asked to unify the results. <span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> Do you know what's happening here?</p>
<div class="codehilite"><pre><span></span><code><span class="kn">set_option</span> <span class="n">profiler</span> <span class="n">true</span>
<span class="kn">open</span> <span class="n">tactic</span>

<span class="n">def</span> <span class="n">bar</span> <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">[</span><span class="n">semiring</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">α</span> <span class="o">:=</span> <span class="n">sorry</span>

<span class="kn">lemma</span> <span class="n">foo</span> <span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span>
  <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">bar</span> <span class="n">α</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">bar</span> <span class="n">α</span> <span class="o">(</span><span class="bp">@</span><span class="n">comm_semiring</span><span class="bp">.</span><span class="n">to_semiring</span> <span class="n">α</span> <span class="bp">_</span><span class="o">))</span> <span class="o">:</span> <span class="n">true</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">do</span>
  <span class="n">h</span> <span class="err">←</span> <span class="n">get_local</span> <span class="bp">`</span><span class="n">h</span><span class="o">,</span>
  <span class="n">ht</span> <span class="err">←</span> <span class="n">infer_type</span> <span class="n">h</span><span class="o">,</span>
  <span class="bp">`</span><span class="o">(</span><span class="err">%%</span><span class="n">h1</span> <span class="bp">=</span> <span class="err">%%</span><span class="n">h2</span><span class="o">)</span> <span class="err">←</span> <span class="n">return</span> <span class="n">ht</span><span class="o">,</span>
  <span class="n">ht&#39;</span> <span class="err">←</span> <span class="n">to_expr</span> <span class="bp">``</span><span class="o">(</span><span class="err">%%</span><span class="n">h2</span> <span class="bp">=</span> <span class="err">%%</span><span class="n">h2</span><span class="o">),</span>
  <span class="n">pr</span> <span class="err">←</span> <span class="n">mk_app</span> <span class="bp">`</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="o">[</span><span class="n">ht</span><span class="o">],</span>
  <span class="n">pr&#39;</span> <span class="err">←</span> <span class="n">mk_app</span> <span class="bp">`</span><span class="n">eq</span><span class="bp">.</span><span class="n">refl</span> <span class="o">[</span><span class="n">ht&#39;</span><span class="o">],</span>
  <span class="n">trace</span> <span class="o">[</span><span class="n">ht</span><span class="o">,</span> <span class="n">ht</span><span class="o">,</span> <span class="n">pr&#39;</span><span class="o">,</span> <span class="n">h</span><span class="o">],</span>
  <span class="n">mk_mapp</span> <span class="bp">`</span><span class="n">eq</span><span class="bp">.</span><span class="n">mp</span> <span class="o">[</span><span class="n">ht</span><span class="o">,</span> <span class="n">ht</span><span class="o">,</span> <span class="n">pr&#39;</span><span class="o">,</span> <span class="n">h</span><span class="o">]</span> <span class="c1">-- takes 23s</span>
</code></pre></div>


</blockquote>
<p>Now that we have community Lean 3.10.0... can this bug be fixed? I just tried Mario's example, and it still takes 13s on my 16-threaded beastlet.</p>



<a name="196093022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196093022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196093022">(May 03 2020 at 09:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/116395-maths/topic/witt.20vectors/near/169124238" title="#narrow/stream/116395-maths/topic/witt.20vectors/near/169124238">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> Okay, I took a look at this issue and found the following nice comment: <a href="https://github.com/leanprover/lean/blob/e6764047a14ce4383d29b2858fa9e2e246d4f13b/src/library/type_context.cpp#L1978" title="https://github.com/leanprover/lean/blob/e6764047a14ce4383d29b2858fa9e2e246d4f13b/src/library/type_context.cpp#L1978">https://github.com/leanprover/lean/blob/e6764047a14ce4383d29b2858fa9e2e246d4f13b/src/library/type_context.cpp#L1978</a><br>
It looks like Leo independently found a performance issue with this code and fixed it for Lean 4: <a href="https://github.com/kha/lean4/commit/d85c30fde186b75dd00e04242fb8b05450a8daf8#diff-f56a907e917690c6815e55e0fe8540e9R798" title="https://github.com/kha/lean4/commit/d85c30fde186b75dd00e04242fb8b05450a8daf8#diff-f56a907e917690c6815e55e0fe8540e9R798">https://github.com/kha/lean4/commit/d85c30fde186b75dd00e04242fb8b05450a8daf8#diff-f56a907e917690c6815e55e0fe8540e9R798</a><br>
You could try porting it to Lean 3 (using this version: <a href="https://github.com/kha/lean4/commit/f8cedb33e70c9d90c9d81a542340bba0b504f8e6" title="https://github.com/kha/lean4/commit/f8cedb33e70c9d90c9d81a542340bba0b504f8e6">https://github.com/kha/lean4/commit/f8cedb33e70c9d90c9d81a542340bba0b504f8e6</a>), would be interesting to see if anything breaks. But I don't think it can be worked around without changing Lean.</p>
</blockquote>
<p>Sebastian told us what needs to be done.</p>



<a name="196112965"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196112965" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196112965">(May 03 2020 at 17:11)</a>:</h4>
<p>I have no understanding of the underlying code here but I just applied the suggested changes on top of 3.10.0c and they seem to solve the issue in Mario's example. Here's the PR: <a href="https://github.com/leanprover-community/lean/issues/211" title="https://github.com/leanprover-community/lean/issues/211">lean#211</a>.</p>



<a name="196113042"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196113042" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196113042">(May 03 2020 at 17:13)</a>:</h4>
<p>Fantastic! What time does it need now?</p>



<a name="196113051"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196113051" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196113051">(May 03 2020 at 17:13)</a>:</h4>
<p>Note that the "23s" is still in your test code:</p>



<a name="196113054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196113054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196113054">(May 03 2020 at 17:14)</a>:</h4>
<p><a href="https://github.com/leanprover-community/lean/pull/211/files#diff-40e3406d4b81ffee1556ec817f06e661R17" title="https://github.com/leanprover-community/lean/pull/211/files#diff-40e3406d4b81ffee1556ec817f06e661R17">https://github.com/leanprover-community/lean/pull/211/files#diff-40e3406d4b81ffee1556ec817f06e661R17</a></p>



<a name="196113278"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196113278" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196113278">(May 03 2020 at 17:18)</a>:</h4>
<p>Yeah, the test file probably needs more work (how do I wrap the whole thing in <code>try_for</code>?).</p>
<p>Here's a trace from 3.10.0c (<code>tactic execution took 6s</code>):</p>
<div class="codehilite"><pre><span></span><code>$ elan run leanprover-community-lean-3.10.0 lean tests/lean/run/mario_type_context.lean
parsing took 0.211ms
elaboration of bar took 0.0243ms
type checking of bar took 0.0118ms
/Users/chb/Documents/lean/lean/tests/lean/run/mario_type_context.lean:4:0: warning: declaration &#39;bar&#39; uses sorry
compilation of bar took 0.172ms
decl post-processing of bar took 0.241ms
parsing took 0.567ms
type checking of foo took 0.0638ms
compilation of foo took 0.00106ms
decl post-processing of foo took 0.00109ms
elaboration: tactic compilation took 30.3ms
[bar α = bar α, bar α = bar α, eq.refl (bar α = bar α), h]
elaboration: tactic execution took 6s
num. allocated objects:  55
num. allocated closures: 55
 5998ms   100.0%   _interaction._lambda_3
 5998ms   100.0%   scope_trace
 5998ms   100.0%   tactic.mk_mapp
 5998ms   100.0%   _interaction._lambda_2
 5998ms   100.0%   tactic.istep._lambda_1
 5998ms   100.0%   tactic.istep
 5998ms   100.0%   tactic.step
 5998ms   100.0%   _interaction
elaboration of foo took 6.97s
/Users/chb/Documents/lean/lean/tests/lean/run/mario_type_context.lean:6:0: warning: declaration &#39;foo&#39; uses sorry
cumulative profiling times:
        compilation 0.172ms
        decl post-processing 0.241ms
        elaboration 6.97s
        elaboration: tactic compilation 30.3ms
        elaboration: tactic execution 6s
        parsing 0.778ms
        type checking 0.0749ms
</code></pre></div>


<p>Here's a trace from the PR branch (<code>elaboration: tactic execution took 6ms</code>):</p>
<div class="codehilite"><pre><span></span><code>$ elan run local lean tests/lean/run/mario_type_context.lean
parsing took 1.64ms
elaboration of bar took 0.488ms
type checking of bar took 0.0185ms
/Users/chb/Documents/lean/lean/tests/lean/run/mario_type_context.lean:4:0: warning: declaration &#39;bar&#39; uses sorry
compilation of bar took 1.08ms
decl post-processing of bar took 0.678ms
parsing took 1.41ms
type checking of foo took 0.0687ms
compilation of foo took 0.00192ms
decl post-processing of foo took 0.00173ms
elaboration: tactic compilation took 40ms
[bar α = bar α, bar α = bar α, eq.refl (bar α = bar α), h]
elaboration: tactic execution took 6ms
num. allocated objects:  55
num. allocated closures: 55
    6ms   100.0%   _interaction._lambda_3
    6ms   100.0%   scope_trace
    6ms   100.0%   tactic.mk_mapp
    6ms   100.0%   _interaction._lambda_2
    6ms   100.0%   tactic.istep._lambda_1
    6ms   100.0%   tactic.istep
    6ms   100.0%   tactic.step
    6ms   100.0%   _interaction
elaboration of foo took 78.4ms
/Users/chb/Documents/lean/lean/tests/lean/run/mario_type_context.lean:6:0: warning: declaration &#39;foo&#39; uses sorry
cumulative profiling times:
        compilation 1.08ms
        decl post-processing 0.679ms
        elaboration 78.9ms
        elaboration: tactic compilation 40ms
        elaboration: tactic execution 6ms
        parsing 3.05ms
        type checking 0.086ms
</code></pre></div>



<a name="196113486"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196113486" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196113486">(May 03 2020 at 17:24)</a>:</h4>
<p><span class="user-mention" data-user-id="123965">@Bryan Gin-ge Chen</span> Can you build mathlib with this change to see if it breaks anything?</p>



<a name="196113490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196113490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196113490">(May 03 2020 at 17:25)</a>:</h4>
<p>Yes, let me try.</p>



<a name="196114301"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196114301" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196114301">(May 03 2020 at 17:46)</a>:</h4>
<p>Sadly, it does seem to break mathlib. The first error is:</p>
<div class="codehilite"><pre><span></span><code>mathlib/src/algebra/opposites.lean:117:4: error: invalid &#39;or.cases_on&#39; application, elaborator has special support for this kind of application (it is handled as an &quot;eliminator&quot;), but term
  eq_zero_or_eq_zero_of_mul_eq_zero (op_inj H)
must not contain metavariables because it is used to compute the motive
</code></pre></div>



<a name="196114376"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196114376" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastien Gouezel <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196114376">(May 03 2020 at 17:48)</a>:</h4>
<p>Does it break badly, or is it just a few lemmas?</p>



<a name="196114528"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196114528" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196114528">(May 03 2020 at 17:52)</a>:</h4>
<p>You might be able to just comment out that instance and the one after it...</p>



<a name="196114529"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196114529" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196114529">(May 03 2020 at 17:53)</a>:</h4>
<p>(just to see how badly it breaks)</p>



<a name="196114638"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196114638" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196114638">(May 03 2020 at 17:55)</a>:</h4>
<p>Good idea. Let me take a look.</p>



<a name="196114916"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196114916" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196114916">(May 03 2020 at 18:01)</a>:</h4>
<p>The next two errors pop up at some <code>erw</code>s in <code>category_theory.opposites</code>, e.g.:</p>
<div class="codehilite"><pre><span></span><code>mathlib/src/category_theory/opposites.lean:192:29: error: rewrite tactic failed, did not find instance of the pattern in the target expression
  (functor.op F).map ?m_3 ≫ α.app ?m_2
state:
C : Type u₁,
_inst_1 : category C,
D : Type u₂,
_inst_2 : category D,
F G : C ⥤ D,
α : functor.op F ⟶ functor.op G,
X Y : C,
f : X ⟶ Y
⊢ G.map f ≫ has_hom.hom.unop (α.app (opposite.op Y)) = has_hom.hom.unop (α.app (opposite.op X)) ≫ F.map f
</code></pre></div>


<p>cf.</p>
<div class="codehilite"><pre><span></span><code><span class="bp">@</span><span class="o">[</span><span class="n">simps</span><span class="o">]</span> <span class="kn">protected</span> <span class="kn">definition</span> <span class="n">unop</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="n">F</span><span class="bp">.</span><span class="n">op</span> <span class="err">⟶</span> <span class="n">G</span><span class="bp">.</span><span class="n">op</span><span class="o">)</span> <span class="o">:</span> <span class="n">G</span> <span class="err">⟶</span> <span class="n">F</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">app</span>         <span class="o">:=</span> <span class="bp">λ</span> <span class="n">X</span><span class="o">,</span> <span class="o">(</span><span class="n">α</span><span class="bp">.</span><span class="n">app</span> <span class="o">(</span><span class="n">op</span> <span class="n">X</span><span class="o">))</span><span class="bp">.</span><span class="n">unop</span><span class="o">,</span>
  <span class="n">naturality&#39;</span> <span class="o">:=</span> <span class="k">begin</span> <span class="n">tidy</span><span class="o">,</span> <span class="n">erw</span> <span class="n">α</span><span class="bp">.</span><span class="n">naturality</span><span class="o">,</span> <span class="n">refl</span><span class="o">,</span> <span class="kn">end</span> <span class="o">}</span>
<span class="c1">----------------------------^ error here</span>
</code></pre></div>



<a name="196115032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196115032" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196115032">(May 03 2020 at 18:03)</a>:</h4>
<p>Clearly we have to choose between Witt vectors and opposites...</p>



<a name="196115346"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196115346" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196115346">(May 03 2020 at 18:10)</a>:</h4>
<p>Lean seems to have gotten stupider when trying to fill in underscores:</p>
<div class="codehilite"><pre><span></span><code>mathlib/src/data/pfun.lean:206:20: error: don&#39;t know how to synthesize placeholder
context:
α : Type u_1,
p : Prop,
f : p → roption α,
mem_assert : ∀ {a : α} (h : p), a ∈ f h → a ∈ assert p f,
_x : p,
h : (f _x).dom
⊢ p
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="kn">theorem</span> <span class="n">mem_bind</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">roption</span> <span class="n">α</span><span class="o">}</span> <span class="o">{</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">roption</span> <span class="n">β</span><span class="o">}</span> <span class="o">:</span>
  <span class="bp">∀</span> <span class="o">{</span><span class="n">a</span> <span class="n">b</span><span class="o">},</span> <span class="n">a</span> <span class="err">∈</span> <span class="n">f</span> <span class="bp">→</span> <span class="n">b</span> <span class="err">∈</span> <span class="n">g</span> <span class="n">a</span> <span class="bp">→</span> <span class="n">b</span> <span class="err">∈</span> <span class="n">f</span><span class="bp">.</span><span class="n">bind</span> <span class="n">g</span>
<span class="bp">|</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">⟨</span><span class="n">h</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span> <span class="bp">⟨</span><span class="n">h₂</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span> <span class="o">:=</span> <span class="bp">⟨⟨_</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span>
<span class="c1">-----------------------------^ error here</span>
<span class="c1">-- fixed by using `⟨⟨_x, h⟩, rfl⟩` instead</span>
</code></pre></div>



<a name="196121187"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196121187" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196121187">(May 03 2020 at 20:24)</a>:</h4>
<p>The build finally finished. It looks like there were &lt; 20 errors in total. <strong>edit</strong>: see <a href="https://gist.github.com/bryangingechen/8ebb9400835b54482f4d2246501f94be" title="https://gist.github.com/bryangingechen/8ebb9400835b54482f4d2246501f94be">gist</a></p>



<a name="196121210"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196121210" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196121210">(May 03 2020 at 20:25)</a>:</h4>
<p>(not counting the thousands of downstream sorry warnings, of course)</p>



<a name="196139358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196139358" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196139358">(May 04 2020 at 04:37)</a>:</h4>
<p>21 errors doesn't seem too bad. Thanks for all the efforts Bryan!</p>



<a name="196139365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196139365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196139365">(May 04 2020 at 04:37)</a>:</h4>
<p>Did the build feel significantly slower or faster than usual?</p>



<a name="196142176"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196142176" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196142176">(May 04 2020 at 05:35)</a>:</h4>
<p><span class="user-mention" data-user-id="123965">@Bryan Gin-ge Chen</span> What is your guesstimate? Is this approach hopeless? 21 errors sounds like it can be fixed. I was worried that every other underscore would break, and we would have to abandon this PR. But what do you think?</p>



<a name="196142657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196142657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196142657">(May 04 2020 at 05:48)</a>:</h4>
<p>Hard to say re: build times since there were lots of errors. I did happen to notice the build took a long time to get through <code>data.real.pi</code>, but maybe that's a slow file for the normal build too.</p>
<p>Since this change is already in Lean 4, I do agree that we should make more of an effort with the PR.</p>



<a name="196143929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196143929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196143929">(May 04 2020 at 06:17)</a>:</h4>
<p><span class="user-mention" data-user-id="123965">@Bryan Gin-ge Chen</span> would you mind making a PR to mathlib (with <code>not-ready-to-merge</code> label)?</p>



<a name="196143974"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196143974" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196143974">(May 04 2020 at 06:18)</a>:</h4>
<p>But I guess I would need a modified Lean in order to contribute...</p>



<a name="196143981"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196143981" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196143981">(May 04 2020 at 06:18)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> Do you think it's worth making this a <code>lean-3.10.1</code>?</p>



<a name="196144735"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196144735" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Bryan Gin-ge Chen <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196144735">(May 04 2020 at 06:33)</a>:</h4>
<p>I'd be happy to open a new PR when there's a new release (which probably should be 3.11.0 since this a "breaking" change). As of right now, I don't really have anything to PR.</p>



<a name="196821454"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196821454" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196821454">(May 07 2020 at 19:46)</a>:</h4>
<p>The code at <code>witt-vectors2</code> is almost compiling again.</p>



<a name="196821523"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196821523" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196821523">(May 07 2020 at 19:46)</a>:</h4>
<p>It's still very ugly, and I need to fix a couple of errors.</p>



<a name="196821535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196821535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196821535">(May 07 2020 at 19:46)</a>:</h4>
<p>Mostly related to bundling homs</p>



<a name="196821596"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196821596" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196821596">(May 07 2020 at 19:47)</a>:</h4>
<p>Already with <code>lean-3.10.0</code> the code is a lot faster. Looking forward to <code>lean-3.11.0</code> (-;</p>



<a name="196821888"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/196821888" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#196821888">(May 07 2020 at 19:49)</a>:</h4>
<p><code>lean-3.11.0</code> will unfortunately still take a while.  At the moment the CI is broken, concretely the part that uploads releases.  This is because the <code>gothub</code> tool stopped compiling.</p>



<a name="199249444"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/199249444" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#199249444">(May 30 2020 at 10:12)</a>:</h4>
<p>Witt vectors are a ring again!<br>
<a href="https://github.com/leanprover-community/mathlib/blob/witt-vectors2/src/ring_theory/witt_vector.lean">https://github.com/leanprover-community/mathlib/blob/witt-vectors2/src/ring_theory/witt_vector.lean</a></p>



<a name="199249446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/199249446" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#199249446">(May 30 2020 at 10:12)</a>:</h4>
<p>Lots of ugly code is now gone. Lean is much better!</p>



<a name="199249449"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/199249449" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#199249449">(May 30 2020 at 10:12)</a>:</h4>
<p>(And the author maybe also improved a bit.)</p>



<a name="199249461"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/199249461" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#199249461">(May 30 2020 at 10:13)</a>:</h4>
<p>If you want an entertaining read for a Saturday afternoon, you can scroll back in this thread to see the pains I went through about a year ago <span aria-label="stuck out tongue wink" class="emoji emoji-1f61c" role="img" title="stuck out tongue wink">:stuck_out_tongue_wink:</span></p>



<a name="199249470"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/199249470" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#199249470">(May 30 2020 at 10:13)</a>:</h4>
<p>There is still a lot of cleanup to be done. But it is now much more straightforward.</p>



<a name="199249475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/199249475" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#199249475">(May 30 2020 at 10:13)</a>:</h4>
<p>This is a huge success story for the community. Witt vectors are just an innocuous piece of algebra in some sense; they could be taught to MSc students. You ran into a brick wall for some reason when formalising them, and this led to isolating fundamental issues with Lean itself, and my understanding is that these have now been fixed.</p>



<a name="199249528"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/199249528" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#199249528">(May 30 2020 at 10:15)</a>:</h4>
<p>One thing that is really annoying, and dissapointing is that there are a lot of <code>convert ring_hom.ext_int _ _</code> that can't be turned into <code>apply</code>. (This is saying that <code>(f g : int →+* R)</code> implies <code>f = g</code>.)</p>



<a name="200025213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/200025213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#200025213">(Jun 07 2020 at 13:53)</a>:</h4>
<p><span class="user-mention" data-user-id="112680">@Johan Commelin</span> if I were to define <code>(a ^ p - a) / p</code> in Lean I would use the integer division and then separately prove that <code>p \| (a ^ p - a)</code></p>



<a name="200025250"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/200025250" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#200025250">(Jun 07 2020 at 13:54)</a>:</h4>
<p>sure we can pass through <code>\Q</code> but that wouldn't be necessary</p>



<a name="200025252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/200025252" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#200025252">(Jun 07 2020 at 13:54)</a>:</h4>
<p>could we do the same thing for the Witt polynomials?</p>



<a name="200025262"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/200025262" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#200025262">(Jun 07 2020 at 13:54)</a>:</h4>
<p>i.e. use integer division instead of passing through <code>\Q</code></p>



<a name="200026047"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/200026047" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#200026047">(Jun 07 2020 at 14:17)</a>:</h4>
<p>I don't think it will make life easier...</p>



<a name="200077055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/200077055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#200077055">(Jun 08 2020 at 09:55)</a>:</h4>
<p><span class="user-mention" data-user-id="112680">@Johan Commelin</span> have you looked at <a href="https://math.berkeley.edu/~hwl/papers/witt.pdf">this construction of (universal) Witt vectors</a>?</p>



<a name="200077113"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/200077113" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#200077113">(Jun 08 2020 at 09:55)</a>:</h4>
<p>where the set is <code>1+TA[[T]]</code>, the addition is "power series multiplication", and the multiplication is "coefficient-wise multiplication (aka Hadamard product)"</p>



<a name="200077260"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/200077260" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#200077260">(Jun 08 2020 at 09:57)</a>:</h4>
<p>No I haven't. I'll do that when I have time again (-;</p>



<a name="200078330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/200078330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#200078330">(Jun 08 2020 at 10:09)</a>:</h4>
<p>correction: it's only Hadamard product when one (or both) of the multiplicands is of the form <code>(1-aT)^-1 = sum a^i T^i</code></p>



<a name="209706690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209706690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209706690">(Sep 10 2020 at 20:46)</a>:</h4>
<p>Together with <span class="user-mention" data-user-id="110596">@Rob Lewis</span> I've finished (as in, sorry-free, not cleaned up yet) the ring isomorphism <code>witt_vector p (zmod p) →+* Z_[p]</code> .<br>
Expect some PR soonish (-;</p>



<a name="209706901"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209706901" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209706901">(Sep 10 2020 at 20:47)</a>:</h4>
<p>how did you define the Teichmuller lift?</p>



<a name="209707027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707027" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707027">(Sep 10 2020 at 20:48)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">teichmuller_fun</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span> <span class="err">𝕎</span> <span class="n">R</span>
<span class="bp">|</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">r</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">0</span>
</code></pre></div>



<a name="209707065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707065" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707065">(Sep 10 2020 at 20:48)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="n">noncomputable</span> <span class="n">def</span> <span class="n">teichmuller</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">→*</span> <span class="err">𝕎</span> <span class="n">R</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="n">teichmuller_fun</span> <span class="n">p</span><span class="o">,</span>
  <span class="n">map_one&#39;</span> <span class="o">:=</span>
  <span class="k">begin</span>
    <span class="n">ext</span> <span class="bp">⟨⟩</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="n">one_coeff_zero</span><span class="o">,</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="n">one_coeff_pos</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">succ_pos</span> <span class="n">n</span><span class="o">),</span> <span class="n">refl</span> <span class="o">}</span>
  <span class="kn">end</span><span class="o">,</span>
  <span class="n">map_mul&#39;</span> <span class="o">:=</span>
  <span class="k">begin</span>
    <span class="n">intros</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span>
    <span class="n">rcases</span> <span class="n">counit_surjective</span> <span class="n">R</span> <span class="n">x</span> <span class="k">with</span> <span class="bp">⟨</span><span class="n">x</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
    <span class="n">rcases</span> <span class="n">counit_surjective</span> <span class="n">R</span> <span class="n">y</span> <span class="k">with</span> <span class="bp">⟨</span><span class="n">y</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="err">←</span> <span class="n">map_teichmuller_fun</span><span class="o">,</span> <span class="err">←</span> <span class="n">ring_hom</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">teichmuller_mul_aux₂</span><span class="o">],</span>
  <span class="kn">end</span> <span class="o">}</span>
</code></pre></div>



<a name="209707480"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707480" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707480">(Sep 10 2020 at 20:52)</a>:</h4>
<p><span class="user-mention" data-user-id="110064">@Kenny Lau</span> We have Teichmuller, Verschiebung, and Frobenius.</p>



<a name="209707521"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707521" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707521">(Sep 10 2020 at 20:52)</a>:</h4>
<p>Frobenius isn't a ring hom yet, but that shouldn't be too hard.</p>



<a name="209707542"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707542" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707542">(Sep 10 2020 at 20:53)</a>:</h4>
<p>Is Ver additive?</p>



<a name="209707579"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707579" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707579">(Sep 10 2020 at 20:53)</a>:</h4>
<p>Yes</p>



<a name="209707625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707625" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707625">(Sep 10 2020 at 20:53)</a>:</h4>
<p>but you don't need Techimuller (in Zp) to define the isom?</p>



<a name="209707691"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707691" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707691">(Sep 10 2020 at 20:54)</a>:</h4>
<p>Nope</p>



<a name="209707746"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707746" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707746">(Sep 10 2020 at 20:54)</a>:</h4>
<p><code>W (F_p)</code> is the projective limit of truncated witt vector rings, which have cardinality <code>p ^ n</code>.</p>



<a name="209707765"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707765" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707765">(Sep 10 2020 at 20:54)</a>:</h4>
<p>And <code>1</code> has order <code>p ^ n</code> in those rings. Hence done.</p>



<a name="209707815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209707815" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209707815">(Sep 10 2020 at 20:55)</a>:</h4>
<p>The other proof is too analytical for me. (I'm scared of <code>tsum</code>.)</p>



<a name="209708201"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209708201" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209708201">(Sep 10 2020 at 20:58)</a>:</h4>
<p>this sounds a bit suspicious. I mean, what is <code>((2, 0, 0, ...) : W (F_p))</code> sent to?</p>



<a name="209708326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209708326" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209708326">(Sep 10 2020 at 20:59)</a>:</h4>
<p>What do you mean "suspicious"?</p>
<p>We have a freaking formal proof, lol</p>



<a name="209708346"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209708346" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209708346">(Sep 10 2020 at 20:59)</a>:</h4>
<div class="codehilite"><pre><span></span><code>   <span class="mi">406</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">basic</span><span class="bp">.</span><span class="n">lean</span>
    <span class="mi">90</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">compare</span><span class="bp">.</span><span class="n">lean</span>
   <span class="mi">265</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">frobenius</span><span class="bp">.</span><span class="n">lean</span>
   <span class="mi">145</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">ideal</span><span class="bp">.</span><span class="n">lean</span>
   <span class="mi">155</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">init_tail</span><span class="bp">.</span><span class="n">lean</span>
    <span class="mi">90</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">is_poly</span><span class="bp">.</span><span class="n">lean</span>
   <span class="mi">108</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">mul_p</span><span class="bp">.</span><span class="n">lean</span>
   <span class="mi">549</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">structure_polynomial</span><span class="bp">.</span><span class="n">lean</span>
    <span class="mi">94</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">teichmuller</span><span class="bp">.</span><span class="n">lean</span>
   <span class="mi">488</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">truncated2</span><span class="bp">.</span><span class="n">lean</span>
   <span class="mi">166</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">verschiebung</span><span class="bp">.</span><span class="n">lean</span>
   <span class="mi">330</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">witt_polynomial</span><span class="bp">.</span><span class="n">lean</span>
   <span class="mi">631</span> <span class="n">src</span><span class="bp">/</span><span class="n">ring_theory</span><span class="bp">/</span><span class="n">witt_vector</span><span class="bp">/</span><span class="n">witt_vector_preps</span><span class="bp">.</span><span class="n">lean</span>
  <span class="mi">3517</span> <span class="n">total</span>
</code></pre></div>



<a name="209708469"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209708469" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209708469">(Sep 10 2020 at 21:00)</a>:</h4>
<p>Anyway, if you have a ring that is the projective limit of rings <code>R n</code>, and <code>R n</code> has cardinality <code>p ^ n</code>, and <code>1 : R n</code> has order <code>p ^ n</code>, then this projective limit is isomorphic to <code>Z_p</code>.</p>



<a name="209708481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209708481" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209708481">(Sep 10 2020 at 21:00)</a>:</h4>
<p>That's not too surprising, right?</p>



<a name="209708534"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209708534" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209708534">(Sep 10 2020 at 21:01)</a>:</h4>
<p>But of course this isom doesn't tell you where Teichmuller lifts are mapped.</p>



<a name="209708697"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209708697" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209708697">(Sep 10 2020 at 21:02)</a>:</h4>
<p>It would be a nice application of Hensel's lemma. But I would like a better API for Henselian rings first.</p>



<a name="209709071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209709071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209709071">(Sep 10 2020 at 21:05)</a>:</h4>
<p>why does 1 have order p^n?</p>



<a name="209709085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209709085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209709085">(Sep 10 2020 at 21:05)</a>:</h4>
<p>additive order.</p>



<a name="209709175"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209709175" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209709175">(Sep 10 2020 at 21:06)</a>:</h4>
<p>yeah, why does 1 have additive order p^n?</p>



<a name="209709183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209709183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209709183">(Sep 10 2020 at 21:06)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">lemma</span> <span class="n">frobenius_fun_verschiebung</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="err">𝕎</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">frobenius_fun</span> <span class="o">(</span><span class="n">verschiebung</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">p</span> <span class="o">:=</span>
<span class="n">congr_fun</span> <span class="o">(</span><span class="n">frobenius_fun_comp_verschiebung</span> <span class="n">p</span><span class="o">)</span> <span class="n">x</span>

<span class="kn">lemma</span> <span class="n">verschiebung_zmod</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="err">𝕎</span> <span class="o">(</span><span class="n">zmod</span> <span class="n">p</span><span class="o">))</span> <span class="o">:</span>
  <span class="n">verschiebung</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">p</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="err">←</span> <span class="n">frobenius_fun_verschiebung</span><span class="o">,</span> <span class="n">frobenius_fun_zmodp</span><span class="o">],</span>
<span class="kn">end</span>

<span class="c1">-- this should be true not just for `char_p R p` but for general `nontrivial R`.</span>
<span class="kn">lemma</span> <span class="n">coeff_p_pow</span> <span class="o">[</span><span class="n">char_p</span> <span class="n">R</span> <span class="n">p</span><span class="o">]</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:</span> <span class="n">is_unit</span> <span class="o">((</span><span class="n">p</span> <span class="bp">^</span> <span class="n">i</span> <span class="o">:</span> <span class="err">𝕎</span> <span class="n">R</span><span class="o">)</span><span class="bp">.</span><span class="n">coeff</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">induction</span> <span class="n">i</span> <span class="k">with</span> <span class="n">i</span> <span class="n">h</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">one_coeff_zero</span><span class="o">,</span> <span class="n">ne</span><span class="bp">.</span><span class="n">def</span><span class="o">,</span> <span class="n">pow_zero</span><span class="o">,</span> <span class="n">is_unit_one</span><span class="o">]</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">pow_succ&#39;</span><span class="o">,</span> <span class="err">←</span> <span class="n">frobenius_fun_verschiebung</span><span class="o">,</span> <span class="n">coeff_frobenius_fun_char_p</span><span class="o">,</span> <span class="n">verschiebung_coeff_succ</span><span class="o">],</span>
    <span class="n">exact</span> <span class="n">is_unit_pow</span> <span class="n">p</span> <span class="n">h</span><span class="o">,</span> <span class="o">}</span>
<span class="kn">end</span>
</code></pre></div>



<a name="209709258"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209709258" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209709258">(Sep 10 2020 at 21:07)</a>:</h4>
<p>The <code>i</code>-th coefficient of <code>p ^ i</code> is a unit. So <code>p ^ i</code> is nonzero in the <code>n</code>-truncated witt vectors, for <code>i &lt; n</code>.</p>



<a name="209709288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209709288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kenny Lau <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209709288">(Sep 10 2020 at 21:07)</a>:</h4>
<p>aha</p>



<a name="209711063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209711063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209711063">(Sep 10 2020 at 21:22)</a>:</h4>
<p>There's some truncated valuation from W_n(k) to {0,1,...,n-1,top} which has the right behaviour. Unfortunately the corresponding multiplicative object is not a group with zero so we can't use lean's valuation stuff I don't think</p>



<a name="209711662"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209711662" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209711662">(Sep 10 2020 at 21:26)</a>:</h4>
<p>I don't have anything intelligent to say about this but this 𝕎 letter looks very cool</p>



<a name="209715173"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209715173" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209715173">(Sep 10 2020 at 22:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110038">Kevin Buzzard</span> <a href="#narrow/stream/116395-maths/topic/witt.20vectors/near/209711063">said</a>:</p>
<blockquote>
<p>There's some truncated valuation from W_n(k) to {0,1,...,n-1,top} which has the right behaviour. Unfortunately the corresponding multiplicative object is not a group with zero so we can't use lean's valuation stuff I don't think</p>
</blockquote>
<p>Isn't this a <code>comm_monoid_with_zero</code>?</p>



<a name="209715234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209715234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209715234">(Sep 10 2020 at 22:01)</a>:</h4>
<p>Well, rather <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>q</mi><mrow><mo stretchy="false">{</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi></mrow><mo stretchy="false">}</mo></mrow></msup></mrow><annotation encoding="application/x-tex">q^{\{0,1,\ldots,n-1,\mathrm{top}\}}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.0824399999999998em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">{</span><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="minner mtight">…</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathrm mtight">t</span><span class="mord mathrm mtight">o</span><span class="mord mathrm mtight">p</span></span><span class="mclose mtight">}</span></span></span></span></span></span></span></span></span></span></span></span> is :)</p>



<a name="209716318"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209716318" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209716318">(Sep 10 2020 at 22:13)</a>:</h4>
<p>Sure -- but valuations take values in a <code>linear_ordered_comm_group_with_zero</code> right now.</p>



<a name="209716854"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209716854" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209716854">(Sep 10 2020 at 22:19)</a>:</h4>
<p>Right. Now I'm thinking it might be really fun to define valuations as morphisms of hypperrings.</p>



<a name="209716901"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/209716901" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#209716901">(Sep 10 2020 at 22:19)</a>:</h4>
<p>Since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>t</mi><mi>o</mi><mi>p</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{0,1,\ldots,n-1,top\}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mclose">}</span></span></span></span> is a quotient of the "tropical" hyperring <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">N</mi></mrow><annotation encoding="application/x-tex">\mathbb{N}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68889em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbb">N</span></span></span></span></span>, and the inverse image of the "ideal" defining this quotient is exactly the ideal in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="double-struck">Z</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">\mathbb{Z}_p</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.974998em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">Z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> which you need to quotient out by to get <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Z</mi><mi mathvariant="normal">/</mi><msup><mi>p</mi><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">\mathbb{Z}/p^n</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathbb">Z</span></span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span>.</p>



<a name="210350242"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/210350242" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#210350242">(Sep 17 2020 at 05:43)</a>:</h4>
<p><span class="user-mention" data-user-id="110596">@Rob Lewis</span> wrote the <code>witt_simp</code> tactic, which allows us to prove in 4 lines:</p>
<div class="codehilite"><pre><span></span><code><span class="c">/-</span><span class="cm">- The “product formula” for Frobenius and Verschiebung. -/</span>
<span class="kn">lemma</span> <span class="n">verschiebung_mul_frobenius</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="err">𝕎</span> <span class="n">R</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">verschiebung</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">frobenius</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">verschiebung</span> <span class="n">x</span> <span class="bp">*</span> <span class="n">y</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">apply</span> <span class="n">is_poly₂</span><span class="bp">.</span><span class="n">ext&#39;</span>
    <span class="o">(</span><span class="n">verschiebung_is_poly</span><span class="bp">.</span><span class="n">comp₂</span> <span class="o">((</span><span class="n">mul_is_poly₂</span> <span class="n">p</span><span class="o">)</span><span class="bp">.</span><span class="n">comp_right</span> <span class="o">(</span><span class="n">frobenius_is_poly</span> <span class="n">p</span><span class="o">)))</span>
    <span class="o">((</span><span class="n">mul_is_poly₂</span> <span class="n">p</span><span class="o">)</span><span class="bp">.</span><span class="n">comp_left</span> <span class="n">verschiebung_is_poly</span><span class="o">),</span>
  <span class="n">rintro</span> <span class="bp">⟨⟩;</span> <span class="n">witt_simp</span> <span class="o">[</span><span class="n">mul_assoc</span><span class="o">]</span>
<span class="kn">end</span>
</code></pre></div>


<p>On proving such identities, Hazewinkel wrote:</p>
<blockquote>
<p>There are pitfalls in calculating with ghost components as is done here. Such a calculation gives a valid proof of an identity or something else only if it is a universal calculation; that is, makes no use of any properties beyond those that follow from the axioms for a unital commutative ring only.</p>
</blockquote>
<p>Note that Rob wrote the tactic after we had 2 or 3 of such proofs done, but before I attempted to prove the product formula above.</p>
<p>It doesn't really do the theory of commutative rings, but we can get pretty close to “universal calculations” and have the short proofs that you would expect on paper.</p>



<a name="210859011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/210859011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#210859011">(Sep 22 2020 at 11:55)</a>:</h4>
<p><span class="user-mention" data-user-id="112680">@Johan Commelin</span> and I have written a paper about this project! <a href="http://robertylewis.com/files/witt-vectors.pdf">http://robertylewis.com/files/witt-vectors.pdf</a></p>
<p>We'd love to hear if you have any comments about it.</p>



<a name="210870735"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/210870735" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#210870735">(Sep 22 2020 at 13:39)</a>:</h4>
<p>line 399 do you really mean <code>R : Type</code> and not <code>R : Type u</code>? Not that this will cause any problems with mathematical applications of course.</p>



<a name="210871179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/210871179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#210871179">(Sep 22 2020 at 13:42)</a>:</h4>
<p>That line is taking advantage of the one right before it: the code snippet has been slightly edited for the sake of presentation!</p>



<a name="210871265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/210871265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#210871265">(Sep 22 2020 at 13:43)</a>:</h4>
<p>It would be the only universe mentioned anywhere in the paper, either we'd have to give a totally irrelevant explanation or it would look like a typo.</p>



<a name="211132595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/211132595" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#211132595">(Sep 24 2020 at 13:43)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/4236">#4236</a> is the first <em>real</em> PR on Witt vectors</p>



<a name="211132860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/211132860" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#211132860">(Sep 24 2020 at 13:45)</a>:</h4>
<p>Finally after 1.5 years or something... a first PR <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="211329135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/211329135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#211329135">(Sep 25 2020 at 23:30)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/4268">#4268</a> is the next one. Brace yourself, this is the ugliest part. We need to show that some polynomials are integral, and it's just a nasty job.</p>



<a name="212524233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/212524233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#212524233">(Oct 07 2020 at 07:45)</a>:</h4>
<p>There's now an improved draft of our paper on arxiv: <a href="https://arxiv.org/abs/2010.02595">https://arxiv.org/abs/2010.02595</a></p>



<a name="212524479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/212524479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#212524479">(Oct 07 2020 at 07:49)</a>:</h4>
<p>Oops I missed the opportunity to comment because I wanted to find time to read carefully. The only comment I had after a very quick read was that the section about specialized tactics was frustrating because it was hard to understand what the tactics were doing and there were no hint about how to implement them.</p>



<a name="212524897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/212524897" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#212524897">(Oct 07 2020 at 07:54)</a>:</h4>
<p>Luckily we've improved that section quite a bit, I think, although it's still not full of implementation details. Since the math is enough to scare off most of our readers it seemed better not to lose the rest with a bunch of metaprogramming talk!</p>



<a name="212527208"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/212527208" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#212527208">(Oct 07 2020 at 08:21)</a>:</h4>
<p>The approach we used in the perfectoid spaces paper was: the fact the set of potential readers is empty is a feature, it shows we are doing something really new.</p>



<a name="212541766"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/212541766" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jasmin Blanchette <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#212541766">(Oct 07 2020 at 10:56)</a>:</h4>
<p>The typesetting looks great! You must have worked hard.</p>



<a name="212541980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/212541980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#212541980">(Oct 07 2020 at 10:58)</a>:</h4>
<p>Pay no attention to the column break on p7</p>



<a name="212541990"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/212541990" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jasmin Blanchette <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#212541990">(Oct 07 2020 at 10:58)</a>:</h4>
<p>Sure. Which page did you say? ;)</p>



<a name="212542235"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/212542235" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#212542235">(Oct 07 2020 at 11:01)</a>:</h4>
<p>What happened to the real Johan? He wouldn't let that page break happen.</p>



<a name="212542385"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/212542385" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Rob Lewis <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#212542385">(Oct 07 2020 at 11:02)</a>:</h4>
<p>The bigger question is, what happened to the arxiv tex install, because we built the paper in four different local environments and they all looked <a href="http://robertylewis.com/files/witt-vectors.pdf">right</a></p>



<a name="212547202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/212547202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ruben Van de Velde <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#212547202">(Oct 07 2020 at 11:58)</a>:</h4>
<p>There seems to be a stray "S" at the end of the Frobenius section on page 10</p>



<a name="213795460"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/213795460" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#213795460">(Oct 19 2020 at 14:40)</a>:</h4>
<p>Hooray, another Witt vector PR was merged. The next one is <a href="https://github.com/leanprover-community/mathlib/issues/4332">#4332</a> and it will tell mathlib the ring structure on Witt vectors.</p>



<a name="213795522"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/213795522" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#213795522">(Oct 19 2020 at 14:41)</a>:</h4>
<p>It's 475 lines of code, features two aux tactics, and a lot of comments.</p>



<a name="213795981"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/213795981" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#213795981">(Oct 19 2020 at 14:44)</a>:</h4>
<p>I've looked whether I could naturally split this into two smaller PRs, but there isn't an obvious point to split the PR</p>



<a name="213796054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/213796054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#213796054">(Oct 19 2020 at 14:45)</a>:</h4>
<p>Once this PR is merged, the fun will start! As in: no more crazy hard long computations, but juicy tactics that give unexpected results.</p>



<a name="213814385"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/213814385" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#213814385">(Oct 19 2020 at 16:54)</a>:</h4>
<p>Hmm, I think I did find a way to split the PR.</p>



<a name="213821236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/213821236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#213821236">(Oct 19 2020 at 17:48)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib/issues/4693">#4693</a> should now be reviewed before <a href="https://github.com/leanprover-community/mathlib/issues/4332">#4332</a>. This new PR is rather easy. It moves a bunch of stuff from an old file to a new file.</p>



<a name="214341047"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/214341047" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#214341047">(Oct 23 2020 at 17:21)</a>:</h4>
<p>I've golfed away more than a 100 lines from <a href="https://github.com/leanprover-community/mathlib/issues/4694">#4694</a></p>



<a name="214341155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/214341155" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#214341155">(Oct 23 2020 at 17:22)</a>:</h4>
<p>I think this is now a pretty cute and readable explanation of why Witt vectors are a ring. (And it includes two marvelous helper tactics, thanks to Rob.)</p>



<a name="218383789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/218383789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#218383789">(Dec 01 2020 at 06:04)</a>:</h4>
<p>A happy status update from the Witt project. As you may have heard, our paper got accepted at CPP21. We're very happy about that.</p>
<p>All contents of the Witt project have now been PR'd. The comparison isomorphism between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo stretchy="false">(</mo><msub><mi mathvariant="double-struck">F</mi><mi>p</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">W(\mathbb{F}_p)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbb">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="double-struck">Z</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">\mathbb{Z}_p</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.974998em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">Z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> is <a href="https://github.com/leanprover-community/mathlib/issues/5164">#5164</a><br>
It depends on 4 other PRs. There are currently 6 open PRs from the project (I opened 5 of them this morning). 3 PRs are unblocked, 3 are blocked by others.<br>
The most technical one is <a href="https://github.com/leanprover-community/mathlib/issues/4838">#4838</a> on the Frobenius operator. (That's also the oldest PR, and blocking two of the others, among which the comparison isom.)</p>



<a name="219818264"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/219818264" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Filippo A. E. Nuccio <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#219818264">(Dec 14 2020 at 09:43)</a>:</h4>
<p><span class="user-mention" data-user-id="112680">@Johan Commelin</span> What is the state of the art of the proof that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">W</mi><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbb{W}(R)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathbb">W</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span> is the projective limit of truncated Witt vectors on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>? I read here <a href="https://leanprover-community.github.io/mathlib_docs/ring_theory/witt_vector/truncated.html">https://leanprover-community.github.io/mathlib_docs/ring_theory/witt_vector/truncated.html</a> that this will be done in future work, and I was wondering if someone (you and <span class="user-mention" data-user-id="110596">@Rob Lewis</span> ?) is actively working on this.</p>



<a name="219818422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/219818422" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#219818422">(Dec 14 2020 at 09:45)</a>:</h4>
<p><span class="user-mention" data-user-id="300245">@Filippo A. E. Nuccio</span> there's an open PR</p>



<a name="219818440"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/219818440" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#219818440">(Dec 14 2020 at 09:45)</a>:</h4>
<p>it's about 200 of lines (waiting for review, hint) <span aria-label="stuck out tongue wink" class="emoji emoji-1f61c" role="img" title="stuck out tongue wink">:stuck_out_tongue_wink:</span></p>



<a name="219818621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/219818621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Filippo A. E. Nuccio <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#219818621">(Dec 14 2020 at 09:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/116395-maths/topic/witt.20vectors/near/219818422">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="300245">Filippo A. E. Nuccio</span> there's an open PR</p>
</blockquote>
<p>Oh great, I'll have a look.</p>



<a name="219819089"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/219819089" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Filippo A. E. Nuccio <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#219819089">(Dec 14 2020 at 09:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/116395-maths/topic/witt.20vectors/near/219818440">said</a>:</p>
<blockquote>
<p>it's about 200 of lines (waiting for review, hint) <span aria-label="stuck out tongue wink" class="emoji emoji-1f61c" role="img" title="stuck out tongue wink">:stuck_out_tongue_wink:</span></p>
</blockquote>
<p>I  guess you are speaking about <a href="https://github.com/leanprover-community/mathlib/issues/5162">#5162</a>, right?</p>



<a name="219819380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/219819380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#219819380">(Dec 14 2020 at 09:54)</a>:</h4>
<p>Nope, it's <a href="https://github.com/leanprover-community/mathlib/issues/5163">#5163</a></p>



<a name="219819429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/219819429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#219819429">(Dec 14 2020 at 09:54)</a>:</h4>
<p><span class="user-mention" data-user-id="300245">@Filippo A. E. Nuccio</span> and <a href="https://github.com/leanprover-community/mathlib/issues/5164">#5164</a> shows that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">W</mi><mo stretchy="false">(</mo><msub><mi mathvariant="double-struck">F</mi><mi>p</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi mathvariant="double-struck">Z</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">\mathbb{W}(\mathbb{F}_p) = \mathbb{Z}_p</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathbb">W</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbb">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.974998em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">Z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>.</p>



<a name="220774747"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/witt%20vectors/near/220774747" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/116395-maths/topic/witt.20vectors.html#220774747">(Dec 23 2020 at 09:52)</a>:</h4>
<p>The last Witt PR has been kicked onto the queue! Many thanks to all the reviewers! That certainly improved the code!</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>