---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html">Importing Log breaks termination proof</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="320026140"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320026140" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320026140">(Jan 08 2023 at 01:54)</a>:</h4>
<p>I have been having difficulty with a termination proof. I am seeing weird behavior which seems bug-like.  The following MWE works fine:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Std.Data.List.Basic</span>
<span class="kn">open</span> <span class="n">Lean</span>

<span class="kd">def</span> <span class="n">examp</span> <span class="o">[</span><span class="n">DecidableEq</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">delim</span><span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span><span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]):</span> <span class="n">List</span> <span class="n">α</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">h₀</span><span class="o">:</span> <span class="n">l</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="o">[]</span> <span class="bp">=&gt;</span> <span class="o">[]</span>
  <span class="bp">|</span> <span class="n">head</span><span class="o">::</span><span class="n">tail</span> <span class="bp">=&gt;</span>
    <span class="k">match</span> <span class="n">List.getRest</span> <span class="n">l</span> <span class="n">delim</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="n">none</span> <span class="bp">=&gt;</span> <span class="n">examp</span> <span class="n">delim</span> <span class="n">tail</span> <span class="n">h</span>
    <span class="bp">|</span> <span class="n">some</span> <span class="n">rest</span> <span class="bp">=&gt;</span>
      <span class="k">have</span> <span class="n">_</span><span class="o">:</span> <span class="n">sizeOf</span> <span class="n">rest</span> <span class="bp">&lt;</span> <span class="n">sizeOf</span> <span class="n">l</span> <span class="o">:=</span> <span class="kd">by</span> <span class="gr">sorry</span>
      <span class="n">examp</span> <span class="n">delim</span> <span class="n">rest</span> <span class="n">h</span>
<span class="n">decreasing_by</span> <span class="n">decreasing_tactic</span>
</code></pre></div>
<p>But if I add the import <code>import Mathlib.Data.Nat.Log</code> at the top of the file, then I get the "failed to prove termination" error message. Is this a bug, or is something else going on?</p>



<a name="320033537"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320033537" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320033537">(Jan 08 2023 at 04:08)</a>:</h4>
<p>If I had to guess, it's because of the (transitively) imported mathlib simp lemmas. Could also be that mathlib extends <code>decreasing_trivial</code>. Investigating!</p>



<a name="320034809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320034809" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320034809">(Jan 08 2023 at 04:36)</a>:</h4>
<p>I think simp lemmas are the culprit; looks like it's actually not proving for the first recursive call, not the second</p>



<a name="320035380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035380">(Jan 08 2023 at 04:46)</a>:</h4>
<p>New MWE:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Data.Nat.Order.Basic</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">delim</span> <span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[])</span> <span class="o">(</span><span class="n">head</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">tail</span> <span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">:</span> <span class="o">(</span><span class="n">invImage</span> <span class="o">(</span><span class="n">β</span> <span class="o">:=</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="bp">×'</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[])</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">instWellFoundedRelation</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span>
  <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span>
  <span class="o">:=</span> <span class="kd">by</span> <span class="n">decreasing_with</span> <span class="n">simp</span> <span class="o">(</span><span class="n">config</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">arith</span> <span class="o">:=</span> <span class="n">true</span> <span class="o">})</span>
</code></pre></div>



<a name="320035412"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035412" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035412">(Jan 08 2023 at 04:47)</a>:</h4>
<p>what does <code>set_option trace.Meta.simp.rewrite true</code> show in each case?</p>



<a name="320035495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035495">(Jan 08 2023 at 04:48)</a>:</h4>
<p>Oh, a useful trace option! Let me see...</p>



<a name="320035559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035559" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035559">(Jan 08 2023 at 04:49)</a>:</h4>
<p>The weird thing is that it doesn't even present me with any unsolved goals, just that it failed.  Let me try that option.</p>



<a name="320035621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035621">(Jan 08 2023 at 04:49)</a>:</h4>
<p><a href="/user_uploads/3121/yjP6okNntpNiuvNUYLZClWG3/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/yjP6okNntpNiuvNUYLZClWG3/image.png" title="image.png"><img src="/user_uploads/3121/yjP6okNntpNiuvNUYLZClWG3/image.png"></a></div>



<a name="320035674"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035674" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035674">(Jan 08 2023 at 04:50)</a>:</h4>
<p>Oh, wait a minute</p>



<a name="320035687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035687" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035687">(Jan 08 2023 at 04:50)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Data.Nat.Order.Basic</span>

<span class="c1">--set_option trace.Meta.Tactic.simp.rewrite true</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">delim</span> <span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[])</span> <span class="o">(</span><span class="n">head</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">tail</span> <span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">:</span> <span class="o">(</span><span class="n">invImage</span> <span class="o">(</span><span class="n">β</span> <span class="o">:=</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="bp">×'</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[])</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">instWellFoundedRelation</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span>
  <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span>
  <span class="o">:=</span> <span class="kd">by</span>
    <span class="n">simp_wf</span>
    <span class="c1">--simp (config := { arith := true })</span>
</code></pre></div>



<a name="320035705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035705">(Jan 08 2023 at 04:50)</a>:</h4>
<p>so <code>simp_wf</code> is changing :)</p>



<a name="320035767"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035767" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035767">(Jan 08 2023 at 04:51)</a>:</h4>
<p>Wondering if <code>decreasing_tactic</code> should add an alternative in its <code>first</code> to simply not try the given tactic...<br>
edit: probably a bad idea</p>



<a name="320035838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035838" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035838">(Jan 08 2023 at 04:52)</a>:</h4>
<p>what does it output? (lean is not in front of me)</p>



<a name="320035852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320035852" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320035852">(Jan 08 2023 at 04:52)</a>:</h4>
<p>Paste the whole thing here?</p>



<a name="320036000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036000">(Jan 08 2023 at 04:55)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">InvImage</span><span class="o">,</span> <span class="n">InvImage</span> <span class="n">WellFoundedRelation.rel</span> <span class="o">(</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">x_1</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span>
      <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span>
      <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span>
        <span class="n">snd</span> <span class="o">:=</span>
          <span class="n">h</span> <span class="o">}</span> <span class="bp">==&gt;</span> <span class="n">WellFoundedRelation.rel</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">x_1</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">})</span>
      <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">x_1</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">})</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">InvImage</span><span class="o">,</span> <span class="n">InvImage</span> <span class="n">WellFoundedRelation.rel</span> <span class="n">sizeOf</span>
      <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">x_1</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">})</span>
      <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">x_1</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span>
        <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span>
          <span class="n">snd</span> <span class="o">:=</span>
            <span class="n">h</span> <span class="o">})</span> <span class="bp">==&gt;</span> <span class="n">WellFoundedRelation.rel</span>
      <span class="o">(</span><span class="n">sizeOf</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">x_1</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}))</span>
      <span class="o">(</span><span class="n">sizeOf</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">x_1</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}))</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">Nat.lt_wfRel</span><span class="o">,</span> <span class="n">Nat.lt_wfRel</span> <span class="bp">==&gt;</span> <span class="o">{</span> <span class="n">rel</span> <span class="o">:=</span> <span class="n">Nat.lt</span><span class="o">,</span> <span class="n">wf</span> <span class="o">:=</span> <span class="n">Nat.lt_wfRel.proof_1</span> <span class="o">}</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">sizeOf_nat</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="n">tail</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="n">sizeOf</span> <span class="n">tail</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">List.cons.sizeOf_spec</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="o">(</span><span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">head</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">sizeOf_default</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="n">head</span> <span class="bp">==&gt;</span> <span class="mi">0</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">add_zero</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="mi">1</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">==&gt;</span> <span class="mi">1</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">sizeOf_nat</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">Nat.lt_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">Nat.lt</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="n">tail</span><span class="o">)</span> <span class="o">(</span><span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="n">sizeOf</span> <span class="n">tail</span> <span class="bp">&lt;</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">lt_add_iff_pos_left</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="n">tail</span> <span class="bp">&lt;</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span> <span class="bp">==&gt;</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="mi">1</span>
</code></pre></div>



<a name="320036046"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036046" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036046">(Jan 08 2023 at 04:56)</a>:</h4>
<p><code>simp_wf</code> is declared as</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">macro</span> <span class="s2">"simp_wf"</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span>
  <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="n">simp</span> <span class="o">[</span><span class="n">invImage</span><span class="o">,</span> <span class="n">InvImage</span><span class="o">,</span> <span class="n">Prod.lex</span><span class="o">,</span> <span class="n">sizeOfWFRel</span><span class="o">,</span>
          <span class="n">measure</span><span class="o">,</span> <span class="n">Nat.lt_wfRel</span><span class="o">,</span> <span class="n">WellFoundedRelation.rel</span><span class="o">])</span>
</code></pre></div>
<p>It's a bit odd to me that it isn't a <code>simp only</code>; the goal is closed by a simp lemma that can immediately be applied after the wf lemmas</p>



<a name="320036093"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036093" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036093">(Jan 08 2023 at 04:57)</a>:</h4>
<p><span class="user-mention" data-user-id="571451">@Jeremy Salwen</span> is that with or without the mathlib simp lemmas?</p>



<a name="320036192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036192">(Jan 08 2023 at 04:58)</a>:</h4>
<p><span class="user-mention" data-user-id="407274">@James Gallicchio</span> It is intentional that it is not <code>simp only</code>, you should be able to mark your own functions as simp to improve the termination checker locally</p>



<a name="320036207"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036207" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036207">(Jan 08 2023 at 04:58)</a>:</h4>
<p>That is with them:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Data.Nat.Order.Basic</span>
<span class="kn">import</span> <span class="n">Mathlib.Data.Nat.Log</span>

<span class="kd">set_option</span> <span class="n">trace.Meta.Tactic.simp.rewrite</span> <span class="n">true</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">delim</span> <span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[])</span> <span class="o">(</span><span class="n">head</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">tail</span> <span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span>
  <span class="o">:</span> <span class="o">(</span><span class="n">invImage</span> <span class="o">(</span><span class="n">β</span> <span class="o">:=</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="bp">×'</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[])</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">instWellFoundedRelation</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span>
  <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span>
  <span class="o">:=</span> <span class="kd">by</span>
    <span class="n">simp_wf</span>
    <span class="c1">-- simp (config := { arith := true })</span>
</code></pre></div>



<a name="320036234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036234">(Jan 08 2023 at 04:59)</a>:</h4>
<p>it looks like it's closing the goal, so what's the problem?</p>



<a name="320036242"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036242" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036242">(Jan 08 2023 at 04:59)</a>:</h4>
<p>But actually for me James's MWE works fine.</p>



<a name="320036249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036249">(Jan 08 2023 at 04:59)</a>:</h4>
<p>Yeah ok, let me post from my original MWE</p>



<a name="320036372"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036372" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036372">(Jan 08 2023 at 05:01)</a>:</h4>
<p>Here is the output from the failing original MWE:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">InvImage</span><span class="o">,</span> <span class="n">InvImage</span> <span class="n">WellFoundedRelation.rel</span> <span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span>
      <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span>
        <span class="n">sizeOf</span>
          <span class="n">x</span> <span class="bp">==&gt;</span> <span class="k">fun</span> <span class="n">a₁</span> <span class="n">a₂</span> <span class="bp">=&gt;</span>
      <span class="n">WellFoundedRelation.rel</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">a₁</span><span class="o">)</span>
        <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">a₂</span><span class="o">)</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">ne_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]</span> <span class="bp">==&gt;</span> <span class="bp">¬</span><span class="n">delim</span> <span class="bp">=</span> <span class="o">[]</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">ne_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]</span> <span class="bp">==&gt;</span> <span class="bp">¬</span><span class="n">delim</span> <span class="bp">=</span> <span class="o">[]</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">InvImage</span><span class="o">,</span> <span class="n">InvImage</span> <span class="n">WellFoundedRelation.rel</span> <span class="n">sizeOf</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">a₁</span><span class="o">)</span>
      <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span>
        <span class="n">a₂</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="n">WellFoundedRelation.rel</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">a₁</span><span class="o">))</span>
      <span class="o">(</span><span class="n">sizeOf</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">a₂</span><span class="o">))</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">Nat.lt_wfRel</span><span class="o">,</span> <span class="n">Nat.lt_wfRel</span> <span class="bp">==&gt;</span> <span class="o">{</span> <span class="n">rel</span> <span class="o">:=</span> <span class="n">Nat.lt</span><span class="o">,</span> <span class="n">wf</span> <span class="o">:=</span> <span class="n">Nat.lt_wfRel.proof_1</span> <span class="o">}</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">sizeOf_nat</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="n">a₁.fst</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="n">sizeOf</span> <span class="n">a₁.fst</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">sizeOf_nat</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="n">a₂.fst</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="n">sizeOf</span> <span class="n">a₂.fst</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">Nat.lt_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">Nat.lt</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="n">a₁.fst</span><span class="o">)</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="n">a₂.fst</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="n">sizeOf</span> <span class="n">a₁.fst</span> <span class="bp">&lt;</span> <span class="n">sizeOf</span> <span class="n">a₂.fst</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">ne_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]</span> <span class="bp">==&gt;</span> <span class="bp">¬</span><span class="n">delim</span> <span class="bp">=</span> <span class="o">[]</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">ne_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]</span> <span class="bp">==&gt;</span> <span class="bp">¬</span><span class="n">delim</span> <span class="bp">=</span> <span class="o">[]</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">gt_iff_lt</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="o">(</span><span class="k">fun</span> <span class="n">a₁</span> <span class="n">a₂</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">a₁.fst</span> <span class="bp">&lt;</span> <span class="n">sizeOf</span> <span class="n">a₂.fst</span><span class="o">)</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span>
      <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span>
        <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span> <span class="bp">==&gt;</span> <span class="n">sizeOf</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span><span class="bp">.</span><span class="n">fst</span> <span class="bp">&lt;</span> <span class="n">sizeOf</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span><span class="bp">.</span><span class="n">fst</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">List.cons.sizeOf_spec</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="o">(</span><span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">head</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">sizeOf_default</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="n">head</span> <span class="bp">==&gt;</span> <span class="mi">0</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">add_zero</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="mi">1</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">==&gt;</span> <span class="mi">1</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">lt_add_iff_pos_left</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="n">tail</span> <span class="bp">&lt;</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span> <span class="bp">==&gt;</span> <span class="mi">0</span> <span class="bp">&lt;</span> <span class="mi">1</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">InvImage</span><span class="o">,</span> <span class="n">InvImage</span> <span class="n">WellFoundedRelation.rel</span> <span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span>
      <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span>
        <span class="n">sizeOf</span>
          <span class="n">x</span> <span class="bp">==&gt;</span> <span class="k">fun</span> <span class="n">a₁</span> <span class="n">a₂</span> <span class="bp">=&gt;</span>
      <span class="n">WellFoundedRelation.rel</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">a₁</span><span class="o">)</span>
        <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">a₂</span><span class="o">)</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">ne_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]</span> <span class="bp">==&gt;</span> <span class="bp">¬</span><span class="n">delim</span> <span class="bp">=</span> <span class="o">[]</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">ne_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]</span> <span class="bp">==&gt;</span> <span class="bp">¬</span><span class="n">delim</span> <span class="bp">=</span> <span class="o">[]</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">InvImage</span><span class="o">,</span> <span class="n">InvImage</span> <span class="n">WellFoundedRelation.rel</span> <span class="n">sizeOf</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">a₁</span><span class="o">)</span>
      <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span>
        <span class="n">a₂</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="n">WellFoundedRelation.rel</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">a₁</span><span class="o">))</span>
      <span class="o">(</span><span class="n">sizeOf</span> <span class="o">((</span><span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">PSigma.casesOn</span> <span class="n">a</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">snd</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">x</span><span class="o">)</span> <span class="n">a₂</span><span class="o">))</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">unfold</span> <span class="n">Nat.lt_wfRel</span><span class="o">,</span> <span class="n">Nat.lt_wfRel</span> <span class="bp">==&gt;</span> <span class="o">{</span> <span class="n">rel</span> <span class="o">:=</span> <span class="n">Nat.lt</span><span class="o">,</span> <span class="n">wf</span> <span class="o">:=</span> <span class="n">Nat.lt_wfRel.proof_1</span> <span class="o">}</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">sizeOf_nat</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="n">a₁.fst</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="n">sizeOf</span> <span class="n">a₁.fst</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">sizeOf_nat</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="n">a₂.fst</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="n">sizeOf</span> <span class="n">a₂.fst</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">Nat.lt_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">Nat.lt</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="n">a₁.fst</span><span class="o">)</span> <span class="o">(</span><span class="n">sizeOf</span> <span class="n">a₂.fst</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="n">sizeOf</span> <span class="n">a₁.fst</span> <span class="bp">&lt;</span> <span class="n">sizeOf</span> <span class="n">a₂.fst</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">ne_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]</span> <span class="bp">==&gt;</span> <span class="bp">¬</span><span class="n">delim</span> <span class="bp">=</span> <span class="o">[]</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">ne_eq</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]</span> <span class="bp">==&gt;</span> <span class="bp">¬</span><span class="n">delim</span> <span class="bp">=</span> <span class="o">[]</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">gt_iff_lt</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="o">(</span><span class="k">fun</span> <span class="n">a₁</span> <span class="n">a₂</span> <span class="bp">=&gt;</span> <span class="n">sizeOf</span> <span class="n">a₁.fst</span> <span class="bp">&lt;</span> <span class="n">sizeOf</span> <span class="n">a₂.fst</span><span class="o">)</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">rest</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span>
      <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span>
        <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span> <span class="bp">==&gt;</span> <span class="n">sizeOf</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">rest</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span><span class="bp">.</span><span class="n">fst</span> <span class="bp">&lt;</span> <span class="n">sizeOf</span> <span class="o">{</span> <span class="n">fst</span> <span class="o">:=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">,</span> <span class="n">snd</span> <span class="o">:=</span> <span class="n">h</span> <span class="o">}</span><span class="bp">.</span><span class="n">fst</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">List.cons.sizeOf_spec</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="o">(</span><span class="n">head</span> <span class="o">::</span> <span class="n">tail</span><span class="o">)</span> <span class="bp">==&gt;</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">head</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">sizeOf_default</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">sizeOf</span> <span class="n">head</span> <span class="bp">==&gt;</span> <span class="mi">0</span>

<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="bp">@</span><span class="n">add_zero</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="mi">1</span> <span class="bp">+</span> <span class="mi">0</span> <span class="bp">==&gt;</span> <span class="mi">1</span>
</code></pre></div>



<a name="320036395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036395">(Jan 08 2023 at 05:01)</a>:</h4>
<p>As I mentioned before the orignal MWE did not display any unsolved goal, <em>just</em> the error message that it couldn't prove termination, as I showed in the screenshot.</p>



<a name="320036717"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036717" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036717">(Jan 08 2023 at 05:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="571451">Jeremy Salwen</span> <a href="#narrow/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof/near/320036395">said</a>:</p>
<blockquote>
<p>As I mentioned before the orignal MWE did not display any unsolved goal, <em>just</em> the error message that it couldn't prove termination, as I showed in the screenshot.</p>
</blockquote>
<p>This is an error reporting issue. I believe it is leaving goals, but they aren't being reported</p>



<a name="320036774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036774">(Jan 08 2023 at 05:06)</a>:</h4>
<p>one trick you can do is <code>termination_by decreasing_tactic; trace_state</code> (untested)</p>



<a name="320036809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036809" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036809">(Jan 08 2023 at 05:07)</a>:</h4>
<p>Hmm, <code>trace_state</code> seems to only output an empty message :(</p>



<a name="320036910"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036910" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036910">(Jan 08 2023 at 05:09)</a>:</h4>
<p>aside from the error reporting, I think <code>decreasing_tactic</code> should probably be modified include a <code>done</code> alternative. if you add</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">macro_rules</span> <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="n">decreasing_trivial</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="n">done</span><span class="o">)</span>
</code></pre></div>
<p>to the original MWE it compiles with/without mathlib :)</p>



<a name="320036980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320036980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320036980">(Jan 08 2023 at 05:10)</a>:</h4>
<p>definitely a bug from user perspective, if <code>simp_wf</code> is actually intended to apply all simp lemmas</p>



<a name="320037014"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037014" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037014">(Jan 08 2023 at 05:11)</a>:</h4>
<p>Here's a workaround by inlining stuff:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Std.Data.List.Basic</span>
<span class="kn">import</span> <span class="n">Mathlib.Data.Nat.Log</span>

<span class="kn">open</span> <span class="n">Lean</span>

<span class="kd">def</span> <span class="n">examp</span> <span class="o">[</span><span class="n">DecidableEq</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">delim</span><span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span><span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]):</span> <span class="n">List</span> <span class="n">α</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">h₀</span><span class="o">:</span> <span class="n">l</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="o">[]</span> <span class="bp">=&gt;</span> <span class="o">[]</span>
  <span class="bp">|</span> <span class="n">head</span><span class="o">::</span><span class="n">tail</span> <span class="bp">=&gt;</span>
    <span class="k">match</span> <span class="n">List.getRest</span> <span class="n">l</span> <span class="n">delim</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="n">none</span> <span class="bp">=&gt;</span> <span class="n">examp</span> <span class="n">delim</span> <span class="n">tail</span> <span class="n">h</span>
    <span class="bp">|</span> <span class="n">some</span> <span class="n">rest</span> <span class="bp">=&gt;</span>
      <span class="k">have</span> <span class="n">_x</span><span class="o">:</span> <span class="n">sizeOf</span> <span class="n">rest</span> <span class="bp">&lt;</span> <span class="n">sizeOf</span> <span class="n">l</span> <span class="o">:=</span> <span class="kd">by</span> <span class="gr">sorry</span>
      <span class="n">examp</span> <span class="n">delim</span> <span class="n">rest</span> <span class="n">h</span>
<span class="n">decreasing_by</span>
  <span class="n">simp_wf</span>
  <span class="n">repeat</span> <span class="o">(</span><span class="n">first</span> <span class="bp">|</span> <span class="n">apply</span> <span class="n">Prod.Lex.right</span> <span class="bp">|</span> <span class="n">apply</span> <span class="n">Prod.Lex.left</span><span class="o">)</span>
  <span class="n">repeat</span> <span class="o">(</span><span class="n">first</span> <span class="bp">|</span> <span class="n">apply</span> <span class="n">PSigma.Lex.right</span> <span class="bp">|</span> <span class="n">apply</span> <span class="n">PSigma.Lex.left</span><span class="o">)</span>
</code></pre></div>
<p>which shows an error at <code>examp delim rest h</code> (so it was the second goal after all):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">unsolved</span> <span class="n">goals</span>
<span class="n">deliml</span><span class="o">:</span> <span class="n">List</span> <span class="n">α</span>
<span class="n">h</span><span class="o">:</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]</span>
<span class="n">head</span><span class="o">:</span> <span class="n">α</span>
<span class="n">tail</span><span class="o">:</span> <span class="n">List</span> <span class="n">α</span>
<span class="n">h₀</span><span class="o">:</span> <span class="n">l</span> <span class="bp">=</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span>
<span class="n">rest</span><span class="o">:</span> <span class="n">List</span> <span class="n">α</span>
<span class="n">_x</span><span class="o">:</span> <span class="n">sizeOf</span> <span class="n">rest</span> <span class="bp">&lt;</span> <span class="n">sizeOf</span> <span class="n">l</span>
<span class="bp">⊢</span> <span class="n">sizeOf</span> <span class="n">rest</span> <span class="bp">&lt;</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span>
</code></pre></div>



<a name="320037083"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037083" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037083">(Jan 08 2023 at 05:12)</a>:</h4>
<p>the first goal is closed by <code>simp_wf</code> alone. the second goal is closed by <code>decreasing_tactic</code>.</p>



<a name="320037096"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037096" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037096">(Jan 08 2023 at 05:13)</a>:</h4>
<p>the issue is <code>decreasing_tactic</code> doesn't close something that <code>simp_wf</code> closes by itself :)</p>



<a name="320037106"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037106" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037106">(Jan 08 2023 at 05:13)</a>:</h4>
<p>oh I see, adding <code>try decreasing_tactic</code> at the end makes it pass</p>



<a name="320037156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037156">(Jan 08 2023 at 05:14)</a>:</h4>
<p>i partly suspect <code>simp_wf</code> should be <code>simp only</code>, since <code>decreasing_tactic</code> has a <code>simp</code> call anyways...</p>
<p>(is there a reasonable way I can test changes to <code>simp_wf</code>? editing the lean-toolchain's file and reloading doesn't seem to do anything)</p>



<a name="320037166"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037166" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037166">(Jan 08 2023 at 05:14)</a>:</h4>
<p>If I introduce <code>have _: sizeOf rest &lt; 1 + sizeOf tail := by sorry</code> at the second recursion, it still fails for me.</p>



<a name="320037196"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037196" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037196">(Jan 08 2023 at 05:15)</a>:</h4>
<p>not for me, that works (with <code>try decreasing_tactic</code>)</p>



<a name="320037271"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037271" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037271">(Jan 08 2023 at 05:16)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Std.Data.List.Basic</span>
<span class="kn">import</span> <span class="n">Mathlib.Data.Nat.Log</span>

<span class="kn">open</span> <span class="n">Lean</span>

<span class="kd">def</span> <span class="n">examp</span> <span class="o">[</span><span class="n">DecidableEq</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">delim</span><span class="o">:</span> <span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">l</span><span class="o">:</span><span class="n">List</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span><span class="o">:</span> <span class="n">delim</span> <span class="bp">≠</span> <span class="o">[]):</span> <span class="n">List</span> <span class="n">α</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">h₀</span><span class="o">:</span> <span class="n">l</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="o">[]</span> <span class="bp">=&gt;</span> <span class="o">[]</span>
  <span class="bp">|</span> <span class="n">head</span><span class="o">::</span><span class="n">tail</span> <span class="bp">=&gt;</span>
    <span class="k">match</span> <span class="n">List.getRest</span> <span class="n">l</span> <span class="n">delim</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="n">none</span> <span class="bp">=&gt;</span> <span class="n">examp</span> <span class="n">delim</span> <span class="n">tail</span> <span class="n">h</span>
    <span class="bp">|</span> <span class="n">some</span> <span class="n">rest</span> <span class="bp">=&gt;</span>
      <span class="k">have</span> <span class="n">_</span><span class="o">:</span> <span class="n">sizeOf</span> <span class="n">rest</span> <span class="bp">&lt;</span> <span class="mi">1</span> <span class="bp">+</span> <span class="n">sizeOf</span> <span class="n">tail</span> <span class="o">:=</span> <span class="kd">by</span> <span class="gr">sorry</span>
      <span class="k">have</span> <span class="n">_</span><span class="o">:</span> <span class="n">sizeOf</span> <span class="n">rest</span> <span class="bp">&lt;</span>  <span class="n">sizeOf</span> <span class="n">l</span> <span class="o">:=</span> <span class="kd">by</span> <span class="gr">sorry</span>
      <span class="n">examp</span> <span class="n">delim</span> <span class="n">rest</span> <span class="n">h</span>
<span class="n">decreasing_by</span> <span class="n">try</span> <span class="n">decreasing_tactic</span>
</code></pre></div>
<p>is what fails for me.</p>



<a name="320037286"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037286" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037286">(Jan 08 2023 at 05:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="571451">Jeremy Salwen</span> <a href="#narrow/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof/near/320037166">said</a>:</p>
<blockquote>
<p>If I introduce <code>have _: sizeOf rest &lt; 1 + sizeOf tail := by sorry</code> at the second recursion, it still fails for me.</p>
</blockquote>
<p>(I think the first recursive call fails in your MWE, not the second. <code>decreasing_tactic</code> <em>should</em> succeed on both, but there's a bug that causes it to break with poor error messages)</p>



<a name="320037311"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037311" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037311">(Jan 08 2023 at 05:17)</a>:</h4>
<p>ahh ok</p>



<a name="320037318"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037318" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037318">(Jan 08 2023 at 05:17)</a>:</h4>
<p><code>decreasing_by try simp_wf; try decreasing_tactic</code> works</p>



<a name="320037369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037369" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037369">(Jan 08 2023 at 05:18)</a>:</h4>
<p>in particular, it does a <code>simp_wf</code> which closes the goal for rec call 1, but then does another <code>simp</code> which fails. there's many ways to resolve this bug, I'm not sure what is the right one...</p>



<a name="320037375"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037375" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037375">(Jan 08 2023 at 05:18)</a>:</h4>
<p>Do you know what the bug is?</p>



<a name="320037722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037722" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037722">(Jan 08 2023 at 05:25)</a>:</h4>
<p>I think <code>decreasing_with</code> should look more like</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span>
   <span class="o">(</span><span class="n">simp_wf</span>
    <span class="n">repeat</span> <span class="o">(</span><span class="n">first</span> <span class="bp">|</span> <span class="n">apply</span> <span class="n">Prod.Lex.right</span> <span class="bp">|</span> <span class="n">apply</span> <span class="n">Prod.Lex.left</span><span class="o">)</span>
    <span class="n">repeat</span> <span class="o">(</span><span class="n">first</span> <span class="bp">|</span> <span class="n">apply</span> <span class="n">PSigma.Lex.right</span> <span class="bp">|</span> <span class="n">apply</span> <span class="n">PSigma.Lex.left</span><span class="o">)</span>
    <span class="n">first</span>
    <span class="bp">|</span> <span class="n">done</span>
    <span class="bp">|</span> <span class="bp">$</span><span class="n">ts</span>
    <span class="bp">|</span> <span class="n">fail</span> <span class="s2">"failed to prove termination, possible solutions: ..."</span><span class="o">)</span>
</code></pre></div>



<a name="320037981"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320037981" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320037981">(Jan 08 2023 at 05:30)</a>:</h4>
<p>Yeah, that's definitely an option too. I'm sorta of the mind that <code>decreasing_with</code> should guarantee that it applies the tactic you pass (which would imply that <code>simp_wf</code> shouldn't be closing goals on its own)</p>



<a name="320038009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038009">(Jan 08 2023 at 05:31)</a>:</h4>
<p>I think the tactic should try to be monotonic with respect to strengthening tactics</p>



<a name="320038015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038015" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038015">(Jan 08 2023 at 05:31)</a>:</h4>
<p>But then again, even <code>simp only</code> could close a goal <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="320038018"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038018" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038018">(Jan 08 2023 at 05:31)</a>:</h4>
<p>exactly</p>



<a name="320038081"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038081" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038081">(Jan 08 2023 at 05:32)</a>:</h4>
<p>Then yeah, would support adding it there. we could also make <code>decreasing_trivial</code> elaborate to <code>done</code>, but I don't know if trivial implies done...</p>



<a name="320038097"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038097" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038097">(Jan 08 2023 at 05:32)</a>:</h4>
<p>it doesn't</p>



<a name="320038122"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038122" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038122">(Jan 08 2023 at 05:32)</a>:</h4>
<p>if it did we wouldn't have this error</p>



<a name="320038138"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038138" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038138">(Jan 08 2023 at 05:32)</a>:</h4>
<p>none of the <code>decreasing_trivial</code> tactics succeed on no goals</p>



<a name="320038157"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038157" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038157">(Jan 08 2023 at 05:33)</a>:</h4>
<p>Yeah. I assume lean3's <code>trivial</code> also fails on empty context, and we should keep that property...</p>



<a name="320038256"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038256" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038256">(Jan 08 2023 at 05:34)</a>:</h4>
<p>(are you working on a PR for this? or should I?)</p>



<a name="320038404"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038404" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038404">(Jan 08 2023 at 05:36)</a>:</h4>
<p>go for it</p>



<a name="320038429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320038429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320038429">(Jan 08 2023 at 05:36)</a>:</h4>
<p>don't forget to add a test</p>



<a name="320039632"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320039632" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jeremy Salwen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320039632">(Jan 08 2023 at 05:55)</a>:</h4>
<p>Thanks for helping with this! <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span></p>



<a name="320039730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Importing%20Log%20breaks%20termination%20proof/near/320039730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Importing.20Log.20breaks.20termination.20proof.html#320039730">(Jan 08 2023 at 05:57)</a>:</h4>
<p>Thank you for finding the bug! I'm quite surprised this edge case hasn't come up before, honestly</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>