---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Modified.20typeclass.20resolution.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html">Modified typeclass resolution</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="259935575"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/259935575" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#259935575">(Nov 01 2021 at 23:32)</a>:</h4>
<p>In a recent <a href="#narrow/stream/270676-lean4/topic/Breaking.20instance.20resolution.20loop">post</a>, I had an issue with a special kind of infinite loop during typeclass synthesis. Concretely, the loop is of the form:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">C</span>
<span class="n">α</span> <span class="bp">→</span> <span class="n">C</span>
<span class="n">α</span> <span class="bp">→</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">C</span>
<span class="n">α</span> <span class="bp">→</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">C</span>
<span class="bp">...</span>
</code></pre></div>
<p>I believed that it should be fixable and after a weekend of thinking and coding I have a fix.</p>
<p>I have <a href="https://github.com/lecopivo/lean4/commit/6348d674408b503673a91be26bea4420418a8851">forked lean4</a> and now the typeclass synthetisis should work much better for synthesizing classes of the form <code>(a : α) → C</code> where <code>a</code> does not appear in <code>C</code>.  The modified lean does not break a single unit test, so hopefully the modification is purely an extension.</p>
<p>Why did I do that? I want to work with unbundled morphisms. In mathlib, we work with unbundled objects and any kind of structure is fetch on the fly with the typeclass system. I want to do the same for functions and on the fly fetch a proof that a function is linear, continuous, differentiable, ...</p>
<p>Here is an example of what the modification allows. All of the examples are automatically solver by typeclass resolution and those six instances roughly correspond to rules that hold in cartesian closed category.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">is_smooth</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span><span class="o">}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span> <span class="gr">sorry</span>

<span class="kd">class</span> <span class="n">IsSmooth</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span><span class="o">}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="n">where</span>
  <span class="o">(</span><span class="n">proof</span> <span class="o">:</span> <span class="n">is_smooth</span> <span class="n">f</span><span class="o">)</span>

<span class="kd">instance</span> <span class="n">identity</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="k">fun</span> <span class="n">a</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">=&gt;</span> <span class="n">a</span> <span class="o">:=</span> <span class="gr">sorry</span>
<span class="kd">instance</span> <span class="n">const</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="k">fun</span> <span class="n">a</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">=&gt;</span> <span class="n">b</span> <span class="o">:=</span> <span class="gr">sorry</span>
<span class="kd">instance</span> <span class="n">swap</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">a</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">)]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">b</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="gr">sorry</span>
<span class="kd">instance</span> <span class="n">parm</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="gr">sorry</span>
<span class="kd">instance</span> <span class="n">comp</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">g</span><span class="o">)</span> <span class="o">:=</span> <span class="gr">sorry</span>
<span class="kd">instance</span> <span class="n">diag</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">b</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">b</span><span class="o">)]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="n">a</span><span class="o">))</span> <span class="o">:=</span> <span class="gr">sorry</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">g</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="bp">λ</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="o">(</span><span class="n">f</span> <span class="bp">∘</span> <span class="n">g</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">(</span><span class="n">d</span> <span class="o">:</span> <span class="n">δ</span><span class="o">)</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">a</span><span class="o">)</span> <span class="n">d</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">d</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">a</span><span class="o">)</span> <span class="n">d</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">d</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">d</span><span class="o">)]</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">d</span> <span class="bp">=&gt;</span> <span class="o">(</span><span class="n">f</span> <span class="n">d</span> <span class="o">(</span><span class="n">g</span> <span class="n">a</span><span class="o">)))</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">h</span><span class="o">]</span> <span class="o">(</span><span class="n">d</span> <span class="o">:</span> <span class="n">δ</span><span class="o">)</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="o">(</span><span class="n">h</span> <span class="n">a</span><span class="o">))</span> <span class="n">d</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">a</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">)]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">b</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="o">)]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">c</span> <span class="n">b</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="o">)]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">c</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">ε</span><span class="o">)</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">)]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">d</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">γ</span><span class="o">)</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">c</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="n">γ</span><span class="o">)</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="o">)]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">c</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">ε</span> <span class="bp">→</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">ε</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">a</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">)]</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">h</span><span class="o">]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">x</span> <span class="n">y</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span> <span class="n">y</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="n">x</span> <span class="n">y</span><span class="o">))</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">b</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">b</span><span class="o">)]</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">):</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="n">a</span><span class="o">))</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="n">a</span><span class="o">))</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">d</span> <span class="o">:</span> <span class="n">δ</span><span class="o">)</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">a</span><span class="o">)</span> <span class="n">d</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)))</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">a</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">)]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">b</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">δ</span><span class="o">)</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="o">)]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">c</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">ε</span><span class="o">)</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">)]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">d</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">(</span><span class="n">d</span> <span class="o">:</span> <span class="n">δ</span><span class="o">)</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">a</span><span class="o">)</span> <span class="n">d</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">f</span><span class="o">]</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">d</span> <span class="bp">=&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">a</span><span class="o">)</span> <span class="n">d</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
<span class="kd">example</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">δ</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">)</span> <span class="o">[</span><span class="bp">∀</span> <span class="n">d</span><span class="o">,</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="n">f</span> <span class="n">d</span><span class="o">)]</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">[</span><span class="n">IsSmooth</span> <span class="n">g</span><span class="o">]</span> <span class="o">:</span> <span class="n">IsSmooth</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">d</span> <span class="bp">=&gt;</span> <span class="o">(</span><span class="n">f</span> <span class="n">d</span> <span class="o">(</span><span class="n">g</span> <span class="n">a</span><span class="o">)))</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">infer_instance</span>
</code></pre></div>
<p>Any thoughts on this? Is it a good idea to add this to lean?</p>



<a name="261925433"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/261925433" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Floris van Doorn <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#261925433">(Nov 18 2021 at 13:17)</a>:</h4>
<p>I somehow completely missed this post. <br>
This looks amazing! This would be incredibly useful for a lot of predicates on functions in mathlib.</p>



<a name="261974033"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/261974033" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#261974033">(Nov 18 2021 at 19:05)</a>:</h4>
<p><span class="user-mention" data-user-id="346070">@Tomas Skrivan</span> seems very cool! Does it pass all the tests? If so, why not PR it to Lean? You have already written the changes so there is little cost and it would likely be more easily noticed by <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> or <span class="user-mention" data-user-id="112857">@Leonardo de Moura</span>.</p>



<a name="261976597"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/261976597" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#261976597">(Nov 18 2021 at 19:21)</a>:</h4>
<p>Yes it passes all tests, but I know it is breakable by some intricate classes with dependent types. Should be fairly easy to fix and then I can make a PR, I just didn't have time to do it yet. Also I do not fully understand the whole TC resolution, so I thought I keep testing it before PR.</p>



<a name="261977351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/261977351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#261977351">(Nov 18 2021 at 19:26)</a>:</h4>
<p>Yes and I find it very very useful. I'm writing automatic differentiation tool with it where I use the TC system to prove that certain functions are smooth, linear, invertible. I can almost do symbolic calculations in variational calculus like deriving Euler-Lagrange equation by taking gradient of action, not completely there yet but soon.</p>



<a name="261994248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/261994248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#261994248">(Nov 18 2021 at 21:34)</a>:</h4>
<p><span class="user-mention" data-user-id="346070">@Tomas Skrivan</span> This looks very interesting. Thanks for investigating the issue and finding a solution. I am currently busy with boring stuff (slides, proposal writing, etc), but I will try to find time during the weekend to go over your code. Could you please add comments and any other information it may be relevant?</p>



<a name="261995223"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/261995223" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#261995223">(Nov 18 2021 at 21:43)</a>:</h4>
<p>If you open a PR, we can also check if there are any (significant) performance regressions</p>



<a name="262004411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/262004411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#262004411">(Nov 18 2021 at 23:02)</a>:</h4>
<p>I will explain and comment the code, but I'm away from a computer for the next three days so I can't touch the code or make a PR.</p>



<a name="262046948"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/262046948" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#262046948">(Nov 19 2021 at 09:59)</a>:</h4>
<p><span class="user-mention" data-user-id="112857">@Leonardo de Moura</span>  Let me explain how it works.</p>
<p>The main problem is to deal with instances of type <code>a : A -&gt; C</code> where <code>a</code> does not appear in class <code>C</code>. When you look for such an instance it is enough to look for an instance <code>c : C</code> and then return <code>fun _ =&gt; c</code>.</p>
<p>My solution makes sure that instance of a type like <code>a : A -&gt; C</code> never gets tabled/cached. More on that later.</p>
<p>At the core is the function <code>removeUnusedArguments</code>, it takes an expression <code>E</code> and does two things:</p>
<p>1. Removes unused arguments producing <code>E'</code>, for example<br>
<code>a : A -&gt; C</code> to <code>C</code><br>
<code>a1 : A1 -&gt; a2 : A2 -&gt; C a1</code> to <code>a1 : A1 -&gt; C a1</code><br>
<code>a1 : A1 -&gt; a2 : A2 -&gt; a3 : A3 a1 -&gt; C a3</code> to <code>a1 : A1 -&gt; a3 : A3 a1 -&gt; C a3</code> (this does not work and need to be fixed)</p>
<p>2. Creates a function to do the reverse transformation <code>E' -&gt; E</code>, for example:<br>
<code>C -&gt; (a : A -&gt; C)</code><br>
<code>(a1 : A1 -&gt; C a1) -&gt; (a1 : A1 -&gt; a2 : A2 -&gt; C a1)</code></p>
<p>The modification to TC resolution works this way: We are looking for an instance of <code>E</code>, if it is tabled just get it as normal, but if not first remove all unused arguments producing <code>E'</code>. Now we look up the table again but for <code>E'</code>. If it exists, use the map <code>E' -&gt; E</code> to create <code>E</code>. If it does not exists, create a new goal <code>E'</code>.</p>
<p>Maybe as an optimization, <code>E</code> can be added to the table too, but I do not know how to setup proper dependency on <code>E'</code>, i.e. correct generator, waiter and consumer nodes.</p>
<p>I have also added few comment to the <a href="https://github.com/lecopivo/lean4/commit/6348d674408b503673a91be26bea4420418a8851">code</a>. Let me know if something is unclear.</p>



<a name="262392149"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/262392149" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#262392149">(Nov 22 2021 at 23:28)</a>:</h4>
<p>I have created a <a href="https://github.com/leanprover/lean4/pull/815">pull request</a> </p>
<p>Unfortunately, I have messed up few things on my github, so my code comments disappeared. I will try to comment the code again at some point.</p>



<a name="262392397"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/262392397" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#262392397">(Nov 22 2021 at 23:31)</a>:</h4>
<p>If you ever committed the comments, git reflog probably still lists those commits even if you overwrote them later</p>



<a name="262392687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Modified%20typeclass%20resolution/near/262392687" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Modified.20typeclass.20resolution.html#262392687">(Nov 22 2021 at 23:34)</a>:</h4>
<p>Well I have managed to make a mess with few branches and stupid commits. So I thought that the easiest thing to do in order to clean in up and submit a nice pull request would be to delete the github repo and fork it again :)</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>