---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html">performance regression in nightly-2021-08-04?</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="248362837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248362837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248362837">(Aug 04 2021 at 15:04)</a>:</h4>
<p>I'm noticing that some of my code got noticeably slower in nightly-2021-08-04. In particular,</p>



<a name="248362846"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248362846" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248362846">(Aug 04 2021 at 15:04)</a>:</h4>
<p><a href="https://github.com/dwrensha/lean4-maze/blob/5121db6df78c6ab4d26afcfae77f62172dade1a8/Maze.lean#L392-L396">https://github.com/dwrensha/lean4-maze/blob/5121db6df78c6ab4d26afcfae77f62172dade1a8/Maze.lean#L392-L396</a></p>



<a name="248362960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248362960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248362960">(Aug 04 2021 at 15:05)</a>:</h4>
<p>When I move my cursor through that tactic proof in emacs, it now seems to take about 2 seconds for the goal view to update.</p>



<a name="248363007"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248363007" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248363007">(Aug 04 2021 at 15:05)</a>:</h4>
<p>Before I updated to nightly-2021-08-04, it was more like a half second.</p>



<a name="248363409"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248363409" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248363409">(Aug 04 2021 at 15:08)</a>:</h4>
<p>nightly-2021-08-03 does not seem to have this problem, so it seems that something changed in the last day or so to cause this</p>



<a name="248363929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248363929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248363929">(Aug 04 2021 at 15:12)</a>:</h4>
<p>can you pls try setting <code>set_option pp.analyze false</code>?</p>



<a name="248364118"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248364118" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248364118">(Aug 04 2021 at 15:14)</a>:</h4>
<p>ah, that makes things snappy once again!</p>



<a name="248364238"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248364238" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248364238">(Aug 04 2021 at 15:14)</a>:</h4>
<p>It got merged yesterday, and it hasn't been perf-stress-tested yet. I will investigate.</p>



<a name="248364330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248364330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248364330">(Aug 04 2021 at 15:15)</a>:</h4>
<p><a href="https://github.com/leanprover/lean4/pull/575">https://github.com/leanprover/lean4/pull/575</a></p>



<a name="248364556"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248364556" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248364556">(Aug 04 2021 at 15:16)</a>:</h4>
<p>(^ link to what seems to be the relevant pull request, for context)</p>



<a name="248434932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/performance%20regression%20in%20nightly-2021-08-04%3F/near/248434932" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/performance.20regression.20in.20nightly-2021-08-04.3F.html#248434932">(Aug 05 2021 at 03:36)</a>:</h4>
<p><span class="user-mention" data-user-id="243791">@David Renshaw</span> I issued a PR that speeds your example up a good deal (<a href="https://github.com/leanprover/lean4/pull/605">https://github.com/leanprover/lean4/pull/605</a>). There is still some overhead though with <code>pp.analyze true</code>, since the analyzer still preprocesses your big terms even though its annotations are ignored by your custom delaborator. There is probably more relatively low hanging fruit to optimize the analyzer further, but note that your example is the epitome of one where you don't want <code>pp.analyze</code> to run. It is not clear yet whether it is appropriate for <code>pp.analyze</code> to be the default, but I think your example is "advanced" enough already such that needing to explicitly disable it for best performance would be reasonable.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>