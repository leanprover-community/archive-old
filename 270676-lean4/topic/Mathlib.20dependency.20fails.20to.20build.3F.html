---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html">Mathlib dependency fails to build?</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="298875697"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/298875697" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#298875697">(Sep 14 2022 at 22:45)</a>:</h4>
<p>It seems like every time I <code>lake update</code> and bump my toolchain, some parts of Mathlib fail to update. I just did a bump to 09-11, and it errors trying to build <code>Mathlib/Data/Option/Basic.lean</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">error</span><span class="o">:</span> <span class="bp">&gt;</span> <span class="n">LEAN_PATH</span><span class="bp">=./</span><span class="n">lean_packages</span><span class="bp">/</span><span class="n">Cli</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">./</span><span class="n">lean_packages</span><span class="bp">/</span><span class="n">leanInk</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">./</span><span class="n">lean_packages</span><span class="bp">/</span><span class="n">doc</span><span class="bp">-</span><span class="n">gen4</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">./</span><span class="n">lean_packages</span><span class="bp">/</span><span class="n">Unicode</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">./</span><span class="n">lean_packages</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">./</span><span class="n">lean_packages</span><span class="bp">/</span><span class="n">std</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">./</span><span class="n">lean_packages</span><span class="bp">/</span><span class="n">lake</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">./</span><span class="n">lean_packages</span><span class="bp">/</span><span class="n">CMark</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span> <span class="n">LD_LIBRARY_PATH</span><span class="bp">=/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-09-11/lib:./lean_packages/mathlib/build/lib /home/james/.elan/toolchains/leanprover--lean4---nightly-2022-09-11/bin/lean ./lean_packages/mathlib/././Mathlib/Data/Option/Basic.lean -R ./lean_packages/mathlib/./. -o ./lean_packages/mathlib/build/lib/Mathlib/Data/Option/Basic.olean -i ./lean_packages/mathlib/build/lib/Mathlib/Data/Option/Basic.ilean -c ./lean_packages/mathlib/build/ir/Mathlib/Data/Option/Basic.c</span>
<span class="n">error</span><span class="o">:</span> <span class="n">stdout</span><span class="o">:</span>
<span class="bp">./</span><span class="n">lean_packages</span><span class="bp">/</span><span class="n">mathlib</span><span class="bp">/././</span><span class="n">Mathlib</span><span class="bp">/</span><span class="n">Data</span><span class="bp">/</span><span class="n">Option</span><span class="bp">/</span><span class="n">Basic.lean</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="kn">import</span> <span class="n">failed</span><span class="o">,</span> <span class="n">environment</span> <span class="n">already</span> <span class="n">contains</span> <span class="bp">'</span><span class="n">Option.elim._cstage2'</span>
</code></pre></div>
<p>Am I doing something wrong in the process of updating? It looks like it's building fine on the mathlib github...</p>



<a name="298881446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/298881446" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#298881446">(Sep 14 2022 at 23:35)</a>:</h4>
<p>Maybe you could post your <code>lakefile</code>? Have you tried <code>lake clean</code>? I've experienced transient errors on upgrading that it seems <code>lake clean</code> resolved.</p>



<a name="298883017"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/298883017" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#298883017">(Sep 14 2022 at 23:54)</a>:</h4>
<p><code>lake clean</code> and even deleting the <code>lean_packages</code> folders doesn't seem to resolve it... the repo is up to date: <a href="https://github.com/JamesGallicchio/LeanColls">https://github.com/JamesGallicchio/LeanColls</a><br>
lakefile: <a href="https://github.com/JamesGallicchio/LeanColls/blob/main/lakefile.lean">https://github.com/JamesGallicchio/LeanColls/blob/main/lakefile.lean</a><br>
manifest.json: <a href="https://github.com/JamesGallicchio/LeanColls/blob/main/lean_packages/manifest.json">https://github.com/JamesGallicchio/LeanColls/blob/main/lean_packages/manifest.json</a></p>



<a name="298883108"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/298883108" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#298883108">(Sep 14 2022 at 23:55)</a>:</h4>
<p>I haven't spent much time investigating, just was hoping someone else had experienced this <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="298990240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/298990240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#298990240">(Sep 15 2022 at 15:06)</a>:</h4>
<p>This usually means you have the wrong Lean version.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>cp lean_packages/mathlib/lean-toolchain .
</code></pre></div>



<a name="298993240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/298993240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#298993240">(Sep 15 2022 at 15:22)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> once mentioned <code>lake update</code> can help with these sorts of issues too</p>



<a name="298993847"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/298993847" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#298993847">(Sep 15 2022 at 15:25)</a>:</h4>
<p>Having so many dependencies is a bit terrifying in my experience. You also have to check the entire chain of dependencies of their dependencies and make sure it's all coherent and consistent</p>



<a name="298994280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/298994280" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#298994280">(Sep 15 2022 at 15:28)</a>:</h4>
<p>An issue I faced once was that I had dependencies A and B, but A also depended on an older version of B. And Lake downloaded the older version of B to satisfy A but then my own project ended up depending on an incompatible version of B</p>



<a name="298994398"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/298994398" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#298994398">(Sep 15 2022 at 15:28)</a>:</h4>
<p>That bug has been fixed now.</p>



<a name="299019072"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299019072" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299019072">(Sep 15 2022 at 17:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F/near/298990240">said</a>:</p>
<blockquote>
<p>This usually means you have the wrong Lean version.</p>
<p><div class="codehilite" data-code-language="Bash"><pre><span></span><code>cp lean_packages/mathlib/lean-toolchain .
</code></pre></div><br>
</p>
</blockquote>
<p>They are identical... :/</p>



<a name="299019331"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299019331" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299019331">(Sep 15 2022 at 17:38)</a>:</h4>
<p>I have also run <code>lake update</code>, which is how I got to my current manifest</p>



<a name="299020054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299020054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299020054">(Sep 15 2022 at 17:42)</a>:</h4>
<p>Does it work if you first delete <code>lean_packages/mathlib/build</code>?</p>



<a name="299020375"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299020375" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299020375">(Sep 15 2022 at 17:44)</a>:</h4>
<p>Deleting everything in lean_packages (minus the <code>manifest.json</code>) does not resolve anything. I'm gonna investigate where the errors are actually coming from, see if I can figure out where the version mismatch is</p>



<a name="299020642"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299020642" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299020642">(Sep 15 2022 at 17:46)</a>:</h4>
<p>Ah... I missed that</p>



<a name="299020747"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299020747" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299020747">(Sep 15 2022 at 17:46)</a>:</h4>
<p>Regardless, this situation seems not ideal <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> Maybe I am updating my dependencies way more frequently than everyone else but this has been a recurring issue. Does lake check that all dependencies' toolchains match the current project's?</p>



<a name="299109101"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299109101" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299109101">(Sep 16 2022 at 07:56)</a>:</h4>
<p>Oh, I never updated this thread -- I must have been <code>lake update</code>ing during a period when std4 and mathlib4 were out of sync, and <code>lake</code> evidently doesn't check that toolchains match</p>



<a name="299109160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299109160" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299109160">(Sep 16 2022 at 07:57)</a>:</h4>
<p>(std4 was already updated to 09-15; mathlib and my lib were on 09-11. lake downloaded the most recent packages for everything)</p>



<a name="299109559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299109559" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299109559">(Sep 16 2022 at 07:59)</a>:</h4>
<p>This is definitely made worse by being on nightly, maybe it'll be less bad when development calms down a bit, but is there any improvement that could be made here?</p>
<p>My ideal would be for <code>lake</code> to poll which toolchain versions the various dependencies have releases for, compute the highest version that everything has a release for, and then update the local project + all dependencies to be on that toolchain version. Not sure how possible that is, though</p>



<a name="299110618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299110618" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299110618">(Sep 16 2022 at 08:06)</a>:</h4>
<p>Actually, that isn't even really good enough -- just also had to manually fix my <code>manifest</code> because mathlib relied on a different version of <code>std4</code> than what <code>lake update</code> pulled (because mathlib was behind)</p>
<p>Don't know if I have suggestions for how to improve this. :/</p>



<a name="299110739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299110739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299110739">(Sep 16 2022 at 08:07)</a>:</h4>
<p>I assume it's not okay for a project to depend on multiple versions of the same library, since namespaces would conflict</p>



<a name="299123943"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299123943" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299123943">(Sep 16 2022 at 09:34)</a>:</h4>
<blockquote>
<p>That bug has been fixed now.</p>
</blockquote>
<p>Apparently not entirely: see <a href="https://github.com/leanprover/lake/issues/119">https://github.com/leanprover/lake/issues/119</a>  (And then there was always the issue that it didn't pick up updates if the branch changed, but that's not the case here.)</p>



<a name="299206666"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%20dependency%20fails%20to%20build%3F/near/299206666" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.20dependency.20fails.20to.20build.3F.html#299206666">(Sep 16 2022 at 17:15)</a>:</h4>
<p>Ahh, I missed that ticket, that makes sense</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>