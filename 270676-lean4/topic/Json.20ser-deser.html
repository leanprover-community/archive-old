---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Json.20ser-deser.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html">Json ser-deser</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="290495761"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290495761" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290495761">(Jul 22 2022 at 11:53)</a>:</h4>
<p>I'm currently working the autogenerated <code>FromJson</code>, <code>ToJson</code> instances to dump some info to a JSON file and read it in in another part of doc-gen, the input can be parsed as JSON just fine but the autogenerated <code>ToJson</code> instance gives me some "String expected" error so it apparently doesn't like the format the <code>ToJson</code> generated? At least when viewing the file I can validate that it has the correct format:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">JsonDeclaration</span> <span class="n">where</span>
  <span class="n">name</span> <span class="o">:</span> <span class="n">String</span>
  <span class="n">doc</span> <span class="o">:</span> <span class="n">String</span>
  <span class="n">docLink</span> <span class="o">:</span> <span class="n">String</span>
  <span class="n">sourceLink</span> <span class="o">:</span> <span class="n">String</span>
  <span class="n">deriving</span> <span class="n">FromJson</span><span class="o">,</span> <span class="n">ToJson</span>

<span class="kd">structure</span> <span class="n">JsonInstance</span> <span class="n">where</span>
  <span class="n">name</span> <span class="o">:</span> <span class="n">String</span>
  <span class="n">className</span> <span class="o">:</span> <span class="n">String</span>
  <span class="n">deriving</span> <span class="n">FromJson</span><span class="o">,</span> <span class="n">ToJson</span>

<span class="kd">structure</span> <span class="n">JsonModule</span> <span class="n">where</span>
  <span class="n">name</span> <span class="o">:</span> <span class="n">String</span>
  <span class="n">declarations</span> <span class="o">:</span> <span class="n">List</span> <span class="n">JsonDeclaration</span>
  <span class="n">instances</span> <span class="o">:</span> <span class="n">Array</span> <span class="n">JsonInstance</span>
  <span class="n">imports</span> <span class="o">:</span> <span class="n">Array</span> <span class="n">String</span>
  <span class="n">deriving</span> <span class="n">FromJson</span><span class="o">,</span> <span class="n">ToJson</span>
</code></pre></div>
<p>(The List and Array stuff are there for a reason)<br>
On an value of <code>JsonModule</code> toJson produces a file like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">{</span>
  <span class="s2">"name"</span><span class="o">:</span><span class="s2">"Init.NotationExtra"</span><span class="o">,</span>
  <span class="s2">"instances"</span><span class="o">:[{</span><span class="s2">"name"</span><span class="o">:</span><span class="s2">"Lean.instForInLoopUnit"</span><span class="o">,</span><span class="s2">"className"</span><span class="o">:</span><span class="s2">"ForIn"</span><span class="o">}],</span>
  <span class="s2">"imports"</span><span class="o">:[</span><span class="s2">"Init.Meta"</span><span class="o">,</span><span class="s2">"Init.Data.Array.Subarray"</span><span class="o">,</span><span class="s2">"Init.Data.ToString"</span><span class="o">],</span>
  <span class="s2">"declarations"</span><span class="o">:[</span>
    <span class="o">{</span><span class="s2">"sourceLink"</span><span class="o">:</span><span class="s2">"https://github.com/leanprover/lean4/blob/3846dd60fd5bbb7901b432066234037c35b872a0/src/Init/NotationExtra.lean#L275-L275"</span><span class="o">,</span><span class="s2">"name"</span><span class="o">:</span><span class="s2">"Lean.«term_Matches_|»"</span><span class="o">,</span><span class="s2">"docLink"</span><span class="o">:</span><span class="s2">"./Init/NotationExtra.html#Lean.«term_Matches_|»"</span><span class="o">,</span><span class="s2">"doc"</span><span class="o">:</span><span class="s2">""</span><span class="o">},</span>
  <span class="bp">......</span>
   <span class="o">]</span>
<span class="o">}</span>
</code></pre></div>
<p>and the <code>fromJson?</code> throws its "String expected" error.</p>
<p>How would I go about debugging this?</p>



<a name="290496156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290496156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290496156">(Jul 22 2022 at 11:57)</a>:</h4>
<p>Minimizing further it doesn't even like:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">{</span>
  <span class="s2">"name"</span><span class="o">:</span><span class="s2">"Init.NotationExtra"</span><span class="o">,</span>
  <span class="s2">"instances"</span><span class="o">:[],</span>
  <span class="s2">"imports"</span><span class="o">:[],</span>
  <span class="s2">"declarations"</span><span class="o">:[]</span>
<span class="o">}</span>
</code></pre></div>



<a name="290496496"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290496496" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290496496">(Jul 22 2022 at 12:00)</a>:</h4>
<p>How are you calling the JSON parser?</p>



<a name="290496531"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290496531" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290496531">(Jul 22 2022 at 12:01)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#eval</span> <span class="k">show</span> <span class="n">IO</span> <span class="n">_</span> <span class="k">from</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">foo</span> <span class="bp">←</span> <span class="n">IO.FS.readFile</span> <span class="o">(</span><span class="n">System.FilePath.mk</span> <span class="s2">"."</span><span class="bp">/</span> <span class="s2">"DocGen4"</span> <span class="bp">/</span> <span class="s2">"Output"</span> <span class="bp">/</span> <span class="s2">"mytest.json"</span><span class="o">)</span>
  <span class="n">IO.println</span> <span class="n">foo</span>
  <span class="k">match</span> <span class="o">(</span><span class="n">fromJson</span><span class="bp">?</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">Except</span> <span class="n">_</span> <span class="n">JsonModule</span><span class="o">)</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="bp">.</span><span class="n">ok</span> <span class="n">foo</span> <span class="bp">=&gt;</span> <span class="n">pure</span> <span class="n">foo.name</span>
  <span class="bp">|</span> <span class="bp">.</span><span class="n">error</span> <span class="n">err</span> <span class="bp">=&gt;</span> <span class="n">pure</span> <span class="n">err</span>
</code></pre></div>
<p>is my test case right now</p>



<a name="290496575"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290496575" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290496575">(Jul 22 2022 at 12:01)</a>:</h4>
<p>I fear there might be a certain coercion from <code>String</code> to <code>Json</code> that you're using here.</p>



<a name="290496703"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290496703" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290496703">(Jul 22 2022 at 12:02)</a>:</h4>
<p>On a tangent: presumably at some point I should bring <a href="https://leanprover-community.github.io/mathlib_docs/find/json_serializable">docs#json_serializable</a> in line with <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ToJson#doc">docs4#ToJson</a> and <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=FromJson#doc">docs4#FromJson</a>?</p>



<a name="290496742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290496742" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290496742">(Jul 22 2022 at 12:03)</a>:</h4>
<p>Or maybe the other way around?  I never liked the separation of <code>FromJson</code> and <code>ToJson</code>.</p>



<a name="290496907"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290496907" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290496907">(Jul 22 2022 at 12:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/Json.20ser-deser/near/290496575">said</a>:</p>
<blockquote>
<p>I fear there might be a certain coercion from <code>String</code> to <code>Json</code> that you're using here.</p>
</blockquote>
<p>Can you elaborate?</p>



<a name="290496921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290496921" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290496921">(Jul 22 2022 at 12:05)</a>:</h4>
<p><a href="https://leanprover-community.github.io/mathlib_docs/find/polyrith.poly.non_null_json_serializable">docs#polyrith.poly.non_null_json_serializable</a> has a dummy function for serialization, so I think the split might make sense</p>



<a name="290497004"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290497004" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290497004">(Jul 22 2022 at 12:06)</a>:</h4>
<p>Either that, or we should have <code>toJson : α → except String Lean.Json</code> to permit sometimes-serializable objects</p>



<a name="290497013"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290497013" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290497013">(Jul 22 2022 at 12:06)</a>:</h4>
<blockquote>
<p>Can you elaborate?</p>
</blockquote>
<p><code>fromJson?</code> takes a <code>Json</code> argument.  In your example, <code>foo</code> is a string.  So <code>fromJson? foo</code> means <code>fromJson? (.str foo)</code>.</p>



<a name="290497039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290497039" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290497039">(Jul 22 2022 at 12:06)</a>:</h4>
<p>ohhhhhh</p>



<a name="290497056"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290497056" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290497056">(Jul 22 2022 at 12:07)</a>:</h4>
<p>so fromJson? (Json.parse foo) instead</p>



<a name="290497281"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290497281" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290497281">(Jul 22 2022 at 12:09)</a>:</h4>
<blockquote>
<p><a href="https://leanprover-community.github.io/mathlib_docs/find/polyrith.poly.non_null_json_serializable">docs#polyrith.poly.non_null_json_serializable</a> has a dummy function for serialization, so I think the split might make sense</p>
</blockquote>
<p>Ideally sage would just return JSON in the schema expected by <code>deriving JsonSerializable for Poly</code>.</p>



<a name="290497442"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290497442" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290497442">(Jul 22 2022 at 12:11)</a>:</h4>
<p>Alright working now, thanks <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="290501947"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Json%20ser-deser/near/290501947" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Json.20ser-deser.html#290501947">(Jul 22 2022 at 12:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/Json.20ser-deser/near/290497281">said</a>:</p>
<blockquote>
<blockquote>
<p><a href="https://leanprover-community.github.io/mathlib_docs/find/polyrith.poly.non_null_json_serializable">docs#polyrith.poly.non_null_json_serializable</a> has a dummy function for serialization, so I think the split might make sense</p>
</blockquote>
<p>Ideally sage would just return JSON in the schema expected by <code>deriving JsonSerializable for Poly</code>.</p>
</blockquote>
<p>In this case we send send the <code>poly</code>s to sage in a completely different format to the format we receive them; which is obviously messy.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>