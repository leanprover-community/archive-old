---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html">Acces environment from command macro</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="292137283"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292137283" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292137283">(Aug 05 2022 at 10:54)</a>:</h4>
<p>If I want to write a user command using <code>macro</code>, is it possible to access the current environment (at macro execution time, not macro writing time)?</p>



<a name="292137613"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292137613" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292137613">(Aug 05 2022 at 10:58)</a>:</h4>
<p>No, that's the point where you should switch to <code>elab</code></p>



<a name="292138000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292138000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292138000">(Aug 05 2022 at 11:02)</a>:</h4>
<p>Is there a nice example of doing that?</p>



<a name="292138730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292138730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292138730">(Aug 05 2022 at 11:10)</a>:</h4>
<p><code>#find</code> perhaps? <a href="https://github.com/leanprover-community/mathlib4/blob/876d9cc42ccbfea023752e40e6edb7279d9c6b5a/Mathlib/Tactic/Find.lean#L67">https://github.com/leanprover-community/mathlib4/blob/876d9cc42ccbfea023752e40e6edb7279d9c6b5a/Mathlib/Tactic/Find.lean#L67</a><br>
There's a <em>lot</em> of other stuff about matching types happening there of course</p>



<a name="292138805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292138805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292138805">(Aug 05 2022 at 11:11)</a>:</h4>
<p>Depending on what information you need, you probably don't need the <code>liftTermElabM</code></p>



<a name="292138969"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292138969" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292138969">(Aug 05 2022 at 11:12)</a>:</h4>
<p>Thanks!</p>



<a name="292143808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292143808" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292143808">(Aug 05 2022 at 12:02)</a>:</h4>
<p>I'm still stuck because I don't know how to mix macro style and elab style. Say I want my custom namespace command where part of the created name comes from the environment. I can do the easy case where that part is actually hard-coded.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>

<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Meta</span>

<span class="n">macro</span> <span class="s2">"foo"</span> <span class="n">n</span><span class="o">:</span><span class="n">num</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span>
  <span class="bp">`</span><span class="o">(</span><span class="kn">namespace</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">$</span> <span class="n">Name.str</span> <span class="bp">`</span><span class="n">hard_coded</span> <span class="o">(</span><span class="s2">"bar"</span> <span class="bp">++</span> <span class="n">toString</span> <span class="n">n.getNat</span><span class="o">)))</span>

<span class="n">foo</span> <span class="mi">1</span>
<span class="kd">def</span> <span class="n">x</span> <span class="o">:=</span> <span class="mi">3</span>

<span class="kd">end</span> <span class="n">hard_coded.bar1</span>
</code></pre></div>
<p>Now I would like to replace <code>hard_coded in the above macro by the value of </code>head` taken from the environment at command running time. The naive version is</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">macro</span> <span class="s2">"foo"</span> <span class="n">n</span><span class="o">:</span><span class="n">num</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span>
  <span class="bp">`</span><span class="o">(</span><span class="kn">namespace</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">$</span> <span class="n">Name.str</span> <span class="bp">$</span><span class="n">head</span> <span class="o">(</span><span class="s2">"bar"</span> <span class="bp">++</span> <span class="n">toString</span> <span class="n">n.getNat</span><span class="o">)))</span>
</code></pre></div>
<p>which doesn't work at all. Then I tried something like</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">open</span> <span class="n">Lean</span> <span class="n">Elab</span> <span class="k">in</span>
<span class="n">elab</span> <span class="s2">"foo'"</span> <span class="n">n</span><span class="o">:</span><span class="n">num</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">env</span> <span class="o">:</span> <span class="n">Environment</span> <span class="bp">←</span> <span class="n">liftMacroM</span> <span class="bp">$</span> <span class="n">pure</span> <span class="o">(</span><span class="bp">←</span> <span class="n">getEnv</span><span class="o">)</span>
  <span class="k">match</span> <span class="n">env.find</span><span class="bp">?</span> <span class="bp">`</span><span class="n">head</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">some</span> <span class="n">decl</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span><span class="kn">namespace</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">$</span> <span class="n">Name.str</span> <span class="bp">$</span><span class="o">(</span><span class="n">decl.name</span><span class="o">)</span> <span class="o">(</span><span class="s2">"bar"</span> <span class="bp">++</span> <span class="n">toString</span> <span class="n">n.getNat</span><span class="o">)))</span>
  <span class="bp">|</span> <span class="n">none</span> <span class="bp">=&gt;</span> <span class="n">throwError</span> <span class="s2">"Failed"</span>
</code></pre></div>
<p>which doesn't make any sense.</p>



<a name="292144350"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292144350" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292144350">(Aug 05 2022 at 12:07)</a>:</h4>
<p><span class="user-mention" data-user-id="110031">@Patrick Massot</span> What is "head" in this example? Is it a global definition? What does the user side code look like?</p>



<a name="292144461"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292144461" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292144461">(Aug 05 2022 at 12:08)</a>:</h4>
<p>it sounds like you might want to resolve <code>head</code> at elab time, in which case you would call <code>resolveName</code> or one of its friends</p>



<a name="292145262"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292145262" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292145262">(Aug 05 2022 at 12:16)</a>:</h4>
<p>The user code would be</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">head</span> <span class="o">:=</span> <span class="s2">"no_hard_coded"</span>
<span class="n">foo'</span> <span class="mi">2</span>
<span class="kd">end</span> <span class="n">not_hard_coded.bar2</span>
</code></pre></div>



<a name="292145620"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292145620" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292145620">(Aug 05 2022 at 12:19)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>
<span class="kn">import</span> <span class="n">Mathlib.Util.TermUnsafe</span>

<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Meta</span> <span class="n">Elab</span> <span class="n">Command</span>

<span class="n">elab</span> <span class="s2">"foo"</span> <span class="n">n</span><span class="o">:</span><span class="n">num</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="o">[(</span><span class="n">head</span><span class="o">,</span> <span class="n">_</span><span class="o">)]</span> <span class="bp">←</span> <span class="n">resolveGlobalName</span> <span class="bp">`</span><span class="n">head</span> <span class="bp">|</span> <span class="n">throwError</span> <span class="s2">"head not found or overloaded"</span>
  <span class="k">let</span> <span class="n">head</span> <span class="bp">←</span> <span class="n">unsafe</span> <span class="n">evalConstCheck</span> <span class="n">Name</span> <span class="bp">``</span><span class="n">Name</span> <span class="n">head</span>
  <span class="n">elabCommand</span> <span class="o">(</span><span class="bp">←</span> <span class="bp">`</span><span class="o">(</span><span class="kn">namespace</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">$</span> <span class="n">Name.str</span> <span class="n">head</span> <span class="o">(</span><span class="s2">"bar"</span> <span class="bp">++</span> <span class="n">toString</span> <span class="n">n.getNat</span><span class="o">))))</span>

<span class="kd">def</span> <span class="n">head</span> <span class="o">:</span> <span class="n">Name</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">not_hard_coded</span>

<span class="n">foo</span> <span class="mi">1</span>
<span class="kd">def</span> <span class="n">x</span> <span class="o">:=</span> <span class="mi">3</span>
<span class="kd">end</span> <span class="n">not_hard_coded.bar1</span>
</code></pre></div>



<a name="292145713"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292145713" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292145713">(Aug 05 2022 at 12:20)</a>:</h4>
<p><code>resolveGlobalName</code> is not the most convenient function to call, there should be a better one somewhere</p>



<a name="292145823"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292145823" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292145823">(Aug 05 2022 at 12:21)</a>:</h4>
<p>Thanks! What needs mathlib here?</p>



<a name="292145864"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292145864" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292145864">(Aug 05 2022 at 12:21)</a>:</h4>
<p>The <code>unsafe</code> term macro</p>



<a name="292145873"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292145873" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292145873">(Aug 05 2022 at 12:21)</a>:</h4>
<p>I just fixed it</p>



<a name="292145927"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292145927" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292145927">(Aug 05 2022 at 12:22)</a>:</h4>
<p>I want to PR that to core, it comes up all the time</p>



<a name="292146213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292146213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292146213">(Aug 05 2022 at 12:24)</a>:</h4>
<p>I was also missing <code>elabCommand</code>. I searched for it but couldn't find it.</p>



<a name="292146466"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292146466" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292146466">(Aug 05 2022 at 12:26)</a>:</h4>
<p>as you can see, using <code>elabCommand</code> makes it easy to turn a macro into an elab</p>



<a name="292146501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292146501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292146501">(Aug 05 2022 at 12:27)</a>:</h4>
<p>same thing for <code>elabTactic</code> or <code>elabTerm</code></p>



<a name="292187583"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292187583" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292187583">(Aug 05 2022 at 17:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> You should probably be using <code>withMacroExpansion</code> in your example to make sure the macro stack is setup properly:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"foo"</span> <span class="n">n</span><span class="o">:</span><span class="n">num</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="o">[(</span><span class="n">head</span><span class="o">,</span> <span class="n">_</span><span class="o">)]</span> <span class="bp">←</span> <span class="n">resolveGlobalName</span> <span class="bp">`</span><span class="n">head</span> <span class="bp">|</span> <span class="n">throwError</span> <span class="s2">"head not found or overloaded"</span>
  <span class="k">let</span> <span class="n">head</span> <span class="bp">←</span> <span class="n">unsafe</span> <span class="n">evalConstCheck</span> <span class="n">Name</span> <span class="bp">``</span><span class="n">Name</span> <span class="n">head</span>
  <span class="k">let</span> <span class="n">cmd</span> <span class="bp">←</span> <span class="bp">`</span><span class="o">(</span><span class="kn">namespace</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">$</span> <span class="n">Name.str</span> <span class="n">head</span> <span class="o">(</span><span class="s2">"bar"</span> <span class="bp">++</span> <span class="n">toString</span> <span class="n">n.getNat</span><span class="o">)))</span>
  <span class="n">withMacroExpansion</span> <span class="o">(</span><span class="bp">←</span> <span class="n">getRef</span><span class="o">)</span> <span class="n">cmd</span> <span class="bp">&lt;|</span> <span class="n">elabCommand</span> <span class="n">cmd</span>
</code></pre></div>



<a name="292187871"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292187871" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292187871">(Aug 05 2022 at 17:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292145927">said</a>:</p>
<blockquote>
<p>I want to PR that to core, it comes up all the time</p>
</blockquote>
<p>I think the major problem is that <code>evalConst</code> does not do the usual <code>unsafe</code>/<code>implementedBy</code> split done by most other unsafe code. It unsafety being hidden behind an opaque is always the behavior I want in any of my use cases.</p>



<a name="292192486"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292192486" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292192486">(Aug 05 2022 at 18:38)</a>:</h4>
<p>I'm not sure what you mean. <code>evalConst</code> should definitely be an <code>unsafe</code> function, it directly causes unsafety if you call it wrong</p>



<a name="292192659"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292192659" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292192659">(Aug 05 2022 at 18:40)</a>:</h4>
<p>A safe interface for <code>evalConst</code> would be great; I think it could be an <code>elab</code> that checks the expected type and synthesizes the expr version to ensure no discrepancy</p>



<a name="292192876"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292192876" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292192876">(Aug 05 2022 at 18:42)</a>:</h4>
<p>In any case, the thing that I want to PR is term-mode <code>unsafe</code> - evalConst is not specifically the motivator here, but rather the <code>unsafe</code>/<code>implementedBy</code> trick that comes up many dozens of times in the lean 4 codebase</p>



<a name="292194300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292194300" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292194300">(Aug 05 2022 at 18:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292192486">said</a>:</p>
<blockquote>
<p>I'm not sure what you mean. <code>evalConst</code> should definitely be an <code>unsafe</code> function, it directly causes unsafety if you call it wrong</p>
</blockquote>
<p>Yes, but it should be an the unsafe version should be <code>unsafeEvalConst</code> with the user <code>evalConst</code> being an standard  <code>implementedBy</code> wrapper. At least, that is always what I want when I use it.</p>



<a name="292194559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292194559" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292194559">(Aug 05 2022 at 18:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292192876">said</a>:</p>
<blockquote>
<p>In any case, the thing that I want to PR is term-mode <code>unsafe</code> - evalConst is not specifically the motivator here, but rather the <code>unsafe</code>/<code>implementedBy</code> trick that comes up many dozens of times in the lean 4 codebase</p>
</blockquote>
<p>I know, and I agree. However, I think <code>evalConst</code> is unique in that it is one of the few places the unsafety bleeds into user code in burdensome manner. Most other usages in the Lean core utilize the <code>unsafe</code>/<code>implementedBy</code> trick to make this more convenient for the end-user (and not require them write dozens of such tricks themselves).</p>



<a name="292194602"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292194602" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292194602">(Aug 05 2022 at 18:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292194300">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292192486">said</a>:</p>
<blockquote>
<p>I'm not sure what you mean. <code>evalConst</code> should definitely be an <code>unsafe</code> function, it directly causes unsafety if you call it wrong</p>
</blockquote>
<p>Yes, but it should be an the unsafe version should be <code>unsafeEvalConst</code> with the user <code>evalConst</code> being an standard  <code>implementedBy</code> wrapper. At least, that is always what I want when I use it.</p>
</blockquote>
<p>What I'm saying is that there can't be a safe version of <code>evalConst</code>, that would just be unsound</p>



<a name="292194726"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292194726" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292194726">(Aug 05 2022 at 18:56)</a>:</h4>
<p>at least, not with the signature it has</p>



<a name="292194796"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292194796" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292194796">(Aug 05 2022 at 18:57)</a>:</h4>
<p>the safe version, as I said, would have to be part-macro in order to ensure that the expected type actually matches the provided <code>Expr</code></p>



<a name="292194923"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292194923" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292194923">(Aug 05 2022 at 18:58)</a>:</h4>
<p>even <code>evalConstCheck</code> is only "slightly less unsafe", because it fundamentally can't check this as a regular function</p>



<a name="292196284"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292196284" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292196284">(Aug 05 2022 at 19:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292194602">said</a>:</p>
<blockquote>
<p>that would just be unsound</p>
</blockquote>
<p>It would not be unsound, the <code>implementedBy</code> prohibits that already, it would be memory unsafe, though. But that's fine, one naturally is assuming the value is of the expected type to do the evaluation in most use cases.</p>



<a name="292196519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292196519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292196519">(Aug 05 2022 at 19:11)</a>:</h4>
<p>As your example demonstrate, we generally discard this potentially unsafety in use cases.</p>



<a name="292196847"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292196847" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292196847">(Aug 05 2022 at 19:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292196284">said</a>:</p>
<blockquote>
<p>It would not be unsound, the <code>implementedBy</code> prohibits that already, it would be memory unsafe, though.</p>
</blockquote>
<p>Yes, that's what I mean by unsound. <code>unsafe</code> isn't just line noise, it has meaning and you shouldn't just be wrapping it with a safe wrapper unless you are preventing the memory safety issue from leaking</p>



<a name="292196971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292196971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292196971">(Aug 05 2022 at 19:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292196519">said</a>:</p>
<blockquote>
<p>As your example demonstrate, we generally discard this potentially unsafety in use cases.</p>
</blockquote>
<p>In use cases, we can confirm that the unsafety is encapsulated. In my example we can see that it is safe because I used <code>Name</code> and <code> ``Name</code> as parameters</p>



<a name="292197058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292197058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292197058">(Aug 05 2022 at 19:17)</a>:</h4>
<p>so the <code>unsafe</code> is exactly where it should be in this example</p>



<a name="292198151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292198151" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292198151">(Aug 05 2022 at 19:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292196971">said</a>:</p>
<blockquote>
<p>In use cases, we can confirm that the unsafety is encapsulated. In my example we can see that it is safe because I used <code>Name</code> and <code> ``Name</code> as parameters</p>
</blockquote>
<p>Note that this is not true, (as mentioned in the documentation for <code>evalConst</code>):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">This</span> <span class="n">function</span> <span class="n">is</span> <span class="n">only</span> <span class="n">safe</span> <span class="n">to</span> <span class="n">use</span> <span class="k">if</span> <span class="n">the</span> <span class="n">type</span> <span class="n">matches</span> <span class="n">the</span> <span class="n">declaration's</span> <span class="n">type</span> <span class="k">in</span> <span class="n">the</span> <span class="n">environment</span>
<span class="n">and</span> <span class="k">if</span> <span class="bp">`</span><span class="n">enableInitializersExecution</span><span class="bp">`</span> <span class="n">has</span> <span class="n">been</span> <span class="n">used</span> <span class="n">before</span> <span class="n">importing</span> <span class="n">any</span> <span class="n">modules</span>
</code></pre></div>
<p>The key here is "if the type matches the declaration's type <strong>in the [provided] environment</strong>" . In your example, there is no fool-proof guarantee that the type <code>Name</code> in the environment (which is arbitrary environment accepted at the run time of the command) matches that of the type <code>Name</code> mentioned at the use site (which is fixed to the Name of compile time elaboration environment). For example, if this elab command was used as a pluign in a <code>prelude</code> module with a different definition for <code>Lean.Name</code>, it could cause memory unsafety. Or, if the olean was used with a different Lean version where the name definition changed (as it recently did), it could also cause memory unsafety.</p>
<p>In summary, the safety guarantee for <code>evalConst</code> is essentially unmeetable. Every practical use of its still introduces the possibility of memory unsafety.</p>



<a name="292200267"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292200267" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292200267">(Aug 05 2022 at 19:48)</a>:</h4>
<blockquote>
<p>In your example, there is no fool-proof guarantee that the type Name in the environment (which is arbitrary environment accepted at the run time of the command) matches that of the type Name mentioned at the use site (which is fixed to the Name of compile time elaboration environment).</p>
</blockquote>
<p>The environment has to be an extension of the current compile time environment in order to call this function.</p>



<a name="292200481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292200481" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292200481">(Aug 05 2022 at 19:51)</a>:</h4>
<p>If the oleans don't match, then you are already in UB territory. Lean provides no guarantees in this case</p>



<a name="292200574"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292200574" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292200574">(Aug 05 2022 at 19:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292200267">said</a>:</p>
<blockquote>
<p>The environment has to be an extension of the current compile time environment in order to call this function.</p>
</blockquote>
<p>No it does not (at least with the use of plugins). Just like one can use (and does use) builtin Lean elaborates without importing all of Lean. Furthermore, even an extension of the environment could modify the meaning of <code>Name</code> (that would be extremely hacky and probably break other things, but it is still possible).</p>



<a name="292200607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292200607" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292200607">(Aug 05 2022 at 19:52)</a>:</h4>
<blockquote>
<p>Furthermore, even an extension of the environment could modify the meaning of Name (that would be extremely hacky and probably break other things, but it is still possible).</p>
</blockquote>
<p>You can't remove or change definitions in the environment, that is something the kernel itself prevents</p>



<a name="292200789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292200789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292200789">(Aug 05 2022 at 19:55)</a>:</h4>
<p>As for plugins, I would call that an <code>unsafe</code> feature. You have to abide by certain rules when using plugins to avoid memory unsafety</p>



<a name="292200816"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292200816" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292200816">(Aug 05 2022 at 19:55)</a>:</h4>
<p>you can get all sorts of link errors that way</p>



<a name="292200846"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292200846" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292200846">(Aug 05 2022 at 19:55)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> The environment's constants are just stored in an <code>SMap</code>, they are perfectly modifiable (though I don't doubt that would cause major problems elsewhere).</p>



<a name="292201331"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201331" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201331">(Aug 05 2022 at 20:00)</a>:</h4>
<p>Actually, based on <a href="https://github.com/leanprover/lean4/blob/deafc315c783ac8069508f72b2815f2713d06f6a/src/Lean/Data/SMap.lean#L25-L27">this comment</a> in <code>SMap</code>, supporting deletions would not be that hard. So maybe it wouldn't break tons of things elsewhere.</p>



<a name="292201370"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201370" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201370">(Aug 05 2022 at 20:01)</a>:</h4>
<p>the comment says that it would require changing the definition of the map to have <code>Option</code> keys</p>



<a name="292201403"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201403" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201403">(Aug 05 2022 at 20:01)</a>:</h4>
<p>in other words, they aren't really being deleted, only hidden from the frontend</p>



<a name="292201428"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201428" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201428">(Aug 05 2022 at 20:01)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> yes, to properly efficiently support them in the core. You could still overwrite the whole map to do so if you wanted.</p>



<a name="292201519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201519">(Aug 05 2022 at 20:02)</a>:</h4>
<p>I still wouldn't put the blame for this on <code>evalConst</code>, those are some unsafe operations you are doing</p>



<a name="292201538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201538" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201538">(Aug 05 2022 at 20:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292201403">said</a>:</p>
<blockquote>
<p>in other words, they aren't really being deleted, only hidden from the frontend</p>
</blockquote>
<p>That second map is for local declarations, it is then compacted into the first map on a import. So, after an import, I think it would be deleted?</p>



<a name="292201690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201690">(Aug 05 2022 at 20:04)</a>:</h4>
<p>it's not implemented so it's difficult to speculate on what exactly it would do</p>



<a name="292201792"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201792" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201792">(Aug 05 2022 at 20:05)</a>:</h4>
<p>like, you can also just add things to the environment without calling the kernel too</p>



<a name="292201870"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201870" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201870">(Aug 05 2022 at 20:06)</a>:</h4>
<p>or you could override the toplevel to play tetris instead</p>



<a name="292201911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201911" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201911">(Aug 05 2022 at 20:06)</a>:</h4>
<p>at some point you aren't really using lean anymore</p>



<a name="292201953"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201953" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201953">(Aug 05 2022 at 20:07)</a>:</h4>
<p>and if you get into trouble it's on you</p>



<a name="292201964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292201964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292201964">(Aug 05 2022 at 20:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292201519">said</a>:</p>
<blockquote>
<p>I still wouldn't put the blame for this on <code>evalConst</code>, those are some unsafe operations you are doing</p>
</blockquote>
<p>Since you didn't like my reasonable (imo) example of plugins and my hacky example of an environment modifications, here is another one: running the elaborator on a external environment. For instance, if we are in the process of elaborating an external file (ala <code>runFrontend</code>) and wish to execute this elaborator (or a set of elaborators in general including this one) on some synthetic syntax related to the file (and thus in its environment) the eval would also break.</p>



<a name="292202120"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202120" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202120">(Aug 05 2022 at 20:09)</a>:</h4>
<p>This command and many others like it do not support that use case</p>



<a name="292202131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202131">(Aug 05 2022 at 20:09)</a>:</h4>
<p>if you try to use it anyway that's on you</p>



<a name="292202190"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202190" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202190">(Aug 05 2022 at 20:10)</a>:</h4>
<p><code>unsafe</code> is a way of saying "don't come to me if your hacks don't work"</p>



<a name="292202192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202192">(Aug 05 2022 at 20:10)</a>:</h4>
<p>UB in certain use cases is generally what "unsafe" means.</p>



<a name="292202194"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202194" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202194">(Aug 05 2022 at 20:10)</a>:</h4>
<p><code>importModules</code> is <code>unsafe</code> for this reason</p>



<a name="292202234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202234">(Aug 05 2022 at 20:11)</a>:</h4>
<p><code>importModules</code> is not <code>unsafe</code>?</p>



<a name="292202248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202248">(Aug 05 2022 at 20:11)</a>:</h4>
<p><code>withImportModules</code></p>



<a name="292202273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202273">(Aug 05 2022 at 20:11)</a>:</h4>
<p>which is not generally used directly when augmenting the frontend?</p>



<a name="292202473"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202473" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202473">(Aug 05 2022 at 20:13)</a>:</h4>
<p>lean isn't very bulletproof esp. if you try writing your own prelude</p>



<a name="292202524"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202524" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202524">(Aug 05 2022 at 20:14)</a>:</h4>
<p>time being finite and all that</p>



<a name="292202614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202614" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202614">(Aug 05 2022 at 20:15)</a>:</h4>
<p>but the notion of what is <code>unsafe</code> or not for the purpose of "blame assignment" is fairly well trodden in e.g. rust, and lean is trying to follow the same patterns</p>



<a name="292202724"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292202724" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292202724">(Aug 05 2022 at 20:16)</a>:</h4>
<p>Regardless, my general point, is that by bypassing the unsafe in your example, what the user is stating that they don't care about the edge cases where the behavior may still be unsafe, not that they have reasonably verified that any such case is now impossible. Which is fine, but is an important distinction in guarentees.</p>



<a name="292203347"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292203347" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292203347">(Aug 05 2022 at 20:23)</a>:</h4>
<p>In that vein, I am not sure what the <code>unsafe</code> adds in that code, it is essentially silently introducing an equivalent to the common <code>unsafe</code>/<code>implementedBy</code> trick for every use case of the <code>evalConst*</code> without preforming additional verification to ensure it is less unsafe. I don't understand how that would be more useful than just do that trick at the definition of <code>evalConst</code> (or <code>evalConstCheck</code>) since that is generally always the way it will be used.</p>
<p>That isn't to say I think the term level <code>unsafe</code> is useless in general (it is a great idea that removes a lot of burdensome boilerplate). I just think the <code>evalConst</code> is one place where the unsafe should be hidden away and mentioned in the docstring, as it will be just be hidden away at all its use sites otherwise.</p>



<a name="292203600"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292203600" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292203600">(Aug 05 2022 at 20:26)</a>:</h4>
<p>Though, I guess that last comment is more relevant now without the term-level unsafe in the Lean core, than once it is there. Because currently hiding it away takes a lot of boilerplate. With the <code>unsafe</code> macro, it just takes one keyword (which admittedly does nicely documented to the read of the code that the function being used is introducing unsafety).</p>



<a name="292205670"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292205670" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292205670">(Aug 05 2022 at 20:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292203347">said</a>:</p>
<blockquote>
<p>In that vein, I am not sure what the <code>unsafe</code> adds in that code, it is essentially silently introducing an equivalent to the common <code>unsafe</code>/<code>implementedBy</code> trick for every use case of the <code>evalConst*</code> without preforming additional verification to ensure it is less unsafe.</p>
</blockquote>
<p>This is rust-style verification: you read the code carefully and convince yourself that it is correct. The <code>unsafe</code> alerts you to the possibility that something that requires additional scrutiny is going on. Lean-style verification would have proof side conditions and for most memory safety issues in lean that's not an option because the side conditions cannot be expressed in the lean logic.</p>
<blockquote>
<p>I don't understand how that would be more useful than just do that trick at the definition of <code>evalConst</code> (or <code>evalConstCheck</code>) since that is generally always the way it will be used.</p>
</blockquote>
<p>Of course, if the trick could be done in the definition of <code>evalConst</code> it should be placed there, but the point is that it can't be because the type is generic in <code>evalConst</code> and it is not generic in the user code.</p>



<a name="292206142"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292206142" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292206142">(Aug 05 2022 at 20:51)</a>:</h4>
<p>Like I said, I think it <em>can</em> be done in general but you would need to use a macro to automate the matching of type to expr, or possibly a typeclass like the <code>reflect</code> typeclass that did it in lean 3</p>



<a name="292208582"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292208582" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292208582">(Aug 05 2022 at 21:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292206142">said</a>:</p>
<blockquote>
<p>Like I said, I think it <em>can</em> be done in general</p>
</blockquote>
<p>Assuming that you are okay disregarding cases like plugins, elaborators, and environment changes that I mentioned above. One reason I point this out is that this is the case for Lake which uses <code>evalConst</code> extensively in such a scenario (on a separately elaborated environment -- that of the configuration file).</p>



<a name="292208645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292208645" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292208645">(Aug 05 2022 at 21:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292206142">said</a>:</p>
<blockquote>
<p>or possibly a typeclass like the <code>reflect</code> typeclass that did it in lean 3</p>
</blockquote>
<p>You could use the <code>toTypeExpr</code> of the <code>ToExpr</code> class for this (I have done this is some places).</p>



<a name="292208756"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292208756" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292208756">(Aug 05 2022 at 21:18)</a>:</h4>
<p>Though, for cases like this, it might be best to separate <code>toTypeExpr</code> from <code>ToExpr</code>, since there are many cases where a type of a value is reflectable even if the value is not.</p>



<a name="292209307"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292209307" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292209307">(Aug 05 2022 at 21:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292205670">said</a>:</p>
<blockquote>
<p>Of course, if the trick could be done in the definition of <code>evalConst</code> it should be placed there, but the point is that it can't be because the type is generic in <code>evalConst</code> and it is not generic in the user code.</p>
</blockquote>
<p>Huh, yes it can? The following definitions compile just fine:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[implementedBy Lean.Environment.evalConst]</span> <span class="n">opaque</span> <span class="n">evalConst'</span>
<span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">env</span> <span class="o">:</span> <span class="bp">@&amp;</span> <span class="n">Environment</span><span class="o">)</span> <span class="o">(</span><span class="n">opts</span> <span class="o">:</span> <span class="bp">@&amp;</span> <span class="n">Options</span><span class="o">)</span> <span class="o">(</span><span class="n">type</span> <span class="o">:</span> <span class="bp">@&amp;</span> <span class="n">Name</span><span class="o">)</span> <span class="o">:</span> <span class="n">Except</span> <span class="n">String</span> <span class="n">α</span>

<span class="kd">@[implementedBy Lean.Environment.evalConstCheck]</span> <span class="n">opaque</span> <span class="n">evalConstCheck'</span>
<span class="o">(</span><span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">env</span> <span class="o">:</span> <span class="n">Environment</span><span class="o">)</span> <span class="o">(</span><span class="n">opts</span> <span class="o">:</span> <span class="n">Options</span><span class="o">)</span> <span class="o">(</span><span class="n">type</span> <span class="o">:</span> <span class="n">Name</span><span class="o">)</span> <span class="o">(</span><span class="n">const</span> <span class="o">:</span> <span class="n">Name</span><span class="o">)</span> <span class="o">:</span> <span class="n">ExceptT</span> <span class="n">String</span> <span class="n">Id</span> <span class="n">α</span>
</code></pre></div>



<a name="292221802"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292221802" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292221802">(Aug 06 2022 at 00:26)</a>:</h4>
<p>That's not made it any safer though, so taking the <code>unsafe</code> off is not correct</p>



<a name="292221814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292221814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292221814">(Aug 06 2022 at 00:27)</a>:</h4>
<p>if you can make it safer then you can take the <code>unsafe</code> off</p>



<a name="292240556"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292240556" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292240556">(Aug 06 2022 at 07:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292208645">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292206142">said</a>:</p>
<blockquote>
<p>or possibly a typeclass like the <code>reflect</code> typeclass that did it in lean 3</p>
</blockquote>
<p>You could use the <code>toTypeExpr</code> of the <code>ToExpr</code> class for this (I have done this is some places).</p>
</blockquote>
<p>This is just as unsafe as calling evalConst directly, since you can safely construct any (unlawful) ToExpr instance.</p>



<a name="292241287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292241287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292241287">(Aug 06 2022 at 08:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro/near/292208582">said</a>:</p>
<blockquote>
<p>One reason I point this out is that this is the case for Lake which uses <code>evalConst</code> extensively in such a scenario (on a separately elaborated environment -- that of the configuration file).</p>
</blockquote>
<p>This is a interesting case though since you're probably not concerned about alternative implementations of those imports in Lake. So you could check whether the imports are resolved to the olean files you expect them to.</p>



<a name="292241410"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Acces%20environment%20from%20command%20macro/near/292241410" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Acces.20environment.20from.20command.20macro.html#292241410">(Aug 06 2022 at 08:12)</a>:</h4>
<p>For the general case I don't see a better safe solution than comparing deep hashes of the type's structure. It's the same problem as how to detect .olean structure incompatibilities.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>