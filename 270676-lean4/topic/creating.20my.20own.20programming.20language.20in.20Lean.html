---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html">creating my own programming language in Lean</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="277222369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277222369" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277222369">(Mar 31 2022 at 01:18)</a>:</h4>
<p>I've been spending the past few days working on a simple and rudimentary programming language. I'm using Lean 4 to build an interpreter.</p>
<p>The thing is: I am struggling with the parser. I tried looking at <code>Parsec</code> but I couldn't understand how to use it in a way that wouldn't be too laborious. <a href="https://github.com/arthurpaulino/FunnyLang/blob/master/FunnyLang/FunnyParser.lean">This</a> is how the parser is implemented at the moment. And I'm afraid things are going very sideways at this point.</p>
<p>This is an example of what I'm trying to parse:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">a</span> <span class="o">:=</span> <span class="mi">4</span>         <span class="c1"># int</span>
<span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">:=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="c1"># function _ → _ → _</span>
<span class="n">fa</span> <span class="o">:=</span> <span class="n">f</span> <span class="n">a</span>      <span class="c1"># function int → int</span>
<span class="n">fa3</span> <span class="o">:=</span> <span class="n">fa</span> <span class="mi">3</span>    <span class="c1"># 7 : int</span>
<span class="n">g</span> <span class="n">n</span> <span class="o">:=</span>
  <span class="n">s</span> <span class="o">:=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">s</span> <span class="o">:=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">n</span>
    <span class="n">n</span> <span class="o">:=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="n">s</span>
<span class="nb">print</span> <span class="n">g</span> <span class="mi">5</span>      <span class="c1"># 15</span>
</code></pre></div>
<p>Ideas and feedback are very much welcome <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="277226408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277226408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277226408">(Mar 31 2022 at 02:41)</a>:</h4>
<p>Have you considered using Lean's own extensible <code>Syntax</code>? For example as in <a href="https://github.com/leanprover/lean4/blob/2bd04285f86b22fc44ce69a1846f81a569fc438b/doc/tutorial/metaprogramming-arith.md">here</a> and the webserver <a href="https://github.com/leanprover/lean4/blob/2bd04285f86b22fc44ce69a1846f81a569fc438b/tests/playground/webserver/Webserver.lean#L93">demo</a>. Also the <code>do</code> notation <a href="https://github.com/leanprover/lean4/blob/2bd04285f86b22fc44ce69a1846f81a569fc438b/src/Lean/Parser/Do.lean#L21">definitions</a> have an imperative flavour similar to your language.</p>



<a name="277226539"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277226539" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277226539">(Mar 31 2022 at 02:43)</a>:</h4>
<p>Will take a look tomorrow for sure. I always thought of <code>Syntax</code> as something exclusive for Lean's own compiler</p>



<a name="277226780"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277226780" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277226780">(Mar 31 2022 at 02:47)</a>:</h4>
<p>My main difficulty is extracting data from a formatted text (a term of type <code>String</code>) without regex</p>



<a name="277243850"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277243850" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277243850">(Mar 31 2022 at 07:42)</a>:</h4>
<p>It's not all pretty, but it's possible to use Lean's parser outside of Lean, yes. Lean 4 Leanpkg used to do this to parse TOML files: <a href="https://github.com/leanprover/lean4/blob/2b7427c962ddab1fc28c9b1f933947b5f7cd60cb/src/Leanpkg/Toml.lean">https://github.com/leanprover/lean4/blob/2b7427c962ddab1fc28c9b1f933947b5f7cd60cb/src/Leanpkg/Toml.lean</a></p>



<a name="277244033"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277244033" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277244033">(Mar 31 2022 at 07:45)</a>:</h4>
<p>This should get nicer in the future when we have <code>builtin syntax</code> for syntax compiled into the binary (currently covered by <code>leading_parser</code> etc.) and per-category token sets.</p>



<a name="277261554"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277261554" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277261554">(Mar 31 2022 at 10:44)</a>:</h4>
<p>Huh, I was scared of that approach. Am I mistaken or that program loads up the TOML file as a Lean file (hence the "HACKHACKHACK")?<br>
I will seek other solutions for now then. Maybe something useful comes out of it</p>



<a name="277261612"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277261612" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277261612">(Mar 31 2022 at 10:45)</a>:</h4>
<p>I don't think it is necessary to load the file as a lean file, you should be able to create and call the <code>Parser</code> directly</p>



<a name="277261752"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277261752" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277261752">(Mar 31 2022 at 10:46)</a>:</h4>
<p>the simplest solution is if you can literally embed the syntax in a lean file, headed by a macro or something</p>



<a name="277262152"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277262152" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277262152">(Mar 31 2022 at 10:50)</a>:</h4>
<p>If this is possible, then I most likely can take care of the rest:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">MyType</span>
  <span class="bp">|</span> <span class="n">num</span> <span class="o">:</span> <span class="n">Nat</span> <span class="bp">→</span> <span class="n">MyType</span>
  <span class="bp">|</span> <span class="n">op</span>  <span class="o">:</span> <span class="n">MyType</span> <span class="bp">→</span> <span class="n">MyType</span> <span class="bp">→</span> <span class="n">MyType</span>
  <span class="n">deriving</span> <span class="n">Repr</span>

<span class="n">declare_syntax_cat</span> <span class="n">mytype</span>
<span class="n">syntax</span> <span class="n">num</span> <span class="o">:</span> <span class="n">mytype</span>
<span class="n">syntax</span> <span class="n">num</span> <span class="s2">" !! "</span> <span class="n">num</span> <span class="o">:</span> <span class="n">mytype</span>

<span class="kd">def</span> <span class="n">parseMyType</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">:</span> <span class="n">MyType</span> <span class="o">:=</span> <span class="gr">sorry</span>

<span class="k">#eval</span> <span class="n">parseMyType</span> <span class="s2">"3"</span>      <span class="c1">-- MyType.num 3</span>
<span class="k">#eval</span> <span class="n">parseMyType</span> <span class="s2">"4 !! 5"</span> <span class="c1">-- MyType.op (MyType.num 4) (MyType.num 5)</span>
</code></pre></div>



<a name="277262355"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277262355" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277262355">(Mar 31 2022 at 10:52)</a>:</h4>
<p>do you mind if it lives in a monad, say <code>MetaM</code>?</p>



<a name="277262429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277262429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277262429">(Mar 31 2022 at 10:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/277261554">said</a>:</p>
<blockquote>
<p>that program loads up the TOML file as a Lean file</p>
</blockquote>
<p>No, the file is parsed in the category <code>file</code> defined above <a href="https://github.com/leanprover/lean4/blob/2b7427c962ddab1fc28c9b1f933947b5f7cd60cb/src/Leanpkg/Toml.lean#L60">https://github.com/leanprover/lean4/blob/2b7427c962ddab1fc28c9b1f933947b5f7cd60cb/src/Leanpkg/Toml.lean#L60</a></p>



<a name="277262531"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277262531" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277262531">(Mar 31 2022 at 10:54)</a>:</h4>
<p>I think the first two <code>HACK</code>s are obsolete, we now create antiquotations for syntax abbrevs</p>



<a name="277262625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277262625" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277262625">(Mar 31 2022 at 10:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/277262355">said</a>:</p>
<blockquote>
<p>do you mind if it lives in a monad, say <code>MetaM</code>?</p>
</blockquote>
<p>Nope. I already need to be in <code>IO</code> because I have to read a file. And I remember lifting a <code>MetaM</code> monad from IO</p>



<a name="277262736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277262736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277262736">(Mar 31 2022 at 10:56)</a>:</h4>
<p>if you need to lift from <code>IO</code> to <code>MetaM</code>, keep in mind that you need an environment that contains those <code>syntax</code> declarations</p>



<a name="277262774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277262774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277262774">(Mar 31 2022 at 10:57)</a>:</h4>
<p>in the example this is done using <code>importModules [{ module := `Leanpkg.Toml }] {}</code></p>



<a name="277262797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277262797" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277262797">(Mar 31 2022 at 10:57)</a>:</h4>
<p>where the syntax declarations are in <code>Leanpkg.Toml</code></p>



<a name="277263017"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277263017" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277263017">(Mar 31 2022 at 10:59)</a>:</h4>
<p>I don't understand it. Is <code>Leanpkg.Toml</code> on that very same file?</p>



<a name="277263050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277263050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277263050">(Mar 31 2022 at 10:59)</a>:</h4>
<p>(I ask this because I see <code>namespace Toml</code>)</p>



<a name="277263136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277263136" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277263136">(Mar 31 2022 at 11:00)</a>:</h4>
<p>yes, <code>Leanpkg.Toml</code> is the file itself</p>



<a name="277263218"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277263218" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277263218">(Mar 31 2022 at 11:00)</a>:</h4>
<p>this is a lean file that at runtime reads the olean file it created at compile time</p>



<a name="277263944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277263944" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277263944">(Mar 31 2022 at 11:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/277262355">said</a>:</p>
<blockquote>
<p>do you mind if it lives in a monad, say <code>MetaM</code>?</p>
</blockquote>
<p>I got the impression that you were about to propose a solution that's simpler than the TOML example. Were you :D ?</p>



<a name="277264049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277264049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277264049">(Mar 31 2022 at 11:08)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>
<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Parser</span>
<span class="kd">inductive</span> <span class="n">MyType</span>
  <span class="bp">|</span> <span class="n">num</span> <span class="o">:</span> <span class="n">Nat</span> <span class="bp">→</span> <span class="n">MyType</span>
  <span class="bp">|</span> <span class="n">op</span>  <span class="o">:</span> <span class="n">MyType</span> <span class="bp">→</span> <span class="n">MyType</span> <span class="bp">→</span> <span class="n">MyType</span>
  <span class="n">deriving</span> <span class="n">Repr</span>

<span class="n">declare_syntax_cat</span> <span class="n">mytype</span>
<span class="n">syntax</span> <span class="n">num</span> <span class="o">:</span> <span class="n">mytype</span>
<span class="n">syntax</span> <span class="n">mytype</span> <span class="s2">" !! "</span> <span class="n">mytype</span> <span class="o">:</span> <span class="n">mytype</span>


<span class="n">partial</span> <span class="kd">def</span> <span class="n">parseMyType</span> <span class="o">(</span><span class="n">env</span> <span class="o">:</span> <span class="n">Environment</span><span class="o">)</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">:</span> <span class="n">Except</span> <span class="n">String</span> <span class="n">MyType</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">rec</span> <span class="n">parseCore</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">mytype</span><span class="bp">|</span> <span class="bp">$</span><span class="n">x</span><span class="o">:</span><span class="n">numLit</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">pure</span> <span class="bp">$</span> <span class="n">MyType.num</span> <span class="n">x.toNat</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">mytype</span><span class="bp">|</span> <span class="bp">$</span><span class="n">a</span> <span class="bp">!!</span> <span class="bp">$</span><span class="n">b</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">return</span> <span class="n">MyType.op</span> <span class="o">(</span><span class="bp">←</span> <span class="n">parseCore</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="bp">←</span> <span class="n">parseCore</span> <span class="n">b</span><span class="o">)</span>
  <span class="bp">|</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">throw</span> <span class="s2">"parse error"</span>
  <span class="n">parseCore</span> <span class="o">(</span><span class="bp">←</span> <span class="n">runParserCategory</span> <span class="n">env</span> <span class="bp">`</span><span class="n">mytype</span> <span class="n">s</span><span class="o">)</span>

<span class="k">#eval</span> <span class="k">show</span> <span class="n">MetaM</span> <span class="n">_</span> <span class="k">from</span> <span class="n">return</span> <span class="n">parseMyType</span> <span class="o">(</span><span class="bp">←</span> <span class="n">getEnv</span><span class="o">)</span> <span class="s2">"3"</span>      <span class="c1">-- MyType.num 3</span>
<span class="k">#eval</span> <span class="k">show</span> <span class="n">MetaM</span> <span class="n">_</span> <span class="k">from</span> <span class="n">return</span> <span class="n">parseMyType</span> <span class="o">(</span><span class="bp">←</span> <span class="n">getEnv</span><span class="o">)</span> <span class="s2">"4 !! 5"</span> <span class="c1">-- MyType.op (MyType.num 4) (MyType.num 5)</span>
</code></pre></div>



<a name="277264299"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277264299" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277264299">(Mar 31 2022 at 11:10)</a>:</h4>
<p>Holy smokes, let me try using that idea <span aria-label="open mouth" class="emoji emoji-1f62e" role="img" title="open mouth">:open_mouth:</span></p>



<a name="277264377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277264377" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277264377">(Mar 31 2022 at 11:11)</a>:</h4>
<p>it even gives kind-of-good error messages</p>



<a name="277271060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277271060" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277271060">(Mar 31 2022 at 12:14)</a>:</h4>
<p>It's working!</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#eval</span> <span class="k">show</span> <span class="n">MetaM</span> <span class="n">_</span> <span class="k">from</span> <span class="n">return</span> <span class="n">parseProgram</span> <span class="o">(</span><span class="bp">←</span> <span class="n">getEnv</span><span class="o">)</span> <span class="s2">"a := 3; b := a + a; b + 1"</span>
<span class="c1">-- Except.ok (Program.attribution</span>
<span class="c1">--   "a"</span>
<span class="c1">--   (Program.sequence</span>
<span class="c1">--     (Program.evaluation (Expression.atom (Value.int 3)))</span>
<span class="c1">--     (Program.attribution</span>
<span class="c1">--       "b"</span>
<span class="c1">--       (Program.sequence</span>
<span class="c1">--         (Program.evaluation (Expression.add (Expression.var "a") (Expression.var "a")))</span>
<span class="c1">--         (Program.evaluation (Expression.add (Expression.var "b") (Expression.atom (Value.int 1))))))))</span>
</code></pre></div>



<a name="277271454"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277271454" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277271454">(Mar 31 2022 at 12:18)</a>:</h4>
<p>Although it should start with <code>Program.sequence ...</code>. It's parsing as an attribution of <code>3; b := a + a; b + 1</code> to the variable <code>a</code></p>



<a name="277271633"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277271633" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277271633">(Mar 31 2022 at 12:20)</a>:</h4>
<p>You should be able to fix this by giving the precedences explicitly</p>



<a name="277301430"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277301430" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277301430">(Mar 31 2022 at 15:47)</a>:</h4>
<p>I was able to create the <code>env</code> by doing</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">initSearchPath</span> <span class="o">(</span><span class="bp">←</span> <span class="n">Lean.findSysroot</span><span class="o">)</span> <span class="o">[</span><span class="s2">"build/lib"</span><span class="o">]</span>
<span class="k">let</span> <span class="n">env</span> <span class="bp">←</span> <span class="n">importModules</span> <span class="o">[{</span> <span class="n">module</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">FunnyLang.Parser</span> <span class="o">}]</span> <span class="o">{}</span>
</code></pre></div>
<p>But now my binary relies on being inside the repository. Is there a workaround for this?</p>



<a name="277304938"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277304938" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277304938">(Mar 31 2022 at 16:10)</a>:</h4>
<p>There is one solution, which is keeping a copy of the <code>Parser.lean</code> file as a string and then running Lean's frontend on it to get the env. But I <em>really</em> don't want to touch that</p>



<a name="277305580"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277305580" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277305580">(Mar 31 2022 at 16:14)</a>:</h4>
<p>You do not need the source file, but you do need the .olean file and those of its dependencies</p>



<a name="277305854"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277305854" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277305854">(Mar 31 2022 at 16:17)</a>:</h4>
<p>Does it mean that if I wanted to release a binary for this interpreter, I'd need to release the olean file as well?</p>



<a name="277306027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277306027" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277306027">(Mar 31 2022 at 16:18)</a>:</h4>
<p>Is this kind of issue that <code>builtin syntax</code> would solve?</p>



<a name="277306078"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277306078" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277306078">(Mar 31 2022 at 16:19)</a>:</h4>
<p>yes to both</p>



<a name="277306135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277306135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277306135">(Mar 31 2022 at 16:19)</a>:</h4>
<p>You could do the latter right now by using <code>Parser</code> instead of <code>syntax</code> like Lean itself does, but it <em>is</em> quite different.</p>



<a name="277306686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277306686" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277306686">(Mar 31 2022 at 16:24)</a>:</h4>
<p>is there an example I can see that's not the Lean 4 parser itself? Maybe some simple test case</p>



<a name="277306801"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277306801" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277306801">(Mar 31 2022 at 16:25)</a>:</h4>
<p>I don't think so, no. I developed <code>syntax</code> so most people could avoid <code>Parser/leading_parser</code> :)</p>



<a name="277306899"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277306899" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277306899">(Mar 31 2022 at 16:25)</a>:</h4>
<p>I'm happy waiting for <code>builtin syntax</code> then (and using this current solution) <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="277506426"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277506426" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277506426">(Apr 02 2022 at 04:51)</a>:</h4>
<p>Still on the topic of syntax, I'm not being able to figure this out on my own.<br>
I believe <a href="https://github.com/arthurpaulino/FunnyLang/blob/f6bced8c6b581640ac88c93e0490241c42da0ddc/FunnyLang/Meta.lean#L36">this line</a> is the culprit.</p>
<p>I've set up a bunch of tests below <a href="https://github.com/arthurpaulino/FunnyLang/blob/f6bced8c6b581640ac88c93e0490241c42da0ddc/FunnyLang/Meta.lean#L115">this line</a> and I want to define the syntax such that those <code>#assert</code> lines say nothing. Some of them are already passing, but most of them are complaining.</p>
<p>I'm trying to make the parser understand indentation. But as soon as I use <code>withPosition</code> on the <code>syntax:25 program program : program</code> line, Lean breaks down and the server dies due to some loop that I don't understand.</p>
<p>As always, guidance is very much appreciated <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="277508241"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277508241" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277508241">(Apr 02 2022 at 05:37)</a>:</h4>
<p>wait, how is <code>syntax:25 program program : program</code> supposed to work? That's just going to cause unbounded recursion</p>



<a name="277508306"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277508306" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277508306">(Apr 02 2022 at 05:38)</a>:</h4>
<p>is the intention to support newline-separated statements like in <code>by</code> blocks? If so you can look at how <a href="https://github.com/leanprover/lean4/blob/master/src/Lean/Parser/Term.lean#L34-L39">tactic</a> does it</p>



<a name="277508448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277508448" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277508448">(Apr 02 2022 at 05:41)</a>:</h4>
<p>the key part there is <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.many1indent#src">src4#Lean.Parser.many1indent</a>, which would be written <code>withPosition(colGe p)</code> in the <code>syntax</code> language</p>



<a name="277509605"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277509605" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277509605">(Apr 02 2022 at 06:08)</a>:</h4>
<p>Here's a version that works, except that I had to adjust the indentation in <code>p10</code> and <code>p11</code> since all the lines have to line up</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">declare_syntax_cat</span>                            <span class="n">value</span>
<span class="n">syntax</span> <span class="o">(</span><span class="s2">"-"</span> <span class="n">noWs</span><span class="o">)</span><span class="bp">?</span> <span class="n">num</span>                      <span class="o">:</span> <span class="n">value</span>
<span class="n">syntax</span> <span class="n">str</span>                                  <span class="o">:</span> <span class="n">value</span>
<span class="n">syntax</span> <span class="s2">"true"</span>                               <span class="o">:</span> <span class="n">value</span>
<span class="n">syntax</span> <span class="s2">"false"</span>                              <span class="o">:</span> <span class="n">value</span>
<span class="n">syntax</span> <span class="o">(</span><span class="s2">"-"</span> <span class="n">noWs</span><span class="o">)</span><span class="bp">?</span> <span class="n">num</span> <span class="n">noWs</span> <span class="s2">"."</span> <span class="o">(</span><span class="n">noWs</span> <span class="n">num</span><span class="o">)</span><span class="bp">?</span> <span class="o">:</span> <span class="n">value</span>
<span class="n">syntax</span> <span class="n">withPosition</span><span class="o">(</span><span class="s2">"[ "</span> <span class="n">colGt</span> <span class="n">value</span><span class="bp">*</span> <span class="s2">" ]"</span><span class="o">)</span> <span class="o">:</span> <span class="n">value</span>
<span class="n">syntax</span> <span class="s2">"nil"</span>                                <span class="o">:</span> <span class="n">value</span>

<span class="n">declare_syntax_cat</span>                    <span class="n">expression</span>
<span class="n">syntax</span> <span class="n">value</span>                        <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="s2">" ! "</span> <span class="n">expression</span>             <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="n">expression</span> <span class="s2">" + "</span>  <span class="n">expression</span> <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="n">expression</span> <span class="s2">" * "</span>  <span class="n">expression</span> <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="n">expression</span> <span class="s2">" = "</span>  <span class="n">expression</span> <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="n">expression</span> <span class="s2">" != "</span> <span class="n">expression</span> <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="n">expression</span> <span class="s2">" &lt; "</span>  <span class="n">expression</span> <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="n">expression</span> <span class="s2">" &lt;= "</span> <span class="n">expression</span> <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="n">expression</span> <span class="s2">" &gt; "</span>  <span class="n">expression</span> <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="n">expression</span> <span class="s2">" &gt;= "</span> <span class="n">expression</span> <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="n">ident</span> <span class="o">(</span><span class="n">colGt</span> <span class="n">expression</span><span class="o">)</span><span class="bp">*</span>    <span class="o">:</span> <span class="n">expression</span>
<span class="n">syntax</span> <span class="s2">"( "</span> <span class="n">expression</span> <span class="s2">" )"</span>         <span class="o">:</span> <span class="n">expression</span>

<span class="n">declare_syntax_cat</span> <span class="n">program</span>

<span class="n">syntax</span> <span class="n">programSeq</span> <span class="o">:=</span> <span class="n">withPosition</span><span class="o">((</span><span class="n">colGe</span> <span class="n">program</span><span class="o">)</span><span class="bp">+</span><span class="o">)</span>
<span class="n">syntax</span> <span class="s2">"skip"</span>                                                 <span class="o">:</span> <span class="n">program</span>
<span class="n">syntax</span> <span class="n">withPosition</span><span class="o">(</span><span class="n">ident</span><span class="bp">+</span> <span class="s2">" := "</span> <span class="n">colGt</span> <span class="n">programSeq</span><span class="o">)</span>           <span class="o">:</span> <span class="n">program</span>
<span class="n">syntax</span> <span class="n">expression</span>                                             <span class="o">:</span> <span class="n">program</span>
<span class="n">syntax</span> <span class="s2">"if"</span> <span class="n">expression</span> <span class="s2">"then"</span> <span class="n">colGt</span> <span class="n">programSeq</span> <span class="s2">"else"</span> <span class="n">colGt</span> <span class="n">programSeq</span> <span class="o">:</span> <span class="n">program</span>
<span class="n">syntax</span> <span class="n">withPosition</span><span class="o">(</span><span class="s2">"while"</span> <span class="n">expression</span> <span class="s2">"do"</span> <span class="n">colGt</span> <span class="n">programSeq</span><span class="o">)</span> <span class="o">:</span> <span class="n">program</span>
<span class="n">syntax</span> <span class="s2">" ( "</span> <span class="n">programSeq</span> <span class="s2">" ) "</span> <span class="o">:</span> <span class="n">program</span>

<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Elab</span> <span class="n">Meta</span>

<span class="kd">def</span> <span class="n">mkApp'</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="n">Name</span><span class="o">)</span> <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="n">Expr</span><span class="o">)</span> <span class="o">:</span> <span class="n">Expr</span> <span class="o">:=</span>
  <span class="n">mkApp</span> <span class="o">(</span><span class="n">mkConst</span> <span class="n">name</span><span class="o">)</span> <span class="n">e</span>

<span class="kd">def</span> <span class="n">elabValue</span> <span class="o">:</span> <span class="n">Syntax</span> <span class="bp">→</span> <span class="n">TermElabM</span> <span class="n">Expr</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">value</span><span class="bp">|$</span><span class="n">n</span><span class="o">:</span><span class="n">numLit</span><span class="o">)</span> <span class="bp">=&gt;</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Value.int</span> <span class="bp">#</span><span class="o">[</span><span class="n">mkApp'</span> <span class="bp">``</span><span class="n">Int.ofNat</span> <span class="o">(</span><span class="n">mkNatLit</span> <span class="n">n.toNat</span><span class="o">)]</span>
  <span class="bp">|</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">throwUnsupportedSyntax</span>

<span class="kd">def</span> <span class="n">elabStringOfIdent</span> <span class="o">(</span><span class="n">id</span> <span class="o">:</span> <span class="n">Syntax</span><span class="o">)</span> <span class="o">:</span> <span class="n">Expr</span> <span class="o">:=</span>
  <span class="n">mkStrLit</span> <span class="n">id.getId.toString</span>

<span class="n">partial</span> <span class="kd">def</span> <span class="n">elabExpression</span> <span class="o">:</span> <span class="n">Syntax</span> <span class="bp">→</span> <span class="n">TermElabM</span> <span class="n">Expr</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">value</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span> <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.atom</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabValue</span> <span class="n">v</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">!</span> <span class="bp">$</span><span class="n">e</span><span class="o">:</span><span class="n">expression</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.not</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">e</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">$</span><span class="n">n</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">es</span><span class="o">:</span><span class="n">expression</span><span class="o">]</span><span class="bp">*</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">es</span> <span class="bp">←</span> <span class="n">es.data.mapM</span> <span class="n">elabExpression</span>
    <span class="k">match</span> <span class="n">es</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="o">[]</span>      <span class="bp">=&gt;</span> <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.var</span> <span class="bp">#</span><span class="o">[</span><span class="n">elabStringOfIdent</span> <span class="n">n</span><span class="o">]</span>
    <span class="bp">|</span> <span class="n">e</span> <span class="o">::</span> <span class="n">es</span> <span class="bp">=&gt;</span>
      <span class="k">let</span> <span class="n">l</span>  <span class="bp">←</span> <span class="n">mkListLit</span> <span class="o">(</span><span class="n">Lean.mkConst</span> <span class="bp">``</span><span class="n">Expression</span><span class="o">)</span> <span class="n">es</span>
      <span class="k">let</span> <span class="n">nl</span> <span class="bp">←</span> <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">List.toNEList</span> <span class="bp">#</span><span class="o">[</span><span class="n">e</span><span class="o">,</span> <span class="n">l</span><span class="o">]</span>
      <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.app</span> <span class="bp">#</span><span class="o">[</span><span class="n">elabStringOfIdent</span> <span class="n">n</span><span class="o">,</span> <span class="n">nl</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">$</span><span class="n">l</span><span class="o">:</span><span class="n">expression</span> <span class="bp">+</span> <span class="bp">$</span><span class="n">r</span><span class="o">:</span><span class="n">expression</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.add</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">l</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">r</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">$</span><span class="n">l</span><span class="o">:</span><span class="n">expression</span> <span class="bp">*</span> <span class="bp">$</span><span class="n">r</span><span class="o">:</span><span class="n">expression</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.mul</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">l</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">r</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">$</span><span class="n">l</span><span class="o">:</span><span class="n">expression</span> <span class="bp">=</span> <span class="bp">$</span><span class="n">r</span><span class="o">:</span><span class="n">expression</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.eq</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">l</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">r</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">$</span><span class="n">l</span><span class="o">:</span><span class="n">expression</span> <span class="bp">!=</span> <span class="bp">$</span><span class="n">r</span><span class="o">:</span><span class="n">expression</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.ne</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">l</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">r</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">$</span><span class="n">l</span><span class="o">:</span><span class="n">expression</span> <span class="bp">&lt;</span> <span class="bp">$</span><span class="n">r</span><span class="o">:</span><span class="n">expression</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.lt</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">l</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">r</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">$</span><span class="n">l</span><span class="o">:</span><span class="n">expression</span> <span class="bp">&lt;=</span> <span class="bp">$</span><span class="n">r</span><span class="o">:</span><span class="n">expression</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.le</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">l</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">r</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">$</span><span class="n">l</span><span class="o">:</span><span class="n">expression</span> <span class="bp">&gt;</span> <span class="bp">$</span><span class="n">r</span><span class="o">:</span><span class="n">expression</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.gt</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">l</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">r</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="bp">$</span><span class="n">l</span><span class="o">:</span><span class="n">expression</span> <span class="bp">&gt;=</span> <span class="bp">$</span><span class="n">r</span><span class="o">:</span><span class="n">expression</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Expression.ge</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">l</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">r</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">expression</span><span class="bp">|</span> <span class="o">(</span><span class="bp">$</span><span class="n">e</span><span class="o">:</span><span class="n">expression</span><span class="o">))</span> <span class="bp">=&gt;</span> <span class="n">elabExpression</span> <span class="n">e</span>
  <span class="bp">|</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">throwUnsupportedSyntax</span>

<span class="n">partial</span> <span class="kd">def</span> <span class="n">elabProgram</span> <span class="o">:</span> <span class="n">Syntax</span> <span class="bp">→</span> <span class="n">TermElabM</span> <span class="n">Expr</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">programSeq</span><span class="bp">|</span> <span class="bp">$</span><span class="n">p1</span><span class="o">:</span><span class="n">program</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">p</span><span class="o">:</span><span class="n">program</span><span class="o">]</span><span class="bp">*</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">p.foldlM</span> <span class="o">(</span><span class="n">init</span> <span class="o">:=</span> <span class="bp">←</span> <span class="n">elabProgram</span> <span class="n">p1</span><span class="o">)</span> <span class="k">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=&gt;</span> <span class="k">do</span>
      <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Program.sequence</span> <span class="bp">#</span><span class="o">[</span><span class="n">a</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabProgram</span> <span class="n">b</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">program</span><span class="bp">|</span> <span class="n">skip</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">return</span> <span class="n">mkConst</span> <span class="bp">``</span><span class="n">Program.skip</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">program</span><span class="bp">|</span> <span class="bp">$</span><span class="n">n</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ns</span><span class="o">:</span><span class="n">ident</span><span class="bp">*</span> <span class="o">:=</span> <span class="bp">$</span><span class="n">p</span><span class="o">:</span><span class="n">programSeq</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="k">match</span> <span class="n">ns.data.map</span> <span class="n">elabStringOfIdent</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="o">[]</span>      <span class="bp">=&gt;</span>
      <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Program.attribution</span> <span class="bp">#</span><span class="o">[</span><span class="n">elabStringOfIdent</span> <span class="n">n</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabProgram</span> <span class="n">p</span><span class="o">]</span>
    <span class="bp">|</span> <span class="n">n'</span> <span class="o">::</span> <span class="n">ns</span> <span class="bp">=&gt;</span>
      <span class="k">let</span> <span class="n">l</span>  <span class="bp">←</span> <span class="n">mkListLit</span> <span class="o">(</span><span class="n">Lean.mkConst</span> <span class="bp">``</span><span class="n">String</span><span class="o">)</span> <span class="n">ns</span>
      <span class="k">let</span> <span class="n">nl</span> <span class="bp">←</span> <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">List.toNEList</span> <span class="bp">#</span><span class="o">[</span><span class="n">n'</span><span class="o">,</span> <span class="n">l</span><span class="o">]</span>
      <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Program.attribution</span> <span class="bp">#</span><span class="o">[</span>
        <span class="n">elabStringOfIdent</span> <span class="n">n</span><span class="o">,</span>
        <span class="n">mkApp'</span> <span class="bp">``</span><span class="n">Program.evaluation</span> <span class="bp">$</span>
          <span class="n">mkApp'</span> <span class="bp">``</span><span class="n">Expression.atom</span> <span class="bp">$</span>
            <span class="bp">←</span> <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Value.curry</span> <span class="bp">#</span><span class="o">[</span><span class="n">nl</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabProgram</span> <span class="n">p</span><span class="o">]</span>
      <span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">program</span><span class="bp">|</span> <span class="k">if</span> <span class="bp">$</span><span class="n">e</span><span class="o">:</span><span class="n">expression</span> <span class="k">then</span> <span class="bp">$</span><span class="n">p</span><span class="o">:</span><span class="n">programSeq</span> <span class="k">else</span> <span class="bp">$</span><span class="n">q</span><span class="o">:</span><span class="n">programSeq</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Program.ifElse</span>
      <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">e</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabProgram</span> <span class="n">p</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabProgram</span> <span class="n">q</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">program</span><span class="bp">|</span> <span class="n">while</span> <span class="bp">$</span><span class="n">e</span><span class="o">:</span><span class="n">expression</span> <span class="k">do</span> <span class="bp">$</span><span class="n">p</span><span class="o">:</span><span class="n">programSeq</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Program.whileLoop</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">e</span><span class="o">,</span> <span class="bp">←</span> <span class="n">elabProgram</span> <span class="n">p</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">program</span><span class="bp">|</span> <span class="bp">$</span><span class="n">e</span><span class="o">:</span><span class="n">expression</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="n">mkAppM</span> <span class="bp">``</span><span class="n">Program.evaluation</span> <span class="bp">#</span><span class="o">[</span><span class="bp">←</span> <span class="n">elabExpression</span> <span class="n">e</span><span class="o">]</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">program</span><span class="bp">|</span> <span class="o">(</span><span class="bp">$</span><span class="n">p</span><span class="o">:</span><span class="n">programSeq</span><span class="o">))</span> <span class="bp">=&gt;</span> <span class="n">elabProgram</span> <span class="n">p</span>
  <span class="bp">|</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">throwUnsupportedSyntax</span>

<span class="c1">------- ↓↓ testing area ↓↓</span>

<span class="n">elab</span> <span class="s2">"&gt;&gt;"</span> <span class="n">ppLine</span> <span class="n">p</span><span class="o">:</span><span class="n">programSeq</span> <span class="n">ppLine</span> <span class="s2">"&lt;&lt;"</span> <span class="o">:</span> <span class="n">term</span> <span class="bp">=&gt;</span> <span class="n">elabProgram</span> <span class="n">p</span>

<span class="kn">open</span> <span class="n">Lean.Elab.Command</span> <span class="n">Lean.Elab.Term</span> <span class="k">in</span>
<span class="n">elab</span> <span class="s2">"#assert "</span> <span class="n">x</span><span class="o">:</span><span class="n">term</span><span class="o">:</span><span class="mi">60</span> <span class="s2">" = "</span> <span class="n">y</span><span class="o">:</span><span class="n">term</span><span class="o">:</span><span class="mi">60</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span>
  <span class="n">liftTermElabM</span> <span class="bp">`</span><span class="n">assert</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">x</span> <span class="bp">←</span> <span class="n">elabTerm</span> <span class="n">x</span> <span class="n">none</span>
    <span class="k">let</span> <span class="n">y</span> <span class="bp">←</span> <span class="n">elabTerm</span> <span class="n">y</span> <span class="n">none</span>
    <span class="n">synthesizeSyntheticMVarsNoPostponing</span>
    <span class="n">unless</span> <span class="o">(</span><span class="bp">←</span> <span class="n">isDefEq</span> <span class="n">x</span> <span class="n">y</span><span class="o">)</span> <span class="k">do</span>
      <span class="n">throwError</span> <span class="s2">"{← reduce x}</span><span class="se">\n</span><span class="s2">------------------------</span><span class="se">\n</span><span class="s2">{← reduce y}"</span>

<span class="kd">def</span> <span class="n">p1</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="n">min</span> <span class="n">x</span> <span class="n">y</span> <span class="o">:=</span>
  <span class="k">if</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">y</span>
    <span class="k">then</span> <span class="n">x</span>
    <span class="k">else</span> <span class="n">y</span>
<span class="n">min</span> <span class="mi">5</span> <span class="mi">3</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="kd">def</span> <span class="n">p2</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="o">(</span><span class="n">min</span> <span class="n">x</span> <span class="n">y</span> <span class="o">:=</span>
  <span class="k">if</span> <span class="n">x</span> <span class="bp">&lt;</span> <span class="n">y</span>
    <span class="k">then</span> <span class="n">x</span>
    <span class="k">else</span> <span class="n">y</span><span class="o">)</span>
<span class="n">min</span> <span class="mi">5</span> <span class="mi">3</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="bp">#</span><span class="n">assert</span> <span class="n">p1</span> <span class="bp">=</span> <span class="n">p2</span>

<span class="kd">def</span> <span class="n">p3</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="n">while</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">a</span> <span class="k">do</span>
  <span class="n">x</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="n">a</span> <span class="bp">&lt;</span> <span class="mi">3</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="kd">def</span> <span class="n">p4</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="n">while</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">a</span> <span class="k">do</span> <span class="n">x</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="n">a</span> <span class="bp">&lt;</span> <span class="mi">3</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="kd">def</span> <span class="n">p5</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="o">(</span><span class="n">while</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="n">a</span> <span class="k">do</span> <span class="n">x</span> <span class="o">:=</span> <span class="mi">2</span><span class="o">)</span>
<span class="n">a</span> <span class="bp">&lt;</span> <span class="mi">3</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="bp">#</span><span class="n">assert</span> <span class="n">p3</span> <span class="bp">=</span> <span class="n">p4</span>
<span class="bp">#</span><span class="n">assert</span> <span class="n">p4</span> <span class="bp">=</span> <span class="n">p5</span>

<span class="kd">def</span> <span class="n">p6</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="o">(</span><span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">:=</span>
  <span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span>
<span class="o">(</span><span class="n">f3</span> <span class="o">:=</span> <span class="n">f</span> <span class="mi">3</span><span class="o">)</span>
<span class="n">f32</span> <span class="o">:=</span> <span class="n">f3</span> <span class="mi">2</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="kd">def</span> <span class="n">p7</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="o">(</span><span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">:=</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span>
<span class="o">(</span><span class="n">f3</span> <span class="o">:=</span> <span class="n">f</span> <span class="mi">3</span><span class="o">)</span>
<span class="n">f32</span> <span class="o">:=</span> <span class="n">f3</span> <span class="mi">2</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="bp">#</span><span class="n">assert</span> <span class="n">p6</span> <span class="bp">=</span> <span class="n">p7</span>

<span class="kd">def</span> <span class="n">p8</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">:=</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">y</span>
<span class="n">f3</span> <span class="o">:=</span> <span class="n">f</span> <span class="mi">3</span>
<span class="n">f32</span> <span class="o">:=</span> <span class="n">f3</span> <span class="mi">2</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="bp">#</span><span class="n">assert</span> <span class="n">p7</span> <span class="bp">=</span> <span class="n">p8</span>


<span class="kd">def</span> <span class="n">p9</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="n">a</span> <span class="o">:=</span>
  <span class="n">x</span> <span class="o">:=</span> <span class="mi">5</span>
  <span class="n">y</span> <span class="bp">=</span> <span class="mi">5</span>
<span class="mi">2</span> <span class="bp">+</span> <span class="mi">5</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="kd">def</span> <span class="n">p9'</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="o">(</span><span class="n">a</span> <span class="o">:=</span>
  <span class="n">x</span> <span class="o">:=</span> <span class="mi">5</span>
  <span class="n">y</span> <span class="bp">=</span> <span class="mi">5</span><span class="o">)</span>
<span class="mi">2</span> <span class="bp">+</span> <span class="mi">5</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="kd">def</span> <span class="n">p10</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="n">a</span> <span class="o">:=</span>
  <span class="o">(</span><span class="n">x</span> <span class="o">:=</span> <span class="mi">5</span>
   <span class="n">y</span> <span class="bp">=</span> <span class="mi">5</span><span class="o">)</span>
<span class="mi">2</span> <span class="bp">+</span> <span class="mi">5</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="kd">def</span> <span class="n">p11</span> <span class="o">:=</span> <span class="bp">&gt;&gt;</span>
<span class="o">(</span><span class="n">a</span> <span class="o">:=</span>
  <span class="o">((</span><span class="n">x</span> <span class="o">:=</span> <span class="mi">5</span><span class="o">)</span>
   <span class="n">y</span> <span class="bp">=</span> <span class="mi">5</span><span class="o">))</span>
<span class="mi">2</span> <span class="bp">+</span> <span class="mi">5</span>
<span class="bp">&lt;&lt;.</span><span class="n">toString</span>

<span class="bp">#</span><span class="n">assert</span> <span class="n">p9</span> <span class="bp">=</span> <span class="n">p9'</span>
<span class="bp">#</span><span class="n">assert</span> <span class="n">p9</span> <span class="bp">=</span> <span class="n">p10</span>
<span class="bp">#</span><span class="n">assert</span> <span class="n">p10</span> <span class="bp">=</span> <span class="n">p11</span>
</code></pre></div>



<a name="277513991"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277513991" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277513991">(Apr 02 2022 at 07:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/277506426">said</a>:</p>
<blockquote>
<p>I'm trying to make the parser understand indentation. But as soon as I use <code>withPosition</code> on the <code>syntax:25 program program : program</code> line, Lean breaks down and the server dies due to some loop that I don't understand.</p>
</blockquote>
<p>Lean eliminates the left recursion in <code>syntax cat ... : cat</code>, but if you wrap it in <code>withPosition</code>, it doesn't happen anymore</p>



<a name="277521249"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277521249" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277521249">(Apr 02 2022 at 10:32)</a>:</h4>
<p>And as always, thanks a lot <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span></p>



<a name="277642422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277642422" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277642422">(Apr 03 2022 at 15:32)</a>:</h4>
<p>(I just noticed that you fixed other syntax definitions in my code, thanks for those as well <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span>)</p>



<a name="277664377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277664377" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277664377">(Apr 03 2022 at 22:21)</a>:</h4>
<p>I ran into a syntax trouble again <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span> <br>
I apologize upfront for not being able to reduce the code to a smaller <a href="https://leanprover-community.github.io/mwe.html">#mwe</a>.</p>
<p>I'm trying to represent a function application:</p>
<ul>
<li><code>f 3 3</code> applies 3 and 3 to the function <code>f</code></li>
<li><code>f a 3</code> applies <code>a</code> and 3 to the function <code>f</code></li>
</ul>
<p>In <a href="https://github.com/arthurpaulino/FunnyLang/blob/7f7fb451deeae27e6b3ec3a6afd30a59e2ad519a/FunnyLang/Meta.lean#L133">my code</a>, <code>f 3 3</code> is properly parsed as "f [3 3]", "[3 3]" being a list of expressions. However, I can't seem to be able to make Lean understand <code>f a 3</code> as "f [a 3]". Instead, it's parsing as if I were passing an application of 3 to the "function" <code>a</code> and then passing the result to the function <code>f</code></p>
<p>As you can see, I put a debug message so we can know the number of application arguments being parsed. In the <code>f 3 3</code> example it prints out <code>2</code>, which is correct. But in <code>f a 3</code> it prints out <code>1</code> and then <code>1</code> again, which is coherent with the behavior I'm describing above.</p>
<p>Any ideas how I can escape of this right precedence behavior? I tried setting precedence values in a lot of different ways without success</p>



<a name="277664562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277664562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277664562">(Apr 03 2022 at 22:24)</a>:</h4>
<p>While trying to create an <a href="https://leanprover-community.github.io/mwe.html">#mwe</a>, I was able to make this small prototype work:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>

<span class="n">declare_syntax_cat</span> <span class="n">foo</span>
<span class="n">syntax</span> <span class="n">num</span>                      <span class="o">:</span> <span class="n">foo</span>
<span class="n">syntax</span><span class="o">:</span><span class="mi">51</span> <span class="n">ident</span>                 <span class="o">:</span> <span class="n">foo</span>
<span class="n">syntax</span><span class="o">:</span><span class="mi">49</span> <span class="n">ident</span> <span class="o">(</span><span class="n">colGt</span> <span class="n">foo</span><span class="o">:</span><span class="mi">50</span><span class="o">)</span><span class="bp">+</span> <span class="o">:</span> <span class="n">foo</span>

<span class="n">elab</span> <span class="s2">" ⟪ "</span> <span class="n">f</span><span class="o">:</span><span class="n">foo</span> <span class="s2">" ⟫ "</span> <span class="o">:</span> <span class="n">term</span> <span class="bp">=&gt;</span>
  <span class="k">match</span> <span class="n">f</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">foo</span><span class="bp">|</span> <span class="bp">$</span><span class="n">i</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">fs</span><span class="o">:</span><span class="n">foo</span><span class="bp">*</span><span class="o">)</span> <span class="bp">=&gt;</span>
    <span class="n">dbg_trace</span> <span class="n">fs.size</span>
    <span class="n">default</span>
  <span class="bp">|</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">default</span>

<span class="k">#eval</span> <span class="bp">⟪</span><span class="n">f</span> <span class="mi">3</span> <span class="mi">3</span><span class="bp">⟫</span> <span class="c1">-- 2</span>
<span class="k">#eval</span> <span class="bp">⟪</span><span class="n">f</span> <span class="n">a</span> <span class="mi">3</span><span class="bp">⟫</span> <span class="c1">-- 2</span>
</code></pre></div>
<p>But when I try to plug this idea in my code, it breaks all my other examples with working syntax</p>



<a name="277665467"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277665467" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277665467">(Apr 03 2022 at 22:44)</a>:</h4>
<p>Wait, nevermind. I got it!<br>
I had to add a match case for the <code>| `(expression| $n:ident)</code> alone <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="277665471"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277665471" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277665471">(Apr 03 2022 at 22:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> has marked this topic as resolved.</p>



<a name="277666198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/277666198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#277666198">(Apr 03 2022 at 23:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> has marked this topic as unresolved.</p>



<a name="280868705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280868705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280868705">(May 02 2022 at 12:44)</a>:</h4>
<p>Hi everyone! I'm happy to announce that the first iteration my first ever programming language is finished and documented. I named it <a href="https://github.com/arthurpaulino/FxyLang">Fxy</a>.</p>
<p>There's still a lot of work on the reasoning front, but the implementation is working nicely already. I wouldn't have been able to do it without the ideas from <span class="user-mention" data-user-id="110026">@Simon Hudon</span> and <span class="user-mention" data-user-id="110049">@Mario Carneiro</span>. Also, big thanks to everyone who helped me in this thread.</p>
<p>Fxy is (obviously) infinitely simpler than Lean 4 and thus might serve as a small (and yet not too trivial) showcase of how to use Lean 4 for programming purposes.</p>
<p>A small example of a Fxy program to compute the sum of the <code>n</code> first natural numbers:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">f</span> <span class="n">n</span> <span class="o">:=</span>
  <span class="n">s</span> <span class="o">:=</span> <span class="mi">0</span>
  <span class="n">i</span> <span class="o">:=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="n">do</span>
    <span class="n">i</span> <span class="o">:=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">s</span> <span class="o">:=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">i</span>
  <span class="n">s</span>
<span class="err">!</span><span class="nb">print</span> <span class="n">f</span> <span class="mi">5</span> <span class="c1"># prints 15</span>
</code></pre></div>



<a name="280873613"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280873613" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280873613">(May 02 2022 at 13:31)</a>:</h4>
<p>Very very cool Arthur. I see you're also working on showing off some reasoning there now -- is the idea that someone will be able to take a Fxy program like that one and prove things about it from within Lean via some exposed intermediate API? If so in some nice future world where someone writes an e.g. Python interpreter in Lean 4 that will be very cool.</p>



<a name="280874214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280874214" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280874214">(May 02 2022 at 13:37)</a>:</h4>
<p>That idea actually blew my mind. No, it wasn't on my radar. I just want to learn about semantics reasoning and that's why there exists an implementation of small steps. But hey, being able to reason about Python code from Lean would be pretty cool! (Although I believe that only a subset of Python  could be considered in such scenario)</p>



<a name="280875588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280875588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280875588">(May 02 2022 at 13:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="321696">Julian Berman</span> <a href="#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/280873613">said</a>:</p>
<blockquote>
<p>Very very cool Arthur. I see you're also working on showing off some reasoning there now -- is the idea that someone will be able to take a Fxy program like that one and prove things about it from within Lean via some exposed intermediate API? If so in some nice future world where someone writes an e.g. Python interpreter in Lean 4 that will be very cool.</p>
</blockquote>
<p>Formally arguing about non functional languages is usually rather complicated because of all the pointer/reference stuff that can change all the time. The Coq people have done huge amounts of efforts to argue about a C subset, I imagine an even more complicated and less typed language like python will be much harder.</p>



<a name="280876774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280876774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280876774">(May 02 2022 at 13:58)</a>:</h4>
<p>Thanks, I figured this was definitely not a new idea and likely a hard one :D -- seems like I found <a href="http://staff.ustc.edu.cn/~fuming/papers/p97-cao.pdf">this</a> or <a href="https://link.springer.com/article/10.1007/s00165-007-0055-2">this</a> fairly quickly to peruse.</p>



<a name="280876909"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280876909" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280876909">(May 02 2022 at 13:59)</a>:</h4>
<p>Very nice! At some point I might attempt to parse existing scripting language VEX in Houdini to Lean 4 and looking at Fxy as a guiding example will be tremendously helpful.</p>



<a name="280877430"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280877430" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280877430">(May 02 2022 at 14:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="321696">Julian Berman</span> <a href="#narrow/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean/near/280876774">said</a>:</p>
<blockquote>
<p>Thanks, I figured this was definitely not a new idea and likely a hard one :D -- seems like I found <a href="http://staff.ustc.edu.cn/~fuming/papers/p97-cao.pdf">this</a> or <a href="https://link.springer.com/article/10.1007/s00165-007-0055-2">this</a> fairly quickly to peruse.</p>
</blockquote>
<p>The two big names in Coq world regarding formalization of C are CompCert and VST/Verified Software Toolchain if youre interested in that.</p>



<a name="280877844"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280877844" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280877844">(May 02 2022 at 14:06)</a>:</h4>
<p>I am indeed, thanks for pointing me in the right direction! (Now I'll probably stop crowding Arthur's cool thread!)</p>



<a name="280878021"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280878021" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280878021">(May 02 2022 at 14:08)</a>:</h4>
<p><span class="user-mention" data-user-id="346070">@Tomas Skrivan</span> I also implemented a way to parse Fxy code in Lean itself (not from a string). I used it mostly for debugging (see <code>MetaDebug.lean</code>), but I believe cooler things can be done with it</p>



<a name="280878472"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280878472" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280878472">(May 02 2022 at 14:13)</a>:</h4>
<p>I have no clue how these things work ... are you using the same parser code to parse Fxy from a *.fxy file and from within a *.lean file?</p>



<a name="280878834"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280878834" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280878834">(May 02 2022 at 14:15)</a>:</h4>
<p>Ughhh I'm confused, you have two ways of running Fxy, right? Either you have your own execution defined in <code>Executaion.lean</code> or you turn Fxy code into Lean expression, in <code>MetaDebug.lean</code>, and execute that. Why do you have these two ways of doing that?</p>



<a name="280879827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280879827" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280879827">(May 02 2022 at 14:24)</a>:</h4>
<p>There are two ways to <em>parse</em> Fxy code and two ways to <em>run</em> a (parsed) Fxy program. Those are orthogonal.</p>
<p>You can parse code from a fxy file or from a lean file. Once you have a <code>Program</code>, you can run it using the verifiable runner or the non-verifiable runner.</p>
<p>The parsers use the same syntax (see <code>Syntax.lean</code>). Hm, I should explain this better in the repo</p>



<a name="280880422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280880422" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280880422">(May 02 2022 at 14:28)</a>:</h4>
<p>The parsers themselves are very similar, but one produces a term of <code>Program</code> (when reading from a fxy file) and the other produces a term of <code>Expr</code> (this is what you'd do in term elaboration - read <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/md/elaboration.md">this chapter</a> written by <span class="user-mention" data-user-id="395550">@Henrik Böving</span> )</p>



<a name="280881076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280881076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280881076">(May 02 2022 at 14:33)</a>:</h4>
<p>Answering the question of "why", it was just for debugging. It's much faster to debug the executor if the code can be parsed from Lean code than if I had to do cycles of <code>lake build</code> and fxy file editing everytime. And btw this was one aspect of the development which really made Lean 4 shine IMO</p>



<a name="280889328"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280889328" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280889328">(May 02 2022 at 15:30)</a>:</h4>
<p>That makes sense, is there a way to keep those two executors in sync?  Or you just hope they match each other? As the language grows I guess you will drop the debugging executor, or no?</p>



<a name="280890426"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280890426" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280890426">(May 02 2022 at 15:38)</a>:</h4>
<p>Very Nice. One hope of mine to try some day is the <a href="https://www.gap-system.org/Manuals/doc/ref/chap4.html#X7FE7C0C17E1ED118">GAP system</a> so a bunch of mathematical algorithms run in Lean 4. Hopefully they can be lifted step-by-step to certified ones.</p>



<a name="280892960"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280892960" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280892960">(May 02 2022 at 15:56)</a>:</h4>
<p><span class="user-mention" data-user-id="346070">@Tomas Skrivan</span> I think you mean the debugging parser. Maybe!<br>
If you see the file you'll notice that it's also easy to create test cases with it</p>



<a name="280899233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280899233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Christian Pehle <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280899233">(May 02 2022 at 16:41)</a>:</h4>
<p>Similarly it might be cool if Lean 4 would eventually be used to replace the bespoke scripting languages in Singular, Macaulay 2 etc. with something that has more solid foundations.</p>



<a name="280903158"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/280903158" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#280903158">(May 02 2022 at 17:10)</a>:</h4>
<p>If using Lean's <code>syntax</code> to parse generic strings (e.g. extracted from text files) becomes a thing, then a proper workaround for <a href="https://github.com/arthurpaulino/FxyLang/blob/afcd0db77d320438d625bac9cb8cf55413c47e52/Main.lean#L14">this part</a> might be more useful than expected</p>



<a name="281017341"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281017341" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281017341">(May 03 2022 at 14:02)</a>:</h4>
<p><span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span> which group theory algorithms in particular are you interested in? I'm assuming that "formally verify GAP algorithms" is not really possible, so it's "re-implement GAP algorithms in Lean and prove they're correct"?</p>



<a name="281020860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281020860" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281020860">(May 03 2022 at 14:25)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span>  The actual algorithms I plan to try to implement (with proofs) are those from Geometric/Combinatorial group theory. For example, the word and conjugacy problems for surface groups and free groups. I do not know if these are in GAP, but either way I would work from scratch in Lean 4.</p>
<p>The GAP stuff was more speculation. What I mean was that since the syntax of lean 4 is so nicely extendable, elaborators will translate appropriately enclosed (or read from files) objects as lean objects. So in principle one can try to prove theorems about these. A variant is to use the pretty printer to actually generate lean code and work with this. The broad idea is to start with lean purely as a programming language, with interpreters able to run code in at least small languages like GAP. And see if algorithms can be enriched incrementally with proofs. </p>
<p>Whether this is even remotely practical I have no idea, and won't till it is tried.</p>



<a name="281023729"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281023729" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281023729">(May 03 2022 at 14:44)</a>:</h4>
<p>I think it's an interesting idea whether or not it's practical. It might be hard to sell to the math community -- "oh GAP is a pretty good piece of software and I'll continue to use it over yours because it's faster and you don't usually hit bugs" -- but I think that formally verified serious mathematical software will only get better over time and it's worth trying to put down some markers, so we can discover what the state of the art looks like.</p>



<a name="281026690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281026690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddharth Bhat <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281026690">(May 03 2022 at 15:04)</a>:</h4>
<p>One thought might be to run GAP algorithms unverified in Lean, and then <em>verify</em> that the results are correct via proof certificates within Lean4. So GAP is used to import untrusted algorithms, whose results we check with formally proven verifiers..I've started on a GAP embedding in Lean (<a href="https://github.com/opencompl/lean-gap">https://github.com/opencompl/lean-gap</a>), though it's early days yet.</p>



<a name="281027717"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281027717" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281027717">(May 03 2022 at 15:10)</a>:</h4>
<p>A verified algorithm can also give a formal proof. For instance one may want to show that something is not a sphere, and a verified algorithm may show that its fundamental group is non-trivial (there is an actual published paper in a top journal with the opposite error - something that was claimed about a sphere but turns out was about a space with non-trivial fundamental group).</p>



<a name="281965556"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281965556" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281965556">(May 11 2022 at 13:33)</a>:</h4>
<p>Just speculation at this point, but how hard will it be to have a command elaborator for say <code>importFxy filename</code> which imports an fxy file and makes <em>lean</em> definitions corresponding to function definitions in the <em>fxy</em> file?</p>



<a name="281966862"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281966862" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281966862">(May 11 2022 at 13:43)</a>:</h4>
<p>i'm guessing you'd intend to do it at compilation time, because at execution time it's already the current flow.</p>
<p>If you can perform IO operations (reading a text file) at compilation time, then you can pass the content of a <code>fxy</code> file to the <a href="https://github.com/arthurpaulino/FxyLang/blob/d7cf6aeff91f02d59bf9387e853983184a001c44/FxyLang/Implementation/Parser.lean#L106">parse function</a>, which should take care of the rest. Notice that the current parsing method also requires an <code>Environment</code> containing the syntax definitions, but it can be done from a monad like <code>MetaM</code> via <code>getEnv</code>.</p>



<a name="281967379"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281967379" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281967379">(May 11 2022 at 13:47)</a>:</h4>
<p>So the question becomes: how to read an arbitrary text file at compilation time? I don't know, but I do recall seeing people do it</p>



<a name="281967756"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281967756" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281967756">(May 11 2022 at 13:49)</a>:</h4>
<p>Easily, because <code>IO</code> can be lifted into <code>CoreM</code> etc</p>



<a name="281968925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281968925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281968925">(May 11 2022 at 13:57)</a>:</h4>
<p>That is what I thought <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> - and am I correct that this should work in the interpreter too? (My agenda eventually is to target GAP).</p>



<a name="281970055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281970055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281970055">(May 11 2022 at 14:03)</a>:</h4>
<p>There should be no semantic difference between compiled code and the interpreter except that the latter cannot directly call <code>extern</code> declarations</p>



<a name="281971146"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/creating%20my%20own%20programming%20language%20in%20Lean/near/281971146" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/creating.20my.20own.20programming.20language.20in.20Lean.html#281971146">(May 11 2022 at 14:11)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I just want to point out that <a href="#narrow/stream/270676-lean4/topic/PrettyPrinter/near/265959260">this</a> still happens with yesterday's nightly build</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>