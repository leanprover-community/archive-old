---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/building.20multiple.20binaries.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html">building multiple binaries</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="282292852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/282292852" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#282292852">(May 13 2022 at 19:14)</a>:</h4>
<p>Has anyone else felt the need for Lake to be able to compile multiple binaries? If so, are there plans to make it possible?</p>
<p><a href="https://en.wikipedia.org/wiki/XY_problem">#xy</a>: I'm thinking about how to setup a proper testing infrastructure for a Lake project using something like <a href="https://hspec.github.io/">https://hspec.github.io/</a>. I would like to have the tests running in a way that an error can return 1 to the OS.</p>
<p>I have somewhat done it using a Lake script. However, the Lake script looks like a solution particular to a certain repository rather than something that can be extensively used by other libraries. Hence my idea about allowing Lake to build multiple binaries, such that one would be able to build the main binary <em>and</em> the testing binary.</p>
<p>Thanks in advance!</p>



<a name="282295057"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/282295057" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#282295057">(May 13 2022 at 19:36)</a>:</h4>
<p>I also tried running a Lean file with <code>lean --run tests.lean</code>, which has a <code>main : List String → IO UInt32</code> function. But I'm getting a lot of errors like <code>unknown constant sorryAx</code>, even though I added the line <code>Lean.initSearchPath $ ← Lean.findSysroot</code> in my function. Maybe it's missing the definition of <code>LEAN_PATH</code> in my environment, but at this point I think it could be smoother with support from Lake <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>
<p>There's also the fact that I would prefer running the tests with the compiled binary instead of the interpreted code. Not only because of execution speed, but also because in production we would have compiled code running anyway</p>



<a name="282297247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/282297247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#282297247">(May 13 2022 at 19:56)</a>:</h4>
<p>I will read the question more carefully later, but maybe you are missing <code>lake env lean --run ...</code></p>



<a name="282321564"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/282321564" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#282321564">(May 14 2022 at 00:12)</a>:</h4>
<p>I think I can get away with a custom compilation command (similar to what <code>lake build</code> does).</p>
<p>If this is an welcome addition, I might try adding an extra attribute to the Lake package config on a fork:<br>
<code>moreBinTargets : List (String x String)</code>, that is, a list of pairs of Lean file names and binary file names</p>



<a name="282351694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/282351694" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#282351694">(May 14 2022 at 12:55)</a>:</h4>
<p>I would definitely like the ability to build multiple binaries. Exactly the same use case, for running tests. Currently I have a custom lake script executing <code>lean --run ...</code> command</p>
<p>Also the ability to build multiple shared libraries would be nice. That would be useful for my Lean as a scripting language project.</p>



<a name="282375395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/282375395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#282375395">(May 14 2022 at 22:25)</a>:</h4>
<p>I was able to make a setup that works (and is not too ugly). The idea is to build a binary for each Lean file in the <a href="https://github.com/yatima-inc/yatima-lang/tree/8ececbb8403924178fa744f5d1655fbacf4e17d0/Tests"><code>Tests</code></a> directory.</p>
<p>I simply tried to mimic the last steps of <code>lake build</code>. It's done in <a href="https://github.com/yatima-inc/yatima-lang/blob/8ececbb8403924178fa744f5d1655fbacf4e17d0/lakefile.lean#L36">this Lake script</a>.</p>
<p><span class="user-mention" data-user-id="346070">@Tomas Skrivan</span> you should be able to adapt this approach to your needs <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="282408139"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/282408139" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#282408139">(May 15 2022 at 12:51)</a>:</h4>
<p>as a more general thought: Maybe we could have Lake include scripts as dependencies? So not only have dependencies that provide Lean code but also ones that provide Lake scripts, this way one could e.g. host a general purpose <code>lake-test</code> repo and people could declare it as a <code>script-dependency</code> or w/e and just use it so we can avoid copying around such scripts from the beginning.</p>



<a name="282428469"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/282428469" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#282428469">(May 15 2022 at 20:53)</a>:</h4>
<p>Fyi, building multiple binaries / libraries is on the TODO list and I will be back to working heavily on Lake starting  tomorrow.</p>



<a name="285788859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285788859" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285788859">(Jun 11 2022 at 17:12)</a>:</h4>
<p>Good news! A new version of Lake  (v3.1.1) landed in last night's nightly and the big new feature is support for multiple libraries and binaries! (I thought I had missed the deadline and it would be in tonight's nightly, hence why I am a little late with this announcement. ) The full changelog can be found in Lake's <a href="https://github.com/leanprover/lake/releases/tag/v3.1.0">v3.1.0 release notes</a> (<a href="https://github.com/leanprover/lake/releases/tag/v3.1.1">v3.1.1</a> is a hotfix to solve an issue I discovered only after releasing v3.1.0). Detailed documentation on how to use the new Lake  can be found in the <a href="https://github.com/leanprover/lake/blob/v3.1.1/README.md">README</a>. However, I'll give a brief description of how to use the new multi-target feature here.</p>
<p>There are currently three target types: Lean libraries (a collection modules available to import that can be also be built into a static and/or shared library), Lean binary executables (a module with a <code>main</code> function), and external libraries (replacing <code>moreLibTargets</code>). Each comes with a new DSL command to define the target. Examples:</p>
<p><strong>Lean Library</strong></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">lean_lib</span> <span class="n">foo</span> <span class="o">{</span>
  <span class="n">roots</span> <span class="o">:=</span> <span class="bp">-</span> <span class="bp">...</span>
  <span class="n">globs</span> <span class="o">:=</span> <span class="bp">-</span> <span class="bp">...</span>
  <span class="n">libName</span> <span class="o">:=</span> <span class="bp">-</span> <span class="bp">...</span>
  <span class="n">moreLinkArgs</span> <span class="o">:=</span> <span class="bp">-</span> <span class="bp">...</span>
<span class="o">}</span>
</code></pre></div>
<p><strong>Binary Executable</strong></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">lean_exe</span> <span class="n">foo</span> <span class="o">{</span>
  <span class="n">root</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">Main</span>
  <span class="n">supportInterpreter</span> <span class="o">:=</span> <span class="n">true</span>
  <span class="n">moreLinkArgs</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[]</span>
<span class="o">}</span>
</code></pre></div>
<p><strong>External Library</strong></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">extern_lib</span> <span class="n">foo</span> <span class="o">:=</span>
  <span class="n">staticLibTarget</span> <span class="n">fooFile</span> <span class="bp">#</span><span class="o">{</span><span class="n">mainOFile</span><span class="o">]</span> <span class="c1">-- i.e., any `FileTarget`</span>
</code></pre></div>
<p>Defined targets can be built on the CLI using <code>lake build foo</code> or marked with the <code>@[defaultTarget]</code> attribute to build them on a bare <code>lake build</code>.  Hopefully that all makes sense and the transition is to the new style is not too painful (and Ithere are no bugs in Lake). Good luck!</p>
<p><strong>P.S.</strong> This new release of Lake has a number of other changes (including new syntax for specifying dependencies), so make sure you do take a look at the <a href="https://github.com/leanprover/lake/releases/tag/v3.1.0">release notes</a>. However, those changes are outside the scope of this thread, so I will not got into detail on them here now.</p>



<a name="285789313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285789313" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285789313">(Jun 11 2022 at 17:22)</a>:</h4>
<p>Can I ask why the transition from using Lean arrays to a custom DSL for specifying package dependencies? Does it enable new features? I must say I liked when the specification was "just" a Lean array, as opposed to a DSL whose semantics are not immediately clear. As you note, this might cause problems for linking dependencies in a particular order. (Overall the package manager seems to be moving in a good direction with lockfiles and such, so thank you for your work on it <span class="user-mention" data-user-id="315577">@Mac</span> ! I only have the one DSL-complaint here.)</p>



<a name="285790171"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285790171" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285790171">(Jun 11 2022 at 17:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/285789313">said</a>:</p>
<blockquote>
<p>Can I ask why the transition from using Lean arrays to a custom DSL for specifying package dependencies? </p>
</blockquote>
<p>I find DSLs appropriate for Lake for a few reasons: (1) it allows for more modularity (everything does not have declared before / within the package, things can be interleaved); (2) it hides Lake's internal representation of the configuration from the user, allowing it to be changed without breaking user code (which makes adding features and maintaining backwards compatibility easier); (3) it is consistent with Lean core's design (i.e., <code>syntax</code>, <code>macro</code>, <code>elab</code>, <code>initalize</code>, etc.).</p>
<p>Point (2) is especially important. With sufficiently expressive DSLs, the internal representation can be completely hidden (making a lot of refactors that would be otherwise breaking, capable of being made non-breaking). Furthermore, for breaking syntax changes (such as a language overhaul), a new DSL namespace could be created (e.g., <code>DSLv2</code>) allow users to opt into the new syntax. In contrast, direct interaction with the internal representation makes almost all changes breaking changes (as this update demonstrates with its many would-be breaking changes).</p>
<p>For the package dependency DSL, in particular, it can allow the eventually (possible) feature of resolving dependencies during lakefile elaboration and/or potentially enabling special syntax for referencing sub-targets of declared dependencies. It also is much terser, which I consider a major positive (I also think it is easier to read).</p>



<a name="285790277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285790277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285790277">(Jun 11 2022 at 17:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/285789313">said</a>:</p>
<blockquote>
<p>As you note, this might cause problems for linking dependencies in a particular order.</p>
</blockquote>
<p>I do have plan to resolve this: new syntax (<code>extern_lib foo requires bar, baz</code>) and a topological sort of requirements. I just haven't included it here because I wanted to get this update out and I don't think that the current caveat is likely to effect many. Note the array solution still had ordering problems if some sorting need to be done with external libraries of downstream dependencies.</p>



<a name="285791243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285791243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285791243">(Jun 11 2022 at 18:12)</a>:</h4>
<p>Hm, but the hiding of internal representation and custom syntax are orthogonal concerns, no? For example, there could be a stable structure <code>PackageConfig</code> that users declare which you then translate into a <code>PackageConfigInternal</code>. The <code>Internal</code> variant can be changed without affecting <code>PackageConfig</code>. So it seems like that all can be achieved without much DSL, and the real concern that is addressed by it is (1). Having separate commands for separate targets seems like a pretty good idea, e.g. <a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html">Cargo</a> does it. Anyway, I see you have your reasons so I am not really suggesting a change, just trying to untangle which features help where.</p>



<a name="285791664"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285791664" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285791664">(Jun 11 2022 at 18:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/285791243">said</a>:</p>
<blockquote>
<p>For example, there could be a stable structure <code>PackageConfig</code> that users declare which you then translate into a <code>PackageConfigInternal</code>. The <code>Internal</code> variant can be changed without affecting <code>PackageConfig</code>.</p>
</blockquote>
<p>Yeah, maybe the word "internal" is misleading. What I meant by my concern was changes to the structure of the forward-facing <code>PackageConfig</code>. The structure of Lean object is very rigid, whereas syntax can be very flexible -- this makes it easier to avoid breaking changes. For example, just changing a field from type <code>Foo</code> to <code>Option Foo</code> can break compatibility in some cases. In contrast, with macros, both versions can be easily massaged into the same type.</p>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/285791243">said</a>:</p>
<blockquote>
<p>Anyway, I see you have your reasons so I am not really suggesting a change, just trying to untangle which features help where.</p>
</blockquote>
<p>Don't worry, I don't mind the questions. Thinking through these things is quite valuable. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="285839301"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285839301" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285839301">(Jun 12 2022 at 12:21)</a>:</h4>
<p>If there are multiple packages, can a compiled version of one be easily used in another, the way <code>Main.lean</code> uses compiled version of the other files?</p>



<a name="285846392"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285846392" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285846392">(Jun 12 2022 at 14:48)</a>:</h4>
<p><span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span> I am not sure what you mean? Could you elaborate further on what you mean?</p>



<a name="285846528"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285846528" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285846528">(Jun 12 2022 at 14:52)</a>:</h4>
<p>I mean that at present if I want to run something compiled instead of in the interpreter, I run it in the <code>Main</code> after <code>lake build</code>. In the case of multiple projects, is there some way that code from one project can similarly be used in compiled form in another project, even in the interpreter.</p>



<a name="285846757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285846757" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285846757">(Jun 12 2022 at 14:57)</a>:</h4>
<p><span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span> I am really sorry, but that still doesn't make sense to me. Why would running things in<code>Main.lean</code> have any impact on whether things are compiled or interpreted? Do you instead mean in the <code>main</code>  function and then running the executable?</p>



<a name="285847262"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285847262" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285847262">(Jun 12 2022 at 15:08)</a>:</h4>
<p>Yes. I mean that.</p>



<a name="285847275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285847275" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285847275">(Jun 12 2022 at 15:09)</a>:</h4>
<p>I mean is there a reasonably easy way to make one project use the executable form of another project.</p>



<a name="285848498"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285848498" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285848498">(Jun 12 2022 at 15:41)</a>:</h4>
<p>Is the idea that you have a package <code>A</code> which could be compiled by <code>leanc</code> into <code>libA.so</code>, and then you have a package <code>B</code> importing <code>A</code>, and you would like the interpreter on <code>B</code>'s files to use the compiled code in <code>libA.so</code>? That sounds a bit like <a href="https://github.com/leanprover/lake/pull/47">leanprover/lake#47</a> which seems on hold, however.</p>



<a name="285848541"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285848541" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285848541">(Jun 12 2022 at 15:42)</a>:</h4>
<p>Or do you mean that <code>A</code> is an executable with a <code>def main</code> that gets compiled to an <code>A.exe</code> (or whatever), and you would like to run that using <code>IO.Process</code> in <code>B</code>'s <code>main</code>?</p>



<a name="285848795"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285848795" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285848795">(Jun 12 2022 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/285848498">said</a>:</p>
<blockquote>
<p>Is the idea that you have a package <code>A</code> which could be compiled by <code>leanc</code> into <code>libA.so</code>, and then you have a package <code>B</code> importing <code>A</code>, and you would like the interpreter on <code>B</code>'s files to use the compiled code in <code>libA.so</code>? That sounds a bit like <a href="https://github.com/leanprover/lake/pull/47">leanprover/lake#47</a> which seems on hold, however.</p>
</blockquote>
<p>Yes indeed I mean this. For example one package may have a tactic which I want to use in the other.</p>



<a name="285853635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285853635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285853635">(Jun 12 2022 at 17:46)</a>:</h4>
<p><span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span> In that case, you should be happy to know that  my primary goal for this coming week is to support precompiling modules (i.e., <a href="https://github.com/leanprover/lake/pull/47">leanprover/lake#47</a>).</p>



<a name="285854757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285854757" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> z battleman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285854757">(Jun 12 2022 at 18:14)</a>:</h4>
<p>This is kind of vaguely related so I thought I would ask here. Is it possible to point a lakefile to multiple c files? Basically, I want to Lean files each which points to its own c file that it interacts with over the FFI. Is such a thing possible?</p>



<a name="285870392"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285870392" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285870392">(Jun 13 2022 at 00:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/285853635">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="266304">Siddhartha Gadgil</span> In that case, you should be happy to know that  my primary goal for this coming week is to support precompiling modules (i.e., <a href="https://github.com/leanprover/lake/pull/47">leanprover/lake#47</a>).</p>
</blockquote>
<p>Indeed that is wonderful news.</p>



<a name="285950763"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285950763" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285950763">(Jun 13 2022 at 16:01)</a>:</h4>
<p><span class="user-mention" data-user-id="315577">@Mac</span> I have more questions :) Why the move away from functional package parameters like <code>(args)</code> to global variables?</p>



<a name="285952860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285952860" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285952860">(Jun 13 2022 at 16:15)</a>:</h4>
<p>And one more. Previously we specified explicitly which libraries to link in with <code>moreLibTargets</code>. In the new version, are the <code>extern_lib</code>s linked into every <code>lean_lib</code> and <code>lean_exe</code>? Is it possible to specify which libraries to link per-target?</p>



<a name="285953121"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285953121" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285953121">(Jun 13 2022 at 16:17)</a>:</h4>
<p>In a similar vein, should <code>require</code> really be global (per workspace) instead of being scoped to libraries? For example, there might be a separate library containing all tests, which alone should depend on a test framework.</p>



<a name="285962616"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285962616" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285962616">(Jun 13 2022 at 17:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/285950763">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> Why the move away from functional package parameters like <code>(args)</code> to global variables?</p>
</blockquote>
<p>As mentioned in the <a href="https://github.com/leanprover/lake/releases/tag/v3.1.0">release notes</a>, making it a global macro makes it easier to use across targets. I think adding parameters to every target would be annoying.</p>



<a name="285963470"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/285963470" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#285963470">(Jun 13 2022 at 17:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/285952860">said</a>:</p>
<blockquote>
<p>And one more. Previously we specified explicitly which libraries to link in with <code>moreLibTargets</code>. In the new version, are the <code>extern_lib</code>s linked into every <code>lean_lib</code> and <code>lean_exe</code>? Is it possible to specify which libraries to link per-target?</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/285953121">said</a>:</p>
<blockquote>
<p>In a similar vein, should <code>require</code> really be global (per workspace) instead of being scoped to libraries? For example, there might be a separate library containing all tests, which alone should depend on a test framework.</p>
</blockquote>
<p>Yes, as with the original <code>moreLibTargets</code> and <code>dependencies</code>, every <code>extern_lib</code> and <code>require</code> is applied globally. However, scoping them locally to a given target is a future planned feature.</p>



<a name="286014016"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/286014016" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#286014016">(Jun 14 2022 at 02:43)</a>:</h4>
<blockquote>
<p>Yes, as with the original <code>moreLibTargets</code> and dependencies, every <code>extern_lib</code> and require is applied globally. However, scoping them locally to a given target is a future planned feature.</p>
</blockquote>
<p>This would be very useful. While on this topic, maybe it would make sense to commit to the separation entirely and make the compilation-related fields — <code>moreLeancArgs</code>/<code>moreLinkArgs</code>/<code>supportInterpreter</code>/etc — all per-target fields rather than parts of <code>PackageConfig</code> — it sounds like now the <code>package</code> has become more of a metadata statement about the source / build directory locations, and maybe in the future it will include author/website/version/etc, whereas the targets deal with compilation.</p>



<a name="286015687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/286015687" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#286015687">(Jun 14 2022 at 03:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/286014016">said</a>:</p>
<blockquote>
<blockquote>
<p>Yes, as with the original <code>moreLibTargets</code> and dependencies, every <code>extern_lib</code> and require is applied globally. However, scoping them locally to a given target is a future planned feature.</p>
</blockquote>
<p>This would be very useful. </p>
</blockquote>
<p>I can see how it could be eventually, but I am surprised you feel that strongly about it now. I don't really see many use cases for fine-grained dependency management at the moment. But maybe I am missing something obvious.</p>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/286014016">said</a>:</p>
<blockquote>
<p>While on this topic, maybe it would make sense to commit to the separation entirely and make the compilation-related fields — <code>moreLeancArgs</code>/<code>moreLinkArgs</code>/<code>supportInterpreter</code>/etc — all per-target fields rather than parts of <code>PackageConfig</code> — it sounds like now the <code>package</code> has become more of a metadata statement about the source / build directory locations, and maybe in the future it will include author/website/version/etc, whereas the targets deal with compilation.</p>
</blockquote>
<p>Part of this is already done: <code>moreLinkArgs</code> and <code>supportInterpreter</code> have already been moved to targets.  I did not move <code>moreLeancArgs</code> and, most importantly, <code>moreLeanArgs</code> because  I was not sure if compiling Lean modules with different options in same library was entirely safe (i.e., whether it could lead to potential incompatibilities between them).  Also, if all (or multiple) targets share the same options it could be annoying to copy them to each one. One solution I am considering is to have both a package-wide field and a per target field and then combine the two when building.</p>



<a name="286017109"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/286017109" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#286017109">(Jun 14 2022 at 03:40)</a>:</h4>
<blockquote>
<p>I don't really see many use cases for fine-grained dependency management at the moment.</p>
</blockquote>
<p>For example, you may want to compile with two different implementations of a numerical library. However, it doesn't seem like I need this feature for anything at the moment, so you are right, the "very useful" was exaggerated :)</p>



<a name="286032939"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/286032939" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#286032939">(Jun 14 2022 at 07:40)</a>:</h4>
<blockquote>
<p>I was not sure if compiling Lean modules with different options in same library was entirely safe</p>
</blockquote>
<p>No less than doing so in different libraries, I believe <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="286034426"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/286034426" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#286034426">(Jun 14 2022 at 07:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/286032939">said</a>:</p>
<blockquote>
<p>No less than doing so in different libraries, I believe <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>
</blockquote>
<p>Yeah, I was also thinking about that. Is it a problem? I could move the options from being package-wide to workspace-wide and thus avoid any possibility of incompatibility. I just don't know enough about the risks to know which direction would be better to take. That is, should I move towards target-local scoping of options or move towards workspace-global scoping?</p>



<a name="286035316"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/286035316" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#286035316">(Jun 14 2022 at 08:05)</a>:</h4>
<p>Does workspace-global include remote dependencies?</p>



<a name="286035667"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/286035667" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#286035667">(Jun 14 2022 at 08:09)</a>:</h4>
<p>I can't think of any unsafe options other than some <code>#define</code>s that break the ABI, and in that case you're already in trouble with compatibility with the stdlib. So I don't think this is a big concern right now.</p>



<a name="286035942"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/286035942" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#286035942">(Jun 14 2022 at 08:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/286035316">said</a>:</p>
<blockquote>
<p>Does workspace-global include remote dependencies?</p>
</blockquote>
<p>Yes it does.</p>



<a name="286036102"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/286036102" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#286036102">(Jun 14 2022 at 08:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/286035667">said</a>:</p>
<blockquote>
<p>I can't think of any unsafe options other than some <code>#define</code>s that break the ABI, and in that case you're already in trouble with compatibility with the stdlib. So I don't think this is a big concern right now.</p>
</blockquote>
<p>So are you saying that target-local flags should likely be fine both for <code>leanc</code> and <code>lean</code>?</p>



<a name="286036304"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/286036304" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#286036304">(Jun 14 2022 at 08:16)</a>:</h4>
<p>Yes. Though there certainly are options that are <em>desirable</em> to be passed upstream, such as a debug compile profile.</p>



<a name="293094806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293094806" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293094806">(Aug 12 2022 at 12:06)</a>:</h4>
<p>What would be the best way to generate one binary per file in a certain directory? Should I write a command elaboration that would crawl that directory and generate bunch of <code>lean_exe</code> commands?</p>



<a name="293098625"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293098625" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293098625">(Aug 12 2022 at 12:28)</a>:</h4>
<p>We are kind of doing it in LSpec: <a href="https://github.com/yatima-inc/LSpec#setting-up-a-testing-infra">https://github.com/yatima-inc/LSpec#setting-up-a-testing-infra</a><br>
But it expects the user to edit the lakefile accordingly</p>



<a name="293099431"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293099431" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293099431">(Aug 12 2022 at 12:33)</a>:</h4>
<p>Yeah I do not want to edit lakefile manually.</p>



<a name="293100324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293100324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293100324">(Aug 12 2022 at 12:39)</a>:</h4>
<p>I thought about empowering LSpec to be able to make editions on the lakefile for the user but turns out the editions may not be trivial, as shown in this example: <a href="https://github.com/yatima-inc/yatima-lang/blob/main/lakefile.lean#L36-L40">https://github.com/yatima-inc/yatima-lang/blob/main/lakefile.lean#L36-L40</a></p>



<a name="293100580"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293100580" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293100580">(Aug 12 2022 at 12:40)</a>:</h4>
<p>The non-trivial part is that you need to turn on interpreter?</p>



<a name="293101494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293101494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293101494">(Aug 12 2022 at 12:46)</a>:</h4>
<p>That's one example, but who knows what it might take to run some crazy tests some users may create. For example, one might want to test some FFI implementation with highly specific build parameters. And that's not even an unlikely scenario</p>



<a name="293102073"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293102073" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293102073">(Aug 12 2022 at 12:50)</a>:</h4>
<p>My use case it for scripting in Houdini. Every script should create a new library so they should be all the same from the build perspective.</p>



<a name="293102730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293102730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293102730">(Aug 12 2022 at 12:54)</a>:</h4>
<p>Here's a crazy hack: make a Lake script that edits the lakefile itself, generating the <code>lean_exe</code> lines for you</p>



<a name="293102911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293102911" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293102911">(Aug 12 2022 at 12:55)</a>:</h4>
<p>Just gotta be careful not to add the same line twice</p>



<a name="293103544"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293103544" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293103544">(Aug 12 2022 at 12:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/293102730">said</a>:</p>
<blockquote>
<p>Here's a crazy hack: make a Lake script that edits the lakefile itself, generating the <code>lean_exe</code> lines for you</p>
</blockquote>
<p>Before I attempt doing that I will keep on browsing through the meta-programming book and hopefully figure something else out :)</p>



<a name="293108337"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293108337" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293108337">(Aug 12 2022 at 13:25)</a>:</h4>
<p>When I add this to my lakefile</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"#lean_exe_generate"</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="n">elabCommand</span> <span class="o">(</span><span class="bp">←</span> <span class="bp">`</span><span class="o">(</span><span class="n">lean_exe</span> <span class="n">Main1</span><span class="o">))</span>
  <span class="n">elabCommand</span> <span class="o">(</span><span class="bp">←</span> <span class="bp">`</span><span class="o">(</span><span class="n">lean_exe</span> <span class="n">Main2</span><span class="o">))</span>

<span class="bp">#</span><span class="n">lean_exe_generate</span>
</code></pre></div>
<p>and run <code>lake build Main1</code> I get an error <code>error: unknown target 'Main' </code></p>
<p>Why is that happening?</p>



<a name="293110775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293110775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293110775">(Aug 12 2022 at 13:38)</a>:</h4>
<p>Dunno, but ctrl-clicking on <code>lean_exe</code> and trying to mimic that (instead of calling <code>lean_exe</code>) might take you further</p>



<a name="293112777"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293112777" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293112777">(Aug 12 2022 at 13:51)</a>:</h4>
<p>Interesting, changing to </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"#lean_exe_generate"</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="n">elabCommand</span> <span class="o">(</span><span class="bp">←</span> <span class="bp">`</span><span class="o">(</span><span class="kd">@[leanExe]</span>  <span class="kd">def</span> <span class="n">Main1</span> <span class="o">:</span> <span class="n">Lake.LeanExeConfig</span> <span class="o">:=</span>  <span class="o">{</span> <span class="n">name</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">Main1</span><span class="o">}</span> <span class="o">))</span>
  <span class="n">elabCommand</span> <span class="o">(</span><span class="bp">←</span> <span class="bp">`</span><span class="o">(</span><span class="kd">@[leanExe]</span>  <span class="kd">def</span> <span class="n">Main2</span> <span class="o">:</span> <span class="n">Lake.LeanExeConfig</span> <span class="o">:=</span>  <span class="o">{</span> <span class="n">name</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">Main2</span><span class="o">}</span> <span class="o">))</span>
</code></pre></div>
<p>now I get <code>Building Main1</code> and oleans are created but I'm not getting <code>Compling Main1</code> and <code>Linking Main1</code></p>



<a name="293199623"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293199623" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293199623">(Aug 12 2022 at 21:57)</a>:</h4>
<p>Please let me know if you succeed <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="293211690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293211690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293211690">(Aug 13 2022 at 00:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="346070">Tomas Skrivan</span> <a href="#narrow/stream/270676-lean4/topic/building.20multiple.20binaries/near/293108337">said</a>:</p>
<blockquote>
<p>When I add this to my lakefile</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"#lean_exe_generate"</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="n">elabCommand</span> <span class="o">(</span><span class="bp">←</span> <span class="bp">`</span><span class="o">(</span><span class="n">lean_exe</span> <span class="n">Main1</span><span class="o">))</span>
  <span class="n">elabCommand</span> <span class="o">(</span><span class="bp">←</span> <span class="bp">`</span><span class="o">(</span><span class="n">lean_exe</span> <span class="n">Main2</span><span class="o">))</span>

<span class="bp">#</span><span class="n">lean_exe_generate</span>
</code></pre></div>
<p>and run <code>lake build Main1</code> I get an error <code>error: unknown target 'Main' </code></p>
<p>Why is that happening?</p>
</blockquote>
<p>Hygiene. Lean will transform the <code>Main1</code>/<code>Main2</code> into some cryptic hygienic identifier. If you want to use raw identifiers either use <code>$(mkIdent `Main1)</code> to create an unhygienic identifier manually or turn hygiene off with <code>set_option hygiene false</code>.</p>



<a name="293211742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293211742" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293211742">(Aug 13 2022 at 00:11)</a>:</h4>
<p>Note that you can also run <code>CommandElabM</code> directly now via <code>#eval</code>, so you may not even need to create the custom syntax.</p>



<a name="293725161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293725161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293725161">(Aug 16 2022 at 14:08)</a>:</h4>
<p>Great! got it working. This code in lakefile creates one executable for each file <code>Tests/*.lean</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">lean_exe_generate</span> <span class="o">:</span> <span class="n">CommandElabM</span> <span class="n">Unit</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">dirName</span> <span class="o">:=</span> <span class="s2">"Tests"</span>
  <span class="k">let</span> <span class="n">dir</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">←</span> <span class="n">IO.currentDir</span><span class="o">)</span> <span class="bp">/</span> <span class="n">dirName</span>
  <span class="n">for</span> <span class="n">file</span> <span class="k">in</span> <span class="bp">←</span> <span class="n">dir.readDir</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">file.path.extension</span> <span class="bp">=</span> <span class="s2">"lean"</span> <span class="k">then</span>
      <span class="k">let</span> <span class="n">name</span> <span class="o">:=</span> <span class="n">mkIdent</span> <span class="n">file.path.fileStem.get</span><span class="bp">!</span>
      <span class="k">let</span> <span class="n">root</span> <span class="o">:=</span> <span class="n">Syntax.mkStrLit</span> <span class="o">(</span><span class="n">dirName</span> <span class="bp">++</span> <span class="s2">"/"</span> <span class="bp">++</span> <span class="n">file.path.fileStem.get</span><span class="bp">!</span><span class="o">)</span>
      <span class="n">elabCommand</span> <span class="o">(</span><span class="bp">←</span> <span class="bp">`</span><span class="o">(</span><span class="n">lean_exe</span> <span class="bp">$</span><span class="n">name</span> <span class="o">{</span> <span class="n">root</span> <span class="o">:=</span> <span class="bp">$</span><span class="n">root</span> <span class="o">}))</span>

<span class="k">#eval</span> <span class="n">lean_exe_generate</span>
</code></pre></div>



<a name="293727610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293727610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293727610">(Aug 16 2022 at 14:22)</a>:</h4>
<p>This looks nice! I might incorporate this trick in the LSpec README someday. But it would also need a way to recursively search directories (not a big issue)</p>



<a name="293729087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/building%20multiple%20binaries/near/293729087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/building.20multiple.20binaries.html#293729087">(Aug 16 2022 at 14:29)</a>:</h4>
<p>It's easily doable with <a href="https://github.com/yatima-inc/LSpec/blob/main/Main.lean#L3-L15">this function</a>, which only God knows how many times I've copied throughout several repos</p>
<p>Offtopic: would it be worth PR'ing this function to the <code>System</code> API? I have replicated it too many times already. It can of course be generalized to accept a custom extension instead of being fixed on "lean".<br>
Would any maintainer endorse it?</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>