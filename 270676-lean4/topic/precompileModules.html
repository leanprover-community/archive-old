---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/precompileModules.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html">precompileModules</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="288506811"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/288506811" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#288506811">(Jul 05 2022 at 10:20)</a>:</h4>
<p>I just tried to enable Lake's new <code>precompileModules</code> option for Aesop. It seems to work in principle (yay!) and makes things noticably faster (big yay!), but I encountered some issues. Repro branch: <a href="https://github.com/JLimperg/aesop/tree/precompileModules">https://github.com/JLimperg/aesop/tree/precompileModules</a></p>
<p>(1) When I load an Aesop module in VSCode or Emacs, I get errors like</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>error loading library, Aesop-Builder-Default: cannot open shared object file: No such file or directory
</code></pre></div>
<p>(2) When I open a test file (which depends on Aesop) in VSCode or Emacs, I get errors like</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>`/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/lake print-paths Init Aesop` failed:

stderr:
info: &gt; /home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/leanc -c -o ./build/ir/Aesop.o ./build/ir/Aesop.c -O3 -DNDEBUG
error: stderr:
In file included from ./build/ir/Aesop.c:4:
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/include/lean/lean.h:8:10: fatal error: 'stddef.h' file not found
#include &lt;stddef.h&gt;
         ^~~~~~~~~~
1 error generated.
error: external command /home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/leanc exited with status 1
error: build failed
</code></pre></div>
<p>(3) When I run <code>lake clean &amp;&amp; lake build</code>, I get errors like this:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>&gt; LEAN_PATH=./build/lib LD_LIBRARY_PATH=/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/lib:./build/lib /home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/lean ./././Aesop.lean -R ././. -o ./build/lib/Aesop.olean -i ./build/lib/Aesop.ilean -c ./build/ir/Aesop.c --load-dynlib=libAesop-Check.so --load-dynlib=libAesop-Nanos.so --load-dynlib=libAesop-Util-UnionFind.so --load-dynlib=libAesop-Util-Basic.so --load-dynlib=libAesop-Util-UnorderedArraySet.so --load-dynlib=libAesop-Util.so --load-dynlib=libAesop-Frontend-ElabM.so --load-dynlib=libAesop-Percent.so --load-dynlib=libAesop-Rule-Name.so --load-dynlib=libAesop-Index-Basic.so --load-dynlib=libAesop-Index.so --load-dynlib=libAesop-Rule-BranchState.so --load-dynlib=libAesop-RuleTac-Basic.so --load-dynlib=libAesop-Rule-Basic.so --load-dynlib=libAesop-Rule.so --load-dynlib=libAesop-Builder-Basic.so --load-dynlib=libAesop-Builder-Apply.so --load-dynlib=libAesop-RuleTac-Cases.so --load-dynlib=libAesop-Builder-Cases.so --load-dynlib=libAesop-Builder-Constructors.so --load-dynlib=libAesop-Builder-NormSimp.so --load-dynlib=libAesop-Builder-Tactic.so --load-dynlib=libAesop-Builder-Default.so --load-dynlib=libAesop-Builder-Forward.so --load-dynlib=libAesop-Builder.so --load-dynlib=libAesop-RuleSet.so --load-dynlib=libAesop-Frontend-RuleExpr.so --load-dynlib=libAesop-Frontend-Attribute.so --load-dynlib=libAesop-Options.so --load-dynlib=libAesop-RuleTac-Apply.so --load-dynlib=libAesop-RuleTac-Forward.so --load-dynlib=libAesop-RuleTac-Tactic.so --load-dynlib=libAesop-RuleTac.so --load-dynlib=libAesop-Search-Expansion-Simp-Basic.so --load-dynlib=libAesop-Search-Expansion-Simp-SimpAll.so --load-dynlib=libAesop-Search-Expansion-Simp-SimpGoal.so --load-dynlib=libAesop-Search-Expansion-Simp.so --load-dynlib=libAesop-Tracing-Init.so --load-dynlib=libAesop-Tracing.so --load-dynlib=libAesop-Constants.so --load-dynlib=libAesop-Tree-BranchState.so --load-dynlib=libAesop-Tree-UnsafeQueue.so --load-dynlib=libAesop-Tree-Data.so --load-dynlib=libAesop-Tree-Traversal.so --load-dynlib=libAesop-Tree-RunMetaM.so --load-dynlib=libAesop-Tree-TreeM.so --load-dynlib=libAesop-Tree-AddRapp.so --load-dynlib=libAesop-Tree-State.so --load-dynlib=libAesop-Tree-Check.so --load-dynlib=libAesop-Tree-Format.so --load-dynlib=libAesop-Tree-ExtractProof.so --load-dynlib=libAesop-Tree-ExtractSafePrefixes.so --load-dynlib=libAesop-Tree-Free.so --load-dynlib=libAesop-Tree.so --load-dynlib=libAesop-Search-Queue.so --load-dynlib=libAesop-Profiling.so --load-dynlib=libAesop-Search-SearchM.so --load-dynlib=libAesop-Search-RuleSelection.so --load-dynlib=libAesop-Search-Expansion.so --load-dynlib=libAesop-Search-Main.so --load-dynlib=libAesop-Frontend-Command.so --load-dynlib=libAesop-Frontend-Tactic.so --load-dynlib=libAesop-Frontend.so --load-dynlib=libAesop-BuiltinRules-Assumption.so --load-dynlib=libAesop-BuiltinRules-ApplyHyps.so --load-dynlib=libAesop-BuiltinRules-DestructProducts.so --load-dynlib=libAesop-BuiltinRules-Intros.so --load-dynlib=libAesop-BuiltinRules-Split.so --load-dynlib=libAesop-BuiltinRules-Subst.so --load-dynlib=libAesop-BuiltinRules.so --load-dynlib=libAesop-Main.so
stderr:
Error: index out of bounds
backtrace:
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_panic_fn+0x9e)[0x7f0cb62e7f4e]
./build/lib/libAesop-Frontend-RuleExpr.so(initialize_Aesop_Frontend_RuleExpr+0x36e3)[0x7f0cb28cae93]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_run_mod_init+0x28)[0x7f0cb62db208]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Array_forInUnsafe_loop___at_Lean_registerInitAttrUnsafe___spec__14+0x190)[0x7f0cb5d98ea0]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Lean_registerInitAttrUnsafe___lambda__3+0xce)[0x7f0cb5d9a75e]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Lean_registerInitAttrUnsafe___lambda__3___boxed+0x3a)[0x7f0cb5d9aada]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_apply_3+0x628)[0x7f0cb62f4738]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Lean_registerParametricAttribute___rarg___lambda__1+0x5b)[0x7f0cb5f5c00b]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_apply_3+0x666)[0x7f0cb62f4776]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l___private_Lean_Environment_0__Lean_finalizePersistentExtensions_loop+0x8bd)[0x7f0cb505594d]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Lean_importModules___lambda__3+0x818)[0x7f0cb505c918]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_apply_2+0x382)[0x7f0cb62f3342]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_apply_1+0x16a)[0x7f0cb62f24ea]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Lean_withImporting___rarg+0x62)[0x7f0cb516f3c2]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Lean_importModules___lambda__4___boxed+0x3d)[0x7f0cb505d19d]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_apply_2+0x382)[0x7f0cb62f3342]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_apply_1+0x16a)[0x7f0cb62f24ea]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Lean_profileitIOUnsafe___rarg___lambda__1+0xe)[0x7f0cb51e40fe]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Lean_profileitIOUnsafe___rarg___lambda__1___boxed+0xc)[0x7f0cb51e430c]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_apply_1+0x156)[0x7f0cb62f24d6]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_profileit+0x63)[0x7f0cb623bbe3]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Lean_profileitIOUnsafe___rarg+0x54)[0x7f0cb51e4224]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_import_modules+0x103)[0x7f0cb505d003]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(l_Lean_Elab_processHeader+0x35)[0x7f0cb45db045]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_run_frontend+0x294)[0x7f0cb4d6abf4]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(+0x2b50c5f)[0x7f0cb61d5c5f]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/../lib/lean/libleanshared.so(lean_main+0x1dbb)[0x7f0cb61d7d5b]
/lib64/libc.so.6(+0x2934a)[0x7f0cb348f34a]
/lib64/libc.so.6(__libc_start_main+0x7c)[0x7f0cb348f3fc]
/home/jannis/.elan/toolchains/leanprover--lean4---nightly-2022-07-04/bin/lean(_start+0x2e)[0x20180e]
</code></pre></div>
<p>However, these errors don't seem to be fatal: the build succeeds and I can still successfully run the test suite.</p>



<a name="288510356"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/288510356" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#288510356">(Jul 05 2022 at 10:56)</a>:</h4>
<p>The first two should be <a href="https://github.com/leanprover/lake/issues/93">https://github.com/leanprover/lake/issues/93</a>. I should probably look into the bounds panic, even if it is not fatal as you said. At least we have a stacktrace now.</p>



<a name="290924303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/290924303" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#290924303">(Jul 26 2022 at 17:02)</a>:</h4>
<p>Hi! I am working on a package with <code>precompileModules := true</code> in the lakefile, and I can see that <code>.so</code> files are being built. However <code>ps faux</code> on an example file just shows <code>/home/nawrocki/.elan/toolchains/leanprover--lean4---nightly-2022-07-14/bin/lean --worker file:///home/nawrocki/lean-smt/Test/BitVec/AES.lean</code>, i.e. no <code>--load-dynlib</code> or whatever options are passed to the worker. Is there a separate mechanism for loading them, or should that flag be there? This is on <code>nightly-2022-07-14</code>.</p>



<a name="290926661"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/290926661" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#290926661">(Jul 26 2022 at 17:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/precompileModules/near/290924303">said</a>:</p>
<blockquote>
<p>no <code>--load-dynlib</code> or whatever options are passed to the worker. Is there a separate mechanism for loading them</p>
</blockquote>
<p>Yep this is right, The worker, during its <code>lake print-paths</code> invocation gets back a list of dynlibs to load, which it then does -- no flags needed.</p>



<a name="290926973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/290926973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#290926973">(Jul 26 2022 at 17:23)</a>:</h4>
<p>Ah cool, thanks!</p>



<a name="291430348"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291430348" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291430348">(Jul 30 2022 at 13:59)</a>:</h4>
<p>More questions :D How do I load the precompiled modules into a command-line invocation of Lean? To get imports to work I usually write <code>lake env lean Foo.lean</code>, but on the command line this does not load the shared libraries even when <code>precompileModules := true</code> in the <code>lakefile</code>. I was caught unaware and wondering why something that was instant in the editor was so slow on the command line. So what magic invocation should I use? Obviously <code>lake env lean --load-dynlib=lib1.so --load-dynlib=lib2.so Foo.lean</code> manually is non-ideal</p>



<a name="291437269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291437269" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291437269">(Jul 30 2022 at 16:14)</a>:</h4>
<p><span class="user-mention" data-user-id="128280">@Wojciech Nawrocki</span> such a command does not yet exist. In my view, the best way to do this would be to support specifying Lean dynlibs/plugins through an environment variables (see <a href="#narrow/stream/147302-lean4-dev/topic/Lean.20command.20line.20size/near/289393949">my proposal</a>) -- i just haven't got around to this yet.</p>



<a name="291437358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291437358" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291437358">(Jul 30 2022 at 16:16)</a>:</h4>
<p>I am a little curious as to what you are using this for. Generally <code>lake env</code> is used to run custom executables that run their own frontend (and thus don't usually have their own <code>--load-dynlib</code>) options anyway.</p>



<a name="291437485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291437485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291437485">(Jul 30 2022 at 16:19)</a>:</h4>
<p>One more note: Even with environment variables, passing dynlibs through something like <code>lake env</code> would require a significant change in how it works. Currently, <code>lake env</code> does not build anything. However, Lake only knows what dynlibs their are after a build, so <code>lake env</code> would need to be augmented to build the whole package before executing the subcommand.</p>



<a name="291437557"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291437557" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291437557">(Jul 30 2022 at 16:20)</a>:</h4>
<p>(This should not be difficult to do, but it would be a notable change in behavior.)</p>



<a name="291440330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291440330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291440330">(Jul 30 2022 at 17:10)</a>:</h4>
<blockquote>
<p>I am a little curious as to what you are using this for. </p>
</blockquote>
<p>It's for running <code>.produced</code>/<code>.expected</code> style tests in CI, as in <a href="https://github.com/Vtec234/lean-smt/blob/485dc172e1284e6d9558368c03dc4c9e06b4c5da/lakefile.lean#L60">here</a>. Note that we shell out to a <code>lean</code> process (actually without <code>lake env</code> in this case, but in another repo I am running <code>lake env lean</code> towards the same end from a shell script).</p>



<a name="291440514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291440514" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291440514">(Jul 30 2022 at 17:14)</a>:</h4>
<p>I suppose running the frontend directly from the Lake script would not help either.</p>



<a name="291442924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291442924" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291442924">(Jul 30 2022 at 18:00)</a>:</h4>
<p><span class="user-mention" data-user-id="128280">@Wojciech Nawrocki</span> Some notes on that code (hopefully this is helpful):</p>
<ul>
<li>Scripts are run in <code>ScriptM</code>, not plain <code>IO</code>. This means you have access to Lake's computed <code>Workspace</code>. Thus, for example, you can do <code>let lean &lt;- getLean</code> to get the already detected Lean. rather than re-detecting it your self.</li>
<li>Since that script already assumes the tests requisite modules are built, you could just pass the dynlib from the module you want directly in the script (e.g., <code>(&lt;- findModule? &lt;mod-name&gt;).get!.dynlibFile</code> to get the file and  then pass <code>--load=dynlib={file}</code> to the lean invocation).</li>
<li>Also, for <code>LEAN_PATH</code>, you can use <code>&lt;- getAugmentedLeanPath</code> instead of computing it yourself.</li>
</ul>



<a name="291445467"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291445467" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291445467">(Jul 30 2022 at 18:58)</a>:</h4>
<p>Thanks for the tips! For the dynlibs though, I assume I would have to manually grab it for every module? Is there a quick way to do what Lake already does when invoking <code>lean</code> and get <em>all</em> the transitively required dynlibs?</p>



<a name="291446591"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291446591" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291446591">(Jul 30 2022 at 19:23)</a>:</h4>
<p>Note that there is no need for passing the transitive closure on Unix, the root .so is sufficient. But I suppose it would be preferable if your tests worked on Windows as well.</p>



<a name="291446835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291446835" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291446835">(Jul 30 2022 at 19:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/precompileModules/near/291445467">said</a>:</p>
<blockquote>
<p>Thanks for the tips! For the dynlibs though, I assume I would have to manually grab it for every module? Is there a quick way to do what Lake already does when invoking <code>lean</code> and get <em>all</em> the transitively required dynlibs?</p>
</blockquote>
<p><span class="user-mention" data-user-id="128280">@Wojciech Nawrocki</span> No, because things like external libraries dynlibs can only be determined after a build. If you want to do that you essentially need to invoke <a href="https://github.com/leanprover/lake/blob/dcf8e1fc406acfd4dbbfd691f4ecf76966fae407/Lake/Build/Imports.lean#L27-L57"><code>buildImportsAndDeps</code></a> like <code>print-paths</code> <a href="https://github.com/leanprover/lake/blob/dcf8e1fc406acfd4dbbfd691f4ecf76966fae407/Lake/CLI/Main.lean#L178-L179">does</a>.</p>



<a name="291447011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291447011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291447011">(Jul 30 2022 at 19:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/precompileModules/near/291446591">said</a>:</p>
<blockquote>
<p>Note that there is no need for passing the transitive closure on Unix, the root .so is sufficient. But I suppose it would be preferable if your tests worked on Windows as well.</p>
</blockquote>
<p>Indeed it looks like the shared libraries load their dependency <code>.so</code>s. However with just <code>precompileModules := true</code>, there <em>is no</em> root shared lib. As in, I get <code>libFoo-Mod1.so</code>, <code>libFoo-Mod2.so</code> etc but there is no <code>build/lib/libFoo.so</code>.</p>



<a name="291447065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291447065" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291447065">(Jul 30 2022 at 19:35)</a>:</h4>
<p>Since this is the case, I guess at least on Unix <code>lake build</code> does not in fact have to do this:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nv">LEAN_PATH</span><span class="o">=</span>./build/lib <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/home/nawrocki/.elan/toolchains/leanprover--lean4---nightly-2022-07-29/lib:./build/lib /home/nawrocki/.elan/toolchains/leanprover--lean4---nightly-2022-07-29/bin/lean ./././Smt/Tactic/Smt.lean -R ././. -o ./build/lib/Smt/Tactic/Smt.olean -i ./build/lib/Smt/Tactic/Smt.ilean -c ./build/ir/Smt/Tactic/Smt.c --load-dynlib<span class="o">=</span>libSmt-Data-Sexp.so --load-dynlib<span class="o">=</span>libSmt-Dsl-Sexp.so --load-dynlib<span class="o">=</span>libSmt-Term.so --load-dynlib<span class="o">=</span>libSmt-Solver.so --load-dynlib<span class="o">=</span>libSmt-Commands.so --load-dynlib<span class="o">=</span>libSmt-Graph.so --load-dynlib<span class="o">=</span>libSmt-Util.so --load-dynlib<span class="o">=</span>libSmt-Attribute.so --load-dynlib<span class="o">=</span>libSmt-Translator.so --load-dynlib<span class="o">=</span>libSmt-Tactic-WHNFConfigurableRef.so --load-dynlib<span class="o">=</span>libSmt-Tactic-WHNFConfigurable.so --load-dynlib<span class="o">=</span>libSmt-Tactic-WHNFSmt.so --load-dynlib<span class="o">=</span>libSmt-Tactic-EqnDef.so --load-dynlib<span class="o">=</span>libSmt-Query.so
</code></pre></div>



<a name="291447155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291447155" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291447155">(Jul 30 2022 at 19:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/precompileModules/near/291446835">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> No, because things like external libraries dynlibs can only be determined after a build. If you want to do that you essentially need to invoke <a href="https://github.com/leanprover/lake/blob/dcf8e1fc406acfd4dbbfd691f4ecf76966fae407/Lake/Build/Imports.lean#L27-L57"><code>buildImportsAndDeps</code></a> like <code>print-paths</code> <a href="https://github.com/leanprover/lake/blob/dcf8e1fc406acfd4dbbfd691f4ecf76966fae407/Lake/CLI/Main.lean#L178-L179">does</a>.</p>
</blockquote>
<p>I will try this since it sounds like the only cross-platform solution.</p>



<a name="291447624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291447624" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291447624">(Jul 30 2022 at 19:47)</a>:</h4>
<p>Is it possible to specify in the<code>lakefile</code> to produce <code>libFoo.so</code> during the build? I am looking through the list of <code>lean_lib</code> arguments and tried <code>nativeFacets := #[Module.oFacet, Module.dynlibFacet]</code> but that fails with a cyclic dependency error (anyhow it doesn't sound like this would do the right thing). I can run <code>lake build Foo:shared</code> on the command line but wanted to default to that.</p>



<a name="291450692"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291450692" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291450692">(Jul 30 2022 at 21:00)</a>:</h4>
<p><span class="user-mention" data-user-id="128280">@Wojciech Nawrocki</span> Unforunately, no, there is no way to default a library to produce something other than the lean binaries currently.</p>



<a name="291450709"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/291450709" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#291450709">(Jul 30 2022 at 21:01)</a>:</h4>
<p>This was something I considered and thought of adding a <code>facet</code> parameter to <code>defaultTarget</code>. Thus, it is on the TODO list, but as I only have a week left in my internship it may be a while before its complete (at least by me).</p>



<a name="294261863"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/294261863" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alexander Bentkamp <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#294261863">(Aug 19 2022 at 13:11)</a>:</h4>
<p>Wow, I really underestimated what impact <code>precompileModules</code> would have. On my test example, the time my tactic takes went down from 1800ms to 550ms, just by enabling <code>precompileModules</code>!</p>



<a name="294262134"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/294262134" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#294262134">(Aug 19 2022 at 13:12)</a>:</h4>
<p>Which tactic is that?</p>



<a name="294262491"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/294262491" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alexander Bentkamp <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#294262491">(Aug 19 2022 at 13:14)</a>:</h4>
<p><code>duper</code>, the successor to Lean3's <code>super</code>.</p>



<a name="294262509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/294262509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alexander Bentkamp <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#294262509">(Aug 19 2022 at 13:14)</a>:</h4>
<p><a href="https://github.com/abentkamp/duper">https://github.com/abentkamp/duper</a></p>



<a name="294262561"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/294262561" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alexander Bentkamp <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#294262561">(Aug 19 2022 at 13:15)</a>:</h4>
<p>It's mostly <span class="user-mention" data-user-id="436568">@Josh Clune</span> working on this now</p>



<a name="294262883"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/294262883" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#294262883">(Aug 19 2022 at 13:17)</a>:</h4>
<p>Nice! Is it already usable?</p>



<a name="294263651"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/294263651" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alexander Bentkamp <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#294263651">(Aug 19 2022 at 13:21)</a>:</h4>
<p>No, we are currently a bit underwhelmed by the performance :-). The <code>precompileModules</code> brings us much closer to what we would expect, but there must be some other performance bottlenecks that we need to figure out...</p>



<a name="294273210"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/294273210" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Marc Huisinga <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#294273210">(Aug 19 2022 at 14:04)</a>:</h4>
<p>If you're using <code>Array</code>, <code>HashMap</code> and such, you must be very careful that all the operations you expect to be O(1) are indeed O(1)</p>



<a name="294275007"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/294275007" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Marc Huisinga <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#294275007">(Aug 19 2022 at 14:14)</a>:</h4>
<p>E.g. <code>Array.data</code> is not (c.f. <a href="https://github.com/leanprover/lean4/blob/651d4044b376e27b414f01dd45703c2f069a22f1/src/Init/Prelude.lean#L2459">here</a>, <a href="https://github.com/leanprover/lean4/blob/9de477ecf9f590a8c02acabf0cdbf4d68fa19486/src/runtime/object.cpp#L344">here</a>, <a href="https://github.com/leanprover/lean4/blob/9de477ecf9f590a8c02acabf0cdbf4d68fa19486/src/runtime/object.cpp#L337">here</a> and finally <a href="https://github.com/leanprover/lean4/blob/f6211b1a74690daadce3f1466127d06fbc97a287/src/Init/Data/Array/Basic.lean#L474">here</a>) and for most mutations you need to ensure that the reference count is 1 / the array is being used linearly for array operations to be fast</p>



<a name="298498668"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/298498668" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#298498668">(Sep 13 2022 at 00:28)</a>:</h4>
<p>Hey, I'm having the same issue (1) as Jannis's original question -- I'm almost positive something is just wrong with my lakefile. Thoughts?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lake</span>
<span class="kn">open</span> <span class="n">System</span> <span class="n">Lake</span> <span class="n">DSL</span>

<span class="n">package</span> <span class="n">leancolls</span> <span class="o">{</span>
  <span class="n">precompileModules</span> <span class="o">:=</span> <span class="n">true</span>
<span class="o">}</span>

<span class="kd">@[defaultTarget]</span>
<span class="n">lean_lib</span> <span class="n">LeanColls</span>

<span class="kd">@[defaultTarget]</span>
<span class="n">lean_exe</span> <span class="n">test</span> <span class="o">{</span>
  <span class="n">root</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">Main</span>
<span class="o">}</span>

<span class="n">target</span> <span class="n">leancolls_array.o</span> <span class="o">(</span><span class="n">pkg</span> <span class="o">:</span> <span class="n">Package</span><span class="o">)</span> <span class="o">:</span> <span class="n">FilePath</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">oFile</span> <span class="o">:=</span> <span class="n">pkg.buildDir</span> <span class="bp">/</span> <span class="s2">"c"</span> <span class="bp">/</span> <span class="s2">"leancolls_array.o"</span>
  <span class="k">let</span> <span class="n">srcJob</span> <span class="bp">←</span> <span class="n">inputFile</span> <span class="bp">&lt;|</span> <span class="n">pkg.dir</span> <span class="bp">/</span> <span class="s2">"bindings"</span> <span class="bp">/</span> <span class="s2">"leancolls_array.c"</span>
  <span class="n">buildFileAfterDep</span> <span class="n">oFile</span> <span class="n">srcJob</span> <span class="k">fun</span> <span class="n">srcFile</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">flags</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="s2">"-I"</span><span class="o">,</span> <span class="o">(</span><span class="bp">←</span> <span class="n">getLeanIncludeDir</span><span class="o">)</span><span class="bp">.</span><span class="n">toString</span><span class="o">,</span> <span class="s2">"-fPIC"</span><span class="o">]</span>
    <span class="n">compileO</span> <span class="s2">"leancolls_array.c"</span> <span class="n">oFile</span> <span class="n">srcFile</span> <span class="n">flags</span>

<span class="n">extern_lib</span> <span class="n">libleancolls_array</span> <span class="o">(</span><span class="n">pkg</span> <span class="o">:</span> <span class="n">Package</span><span class="o">)</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">name</span> <span class="o">:=</span> <span class="n">nameToStaticLib</span> <span class="s2">"leancolls_array"</span>
  <span class="k">let</span> <span class="n">ffiO</span> <span class="bp">←</span> <span class="n">fetch</span> <span class="bp">&lt;|</span> <span class="n">pkg.target</span> <span class="bp">``</span><span class="n">leancolls_array.o</span>
  <span class="n">buildStaticLib</span> <span class="o">(</span><span class="n">pkg.buildDir</span> <span class="bp">/</span> <span class="s2">"c"</span> <span class="bp">/</span> <span class="n">name</span><span class="o">)</span> <span class="bp">#</span><span class="o">[</span><span class="n">ffiO</span><span class="o">]</span>

<span class="n">require</span> <span class="n">mathlib</span> <span class="k">from</span> <span class="n">git</span>
  <span class="s2">"https://github.com/leanprover-community/mathlib4"</span> <span class="bp">@</span> <span class="s2">"master"</span>

<span class="kd">meta</span> <span class="k">if</span> <span class="n">get_config</span><span class="bp">?</span> <span class="n">env</span> <span class="bp">=</span> <span class="n">some</span> <span class="s2">"dev"</span> <span class="k">then</span> <span class="c1">-- dev is so not everyone has to build it</span>
<span class="n">require</span> <span class="bp">«</span><span class="n">doc</span><span class="bp">-</span><span class="n">gen4</span><span class="bp">»</span> <span class="k">from</span> <span class="n">git</span> <span class="s2">"https://github.com/leanprover/doc-gen4"</span> <span class="bp">@</span> <span class="s2">"main"</span>
</code></pre></div>
<p>The C FFI code is in a file <code>bindings/leancolls_array.c</code></p>



<a name="298498738"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/298498738" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#298498738">(Sep 13 2022 at 00:29)</a>:</h4>
<p>I'm on 09-05 nightly, and my VS Code extension is version v0.0.95 which seems to include the fixes above</p>



<a name="298500686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/298500686" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#298500686">(Sep 13 2022 at 00:59)</a>:</h4>
<p>Oh, wait, I wrote <code>  buildStaticLib (pkg.buildDir / "c" / name) #[ffiO]</code> instead of <code>"lib"</code>... <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="298500755"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/298500755" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#298500755">(Sep 13 2022 at 01:00)</a>:</h4>
<p><a href="https://github.com/leanprover/lake/blob/master/examples/ffi/lib/lakefile.lean">https://github.com/leanprover/lake/blob/master/examples/ffi/lib/lakefile.lean</a> I was copying this example... Maybe it needs updating?</p>



<a name="299868944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/299868944" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#299868944">(Sep 21 2022 at 00:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="407274">James Gallicchio</span> <a href="#narrow/stream/270676-lean4/topic/precompileModules/near/298500686">said</a>:</p>
<blockquote>
<p>Oh, wait, I wrote <code>  buildStaticLib (pkg.buildDir / "c" / name) #[ffiO]</code> instead of <code>"lib"</code>... <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>
</blockquote>
<p>I am not sure what you mean. Also you should probably not be passing a simple string as a path, as the current working directory can very based on were a package is in the dependency hierarchy. You may however want to use <code>pkg.libDir</code>?</p>



<a name="299869078"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/299869078" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#299869078">(Sep 21 2022 at 00:48)</a>:</h4>
<p>Fyi, I am still not sure what the issue is. The FFI example builds and works so it should be a proper model for user code.</p>



<a name="299870380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/299870380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#299870380">(Sep 21 2022 at 01:06)</a>:</h4>
<p>Oh, you may have been talking about <a href="#narrow/stream/270676-lean4/topic/lakefile.20dependencies/near/291358687">this issue</a> raised in a previous Zulip thread. Yeah, the FFI example likely needs an update in that case. However, its been a while and don't exactly remember why it the FFI example worked for me in the past when I tested it interactively but it doesn't now -- I will have to go take a look sometime.</p>



<a name="299878509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/precompileModules/near/299878509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/precompileModules.html#299878509">(Sep 21 2022 at 03:19)</a>:</h4>
<p>Yeah -- I don't know enough to understand why the issue occurred, but it seems like the output needs to be in the "lib" directory in my use case. Not sure why</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>