---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html">addDeclarationRanges eval taking forever</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="235317338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235317338" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Aurélien Saue <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235317338">(Apr 20 2021 at 09:57)</a>:</h4>
<p>The final #eval in this snippet is being processed forever</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>
<span class="kn">open</span> <span class="n">Lean</span>

<span class="kd">def</span> <span class="n">name</span> <span class="o">:</span> <span class="n">Name</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">name</span>


<span class="kd">def</span> <span class="n">drs</span> <span class="o">:</span> <span class="n">DeclarationRanges</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="n">range</span> <span class="o">:=</span>
      <span class="o">{</span> <span class="n">pos</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">line</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">column</span> <span class="o">:=</span> <span class="mi">0</span> <span class="o">},</span>
        <span class="n">charUtf16</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span>
        <span class="n">endPos</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">line</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">column</span> <span class="o">:=</span> <span class="mi">0</span> <span class="o">},</span>
        <span class="n">endCharUtf16</span> <span class="o">:=</span> <span class="mi">0</span> <span class="o">},</span>
    <span class="n">selectionRange</span> <span class="o">:=</span>
      <span class="o">{</span> <span class="n">pos</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">line</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">column</span> <span class="o">:=</span> <span class="mi">0</span> <span class="o">},</span>
        <span class="n">charUtf16</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span>
        <span class="n">endPos</span> <span class="o">:=</span> <span class="o">{</span> <span class="n">line</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">column</span> <span class="o">:=</span> <span class="mi">0</span> <span class="o">},</span>
        <span class="n">endCharUtf16</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">}</span>
  <span class="o">}</span>


<span class="k">#eval</span> <span class="o">(</span><span class="n">addDeclarationRanges</span> <span class="n">name</span> <span class="n">drs</span> <span class="o">:</span> <span class="n">MetaM</span> <span class="n">Unit</span><span class="o">)</span>
</code></pre></div>



<a name="235318355"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235318355" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Aurélien Saue <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235318355">(Apr 20 2021 at 10:06)</a>:</h4>
<p>Actually it does work when executing in command line but not in VSCode</p>



<a name="235318480"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235318480" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235318480">(Apr 20 2021 at 10:07)</a>:</h4>
<p>I wonder if this is related to <a href="#narrow/stream/270676-lean4/topic/can't.20print.20unit/near/234134267">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/can't.20print.20unit/near/234134267</a></p>



<a name="235318959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235318959" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235318959">(Apr 20 2021 at 10:12)</a>:</h4>
<p>In Emacs I just get an empty message as expected</p>



<a name="235342814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235342814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235342814">(Apr 20 2021 at 13:25)</a>:</h4>
<p>This is interesting.  Apparently the server returns empty messages:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code>  <span class="p">{</span>
    <span class="nt">"params"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"version"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">"uri"</span><span class="p">:</span> <span class="s2">"file:///home/gebner/lean4/foo.lean"</span><span class="p">,</span>
      <span class="nt">"diagnostics"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">"source"</span><span class="p">:</span> <span class="s2">"Lean 4 server"</span><span class="p">,</span>
          <span class="nt">"severity"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
          <span class="nt">"range"</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">"start"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"line"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="nt">"character"</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">},</span>
            <span class="nt">"end"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"line"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="nt">"character"</span><span class="p">:</span> <span class="mi">5</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">"message"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span>
          <span class="nt">"fullRange"</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">"start"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"line"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="nt">"character"</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">},</span>
            <span class="nt">"end"</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">"line"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="nt">"character"</span><span class="p">:</span> <span class="mi">5</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">"method"</span><span class="p">:</span> <span class="s2">"textDocument/publishDiagnostics"</span><span class="p">,</span>
    <span class="nt">"jsonrpc"</span><span class="p">:</span> <span class="s2">"2.0"</span>
  <span class="p">}</span>
</code></pre></div>



<a name="235342943"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235342943" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235342943">(Apr 20 2021 at 13:26)</a>:</h4>
<p>I wonder if it's related to a similar issue I'm facing with side-effecting <code>MetaM Unit</code> stuff.</p>



<a name="235342997"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235342997" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235342997">(Apr 20 2021 at 13:26)</a>:</h4>
<p>I seem to also get infinite loops if I don't print something using <code>trace[Meta.debug]</code> and make a pure side-effect.</p>



<a name="235343009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235343009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235343009">(Apr 20 2021 at 13:26)</a>:</h4>
<p>The vscode extension then throws an exception (and doesn't update the diagnostics):</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>Notification handler 'textDocument/publishDiagnostics' failed with message: message must be set
</code></pre></div>



<a name="235349079"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235349079" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235349079">(Apr 20 2021 at 14:05)</a>:</h4>
<p>I see <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> fixed it on the extension side, but I suppose we could still suppress empty messages from the server?</p>



<a name="235349228"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235349228" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235349228">(Apr 20 2021 at 14:06)</a>:</h4>
<p>I'm not sure what the right solution here is.  Empty messages are not forbidden by the LSP protocol AFAICT.</p>



<a name="235349423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235349423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235349423">(Apr 20 2021 at 14:07)</a>:</h4>
<p>Yeah, I just wonder what's the more helpful behavior. If people use it for side-effects, they probably don't want to see any empty message.</p>



<a name="235350159"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235350159" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235350159">(Apr 20 2021 at 14:12)</a>:</h4>
<p>Yeah, suppressing the empty message is probably more helpful.</p>



<a name="235407235"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235407235" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235407235">(Apr 20 2021 at 20:11)</a>:</h4>
<p>I think that suppressing empty messages should be done on the extension side. I think it is difficult to find all the places where lean can possibly send an empty message, I've run into this problem in 3 or 4 places before</p>



<a name="235407482"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/addDeclarationRanges%20eval%20taking%20forever/near/235407482" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/addDeclarationRanges.20eval.20taking.20forever.html#235407482">(Apr 20 2021 at 20:13)</a>:</h4>
<p>I would have made it specific to <code>#eval</code>, I don't know about any other parts that could send empty messages. But even then, there is a single function in the code that actually writes out the diagnostics notification to the client, so we could also filter them there.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>