---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Simp.20bug.20-.20produces.60application.20type.20mismatch.60.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Simp.20bug.20-.20produces.60application.20type.20mismatch.60.html">Simp bug - produces`application type mismatch`</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="257711901"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Simp%20bug%20-%20produces%60application%20type%20mismatch%60/near/257711901" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Simp.20bug.20-.20produces.60application.20type.20mismatch.60.html#257711901">(Oct 15 2021 at 15:01)</a>:</h4>
<p>I'm playing around with combinatory logic and I have encountered a problem with <code>simp</code> tactic. It seems to produce an invalid expression on nightly build.</p>
<p>This example defines <code>S</code> combinator with <code>B</code>(comp) and <code>C</code>(swap) and diagonal(no clue what is the official name)</p>
<p>Define <code>comp, swap, diag</code> and their reductions</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">variable</span> <span class="o">{</span><span class="n">X</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">Z</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span>

<span class="kd">def</span> <span class="n">comp</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:=</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span>
<span class="kd">def</span> <span class="n">swap</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:=</span> <span class="n">f</span> <span class="n">x</span> <span class="n">y</span>
<span class="kd">def</span> <span class="n">diag</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span> <span class="n">x</span><span class="o">)</span>

<span class="kd">@[simp]</span> <span class="kd">def</span> <span class="n">comp_reduce</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">comp</span> <span class="n">f</span> <span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span><span class="o">[</span><span class="n">comp</span><span class="o">]</span> <span class="n">done</span>
<span class="kd">@[simp]</span> <span class="kd">def</span> <span class="n">swap_reduce</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">swap</span> <span class="n">f</span> <span class="n">y</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span><span class="o">[</span><span class="n">swap</span><span class="o">]</span> <span class="n">done</span>
<span class="kd">@[simp]</span> <span class="kd">def</span> <span class="n">diag_reduce</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">diag</span> <span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">x</span> <span class="n">x</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span><span class="o">[</span><span class="n">diag</span><span class="o">]</span> <span class="n">done</span>
</code></pre></div>
<p>Define <code>subs</code>(S combinator) in terms of the previous three and prove it is indeed S combinator</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">subs</span> <span class="o">:</span> <span class="o">(</span><span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">X</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">swap</span> <span class="o">(</span><span class="n">comp</span> <span class="o">(</span><span class="n">comp</span> <span class="n">diag</span><span class="o">)</span> <span class="o">(</span><span class="n">comp</span> <span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span><span class="o">))))</span>

<span class="kd">@[simp]</span> <span class="kd">def</span> <span class="n">subs_reduce</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">subs</span> <span class="n">f</span> <span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span>
  <span class="n">conv</span> <span class="bp">=&gt;</span> <span class="n">lhs</span><span class="bp">;</span> <span class="n">whnf</span><span class="bp">;</span>
  <span class="n">done</span>

<span class="kd">@[simp]</span> <span class="kd">def</span> <span class="n">subs_reduce'</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">subs</span> <span class="n">f</span> <span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span>
  <span class="n">simp</span><span class="o">[</span><span class="n">subs</span><span class="o">]</span>
  <span class="n">done</span>
</code></pre></div>
<p>On nighly build <code>leanprover/lean4:nightly-2021-10-13</code> proving <code>subs_reduce'</code> fails with an error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">application</span> <span class="n">type</span> <span class="n">mismatch</span>
  <span class="n">comp</span> <span class="n">diag</span> <span class="o">(</span><span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span> <span class="n">g</span><span class="o">))</span> <span class="n">x</span>
<span class="n">argument</span> <span class="n">has</span> <span class="n">type</span>
  <span class="n">X</span>
<span class="n">but</span> <span class="n">function</span> <span class="n">has</span> <span class="n">type</span>
  <span class="o">(</span><span class="n">X</span> <span class="bp">→</span> <span class="n">Y</span> <span class="bp">→</span> <span class="n">Z</span><span class="o">)</span> <span class="bp">→</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">Z</span>
</code></pre></div>



<a name="257714359"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Simp%20bug%20-%20produces%60application%20type%20mismatch%60/near/257714359" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Simp.20bug.20-.20produces.60application.20type.20mismatch.60.html#257714359">(Oct 15 2021 at 15:15)</a>:</h4>
<p>For some reason after couple of simplifications it produces an invalid goal:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">comp</span> <span class="n">diag</span> <span class="o">(</span><span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span> <span class="n">g</span><span class="o">))</span> <span class="n">x</span> <span class="n">f</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">x</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span>
</code></pre></div>
<p>but the correct goal should be</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">comp</span> <span class="n">diag</span> <span class="o">(</span><span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span> <span class="n">g</span><span class="o">))</span> <span class="n">f</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">x</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span>
</code></pre></div>
<p>Continuing from that point on works fine:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">finish_proof</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="n">comp</span> <span class="n">diag</span> <span class="o">(</span><span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span> <span class="n">g</span><span class="o">))</span> <span class="n">f</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">x</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span>
  <span class="n">simp</span>
  <span class="n">done</span>  <span class="c1">-- works!</span>
</code></pre></div>



<a name="257723598"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Simp%20bug%20-%20produces%60application%20type%20mismatch%60/near/257723598" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Simp.20bug.20-.20produces.60application.20type.20mismatch.60.html#257723598">(Oct 15 2021 at 16:13)</a>:</h4>
<p>The <code>simp.rewrite</code> trace is:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="mi">23</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span>
<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">swap_reduce</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">swap</span> <span class="o">(</span><span class="n">comp</span> <span class="o">(</span><span class="n">comp</span> <span class="n">diag</span><span class="o">)</span> <span class="o">(</span><span class="n">comp</span> <span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span><span class="o">)))</span> <span class="n">f</span>
  <span class="n">g</span> <span class="bp">==&gt;</span> <span class="n">comp</span> <span class="o">(</span><span class="n">comp</span> <span class="n">diag</span><span class="o">)</span> <span class="o">(</span><span class="n">comp</span> <span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span><span class="o">))</span> <span class="n">g</span> <span class="n">f</span>
<span class="mi">23</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span>
<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">comp_reduce</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">comp</span> <span class="o">(</span><span class="n">comp</span> <span class="n">diag</span><span class="o">)</span> <span class="o">(</span><span class="n">comp</span> <span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span><span class="o">))</span>
  <span class="n">g</span> <span class="bp">==&gt;</span> <span class="n">comp</span> <span class="n">diag</span> <span class="o">(</span><span class="n">comp</span> <span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span><span class="o">)</span> <span class="n">g</span><span class="o">)</span>
<span class="mi">23</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span>
<span class="o">[</span><span class="n">Meta.Tactic.simp.rewrite</span><span class="o">]</span> <span class="n">comp_reduce</span><span class="o">:</span><span class="mi">1000</span><span class="o">,</span> <span class="n">comp</span> <span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span><span class="o">)</span> <span class="n">g</span> <span class="bp">==&gt;</span> <span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span> <span class="n">g</span><span class="o">)</span>
</code></pre></div>



<a name="257724464"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Simp%20bug%20-%20produces%60application%20type%20mismatch%60/near/257724464" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Simp.20bug.20-.20produces.60application.20type.20mismatch.60.html#257724464">(Oct 15 2021 at 16:19)</a>:</h4>
<p>Manually repeating these rewrites works fine</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">subs_reduce''</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="o">((</span><span class="n">swap</span> <span class="o">(</span><span class="n">comp</span> <span class="o">(</span><span class="n">comp</span> <span class="n">diag</span><span class="o">)</span> <span class="o">(</span><span class="n">comp</span> <span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span><span class="o">))))</span> <span class="n">f</span> <span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">swap_reduce</span><span class="o">]</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">comp_reduce</span><span class="o">]</span>
  <span class="n">conv</span> <span class="bp">=&gt;</span>
    <span class="n">enter</span> <span class="o">[</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">]</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">comp_reduce</span><span class="o">]</span>
  <span class="n">done</span>
</code></pre></div>



<a name="257727130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Simp%20bug%20-%20produces%60application%20type%20mismatch%60/near/257727130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Simp.20bug.20-.20produces.60application.20type.20mismatch.60.html#257727130">(Oct 15 2021 at 16:36)</a>:</h4>
<p>Here is a self contained version that produces invalid goal just after one step of <code>simp.rewrite</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">variable</span> <span class="o">{</span><span class="n">X</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">Y</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">Z</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span>

<span class="kd">def</span> <span class="n">comp</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:=</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span>
<span class="kd">def</span> <span class="n">swap</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:=</span> <span class="n">f</span> <span class="n">x</span> <span class="n">y</span>
<span class="kd">def</span> <span class="n">diag</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span> <span class="n">x</span><span class="o">)</span>

<span class="kd">@[simp]</span> <span class="kd">def</span> <span class="n">comp_reduce</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">comp</span> <span class="n">f</span> <span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span><span class="o">[</span><span class="n">comp</span><span class="o">]</span> <span class="n">done</span>
<span class="kd">def</span> <span class="n">swap_reduce</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">swap</span> <span class="n">f</span> <span class="n">y</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span><span class="o">[</span><span class="n">swap</span><span class="o">]</span> <span class="n">done</span>
<span class="kd">@[simp]</span> <span class="kd">def</span> <span class="n">diag_reduce</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">diag</span> <span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">x</span> <span class="n">x</span> <span class="o">:=</span> <span class="kd">by</span> <span class="n">simp</span><span class="o">[</span><span class="n">diag</span><span class="o">]</span> <span class="n">done</span>

<span class="kd">def</span> <span class="n">subs</span> <span class="o">:</span> <span class="o">(</span><span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">X</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">swap</span> <span class="o">(</span><span class="n">comp</span> <span class="o">(</span><span class="n">comp</span> <span class="n">diag</span><span class="o">)</span> <span class="o">(</span><span class="n">comp</span> <span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span><span class="o">))))</span>

<span class="kd">set_option</span> <span class="n">trace.Meta.Tactic.simp</span> <span class="n">true</span>

<span class="kd">def</span> <span class="n">foo</span> <span class="o">{</span><span class="n">W</span><span class="o">}</span> <span class="o">:=</span> <span class="o">((</span><span class="n">comp</span> <span class="n">comp</span> <span class="o">(</span><span class="n">swap</span> <span class="n">comp</span><span class="o">))</span> <span class="o">:</span> <span class="o">(</span><span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="bp">→</span> <span class="n">_</span> <span class="bp">→</span> <span class="n">W</span> <span class="bp">→</span> <span class="n">X</span> <span class="bp">→</span> <span class="n">Z</span><span class="o">)</span>
<span class="kd">def</span> <span class="n">subs_reduce'</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="bp">→</span><span class="n">Z</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">X</span><span class="bp">→</span><span class="n">Y</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">X</span><span class="o">)</span> <span class="o">:</span> <span class="n">comp</span> <span class="o">(</span><span class="n">comp</span> <span class="n">diag</span><span class="o">)</span> <span class="n">foo</span> <span class="n">g</span> <span class="n">f</span> <span class="n">x</span> <span class="bp">=</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">g</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span>
<span class="kd">by</span>
  <span class="n">simp</span>
  <span class="n">done</span>   <span class="c1">--  application type mismatch: comp diag (foo g) x</span>
</code></pre></div>



<a name="257729621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Simp%20bug%20-%20produces%60application%20type%20mismatch%60/near/257729621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Simp.20bug.20-.20produces.60application.20type.20mismatch.60.html#257729621">(Oct 15 2021 at 16:54)</a>:</h4>
<p>Maybe related to this <a href="https://github.com/leanprover/lean4/commit/1282fb2d97bc45873c050aa62f95a263c528f68d">commit</a>. It even has a comment about reversed order of arguments.</p>



<a name="258099609"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Simp%20bug%20-%20produces%60application%20type%20mismatch%60/near/258099609" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Simp.20bug.20-.20produces.60application.20type.20mismatch.60.html#258099609">(Oct 18 2021 at 21:01)</a>:</h4>
<p>Pushed a fix for this bug.<br>
<a href="https://github.com/leanprover/lean4/commit/6b2303b24305deab05a7609985f03af3e9fdece5">https://github.com/leanprover/lean4/commit/6b2303b24305deab05a7609985f03af3e9fdece5</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>