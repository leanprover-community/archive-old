---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Show.20expanded.20macros.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Show.20expanded.20macros.html">Show expanded macros</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="304288560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Show%20expanded%20macros/near/304288560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Marcus Rossel <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Show.20expanded.20macros.html#304288560">(Oct 16 2022 at 10:01)</a>:</h4>
<p>Is there a way of viewing the code generated by a macro?<br>
For example, for something like:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">macro</span> <span class="s2">"my_cmd"</span> <span class="n">thing</span><span class="o">:</span><span class="n">ident</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span>
  <span class="kd">inductive</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">&lt;|</span> <span class="n">thing.getId</span> <span class="bp">++</span> <span class="bp">`</span><span class="n">One</span><span class="o">)</span> <span class="bp">|</span> <span class="n">a</span> <span class="bp">|</span> <span class="n">b</span> <span class="bp">|</span> <span class="n">c</span>
  <span class="kd">inductive</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">&lt;|</span> <span class="n">thing.getId</span> <span class="bp">++</span> <span class="bp">`</span><span class="n">Two</span><span class="o">)</span> <span class="bp">|</span> <span class="n">d</span> <span class="bp">|</span> <span class="n">e</span> <span class="bp">|</span> <span class="n">f</span>
<span class="o">)</span>

<span class="n">my_cmd</span> <span class="n">Test</span>
</code></pre></div>
<p>... is there a way of having Lean show me?:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">Test.One</span> <span class="bp">|</span> <span class="n">a</span> <span class="bp">|</span> <span class="n">b</span> <span class="bp">|</span> <span class="n">c</span>
<span class="kd">inductive</span> <span class="n">Test.Two</span> <span class="bp">|</span> <span class="n">d</span> <span class="bp">|</span> <span class="n">e</span> <span class="bp">|</span> <span class="n">f</span>
</code></pre></div>
<p>Or does this question not make sense, as Lean can't know which macros I want it to expand and which should remain untouched?</p>



<a name="304296377"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Show%20expanded%20macros/near/304296377" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Show.20expanded.20macros.html#304296377">(Oct 16 2022 at 11:22)</a>:</h4>
<p>You can recover the Syntax object itself:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>
<span class="kn">open</span> <span class="n">Lean</span>

<span class="n">macro</span> <span class="s2">"my_cmd"</span> <span class="n">thing</span><span class="o">:</span><span class="n">ident</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">stx</span> <span class="bp">←</span> <span class="bp">`</span><span class="o">(</span>
    <span class="kd">inductive</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">&lt;|</span> <span class="n">thing.getId</span> <span class="bp">++</span> <span class="bp">`</span><span class="n">One</span><span class="o">)</span> <span class="bp">|</span> <span class="n">a</span> <span class="bp">|</span> <span class="n">b</span> <span class="bp">|</span> <span class="n">c</span>
    <span class="kd">inductive</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">&lt;|</span> <span class="n">thing.getId</span> <span class="bp">++</span> <span class="bp">`</span><span class="n">Two</span><span class="o">)</span> <span class="bp">|</span> <span class="n">d</span> <span class="bp">|</span> <span class="n">e</span> <span class="bp">|</span> <span class="n">f</span>
  <span class="o">)</span>
  <span class="n">dbg_trace</span> <span class="n">stx</span>
  <span class="n">return</span> <span class="n">stx</span>

<span class="n">my_cmd</span> <span class="n">Test</span>
</code></pre></div>
<p>but doing it in a readable way would require you to use the pretty printer which afaik cannot work because it operates in the meta stack (CoreM, MetaM) while MacroM is only a weak:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">abbrev</span> <span class="n">MacroM</span> <span class="o">:=</span> <span class="n">ReaderT</span> <span class="n">Macro.Context</span> <span class="o">(</span><span class="n">EStateM</span> <span class="n">Macro.Exception</span> <span class="n">Macro.State</span><span class="o">)</span>
</code></pre></div>



<a name="304303816"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Show%20expanded%20macros/near/304303816" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Marcus Rossel <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Show.20expanded.20macros.html#304303816">(Oct 16 2022 at 12:34)</a>:</h4>
<p><span class="user-mention" data-user-id="395550">@Henrik Böving</span> I don't understand the last part about the pretty printer. Are you saying that there is way to pretty print any given <code>Syntax</code> object, but it requires using <code>CoreM</code>/<code>MetaM</code>? If so, let's say I have a <code>Syntax</code> object, then how would I use <code>CoreM</code>/<code>MetaM</code> to pretty print it?</p>



<a name="304304073"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Show%20expanded%20macros/near/304304073" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Show.20expanded.20macros.html#304304073">(Oct 16 2022 at 12:37)</a>:</h4>
<p>In your case for example with <a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.ppCommand#doc">docs4#Lean.PrettyPrinter.ppCommand</a>, the pretty printer is how all of the info view works, otherwise we'd only see <code>Expr</code>s</p>
<p>Also i dug a little more you can get a sort of pretty print (more of a toString) this way:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>
<span class="kn">open</span> <span class="n">Lean</span>

<span class="n">macro</span> <span class="s2">"my_cmd"</span> <span class="n">thing</span><span class="o">:</span><span class="n">ident</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">stx</span> <span class="bp">←</span> <span class="bp">`</span><span class="o">(</span>
    <span class="kd">inductive</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">&lt;|</span> <span class="n">thing.getId</span> <span class="bp">++</span> <span class="bp">`</span><span class="n">One</span><span class="o">)</span> <span class="bp">|</span> <span class="n">a</span> <span class="bp">|</span> <span class="n">b</span> <span class="bp">|</span> <span class="n">c</span>
    <span class="kd">inductive</span> <span class="bp">$</span><span class="o">(</span><span class="n">mkIdent</span> <span class="bp">&lt;|</span> <span class="n">thing.getId</span> <span class="bp">++</span> <span class="bp">`</span><span class="n">Two</span><span class="o">)</span> <span class="bp">|</span> <span class="n">d</span> <span class="bp">|</span> <span class="n">e</span> <span class="bp">|</span> <span class="n">f</span>
  <span class="o">)</span>
  <span class="n">dbg_trace</span> <span class="n">Syntax.prettyPrint</span> <span class="n">stx</span>
  <span class="n">return</span> <span class="n">stx</span>

<span class="n">my_cmd</span> <span class="n">test</span>
</code></pre></div>



<a name="304311283"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Show%20expanded%20macros/near/304311283" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Show.20expanded.20macros.html#304311283">(Oct 16 2022 at 13:48)</a>:</h4>
<p><code>set_option trace.Elab.command true</code>; see <a href="https://leanprover.github.io/lean4/doc/dev/debugging.html#tracing">https://leanprover.github.io/lean4/doc/dev/debugging.html#tracing</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>