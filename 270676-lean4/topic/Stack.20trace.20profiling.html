---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Stack.20trace.20profiling.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html">Stack trace profiling</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="271010783"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271010783" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271010783">(Feb 07 2022 at 17:16)</a>:</h4>
<p>Has anyone had success using <code>perf</code> to get a meaningful profile of a lean 4 application? I've been trying to run mathport in perf, but the stack trace seems to break down very often, with only one or two functions before hitting some <code>[unknown] ([unknown])</code>, and it's rare to see any functions at all defined in the <code>Mathport</code> package in the call stack.</p>
<p>Steps:</p>
<ul>
<li>add <code>moreLeancArgs := #["-UNDEBUG", "-Og", "-ggdb", "-g3", "-fno-omit-frame-pointer"]</code> to lakefile.lean</li>
<li><code>sudo sh -c "echo 0 &gt; /proc/sys/kernel/kptr_restrict"</code></li>
<li><code>sudo sh -c "echo -1 &gt; /proc/sys/kernel/perf_event_paranoid"</code></li>
<li><code>perf record -g --call-graph fp -e cycles -F 999 -- cmd args...</code></li>
<li><code>perf script -F +pid &gt; test.perf</code></li>
<li>View in <a href="http://profiler.firefox.com">profiler.firefox.com</a></li>
</ul>
<p>The perf file looks like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">mathport</span> <span class="mi">2429065</span><span class="bp">/</span><span class="mi">2429071</span> <span class="mi">1263112</span><span class="bp">.</span><span class="mi">249188</span><span class="o">:</span>    <span class="mi">4429237</span> <span class="n">cycles</span><span class="o">:</span>
             <span class="mi">1</span><span class="n">b5f5c7</span> <span class="n">lean_expr_loose_bvar_range</span><span class="bp">+</span><span class="mi">0x77</span> <span class="o">(</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/</span><span class="n">Documents</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">mathport</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">mathport</span><span class="o">)</span>

<span class="n">mathport</span> <span class="mi">2429065</span><span class="bp">/</span><span class="mi">2429071</span> <span class="mi">1263112</span><span class="bp">.</span><span class="mi">250253</span><span class="o">:</span>    <span class="mi">4413503</span> <span class="n">cycles</span><span class="o">:</span>
             <span class="mi">1</span><span class="n">b61131</span> <span class="n">l_Lean_mkLambda</span><span class="bp">+</span><span class="mi">0x111</span> <span class="o">(</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/</span><span class="n">Documents</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">mathport</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">mathport</span><span class="o">)</span>

<span class="n">mathport</span> <span class="mi">2429065</span><span class="bp">/</span><span class="mi">2429071</span> <span class="mi">1263112</span><span class="bp">.</span><span class="mi">251281</span><span class="o">:</span>    <span class="mi">4380424</span> <span class="n">cycles</span><span class="o">:</span>
             <span class="mi">19</span><span class="n">d775d</span> <span class="n">lean</span><span class="o">::</span><span class="n">hash</span><span class="bp">+</span><span class="mi">0xd</span> <span class="o">(</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/</span><span class="n">Documents</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">mathport</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">mathport</span><span class="o">)</span>
    <span class="n">d000007fdb84006b</span> <span class="o">[</span><span class="n">unknown</span><span class="o">]</span> <span class="o">([</span><span class="n">unknown</span><span class="o">])</span>

<span class="n">mathport</span> <span class="mi">2429065</span><span class="bp">/</span><span class="mi">2429071</span> <span class="mi">1263112</span><span class="bp">.</span><span class="mi">252260</span><span class="o">:</span>    <span class="mi">4365599</span> <span class="n">cycles</span><span class="o">:</span>
             <span class="mi">1</span><span class="n">b5ac94</span> <span class="n">l_Lean_Expr_mkData</span><span class="bp">+</span><span class="mi">0x134</span> <span class="o">(</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/</span><span class="n">Documents</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">mathport</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">mathport</span><span class="o">)</span>

<span class="n">mathport</span> <span class="mi">2429065</span><span class="bp">/</span><span class="mi">2429071</span> <span class="mi">1263112</span><span class="bp">.</span><span class="mi">253293</span><span class="o">:</span>    <span class="mi">4377971</span> <span class="n">cycles</span><span class="o">:</span>
             <span class="mi">19</span><span class="n">dc2fc</span> <span class="n">lean</span><span class="o">::</span><span class="n">replace_rec_fn</span><span class="o">::</span><span class="n">apply</span><span class="bp">+</span><span class="mi">0xfc</span> <span class="o">(</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/</span><span class="n">Documents</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">mathport</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">mathport</span><span class="o">)</span>

<span class="n">mathport</span> <span class="mi">2429065</span><span class="bp">/</span><span class="mi">2429071</span> <span class="mi">1263112</span><span class="bp">.</span><span class="mi">254344</span><span class="o">:</span>    <span class="mi">4350249</span> <span class="n">cycles</span><span class="o">:</span>
             <span class="mi">19</span><span class="n">d7d3e</span> <span class="n">lean</span><span class="o">::</span><span class="n">mk_lambda</span><span class="bp">+</span><span class="mi">0xe</span> <span class="o">(</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/</span><span class="n">Documents</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">mathport</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">mathport</span><span class="o">)</span>

<span class="n">mathport</span> <span class="mi">2429065</span><span class="bp">/</span><span class="mi">2429071</span> <span class="mi">1263112</span><span class="bp">.</span><span class="mi">255319</span><span class="o">:</span>    <span class="mi">4324505</span> <span class="n">cycles</span><span class="o">:</span>
             <span class="mi">399</span><span class="n">d527</span> <span class="n">lean_apply_2</span><span class="bp">+</span><span class="mi">0xc7</span> <span class="o">(</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/</span><span class="n">Documents</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">mathport</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">mathport</span><span class="o">)</span>
             <span class="mi">24</span><span class="n">af839</span> <span class="n">l_Lean_Meta_mkLambdaFVars</span><span class="bp">+</span><span class="mi">0x279</span> <span class="o">(</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/</span><span class="n">Documents</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">mathport</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">mathport</span><span class="o">)</span>
                   <span class="mi">1</span> <span class="o">[</span><span class="n">unknown</span><span class="o">]</span> <span class="o">([</span><span class="n">unknown</span><span class="o">])</span>
</code></pre></div>



<a name="271011521"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271011521" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271011521">(Feb 07 2022 at 17:21)</a>:</h4>
<p>I usually do <code>--call-graph dwarf,65528</code> which records more of the stack.</p>



<a name="271011545"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271011545" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271011545">(Feb 07 2022 at 17:21)</a>:</h4>
<p><code>-fno-omit-fp</code> probably doesn't change much unless you also recompile Lean with it. But then you may as well download the Lean 4 "Linux" (<em>not</em> "Linux release") artifact, which is not linked using lld and thus should work with <code>perf --call-graph dwarf</code>: <a href="https://github.com/llvm/llvm-project/issues/53156">https://github.com/llvm/llvm-project/issues/53156</a></p>



<a name="271011675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271011675" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271011675">(Feb 07 2022 at 17:22)</a>:</h4>
<p>perf works great for me. Here is an example:</p>
<p>perf record --call-graph dwarf build/release/stage1/bin/lean TBA/While/ConstantPropagation.lean</p>
<p>hotspot</p>



<a name="271011798"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271011798" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271011798">(Feb 07 2022 at 17:23)</a>:</h4>
<p>do you have to build lean with something other than the default <code>-O3 -DNDEBUG</code>?</p>



<a name="271011855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271011855" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271011855">(Feb 07 2022 at 17:23)</a>:</h4>
<p>No, if your default linker is not lld</p>



<a name="271011986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271011986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271011986">(Feb 07 2022 at 17:24)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> what's my default linker?</p>



<a name="271012049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271012049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271012049">(Feb 07 2022 at 17:24)</a>:</h4>
<p>Most probably not lld :) . <code>ld -v</code>.</p>



<a name="271012088"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271012088" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271012088">(Feb 07 2022 at 17:25)</a>:</h4>
<p><code>GNU ld (GNU Binutils for Ubuntu) 2.37</code></p>



<a name="271012764"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271012764" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271012764">(Feb 07 2022 at 17:29)</a>:</h4>
<p>And the output from above is with a self-compiled Lean?</p>



<a name="271012955"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271012955" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271012955">(Feb 07 2022 at 17:30)</a>:</h4>
<p>no, I'm on nightly</p>



<a name="271012986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271012986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271012986">(Feb 07 2022 at 17:30)</a>:</h4>
<p>I haven't tried your suggestion of recompiling lean yet</p>



<a name="271013086"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271013086" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271013086">(Feb 07 2022 at 17:31)</a>:</h4>
<blockquote>
<p>But then you may as well download the Lean 4 "Linux" (not "Linux release") artifact</p>
</blockquote>
<p><code>--call-graph dwarf</code> works for me with the nightly build (though ld is used for linking mathport since I'm on nixos).</p>



<a name="271013226"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271013226" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271013226">(Feb 07 2022 at 17:32)</a>:</h4>
<p>gabriel's suggestion seems to produce some very large files, I get these <code>Check IO/CPU overload!</code> warnings and some self test stuff seems to fail</p>



<a name="271013276"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271013276" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271013276">(Feb 07 2022 at 17:32)</a>:</h4>
<p>Yeah, the files are larger because it captures more stack information.  The overload warnings are harmless in my experience.</p>



<a name="271013380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271013380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271013380">(Feb 07 2022 at 17:33)</a>:</h4>
<p>(<span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> BTW, thanks for the <code>perf report | less</code> tip.  The dumb output is really much better than the TUI which gets shown by default.)</p>



<a name="271014500"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271014500" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271014500">(Feb 07 2022 at 17:41)</a>:</h4>
<p>hm, <code>--call-graph dwarf,65528</code> didn't help</p>



<a name="271014975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271014975" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271014975">(Feb 07 2022 at 17:44)</a>:</h4>
<p>Do you get unknown in <code>perf report | less</code> as well?  (I don't get any here.)</p>



<a name="271015059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271015059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271015059">(Feb 07 2022 at 17:45)</a>:</h4>
<p>IIRC you can switch the linker by doing <code>export LEAN_CC=gcc</code>.</p>



<a name="271015189"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271015189" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271015189">(Feb 07 2022 at 17:45)</a>:</h4>
<p>Here's perf report (trimmed in kernel calls):</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>    <span class="mi">10</span><span class="bp">.</span><span class="mi">31</span><span class="bp">%</span>    <span class="mi">10</span><span class="bp">.</span><span class="mi">27</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="n">mathport</span>              <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_dec_ref_cold</span>
            <span class="bp">|</span>
            <span class="c1">---lean_dec_ref_cold</span>

     <span class="mi">6</span><span class="bp">.</span><span class="mi">45</span><span class="bp">%</span>     <span class="mi">6</span><span class="bp">.</span><span class="mi">44</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="n">mathport</span>              <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean</span><span class="o">::</span><span class="n">replace_rec_fn</span><span class="o">::</span><span class="n">apply</span>
            <span class="bp">|</span>
            <span class="c1">---lean::replace_rec_fn::apply</span>

     <span class="mi">6</span><span class="bp">.</span><span class="mi">11</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">01</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">asm_exc_page_fault</span>
            <span class="bp">|</span>
             <span class="c1">--6.10%--asm_exc_page_fault</span>
                       <span class="bp">|</span>
                        <span class="c1">--5.66%--exc_page_fault</span>

     <span class="mi">5</span><span class="bp">.</span><span class="mi">66</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">01</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">exc_page_fault</span>
            <span class="bp">|</span>
             <span class="c1">--5.65%--exc_page_fault</span>
                       <span class="bp">|</span>
                        <span class="c1">--5.61%--do_user_addr_fault</span>

     <span class="mi">5</span><span class="bp">.</span><span class="mi">61</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">02</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">do_user_addr_fault</span>
            <span class="bp">|</span>
             <span class="c1">--5.59%--do_user_addr_fault</span>
                       <span class="bp">|</span>
                        <span class="c1">--5.36%--handle_mm_fault</span>

     <span class="mi">5</span><span class="bp">.</span><span class="mi">36</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">05</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">handle_mm_fault</span>
            <span class="bp">|</span>
             <span class="c1">--5.31%--handle_mm_fault</span>

     <span class="mi">5</span><span class="bp">.</span><span class="mi">28</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">08</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">__handle_mm_fault</span>
            <span class="bp">|</span>
             <span class="c1">--5.20%--__handle_mm_fault</span>

     <span class="mi">5</span><span class="bp">.</span><span class="mi">24</span><span class="bp">%</span>     <span class="mi">5</span><span class="bp">.</span><span class="mi">23</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="n">mathport</span>              <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">l_Lean_mkApp</span>
            <span class="bp">|</span>
            <span class="c1">---l_Lean_mkApp</span>

     <span class="mi">5</span><span class="bp">.</span><span class="mi">18</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">02</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">handle_pte_fault</span>
            <span class="bp">|</span>
             <span class="c1">--5.16%--handle_pte_fault</span>

     <span class="mi">5</span><span class="bp">.</span><span class="mi">00</span><span class="bp">%</span>     <span class="mi">4</span><span class="bp">.</span><span class="mi">98</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="n">mathport</span>              <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_free_small</span>
            <span class="bp">|</span>
            <span class="c1">---lean_free_small</span>

     <span class="mi">4</span><span class="bp">.</span><span class="mi">77</span><span class="bp">%</span>     <span class="mi">4</span><span class="bp">.</span><span class="mi">73</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="n">mathport</span>              <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_alloc_small</span>
            <span class="bp">|</span>
            <span class="c1">---lean_alloc_small</span>

     <span class="mi">4</span><span class="bp">.</span><span class="mi">68</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">01</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">do_fault</span>
            <span class="bp">|</span>
             <span class="c1">--4.68%--do_fault</span>

     <span class="mi">4</span><span class="bp">.</span><span class="mi">68</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">do_read_fault</span>
            <span class="bp">|</span>
             <span class="c1">--4.67%--do_read_fault</span>

     <span class="mi">4</span><span class="bp">.</span><span class="mi">14</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">06</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">page_cache_ra_unbounded</span>
            <span class="bp">|</span>
             <span class="c1">--4.08%--page_cache_ra_unbounded</span>

     <span class="mi">3</span><span class="bp">.</span><span class="mi">91</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">__do_fault</span>
            <span class="bp">|</span>
             <span class="c1">--3.91%--__do_fault</span>
                       <span class="n">ext4_filemap_fault</span>

     <span class="mi">3</span><span class="bp">.</span><span class="mi">91</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">02</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">ext4_filemap_fault</span>
            <span class="bp">|</span>
             <span class="c1">--3.89%--ext4_filemap_fault</span>

     <span class="mi">3</span><span class="bp">.</span><span class="mi">88</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">04</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">filemap_fault</span>
            <span class="bp">|</span>
             <span class="c1">--3.84%--filemap_fault</span>

     <span class="mi">3</span><span class="bp">.</span><span class="mi">18</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="o">[</span><span class="n">kernel.kallsyms</span><span class="o">]</span>     <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="n">do_page_cache_ra</span>
            <span class="bp">|</span>
             <span class="c1">--3.18%--do_page_cache_ra</span>

     <span class="mi">3</span><span class="bp">.</span><span class="mi">01</span><span class="bp">%</span>     <span class="mi">2</span><span class="bp">.</span><span class="mi">78</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="n">mathport</span>              <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_name_eq</span>
            <span class="bp">|</span>
             <span class="c1">--3.00%--lean_name_eq</span>

     <span class="mi">2</span><span class="bp">.</span><span class="mi">72</span><span class="bp">%</span>     <span class="mi">2</span><span class="bp">.</span><span class="mi">72</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="n">mathport</span>              <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean</span><span class="o">::</span><span class="n">replace_cache</span><span class="o">::</span><span class="n">insert</span>
            <span class="bp">|</span>
            <span class="c1">---lean::replace_cache::insert</span>
</code></pre></div>



<a name="271015330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271015330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271015330">(Feb 07 2022 at 17:46)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>    <span class="mi">89</span><span class="bp">.</span><span class="mi">44</span><span class="bp">%</span>     <span class="mi">0</span><span class="bp">.</span><span class="mi">72</span><span class="bp">%</span>  <span class="n">mathport</span>  <span class="n">mathport</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_apply_1</span>
            <span class="bp">|</span>
             <span class="c1">--88.72%--lean_apply_1</span>
                       <span class="bp">|</span>
                        <span class="c1">--87.41%--lean::lean_io_as_task_fn</span>
                                  <span class="n">lean_apply_1</span>
                                  <span class="n">l_EIO_toBaseIO___rarg</span>
                                  <span class="n">lean_apply_1</span>
                                  <span class="bp">|</span>
                                   <span class="c1">--87.41%--l_Mathport_mathport1</span>
                                             <span class="n">l_Mathport_mathport1___lambda__3</span>
                                             <span class="n">l_Lean_withImportModules___rarg</span>
                                             <span class="bp">|</span>
                                             <span class="bp">|</span><span class="c1">--60.33%--lean_import_modules</span>
                                             <span class="bp">|</span>          <span class="n">l_Lean_profileitIOUnsafe___rarg</span>
                                             <span class="bp">|</span>          <span class="n">lean_profileit</span>
                                             <span class="bp">|</span>          <span class="n">lean_apply_1</span>
                                             <span class="bp">|</span>          <span class="n">l_Lean_profileitIOUnsafe___rarg___lambda__1___boxed</span>
                                             <span class="bp">|</span>          <span class="n">l_Lean_profileitIOUnsafe___rarg___lambda__1</span>
                                             <span class="bp">|</span>          <span class="n">lean_apply_1</span>
                                             <span class="bp">|</span>          <span class="n">l_Lean_withImporting___rarg</span>
                                             <span class="bp">|</span>          <span class="n">lean_apply_1</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>
                                             <span class="bp">|</span>          <span class="bp">|</span><span class="c1">--56.98%--lean_apply_2</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="n">l_Lean_importModules___lambda__3</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span><span class="c1">--43.81%--l___private_Lean_Environment_0__Lean_finalizePersistentExtensions_loop</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="n">lean_apply_3</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span><span class="c1">--39.13%--l_Lean_registerSimplePersistentEnvExtension___rarg___lambda__1___boxed</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="n">lean_apply_1</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span><span class="c1">--31.26%--l_Lean_mkStateFromImportedEntries___at_Mathport_initFn____x40_Mathport_Bridge_Rename___hyg_61____spec__2</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="n">l_Array_foldlMUnsafe_fold___at_Mathport_initFn____x40_Mathport_Bridge_Rename___hyg_61____spec__4</span>
                                             <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="n">l_Array_foldlMUnsafe_fold___at_Mathport_initFn____x40_Mathport_Bridge_Rename___hyg_61____spec__3</span>
</code></pre></div>



<a name="271015380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271015380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271015380">(Feb 07 2022 at 17:46)</a>:</h4>
<p>yeah, definitely not getting that</p>



<a name="271015438"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271015438" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271015438">(Feb 07 2022 at 17:47)</a>:</h4>
<p>I did get something close to that when profiling in gdb though</p>



<a name="271015643"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271015643" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271015643">(Feb 07 2022 at 17:48)</a>:</h4>
<p>there is a call to a profiling command <code>lean_profileit</code> in there? Did you do something on the lean side?</p>



<a name="271015788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271015788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271015788">(Feb 07 2022 at 17:49)</a>:</h4>
<p>That's interesting.  I didn't fiddle with the compiler options at all.  This is completely vanilla mathport master.  I've only set the <code>LEAN_CC=cc</code> environment variable.  And the <code>--call-graph dwarf,65528</code> option.</p>



<a name="271015975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271015975" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271015975">(Feb 07 2022 at 17:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Stack.20trace.20profiling/near/271015643">said</a>:</p>
<blockquote>
<p>there is a call to a profiling command <code>lean_profileit</code> in there? Did you do something on the lean side?</p>
</blockquote>
<p><a href="https://github.com/leanprover/lean4/blob/95aec2cf93762530a9c69dfc98c165a8b54238e2/src/Lean/Environment.lean#L615">https://github.com/leanprover/lean4/blob/95aec2cf93762530a9c69dfc98c165a8b54238e2/src/Lean/Environment.lean#L615</a></p>



<a name="271015981"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271015981" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271015981">(Feb 07 2022 at 17:50)</a>:</h4>
<p>I'm trying that now</p>



<a name="271016199"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271016199" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271016199">(Feb 07 2022 at 17:52)</a>:</h4>
<p>oh, the linker failed</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">error</span><span class="o">:</span> <span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="n">cannot</span> <span class="n">find</span> <span class="bp">-</span><span class="n">lc</span><span class="bp">++</span>
<span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="n">cannot</span> <span class="n">find</span> <span class="bp">-</span><span class="n">lc</span><span class="bp">++</span><span class="n">abi</span>
<span class="n">collect2</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">ld</span> <span class="n">returned</span> <span class="mi">1</span> <span class="n">exit</span> <span class="n">status</span>
</code></pre></div>



<a name="271016535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271016535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271016535">(Feb 07 2022 at 17:54)</a>:</h4>
<p>Oh, the nixpkgs wrapper (shell script around leanc) also adds an <code>-L</code> flag.  Not sure if there's an easy way to simulate that elsewhere (without replacing <code>leanc</code> by a shell script).</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="ch">#! /nix/store/a54wrar1jym1d8yvlijq0l2gghmy8szz-bash-5.1-p12/bin/bash</span>
<span class="nv">LEAN_CC</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">LEAN_CC</span><span class="k">:-</span><span class="p">/nix/store/xiq6j4jsyj351p8q3yw9cg1hdqp9m685-gcc-wrapper-10.3.0/bin/cc</span><span class="si">}</span><span class="s2">"</span> <span class="nb">exec</span> -a <span class="s2">"</span><span class="nv">$0</span><span class="s2">"</span> /home/gebner/.elan/toolchains/leanprover--lean4---nightly-2022-01-27/bin/leanc.orig <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span> -L /home/gebner/.elan/toolchains/leanprover--lean4---nightly-2022-01-27/lib  <span class="c1"># use bundled libraries, but not bundled compiler that doesn't know about NIX_LDFLAGS</span>
</code></pre></div>



<a name="271017603"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271017603" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271017603">(Feb 07 2022 at 18:00)</a>:</h4>
<p><span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> I added <code>"-L/home/mario/.elan/toolchains/leanprover--lean4---nightly-2022-02-06/lib"</code> to lake's <code>moreLinkArgs</code> and it worked and produced sensible perf output</p>



<a name="271018108"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271018108" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271018108">(Feb 07 2022 at 18:03)</a>:</h4>
<p>I'd really love to know how lld manages to screw this up... and why nobody else seems to mind</p>



<a name="271018265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/271018265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#271018265">(Feb 07 2022 at 18:04)</a>:</h4>
<p><code>-fuse-ld=ld</code> in the link args should also work btw. Maybe it needs a full path.</p>



<a name="307571524"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/307571524" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#307571524">(Nov 02 2022 at 16:55)</a>:</h4>
<p>I am unable to get any combination of flags working to profile a Lean-built executable using <code>nightly-2022-10-31</code>. My <code>lakefile.lean</code> is:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[default_target]</span>
<span class="n">lean_exe</span> <span class="n">checker</span> <span class="o">{</span>
  <span class="n">root</span> <span class="o">:=</span> <span class="bp">`</span><span class="n">Main</span>
  <span class="n">moreLeancArgs</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="s2">"-DNDEBUG"</span><span class="o">,</span> <span class="s2">"-O3"</span><span class="o">]</span>
  <span class="n">moreLinkArgs</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span>
    <span class="s2">"-fuse-ld=ld"</span><span class="o">,</span>
    <span class="s2">"-L/home/nawrocki/.elan/toolchains/leanprover--lean4---nightly-2022-10-31/lib"</span>
  <span class="o">]</span>
</code></pre></div>
<p>and I am using <code>perf record --call-graph dwarf ./build/bin/checker</code>. The output I get is "flat", i.e. has a bunch of <code>[unknown]</code>s like in Mario's original post.</p>



<a name="307572963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/307572963" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#307572963">(Nov 02 2022 at 17:01)</a>:</h4>
<p>I should say I also tried with <code>moreLeancArgs := #["-UNDEBUG", "-Og", "-ggdb", "-g3", "-fno-omit-frame-pointer"]</code> but it did not help.</p>



<a name="307577920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/307577920" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#307577920">(Nov 02 2022 at 17:23)</a>:</h4>
<p><a href="/user_uploads/3121/ncmiZ5o29s3A-6uN6E8j9JTd/Screenshot_20221102_102251.png">Screenshot_20221102_102251.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/ncmiZ5o29s3A-6uN6E8j9JTd/Screenshot_20221102_102251.png" title="Screenshot_20221102_102251.png"><img src="/user_uploads/3121/ncmiZ5o29s3A-6uN6E8j9JTd/Screenshot_20221102_102251.png"></a></div>



<a name="307579829"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/307579829" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#307579829">(Nov 02 2022 at 17:33)</a>:</h4>
<p>You didn't post the code you're benchmarking, but if you have deep recursions you can try to increase the size of the captured stack trace with <code>--call-graph dwarf,60000</code>.</p>



<a name="307587315"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Stack%20trace%20profiling/near/307587315" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Stack.20trace.20profiling.html#307587315">(Nov 02 2022 at 18:05)</a>:</h4>
<p>The code is <a href="https://github.com/rebryant/model-counting/tree/59fd27668c7b30d73e55400b749a2c93b0fd4760/lean4/ProofChecker">here</a> (note the lakefile doesn't have the leanc flags I only use those locally). However I was able to get it working on another machine; it seems that something is wrong with the setup on the other one, so <code>leanc</code> is not to blame.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>