---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html">functional but in place paradigm</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="223644050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223644050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Huỳnh Trần Khanh <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223644050">(Jan 22 2021 at 13:59)</a>:</h4>
<p>Does Lean 4 implement some sort of "functional but in-place" algorithm? That is the data structures are immutable to the user but they are mutated internally. Apologies if the terminology is not really correct.</p>



<a name="223644247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223644247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Huỳnh Trần Khanh <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223644247">(Jan 22 2021 at 14:01)</a>:</h4>
<p>because from what I've gathered pure functional programming programs can experience some sort of slowdown because of persistent data structures overhead</p>



<a name="223644421"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223644421" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Huỳnh Trần Khanh <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223644421">(Jan 22 2021 at 14:02)</a>:</h4>
<p>thanks in advance</p>



<a name="223644611"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223644611" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Marc Huisinga <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223644611">(Jan 22 2021 at 14:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="270523">Huỳnh Trần Khanh</span> <a href="#narrow/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm/near/223644050">said</a>:</p>
<blockquote>
<p>Does Lean 4 implement some sort of "functional but in-place" algorithm? That is the data structures are immutable to the user but they are mutated internally. Apologies if the terminology is not really correct.</p>
</blockquote>
<p>From what I can gather the terminology "functional but in-place" comes from a paper that was built right on top of <a href="https://arxiv.org/pdf/1908.05647.pdf">https://arxiv.org/pdf/1908.05647.pdf</a>, so yes</p>



<a name="223649171"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223649171" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Huỳnh Trần Khanh <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223649171">(Jan 22 2021 at 14:41)</a>:</h4>
<p>What does the <span aria-label="seedling" class="emoji emoji-1f331" role="img" title="seedling">:seedling:</span> emoji mean in this context <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<a name="223649293"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223649293" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Huỳnh Trần Khanh <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223649293">(Jan 22 2021 at 14:42)</a>:</h4>
<p>Immutable beans?</p>



<a name="223649295"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223649295" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223649295">(Jan 22 2021 at 14:42)</a>:</h4>
<p>I guess that <code>X</code> planted a seed for <code>Y</code>?</p>



<a name="223658881"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223658881" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jesse Michael Han <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223658881">(Jan 22 2021 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="270523">Huỳnh Trần Khanh</span> <a href="#narrow/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm/near/223649171">said</a>:</p>
<blockquote>
<p>What does the <span aria-label="seedling" class="emoji emoji-1f331" role="img" title="seedling">:seedling:</span> emoji mean in this context <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>
</blockquote>
<p>the immutable beans sprouted <span aria-label="sprout" class="emoji emoji-1f331" role="img" title="sprout">:sprout:</span></p>



<a name="223674612"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223674612" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223674612">(Jan 22 2021 at 17:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="270523">Huỳnh Trần Khanh</span> <a href="#narrow/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm/near/223644247">said</a>:</p>
<blockquote>
<p>because from what I've gathered pure functional programming programs can experience some sort of slowdown because of persistent data structures overhead</p>
</blockquote>
<p>I don't know the answer for Lean 4, but my understanding of modern data structures is that persistent data structures exactly "fixed" this performance problem in practice. I.e. old "immutable" data structures are indeed very expensive for copying, but persistent ones bring you terms that look mostly like O(log verygoodthing) for all the operations, and in practice say Clojure, where data structures are persistent, do just fine</p>



<a name="223674676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223674676" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223674676">(Jan 22 2021 at 17:47)</a>:</h4>
<p>(In Python I'm a big proponent of "use persistent data structures over the built in ones", and anecdotally that doesn't affect performance benchmarks for most real applications I've seen)</p>



<a name="223675072"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223675072" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223675072">(Jan 22 2021 at 17:50)</a>:</h4>
<p>Yeah looks like lean 4 has PersistentArray, PersistentHashSet...</p>



<a name="223675096"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223675096" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223675096">(Jan 22 2021 at 17:50)</a>:</h4>
<p>Lean implementations of them too interesting...</p>



<a name="223724836"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/functional%20but%20in%20place%20paradigm/near/223724836" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Huỳnh Trần Khanh <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/functional.20but.20in.20place.20paradigm.html#223724836">(Jan 23 2021 at 01:47)</a>:</h4>
<p><span class="user-mention" data-user-id="321696">@Julian Berman</span> Well, modern persistent data structures are fast when you need persistence!</p>
<blockquote>
<p>in practice say Clojure, where data structures are persistent, do just fine</p>
</blockquote>
<p>Yeah. Most applications aren't CPU bound, they are usually IO bound. And persistent data structures incur a very small or I'd say negligible overhead for those applications. Defensive copying is the root of most performance problems for these types of apps.</p>
<blockquote>
<p>that look mostly like O(log verygoodthing)</p>
</blockquote>
<p>Yeah, for HAMTs it's like 6 steps for every lookup/mutate operation when there are like 2 to the 64 elements.</p>
<p>As a (retired) competitive programmer, I can implement a persistent binary tree in 7 minutes. Because I'm trained to do that. The easiest way to implement persistence is refcounting everything, and I'd imagine that it'd be easier in a functional programming language. There are more crafty approaches, I read somewhere on the internet that an array can be made persistent in a way that operations cost O(log log n) time. That's pretty close to constant time.</p>
<p>But asymptotic time complexity is not everything. After all, you need a computer to execute an algorithm, an algorithm can't run itself. Persistence means a lot of pointer chasing, cache line fills and whatnot, and when it comes to compute-heavy programs the slowdown can be fatal. Programming competitions usually limit program runtime to something like 1 second or even one fifth of a second. Performance is critical. Every nanosecond counts. Abusing 64 bit integers can lead to TLE (time limit exceeded). If you make too many syscalls, you can get TLE too. Because the sandbox checks every syscall to make sure the syscalls won't do something wonky to the judging servers. And using STL binary trees (map and set) can inflate program runtime tenfold <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> Or even two orders of magnitude if you happen to be unlucky. Avoiding cache line fills is really important.</p>
<p>There are circumstances where performance is really critical and mandatory persistence is pretty much inappropriate.</p>
<p>Anyway, it's nice to hear that Lean 4 does optimize copying into in-place mutation.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>