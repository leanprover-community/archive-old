---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Another.20IO.20Task.20question.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html">Another IO Task question</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="249932825"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249932825" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249932825">(Aug 19 2021 at 01:57)</a>:</h4>
<p>Is there a more efficient way to perform a <code>(t : IO (Task a)) -&gt; IO a</code> conversion than <code>t &gt;&gt;= IO.wait</code>? As, unless I am mistaken, that spawns a thread and then has the main thread wait on it and is thus much less efficient than just executing the task in the main thread.</p>



<a name="249932895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249932895" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249932895">(Aug 19 2021 at 01:58)</a>:</h4>
<p>isn't the existence of a <code>Task a</code> already committing to the task existing on its own thread?</p>



<a name="249932937"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249932937" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249932937">(Aug 19 2021 at 01:59)</a>:</h4>
<p>that is, <code>Task a</code> is the type of potentially already-started computations returning a value of type <code>a</code></p>



<a name="249933063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933063">(Aug 19 2021 at 02:01)</a>:</h4>
<p>if you want a task that has not yet been started you can use the type <code>IO a</code> instead of <code>Task a</code>. <code>IO (IO a) -&gt; IO a</code> can be done without fork join</p>



<a name="249933154"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933154" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933154">(Aug 19 2021 at 02:02)</a>:</h4>
<p>I am actually not sure about this. The docs for <code>IO.asTask</code> sounds like what you said could be possible. However, I would think that <code>IO (Task a)</code> would spawn a Task when the monad is unpacked (ex, via bind), not immediately. Having a <code>Task a</code> around outside a monad definitely does mean what you said, though.</p>



<a name="249933215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933215" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933215">(Aug 19 2021 at 02:03)</a>:</h4>
<p>well, in an <code>IO (Task a)</code> we don't actually know if the task has been started or not. It might as well be <code>pure t</code> where <code>t : Task a</code> is currently running on another thread</p>



<a name="249933294"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933294" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933294">(Aug 19 2021 at 02:04)</a>:</h4>
<p>in any case, the only thing we can do with such a value is run it (on some thread) to get a <code>Task a</code> of unknown provenance</p>



<a name="249933349"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933349" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933349">(Aug 19 2021 at 02:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249933215">said</a>:</p>
<blockquote>
<p>well, in an <code>IO (Task a)</code> we don't actually know if the task has been started or not. It might as well be <code>pure t</code> where <code>t : Task a</code> is currently running on another thread</p>
</blockquote>
<p>I am not sure how legal what you are saying is. As the <code>IO (Task a)</code>  generated by <code>pure t</code> is a very different kind of task than the one generated by <code>IO.asTask</code>.</p>



<a name="249933405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933405">(Aug 19 2021 at 02:06)</a>:</h4>
<p>That said, in the internals of <code>Task</code> one can presumably say what state the task is in and where it is running, so <code>IO.wait</code> can probably avoid the overhead if it sees the task is already complete</p>



<a name="249933443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933443">(Aug 19 2021 at 02:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249933349">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249933215">said</a>:</p>
<blockquote>
<p>well, in an <code>IO (Task a)</code> we don't actually know if the task has been started or not. It might as well be <code>pure t</code> where <code>t : Task a</code> is currently running on another thread</p>
</blockquote>
<p>I am not sure how legal what you are saying is. As the <code>IO (Task a)</code>  generated by <code>pure t</code> is a very different kind of task than the one generated by <code>IO.asTask</code>.</p>
</blockquote>
<p>That's true, but my point is they have the same type, so any function accepting one has to be prepared to deal with the other</p>



<a name="249933544"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933544" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933544">(Aug 19 2021 at 02:09)</a>:</h4>
<p>true, but all these functions are <code>constant</code> so they aren't really listening to the type system. My point is that there could be an <code>IO.join</code> that inspects the task internals and notices it has yet to be started and instead just invokes the closure rather than spawning the task. (For already spawned tasks it just waits on them.)</p>



<a name="249933555"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933555" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933555">(Aug 19 2021 at 02:09)</a>:</h4>
<p>are you sure it isn't already doing that?</p>



<a name="249933614"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933614" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933614">(Aug 19 2021 at 02:10)</a>:</h4>
<p>There isn't a function that I know of that could do this.</p>



<a name="249933621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933621">(Aug 19 2021 at 02:10)</a>:</h4>
<p>I mean <code>IO.wait</code> could just do that</p>



<a name="249933630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933630" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933630">(Aug 19 2021 at 02:10)</a>:</h4>
<p>In <code>IO.wait</code> the object is a pure <code>Task a</code> so it  is definitely already spawned.</p>



<a name="249933736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933736">(Aug 19 2021 at 02:13)</a>:</h4>
<p>If <code>Task</code>s are definitely already started, then I don't think there is any type that represents both not started and started tasks, so the type signature will determine already whether it needs to be on another thread or not</p>



<a name="249933805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933805">(Aug 19 2021 at 02:14)</a>:</h4>
<p>After looking at the internals, since an IO object is just a closure and invoking the closure starts the task. Since there is no way inspect into the closure / inform it to not spawn the task, I guess this is, in fact, impossible.</p>



<a name="249933829"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933829" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933829">(Aug 19 2021 at 02:15)</a>:</h4>
<p>right, a <code>IO (Task a)</code> is just a function that returns an already spawned task, there isn't any point to intercept it</p>



<a name="249933842"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933842" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933842">(Aug 19 2021 at 02:15)</a>:</h4>
<p>:(</p>



<a name="249933906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933906" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933906">(Aug 19 2021 at 02:16)</a>:</h4>
<p>What's the motivation? Why would you not know whether the task is started or not?</p>



<a name="249933917"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933917" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933917">(Aug 19 2021 at 02:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249933829">said</a>:</p>
<blockquote>
<p>right, a <code>IO (Task a)</code> is just a function that returns an already spawned task, there isn't any point to intercept it</p>
</blockquote>
<p>Not that it does necessarily return an <em>already spawned</em> task. The function itself be the thing the spawns the task (as it is in <code>IO.asTask</code>'s case).</p>



<a name="249933931"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933931" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933931">(Aug 19 2021 at 02:17)</a>:</h4>
<p>sure, but it can do that at any point in the function and you aren't instrumenting the code</p>



<a name="249933935"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933935" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933935">(Aug 19 2021 at 02:17)</a>:</h4>
<p>by the time the function returns, the task is started. Before the function is called, it may or may not be started (it doesn't even really exist as a thing yet)</p>



<a name="249933980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933980">(Aug 19 2021 at 02:18)</a>:</h4>
<p>so this isn't a type that does what you want</p>



<a name="249933987"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933987" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933987">(Aug 19 2021 at 02:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249933906">said</a>:</p>
<blockquote>
<p>What's the motivation? Why would you not know whether the task is started or not?</p>
</blockquote>
<p>In Lake, build tasks are IO actions that may be run asynchronously, thus I have to choose between representing them as <code>IO a</code> or <code>IO (IOTask a)</code>.</p>



<a name="249933999"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249933999" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249933999">(Aug 19 2021 at 02:18)</a>:</h4>
<p>The former is inefficient in the case of asynchronous tasks, the later is inefficient in the case of synchronous tasks.</p>



<a name="249934021"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934021" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934021">(Aug 19 2021 at 02:19)</a>:</h4>
<p>How about <code>IO (IO a)</code> then? The idea is you execute in the outer IO if you want it to run immediately and in the inner IO if you want to allow it to be scheduled flexibly</p>



<a name="249934074"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934074" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934074">(Aug 19 2021 at 02:20)</a>:</h4>
<p>this assumes that build tasks can decide for themselves which category they want to be in</p>



<a name="249934080"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934080" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934080">(Aug 19 2021 at 02:20)</a>:</h4>
<p>How does that help?</p>



<a name="249934086"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934086" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934086">(Aug 19 2021 at 02:20)</a>:</h4>
<p>More accurately, how are you proposing to represent them as <code>IO (IO a)</code>?</p>



<a name="249934170"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934170" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934170">(Aug 19 2021 at 02:22)</a>:</h4>
<p>I don't understand the question. Build tasks have that type, they return whatever type <code>a</code> is behind two layers of IO, and you use <code>do ... pure (pure a)</code> for sync actions and <code>pure (do ... pure a)</code> for async actions</p>



<a name="249934203"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934203" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934203">(Aug 19 2021 at 02:23)</a>:</h4>
<p>and then the harness runs all the outer IOs to get a <code>List (IO a)</code> or whatever the data structure is and puts them in a thread pool or what have you</p>



<a name="249934261"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934261" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934261">(Aug 19 2021 at 02:24)</a>:</h4>
<p>Ah, this may be the key:</p>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249934074">said</a>:</p>
<blockquote>
<p>this assumes that build tasks can decide for themselves which category they want to be in</p>
</blockquote>
<p>Its exactly the opposite, the build manager is determining whether they are sync or async.</p>



<a name="249934278"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934278" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934278">(Aug 19 2021 at 02:24)</a>:</h4>
<p>Here the build manager gets to decide how to schedule the async parts, and the outer IO is for mandatory sync actions</p>



<a name="249934295"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934295" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934295">(Aug 19 2021 at 02:25)</a>:</h4>
<p>for a fully synchronous build manager you would just run both layers immediately</p>



<a name="249934366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934366" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934366">(Aug 19 2021 at 02:26)</a>:</h4>
<p>and an async build manager could go through the list and call <code>IO.asTask</code> on each one to get a list of tasks</p>



<a name="249934386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934386">(Aug 19 2021 at 02:27)</a>:</h4>
<p>or do that up to <code>numThreads</code> times and manage the parallelism</p>



<a name="249934388"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934388" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934388">(Aug 19 2021 at 02:27)</a>:</h4>
<p>I honestly am very confused about what you are describing.</p>



<a name="249934544"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934544" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934544">(Aug 19 2021 at 02:30)</a>:</h4>
<p>Currently, each build target has some task <code>IO PUnit</code> that builds the artifact. I can make this asynchronous by running <code>IO.asTask</code> to get an <code>IO (IOTask PUnit)</code> or I can just run this synchronously by using the monad itself. I fail to see how this can be usefully made into an <code>IO (IO PUnit)</code> action.</p>



<a name="249934592"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934592" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934592">(Aug 19 2021 at 02:31)</a>:</h4>
<p>That corresponds to the inner IO in my version. The outer IO is for things that have to be run on load time; if this is not necessary then <code>IO Unit</code> should suffice</p>



<a name="249934594"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934594" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934594">(Aug 19 2021 at 02:31)</a>:</h4>
<p>However, I will note that your suggestion of using <code>m (m a)</code> (ex. <code>IO (IO a))</code>) for asynchronous actions is what Haskell does, so if there was an efficient way of mirroring that in Lean, I would be all ears.</p>



<a name="249934686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934686" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934686">(Aug 19 2021 at 02:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249934592">said</a>:</p>
<blockquote>
<p>That corresponds to the inner IO in my version. The outer IO is for things that have to be run on load time; if this is not necessary then <code>IO Unit</code> should suffice</p>
</blockquote>
<p>So how is that different from what I am doing?</p>



<a name="249934809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934809" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934809">(Aug 19 2021 at 02:35)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">buildTask1</span> <span class="o">:</span> <span class="n">IO</span> <span class="o">(</span><span class="n">IO</span> <span class="n">Unit</span><span class="o">)</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="n">println</span><span class="bp">!</span> <span class="s2">"I always run immediately"</span>
  <span class="n">pure</span> <span class="k">do</span>
    <span class="n">println</span><span class="bp">!</span> <span class="s2">"I run when this task is scheduled"</span>

<span class="kd">def</span> <span class="n">buildTask2</span> <span class="o">:</span> <span class="n">IO</span> <span class="o">(</span><span class="n">IO</span> <span class="n">Unit</span><span class="o">)</span> <span class="o">:=</span> <span class="n">pure</span> <span class="o">(</span><span class="n">pure</span> <span class="o">())</span>


<span class="kd">def</span> <span class="n">buildManager</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="c1">-- run sync actions</span>
  <span class="k">let</span> <span class="n">ios</span> <span class="o">:</span> <span class="n">List</span> <span class="o">(</span><span class="n">IO</span> <span class="n">Unit</span><span class="o">)</span> <span class="bp">←</span> <span class="o">[</span><span class="n">buildTask1</span><span class="o">,</span> <span class="n">buildTask2</span><span class="o">]</span><span class="bp">.</span><span class="n">mapM</span> <span class="n">id</span>
  <span class="c1">-- split off the first task, because we want to run it on the main thread</span>
  <span class="k">let</span> <span class="n">io1</span> <span class="o">::</span> <span class="n">ios</span> <span class="bp">←</span> <span class="n">ios</span> <span class="bp">|</span> <span class="n">panic</span><span class="bp">!</span> <span class="s2">""</span>
  <span class="c1">-- start async actions in parallel</span>
  <span class="k">let</span> <span class="n">tasks</span> <span class="bp">←</span> <span class="n">ios.mapM</span> <span class="n">IO.asTask</span>
  <span class="c1">-- Run the first task on the main thread</span>
  <span class="k">let</span> <span class="n">result1</span> <span class="bp">←</span> <span class="n">io1</span>
  <span class="c1">-- block on the async tasks</span>
  <span class="k">let</span> <span class="n">results</span> <span class="bp">←</span> <span class="n">tasks.mapM</span> <span class="n">IO.wait</span>
  <span class="c1">-- do something with results</span>
</code></pre></div>



<a name="249934888"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934888" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934888">(Aug 19 2021 at 02:37)</a>:</h4>
<p>Again, in Lake there is no 'I always run immediately', there is only 'I run when the task is scheduled' in build tasks.</p>



<a name="249934894"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934894" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934894">(Aug 19 2021 at 02:37)</a>:</h4>
<p>which just reduces this example to what I already have.</p>



<a name="249934895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934895" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934895">(Aug 19 2021 at 02:37)</a>:</h4>
<p>Without the outer IO, the only difference is that the first line is just <code>let ios : List (IO Unit) := [buildTask1, buildTask2]</code></p>



<a name="249934899"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934899" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934899">(Aug 19 2021 at 02:37)</a>:</h4>
<p>you still have flexibility in when to schedule things</p>



<a name="249934956"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934956" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934956">(Aug 19 2021 at 02:38)</a>:</h4>
<p>I'm not sure how you want to determine what to run where though</p>



<a name="249934970"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934970" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934970">(Aug 19 2021 at 02:38)</a>:</h4>
<p>The problem is that a build task A may or may not wish to build other things and it may want to do so asynchronously. If it does,  it is now left with a <code>IOTask</code> instead of an <code>IO</code>, so it has to wait on it to covert into an <code>IO</code>. However, a build task B may then choose to to ran A asynchronously as well, which means I end up be with a dead thread (as it reduces to essentially `IO.asTask (IO.wait t)).</p>



<a name="249934998"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249934998" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249934998">(Aug 19 2021 at 02:39)</a>:</h4>
<p>Do you want task B to call task A directly, or ask the build manager to do it?</p>



<a name="249935048"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935048" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935048">(Aug 19 2021 at 02:40)</a>:</h4>
<p>task B calls A directly (in the current implementation)</p>



<a name="249935070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935070">(Aug 19 2021 at 02:40)</a>:</h4>
<p>So is the asynchrony because task B has something else to do while A runs?</p>



<a name="249935087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935087">(Aug 19 2021 at 02:41)</a>:</h4>
<p>yes, task <em>A</em> or <em>B</em> may depending on 10 different tasks, so it wants to build them all asynchronously.</p>



<a name="249935090"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935090" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935090">(Aug 19 2021 at 02:41)</a>:</h4>
<p>because if it's just creating the task and waiting on it immediately then that's obviously useless</p>



<a name="249935153"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935153" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935153">(Aug 19 2021 at 02:42)</a>:</h4>
<p>okay, so it can just do that then, right? It just starts all the tasks, and waits on all the results</p>



<a name="249935192"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935192" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935192">(Aug 19 2021 at 02:43)</a>:</h4>
<p>Yes, but A already does that, so B is now waiting on A's thread which is waiting on its own dependency's threads.</p>



<a name="249935198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935198">(Aug 19 2021 at 02:43)</a>:</h4>
<p>shouldn't B be waiting on A?</p>



<a name="249935202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935202">(Aug 19 2021 at 02:43)</a>:</h4>
<p>yep, typo -- fixed.</p>



<a name="249935280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935280" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935280">(Aug 19 2021 at 02:44)</a>:</h4>
<p>okay so where's the problem? If B wants to run A on its own thread it can do so</p>



<a name="249935300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935300" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935300">(Aug 19 2021 at 02:45)</a>:</h4>
<p>But that's the problem since A is a collection of asynchronous tasks, spawning it on new thread is silly.</p>



<a name="249935316"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935316" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935316">(Aug 19 2021 at 02:45)</a>:</h4>
<p>So then B can not run it async</p>



<a name="249935322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935322">(Aug 19 2021 at 02:45)</a>:</h4>
<p>And therein lies the problem, how is B to know which to do?</p>



<a name="249935374"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935374" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935374">(Aug 19 2021 at 02:46)</a>:</h4>
<p>how is anything to know which to do?</p>



<a name="249935388"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935388" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935388">(Aug 19 2021 at 02:46)</a>:</h4>
<p>Exactly, hence my problem.</p>



<a name="249935395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935395">(Aug 19 2021 at 02:46)</a>:</h4>
<p>what's the ideal decision procedure here</p>



<a name="249935414"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935414" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935414">(Aug 19 2021 at 02:47)</a>:</h4>
<p>it's certainly harder from B's myopic point of view, but even from a global view I'm not sure what you want to do about it</p>



<a name="249935431"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935431" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935431">(Aug 19 2021 at 02:47)</a>:</h4>
<p>What B would like to do is, if A is a collection of async tasks, add them to the async queue. Otherwise, run it as a new thread (and add it to the queue).</p>



<a name="249935439"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935439" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935439">(Aug 19 2021 at 02:47)</a>:</h4>
<p>if you want to be able to make global decisions here, though, you should probably have B not call A directly and use the build manager as middle man</p>



<a name="249935503"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935503" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935503">(Aug 19 2021 at 02:48)</a>:</h4>
<p>I don't really want a global decision here. This mostly a decision on the intersection point.</p>



<a name="249935510"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935510" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935510">(Aug 19 2021 at 02:48)</a>:</h4>
<p>Can A have some metadata saying "I am a collection of async tasks"? Then the library can provide a function which is "run async if this is a sync action, and run sync if this is a collection of async actions"</p>



<a name="249935624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935624" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935624">(Aug 19 2021 at 02:50)</a>:</h4>
<p>you can make the setting of that flag less error prone by having a special constructor for "aggregate tasks"</p>



<a name="249935629"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935629" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935629">(Aug 19 2021 at 02:50)</a>:</h4>
<p>Yeah, I was probably being a little to narrow minded. I could just use a new monad that is either an <code>IO</code> or an <code>IO (IOTask a)</code>. I was just trying to get away with just using <code>IO</code>.</p>



<a name="249935659"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935659" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935659">(Aug 19 2021 at 02:51)</a>:</h4>
<p>well, in my version it's still just an <code>IO a</code>, or rather <code>(IO a) x Bool</code></p>



<a name="249935719"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935719" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935719">(Aug 19 2021 at 02:52)</a>:</h4>
<p>I don't think <code>IO (IOTask a)</code> is helpful, that's for already started tasks so it is more appropriate as the return type of library functions</p>



<a name="249935762"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935762" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935762">(Aug 19 2021 at 02:53)</a>:</h4>
<p><code>IO (IOTask a)</code> is an <code>IOTask</code> spawner -- it is not for already started tasks.</p>



<a name="249935783"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935783" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935783">(Aug 19 2021 at 02:53)</a>:</h4>
<p>Though you can of course inject an already existing task with <code>pure</code>.</p>



<a name="249935787"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935787" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935787">(Aug 19 2021 at 02:53)</a>:</h4>
<p>well yes, but when would a build task ever want to have a type like that?</p>



<a name="249935834"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935834" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935834">(Aug 19 2021 at 02:54)</a>:</h4>
<p>when it can just return the result</p>



<a name="249935846"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935846" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935846">(Aug 19 2021 at 02:54)</a>:</h4>
<p>unless you are interested in the inner/outer IO approach from before</p>



<a name="249935861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935861" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935861">(Aug 19 2021 at 02:54)</a>:</h4>
<p>If the task is just a collection  of asynchronous tasks (or a collection + a post-completion action)?</p>



<a name="249935911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935911" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935911">(Aug 19 2021 at 02:56)</a>:</h4>
<p>I should probably be using <code>IO Unit</code>/<code>IOTask PUnit</code> more to make it clearer that <code>a</code> is not a result in this system.</p>



<a name="249935965"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935965" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935965">(Aug 19 2021 at 02:56)</a>:</h4>
<p>A collection of asynchronous tasks could have type <code>List (IO a)</code>, i.e. literally a collection</p>



<a name="249935975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249935975" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249935975">(Aug 19 2021 at 02:56)</a>:</h4>
<p>I was wondering about that; this is a lot harder if you want to be type parametric</p>



<a name="249936013"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936013" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936013">(Aug 19 2021 at 02:57)</a>:</h4>
<p>so the monad might be <code>Sum (IO a) (List (IO a))</code></p>



<a name="249936053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936053">(Aug 19 2021 at 02:58)</a>:</h4>
<p>well, there are some decisions to be made about when a task becomes a collection and vice versa</p>



<a name="249936084"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936084" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936084">(Aug 19 2021 at 02:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249935965">said</a>:</p>
<blockquote>
<p>A collection of asynchronous tasks could have type <code>List (IO a)</code>, i.e. literally a collection</p>
</blockquote>
<p>I assume you mean <code>Array (IOTask a)</code>. That is fine if it just a collection. However, if it is a collection and then an action, then it is not.</p>



<a name="249936089"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936089" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936089">(Aug 19 2021 at 02:58)</a>:</h4>
<p>not <code>IOTask</code>, <code>IO</code></p>



<a name="249936098"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936098" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936098">(Aug 19 2021 at 02:58)</a>:</h4>
<p>That would be a collection of synchronous actions, not asynchronous tasks.</p>



<a name="249936105"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936105" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936105">(Aug 19 2021 at 02:58)</a>:</h4>
<p>It is a collection of not-yet-started tasks</p>



<a name="249936120"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936120" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936120">(Aug 19 2021 at 02:59)</a>:</h4>
<p>you use <code>IO.asTask</code> to start them</p>



<a name="249936131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936131">(Aug 19 2021 at 02:59)</a>:</h4>
<p>In this case they are already started though.</p>



<a name="249936310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936310">(Aug 19 2021 at 03:01)</a>:</h4>
<p>The advantage of waiting to start the tasks until you have the complete collection is that you get more parallelism</p>



<a name="249936347"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936347" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936347">(Aug 19 2021 at 03:02)</a>:</h4>
<p>A build target <code>A </code>often comes with the a list of additional targets <code>Bs</code> as dependencies. Each as a <code>task</code> field that, when run, will materialize the target. The build target <code>A</code>'s <code>task</code> will run these tasks and (after they are finished) perform its own build.</p>



<a name="249936428"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936428" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936428">(Aug 19 2021 at 03:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249936310">said</a>:</p>
<blockquote>
<p>The advantage of waiting to start the tasks until you have the complete collection is that you get more parallelism</p>
</blockquote>
<p>You often can't do this because the task itself might determine which tasks to run.</p>



<a name="249936536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936536" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936536">(Aug 19 2021 at 03:04)</a>:</h4>
<p>In building a Lean module, for example, we learn which tasks to run by reading the imports and we only want to run the task once for the same import. Thus we determine which module tasks are built while building.</p>



<a name="249936636"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936636" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936636">(Aug 19 2021 at 03:06)</a>:</h4>
<p>With the <code>Sum (IO Unit) (List (IO Unit))</code>monad, there are two ways to implement <code>A.task</code>. If it has a lot of additional work to do, then it chooses the first variant: it has to implement an <code>IO Unit</code>, which runs <code>runMany Bs</code> for the list of tasks <code>Bs</code>, gets the results, and does what it needs to do. If it has nothing to do besides aggregating the <code>Bs</code>, then it calls <code>collect Bs</code> which produces the <code>List (IO Unit)</code> variant by concatenating all the subtasks in the Bs</p>



<a name="249936785"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249936785" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249936785">(Aug 19 2021 at 03:09)</a>:</h4>
<p>The most common cases for build tasks, imo, are the following: </p>
<ul>
<li>Do nothing, the file is an input</li>
<li>Build something (ideally synchronously) and then perform an action (ex. building a <code>.o</code> file)</li>
<li>Build many things (ideally asynchronously) and then perform an action (ex. building a static/shared library)</li>
<li>Do something heavily complex (i.e., intermingle building and determining which things to build)</li>
</ul>



<a name="249937000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937000">(Aug 19 2021 at 03:13)</a>:</h4>
<p>In all of those examples, you already know whether you are async or sync</p>



<a name="249937011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937011">(Aug 19 2021 at 03:13)</a>:</h4>
<p>and <code>IO Unit</code> already handles those cases</p>



<a name="249937068"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937068" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937068">(Aug 19 2021 at 03:14)</a>:</h4>
<p>Yes the task itself knows whether it wants to be synchronous or asynchronous. However, it does not know whether its dependents do.</p>



<a name="249937079"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937079" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937079">(Aug 19 2021 at 03:14)</a>:</h4>
<p>it knows whether it wants to run its direct children on the same thread or not</p>



<a name="249937121"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937121" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937121">(Aug 19 2021 at 03:15)</a>:</h4>
<p>Yes, but it doesn't know whether its direct children are run on the same thread or not.</p>



<a name="249937126"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937126" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937126">(Aug 19 2021 at 03:15)</a>:</h4>
<p>Options 1 and 2 are synchronous build tasks, options 3 and 4 are asynchronous tasks.</p>



<a name="249937131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937131">(Aug 19 2021 at 03:15)</a>:</h4>
<p>if it is responsible for starting the children then it can do so</p>



<a name="249937191"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937191" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937191">(Aug 19 2021 at 03:16)</a>:</h4>
<p>It is only necessarily responsible for finishing its dependents, not starting them.</p>



<a name="249937278"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937278" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937278">(Aug 19 2021 at 03:18)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">doNothing</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span> <span class="o">:=</span> <span class="n">pure</span> <span class="o">()</span>

<span class="kd">def</span> <span class="n">buildSyncThen</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span><span class="o">)</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span> <span class="o">:=</span> <span class="n">a</span> <span class="bp">*&gt;</span> <span class="n">b</span>

<span class="kd">def</span> <span class="n">buildAsyncThen</span> <span class="o">(</span><span class="n">as</span> <span class="o">:</span> <span class="n">List</span> <span class="o">(</span><span class="n">IO</span> <span class="n">Unit</span><span class="o">))</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span><span class="o">)</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">as</span> <span class="bp">←</span> <span class="n">as.mapM</span> <span class="n">IO.asTask</span>
  <span class="k">let</span> <span class="n">_</span> <span class="bp">←</span> <span class="n">as.mapM</span> <span class="n">IO.wait</span>
  <span class="n">b</span>

<span class="kd">def</span> <span class="n">doSomethingElse</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">IO</span> <span class="o">(</span><span class="n">List</span> <span class="o">(</span><span class="n">IO</span> <span class="n">Unit</span><span class="o">)))</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">as</span> <span class="bp">←</span> <span class="n">f</span>
  <span class="n">buildAsyncThen</span> <span class="n">as</span> <span class="o">()</span>
</code></pre></div>



<a name="249937345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937345">(Aug 19 2021 at 03:20)</a>:</h4>
<p>Your <code>buildAsyncThen</code> is very inefficient if spawned asynchronously. It spawns a thread that does nothing but wait until it is dependents are finished.</p>



<a name="249937386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937386">(Aug 19 2021 at 03:20)</a>:</h4>
<p>That's what the collection thing was about</p>



<a name="249937405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937405">(Aug 19 2021 at 03:21)</a>:</h4>
<p>if you keep metadata on the tasks to be able to say which ones are "heavy" and which are "light" then you can avoid spawning threads for light tasks</p>



<a name="249937429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937429">(Aug 19 2021 at 03:21)</a>:</h4>
<p>if <code>b</code> is heavy then <code>buildAsyncThen</code> might not be so useless</p>



<a name="249937485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937485">(Aug 19 2021 at 03:22)</a>:</h4>
<p>It still is, because before it does b it is just a thread that is sitting around doing nothing.</p>



<a name="249937501"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937501" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937501">(Aug 19 2021 at 03:23)</a>:</h4>
<p>really, I think you need a green threads implementation</p>



<a name="249937517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937517" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937517">(Aug 19 2021 at 03:23)</a>:</h4>
<p>In fact, isn't <code>Task</code> doing that already?</p>



<a name="249937521"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937521" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937521">(Aug 19 2021 at 03:23)</a>:</h4>
<p>I'm not sure that these are actually system threads</p>



<a name="249937586"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937586" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937586">(Aug 19 2021 at 03:24)</a>:</h4>
<p>For example, consider: <code>buildAsyncThen [buildAsyncThen [...] a1, ...., buildAsyncThen [...] a10] b</code>. The outer <code>buildAsyncThen</code> spawns 10 threads that wait for the inner tasks to complete and if those tasks are complex they may be sitting around for a while eating up the thread pool doing nothing.</p>



<a name="249937631"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937631" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937631">(Aug 19 2021 at 03:26)</a>:</h4>
<p>In that case you might want something like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">BuildTask</span> <span class="n">where</span>
  <span class="n">deps</span> <span class="o">:</span> <span class="n">Array</span> <span class="o">(</span><span class="n">IO</span> <span class="n">Unit</span><span class="o">)</span>
  <span class="n">main</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span>
</code></pre></div>
<p>then <code>buildAsyncThen</code> is a combinator that combines the deps</p>



<a name="249937678"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937678" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937678">(Aug 19 2021 at 03:26)</a>:</h4>
<p>These are the reasons <code>IO.mapTask</code>/<code>IO.mapTasks</code>/<code>IO.bindTask</code> exist, specifically  to avoid creating such threads.</p>



<a name="249937699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937699" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937699">(Aug 19 2021 at 03:27)</a>:</h4>
<p>See Sebastian's comment on my previous IO Task question: <a href="#narrow/stream/270676-lean4/topic/.E2.9C.94.20IO.20Tasks/near/248579994">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/.E2.9C.94.20IO.20Tasks/near/248579994</a></p>



<a name="249937762"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937762" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937762">(Aug 19 2021 at 03:28)</a>:</h4>
<p>Also see Wojciech's comment below that where he explains that consuming the thread pool can actually lead to deadlock (and no tasks completing).</p>



<a name="249937792"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937792" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937792">(Aug 19 2021 at 03:29)</a>:</h4>
<p>Thus, things that lead to <code>IO.asTask (IO.wait task *&gt; something)</code> have to be avoid like the plague.</p>



<a name="249937897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937897" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937897">(Aug 19 2021 at 03:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249937631">said</a>:</p>
<blockquote>
<p>In that case you might want something like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">BuildTask</span> <span class="n">where</span>
  <span class="n">deps</span> <span class="o">:</span> <span class="n">Array</span> <span class="o">(</span><span class="n">IO</span> <span class="n">Unit</span><span class="o">)</span>
  <span class="n">main</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span>
</code></pre></div>
<p>then <code>buildAsyncThen</code> is a combinator that combines the deps</p>
</blockquote>
<p>This can't be done for the reason I already described. There are build tasks that don't know their dependencies until <code>main</code> is run.</p>



<a name="249937911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249937911" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249937911">(Aug 19 2021 at 03:30)</a>:</h4>
<p>It would be great if there was a version of <code>IO.asTask</code> that yielded a <code>TaskBuilder</code> which you can use to construct a dependency graph with map/bind before starting it</p>



<a name="249938001"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938001" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938001">(Aug 19 2021 at 03:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249937897">said</a>:</p>
<blockquote>
<p>This can't be done for the reason I already described. There are build tasks that don't know their dependencies until <code>main</code> is run.</p>
</blockquote>
<p>For tasks like that you would just have empty deps</p>



<a name="249938012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938012" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938012">(Aug 19 2021 at 03:33)</a>:</h4>
<p>they would just start their deps directly inside <code>main</code></p>



<a name="249938031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938031" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938031">(Aug 19 2021 at 03:33)</a>:</h4>
<p>the deps represent dependencies known in advance, which can be used to aggregate the leaves in your nested <code>buildAsyncThen</code> example</p>



<a name="249938078"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938078" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938078">(Aug 19 2021 at 03:34)</a>:</h4>
<p>So then what is the point of the deps then?</p>



<a name="249938086"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938086" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938086">(Aug 19 2021 at 03:34)</a>:</h4>
<p>for dependencies that need to be computed first, there is nothing for it but to run the action and tie up a thread</p>



<a name="249938091"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938091" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938091">(Aug 19 2021 at 03:34)</a>:</h4>
<p>Sorry, I wrote that before I read your last response.</p>



<a name="249938101"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938101" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938101">(Aug 19 2021 at 03:35)</a>:</h4>
<p>The problem with the Lean build system is that all the simple tasks depend on the big complex task that can't be represented as an IO.</p>



<a name="249938111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938111">(Aug 19 2021 at 03:35)</a>:</h4>
<p>what can't be represented as IO?</p>



<a name="249938118"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938118" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938118">(Aug 19 2021 at 03:35)</a>:</h4>
<p>The package build.</p>



<a name="249938174"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938174" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938174">(Aug 19 2021 at 03:36)</a>:</h4>
<p>why?</p>



<a name="249938179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938179">(Aug 19 2021 at 03:36)</a>:</h4>
<p>Building o files, the static lib, and the exe are simple tasks but they don't know what files to build until the package build has been computed and launched.</p>



<a name="249938263"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249938263" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249938263">(Aug 19 2021 at 03:38)</a>:</h4>
<p>The package build returns a <code>NameMap</code> of modules to their associated active build target / task which the rest (i.e., the o files, static lib, and exe) use to know what to build and what to depend on.</p>



<a name="249960051"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Another%20IO%20Task%20question/near/249960051" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Another.20IO.20Task.20question.html#249960051">(Aug 19 2021 at 09:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Another.20IO.20Task.20question/near/249933544">said</a>:</p>
<blockquote>
<p>My point is that there could be an <code>IO.join</code> that inspects the task internals and notices it has yet to be started and instead just invokes the closure rather than spawning the task. (For already spawned tasks it just waits on them.)</p>
</blockquote>
<p>I didn't read the whole thread, but I just wanted to say this proposal here is a terrible idea because it executes the task with a nondeterministic (and potentially very small) stack size.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>