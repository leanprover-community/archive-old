---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Metaprogramming.20tutorial.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html">Metaprogramming tutorial</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="272248185"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272248185" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272248185">(Feb 17 2022 at 11:54)</a>:</h4>
<p>I've been meaning to write a tutorial about Lean 4 metaprogramming. This would give an overview of the major metaprogramming concepts, to help people get started. To keep the scope somewhat reasonable, I don't want to dive into specifics of the API, so it's not going to be a cookbook.</p>
<p>To begin (and also to force myself to actually do it), can I get some help brainstorming what should go into such an overview? What I have so far:</p>
<ul>
<li>expressions<ul>
<li>Expr; overview of what each constructor stands for</li>
<li>smart constructors</li>
<li>locally nameless representation; <code>forallTelescope</code> and friends</li>
<li>implicit arguments, app builder (<code>mkAppM</code> etc.)</li>
<li>matching on expressions</li>
<li>normalisation, transparency</li>
<li>discrimination trees</li>
</ul>
</li>
<li>monad stacks<ul>
<li><code>ReaderT</code>, <code>StateRefT</code></li>
<li><code>MonadError</code>, <code>MonadBacktrack</code> etc.</li>
</ul>
</li>
<li><code>CoreM</code><ul>
<li>the environment</li>
</ul>
</li>
<li><code>MetaM</code><ul>
<li>metavariables, assignment, types of metavariables</li>
<li>metavariables as goals</li>
<li>local contexts, <code>withMVarContext</code></li>
</ul>
</li>
<li><code>Syntax</code><ul>
<li>syntax declarations, syntax categories (+ <code>behavior</code>)</li>
<li>syntax quotations (matching + construction)</li>
</ul>
</li>
<li>elaboration<ul>
<li><code>TermElabM</code> etc.</li>
<li>elaboration attributes (for commands, tactics)</li>
<li>postponed metas</li>
<li>macros</li>
</ul>
</li>
<li>utilities<ul>
<li>tracing, <code>dbg_trace</code></li>
<li><code>MessageData</code></li>
</ul>
</li>
<li>env extensions and attributes</li>
</ul>
<p>Okay it's looking more like a book actually. :(</p>



<a name="272248534"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272248534" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272248534">(Feb 17 2022 at 11:57)</a>:</h4>
<p>You should add a chapter of the book about using syntax to design DSLs</p>



<a name="272248788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272248788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272248788">(Feb 17 2022 at 11:59)</a>:</h4>
<p>This is something I wish I was qualified enough to do!<br>
I've given it some thought and maybe it would be less frightening to start with a "learn by example" tutorial about tactic writing specifically. It would be a warm up. Getting the hands dirty right away helps eliminate some mental barriers (at least for me)</p>
<ul>
<li>Debugging a tactic</li>
<li>Reading the type of the goal</li>
<li>Matching a hypothesis with the goal and closing it (assumption)</li>
<li>Introducing a hypothesis</li>
<li>Checking if the goal is of <code>a → b</code> and simulating an <code>intros</code></li>
<li>etc</li>
</ul>
<p>Building these small blocks for tactics</p>



<a name="272248930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272248930" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272248930">(Feb 17 2022 at 12:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/272248534">said</a>:</p>
<blockquote>
<p>You should add a chapter of the book about using syntax to design DSLs</p>
</blockquote>
<p>Over my dead body. <span aria-label="smiling devil" class="emoji emoji-1f608" role="img" title="smiling devil">:smiling_devil:</span> People are way too fond of obfuscating their libraries already.</p>



<a name="272250140"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272250140" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272250140">(Feb 17 2022 at 12:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/272248788">said</a>:</p>
<blockquote>
<p>I've given it some thought and maybe it would be less frightening to start with a "learn by example" tutorial about tactic writing specifically. It would be a warm up. Getting the hands dirty right away helps eliminate some mental barriers (at least for me)</p>
</blockquote>
<p>This would be very helpful as well, and I agree that exercises are instrumental. Ideally, we would have different types of documentation (overview/big picture, cookbooks, reference docs) that address people's different needs.</p>



<a name="272250857"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272250857" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272250857">(Feb 17 2022 at 12:20)</a>:</h4>
<p>My difficulty with tutorials that cover topics like you mentioned is that, in my mind, I (consciously or unconsciously) seek tutorials <em>to do something</em>. So reading tutorials that are also some sort of reference manuals is usually a hard experience for me</p>



<a name="272250906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272250906" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272250906">(Feb 17 2022 at 12:20)</a>:</h4>
<p>To some extent this should just be covered by documentation in the code</p>



<a name="272250982"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272250982" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272250982">(Feb 17 2022 at 12:21)</a>:</h4>
<p>I think there isn't nearly enough documentation for some of these functions. I wish lean 4 had a similar rule to mathlib: every <code>def</code> needs a doc comment</p>



<a name="272251423"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272251423" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272251423">(Feb 17 2022 at 12:25)</a>:</h4>
<p>Even if those are documented, if I understood correctly, Jannis intent is to approach those in a less dry way. Docstrings are usually super short and more suitable for people that already understand the abstract concept behind the implementation</p>



<a name="272251485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272251485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272251485">(Feb 17 2022 at 12:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/272250982">said</a>:</p>
<blockquote>
<p>I think there isn't nearly enough documentation for some of these functions. I wish lean 4 had a similar rule to mathlib: every <code>def</code> needs a doc comment</p>
</blockquote>
<p>That would also help of course. But many of the big picture concepts are actually covered reasonably well; it's just a matter of finding the right docstring. And this is always going to be an issue, which is why I believe it would be valuable to have a document that has most of the concepts in one place.</p>



<a name="272251609"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272251609" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272251609">(Feb 17 2022 at 12:27)</a>:</h4>
<p>Maybe what you intend to do is more like a "manual" rather than a "tutorial", given the scope you've mentioned</p>



<a name="272251760"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272251760" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272251760">(Feb 17 2022 at 12:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/272251423">said</a>:</p>
<blockquote>
<p>Even if those are documented, if I understood correctly, Jannis intent is to approach those in a less dry way. Docstrings are usually super short and more suitable for people that already understand the abstract concept behind the implementation</p>
</blockquote>
<p>I don't think this is a given at all. In particular some of the module docs are huge and explain abstract concepts</p>



<a name="272251839"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272251839" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272251839">(Feb 17 2022 at 12:29)</a>:</h4>
<p>Of course there is always room for supplementary documentation, but for goal directed documentation I think it is better to do this via code comments than a reference manual</p>



<a name="272251910"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272251910" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272251910">(Feb 17 2022 at 12:30)</a>:</h4>
<p>at least considering the way things are now</p>



<a name="272252105"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272252105" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272252105">(Feb 17 2022 at 12:32)</a>:</h4>
<p>Maybe an example you could use for inspiration is the <a href="http://rustc-dev-guide.rust-lang.org/">rustc dev guide</a>, which covers all the major systems at a high level, without really going in enough depth on any particular bit to qualify as a code comment</p>



<a name="272252322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272252322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272252322">(Feb 17 2022 at 12:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/272252105">said</a>:</p>
<blockquote>
<p>Maybe an example you could use for inspiration is the <a href="http://rustc-dev-guide.rust-lang.org/">rustc dev guide</a>, which covers all the major systems at a high level, without really going in enough depth on any particular bit to qualify as a code comment</p>
</blockquote>
<p>At a glance, yes, this looks very similar to what I had in mind.</p>



<a name="272252550"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272252550" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272252550">(Feb 17 2022 at 12:37)</a>:</h4>
<p>[props to referencing the Dhammapada <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span>]</p>



<a name="272252818"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272252818" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alexander Bentkamp <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272252818">(Feb 17 2022 at 12:40)</a>:</h4>
<p>Maybe you can add a section about environment extensions? Maybe also custom attributes (<code>registerAttribute</code>) and custom options (<code>register_option</code>)?</p>



<a name="272253065"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272253065" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272253065">(Feb 17 2022 at 12:42)</a>:</h4>
<p>Also initialization: <code>@[init]</code>, <code>initialize</code>, and <code>builtin_initialize</code></p>



<a name="272253267"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272253267" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272253267">(Feb 17 2022 at 12:44)</a>:</h4>
<p>I think a general overview of where environments come from and how staging and initialization works would have been very helpful to me when I started</p>



<a name="272254375"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272254375" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272254375">(Feb 17 2022 at 12:55)</a>:</h4>
<p>The scope is really big already, but I also want to mention an overview of what metaprogramming is for</p>



<a name="272258387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272258387" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272258387">(Feb 17 2022 at 13:29)</a>:</h4>
<p>Other topics that I haven't seen being mentioned so far: delaboration, TacticM</p>



<a name="272258721"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272258721" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272258721">(Feb 17 2022 at 13:31)</a>:</h4>
<p>Generally speaking, I think it is more useful to provide a comprehensive overview than to go into great detail.  There are so many different ways to do the same thing in Lean 4, that I'm often missing a nicer shortcut because I only know the manual way to do something (and I've seen the same thing with other people's PRs on mathlib4).</p>



<a name="272258781"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272258781" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272258781">(Feb 17 2022 at 13:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/272258387">said</a>:</p>
<blockquote>
<p>Other topics that I haven't seen being mentioned so far: delaboration, TacticM</p>
</blockquote>
<p>Oh yeah, delaboration is a good one. I know very little about that myself. Thanks everyone for the suggestions, keep them coming!</p>



<a name="272259158"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272259158" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272259158">(Feb 17 2022 at 13:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/272258721">said</a>:</p>
<blockquote>
<p>There are so many different ways to do the same thing in Lean 4, that I'm often missing a nicer shortcut because I only know the manual way to do something</p>
</blockquote>
<p>Which reminded me of <a href="https://www.python.org/dev/peps/pep-0020/">this</a> (can we have something similar for Lean 4?)</p>



<a name="272260801"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272260801" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272260801">(Feb 17 2022 at 13:47)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> I didn't understand your comment. Wouldn't providing detailed examples encourage the standardization of straightforward ways to do things?</p>



<a name="272261339"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272261339" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272261339">(Feb 17 2022 at 13:51)</a>:</h4>
<p>I don't really care about standardization per se.  But quite often there's shorthand syntax that dramatically reduces the boilerplate.  E.g. <code>termElab</code> -&gt; <code>elab_rules</code> -&gt; <code>elab</code>, etc.  Or using a two-line macro instead of thirty lines of tactic elaborator.  Both approaches accomplish the same, so it's easy to know one but be completely unaware of the other.</p>



<a name="272318710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272318710" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272318710">(Feb 17 2022 at 20:32)</a>:</h4>
<p>Hijacking this thread a bit, we are also still missing a tutorial for just programming without the Meta, I don't know about you but I learned everything I know about how to write stuff in Lean by grepping around in the compiler and trying stuff out since TPIL is (as its name suggests) focused on theorems and not general purpose programming, maybe we could also brainstorm a bit about what a "Programming in Lean" would need to contain?</p>



<a name="272323992"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272323992" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272323992">(Feb 17 2022 at 21:19)</a>:</h4>
<p>Do you know about the unfinished Lean 3 version of programming in Lean? <a href="https://leanprover.github.io/programming_in_lean/programming_in_lean.pdf">https://leanprover.github.io/programming_in_lean/programming_in_lean.pdf</a></p>



<a name="272324053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272324053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272324053">(Feb 17 2022 at 21:20)</a>:</h4>
<p>That reference taught me what a monad was!</p>



<a name="272328256"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272328256" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272328256">(Feb 17 2022 at 21:44)</a>:</h4>
<p>Ah that's certainly going in the right direction yes...although I am a bit unsure about the entire verification part. Yes verification is a pretty big thing in Lean of course but if we want to attract the average functional programming interested person as well and the introduction resource even has formal proofs before introducing how this monad thingy works I don't think that's too attractive for such a  person, especially considering that one of the reasons Haskell is disliked among the "normal" programming community is that "it requires you to know so much maths" (which really it does not but but that's not the point here).</p>



<a name="272328479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272328479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272328479">(Feb 17 2022 at 21:45)</a>:</h4>
<p>Maybe having another separate resource for that would be good? THen again we are basically talking about a small bookshelf at this point already...</p>



<a name="272351236"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272351236" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272351236">(Feb 18 2022 at 02:08)</a>:</h4>
<p>I feel the <em>Type-Driven Development with Idris</em> is a good model, except that most of its examples are systems programming related, while with lean having mathematics related examples may be better. It is also rather easy to find mathematics examples with conditions: the first one I use is subtraction defined with a witness to <em>leq</em>.</p>



<a name="272464382"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/272464382" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomás Díaz <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#272464382">(Feb 18 2022 at 22:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/272250857">said</a>:</p>
<blockquote>
<p>My difficulty with tutorials that cover topics like you mentioned is that, in my mind, I (consciously or unconsciously) seek tutorials <em>to do something</em>. So reading tutorials that are also some sort of reference manuals is usually a hard experience for me</p>
</blockquote>
<p>I've found this document on documentation (lol) really nice on this topic <a href="https://documentation.divio.com/">https://documentation.divio.com/</a> - idk if it's widely known.</p>



<a name="273363692"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/273363692" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#273363692">(Feb 26 2022 at 21:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395550">Henrik Böving</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/272328256">said</a>:</p>
<blockquote>
<p>[O]ne of the reasons Haskell is disliked among the "normal" programming community is that "it requires you to know so much maths" (which really it does not but but that's not the point here).</p>
</blockquote>
<p>And one of the reasons why people think this is because a lot of the documentation for Haskell utilities explains concepts in mathematical terms (e.g., monads) which gives users the impression you need to know the math to use the concept, when generally, you don't. A great example of this is monads, which are described in the API documentation largely by the mathematical monad laws (despite the fact many Haskell monads are not lawful) instead of describing them from a control flow / <code>do</code> notation approach, which would be easier for a non-mathematics-focused computer scientist to follow.</p>
<p>This is something we should probably keep in mind for any programming-focused Lean docs. The examples and descriptions should probably avoid any reference mathematics to attract the less mathematically inclined so as to not give Lean the same (false) reputation as Haskell (i.e., that you need to know maths to use it).</p>



<a name="273368338"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/273368338" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#273368338">(Feb 26 2022 at 23:04)</a>:</h4>
<p>I think that this is particularly important here because lean 3 has made an impact with its mathematics so one can incorrectly deduce from this that Lean is "for mathematicians" or even worse "only for mathematicians".</p>



<a name="276092717"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276092717" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Edward Ayers <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276092717">(Mar 21 2022 at 18:14)</a>:</h4>
<p>Hi all, I half-wrote a metaprogramming tutorial for Lean 3 about 3 years ago and I'm spending today porting it over to Lean 4. I'm plopping it in mathlib4 for now. <a href="https://github.com/leanprover-community/mathlib4/pull/243">https://github.com/leanprover-community/mathlib4/pull/243</a> </p>
<p>more to come.</p>



<a name="276163479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276163479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276163479">(Mar 22 2022 at 09:51)</a>:</h4>
<p>Oh very nice! I'll coordinate with you to contribute more stuff once I'm no longer consumed by my eternal quest to have Aesop correctly deal with metavariables.</p>



<a name="276181686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276181686" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276181686">(Mar 22 2022 at 12:39)</a>:</h4>
<p><span class="user-mention" data-user-id="256311">@Jannis Limperg</span> nice!<br>
I started a tactics writing tutorial and then Edward brought his material. <span class="user-mention" data-user-id="462786">@Ian Benway</span> also told me that he wants to participate with his learnings. Soon enough we'll need to organize the content in a more cohesive structure</p>



<a name="276187418"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276187418" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276187418">(Mar 22 2022 at 13:24)</a>:</h4>
<p>I think the structure you gathered in the beginning of the thread with input from the community is really good</p>



<a name="276413130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276413130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276413130">(Mar 23 2022 at 22:58)</a>:</h4>
<p>After talking to <span class="user-mention" data-user-id="121918">@Edward Ayers</span>, I've moved the content to this repository: <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book">https://github.com/arthurpaulino/lean4-metaprogramming-book</a>.</p>
<p>This repository is meant to be temporary. Once the content is finished (in markdown), we can place it wherever we want.</p>
<p>I'm almost done finishing up the <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/lean/intro.lean">introductory chapter</a>, whose first version was written by Ed.</p>
<p>If anyone wants to be a collaborator, just let me know. Or feel free to open PRs <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="276447500"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276447500" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276447500">(Mar 24 2022 at 09:06)</a>:</h4>
<p>Thanks for this effort. I would be happy to contribute a bit. One suggestion: have an <code>Expressions</code> section as there are a huge number of helpers for constructing expressions (unless the plan is to put these in some other section). For instance, the monadic <code>mkLambdaFVars</code> is extremely useful.</p>



<a name="276452011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276452011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276452011">(Mar 24 2022 at 09:52)</a>:</h4>
<p><code>Expr</code> is one of the datatypes discussed in the second chapter</p>



<a name="276452509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276452509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276452509">(Mar 24 2022 at 09:58)</a>:</h4>
<p>It's really amazing that this meta-programming tutorial is making progress. This is a very very important project.</p>



<a name="276453149"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276453149" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276453149">(Mar 24 2022 at 10:03)</a>:</h4>
<p><span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span> let me know if you want to be a collaborator in the repo (create branches, issues etc)</p>



<a name="276460143"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276460143" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276460143">(Mar 24 2022 at 11:11)</a>:</h4>
<p>Either way is fine with me. I can work with fork and pull-request or directly with the repository.</p>



<a name="276462295"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276462295" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276462295">(Mar 24 2022 at 11:34)</a>:</h4>
<p>I see that there is a nice discussion of <code>Expr</code> in datatypes. </p>
<p>What I was asking about was the huge range of helpers taking care of hygiene, unification, hashing and such things as well as matching, so the user does not need to directly deal with expressions. I mean stuff like <code>mkLambdaFVars</code> to create lambda-expressions, <code>mkAppM</code> for unified application, <code>Expr.eq?</code> to match equalities,  <code>forallTelescope</code> and friends (I personally don't really understand telescopes).</p>
<p>Perhaps these should be a separate <code>Expr.md</code> file (or <code>Cookbook.md</code>)?</p>



<a name="276462435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276462435" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276462435">(Mar 24 2022 at 11:36)</a>:</h4>
<p>Another question: is the format designed to run with <code>docgen4</code>? Or some other literate programming framework?</p>



<a name="276462457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276462457" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276462457">(Mar 24 2022 at 11:36)</a>:</h4>
<p>If its markdown we can render it</p>



<a name="276462578"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276462578" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276462578">(Mar 24 2022 at 11:37)</a>:</h4>
<p>My current plan is to use my <a href="https://github.com/Julian/lftim/blob/main/lean2md.py">lean2md</a> Python script to turn those lean files into markdown files. I want to be able to write while typechecking stuff. I also don't want to be copy/pasting Lean code to markdown codeblocks manually</p>



<a name="276462716"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276462716" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276462716">(Mar 24 2022 at 11:39)</a>:</h4>
<p>No no I mean, if your doc comments are markdown doc-gen4 can render it, there is no need for any further tangling</p>



<a name="276462767"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276462767" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276462767">(Mar 24 2022 at 11:39)</a>:</h4>
<p>Ah, I see. But still, for a book I think we want the actual md files in the end</p>



<a name="276462997"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276462997" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276462997">(Mar 24 2022 at 11:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="266304">Siddhartha Gadgil</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/276462295">said</a>:</p>
<blockquote>
<p>I see that there is a nice discussion of <code>Expr</code> in datatypes. </p>
<p>What I was asking about was the huge range of helpers taking care of hygiene, unification, hashing and such things as well as matching, so the user does not need to directly deal with expressions. I mean stuff like <code>mkLambdaFVars</code> to create lambda-expressions, <code>mkAppM</code> for unified application, <code>Expr.eq?</code> to match equalities,  <code>forallTelescope</code> and friends (I personally don't really understand telescopes).</p>
<p>Perhaps these should be a separate <code>Expr.md</code> file (or <code>Cookbook.md</code>)?</p>
</blockquote>
<p>I think those are totally worth mentioning and even showing use examples.</p>
<p>I guess <code>Expr</code> is too important of a datatype and deserves a chapter of its own? That's how Jannis structured the TOC in the beginning of this thread</p>



<a name="276463274"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276463274" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276463274">(Mar 24 2022 at 11:45)</a>:</h4>
<p>I still think so, yes! However, there's a bit of a dependency problem since many of these <code>Expr</code> functions need <code>MetaM</code>. So you either introduce <code>MetaM</code> quickly and superficially, deferring detailed discussion to the monad chapter; or you split the <code>Expr</code> stuff. I think I prefer option 1, but I'd have to try it to see how it works out.</p>



<a name="276463483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276463483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276463483">(Mar 24 2022 at 11:48)</a>:</h4>
<p>Monads got me thinking that this book would need a "Programming in Lean 4" book first. The fact that we're introducing specific notation for monadic programming like <code>←</code> and <code>do</code> makes me a bit uncomfortable</p>



<a name="276463811"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276463811" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276463811">(Mar 24 2022 at 11:50)</a>:</h4>
<p>I was planning to assume that the audience already knows how to program in Lean (with maybe quick links to TPIL4 or the reference manual for more esoteric stuff).</p>



<a name="276464110"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276464110" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276464110">(Mar 24 2022 at 11:53)</a>:</h4>
<p>That's a good assumption. On the helper functions to manipulate terms of <code>Expr</code>, what if we delay their introduction and talk about them in the <code>MetaM</code> chapter? I think it will make the text more cohesive</p>



<a name="276465021"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276465021" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276465021">(Mar 24 2022 at 12:02)</a>:</h4>
<p>This is what I meant with "split the <code>Expr</code> stuff". I'm fine with trying this option first if you feel it's gonna be better. Just have a forward reference in the <code>Expr</code> chapter so readers know they won't have to write abominations (<code>mkApp (mkApp (mkConst `Eq #[Level.one]) (mkFVar x) (mkFVar y)</code>) forever.</p>



<a name="276465234"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276465234" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276465234">(Mar 24 2022 at 12:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395550">Henrik Böving</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/276462716">said</a>:</p>
<blockquote>
<p>No no I mean, if your doc comments are markdown doc-gen4 can render it, there is no need for any further tangling</p>
</blockquote>
<p>Alectryon would probably be more appropriate since you want to see the code as is, no?</p>



<a name="276466019"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276466019" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276466019">(Mar 24 2022 at 12:11)</a>:</h4>
<p>Alectryon would work too, but I think it's a bit of overkill. Being able to extract the markdown files in order to have input for something like <a href="https://github.com/leanprover/theorem_proving_in_lean4">https://github.com/leanprover/theorem_proving_in_lean4</a> should be enough</p>



<a name="276470197"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276470197" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276470197">(Mar 24 2022 at 12:50)</a>:</h4>
<p>We're considering porting all Lean 4 documentation over to LeanInk+Alectryon since really there's no reason not to do it</p>



<a name="276471277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276471277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276471277">(Mar 24 2022 at 12:58)</a>:</h4>
<p>Oh, I see now. We'll see after the content is more ready</p>



<a name="276476722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276476722" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276476722">(Mar 24 2022 at 13:41)</a>:</h4>
<p>There is a natural split as the basic constructors (like <code>mkAppN</code>) are in <code>Expr.lean</code> while the meta helpers (like <code>mkLambdaFVars</code>) are in <code>Meta/Basic.lean</code>.  So the latter can go into the <code>Meta.md</code> chapter and the former in <code>Expr.md</code>.</p>



<a name="276479764"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276479764" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276479764">(Mar 24 2022 at 14:05)</a>:</h4>
<p><span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span> please feel free to propose changes to the structure that we have so far. I've already changed it a bit after some input from this thread (regarding <code>Expr</code>) but I'm sure we can do better together. "skeleton building" PRs are very much welcome. By "skeleton building" I mean building the structure with sections and subsections but leaving the content marked with <code>--todo</code></p>



<a name="276481255"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276481255" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276481255">(Mar 24 2022 at 14:16)</a>:</h4>
<p>Also notice that I'm putting extra effort trying to follow the suggestion from the community of not making it sound like a "Lean is for mathematics and mathematicians" text. Most of the changes that I made on Ed's first version (which he had written targeting Lean 3, 3 years ago) were on that direction</p>



<a name="276557601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276557601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276557601">(Mar 25 2022 at 00:31)</a>:</h4>
<p>I had this idea of starting from <code>Syntax</code> and building up to <code>Expr</code>. Basically every example involves processing syntaxes.</p>
<p>If we start from <code>Syntax</code>, we can introduce macros right away. I think it can be motivating</p>
<p>What do you folks think?</p>



<a name="276564606"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276564606" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276564606">(Mar 25 2022 at 02:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/276470197">said</a>:</p>
<blockquote>
<p>We're considering porting all Lean 4 documentation over to LeanInk+Alectryon since really there's no reason not to do it</p>
</blockquote>
<p>Is there an example of the end result of that combination? I find the output of <code>mdbook</code> remarkably pretty and pleasant to read</p>



<a name="276564935"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276564935" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276564935">(Mar 25 2022 at 02:31)</a>:</h4>
<p>Yes, we have:</p>
<ul>
<li>input: <a href="https://github.com/leanprover/lean4/blob/master/doc/examples/tc.lean">https://github.com/leanprover/lean4/blob/master/doc/examples/tc.lean</a></li>
<li>output: <a href="https://pp.ipd.kit.edu/~ullrich/tmp/examples/tc.lean.html">https://pp.ipd.kit.edu/~ullrich/tmp/examples/tc.lean.html</a></li>
</ul>
<p>It is not as pretty as the mdbook output yet, but we are all confident we will get there. It already has really nice hover information, and we can visualize the tactic state.</p>



<a name="276586845"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276586845" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276586845">(Mar 25 2022 at 08:10)</a>:</h4>
<p>I have created a pull request with a bunch of examples of constructing expressions both directly and using smart constructors.</p>



<a name="276595425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276595425" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276595425">(Mar 25 2022 at 09:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/276557601">said</a>:</p>
<blockquote>
<p>I had this idea of starting from <code>Syntax</code> and building up to <code>Expr</code>. Basically every example involves processing syntaxes.</p>
<p>If we start from <code>Syntax</code>, we can introduce macros right away. I think it can be motivating</p>
<p>What do you folks think?</p>
</blockquote>
<p>I somewhat dislike the whole <code>Syntax</code> layer. Lots of sugar (<code>$[$t:term],*</code>); some annoying edge cases (<code>leading_ident_behavior := both</code>); subtle differences between syntax categories and syntax defs; macros are too powerful for my liking (recursion and nondeterminism) and simultaneously never powerful enough for what I want to do. This is entirely personal preference, of course, but as a result I would try to de-emphasise this layer.</p>
<p>For my students, I wrote a little tactic that takes a '<code>MetaM</code> tactic' <code>x : MVarId -&gt; MetaM (List MVarId)</code> and executes it. This way, they can run their metaprograms without having to think about syntax at all.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>

<span class="kn">open</span> <span class="n">Lean</span>
<span class="kn">open</span> <span class="n">Lean.Elab</span>
<span class="kn">open</span> <span class="n">Lean.Elab.Term</span>
<span class="kn">open</span> <span class="n">Lean.Elab.Tactic</span> <span class="o">(</span><span class="n">Tactic</span> <span class="n">liftMetaTactic</span><span class="o">)</span>
<span class="kn">open</span> <span class="n">Lean.Meta</span>

<span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">runMetaMTactic</span><span class="o">)</span> <span class="bp">&amp;</span><span class="s2">"run_MetaM_tactic"</span> <span class="n">term</span> <span class="o">:</span> <span class="n">tactic</span>

<span class="n">abbrev</span> <span class="n">MetaMTacticType</span> <span class="o">:=</span> <span class="n">MVarId</span> <span class="bp">→</span> <span class="n">MetaM</span> <span class="o">(</span><span class="n">List</span> <span class="n">MVarId</span><span class="o">)</span>

<span class="n">unsafe</span> <span class="kd">def</span> <span class="n">evalMetaMTacticUnsafe</span> <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="n">Expr</span><span class="o">)</span> <span class="o">:</span> <span class="n">TermElabM</span> <span class="n">MetaMTacticType</span> <span class="o">:=</span>
  <span class="n">withDefault</span> <span class="bp">$</span> <span class="n">withoutModifyingEnv</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">type</span> <span class="bp">←</span> <span class="n">inferType</span> <span class="n">e</span>
    <span class="k">let</span> <span class="n">expectedType</span> <span class="o">:=</span> <span class="n">Lean.mkConst</span> <span class="bp">``</span><span class="n">MetaMTacticType</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">true</span><span class="o">)</span> <span class="bp">←</span> <span class="n">isDefEq</span> <span class="n">type</span> <span class="n">expectedType</span>
      <span class="bp">|</span> <span class="n">throwTypeMismatchError</span> <span class="s2">"runMetaMTactic"</span> <span class="n">expectedType</span> <span class="n">type</span> <span class="n">e</span>
    <span class="k">let</span> <span class="n">name</span> <span class="bp">←</span> <span class="n">mkFreshUserName</span> <span class="bp">`</span><span class="n">_tmp</span>
    <span class="k">let</span> <span class="n">decl</span> <span class="o">:=</span> <span class="n">Declaration.defnDecl</span> <span class="o">{</span>
        <span class="n">name</span> <span class="o">:=</span> <span class="n">name</span><span class="o">,</span> <span class="n">levelParams</span> <span class="o">:=</span> <span class="o">[],</span> <span class="n">type</span> <span class="o">:=</span> <span class="n">type</span><span class="o">,</span>
        <span class="n">value</span> <span class="o">:=</span> <span class="n">e</span><span class="o">,</span> <span class="n">hints</span> <span class="o">:=</span> <span class="n">ReducibilityHints.opaque</span><span class="o">,</span>
        <span class="n">safety</span> <span class="o">:=</span> <span class="n">DefinitionSafety.unsafe</span>
    <span class="o">}</span>
    <span class="n">ensureNoUnassignedMVars</span> <span class="n">decl</span>
    <span class="n">addAndCompile</span> <span class="n">decl</span>
    <span class="n">evalConst</span> <span class="n">MetaMTacticType</span> <span class="n">name</span>

<span class="kd">@[implementedBy evalMetaMTacticUnsafe]</span>
<span class="kd">constant</span> <span class="n">evalMetaMTactic</span> <span class="o">(</span><span class="n">e</span> <span class="o">:</span> <span class="n">Expr</span><span class="o">)</span> <span class="o">:</span> <span class="n">TermElabM</span> <span class="n">MetaMTacticType</span>

<span class="kd">@[tactic runMetaMTactic]</span>
<span class="kd">def</span> <span class="n">evalRunMetaMTactic</span> <span class="o">:</span> <span class="n">Tactic</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span><span class="n">run_MetaM_tactic</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="n">withoutErrToSorry</span> <span class="bp">$</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="o">(</span><span class="n">Lean.mkConst</span> <span class="bp">``</span><span class="n">MetaMTacticType</span><span class="o">)</span>
      <span class="n">synthesizeSyntheticMVars</span> <span class="o">(</span><span class="n">mayPostpone</span> <span class="o">:=</span> <span class="n">false</span><span class="o">)</span>
      <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="n">instantiateMVars</span> <span class="n">t</span>
      <span class="k">let</span> <span class="n">tac</span> <span class="bp">←</span> <span class="n">evalMetaMTactic</span> <span class="n">t</span>
      <span class="n">liftMetaTactic</span> <span class="n">tac</span>
  <span class="bp">|</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">unreachable</span><span class="bp">!</span>

<span class="kd">def</span> <span class="n">greet</span> <span class="o">(</span><span class="n">msg</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="o">(</span><span class="n">goal</span> <span class="o">:</span> <span class="n">MVarId</span><span class="o">)</span> <span class="o">:</span> <span class="n">MetaM</span> <span class="o">(</span><span class="n">List</span> <span class="n">MVarId</span><span class="o">)</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="n">trace</span><span class="o">[</span><span class="n">debug</span><span class="o">]</span> <span class="s2">"{msg}"</span>
  <span class="n">return</span> <span class="o">[</span><span class="n">goal</span><span class="o">]</span>

<span class="kd">set_option</span> <span class="n">trace.debug</span> <span class="n">true</span>

<span class="kd">example</span> <span class="o">:</span> <span class="n">True</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">run_MetaM_tactic</span> <span class="n">greet</span> <span class="s2">"hi"</span>
  <span class="n">trivial</span>
</code></pre></div>



<a name="276596431"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276596431" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276596431">(Mar 25 2022 at 09:56)</a>:</h4>
<p>I also agree (this was also discussed in another thread) that using <code>Syntax</code> for logic and control is far from ideal, and it is best to work at the Meta/TermElab level for this. Lean 4 macros are superb for notation and for creating some shortcuts. But passing around bits of syntax as proxies for function arguments is very fiddly.</p>



<a name="276604281"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276604281" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276604281">(Mar 25 2022 at 11:15)</a>:</h4>
<p>But if there's no clear intention from Lean 4 core devs to change it, I think we better talk about it and explicit the issues. Otherwise readers will have many questions when reading Lean 4 source code (or even the code of some Mathlib4 tactics)</p>



<a name="276604384"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276604384" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276604384">(Mar 25 2022 at 11:16)</a>:</h4>
<p>There should be separate chapters for it that dont introduce knowledge that is a hard requirement to understand the rest IMO</p>



<a name="276606028"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276606028" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276606028">(Mar 25 2022 at 11:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/276604281">said</a>:</p>
<blockquote>
<p>But if there's no clear intention from Lean 4 core devs to change it, I think we better talk about it and explicit the issues. Otherwise readers will have many questions when reading Lean 4 source code (or even the code of some Mathlib4 tactics)</p>
</blockquote>
<p>Yes, of course. I just wouldn't put <code>Syntax</code> front-and-centre. Another way to deal with this would be to have a <code>Syntax</code> primer towards the beginning of the book with a warning that the material there is incomplete (and with a forward reference to the full explanation). That could work as well.</p>



<a name="276606936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276606936" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276606936">(Mar 25 2022 at 11:42)</a>:</h4>
<p>Another approach I've been thinking about: focus on functions like <code>@[macro myMacro] def expandMyMacro : Macro := fun stx =&gt; ...</code>, similar to what you'd do with the <code>tactic</code> tag. And then later talk about the <code>macro</code> and <code>elab</code> shorctuts. Is my read accurate that the main issue lives on the <code>macro/elab</code> syntax?</p>



<a name="276607806"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276607806" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276607806">(Mar 25 2022 at 11:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="266304">Siddhartha Gadgil</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/276586845">said</a>:</p>
<blockquote>
<p>I have created a pull request with a bunch of examples of constructing expressions both directly and using smart constructors.</p>
</blockquote>
<p>Thanks!! Will read soon!</p>



<a name="276609903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276609903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276609903">(Mar 25 2022 at 12:16)</a>:</h4>
<p>Understanding Syntax is very much necessary. I think the point both <span class="user-mention" data-user-id="256311">@Jannis Limperg</span> and I are making is that one should avoid readers driven to using macros and working with syntax where it is better to use Meta/Elab and work with expressions, simply because one can start working with macros a bit quicker.</p>



<a name="276611068"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276611068" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276611068">(Mar 25 2022 at 12:27)</a>:</h4>
<p>Alright, thanks for clarifying! I will throw this idea away for now and stick to the current TOC sequence</p>



<a name="276611868"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276611868" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276611868">(Mar 25 2022 at 12:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112857">Leonardo de Moura</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/276564935">said</a>:</p>
<blockquote>
<p>Yes, we have:</p>
<ul>
<li>input: <a href="https://github.com/leanprover/lean4/blob/master/doc/examples/tc.lean">https://github.com/leanprover/lean4/blob/master/doc/examples/tc.lean</a></li>
<li>output: <a href="https://pp.ipd.kit.edu/~ullrich/tmp/examples/tc.lean.html">https://pp.ipd.kit.edu/~ullrich/tmp/examples/tc.lean.html</a></li>
</ul>
<p>It is not as pretty as the mdbook output yet, but we are all confident we will get there. It already has really nice hover information, and we can visualize the tactic state.</p>
</blockquote>
<p>one thing that I found in the Lean3 Alectryon port is that showing the state after every <code>&lt;;&gt;</code> and similar combinators quickly got unwieldy - I feel like maybe it's nicer to just ignore combinators and put everything together. Although maybe this is a bit different as Lean4 does show all the intermediate states affected</p>



<a name="276612016"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276612016" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Rodriguez <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276612016">(Mar 25 2022 at 12:36)</a>:</h4>
<p>(and similarly with goals accomplished, but it actually looks really nice here - maybe a green-colour bubble is good to signal that it's not got any state information?)</p>



<a name="276751536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276751536" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276751536">(Mar 26 2022 at 23:18)</a>:</h4>
<p>Some extra progress has been made and reviews are very welcome:<br>
<a href="https://github.com/arthurpaulino/lean4-metaprogramming-book">https://github.com/arthurpaulino/lean4-metaprogramming-book</a></p>
<p><span class="user-mention" data-user-id="256311">@Jannis Limperg</span> do you mind being more specific on what you mean by the following topics on the "Expressions" chapter?</p>
<ul>
<li>matching on expressions</li>
<li>normalisation, transparency</li>
<li>discrimination trees</li>
<li>unification</li>
</ul>



<a name="276781604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276781604" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276781604">(Mar 27 2022 at 10:43)</a>:</h4>
<p>Made another pull request with a couple of more examples.</p>



<a name="276782671"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276782671" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276782671">(Mar 27 2022 at 11:07)</a>:</h4>
<p>And another example, involving matching.</p>



<a name="276841690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276841690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276841690">(Mar 28 2022 at 08:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/276751536">said</a>:</p>
<blockquote>
<ul>
<li>matching on expressions</li>
</ul>
</blockquote>
<p>I was thinking about (a) various functions to match specific expressions (equalities etc.), just noting where to find them; (b) a note about matching up to computation. The latter means that you have to <code>whnf</code> to the right level before you match. The mechanics of this are not hard (though a bit annoying), but some examples would be nice, since I think people tend to not be aware how deeply computation permeates metaprogramming. (At least I was a little naive about this when I started, even though I had done a fair amount of type theory before.)</p>
<blockquote>
<ul>
<li>normalisation, transparency</li>
</ul>
</blockquote>
<p><code>whnf</code>. Normalisation in the presence of unfoldable constants (this is where transparency comes in, i.e. <code>withReducible</code> etc.) Maybe a short note about normalisation in the presence of metavariables.</p>
<blockquote>
<ul>
<li>discrimination trees</li>
</ul>
</blockquote>
<p>A discrimination tree is a map with <code>Expr</code> keys where lookup is performed (efficiently) up to normalisation. They're used all over the place to index expressions, e.g. for simp lemmas.</p>
<blockquote>
<ul>
<li>unification</li>
</ul>
</blockquote>
<p><code>isDefEq</code>. The effect of transparency (again). Metavariable assignment during unification, including the different <code>MetavarKind</code>s.</p>
<p>Obviously, some reordering of these topics is in order. ;)</p>



<a name="276883867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/276883867" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#276883867">(Mar 28 2022 at 14:46)</a>:</h4>
<p>I've added delayed-assigned metavariables (which I've had the pleasure(?) to learn about this week) to the structure in the OP.</p>



<a name="280756374"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/280756374" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#280756374">(Apr 30 2022 at 21:14)</a>:</h4>
<p>Great news: <span class="user-mention" data-user-id="395550">@Henrik Böving</span> has written the chapter on <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/md/elaboration.md">Elaboration</a> <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span> <br>
Feedback is very much welcome <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="281097156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/281097156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#281097156">(May 04 2022 at 00:28)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> and I were trying to figure out an order to present the topics in that actually makes sense to people. We figured that most end users will most likely care about 1 of 3 things:</p>
<ul>
<li>just basic notation for writing code quicker</li>
<li>actual DSLs</li>
<li>tactics</li>
</ul>
<p>so i attempted to draw a DAG that shows the "knowledge dependencies" (i am aware of) so to speak, dotted lines represent optional dependencies so for example one can understand term elaboration etc. without knowing how attributes work in detail even though the inner workings rely on attributes:  <a href="/user_uploads/3121/MRhebyLLbbq8KxHLAZj98uFR/image.png">image.png</a> (Does this graph look correct? (not in the aesthetic sense :p))</p>
<div class="message_inline_image"><a href="/user_uploads/3121/MRhebyLLbbq8KxHLAZj98uFR/image.png" title="image.png"><img src="/user_uploads/3121/MRhebyLLbbq8KxHLAZj98uFR/image.png"></a></div><p>One thing we noticed was that, the ability to deal with syntax so to declare it and match on it seems rather central when viewed like this so its probably close to impossible to avoid a good explanation of it rather early on.  It also shows that a lot of the topics mentioned above are not relevant across use cases so for example a tactic programmer will most likely be fine with just knowing Syntax, MetaM and Expr while DSL people are interested in term elaboration and so on. So now we are wondering whether it even makes sense to build the tutorial/book as a linear resource? The knowledge graph does definitely not look linear.</p>



<a name="281098053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/281098053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#281098053">(May 04 2022 at 00:42)</a>:</h4>
<p>Thanks a lot for the DAG!</p>
<p>Yeah, we are trying to figure out a good way to present connected topics with a (minimal) building path. Ideas are very welcome.</p>
<p>Here are my ideas:</p>
<ul>
<li>We can cut off Attribute, CoreM, Env Extension, Initialization, Delaboration and Options (at least in the first iteration of the guide)</li>
<li>Instead of making TacticM as a big goal, we can make Tactics as a big goal and Macro and TacticM as means to achieve it</li>
</ul>



<a name="281142547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/281142547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#281142547">(May 04 2022 at 11:39)</a>:</h4>
<p>This is what I thought. We'd go from left to right. <span class="user-mention" data-user-id="256311">@Jannis Limperg</span> what do you think?<br>
<a href="/user_uploads/3121/n9oow1Wc3UKgQn3FdQc7Bhg1/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/n9oow1Wc3UKgQn3FdQc7Bhg1/image.png" title="image.png"><img src="/user_uploads/3121/n9oow1Wc3UKgQn3FdQc7Bhg1/image.png"></a></div>



<a name="281269227"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/281269227" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#281269227">(May 05 2022 at 08:40)</a>:</h4>
<p>Looks good to me. The general problem -- that not all content of the book is relevant to all audience members -- is something that happens with just about any text. I don't think this merits any radical changes to the form of the text (e.g. breaking it up into separate volumes). But it may be useful to design multiple "paths" through the book and to ensure that these can be followed independently. Software Foundations, for example, has <a href="https://softwarefoundations.cis.upenn.edu/lf-current/deps.html">this roadmap</a>.</p>



<a name="281510203"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/281510203" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#281510203">(May 07 2022 at 01:12)</a>:</h4>
<p>Hello everyone! I bring some updates about this front.</p>
<p><span class="user-mention" data-user-id="395550">@Henrik Böving</span> has been extremely helpful and we've been talking a lot about the content and didactic of this book lately. As you can see above, we were able to simplify the chapters by asking ourselves what are the most common practical motivations to learn metaprogramming in Lean 4.</p>
<p>We thought about DSLs and Tactics, so we backtracked the requirements without allowing ourselves to regress too much. We, then, simplified the chapters <em>even further</em> to come up with the current model:</p>
<ul>
<li>Introduction</li>
<li>Expressions</li>
<li>MetaM</li>
<li>Syntax</li>
<li>Elaboration</li>
<li>Macros</li>
<li>DSLs</li>
<li>Tactics</li>
</ul>
<p>So far, we got the 6 first chapters written to a point that's worth sharing. So this is a good moment for experts and beginners to read and provide corrections and feedback. If something is not clear or if some piece of information is missing, please let us know!</p>
<p><a href="https://github.com/arthurpaulino/lean4-metaprogramming-book">https://github.com/arthurpaulino/lean4-metaprogramming-book</a></p>
<p>Thanks everyone who's been helping out. Only two more chapters to go <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="284418908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284418908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284418908">(May 31 2022 at 01:35)</a>:</h4>
<p>Hi! We're happy to announce that the first version of the main trunk of the <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book">Lean 4 Metaprogramming Book</a> is now complete. There are still items to cover (and help is welcome, as always), but all chapters have content so the read show be fluid at this point.</p>
<p>HUGE thanks to everyone who's helped and/or has been helping. <span class="user-mention" data-user-id="130575">@Siddharth Bhat</span> was able to kill the last two chapters and <span class="user-mention" data-user-id="395550">@Henrik Böving</span> has revamped the chapter about elaboration.</p>
<p>If you've read the book and hasn't understood something, please let me know. Comment here or send me a DM and I will take a look.</p>



<a name="284501389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284501389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Malcolm Langfield <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284501389">(May 31 2022 at 16:19)</a>:</h4>
<p>In the chapter on expressions, there is mention of the quotation/backtick syntax for names. It would be nice if this were defined a bit more explicitly, e.g. why you can't just use ordinary strings, difference between double and single, etc. There is almost nothing on this in the Lean 4 manual or TPIL, just this:</p>
<blockquote>
<p>Declaring a new syntax category like this one automatically declares a quotation operator `(binderterm| ...).</p>
</blockquote>
<p>I was not able to easily find anything in the Lean 4 source describing this syntax either. But it does appear in some places in the manual, and it appears almost immediately in the metaprogramming book.</p>
<p>I think I would have been pretty confused by this syntax if I hadn't seen Lisp before.</p>



<a name="284501562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284501562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Malcolm Langfield <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284501562">(May 31 2022 at 16:20)</a>:</h4>
<p>Though perhaps everyone who is interested in metaprogramming in Lean has already been exposed to all the related syntax.</p>



<a name="284501832"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284501832" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284501832">(May 31 2022 at 16:22)</a>:</h4>
<p>I apologize. We had it before and I probably stripped it away doing some scope simplification. This time I probably cut too much. I'll add it back, thanks for pointing it out!</p>



<a name="284503080"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284503080" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Malcolm Langfield <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284503080">(May 31 2022 at 16:31)</a>:</h4>
<p>No worries! The book is excellent!</p>



<a name="284509059"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284509059" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284509059">(May 31 2022 at 17:10)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> congratulations to you and your coauthors on this work! I'm looking forward to reading it soon. Quick question: is there a quick way to compile this into a PDF?</p>



<a name="284511365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284511365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284511365">(May 31 2022 at 17:28)</a>:</h4>
<p>Not that I know... Currently we're using a Python script to turn Lean files into markdown files. Eventually we can switch to the LeanInk + Alectryon approach and we should have more powers there. Maybe then we'll be able to extract the respective PDF files</p>



<a name="284518300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284518300" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284518300">(May 31 2022 at 18:22)</a>:</h4>
<p>Maybe pandoc knows how (to compile a bunch of markdown to pdf)</p>



<a name="284518384"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284518384" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284518384">(May 31 2022 at 18:23)</a>:</h4>
<p>Otherwise md2html -&gt; pdf would be a thing. Can try when back at a computer if no one succeeds first.</p>



<a name="284523079"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284523079" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284523079">(May 31 2022 at 18:59)</a>:</h4>
<p>Yeah probably needs a bit of tweaking for word wrapping (and syntax highlighting) and a few additional missing characters, but e.g.:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">pandoc</span> <span class="c1">--to pdf md/{main/intro.md,main/expressions.md,main/metam.md,main/syntax.md,main/macros.md,main/elaboration.md,main/dsls.md,main/tactics.md,main/cheat-sheet.md,extra/options.md,extra/attributes.md,extra/pretty-printing.md} -o 'Lean 4 Metaprogramming (Paulino et al.).pdf' --pdf-engine=xelatex -V monofont='DejaVu Sans Mono'</span>
</code></pre></div>
<p>produces <a href="/user_uploads/3121/qNibNNp7wEBmEJcweEeyLD_J/Lean-4-Metaprogramming-Paulino-et-al..pdf">Lean-4-Metaprogramming-Paulino-et-al..pdf</a>.</p>
<p>Arthur happy to PR that as a GH Action workflow if helpful of course.</p>



<a name="284523727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284523727" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284523727">(May 31 2022 at 19:03)</a>:</h4>
<p>It looks nice but some lines are going through the right margin <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="284523810"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284523810" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284523810">(May 31 2022 at 19:04)</a>:</h4>
<p>How to prevent that?</p>



<a name="284525055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284525055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284525055">(May 31 2022 at 19:14)</a>:</h4>
<p>Ah, it also got the chapter order messed up, which is expected. I guess it's sorting the chapters by alphabetical order</p>



<a name="284525156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284525156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284525156">(May 31 2022 at 19:14)</a>:</h4>
<p>I don't understand what is the intended way of reading the book. Are we meant to read the md files on GitHub?</p>



<a name="284526233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284526233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284526233">(May 31 2022 at 19:25)</a>:</h4>
<p>Yes, at least for now. I wanted us to focus on the content first (while having this bare bones presentation). Now that the content has reached a more stable form, we can discuss how we want to present it</p>



<a name="284527215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284527215" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284527215">(May 31 2022 at 19:34)</a>:</h4>
<p><span class="user-mention" data-user-id="462544">@Malcolm Langfield</span> I forgot to say but the info about single/double quotes is on the chapter about expressions. And the info about <code>`(foo| ⋯)</code> can be found on the chapter about <code>Syntax</code></p>



<a name="284528160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284528160" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284528160">(May 31 2022 at 19:43)</a>:</h4>
<blockquote>
<p>It looks nice but some lines are going through the right margin</p>
</blockquote>
<p>I think slightly better and prettier now (by using a different template): <a href="/user_uploads/3121/x4UtWOyHPxR_yqge966xVE1S/Lean-4-Metaprogramming-Paulino-et-al..pdf">Lean-4-Metaprogramming-Paulino-et-al..pdf</a> </p>
<p>The chapter order is correct no? I specified it manually just copying what was in the README</p>



<a name="284528257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284528257" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284528257">(May 31 2022 at 19:44)</a>:</h4>
<p>Syntax highlighting requires some XML file that maybe someone has written for teaching pandoc to highlight Lean4.</p>



<a name="284528357"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284528357" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284528357">(May 31 2022 at 19:46)</a>:</h4>
<p>Yes, my bad about the order! It is indeed correct <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span><br>
Btw, it's looking beautiful. Syntax highlight seems to be the last ingredient</p>
<p>Ah, and a cover with credits to everyone involved. Maybe we need a <code>cover.md</code>?</p>



<a name="284528646"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284528646" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284528646">(May 31 2022 at 19:48)</a>:</h4>
<p>Bout to jump on a call but yeah think so.</p>



<a name="284528739"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284528739" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284528739">(May 31 2022 at 19:49)</a>:</h4>
<p>I did absolutely nothing to make it look nice btw, just used / found <a href="https://github.com/Wandmalfarbe/pandoc-latex-template">https://github.com/Wandmalfarbe/pandoc-latex-template</a>. The command I ran now was:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">pandoc</span> <span class="c1">--from markdown --to pdf md/{main/intro.md,main/expressions.md,main/metam.md,main/syntax.md,main/macros.md,main/elaboration.md,main/dsls.md,main/tactics.md,main/cheat-sheet.md,extra/options.md,extra/attributes.md,extra/pretty-printing.md} -o 'Lean 4 Metaprogramming (Paulino et al.).pdf' --pdf-engine=lualatex -V monofont='DejaVu Sans Mono' --toc --template eisvogel.latex --data-dir .</span>
</code></pre></div>
<p>in case you want to run it yourself.</p>



<a name="284531775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284531775" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284531775">(May 31 2022 at 20:17)</a>:</h4>
<p>With syntax highlighting I would print it tomorrow.</p>



<a name="284532515"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284532515" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284532515">(May 31 2022 at 20:24)</a>:</h4>
<p>I am trying to figure out how to adapt <a href="https://github.com/leanprover/lean4/blob/20e16f1c75b13057e00b4cc5315aac611df766fe/doc/syntax_highlight_in_latex.md">these listings instructions from the lean4 repo</a> but I am LaTeX inept... no luck yet.</p>



<a name="284755214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284755214" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284755214">(Jun 02 2022 at 14:46)</a>:</h4>
<p>Here's a version with syntax highlighting (and updated to today): <a href="/user_uploads/3121/AyHKdD9iPSXlqWF4n-SP-3Zk/Lean-4-Metaprogramming-Paulino-et-al..pdf">Lean-4-Metaprogramming-Paulino-et-al..pdf</a> </p>
<p>What I did to get it is slightly not pretty, so undoubtedly I may have introduced a mistake or two.</p>



<a name="284756019"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284756019" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284756019">(Jun 02 2022 at 14:52)</a>:</h4>
<p>It looks nice! There are some "unexpected" <code>import Lean</code> lines that are a bit funny out of context. It's dragging the <code>import Lean</code> from the beggining of the next chapter</p>



<a name="284756952"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284756952" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284756952">(Jun 02 2022 at 14:58)</a>:</h4>
<p>Aha. I see. OK probably I'm missing an option telling it to page break between chapters, that should be easy to fix.</p>



<a name="284757049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284757049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284757049">(Jun 02 2022 at 14:58)</a>:</h4>
<p>What tool are you using for this? Some pandoc framework I guess?</p>



<a name="284757569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284757569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284757569">(Jun 02 2022 at 15:01)</a>:</h4>
<p>Noticed this cosmetic bug as well: <a href="/user_uploads/3121/eYLDGIG-0qptt5gHNUttOw1V/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/eYLDGIG-0qptt5gHNUttOw1V/image.png" title="image.png"><img src="/user_uploads/3121/eYLDGIG-0qptt5gHNUttOw1V/image.png"></a></div>



<a name="284757656"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284757656" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284757656">(Jun 02 2022 at 15:01)</a>:</h4>
<p>Yeah, it's roughly the command above, combined with <a href="https://github.com/Wandmalfarbe/pandoc-latex-template">this template</a>, but then I can't figure out how to get <code>pandoc</code> to make use of <code>listings</code> in the same way as <a href="https://github.com/leanprover/lean4/blob/20e16f1c75b13057e00b4cc5315aac611df766fe/doc/syntax_highlight_in_latex.md">the lean4 repo recommends</a>, so I literally turned it off and then the ugliness is replacing lines with <code>\begin{verbatim}</code> with <code>\begin{lstlisting}</code>.</p>



<a name="284759862"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284759862" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284759862">(Jun 02 2022 at 15:15)</a>:</h4>
<p><span class="user-mention" data-user-id="321696">@Julian Berman</span> don't bother with those <code>import Lean</code>. I'm solving it in another way. I'm removing them from the top of the files</p>



<a name="284760269"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284760269" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284760269">(Jun 02 2022 at 15:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395550">Henrik Böving</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/284757569">said</a>:</p>
<blockquote>
<p>Noticed this cosmetic bug as well: <a href="/user_uploads/3121/eYLDGIG-0qptt5gHNUttOw1V/image.png">image.png</a></p>
</blockquote>
<p>This is some font alignment issue I think, since it's correct in the <code>.tex</code> file and just being misrendered, so now have to see what I'm (or really the template is) doing differently there.</p>



<a name="284761161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284761161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284761161">(Jun 02 2022 at 15:25)</a>:</h4>
<p>And btw Julian, this looking really nice. And of course requires effort.<br>
Feel free to setup a GH workflow to generate this PDF whenever you're satisfied with the result, as you proposed before <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="284793188"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284793188" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Orestis Melkonian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284793188">(Jun 02 2022 at 19:28)</a>:</h4>
<p>s/indexes/indices/g</p>



<a name="284812961"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284812961" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284812961">(Jun 02 2022 at 22:24)</a>:</h4>
<p>Updates:</p>
<ol>
<li><span class="user-mention" data-user-id="321459">@Damiano Testa</span> has added a new chapter, which is a Cheat Sheet for quick look up</li>
<li>MANY typos were fixed. Thanks everyone for the PRs</li>
<li>The DSL chapter has been simplified and I believe it's now easier to follow</li>
</ol>



<a name="284924938"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/284924938" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Julian Berman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#284924938">(Jun 03 2022 at 19:46)</a>:</h4>
<p>Third time's a charm (though not yet for CI where I'm down to issues installing DejaVu fonts...). But <a href="/user_uploads/3121/62PFBMZpXE_GWjK0Qi7ULQrn/Metaprogramming-in-Lean-4.pdf">here's a version with proper rendering</a> of unicode.</p>



<a name="285465861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285465861" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Dan Velleman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285465861">(Jun 08 2022 at 23:22)</a>:</h4>
<p>I've been reading this tutorial, and I've got a few suggestions.  These suggestions are based on my understanding of what I've read, which might not be completely correct.</p>
<p>In the chapter on MetaM, I think it would be helpful in some of the examples to explain what problem is being solved by the new functions that are being introduced.  For example, in the <code>doubleM</code> example, it might be helpful to point out that, in a context in which <code>n</code> is a free variable of type <code>Nat</code>, the expression <code>n + n</code> has type <code>Nat</code>, but the expression <code>fun (n : Nat) =&gt; n + n</code> makes sense even in a context in which <code>n</code> is not a free variable.  So to create an Expr for this function one needs to create a temporary context in which there is a free variable <code>n</code> of type <code>Nat</code>, construct the expression <code>n + n</code> in that context, and then abstract to construct the lambda expression, which will then make sense in the original context.  The purpose of the <code>withLocalDecl</code> function, as I understand it, is to create that temporary context.  Also, although I understand why you chose to use the letter n in so many places in this example, I actually found it a little confusing.  I found myself wondering whether it was necessary to use <code>n</code> as the variable in the definition of the function that is the last argument to <code>withLocalDecl</code>.  I think it might actually be clearer to write the last line as <code>fun x : Expr =&gt; mkLambdaFVars #[x] $ mkAppN (mkConst ``Nat.add) #[x, x]</code>, to make it clear that the last argument to <code>withLocalDecl</code> is a function that would take <em>any</em> free variable and construct a lambda expression using that free variable, and then that function gets applied to the variable named <code>n</code>.</p>
<p>Similarly, I'd like to see an explanation of the problem that is solved by <code>mkAppM</code> in the <code>lenExprM</code> example.  You might explain that, even though <code>#eval List.length egList</code> gives the result 4, it wouldn't work to use <code>mkApp (mkConst ``List.length) list</code> in the definition of <code>lenExprM</code>.  My understanding is that the reason for this is that <code>List.length</code> has an implicit argument for the type of the elements of the list.  That argument is inferred by Lean when you give the command <code>#eval List.length egList</code>, but it is not inferred by <code>mkApp</code>.  As I understand it, <code>mkAppM</code> solves this problem by inferring and filling in the missing argument.  (Would it work to use <code>mkApp (mkApp (mkConst ``List.length) (mkConst ``Nat)) list</code> in the definition of <code>lenExprM</code>?  It seems to work without <code>reduce</code>, but when I include <code>reduce</code> I get an error message.  Why?)</p>
<p>In the <code>propM</code> example, it seems like <code>mkAppM</code> is being used for a much less important reason.  It might be clearer to use <code>let rhs := mkApp f (mkApp (mkConst ``Nat.succ) n)</code>, since there is no implicit argument that needs to be filled in here, so there is no need for <code>mkAppM</code>.</p>
<p>Finally, I think it might be helpful to have a little more explanation of the role of monads here.  I don't mean an explanation of the theory behind monads.  I'd just like more explanation of the practical effects of declaring something to have type <code>MetaM Expr</code> rather than <code>Expr</code>.  For example, as I understand it, if <code>F</code> has type <code>Expr</code> then I can write <code>let x := F</code>, but if it has type <code>MetaM Expr</code> then I have to write <code>let x ← F</code>.</p>



<a name="285466900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285466900" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285466900">(Jun 08 2022 at 23:35)</a>:</h4>
<p>First things first thank you for the feedback, I think it will definitely help to clear up the issue I'm about to describe^^</p>
<p>We are aware of the issues surrounding the <code>MetaM</code> chapter, particularly that it doesn't really have a thread of thought, there is just things being introduced at random, we hope to clear this up eventually. The reason it is done this way is mostly because <code>MetaM</code> is a tool to be used by the future chapters and not exactly a thing on its own, you usually don't see <code>MetaM</code> being used alone, it's always <code>MetaM</code> getting called from a <code>TermElabM</code>, a <code>TacticM</code> etc.</p>
<p>Regarding monads, the book right now assumes that the user has a grasp on what a monad does up to what monad stacks are, there is some material on what those are and what they do in the temp folder: <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/temp/monad-stacks.lean">https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/temp/monad-stacks.lean</a>. For your basic example, not exactly right, if <code>F</code> has type <code>MetaM Expr</code> you can still write <code>let x := F</code> and it will have type <code>MetaM Expr</code>. If you want to unwrap the <code>Expr</code> value from the <code>MetaM</code> monad you have to use the arrow notation. As a very dumbed down view ( I will refrain from writing yet another monad tutorial here, but maybe in the future if the need arises) you can think of <code>let x &lt;- F</code> notation as a "programmable semicolon" that is if you write some let binding with an arrow like this there will be some sort of additional thing happening implicitly, depending on what monad you ar eoperating in, this can be a variety of effects:</p>
<ul>
<li>in the <code>IO</code> monad its actually performing the <code>IO</code> operation</li>
<li>in the <code>Option</code> monad it checks whether the value on the right hand side is a <code>None</code> and if it is will return early from the function you are currently in with a <code>None</code></li>
<li>in the <code>State</code> monad it might make changes to your state.</li>
<li>in the <code>Reader</code> monad it might read from the read only state that is getting explicitly passed around</li>
</ul>
<p>and so on. Most of the Monads you see in Lean meta programming are a monad stack (which is basically a combination of multiple of these effects) that consist of <code>State</code> and <code>Reader</code>, so they provide your program with some read only and some writeable state that enables you to have a nicer meta programming experience in this case.</p>



<a name="285466968"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285466968" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Dan Velleman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285466968">(Jun 08 2022 at 23:36)</a>:</h4>
<p>Oh, and one more thing.  In the <code>oneMetaVar</code> example, I think the explanation before the example gets the roles of <code>mvar2</code> and <code>mvar3</code> backwards.</p>



<a name="285467020"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285467020" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Dan Velleman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285467020">(Jun 08 2022 at 23:37)</a>:</h4>
<p>(deleted)</p>



<a name="285468130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285468130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285468130">(Jun 08 2022 at 23:54)</a>:</h4>
<p><span class="user-mention" data-user-id="453098">@Dan Velleman</span> you can edit your posts fyi</p>



<a name="285468634"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285468634" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Dan Velleman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285468634">(Jun 08 2022 at 23:59)</a>:</h4>
<p>Thanks Henrik.  Yes, you're right, I wasn't precise enough in my attempt to distinguish between <code>MetaM Expr</code> and <code>Expr</code>.</p>
<p>My knowledge of monads is limited to what I learned from Chapters 6 and 7 of The Hitchhiker's Guide to Logical Verification.  That was enough for me to learn to write simple tactics in Lean 3, and in fact I eventually decided that it was more than I needed to know for that purpose--to write tactics, I really just had to know when to use <code>:=</code> and when to use <code>←</code>, when to use <code>return</code>, and how to deal with the fact that a tactic might fail.  It would be nice if the tutorial you are writing could be written in such a way that it would be readable by someone with my limited knowledge of monads--if that's possible.</p>



<a name="285473849"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285473849" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285473849">(Jun 09 2022 at 01:16)</a>:</h4>
<p>In my current understanding, covering monads is not an easy task. Mostly because it's hard to to hit the sweetspot for what the reader needs. Monadic programming is an involved topic in itself and could be covered on a reasonably long chapter of a book about functional programming.</p>
<p>On the other hand, I'm a fan of self-contained sources of knowledge, so there's clearly a conflict for me. I really don't know if a short intro to monads in Lean 4 would be helpful or if it would be vague enough to cause more confusion! Maybe a section in the intro chapter talking about the syntax and keywords? Mostly to mention some things you mentioned like <code>&lt;-</code> versus <code>:=</code>, <code>do</code> notation and when to use <code>return</code>.</p>
<p><span class="user-mention" data-user-id="112857">@Leonardo de Moura</span> do you know how this topic will be covered in the <code>Functional Programming in Lean</code> book?</p>



<a name="285475532"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285475532" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Leonardo de Moura <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285475532">(Jun 09 2022 at 01:44)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> Yes, the book will cover monadic programming :) <br>
cc <span class="user-mention" data-user-id="354934">@David Thrane Christiansen</span></p>



<a name="285490879"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285490879" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Thrane Christiansen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285490879">(Jun 09 2022 at 06:19)</a>:</h4>
<p>Here's the current plan, subject to revision as the text reveals itself. The book will cover what I think are the basic skills of functional programming:</p>
<ul>
<li>Understanding computation as evaluation of expressions</li>
<li>How to think about honest-to-goodness side effects in that context</li>
<li>Programming with structures like functors, monads, monoids, etc, and thinking about code as "programming up to axioms" rather than just seeing what a concrete instance does (this includes do-notation and the like)</li>
<li>Higher-order functions, functions as values</li>
<li>Polymorphism and how polymorphic function types help write correct programs by restricting the allowable variation in the implementation</li>
</ul>
<p>I'll also have some things about dependently-typed functional programming:</p>
<ul>
<li>Making friends with a termination checker, various techniques for making things structurally recursive where possible</li>
<li>Using universes a la Tarski to do things like what people use GADTs for in Haskell</li>
</ul>
<p>And of course some things about Lean 4 in particular:</p>
<ul>
<li>How to think about and evaluate the run-time performance of programs</li>
<li>How partial functions work</li>
<li>Useful tools in the Lean libraries, like arrays</li>
<li>An intro to the FFI</li>
</ul>



<a name="285667731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285667731" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285667731">(Jun 10 2022 at 12:24)</a>:</h4>
<p>I should clarify (I really should have responded) that there was a common motivation for many of the examples there (which I put), which was forward/mixed reasoning. I did not mention this as I thought the application was not of great interest, but as there is clear feedback from many that a goal helps, I will try to bring this in.</p>
<p>Part of the problem is that finally doing forward reasoning generally needs one to go to the <code>TermElabM</code> level. But I will try to give examples that do not need this.</p>
<p>Specifically:</p>
<ul>
<li><code>mkAppM</code> is used for forward reasoning if we want to generate terms by applying functions wherever this is legal.</li>
<li><code>withLocalDecl</code> is used with <code>mkAppM</code> if one wants to prove say _modus ponens_.</li>
</ul>
<p>As I said I will try to make a PR with such motivating examples.</p>



<a name="285791351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285791351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285791351">(Jun 11 2022 at 18:15)</a>:</h4>
<p>I took some time to read the metaprogramming book (a version I printed a couple of days ago). It was really a quick read, without typing any code. I only wanted to get an idea of what is covered and provide some quick feedback.  The most important point is I'm grateful that all the authors took time to write documentation. </p>
<p>However the main impression I get from this book is that meta-programming is much more complicated in Lean 4 than in Lean 3. It's probably because you wanted to explain shiny new stuff that is not really needed for easy tactic writing.  I also think that a major difficulty is that many of the authors are not so interested in theorem proving but rather in programming or theory of programming languages. For instance I couldn't get anything from the chapter "Embeddin DSLs by elaboration". I have no idea what this chapter is about, and I guess this was announced by the sentence "IMP, which is a simple imperative language, often used for teaching operational and denotational semantics." (I don't know what operational and denotational semantic means). </p>
<p>To illustrate why it all feels more complicated than Lean 3, let's consider the <code>assumption</code> tactic (which is confusingly called <code>custom_trivial</code> although it has nothing to do with <a href="https://leanprover-community.github.io/mathlib_docs/tactics.html#trivial">tactic#trivial</a>). In <a href="https://leanprover-community.github.io/extras/tactic_writing.html">https://leanprover-community.github.io/extras/tactic_writing.html</a>, this is a 4 lines long tactic. In <a href="https://youtu.be/-RQQxFVZnn4?list=PLlF-CfQhukNnq2kDCw2P_vI5AfXN7egP2&amp;t=928">https://youtu.be/-RQQxFVZnn4?list=PLlF-CfQhukNnq2kDCw2P_vI5AfXN7egP2&amp;t=928</a> Rob golfed it to one line. In the Lean 4 book it's 13 lines long...</p>
<div class="youtube-video message_inline_image"><a data-id="-RQQxFVZnn4" href="https://youtu.be/-RQQxFVZnn4?list=PLlF-CfQhukNnq2kDCw2P_vI5AfXN7egP2&amp;t=928"><img src="https://uploads.zulipusercontent.net/bd0cf2c97580f0ba298f730cb4186d8620b3a5d3/68747470733a2f2f692e7974696d672e636f6d2f76692f2d5251517846565a6e6e342f64656661756c742e6a7067"></a></div><p>Maybe we could have an introduction that would be closer to a translation of <a href="https://leanprover-community.github.io/extras/tactic_writing.html">https://leanprover-community.github.io/extras/tactic_writing.html</a>, with some pointers to later chapters for more details and fancier ways.</p>



<a name="285791480"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285791480" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285791480">(Jun 11 2022 at 18:19)</a>:</h4>
<p>Patrick, even though I am one of the authors, I share your view.  I am planning to learn more metaprogramming in Lean4 and implement a simple tactic, from a more naïve point of view and maybe write, either a chapter or a separate document with more details.</p>



<a name="285791540"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285791540" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Damiano Testa <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285791540">(Jun 11 2022 at 18:20)</a>:</h4>
<p>(Also note that my main contribution to the book has been to write the cheat-sheet, which I hoped to be more useful for what you are saying.)</p>



<a name="285791753"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285791753" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285791753">(Jun 11 2022 at 18:27)</a>:</h4>
<p>Now I'll list some more specific comments or suggestions. Page numbers refers to Julian's pdf at <a href="user_uploads/3121/62PFBMZpXE_GWjK0Qi7ULQrn/Metaprogramming-in-Lean-4.pdf">https://leanprover.zulipchat.com/user_uploads/3121/62PFBMZpXE_GWjK0Qi7ULQrn/Metaprogramming-in-Lean-4.pdf</a></p>
<ul>
<li>Page 3, the acronym AST is not defined anywhere.</li>
<li>Page 5 is the first appearance of <code>withStuff</code>. At that point it's officially not meant to be understood, but later in MetaM chapter it is also not really explained.</li>
<li>Page 13 and in many other places there are lists that are not rendered correctly. It works nicely where seen on <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/md/main/metam.md">https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/md/main/metam.md</a>, but not in the pdf. Also in the pdf many comments go out of the page.</li>
<li>Page 13, could you tell what <code>N</code> and <code>M</code> stand for in <code>mkAppN</code> and <code>mkAppM</code>? That would help remembering which one is which</li>
<li>Page 19, in the last code block near the bottom, what are <code>:10</code> and <code>:11</code>? I understand they refer to precedences. But are they actual Lean syntax or stuff you write to tell something to readers? The whole precedence thing really needs a lot of explanation. In Lean 3 they are rather difficult to understand and users need to understand them as soon as they want to define any notation. Sebastian told is a long time ago that they will be easier to understand in Lean 4, but they  still requires a careful explanation. About notation, one very difficult part in Lean 3 is notation involving binders (using <code>scoped</code>). It would be nice to explicitly show examples of how it's done in Lean 4. I guess this is somewhere in the syntax chapter, but again having more mathematical examples would help immensely. For instance describing notations with binders for integrals. Or even the union examples from Sebastian's famous state of the union talk;</li>
<li>Page 31, I cannot make any sense of the first sentence.</li>
<li>Page 49,  the first paragraph refers to <code>admit</code> that appears nowhere in the code</li>
</ul>



<a name="285791800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285791800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285791800">(Jun 11 2022 at 18:28)</a>:</h4>
<p>But let me insist again on the fact that I'm very grateful and I hope you will all continue this effort, maybe adding examples for us mere mathematicians.</p>



<a name="285794147"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285794147" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285794147">(Jun 11 2022 at 19:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285791351">said</a>:</p>
<blockquote>
<p>s. For instance I couldn't get anything from the chapter "Embeddin DSLs by elaboration". I have no idea what this chapter is about, and I guess this was announced by the sentence "IMP, which is a simple imperative language, often used for teaching operational and denotational semantics." (I don't know what operational and denotational semantic means). </p>
</blockquote>
<p>This is in fact by design, if you look further up this thread you will see that we constructed a DAG <a href="user_uploads/3121/n9oow1Wc3UKgQn3FdQc7Bhg1/image.png">https://leanprover.zulipchat.com/user_uploads/3121/n9oow1Wc3UKgQn3FdQc7Bhg1/image.png</a><br>
For the topics, as you can see the DSL part is one of the two tips of the DAG and is entirely unrelated to tactics, if you are only interested in tactics you can ignore it and the things that point to it basically. </p>
<div class="message_inline_image"><a href="user_uploads/3121/n9oow1Wc3UKgQn3FdQc7Bhg1/image.png" title="https://leanprover.zulipchat.com/user_uploads/3121/n9oow1Wc3UKgQn3FdQc7Bhg1/image.png"><img src="user_uploads/3121/n9oow1Wc3UKgQn3FdQc7Bhg1/image.png"></a></div><p>The general idea was that if a reader wanted to learn about a certain topic they could just look at the DAG and read up on all topics required for what they want to learn.</p>



<a name="285794657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285794657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285794657">(Jun 11 2022 at 19:42)</a>:</h4>
<p>That being said thanks for the feedback, I'll try to improve on my explanation of Syntax....guess you will have to re <span aria-label="printer" class="emoji emoji-1f5a8" role="img" title="printer">:printer:</span></p>



<a name="285813750"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285813750" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285813750">(Jun 12 2022 at 02:15)</a>:</h4>
<p><span class="user-mention" data-user-id="110031">@Patrick Massot</span> I am very grateful that you took the time to read the book and provide feedback, with some careful details, even!</p>
<p>If you scroll up to the very beginning of this thread, you will see that my first effort would be to make a tutorial focused on tactics specifically. And I indeed tried to do so! But it was just super hard to accomplish that goal because my impression (just like yours) is that metaprogramming in Lean 4 is indeed more complex.</p>
<p>In Lean 3, we do linters, tactics and notations, roughly speaking. In Lean 4, as a fully fledged general purpose programming language, the metaprogramming capabilities have to accommodate for much more possibilities. And while I, as a software engineer with a CS background, find it all just incredibly interesting, I also admit that the bar has been raised a bit higher for tactic writing. This is my impression.</p>
<p>One of the goals of the book is to situate the reader in a way that they would have a much easier time reading and understanding what's already in the Mathlib4 repo. There are syntax definitions, macros, macro rules (which can also be recursive!), elab, elaboration functions, more monads... There's clearly more ways to make tactics in Lean 4. In Lean 3, you declare your monadic function that consumes some parsers and you're pretty much set to write your logic.</p>
<p>I will iterate on your feedback and complement the intro chapter. I will also add the DAG that Henrik posted here so the reader will have an easier time when reading the book with a more specific goal in mind.</p>
<p>Thank you again for the feedback!!</p>



<a name="285818883"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285818883" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285818883">(Jun 12 2022 at 04:08)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="110031">@Patrick Massot</span> for the feedback. I have added quite a bit to the explanations in the metam chapter in a PR. I would be happy to add more explanations, examples etc based on feedback.</p>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> I have made a PR. I feel now that my planned motivation adds a lot to the complexity so make make things harder for the reader. I am taking as the thread here: constructing and manipulating expressions, to be used for tactics and elaborators.</p>



<a name="285819607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285819607" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285819607">(Jun 12 2022 at 04:25)</a>:</h4>
<p>Will review after I wake up</p>



<a name="285826721"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285826721" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285826721">(Jun 12 2022 at 07:22)</a>:</h4>
<p>I just took my first look at the book and I am very impressed with how much work all of you have put into it! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span>  You have also already outstripped the breadth of my knowledge in Lean 4 metaprogramming,  which shows just how much more I have to learn! However, as person who has done a good bit of metaprogramming in other languages (e.g., Python, Ruby, Haskell, Java, C++), I do find your definition of the related terms rather narrowly tailored to Lean? Is that intentional?</p>
<p>For example, the term <strong><em>reflection</em></strong>  in metaprogramming is generally used in interpreted languages like Python, Ruby, Java, and JavaScript to refer to introspection of the program's own code. That is, listing the functions, classes, methods, imported modules etc.; finding and inspecting their sources, and other analysis tasks. The term <strong><em>metaprogramming</em></strong> generally includes reflection, instrumentation, and other forms of dynamically generating and inspecting code. Such techniques are available in many languages without extensible syntax and  in the same language as the source.</p>
<p>However, the books makes statements like: "the meta-level activities are done in a different language to the one that we use to write code" and "One cool thing about Lean, though, is that it allows us [...] to implement our own meta-level routines to elaborate those in the very same development environment that we use to perform object-level activities". Such a characterization would be very weird for someone coming from Ruby, Python, C++, or even JavaScript and Java (to an extent) where metaprogramming is generally though of just another part of the same language (though Java does also have external template engines for metaprogramming like Apache Velocity and JavaScript has its many transpilers). The fact the book terms this feature "reflection" would also be weird, though I can somewhat see the connection.</p>
<p>I did notice that most of the examples cited were other  theorem provers / functional programming languages (e.g., Isabelle, Coq, and Haskell), so this may be due to a difference between the communities. I would be curious to hear how others understand the term "metaprogramming" and "reflection"  and why they do. New perspectives are always interesting!</p>
<p>Anyway, sorry for the long essay about the second heading of the first chapter of the book (and a rather short section at that). I will hopefully have more practical and less philosophical comments about the rest of the book as I make my way through it. This part just particularly stuck out to me due to the unfamiliar framing -- especially since I thought I had a rather uncontroversial understanding of the general meanings of the terms being used here.</p>



<a name="285826918"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285826918" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285826918">(Jun 12 2022 at 07:28)</a>:</h4>
<p>Interesting StackOverflow question on the topic: <a href="https://stackoverflow.com/questions/514644/what-exactly-is-metaprogramming">https://stackoverflow.com/questions/514644/what-exactly-is-metaprogramming</a></p>



<a name="285830856"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285830856" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285830856">(Jun 12 2022 at 09:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285791753">said</a>:</p>
<blockquote>
<p>The whole precedence thing really needs a lot of explanation. In Lean 3 they are rather difficult to understand and users need to understand them as soon as they want to define any notation. Sebastian told is a long time ago that they will be easier to understand in Lean 4, but they  still requires a careful explanation.</p>
</blockquote>
<p>I'm curious, have you read <a href="https://leanprover.github.io/lean4/doc/notation.html">https://leanprover.github.io/lean4/doc/notation.html</a>? What do you think of that explanation?</p>



<a name="285831687"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285831687" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285831687">(Jun 12 2022 at 09:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285791351">said</a>:</p>
<blockquote>
<p>However the main impression I get from this book is that meta-programming is much more complicated in Lean 4 than in Lean 3.</p>
</blockquote>
<p>It really doesn't have to be, apart from learning finer-grained APIs and monad hierarchies. Also, I think you forgot to count the helper method used in the paper <code>assumption</code> impl. I would argue the following is a more idiomatic implementation in Lean 4.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="c">/-</span><span class="cm"></span>
<span class="cm">meta def find_matching_type (e : expr) : list expr → tactic expr</span>
<span class="cm">| []         := tactic.failed</span>
<span class="cm">| (H :: Hs)  := do t ← tactic.infer_type H,</span>
<span class="cm">                   (tactic.unify e t &gt;&gt; return H) &lt;|&gt; find_matching_type Hs</span>

<span class="cm">meta def my_assumption : tactic unit :=</span>
<span class="cm">do { ctx ← tactic.local_context,</span>
<span class="cm">     t   ← tactic.target,</span>
<span class="cm">     find_matching_type t ctx &gt;&gt;= tactic.exact }</span>
<span class="cm">&lt;|&gt; tactic.fail "my_assumption tactic failed"</span>
<span class="cm">-/</span>

<span class="n">elab</span> <span class="s2">"my_assumption"</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">target</span> <span class="bp">←</span> <span class="n">getMainTarget</span>
  <span class="n">for</span> <span class="n">ldecl</span> <span class="k">in</span> <span class="o">(</span><span class="bp">←</span> <span class="n">getLCtx</span><span class="o">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">(</span><span class="bp">←</span> <span class="n">isDefEq</span> <span class="n">ldecl.type</span> <span class="n">target</span><span class="o">)</span> <span class="k">then</span>
      <span class="n">closeMainGoal</span> <span class="n">ldecl.toExpr</span>
      <span class="n">return</span>
  <span class="n">throwTacticEx</span> <span class="bp">`</span><span class="n">my_assumption</span> <span class="o">(</span><span class="bp">←</span> <span class="n">getMainGoal</span><span class="o">)</span> <span class="n">m</span><span class="bp">!</span><span class="s2">"unable to find matching hypothesis of type{indentExpr target}"</span>
</code></pre></div>



<a name="285832566"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285832566" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285832566">(Jun 12 2022 at 09:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395550">Henrik Böving</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285794147">said</a>:</p>
<blockquote>
<p>For the topics, as you can see the DSL part is one of the two tips of the DAG and is entirely unrelated to tactics, if you are only interested in tactics you can ignore it and the things that point to it basically. </p>
</blockquote>
<p>Just wanted to note that this description is in stark contrast to the opening of the tactic chapter</p>
<blockquote>
<p>We've finally come to what may be considered by many the end goal of this book. The reason why this chapter is placed after the DSL chapter is because the tactic mode in Lean 4 is itself a DSL.</p>
</blockquote>



<a name="285835698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285835698" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285835698">(Jun 12 2022 at 11:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285830856">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285791753">said</a>:</p>
<blockquote>
<p>The whole precedence thing really needs a lot of explanation. In Lean 3 they are rather difficult to understand and users need to understand them as soon as they want to define any notation. Sebastian told is a long time ago that they will be easier to understand in Lean 4, but they  still requires a careful explanation.</p>
</blockquote>
<p>I'm curious, have you read <a href="https://leanprover.github.io/lean4/doc/notation.html">https://leanprover.github.io/lean4/doc/notation.html</a>? What do you think of that explanation?</p>
</blockquote>
<p>I think this explanation is already very good! I had to read certain sentences several times, but the topic is inherently complicated. Maybe you should first explain the number next to <code>notation</code>. And maybe it would help to explain how parsing runs on some example, with sentences like "Lean sees this token, register this information, look up in this table, then sees this token, compare that number to that other number...". </p>
<p>Also maybe focusing on associativity first is a bad move for mathematicians readers. In an average mathematician's mind,  addition and multiplication are neither left associative nor right associative. We don't even teach those words. We teach the word "associative" alone, and it mean that <code>(a+b)+c</code> and <code>a+(b+c)</code> are the same in a very strong sense. Each year when I start teaching my course using Lean I have a very hard time explaining to students that <code>a+b+c</code> has to be one of those two options and not both on equal footing, and then to explain that a lemma says those things are equal. And then much later in the course I have to go to each student at least once to unblock them when they write:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">calc</span> <span class="bp">|</span><span class="n">a</span> <span class="bp">-</span> <span class="n">b</span><span class="bp">|</span> <span class="bp">=</span> <span class="bp">|</span><span class="n">a</span> <span class="bp">-</span> <span class="n">c</span> <span class="bp">+</span> <span class="n">c</span> <span class="bp">-</span> <span class="n">b</span><span class="bp">|</span> <span class="o">:</span> <span class="kd">by</span> <span class="n">ring</span>
<span class="bp">...</span> <span class="bp">≤</span> <span class="bp">|</span><span class="n">a</span> <span class="bp">-</span> <span class="n">c</span><span class="bp">|</span> <span class="bp">+</span> <span class="bp">|</span><span class="n">c</span> <span class="bp">-</span> <span class="n">b</span><span class="bp">|</span> <span class="o">:</span> <span class="n">abs_add</span> <span class="o">(</span><span class="n">a</span><span class="bp">-</span><span class="n">c</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span><span class="bp">-</span><span class="n">b</span><span class="o">),</span>
</code></pre></div>
<p>and Lean complains it doesn't see |a - c + (c - b)|<code> anywhere (actually the situation is often much worse because they write </code>apply abs_add<code> so the error message is less helpful). So if you want to avoid stacking two difficulties on top of each other, I would definitely start the precedence discussion by explaining how the precedence number decide how to parse </code>a + b * c<code> and then, in a second step, write "by the way this also applies to an operator and itself", explaining how Lean parses </code>a - b - c<code> and </code>a^b^c<code> and, in a third step, the really psychologically complicated one: parsing </code>a + b + c`.</p>



<a name="285835855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285835855" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285835855">(Jun 12 2022 at 11:04)</a>:</h4>
<p>Sebastian, your <code>my_assumption</code> tactic looks really nice! It's very easy to read for someone knowning a bit of Lean 3 meta programming. The only confusing thing for me is <code>let target ← getMainTarget</code> which very weirdly mixes the two big classes of assignments in Lean 3: monadic ones using <code>... ← ...</code> and regular ones using <code>let ... := ...</code>.</p>



<a name="285836039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285836039" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285836039">(Jun 12 2022 at 11:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285826721">said</a>:</p>
<blockquote>
<p>I just took my first look at the book and I am very impressed with how much work all of you have put into it! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span>  You have also already outstripped the breadth of my knowledge in Lean 4 metaprogramming,  which shows just how much more I have to learn! However, as person who has done a good bit of metaprogramming in other languages (e.g., Python, Ruby, Haskell, Java, C++), I do find your definition of the related terms rather narrowly tailored to Lean? Is that intentional?<br>
[...]<br>
I did notice that most of the examples cited were other  theorem provers / functional programming languages (e.g., Isabelle, Coq, and Haskell), so this may be due to a difference between the communities. I would be curious to hear how others understand the term "metaprogramming" and "reflection"  and why they do. New perspectives are always interesting!</p>
</blockquote>
<p>For me it makes a <em>lot</em> of sense to use a vocabulary which is somewhat compatible with the vocabulary uses in other proof assistants rather than python or Java. Maybe there could be a warning sentence at the very beginning.</p>



<a name="285836195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285836195" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285836195">(Jun 12 2022 at 11:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285835855">said</a>:</p>
<blockquote>
<p>Sebastian, your <code>my_assumption</code> tactic looks really nice! It's very easy to read for someone knowning a bit of Lean 3 meta programming. The only confusing thing for me is <code>let target ← getMainTarget</code> which very weirdly mixes the two big classes of assignments in Lean 3: monadic ones using <code>... ← ...</code> and regular ones using <code>let ... := ...</code>.</p>
</blockquote>
<p>Basically that difference doesn't exist anymore, all variable bindings are <code>let</code> nowadays, you can in fact even write <code>let foo := ←bar</code> which is equivalent to <code>let foo ← bar</code></p>



<a name="285836197"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285836197" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Marc Huisinga <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285836197">(Jun 12 2022 at 11:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285835855">said</a>:</p>
<blockquote>
<p>Sebastian, your <code>my_assumption</code> tactic looks really nice! It's very easy to read for someone knowning a bit of Lean 3 meta programming. The only confusing thing for me is <code>let target ← getMainTarget</code> which very weirdly mixes the two big classes of assignments in Lean 3: monadic ones using <code>... ← ...</code> and regular ones using <code>let ... := ...</code>.</p>
</blockquote>
<p>You can think of <code>let ... ← ...</code> as being a shorter notation for <code>let ... := ← ...</code>, e.g. </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">foo</span> <span class="o">:</span> <span class="n">Reader</span> <span class="n">Nat</span> <span class="n">Nat</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">x</span> <span class="o">:=</span> <span class="bp">←</span> <span class="n">read</span>
  <span class="k">let</span> <span class="n">x'</span> <span class="bp">←</span> <span class="n">read</span>
  <span class="n">return</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">x'</span>
</code></pre></div>



<a name="285836217"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285836217" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285836217">(Jun 12 2022 at 11:11)</a>:</h4>
<p>In general the ← can go anywhere on a variable that is monadic, for example:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">if</span> <span class="bp">←</span><span class="n">foo</span> <span class="k">then</span> <span class="bp">←</span><span class="n">bar</span> <span class="k">else</span> <span class="n">foobar</span>
</code></pre></div>



<a name="285836380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285836380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285836380">(Jun 12 2022 at 11:15)</a>:</h4>
<p>Thanks Mark and Henrik! I should say that I have very mixed feelings about how much comparison with Lean 3 should be included in this kind of documentation. Maybe there should be dedicated subsections or appendices in each chapter in order to help people coming from Lean 3. But clearly it shouldn't be everywhere. One of the main reasons I came to Lean after briefly trying Coq was that all the SSReflect documentation was constantly referring to standard Coq, and I didn't want to first learn standard Coq and then unlearn it while learning SSReflect. We definitely don't want people to first learn Lean 3 in order to learn Lean 4.</p>



<a name="285836623"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285836623" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285836623">(Jun 12 2022 at 11:20)</a>:</h4>
<p>I'd try to do that but the issue is that I'd have to learn Lean 3 for that first :D</p>



<a name="285837100"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285837100" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285837100">(Jun 12 2022 at 11:31)</a>:</h4>
<p>We might get proper docstrings when hovering over <code>←</code>, <code>return</code>, etc. soon, which with LeanInk would also be displayed in an HTML version</p>



<a name="285837933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285837933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285837933">(Jun 12 2022 at 11:50)</a>:</h4>
<p>While better explanations in the book will certainly make things clearer (it's very young after all), I think there's no question that metaprogramming in Lean 4 is more complicated than in Lean 3. Off the top of my hat, new complications include:</p>
<ul>
<li>The <code>MetaM</code>/<code>TermElabM</code>/<code>TacticM</code> split (plus a couple minor monads on the side).</li>
<li>The whole syntax layer, which in Lean 3 was -- from the tactic writer's point of view -- just a combinator-based parser and some annotations on a tactic's arguments.</li>
<li>The sheer size of the API. Discoverability is much worse compared to Lean 3, where you can look at <code>tactic.lean</code> and have essentially the whole API.</li>
<li>Below <code>TacticM</code>, the need to pass the current goal explicitly, using copious shadowing and <code>withMVarContext</code>.</li>
<li><code>auxDecls</code> (Sebastian's example above has a bug related to these and I've forgotten about them many times).</li>
</ul>
<p>There are also many improvements and the new API is much more powerful, so I'm not complaining at all. But as usual, a more powerful API makes simple things harder and hard things possible. I think there might be value in a simpler API that's good enough for 80% of tactics.</p>
<p>Btw I'm currently writing more content for the <code>MetaM</code> chapter, starting with some stuff on computation.</p>



<a name="285839332"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285839332" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285839332">(Jun 12 2022 at 12:22)</a>:</h4>
<p>Other comments from reading that chapter:</p>
<ul>
<li>
<blockquote>
<p>We will start by implementing tactics that compute in TacticM and then we shall see how some tactics can be implemented as macros.</p>
</blockquote>
<p>I would probably have went with the other order, top-down.</p>
</li>
<li>
<blockquote>
<p>This informs the elaborator that in the context of elaborating tactics, the piece of syntax admit must be elaborated as what we write to the right-hand-side of the =&gt; (we fill the ... with the body of the tactic).</p>
</blockquote>
<p>nit: The tactic is not named <code>admit</code>, and there are no <code>...</code></p>
</li>
<li>
<p><code>sorryAx</code> should probably be explained</p>
</li>
<li></li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"custom_sorry_2"</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">goal</span> <span class="bp">←</span> <span class="n">Lean.Elab.Tactic.getMainGoal</span>
  <span class="k">let</span> <span class="n">goal_declaration</span> <span class="bp">←</span> <span class="n">Lean.Meta.getMVarDecl</span> <span class="n">goal</span>
  <span class="k">let</span> <span class="n">goal_type</span> <span class="o">:=</span> <span class="n">goal_declaration.type</span>
  <span class="n">Lean.Elab.admitGoal</span> <span class="n">goal</span>
</code></pre></div>
<p>I understand the educational goal, but it's a bit weird that half of the code is not even used. Perhaps there are better examples. Also style nitpicks here and throughout: snake case and overuse of namespaced names. I assume the latter are are intended for better understanding the code outside of an interactive environment, but to me it makes the code look overcrowded, and this is again something that LeanInk would solve.</p>
<ul>
<li></li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">TacticM</span> <span class="bp">=</span> <span class="n">ReaderT</span> <span class="n">Context</span> <span class="bp">$</span> <span class="n">StateRefT</span> <span class="n">State</span> <span class="n">TermElabM</span>
</code></pre></div>
<p>This is the one place where I would expect namespaces: <code>Tactic.Context/State</code></p>
<ul>
<li></li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">(</span><span class="n">H2</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">=</span> <span class="mi">2</span><span class="o">):</span> <span class="mi">2</span> <span class="bp">=</span> <span class="mi">2</span>
</code></pre></div>
<p>nit: spacing here and elswhere</p>
<ul>
<li>
<blockquote>
<p>We get the type of LocalDefinition by calling Lean.Meta.inferType on the local declaration's expression.</p>
</blockquote>
<p>Below you show that this is not necessary as there is <code>LocalDefinition.type</code></p>
</li>
<li>
<blockquote>
<p>Until now, we've only performed read-like operations with the context. But what if we want to change it?<br>
In this section we will see how to change the order of goals [...]</p>
</blockquote>
<p>This first example looks misplaced, it does not change the context</p>
</li>
<li>
<blockquote>
<p>For this task, first we will need to use Lean.Elab.Tactic.withMainContext, which can run commands taking into consideration the entire goal state.</p>
</blockquote>
<p>This is just as relevant for the <code>assumption</code>-like tactic before. Indeed, it should be added to my implementation as well, at which point together with <code>isAuxDecl</code> it is basically the built-in implementation.</p>
</li>
<li>
<blockquote>
<p>We write this as a macro expansion, which expands the piece of syntax custom_sorry_macro into the piece of syntax sorry:</p>
</blockquote>
<p>Is this a good first example? Most people think of <code>sorry</code> as a term I would assume, not a tactic.</p>
</li>
<li>
<blockquote>
<p>Extensible Tactics by Macro Expansion</p>
</blockquote>
<p>It should be noted that tactic elaborators are equally extensible</p>
</li>
<li>
<blockquote>
<p>Here, a &lt;;&gt; b means "run tactic a, and apply "b" to each goal after running a".</p>
</blockquote>
<p>No, it means to apply <code>b</code> to each goal *produced by <code>a</code>. Thus the implementation needs an extra set of braces/focus:</p>
</li>
</ul>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="o">{</span> <span class="bp">$</span><span class="n">a</span><span class="o">:</span><span class="n">tactic</span><span class="bp">;</span> <span class="n">all_goals</span> <span class="bp">$</span><span class="n">b</span><span class="o">:</span><span class="n">tactic</span> <span class="o">})</span>
</code></pre></div>
<p>("But what if <code>a</code> consumes more than one goal"? This is indeed an issue with the built-in implementation of <code>&lt;;&gt;</code> as well I'd say.)</p>
<ul>
<li>
<blockquote>
<p>In fact, &lt;;&gt; itself is a tactic combinator. </p>
</blockquote>
<p>Did you mean "tactic macro"?</p>
</li>
<li>
<blockquote>
<p>One can create tactic syntax using the macro (tactic| ⋯).</p>
</blockquote>
<p>missing backtick</p>
</li>
</ul>
<p>This is not meant as criticism, I like the overall structure and examples of the chapter.</p>



<a name="285841171"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285841171" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285841171">(Jun 12 2022 at 12:58)</a>:</h4>
<p><span class="user-mention" data-user-id="256311">@Jannis Limperg</span> thanks a lot! Are you building on top of the PR that <span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span> wrote? I haven't looked at it yet (still in bed) but it will be easier if we don't need to clash content with merge conflicts</p>



<a name="285841190"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285841190" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285841190">(Jun 12 2022 at 12:58)</a>:</h4>
<p>I'll merge this PR, yes.</p>



<a name="285841380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285841380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285841380">(Jun 12 2022 at 13:02)</a>:</h4>
<p>Also thank you <span class="user-mention" data-user-id="315577">@Mac</span> ! Please feel free to propose changes. You're clearly more experienced than me with these concepts from other languages</p>
<p>And thank you <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> ! Your input is invaluable</p>



<a name="285848685"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285848685" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285848685">(Jun 12 2022 at 15:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285791753">said</a>:</p>
<blockquote>
<p>Now I'll list some more specific comments or suggestions. Page numbers refers to Julian's pdf at <a href="user_uploads/3121/62PFBMZpXE_GWjK0Qi7ULQrn/Metaprogramming-in-Lean-4.pdf">https://leanprover.zulipchat.com/user_uploads/3121/62PFBMZpXE_GWjK0Qi7ULQrn/Metaprogramming-in-Lean-4.pdf</a></p>
<ul>
<li>Page 3, the acronym AST is not defined anywhere.</li>
<li>Page 5 is the first appearance of <code>withStuff</code>. At that point it's officially not meant to be understood, but later in MetaM chapter it is also not really explained.</li>
<li>Page 13 and in many other places there are lists that are not rendered correctly. It works nicely where seen on <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/md/main/metam.md">https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/md/main/metam.md</a>, but not in the pdf. Also in the pdf many comments go out of the page.</li>
<li>Page 13, could you tell what <code>N</code> and <code>M</code> stand for in <code>mkAppN</code> and <code>mkAppM</code>? That would help remembering which one is which</li>
<li>Page 19, in the last code block near the bottom, what are <code>:10</code> and <code>:11</code>? I understand they refer to precedences. But are they actual Lean syntax or stuff you write to tell something to readers? The whole precedence thing really needs a lot of explanation. In Lean 3 they are rather difficult to understand and users need to understand them as soon as they want to define any notation. Sebastian told is a long time ago that they will be easier to understand in Lean 4, but they  still requires a careful explanation. About notation, one very difficult part in Lean 3 is notation involving binders (using <code>scoped</code>). It would be nice to explicitly show examples of how it's done in Lean 4. I guess this is somewhere in the syntax chapter, but again having more mathematical examples would help immensely. For instance describing notations with binders for integrals. Or even the union examples from Sebastian's famous state of the union talk;</li>
<li>Page 31, I cannot make any sense of the first sentence.</li>
<li>Page 49,  the first paragraph refers to <code>admit</code> that appears nowhere in the code</li>
</ul>
</blockquote>
<p>Regarding this state of the union talk, I took a look at this version on you tube <a href="https://www.youtube.com/watch?v=yAizjui7CKA">https://www.youtube.com/watch?v=yAizjui7CKA</a> but the sound is rather meh  and the image is...well you can see the image, is there a better version available somewhere? Otherwise I guess I'll follow the sound and read the presentation as PDF next to the video.</p>
<div class="youtube-video message_inline_image"><a data-id="yAizjui7CKA" href="https://www.youtube.com/watch?v=yAizjui7CKA"><img src="https://uploads.zulipusercontent.net/3324b89f5b6ea55eef9ec2850c6bed563493c385/68747470733a2f2f692e7974696d672e636f6d2f76692f7941697a6a756937434b412f64656661756c742e6a7067"></a></div>



<a name="285854164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285854164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285854164">(Jun 12 2022 at 17:59)</a>:</h4>
<p>(just watching with the described approach now)</p>



<a name="285855562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285855562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285855562">(Jun 12 2022 at 18:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285836039">said</a>:</p>
<blockquote>
<p>For me it makes a <em>lot</em> of sense to use a vocabulary which is somewhat compatible with the vocabulary uses in other proof assistants rather than python or Java. Maybe there could be a warning sentence at the very beginning.</p>
</blockquote>
<p>As Lean is part proof assistant, I can see that rational. However, it is also intending to be a general purpose language, and the book's intent seems to be a general introduction to metaprogramming Lean. Thus, it seems like it should try to be a smooth transition both for those coming from the theorem proving world and those coming from the general purpose programming world. Therefore, orienting its focus within both frames of reference and having examples from both spaces seems like worthwhile goal.</p>
<p>Also, I don't even know if the vocabulary currently used in the book is in fact more natural to the theorem proving community. For all I know, the current framing could be novel to both domains. I haven't delved into other theorem provers sufficiently to know how they define metaprogramming. I just know that it fell weird coming from my background (of Ruby, Python, C++, Java, JavaScript, and Haskell).</p>



<a name="285855639"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285855639" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285855639">(Jun 12 2022 at 18:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/285841380">said</a>:</p>
<blockquote>
<p>Also thank you <span class="user-mention silent" data-user-id="315577">Mac</span> ! Please feel free to propose changes. You're clearly more experienced than me with these concepts from other languages.</p>
</blockquote>
<p>You're welcome! I might hopefully write-up with a few tweaks in the future.  <span aria-label="pen" class="emoji emoji-1f58a" role="img" title="pen">:pen:</span></p>



<a name="285869429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285869429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285869429">(Jun 13 2022 at 00:18)</a>:</h4>
<p>Dear all (Damiano's style!),</p>
<p>I want to seize the opportunity and sincerely thank everyone who's helped out so far. I cannot see any way of writing this book other than by collaboration: each of us is able to understand and structure some parts of the content, and together I believe we have a reasonable coverage of what metaprogramming in Lean 4 is about.</p>
<p>Some updates:</p>
<ul>
<li><span class="user-mention" data-user-id="266304">@Siddhartha Gadgil</span> and <span class="user-mention" data-user-id="256311">@Jannis Limperg</span> have improved the <code>MetaM</code> chapter. It may not be perfect yet, but we've made some progress</li>
<li>I've improved the intro chapter, being more explicit about the goal of the book and its structure</li>
<li>I've also made some drastic changes to the chapter on tactics based on the feedback from <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> </li>
<li><span class="user-mention" data-user-id="395550">@Henrik Böving</span> is working on the comments from <span class="user-mention" data-user-id="110031">@Patrick Massot</span> (we'll ask for your feedback again soon, Patrick!)</li>
<li>I've created an issue for the comments from <span class="user-mention" data-user-id="453098">@Dan Velleman</span>. We'll review them after the <code>MetaM</code> chapter is more complete</li>
</ul>
<p>The topic is broad and getting the level of details right is <em>hard</em>. Thus, we rely on more readers exposing what's confusing for them. So, if you read the book and don't understand something, please let us know!</p>
<p>There's a PDF link in the README (thank you <span class="user-mention" data-user-id="321696">@Julian Berman</span>!):<br>
<a href="https://github.com/arthurpaulino/lean4-metaprogramming-book">https://github.com/arthurpaulino/lean4-metaprogramming-book</a></p>



<a name="285897108"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285897108" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285897108">(Jun 13 2022 at 08:41)</a>:</h4>
<p>I made a tiny PR (inserting two blank lines) to hopefully fix a formatting issue.</p>



<a name="285976497"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285976497" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Alex Keizer <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285976497">(Jun 13 2022 at 19:19)</a>:</h4>
<p>First of all, I, too, want to thank everyone working on this tutorial. It really helps a lot in understanding how metaprogramming works.</p>
<p>As for my feedback:</p>
<ul>
<li>I agree with the earlier comments surrounding reflection being confusing coming from a general purpose programming background.</li>
<li>
<p>Similarly, I'd argue most (general purpose) systems do metaprogramming in the same language (Java/C++/Rust). Maybe changing the wording of the introduction to "In most <em>theorem provers</em>, the meta-level activities are done in a different language". I'll concede this point is approaching nitpicking, though.</p>
</li>
<li>
<p>The paragraph below the <code>MonadQuotation</code> code (page 41 of the pdf) is a bit confusing. I don't see where a "function of type <code>Syntax -&gt; m a</code>" is being evaluated? I thought this was talking about <code>withRef, but that seems to execute a monadic action with some given syntax. From the text I'd expect a function </code>(Syntax -&gt; m a) -&gt; m a`</p>
</li>
</ul>
<p>The topic I'd like to see covered a bit more is how parser/syntax-combinators interact with anti-quotations. For example, what is going in with <code>$[$loc]?</code> in this code</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">macro_rules</span>
<span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="n">clean</span> <span class="bp">$</span><span class="n">tac</span><span class="o">:</span><span class="n">tactic</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">loc</span><span class="o">:</span><span class="n">location</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="bp">$</span><span class="n">tac</span><span class="bp">;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">clean</span><span class="o">]</span> <span class="bp">$</span><span class="o">[</span><span class="bp">$</span><span class="n">loc</span><span class="o">]</span><span class="bp">?</span><span class="o">)</span>
</code></pre></div>
<p>But also, how do I use an <code>ar : Array Syntax</code> in an antiquotation where a delimited list of things is expected (I think that is <code>$[ar]*</code>, right)?</p>
<p>Finally, the section on hygiene might also want to clarify that if a macro expands to some <code>def foo := "bar"</code>, <code>foo</code> is also subject to hygiene (this came unexpected for me, even after reading the macro hygiene paper, and is quite difficult to debug/realize by oneself), plus a note on how to circumvent hygiene for names that you do want to be accessible outside the macro scope (i.e., the <code>mkIdent</code> trick)</p>



<a name="285980260"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/285980260" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#285980260">(Jun 13 2022 at 19:48)</a>:</h4>
<p>Thanks for the feedback, I opened an issue here: <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/issues/47">https://github.com/arthurpaulino/lean4-metaprogramming-book/issues/47</a>, I'll get to the syntax/macro stuff in the coming days!</p>



<a name="287387945"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/287387945" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Dan Velleman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#287387945">(Jun 24 2022 at 21:35)</a>:</h4>
<p>In the Tactics chapter, the FAQ section at the end gives an example illustrating how to access the local context.  Here's a slightly modified version of the example:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"faq_get_hypotheses"</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">ctx</span> <span class="bp">←</span> <span class="n">Lean.MonadLCtx.getLCtx</span> <span class="c1">-- get the local context.</span>
  <span class="n">ctx.forM</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">decl</span> <span class="o">:</span> <span class="n">Lean.LocalDecl</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">declExpr</span> <span class="o">:=</span> <span class="n">decl.toExpr</span> <span class="c1">-- Find the expression of the declaration.</span>
    <span class="k">let</span> <span class="n">declType</span> <span class="o">:=</span> <span class="n">decl.type</span> <span class="c1">-- Find the expression of the declaration.</span>
    <span class="k">let</span> <span class="n">declName</span> <span class="o">:=</span> <span class="n">decl.userName</span> <span class="c1">-- Find the name of the declaration.</span>
    <span class="n">dbg_trace</span> <span class="n">f</span><span class="bp">!</span><span class="s2">" local decl: name: {declName} | expr: {declExpr} | type: {declType}"</span>
  <span class="o">)</span>

<span class="kd">example</span> <span class="o">(</span><span class="n">H1</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">H2</span> <span class="o">:</span> <span class="mi">2</span> <span class="bp">=</span> <span class="mi">2</span><span class="o">):</span> <span class="mi">3</span> <span class="bp">=</span> <span class="mi">3</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="k">have</span> <span class="n">H3</span> <span class="o">:</span> <span class="mi">4</span> <span class="bp">=</span> <span class="mi">4</span> <span class="o">:=</span> <span class="n">rfl</span>
  <span class="n">faq_get_hypotheses</span>
  <span class="c1">-- local decl: name: test_faq_get_hypotheses | expr: _uniq.10814 | type: ...</span>
  <span class="c1">-- local decl: name: H1 | expr: _uniq.10815 | type: ...</span>
  <span class="c1">-- local decl: name: H2 | expr: _uniq.10816 | type: ...</span>
  <span class="n">rfl</span>
</code></pre></div>
<p>The modification is that I have added <code>have H3 : 4 = 4 := rfl</code> before the invocation of <code>faq_get_hypotheses</code>.  I was expecting to see the new hypothesis <code>H3</code> in the output, but I didn't.  Why?  How do I get access to not only the original hypotheses, but also any new hypotheses that have been added?</p>



<a name="287398850"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/287398850" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#287398850">(Jun 25 2022 at 00:04)</a>:</h4>
<p>The issue is that a <code>Lean.Elab.Tactic.withMainContext</code> is missing. I'm fixing it right now. Will try to address more issues throughout this weekend.<br>
Thanks for pointing that out!</p>



<a name="287495787"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/287495787" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Horațiu Cheval <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#287495787">(Jun 26 2022 at 14:22)</a>:</h4>
<p>At the end of the Expressions chapter,</p>
<blockquote>
<p>We next consider the helper <code>mkLambda</code> to construct a simple function named <code>cz</code> which takes any natural number and returns <code>Nat.zero</code></p>
</blockquote>
<p>To me, this reads as if we were talking about some expression <code>fun x : Nat =&gt; 0</code> to which we give the name <code>cz</code>.<br>
Am I right that this is not intended and that we are talking about the expression <code>fun cz : Nat =&gt; 0</code>, in which the variable bound by <code>fun</code> is given the name <code>cz</code>?</p>



<a name="287496120"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/287496120" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#287496120">(Jun 26 2022 at 14:30)</a>:</h4>
<p>Yes, that's a mistake in the explanation, in general an expression does not carry a name on its own.</p>



<a name="287496207"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/287496207" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#287496207">(Jun 26 2022 at 14:32)</a>:</h4>
<p>Yeah, sorry. <code>mkLambda</code> consumes a <code>Lean.Name</code> because we can give a name to the variable being bound:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>

<span class="kn">open</span> <span class="n">Lean</span> <span class="k">in</span>
<span class="kd">def</span> <span class="n">constZero</span> <span class="o">:</span> <span class="n">Expr</span> <span class="o">:=</span>
  <span class="n">mkLambda</span> <span class="bp">`</span><span class="n">cz</span> <span class="n">BinderInfo.default</span> <span class="o">(</span><span class="n">mkConst</span> <span class="bp">``</span><span class="n">Nat</span><span class="o">)</span> <span class="o">(</span><span class="n">mkConst</span> <span class="bp">``</span><span class="n">Nat.zero</span><span class="o">)</span>

<span class="n">elab</span> <span class="s2">"testing"</span> <span class="o">:</span> <span class="n">term</span> <span class="bp">=&gt;</span> <span class="n">return</span> <span class="n">constZero</span>

<span class="k">#check</span> <span class="n">testing</span> <span class="c1">-- fun cz =&gt; Nat.zero : Nat → Nat</span>
</code></pre></div>



<a name="287496218"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/287496218" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#287496218">(Jun 26 2022 at 14:32)</a>:</h4>
<p>I'm going to fix it right now. Thanks for pointing that out!</p>



<a name="287497383"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/287497383" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Horațiu Cheval <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#287497383">(Jun 26 2022 at 14:54)</a>:</h4>
<p>No problem, thanks for working on this!</p>



<a name="288544459"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288544459" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288544459">(Jul 05 2022 at 15:14)</a>:</h4>
<p>Hi everyone <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> <br>
Time for another update on the <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book">book</a>!</p>
<ul>
<li><span class="user-mention" data-user-id="256311">@Jannis Limperg</span> has drastically improved the <code>MetaM</code> chapter</li>
<li><span class="user-mention" data-user-id="395550">@Henrik Böving</span> has updated the book to use the new <code>TSyntax</code> API</li>
<li>Many minor changes and fixes to address comments mentioned by the readers</li>
</ul>
<p>To anyone interested, please give it another read to see if anything else needs a better explanation. This book is an important piece to empower the community to take more ownership of the Lean 3 =&gt; Lean 4 migration of mathlib <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="288544615"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288544615" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrés Goens <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288544615">(Jul 05 2022 at 15:16)</a>:</h4>
<p>Nice! Thanks for keeping this up to date and make it easier to digest for the rest of us :)</p>



<a name="288547657"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288547657" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288547657">(Jul 05 2022 at 15:35)</a>:</h4>
<p>Are the cheat-sheet and options chapter meant as appendices? If so then it's weird that pretty-printing come after them in the pdf.</p>



<a name="288547915"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288547915" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288547915">(Jul 05 2022 at 15:37)</a>:</h4>
<p>The book seems toe 20 pages longer than the version I have. Is this a page layout artifact or does it really comes from new content?</p>



<a name="288548296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288548296" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288548296">(Jul 05 2022 at 15:39)</a>:</h4>
<p>The syntax and macro chapter got a little bit longer for sure, elaboration was not really touched, I can't speak for the rest...I guess a git diff would show but I don't know the commit you <span aria-label="printer" class="emoji emoji-1f5a8" role="img" title="printer">:printer:</span> the book on /o\</p>



<a name="288548442"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288548442" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288548442">(Jul 05 2022 at 15:40)</a>:</h4>
<p>The <code>MetaM</code> chapter is a lot longer and more detailed <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="288548661"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288548661" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288548661">(Jul 05 2022 at 15:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/288547657">said</a>:</p>
<blockquote>
<p>Are the cheat-sheet and options chapter meant as appendices? If so then it's weird that pretty-printing come after them in the pdf.</p>
</blockquote>
<p>No appendices. Maybe the cheat-sheet and the FAQ from the chapter on tactics can be unified into a single unit. The extra chapters are like "more things you can do with metaprogramming, but not as important"</p>



<a name="288548838"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288548838" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288548838">(Jul 05 2022 at 15:43)</a>:</h4>
<p>Then I would expect the extras to be at the end. Or is pretty-printing also an extra?</p>



<a name="288548908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288548908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288548908">(Jul 05 2022 at 15:43)</a>:</h4>
<p>It's also an extra <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="288549026"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288549026" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288549026">(Jul 05 2022 at 15:44)</a>:</h4>
<p>(or at least we've been considering it an extra. we're open to suggestions of course!)</p>



<a name="288550409"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288550409" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288550409">(Jul 05 2022 at 15:54)</a>:</h4>
<p>Mathematicians certainly don't consider that having pretty printing is an extra.</p>



<a name="288550504"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288550504" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288550504">(Jul 05 2022 at 15:55)</a>:</h4>
<p>But I don't know how much we need to know. Last time I checked the notation chapter didn't do any pretty-printing, but I know there have been some PRs improving the situation in the mean time.</p>



<a name="288551209"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/288551209" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#288551209">(Jul 05 2022 at 15:59)</a>:</h4>
<p>The <code>notation</code> heuristic for pretty printing is pretty good now it will cover the vast majority of syntax. As soon as you want to pretty print stuff from <code>macro</code> or <code>macro_rules</code> etc. You'll have to consider the pretty printing chapter.</p>



<a name="289281805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289281805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Moritz Doll <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289281805">(Jul 12 2022 at 05:51)</a>:</h4>
<p>Hi,<br>
I have read through the tactics chapter and I found it really nice. Some minor complains were</p>
<ul>
<li>sometimes there are unused variables in the example code (for instance <code>goal</code> in <code>custom_assump_0</code>)</li>
<li>you sometimes use <code>Lean.Elab.Tactic.getMainTarget</code> and sometimes <code>goalDecl.type</code> to get the <code>goalType</code> and I don't see the difference and it is not explained in the text (I changed it in one example from one to the other and it just worked).</li>
<li>in <code>custom_assump_2</code> in the end there should not be a line break (isn't there some fancy unicode symbol suggesting that the line should not break in the code)</li>
<li>in <code>custom_let</code> I would have liked some explanation to what <code>elabTerm</code> does (the explanation seems to be in the introduction examples, where it says that I don't have to understand the details)</li>
</ul>
<p>I have not read the other chapters and except for the 'Tweaking the context' chapter that just worked fine for me. I guess that will change if more fancy stuff gets done in the tactics chapter.</p>



<a name="289295543"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289295543" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289295543">(Jul 12 2022 at 09:00)</a>:</h4>
<p>The process of <code>elabTerm</code> is explained (well not fully explained, large parts of the compiler are related to elabTerm but the general idea) in the elaboration chapter. In general if you want to read the tactic chapter you are expected to have read at leats:</p>
<ul>
<li>Expr</li>
<li>MetaM</li>
<li>Syntax</li>
<li>Macro</li>
<li>Elaboration</li>
</ul>



<a name="289302359"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289302359" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289302359">(Jul 12 2022 at 10:11)</a>:</h4>
<blockquote>
<ul>
<li>you sometimes use <code>Lean.Elab.Tactic.getMainTarget</code> and sometimes <code>goalDecl.type</code> to get the <code>goalType</code> and I don't see the difference and it is not explained in the text (I changed it in one example from one to the other and it just worked).</li>
</ul>
</blockquote>
<p>These are equivalent. If you already have the goal decl then probably callling <code>.type</code> is easier, but if you only need the type and not the goal itself then <code>getMainTarget</code> does both parts.</p>
<blockquote>
<ul>
<li>in <code>custom_assump_2</code> in the end there should not be a line break (isn't there some fancy unicode symbol suggesting that the line should not break in the code)</li>
</ul>
</blockquote>
<p>I wasn't able to work out where you are referring to. I don't see anything in this example that goes against the usual formatting or would be an error.</p>



<a name="289320717"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289320717" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Moritz Doll <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289320717">(Jul 12 2022 at 13:10)</a>:</h4>
<p>oh, I forgot a tab, I did not know that they had any meaning.</p>



<a name="289321538"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289321538" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Moritz Doll <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289321538">(Jul 12 2022 at 13:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395550">Henrik Böving</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/289295543">said</a>:</p>
<blockquote>
<p>The process of <code>elabTerm</code> is explained (well not fully explained, large parts of the compiler are related to elabTerm but the general idea) in the elaboration chapter. In general if you want to read the tactic chapter you are expected to have read at leats:</p>
<ul>
<li>Expr</li>
<li>MetaM</li>
<li>Syntax</li>
<li>Macro</li>
<li>Elaboration</li>
</ul>
</blockquote>
<p>I briefly looked into the elaboration chapter, but I did not find anything about the specific functions <code>elabTerm</code> and <code>elabTermEnsuringType</code>. I agree that for a understanding of tactics one has to read more, but I just wanted a brief peak into how tactic-writing works</p>



<a name="289322495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289322495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289322495">(Jul 12 2022 at 13:24)</a>:</h4>
<p>it uses <code>elabTerm</code> in the end once, though we could probably explicitly mention its meaning. In general it is the entry point to the term elaboration process as the name suggests. And that process is explained in the elaboration chapter.</p>



<a name="289329497"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289329497" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289329497">(Jul 12 2022 at 14:11)</a>:</h4>
<p><span class="user-mention" data-user-id="412682">@Moritz Doll</span> thanks! I've added a brief explanation for the unused <code>goal</code> variable</p>



<a name="289342069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289342069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Moritz Doll <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289342069">(Jul 12 2022 at 15:31)</a>:</h4>
<p>thanks Arthur. One more thing: the difference between <code>Lean.Meta.assert</code> and <code>Lean.Meta.define</code> is not explained in the text.</p>



<a name="289344186"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289344186" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289344186">(Jul 12 2022 at 15:44)</a>:</h4>
<p>This is an open question: how much should we go into detail?<br>
At this point, ctrl+clicking on them should take you to their definitions in core and there you should be able to see their docstrings and implementations, which will definitely be more instructive and precise.</p>
<p>In the intro chapter we state the goal of the book, which is not to provide a detailed notion of the API. Instead, we're trying to situate the reader and provide a bigger picture of what metaprogramming in Lean 4 is. We hope to provide enough context so the reader can explore the core code as well as understand what's already written in Mathlib4 without the same overwhelming experience I had in the past</p>



<a name="289346277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289346277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289346277">(Jul 12 2022 at 15:58)</a>:</h4>
<p>This is a hard compromise because ctrl+click is obviously not an option for those who are reading the book from a md, pdf or html. Maybe I should state in the intro chapter that cloning the repo and exploring the Lean files is encouraged for those who want to go into more details with the help of the go-to-definition functionality</p>



<a name="289347153"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289347153" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289347153">(Jul 12 2022 at 16:03)</a>:</h4>
<p>We do have docstrings in LeanInk HTML output</p>



<a name="289349831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289349831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289349831">(Jul 12 2022 at 16:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/289346277">said</a>:</p>
<blockquote>
<p>This is a hard compromise because ctrl+click is obviously not an option for those who are reading the book from a md, pdf or html.</p>
</blockquote>
<p>Also, is couldn't you also hyperlink method definitions in the PDF output as well? The only case where this seems impossible is for people who print out the book.</p>



<a name="289350559"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289350559" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289350559">(Jul 12 2022 at 16:27)</a>:</h4>
<p>It sounds like a lot of work to get everything wired for that. Maybe it's about time we migrate to LeanInk</p>



<a name="289826591"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289826591" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289826591">(Jul 16 2022 at 12:47)</a>:</h4>
<p>I'm trying to read the metaprogramming book as preparation for next week. </p>
<p>In the <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/md/main/intro.md#building-a-dsl-and-a-syntax-for-it">DSL example</a> there are <code>Arith.symbol</code>s in commented out claimed <code>#check</code> outputs, but I get <code>Arith.val</code>s in the actual output. Furthermore for <code>#check ⟪ "x" * "y" + "z" ⟫ -- precedence</code> I get a different answer, the <code>:75</code> seems to have no effect (changing it and adding 75 to other choices didn't seem to do anything?)</p>
<p>In <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/blob/master/md/main/expressions.md#constructing-expressions">this section</a> I don't see all the big numbers in the <code>#eval</code> output.</p>



<a name="289826858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289826858" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289826858">(Jul 16 2022 at 12:53)</a>:</h4>
<p><a href="https://leanprover.github.io/lean4/doc/metaprogramming-arith.html">https://leanprover.github.io/lean4/doc/metaprogramming-arith.html</a> has a correct version of the Arith grammar</p>



<a name="289827058"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289827058" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289827058">(Jul 16 2022 at 12:58)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> did you clone the book repo? I am suspecting that you are using a different toolchain</p>



<a name="289827064"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289827064" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289827064">(Jul 16 2022 at 12:58)</a>:</h4>
<p>I'm going to check it on my machine again in a few minutes</p>



<a name="289827096"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289827096" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289827096">(Jul 16 2022 at 12:59)</a>:</h4>
<p>I didn't do any repo-cloning, I was literally reading the markdown files I linked to.</p>



<a name="289827167"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289827167" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289827167">(Jul 16 2022 at 13:01)</a>:</h4>
<p>I googled, found the github repo with a bunch of links in the README and just started. What is the correct way to read the book?</p>



<a name="289827174"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289827174" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289827174">(Jul 16 2022 at 13:01)</a>:</h4>
<p>I see. The API has changed recently. <code>Expr</code> no longer carries metadata as it used to. I might just update the book to the newest toolchain</p>



<a name="289827245"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289827245" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289827245">(Jul 16 2022 at 13:03)</a>:</h4>
<p>Note that I'm not very good at computers. I'm just using a random recent lean4 I guess. It hadn't occurred to me that there was an exactly-right version.</p>



<a name="289827300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289827300" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289827300">(Jul 16 2022 at 13:04)</a>:</h4>
<p>I see two ways of reading the book: you can use the markdown files or the PDF, but if you're willing to experiment with code then cloning the repo and tweaking the Lean files is better</p>



<a name="289827324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289827324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289827324">(Jul 16 2022 at 13:05)</a>:</h4>
<p>(to make sure you're on the same version that the text was written)</p>



<a name="289827415"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289827415" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289827415">(Jul 16 2022 at 13:07)</a>:</h4>
<p>Either way, I will try to update the book today. Let's see if I can find some time</p>



<a name="289827798"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289827798" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289827798">(Jul 16 2022 at 13:16)</a>:</h4>
<p>OK so I have cloned the repo and typed <code>lake build</code> (I don't really have a clue what I'm doing) and then I open VS Code and go to <code>lean.main.intro</code> and on line 178/179 I see</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">#check</span> <span class="bp">⟪</span> <span class="s2">"x"</span> <span class="bp">*</span> <span class="s2">"y"</span> <span class="bp">+</span> <span class="s2">"z"</span> <span class="bp">⟫</span> <span class="c1">-- precedence</span>
<span class="c1">-- Arith.add (Arith.mul (Arith.symbol "x") (Arith.symbol "y")) (Arith.symbol "z")</span>
</code></pre></div>
<p>and when I click on the #check I get the completely different</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Arith.mul</span> <span class="o">(</span><span class="n">Arith.var</span> <span class="s2">"x"</span><span class="o">)</span> <span class="o">(</span><span class="n">Arith.add</span> <span class="o">(</span><span class="n">Arith.var</span> <span class="s2">"y"</span><span class="o">)</span> <span class="o">(</span><span class="n">Arith.var</span> <span class="s2">"z"</span><span class="o">))</span> <span class="o">:</span> <span class="n">Arith</span>
</code></pre></div>
<p>Is my set-up wrong in some way? I don't know what I'm doing, so sorry if these questions are not so smart.</p>



<a name="289828116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289828116" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289828116">(Jul 16 2022 at 13:24)</a>:</h4>
<p>No, that's an error in the book as I tried to imply</p>



<a name="289828496"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289828496" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289828496">(Jul 16 2022 at 13:35)</a>:</h4>
<p>Yeah that's an error. But the output of the <code>#eval</code>s in the expression chapter should be as expected now</p>



<a name="289828902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289828902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289828902">(Jul 16 2022 at 13:44)</a>:</h4>
<p>Speaking as someone who has never parsed a grammar in their life, when both the manual and the book claim to be parsing a "classic grammar", namely arithmetic expressions, does this just mean "a grammar known to Gauss" or does it mean something technical like "a grammar which involves some old rules which modern grammars don't have because the theory of grammars has now moved on"?</p>



<a name="289828926"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289828926" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289828926">(Jul 16 2022 at 13:45)</a>:</h4>
<p>classical as in "it is usual to be used as an example here"</p>



<a name="289829093"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289829093" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289829093">(Jul 16 2022 at 13:48)</a>:</h4>
<p>I've just pushed a fix to the arith example in the intro chapter. Thanks for pointing it out Kevin!</p>



<a name="289829095"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289829095" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289829095">(Jul 16 2022 at 13:48)</a>:</h4>
<p>I see plenty of evidence for this, given that the only two times I've ever read about parsing grammars are in the manual and the book, and both of them do this one :-)</p>



<a name="289829111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289829111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289829111">(Jul 16 2022 at 13:49)</a>:</h4>
<p>Thanks Arthur! I will be pressing on with reading the book over the weekend. Wish me luck...</p>



<a name="289829189"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289829189" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289829189">(Jul 16 2022 at 13:50)</a>:</h4>
<p>If more contributors want access to push directly to master, please let me know. I'll be taking my family to a trip during this weekend so my spare time is limited for the next two days</p>



<a name="289829481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289829481" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289829481">(Jul 16 2022 at 13:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110038">Kevin Buzzard</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/289829111">said</a>:</p>
<blockquote>
<p>Thanks Arthur! I will be pressing on with reading the book over the weekend. Wish me luck...</p>
</blockquote>
<p>If you're at DSLs already you're almost through though right?</p>



<a name="289829919"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289829919" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289829919">(Jul 16 2022 at 14:07)</a>:</h4>
<p>No I've only just started!</p>



<a name="289830154"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289830154" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289830154">(Jul 16 2022 at 14:12)</a>:</h4>
<p>Are you reading in a weird order then? DSL is the 2nd last chapter, the proper order can be found in the README</p>



<a name="289830770"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289830770" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289830770">(Jul 16 2022 at 14:28)</a>:</h4>
<p>Okay I just pushed a commit updating the book to the latest toolchain (2022-07-16). <span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> please pull from master before continuing <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="289831222"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289831222" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289831222">(Jul 16 2022 at 14:39)</a>:</h4>
<p>The chapter on expressions (the first one after the introductory chapter) was the most affected one</p>



<a name="289833660"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289833660" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289833660">(Jul 16 2022 at 15:38)</a>:</h4>
<p>The DSL we are talking about is in a file called <code>intro.md</code>. Let me know which chapters I should have been reading before this one ;-)</p>



<a name="289833842"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289833842" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289833842">(Jul 16 2022 at 15:42)</a>:</h4>
<p>Ahhh</p>



<a name="289834680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289834680" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289834680">(Jul 16 2022 at 16:01)</a>:</h4>
<p>DSLs looked pretty easy to me, it's rather heartening to know that they're supposed to be hard :-)</p>



<a name="289858042"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289858042" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289858042">(Jul 17 2022 at 01:58)</a>:</h4>
<p>The very first example in the introduction also has an unused variable linter error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"#assertType "</span> <span class="n">termStx</span><span class="o">:</span><span class="n">term</span> <span class="s2">" : "</span> <span class="n">typeStx</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span>
  <span class="kn">open</span> <span class="n">Lean</span> <span class="n">Lean.Elab</span> <span class="n">Command</span> <span class="n">Term</span> <span class="k">in</span>
  <span class="n">liftTermElabM</span> <span class="bp">`</span><span class="n">assertTypeCmd</span>
    <span class="n">try</span>
      <span class="k">let</span> <span class="n">tp</span> <span class="bp">←</span> <span class="n">elabType</span> <span class="n">typeStx</span>
      <span class="k">let</span> <span class="n">tm</span> <span class="bp">←</span> <span class="n">elabTermEnsuringType</span> <span class="n">termStx</span> <span class="n">tp</span>
      <span class="n">synthesizeSyntheticMVarsNoPostponing</span>
      <span class="n">logInfo</span> <span class="s2">"success"</span>
    <span class="n">catch</span> <span class="bp">|</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">throwError</span> <span class="s2">"failure"</span>
</code></pre></div>
<p>Variable tm is never used. How should this be written? Replacing <code>tm</code> by an underscore is accepted by the linter, but it looks weird.</p>



<a name="289858109"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289858109" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289858109">(Jul 17 2022 at 02:00)</a>:</h4>
<p>In Lean 3 I guess I would write <code>elabTermEnsuringType termStx tp &gt;&gt;= skip</code>, but that doesn't seem to exist in Lean 4.</p>



<a name="289858506"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289858506" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289858506">(Jul 17 2022 at 02:11)</a>:</h4>
<p>As far as I understand one should replace this by an underscore. The <code>skip</code> won't work because lean 4 has a hierarchy <code>CoreM</code>, <code>MetaM</code> , <code>TermElabM</code>, <code>TacticM</code> (somewhat analogous to semigroup, monoid, group, abelian group) and <code>skip</code> is at the tactic level.</p>



<a name="289858676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289858676" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289858676">(Jul 17 2022 at 02:15)</a>:</h4>
<p>Ok. Should I use <code>let _</code> or <code>_</code> alone?</p>



<a name="289858726"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289858726" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289858726">(Jul 17 2022 at 02:16)</a>:</h4>
<p>In the tactic example of the introduction, it would help a bit to point out this is a reimplementation of <code>suffices</code> (or explain the difference with <code>suffices</code> if any)</p>



<a name="289858900"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289858900" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289858900">(Jul 17 2022 at 02:20)</a>:</h4>
<p>I believe it should be <code>let _</code>. If the function returns a <code>Unit</code> in a monad then the <code>let _</code> can be omitted.</p>



<a name="289858924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289858924" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289858924">(Jul 17 2022 at 02:21)</a>:</h4>
<p>I mean that both seem to work, but it's unclear if one is better</p>



<a name="289860015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289860015" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Siddhartha Gadgil <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289860015">(Jul 17 2022 at 02:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/289858924">said</a>:</p>
<blockquote>
<p>I mean that both seem to work, but it's unclear if one is better</p>
</blockquote>
<p>I don't know if there is a difference. My guess is that there is a macro that transforms one to the other so they will be equivalent.</p>



<a name="289866867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289866867" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289866867">(Jul 17 2022 at 06:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110031">Patrick Massot</span> <a href="#narrow/stream/270676-lean4/topic/Metaprogramming.20tutorial/near/289858042">said</a>:</p>
<blockquote>
<p>Variable tm is never used. How should this be written? Replacing <code>tm</code> by an underscore is accepted by the linter, but it looks weird.</p>
</blockquote>
<p>Another way would be to use <code>discard</code> :</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">elab</span> <span class="s2">"#assertType "</span> <span class="n">termStx</span><span class="o">:</span><span class="n">term</span> <span class="s2">" : "</span> <span class="n">typeStx</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span>
  <span class="kn">open</span> <span class="n">Lean</span> <span class="n">Lean.Elab</span> <span class="n">Command</span> <span class="n">Term</span> <span class="k">in</span>
  <span class="n">liftTermElabM</span> <span class="bp">`</span><span class="n">assertTypeCmd</span>
    <span class="n">try</span>
      <span class="k">let</span> <span class="n">tp</span> <span class="bp">←</span> <span class="n">elabType</span> <span class="n">typeStx</span>
      <span class="n">discard</span> <span class="bp">&lt;|</span> <span class="n">elabTermEnsuringType</span> <span class="n">termStx</span> <span class="n">tp</span>
      <span class="n">synthesizeSyntheticMVarsNoPostponing</span>
      <span class="n">logInfo</span> <span class="s2">"success"</span>
    <span class="n">catch</span> <span class="bp">|</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">throwError</span> <span class="s2">"failure"</span>
</code></pre></div>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>
</code></pre></div>



<a name="289883483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289883483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289883483">(Jul 17 2022 at 13:04)</a>:</h4>
<p>Some changes are now on <code>master</code>:</p>
<ul>
<li>Mentioned <code>suffices</code> in the intro chapter, as proposed by Patrick</li>
<li>Used <code>discard</code> on the implementation of <code>#assertType</code>, as proposed by Mac</li>
<li>Merged David's fix for replacing <code>&lt;|&gt;</code> by <code>first | ...</code> in the <code>MetaM</code> chapter (<a href="#narrow/stream/270676-lean4/topic/tactic1.20.3C.7C.3E.20tactic2/near/289846996">reference</a>)</li>
<li>Fixed the <code>and_then</code> tactic, whose problem was pointed out <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/issues/49">here</a></li>
</ul>
<p>Thanks everyone for the observations!</p>



<a name="289908183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289908183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chad McBride <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289908183">(Jul 17 2022 at 22:38)</a>:</h4>
<p>Where can I find a syntax guide for Axioms Examples, Theorems and so forth?  So far what I see in the manual, there are good examples, but is there a syntax guide to go along with it?</p>



<a name="289908265"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289908265" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289908265">(Jul 17 2022 at 22:40)</a>:</h4>
<p><span class="user-mention" data-user-id="514887">@Chad McBride</span> do you mean to add those to the environment via metaprogramming instead of via the common <code>axiom foo : bar</code> syntax?</p>



<a name="289908277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289908277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chad McBride <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289908277">(Jul 17 2022 at 22:41)</a>:</h4>
<p>Sorry, yes I sent this to the wrong group.</p>



<a name="289908661"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289908661" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289908661">(Jul 17 2022 at 22:50)</a>:</h4>
<p>Oh, that's not covered in the book yet and I think it's an important topic. I never tried to do it myself, but I believe you can not only access, but also modify the <code>Environment</code> with a custom command via <code>CommandElabM</code></p>



<a name="289930527"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/289930527" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#289930527">(Jul 18 2022 at 07:17)</a>:</h4>
<p>As above you can read the implementations of elaborators that are already there, e.g. the axiom one: <a href="https://github.com/leanprover/lean4/blob/f6b6b36f47909fe8a089c16efdb87372154e7efa/src/Lean/Elab/Declaration.lean#L78-L110">https://github.com/leanprover/lean4/blob/f6b6b36f47909fe8a089c16efdb87372154e7efa/src/Lean/Elab/Declaration.lean#L78-L110</a></p>
<p>The thing that is actually adding the declaration is <a href="https://github.com/leanprover/lean4/blob/f6b6b36f47909fe8a089c16efdb87372154e7efa/src/Lean/Elab/Declaration.lean#L97-L104">https://github.com/leanprover/lean4/blob/f6b6b36f47909fe8a089c16efdb87372154e7efa/src/Lean/Elab/Declaration.lean#L97-L104</a>, the stuff above is responsible for figuring out the types, the stuff below does a little extra book keeping for special cases.</p>



<a name="292051009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/292051009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Dan Velleman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#292051009">(Aug 04 2022 at 18:30)</a>:</h4>
<p>The MetaM chapter is now very good, but I have a few small suggestions:</p>
<ol>
<li>At the beginning,  after listing 4 monads, you say "These monads extend each other."  This wording isn't very helpful.  I assume what is meant is that each monad in the list extends those earlier in the list.</li>
<li>In the section "Tactic Communication via Metavariablers", you say that the first <code>apply</code> tactic generates three new metavariables, and then you say "Call these metavariables <code>?m2</code>, <code>?m3</code> and <code>?b</code>".   This suggests that you are making up the names of the three metavariables, but in fact Lean must have made up the name <code>?b</code>, because it occurs in <code>?m2</code> and <code>?m3</code>.  Is Lean in fact making up names for all of the metavariables? This confused me briefly.  Also, later in this example, you say "the target of <code>?m3</code> is now <code>f (f a) = a</code>", but I think that's a typo; isn't the target of <code>?m3</code> now <code>f a = a</code>?</li>
<li>I think the explanation of <code>forallMetaTelescope</code>, <code>forallMetaTelescopeReducing</code>, etc. is misleading.  These functions don't take a computation as an argument, as <code>forallTelescope</code> does, do they?  Rather, they return the result of replacing the bound variables with metavariables.</li>
</ol>



<a name="292070767"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/292070767" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#292070767">(Aug 04 2022 at 21:13)</a>:</h4>
<p>Thanks! I'm creating an issue to keep track of those points</p>



<a name="321536683"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Metaprogramming%20tutorial/near/321536683" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Evgenia Karunus <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Metaprogramming.20tutorial.html#321536683">(Jan 15 2023 at 22:17)</a>:</h4>
<p>Some updates:</p>
<ul>
<li>I started adding exercises to the chapters, we now have exercises and solutions for <strong>Expressions</strong> and <strong>MetaM</strong> chapters (<a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/issues/84">issue #84</a>, <a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/pull/85">PR #85</a>).</li>
<li>Pdf is generated upon every push to PR now, too (not only upon every push to master) (<a href="https://github.com/arthurpaulino/lean4-metaprogramming-book/pull/86">PR #86</a>).</li>
</ul>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>