---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does.html">PSA: `Expr.abstract` does not do what you think it does</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="239383830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/PSA%3A%20%60Expr.abstract%60%20does%20not%20do%20what%20you%20think%20it%20does/near/239383830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does.html#239383830">(May 19 2021 at 08:15)</a>:</h4>
<p>I'm happy about suggestions for a better term than unsafe.  "Considered harmful" was my other choice, but I think this would come across even worse.</p>



<a name="239383852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/PSA%3A%20%60Expr.abstract%60%20does%20not%20do%20what%20you%20think%20it%20does/near/239383852" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does.html#239383852">(May 19 2021 at 08:15)</a>:</h4>
<p>"incorrect" seems the most accurate</p>



<a name="239383885"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/PSA%3A%20%60Expr.abstract%60%20does%20not%20do%20what%20you%20think%20it%20does/near/239383885" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does.html#239383885">(May 19 2021 at 08:15)</a>:</h4>
<p>although as you point out it's not clear that a correct function with the same signature can exist</p>



<a name="239384378"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/PSA%3A%20%60Expr.abstract%60%20does%20not%20do%20what%20you%20think%20it%20does/near/239384378" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does.html#239384378">(May 19 2021 at 08:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="235513">Daniel Fabian</span> <a href="#narrow/stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does/near/239382217">said</a>:</p>
<blockquote>
<p>I suggest creating an mwe and a github issue for how this be solved best in lean 4.</p>
</blockquote>
<p>I am very reserved with suggesting library changes in Lean 4 these days.  This is the function that I would have expected:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/src/Lean/Meta/Basic.lean b/src/Lean/Meta/Basic.lean</span>
<span class="gh">index cd6a7fc920..fcbaa584be 100644</span>
<span class="gd">--- a/src/Lean/Meta/Basic.lean</span>
<span class="gi">+++ b/src/Lean/Meta/Basic.lean</span>
<span class="gu">@@ -434,6 +434,14 @@ def instantiateLocalDeclMVars (localDecl : LocalDecl) : MetaM LocalDecl := do</span>
     setNGen newS.ngen;
     throwError "failed to create binder due to failure when reverting variable dependencies"

<span class="gi">+/-- Similar to `abstract`, but consider only the first `min n xs.size` entries in `xs`. -/</span>
<span class="gi">+def abstractRange (e : Expr) (n : Nat) (xs : Array Expr) : MetaM Expr :=</span>
<span class="gi">+  liftMkBindingM &lt;| fun lctx =&gt; MetavarContext.MkBinding.abstractRange xs n e false</span>
<span class="gi">+</span>
<span class="gi">+/-- Replace free variables `xs` with loose bound variables. -/</span>
<span class="gi">+def abstract (e : Expr) (xs : Array Expr) : MetaM Expr :=</span>
<span class="gi">+  abstractRange e xs.size xs</span>
<span class="gi">+</span>
 def mkForallFVars (xs : Array Expr) (e : Expr) (usedOnly : Bool := false) (usedLetOnly : Bool := true) : MetaM Expr :=
   if xs.isEmpty then pure e else liftMkBindingM &lt;| MetavarContext.mkForall xs e usedOnly usedLetOnly

<span class="gh">diff --git a/src/Lean/MetavarContext.lean b/src/Lean/MetavarContext.lean</span>
<span class="gh">index f69a69c62a..61be8edf1f 100644</span>
<span class="gd">--- a/src/Lean/MetavarContext.lean</span>
<span class="gi">+++ b/src/Lean/MetavarContext.lean</span>
<span class="gu">@@ -948,7 +948,7 @@ partial def revert (xs : Array Expr) (mvarId : MVarId) : M (Expr × Array Expr)</span>
   contain a metavariable `?m` s.t. local context of `?m` contains a free variable in `xs`.

   `elimMVarDeps` is defined later in this file. -/
<span class="gd">-@[inline] private def abstractRange (xs : Array Expr) (i : Nat) (e : Expr) : M Expr := do</span>
<span class="gi">+@[inline] def abstractRange (xs : Array Expr) (i : Nat) (e : Expr) : M Expr := do</span>
   let e ← elimMVarDeps xs e
   pure (e.abstractRange i xs)
</code></pre></div>



<a name="239385106"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/PSA%3A%20%60Expr.abstract%60%20does%20not%20do%20what%20you%20think%20it%20does/near/239385106" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does.html#239385106">(May 19 2021 at 08:25)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> I was not proposing a PR, rather a bug. You can clearly add your change as a description of the problem. My point was about making sure we can have a good solution in lean4. And as I mentioned, there's probably a good reason for the function to be private. </p>
<p>It is difficult for me to judge if the behaviour you are experiencing is expected, e.g. because it's a perf trade off or something, or an oversight. Hence the issue.</p>



<a name="239385547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/PSA%3A%20%60Expr.abstract%60%20does%20not%20do%20what%20you%20think%20it%20does/near/239385547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does.html#239385547">(May 19 2021 at 08:28)</a>:</h4>
<blockquote>
<p>there's probably a good reason for the function to be private</p>
</blockquote>
<p>I find it more likely that the developers just make things private by habit and make them public only when needed. That's certainly a habit I get into when writing in languages with pervasive module privacy like java or rust.</p>



<a name="239385942"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/PSA%3A%20%60Expr.abstract%60%20does%20not%20do%20what%20you%20think%20it%20does/near/239385942" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does.html#239385942">(May 19 2021 at 08:31)</a>:</h4>
<p>I think it is possible to justify <code>Expr.abstract</code> as written if it has a precondition that the expr in question has no metavariables, for example because it is already fully elaborated and pulled from an earlier definition</p>



<a name="239386902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/PSA%3A%20%60Expr.abstract%60%20does%20not%20do%20what%20you%20think%20it%20does/near/239386902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/PSA.3A.20.60Expr.2Eabstract.60.20does.20not.20do.20what.20you.20think.20it.20does.html#239386902">(May 19 2021 at 08:39)</a>:</h4>
<p>and my first guess from reading the delta is that there may be a perf issue latent in the other version.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>