---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html">Short array optimization experiment</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="289121748"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289121748" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289121748">(Jul 10 2022 at 20:15)</a>:</h4>
<p>I have defined <code>NFloatArray n</code> which is just a <code>FloatArray</code> with size in the type but it has a specialization for small numbers of <code>n</code>.  I'm curious what is the best way to work with such structure.</p>
<p>I have defined different versions of <code>addOne</code>, a function adding one to every component. </p>
<p>As a test, I run this function 10milion times for <code>n=2</code>. The times are:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">addOne_v1</span> <span class="mi">457</span><span class="n">ms</span>
<span class="n">addOne_v2</span> <span class="mi">138</span><span class="n">ms</span>
<span class="n">addOne_v3</span> <span class="mi">84</span><span class="bp">.</span><span class="mi">1</span><span class="n">ms</span>
<span class="n">addOne_v4</span> <span class="mi">37</span><span class="bp">.</span><span class="mi">7</span><span class="n">ms</span>
<span class="n">addOne_v5</span> <span class="mi">34</span><span class="bp">.</span><span class="mi">1</span><span class="n">ms</span>
</code></pre></div>
<p>Can anyone get it even faster? Why inlining <code>addOne_v3</code> makes it roughly twice as slow? Every other version of <code>addOne</code> benefits from inlining.</p>
<p>File: <code>NFloatArray.lean</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">Float2</span> <span class="n">where</span>
  <span class="n">x</span> <span class="o">:</span> <span class="n">Float</span>
  <span class="n">y</span> <span class="o">:</span> <span class="n">Float</span>

<span class="kd">def</span> <span class="n">NFloatArray</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">n</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="mi">0</span> <span class="bp">=&gt;</span> <span class="n">Unit</span>
  <span class="bp">|</span> <span class="mi">1</span> <span class="bp">=&gt;</span> <span class="n">Float</span>
  <span class="bp">|</span> <span class="mi">2</span> <span class="bp">=&gt;</span> <span class="n">Float2</span>
  <span class="bp">|</span> <span class="n">n'</span><span class="bp">+</span><span class="mi">3</span> <span class="bp">=&gt;</span> <span class="o">{</span><span class="n">xs</span> <span class="o">:</span> <span class="n">FloatArray</span> <span class="bp">//</span> <span class="n">xs.size</span> <span class="bp">=</span> <span class="n">n'</span><span class="bp">+</span><span class="mi">3</span><span class="o">}</span>

<span class="kd">instance</span> <span class="o">:</span> <span class="n">ToString</span> <span class="o">(</span><span class="n">NFloatArray</span> <span class="n">n</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">⟨</span><span class="bp">λ</span> <span class="n">xs</span> <span class="bp">=&gt;</span>
    <span class="k">match</span> <span class="n">n</span><span class="o">,</span> <span class="n">xs</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="s2">"[]"</span>
    <span class="bp">|</span> <span class="mi">1</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="k">let</span> <span class="n">x</span> <span class="o">:</span> <span class="n">Float</span> <span class="o">:=</span> <span class="n">x</span><span class="bp">;</span> <span class="n">s</span><span class="bp">!</span><span class="s2">"[{x}]"</span>
    <span class="bp">|</span> <span class="mi">2</span><span class="o">,</span> <span class="o">⟨</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="n">s</span><span class="bp">!</span><span class="s2">"[{x}, {y}]"</span>
    <span class="bp">|</span> <span class="n">_</span><span class="bp">+</span><span class="mi">3</span><span class="o">,</span> <span class="o">⟨</span><span class="n">xs</span><span class="o">,</span><span class="n">_</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="n">toString</span> <span class="n">xs</span><span class="o">⟩</span>


<span class="kd">def</span> <span class="n">Array.toFloatArray</span> <span class="o">(</span><span class="n">xs</span> <span class="o">:</span> <span class="n">Array</span> <span class="n">Float</span><span class="o">)</span> <span class="o">:</span> <span class="n">FloatArray</span> <span class="o">:=</span> <span class="o">⟨</span><span class="n">xs</span><span class="o">⟩</span>

<span class="kn">namespace</span> <span class="n">NFloatArray</span>

  <span class="kd">@[inline]</span>
  <span class="kd">def</span> <span class="n">iget</span> <span class="o">(</span><span class="n">xs</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">Float</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">n</span><span class="o">,</span> <span class="n">xs</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="mi">0</span>
  <span class="bp">|</span> <span class="mi">1</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">x</span>
  <span class="bp">|</span> <span class="mi">2</span><span class="o">,</span> <span class="o">⟨</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">⟩</span> <span class="bp">=&gt;</span>
    <span class="k">match</span> <span class="n">i</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="o">⟨</span><span class="mi">0</span><span class="o">,</span><span class="n">_</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="n">x</span>
    <span class="bp">|</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="n">_</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="n">y</span>
  <span class="bp">|</span> <span class="n">_</span><span class="bp">+</span><span class="mi">3</span><span class="o">,</span> <span class="o">⟨</span><span class="n">xs'</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="n">xs'.get</span> <span class="o">(</span><span class="n">h</span> <span class="bp">▸</span> <span class="n">i</span><span class="o">)</span>

  <span class="kd">def</span> <span class="n">get</span> <span class="o">(</span><span class="n">xs</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="n">n</span><span class="o">)</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">Fin</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">Float</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">n</span><span class="o">,</span> <span class="n">xs</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="mi">0</span>
  <span class="bp">|</span> <span class="mi">1</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">x</span>
  <span class="bp">|</span> <span class="mi">2</span><span class="o">,</span> <span class="o">⟨</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">⟩</span> <span class="bp">=&gt;</span>
    <span class="k">match</span> <span class="n">i</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="o">⟨</span><span class="mi">0</span><span class="o">,</span><span class="n">_</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="n">x</span>
    <span class="bp">|</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="n">_</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="n">y</span>
  <span class="bp">|</span> <span class="n">_</span><span class="bp">+</span><span class="mi">3</span><span class="o">,</span> <span class="o">⟨</span><span class="n">xs'</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="n">xs'.get</span> <span class="o">(</span><span class="n">h</span> <span class="bp">▸</span> <span class="n">i</span><span class="o">)</span>

  <span class="kd">set_option</span> <span class="n">trace.compiler.ir.result</span> <span class="n">true</span> <span class="k">in</span>
  <span class="kd">@[inline]</span>
  <span class="kd">def</span> <span class="n">addOne_v1</span> <span class="o">{</span><span class="n">n</span><span class="o">}</span> <span class="o">(</span><span class="n">xs</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="n">n</span> <span class="o">:=</span>
    <span class="k">match</span> <span class="n">n</span><span class="o">,</span> <span class="n">xs</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">Unit.unit</span>
    <span class="bp">|</span> <span class="mi">1</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="k">let</span> <span class="n">x</span> <span class="o">:</span> <span class="n">Float</span> <span class="o">:=</span> <span class="n">x</span><span class="bp">;</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">Float</span><span class="o">)</span>
    <span class="bp">|</span> <span class="mi">2</span><span class="o">,</span> <span class="n">xs'</span> <span class="bp">=&gt;</span> <span class="o">⟨</span><span class="n">xs'.get</span> <span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">xs'.get</span> <span class="mi">1</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">⟩</span>
    <span class="bp">|</span> <span class="n">_</span><span class="bp">+</span><span class="mi">3</span><span class="o">,</span> <span class="o">⟨</span><span class="n">xs'</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="o">⟨</span><span class="n">xs'</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="c1">-- TODO: implement me</span>


  <span class="kd">set_option</span> <span class="n">trace.compiler.ir.result</span> <span class="n">true</span> <span class="k">in</span>
  <span class="kd">@[inline]</span>
  <span class="kd">def</span> <span class="n">addOne_v2</span> <span class="o">{</span><span class="n">n</span><span class="o">}</span> <span class="o">(</span><span class="n">xs</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="n">n</span> <span class="o">:=</span>
    <span class="k">match</span> <span class="n">n</span><span class="o">,</span> <span class="n">xs</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">Unit.unit</span>
    <span class="bp">|</span> <span class="mi">1</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="k">let</span> <span class="n">x</span> <span class="o">:</span> <span class="n">Float</span> <span class="o">:=</span> <span class="n">x</span><span class="bp">;</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">Float</span><span class="o">)</span>
    <span class="bp">|</span> <span class="mi">2</span><span class="o">,</span> <span class="n">xs'</span> <span class="bp">=&gt;</span> <span class="o">⟨</span><span class="n">xs'.1</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">xs'.2</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">⟩</span>
    <span class="bp">|</span> <span class="n">_</span><span class="bp">+</span><span class="mi">3</span><span class="o">,</span> <span class="o">⟨</span><span class="n">xs'</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="o">⟨</span><span class="n">xs'</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="c1">-- TODO: implement me</span>

  <span class="kd">set_option</span> <span class="n">trace.compiler.ir.result</span> <span class="n">true</span> <span class="k">in</span>
  <span class="kd">def</span> <span class="n">addOne_v3</span> <span class="o">{</span><span class="n">n</span><span class="o">}</span> <span class="o">(</span><span class="n">xs</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="n">n</span> <span class="o">:=</span>
    <span class="k">match</span> <span class="n">n</span><span class="o">,</span> <span class="n">xs</span> <span class="k">with</span>
    <span class="bp">|</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">Unit.unit</span>
    <span class="bp">|</span> <span class="mi">1</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="k">let</span> <span class="n">x</span> <span class="o">:</span> <span class="n">Float</span> <span class="o">:=</span> <span class="n">x</span><span class="bp">;</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">Float</span><span class="o">)</span>
    <span class="bp">|</span> <span class="mi">2</span><span class="o">,</span> <span class="n">xs'</span> <span class="bp">=&gt;</span> <span class="o">⟨</span><span class="n">xs'.iget</span> <span class="mi">0</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">xs'.iget</span> <span class="mi">1</span> <span class="bp">+</span> <span class="mi">1</span><span class="o">⟩</span>
    <span class="bp">|</span> <span class="n">_</span><span class="bp">+</span><span class="mi">3</span><span class="o">,</span> <span class="o">⟨</span><span class="n">xs'</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="o">⟨</span><span class="n">xs'</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="c1">-- TODO: implement me</span>

  <span class="kd">set_option</span> <span class="n">trace.compiler.ir.result</span> <span class="n">true</span> <span class="k">in</span>
  <span class="kd">@[inline]</span>
  <span class="kd">def</span> <span class="n">addOne_v4</span> <span class="o">{</span><span class="n">n</span><span class="o">}</span> <span class="o">(</span><span class="n">xs</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="n">n</span><span class="o">)</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="n">n</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">n</span><span class="o">,</span> <span class="n">xs</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">Unit.unit</span>
  <span class="bp">|</span> <span class="mi">1</span><span class="o">,</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="k">let</span> <span class="n">x</span> <span class="o">:</span> <span class="n">Float</span> <span class="o">:=</span> <span class="n">x</span><span class="bp">;</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">Float</span><span class="o">)</span>
  <span class="bp">|</span> <span class="mi">2</span><span class="o">,</span> <span class="o">⟨</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="o">⟨</span><span class="n">x</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">y</span><span class="bp">+</span><span class="mi">1</span><span class="o">⟩</span>
  <span class="bp">|</span> <span class="n">_</span><span class="bp">+</span><span class="mi">3</span><span class="o">,</span> <span class="o">⟨</span><span class="n">xs'</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="o">⟨</span><span class="n">xs'</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="c1">-- TODO: implement me</span>

  <span class="kd">set_option</span> <span class="n">trace.compiler.ir.result</span> <span class="n">true</span> <span class="k">in</span>
  <span class="kd">@[inline]</span>
  <span class="kd">def</span> <span class="n">addOne_v5</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="mi">2</span> <span class="bp">→</span> <span class="n">NFloatArray</span> <span class="mi">2</span> <span class="o">:=</span>
    <span class="bp">λ</span> <span class="o">⟨</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">⟩</span> <span class="bp">=&gt;</span> <span class="o">⟨</span><span class="n">x</span><span class="bp">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">y</span><span class="bp">+</span><span class="mi">1</span><span class="o">⟩</span>

<span class="kd">end</span> <span class="n">NFloatArray</span>
</code></pre></div>
<p>File: <code>Main.lean</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">NFloatArray</span>

<span class="kn">open</span> <span class="n">NFloatArray</span>


<span class="kd">def</span> <span class="n">main</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span> <span class="o">:=</span> <span class="k">do</span>

  <span class="n">timeit</span> <span class="s2">"addOne_v1"</span> <span class="bp">$</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mut</span> <span class="n">v</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="mi">2</span> <span class="o">:=</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">⟩</span>
    <span class="n">for</span> <span class="n">i</span> <span class="k">in</span> <span class="o">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">10000000</span><span class="o">]</span> <span class="k">do</span>
      <span class="n">v</span> <span class="o">:=</span> <span class="n">addOne_v1</span> <span class="n">v</span>

  <span class="n">timeit</span> <span class="s2">"addOne_v2"</span> <span class="bp">$</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mut</span> <span class="n">v</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="mi">2</span> <span class="o">:=</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">⟩</span>
    <span class="n">for</span> <span class="n">i</span> <span class="k">in</span> <span class="o">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">10000000</span><span class="o">]</span> <span class="k">do</span>
      <span class="n">v</span> <span class="o">:=</span> <span class="n">addOne_v2</span> <span class="n">v</span>

  <span class="n">timeit</span> <span class="s2">"addOne_v3"</span> <span class="bp">$</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mut</span> <span class="n">v</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="mi">2</span> <span class="o">:=</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">⟩</span>
    <span class="n">for</span> <span class="n">i</span> <span class="k">in</span> <span class="o">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">10000000</span><span class="o">]</span> <span class="k">do</span>
      <span class="n">v</span> <span class="o">:=</span> <span class="n">addOne_v3</span> <span class="n">v</span>

  <span class="n">timeit</span> <span class="s2">"addOne_v4"</span> <span class="bp">$</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mut</span> <span class="n">v</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="mi">2</span> <span class="o">:=</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">⟩</span>
    <span class="n">for</span> <span class="n">i</span> <span class="k">in</span> <span class="o">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">10000000</span><span class="o">]</span> <span class="k">do</span>
      <span class="n">v</span> <span class="o">:=</span> <span class="n">addOne_v4</span> <span class="n">v</span>

  <span class="n">timeit</span> <span class="s2">"addOne_v5"</span> <span class="bp">$</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mut</span> <span class="n">v</span> <span class="o">:</span> <span class="n">NFloatArray</span> <span class="mi">2</span> <span class="o">:=</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">⟩</span>
    <span class="n">for</span> <span class="n">i</span> <span class="k">in</span> <span class="o">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">10000000</span><span class="o">]</span> <span class="k">do</span>
      <span class="n">v</span> <span class="o">:=</span> <span class="n">addOne_v5</span> <span class="n">v</span>
</code></pre></div>



<a name="289122135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289122135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289122135">(Jul 10 2022 at 20:24)</a>:</h4>
<p>Adding <code>-O2</code> flag via <code>moreLeancArgs := #["-O2"]</code>, makes <code>v4</code> as fast as <code>v5</code>.</p>



<a name="289123119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289123119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289123119">(Jul 10 2022 at 20:47)</a>:</h4>
<p>Did you compare against a straight <code>FloatArray</code>?</p>



<a name="289123613"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289123613" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289123613">(Jul 10 2022 at 20:58)</a>:</h4>
<p>Good point, I didn't.</p>



<a name="289123772"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289123772" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289123772">(Jul 10 2022 at 21:02)</a>:</h4>
<p>This implementation:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="kd">def</span> <span class="n">addOne_v0</span> <span class="o">(</span><span class="n">xs</span> <span class="o">:</span> <span class="n">FloatArray</span><span class="o">)</span> <span class="o">:</span> <span class="n">FloatArray</span> <span class="o">:=</span> <span class="n">Id.run</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mut</span> <span class="n">xs</span> <span class="o">:=</span> <span class="n">xs</span>
    <span class="n">for</span> <span class="n">i</span> <span class="k">in</span> <span class="o">[</span><span class="mi">0</span><span class="o">:</span><span class="n">xs.size</span><span class="o">]</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">xi</span> <span class="o">:=</span> <span class="n">xs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="bp">'</span><span class="gr">sorry</span>
      <span class="n">xs</span> <span class="o">:=</span> <span class="n">xs.set</span> <span class="o">⟨</span><span class="n">i</span><span class="o">,</span><span class="gr">sorry</span><span class="o">⟩</span> <span class="o">(</span><span class="n">xs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="bp">'</span><span class="gr">sorry</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span>
    <span class="n">xs</span>
</code></pre></div>
<p>takes rounghly 140ms.</p>



<a name="289123802"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289123802" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289123802">(Jul 10 2022 at 21:03)</a>:</h4>
<p>What happens if you replace <code>xs.size</code> by <code>2</code>?</p>



<a name="289123862"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289123862" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289123862">(Jul 10 2022 at 21:04)</a>:</h4>
<p>Nothing, more or less the same time.</p>



<a name="289124206"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289124206" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289124206">(Jul 10 2022 at 21:14)</a>:</h4>
<p>Unrolling the loop gives  41ms</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="kd">def</span> <span class="n">addOne_v0</span> <span class="o">(</span><span class="n">xs</span> <span class="o">:</span> <span class="n">FloatArray</span><span class="o">)</span> <span class="o">:</span> <span class="n">FloatArray</span> <span class="o">:=</span> <span class="n">Id.run</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mut</span> <span class="n">xs</span> <span class="o">:=</span> <span class="n">xs</span>
    <span class="n">xs</span> <span class="o">:=</span> <span class="n">xs.uset</span> <span class="mi">0</span> <span class="o">(</span><span class="n">xs.uget</span> <span class="mi">0</span> <span class="gr">sorry</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="gr">sorry</span>
    <span class="n">xs</span> <span class="o">:=</span> <span class="n">xs.uset</span> <span class="mi">1</span> <span class="o">(</span><span class="n">xs.uget</span> <span class="mi">1</span> <span class="gr">sorry</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span> <span class="gr">sorry</span>
    <span class="n">xs</span>
</code></pre></div>



<a name="289124258"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289124258" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289124258">(Jul 10 2022 at 21:14)</a>:</h4>
<p>Looks like that using a specialized structure for small <code>n</code> might not be necessary.</p>



<a name="289125231"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125231" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125231">(Jul 10 2022 at 21:38)</a>:</h4>
<p>Running equivalent program in C++ takes 9ms. Also in Lean, running just and empty loop with 10mil iterations takes 26ms.</p>



<a name="289125442"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125442" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125442">(Jul 10 2022 at 21:43)</a>:</h4>
<p>It looks like that <code>addOne_v5</code> is hitting Lean limit, it takes 34ms that is roughly 35ms = 9ms(c++) + 26ms(empty Lean for loop).</p>



<a name="289125477"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125477" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125477">(Jul 10 2022 at 21:44)</a>:</h4>
<p><span class="user-mention" data-user-id="346070">@Tomas Skrivan</span> what if you use <code>BaseIO</code> instead of <code>IO</code>?</p>



<a name="289125537"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125537" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125537">(Jul 10 2022 at 21:45)</a>:</h4>
<p>Not use what are you suggesting? Here and how should I use <code>BaseIO</code>?</p>



<a name="289125569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125569">(Jul 10 2022 at 21:46)</a>:</h4>
<p>I mean use <code>BaseIO</code> as the monad to run these experiments rather than <code>IO</code>.</p>



<a name="289125645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125645" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125645">(Jul 10 2022 at 21:47)</a>:</h4>
<p>Still not clear to me. Are you suggesting <code>def main : BaseIO Unit</code> ? Then I do not have <code>timeit</code> function.</p>



<a name="289125704"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125704" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125704">(Jul 10 2022 at 21:48)</a>:</h4>
<p>Ah, oops, yeah. I forgot <code>timeit</code> is in <code>IO</code> -- that may be a problem. This means that Lean has to check if the loop errored every iteration.</p>



<a name="289125843"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125843" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125843">(Jul 10 2022 at 21:52)</a>:</h4>
<p>Ahh, I see now! That makes perfect sense.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="n">timeit</span> <span class="s2">"nothing"</span> <span class="bp">$</span> <span class="n">pure</span> <span class="o">(</span><span class="n">Id.run</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">mut</span> <span class="n">v</span> <span class="o">:</span> <span class="n">FloatArray</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">]</span><span class="bp">.</span><span class="n">toFloatArray</span>
    <span class="n">for</span> <span class="n">i</span> <span class="k">in</span> <span class="o">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">10000000</span><span class="o">]</span> <span class="k">do</span>
      <span class="n">v</span> <span class="o">:=</span> <span class="n">v</span><span class="o">)</span>
</code></pre></div>
<p>now takes 0.000254ms instead of 26ms</p>



<a name="289125848"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125848" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125848">(Jul 10 2022 at 21:52)</a>:</h4>
<p>:)</p>



<a name="289125947"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125947" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125947">(Jul 10 2022 at 21:55)</a>:</h4>
<p>Ahh, not correct. I think the loop gets eliminated, instead of <code>pure  $ Id.run</code> it should be for example <code>IO.println $ Id.run</code> and the loop should return <code>v</code></p>



<a name="289125962"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289125962" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289125962">(Jul 10 2022 at 21:55)</a>:</h4>
<p>Still significantly faster,  0.018ms.</p>



<a name="289126031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289126031" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289126031">(Jul 10 2022 at 21:57)</a>:</h4>
<p>I think it still may be precomputing the loop though.</p>



<a name="289126154"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289126154" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289126154">(Jul 10 2022 at 22:00)</a>:</h4>
<p>Yeah, the numbers are susspicious.</p>



<a name="289126268"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289126268" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289126268">(Jul 10 2022 at 22:03)</a>:</h4>
<p>It is definitely precomputing the loop. The numbers are nonsensical now.</p>



<a name="289126340"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289126340" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289126340">(Jul 10 2022 at 22:05)</a>:</h4>
<p>(deleted -- I am an idiot -- was not returning <code>v</code>)</p>



<a name="289126569"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289126569" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289126569">(Jul 10 2022 at 22:10)</a>:</h4>
<p>This test works (and is producing the expected code), but the time it reports does not seem like the time it actually takes in the editor:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">trace.compiler.ir.result</span> <span class="n">true</span>

<span class="n">opaque</span> <span class="n">opaqueId</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">FloatArray</span><span class="o">)</span> <span class="o">:</span> <span class="n">FloatArray</span> <span class="o">:=</span> <span class="n">a</span>

<span class="kd">def</span> <span class="n">test_pure</span> <span class="o">:=</span>
  <span class="n">timeit</span> <span class="s2">"pure"</span> <span class="k">do</span>
    <span class="n">IO.println</span> <span class="bp">$</span> <span class="n">Id.run</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">mut</span> <span class="n">v</span> <span class="o">:</span> <span class="n">FloatArray</span> <span class="o">:=</span> <span class="o">⟨</span><span class="bp">#</span><span class="o">[</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">]⟩</span>
      <span class="n">for</span> <span class="n">_</span> <span class="k">in</span> <span class="o">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">10000000</span><span class="o">]</span> <span class="k">do</span>
        <span class="n">v</span> <span class="o">:=</span> <span class="n">opaqueId</span> <span class="n">v</span>
      <span class="n">return</span> <span class="n">v</span>

<span class="k">#eval</span> <span class="n">test_pure</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">[1.000000, 2.000000]</span>
<span class="cm">pure 0.102ms</span>
<span class="cm">-/</span>
</code></pre></div>



<a name="289126792"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289126792" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289126792">(Jul 10 2022 at 22:17)</a>:</h4>
<p>That is really odd, the time does not match but the loop is not precomputed.</p>



<a name="289127101"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289127101" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289127101">(Jul 10 2022 at 22:25)</a>:</h4>
<p>It seems to me like some post-IR optimization is eliminating the loop.</p>



<a name="289127166"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289127166" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289127166">(Jul 10 2022 at 22:27)</a>:</h4>
<p>However, I was not aware such an optimization stage existed, which confuses me greatly.</p>



<a name="289127188"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289127188" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289127188">(Jul 10 2022 at 22:28)</a>:</h4>
<p>Actually, wait, the problem is that it is lifting the loop out of the <code>timeit</code>.</p>



<a name="289127347"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289127347" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289127347">(Jul 10 2022 at 22:31)</a>:</h4>
<p>The variable <code>x_6</code> already holds the computed value, right? So the <code>timeit ◾ x_8 x_7 x_1</code> just unpacks the value from <code>x_7</code>.</p>



<a name="289127352"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289127352" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289127352">(Jul 10 2022 at 22:31)</a>:</h4>
<p>Fixed:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">set_option</span> <span class="n">trace.compiler.ir.result</span> <span class="n">true</span>

<span class="n">opaque</span> <span class="n">opaqueId</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">FloatArray</span><span class="o">)</span> <span class="o">:</span> <span class="n">FloatArray</span> <span class="o">:=</span> <span class="n">a</span>

<span class="kd">def</span> <span class="n">compute_pure</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">FloatArray</span> <span class="o">:=</span> <span class="n">pure</span> <span class="bp">$</span> <span class="n">Id.run</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">mut</span> <span class="n">v</span> <span class="o">:</span> <span class="n">FloatArray</span> <span class="o">:=</span> <span class="o">⟨</span><span class="bp">#</span><span class="o">[</span><span class="mi">0</span><span class="o">]⟩</span>
  <span class="n">for</span> <span class="n">_</span> <span class="k">in</span> <span class="o">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">10000000</span><span class="o">]</span> <span class="k">do</span>
    <span class="n">v</span> <span class="o">:=</span> <span class="n">opaqueId</span> <span class="n">v</span>
  <span class="n">return</span> <span class="n">v</span>

<span class="c">/-</span><span class="cm"></span>
<span class="cm">[result]</span>
<span class="cm">def Std.Range.forIn.loop._at.compute_pure._spec_1 (x_1 : obj) (x_2 : obj) (x_3 : @&amp; obj) (x_4 : @&amp; obj) (x_5 : @&amp; obj) : obj :=</span>
<span class="cm">  let x_6 : u8 := Nat.decLe x_3 x_2;</span>
<span class="cm">  case x_6 : u8 of</span>
<span class="cm">  Bool.false →</span>
<span class="cm">    let x_7 : obj := 0;</span>
<span class="cm">    let x_8 : u8 := Nat.decEq x_1 x_7;</span>
<span class="cm">    case x_8 : u8 of</span>
<span class="cm">    Bool.false →</span>
<span class="cm">      let x_9 : obj := 1;</span>
<span class="cm">      let x_10 : obj := Nat.sub x_1 x_9;</span>
<span class="cm">      dec x_1;</span>
<span class="cm">      let x_11 : obj := Nat.add x_2 x_4;</span>
<span class="cm">      dec x_2;</span>
<span class="cm">      let x_12 : obj := Std.Range.forIn.loop._at.compute_pure._spec_1 x_10 x_11 x_3 x_4 x_5;</span>
<span class="cm">      ret x_12</span>
<span class="cm">    Bool.true →</span>
<span class="cm">      dec x_2;</span>
<span class="cm">      dec x_1;</span>
<span class="cm">      inc x_5;</span>
<span class="cm">      ret x_5</span>
<span class="cm">  Bool.true →</span>
<span class="cm">    dec x_2;</span>
<span class="cm">    dec x_1;</span>
<span class="cm">    inc x_5;</span>
<span class="cm">    ret x_5</span>
<span class="cm">def compute_pure._closed_1 : float :=</span>
<span class="cm">  let x_1 : obj := 0;</span>
<span class="cm">  let x_2 : u8 := 0;</span>
<span class="cm">  let x_3 : float := Float.ofScientific x_1 x_2 x_1;</span>
<span class="cm">  ret x_3</span>
<span class="cm">def compute_pure._closed_2 : obj :=</span>
<span class="cm">  let x_1 : obj := 1;</span>
<span class="cm">  let x_2 : obj := Array.mkEmpty ◾ x_1;</span>
<span class="cm">  ret x_2</span>
<span class="cm">def compute_pure._closed_3._boxed_const_1 : obj :=</span>
<span class="cm">  let x_1 : float := compute_pure._closed_1;</span>
<span class="cm">  let x_2 : obj := box x_1;</span>
<span class="cm">  ret x_2</span>
<span class="cm">def compute_pure._closed_3 : obj :=</span>
<span class="cm">  let x_1 : obj := compute_pure._closed_2;</span>
<span class="cm">  let x_2 : obj := compute_pure._closed_3._boxed_const_1;</span>
<span class="cm">  let x_3 : obj := Array.push ◾ x_1 x_2;</span>
<span class="cm">  ret x_3</span>
<span class="cm">def compute_pure._closed_4 : obj :=</span>
<span class="cm">  let x_1 : obj := compute_pure._closed_3;</span>
<span class="cm">  let x_2 : obj := FloatArray.mk x_1;</span>
<span class="cm">  ret x_2</span>
<span class="cm">def compute_pure (x_1 : obj) : obj :=</span>
<span class="cm">  let x_2 : obj := 10000000;</span>
<span class="cm">  let x_3 : obj := 0;</span>
<span class="cm">  let x_4 : obj := 1;</span>
<span class="cm">  let x_5 : obj := compute_pure._closed_4;</span>
<span class="cm">  let x_6 : obj := Std.Range.forIn.loop._at.compute_pure._spec_1 x_2 x_3 x_2 x_4 x_5;</span>
<span class="cm">  dec x_5;</span>
<span class="cm">  let x_7 : obj := ctor_0[EStateM.Result.ok] x_6 x_1;</span>
<span class="cm">  ret x_7</span>
<span class="cm">def Std.Range.forIn.loop._at.compute_pure._spec_1._boxed (x_1 : obj) (x_2 : obj) (x_3 : obj) (x_4 : obj) (x_5 : obj) : obj :=</span>
<span class="cm">  let x_6 : obj := Std.Range.forIn.loop._at.compute_pure._spec_1 x_1 x_2 x_3 x_4 x_5;</span>
<span class="cm">  dec x_5;</span>
<span class="cm">  dec x_4;</span>
<span class="cm">  dec x_3;</span>
<span class="cm">  ret x_6</span>
<span class="cm">-/</span>

<span class="kd">def</span> <span class="n">test_pure</span> <span class="o">:=</span>
  <span class="n">timeit</span> <span class="s2">"pure"</span> <span class="n">compute_pure</span>

<span class="c">/-</span><span class="cm"></span>
<span class="cm">[result]</span>
<span class="cm">def test_pure._closed_1 : obj :=</span>
<span class="cm">  let x_1 : obj := "pure";</span>
<span class="cm">  ret x_1</span>
<span class="cm">def test_pure._closed_2 : obj :=</span>
<span class="cm">  let x_1 : obj := pap compute_pure;</span>
<span class="cm">  ret x_1</span>
<span class="cm">def test_pure (x_1 : obj) : obj :=</span>
<span class="cm">  let x_2 : obj := test_pure._closed_1;</span>
<span class="cm">  let x_3 : obj := test_pure._closed_2;</span>
<span class="cm">  let x_4 : obj := timeit ◾ x_2 x_3 x_1;</span>
<span class="cm">  dec x_2;</span>
<span class="cm">  ret x_4</span>
<span class="cm">-/</span>

<span class="kd">set_option</span> <span class="n">trace.compiler.ir.result</span> <span class="n">false</span>

<span class="k">#eval</span> <span class="n">test_pure</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">pure 4.56s</span>
<span class="cm">[0.000000]</span>
<span class="cm">-/</span>
</code></pre></div>



<a name="289127420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289127420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289127420">(Jul 10 2022 at 22:33)</a>:</h4>
<p><span class="user-mention" data-user-id="346070">@Tomas Skrivan</span> if you run the above test from an executable you should get a more accurate result.</p>



<a name="289127478"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289127478" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289127478">(Jul 10 2022 at 22:34)</a>:</h4>
<p>It looks like that the <code>opaqueId</code> is no longer necessary.</p>



<a name="289128206"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Short%20array%20optimization%20experiment/near/289128206" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Short.20array.20optimization.20experiment.html#289128206">(Jul 10 2022 at 22:48)</a>:</h4>
<p>Hmm interesting, <code>compute_pure</code> has to really be a definition, otherwise it will get precomputed. </p>
<p>Also, the <code>pure $ Id.run</code> seems to make it a little bit slower, 193ms vs 171ms.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>