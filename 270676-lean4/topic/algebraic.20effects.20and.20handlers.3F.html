---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html">algebraic effects and handlers?</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="231512479"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/231512479" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jason Gross <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#231512479">(Mar 23 2021 at 17:43)</a>:</h4>
<p>I've heard that algebraic effects and handlers form a nicer basis for stateful computation than monads (for example, there's no need to lift operations as there is when you nest monads).  Has anyone thought about basing things in Lean on algebraic effects and handlers rather than monads?  (c.f. <a href="https://xnning.github.io/papers/haskell-evidently.pdf">https://xnning.github.io/papers/haskell-evidently.pdf</a> , for example)</p>



<a name="231513644"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/231513644" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#231513644">(Mar 23 2021 at 17:50)</a>:</h4>
<p>Yes, it's a topic we've considered before. The very short answer is that AFAIK there are only two ways to avoid lifting, neither of which is acceptable for building nontrivial programs like Lean itself: by blowing up the runtime overhead (open union encoding etc.) or the compile time overhead (monomorphization).</p>



<a name="231516365"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/231516365" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#231516365">(Mar 23 2021 at 18:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="241007">Jason Gross</span> <a href="#narrow/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F/near/231512479">said</a>:</p>
<blockquote>
<p>I've heard that algebraic effects and handlers form a nicer basis for stateful computation than monads (for example, there's no need to lift operations as there is when you nest monads).  Has anyone thought about basing things in Lean on algebraic effects and handlers rather than monads?  (c.f. <a href="https://xnning.github.io/papers/haskell-evidently.pdf">https://xnning.github.io/papers/haskell-evidently.pdf</a> , for example)</p>
</blockquote>
<p>FWIW I have found the auto-lifting in Lean4 to be so good that I almost never need to think about this.</p>



<a name="231529512"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/231529512" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jason Gross <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#231529512">(Mar 23 2021 at 19:28)</a>:</h4>
<p>Open union encoding is where everything is polymorphic over all the other effects (or underlying monads) that might be present?</p>



<a name="290960490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/290960490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Locria Cyber <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#290960490">(Jul 26 2022 at 21:48)</a>:</h4>
<p>Maybe have compile-time support for union?</p>



<a name="290961535"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/290961535" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Locria Cyber <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#290961535">(Jul 26 2022 at 22:00)</a>:</h4>
<p>I made a library for this. <a href="https://github.com/locriacyber/lean-eff">https://github.com/locriacyber/lean-eff</a></p>



<a name="290961679"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/290961679" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Locria Cyber <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#290961679">(Jul 26 2022 at 22:01)</a>:</h4>
<p>See Example.Handler and Example.HandlerControl for example.</p>
<p>I don't know how to bench mark, but the runtime of those seem minimal.</p>
<p>using this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">#!/</span><span class="n">usr</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">fish</span>
<span class="n">time</span> <span class="n">for</span> <span class="n">i</span> <span class="k">in</span> <span class="o">(</span><span class="n">seq</span> <span class="mi">10000</span><span class="o">)</span>
    <span class="bp">./</span><span class="n">test_control</span>
<span class="kd">end</span> <span class="bp">&gt;/</span><span class="n">dev</span><span class="bp">/</span><span class="n">null</span>


<span class="n">time</span> <span class="n">for</span> <span class="n">i</span> <span class="k">in</span> <span class="o">(</span><span class="n">seq</span> <span class="mi">10000</span><span class="o">)</span>
    <span class="bp">./</span><span class="n">test_handle</span>
<span class="kd">end</span> <span class="bp">&gt;/</span><span class="n">dev</span><span class="bp">/</span><span class="n">null</span>
</code></pre></div>



<a name="290961823"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/290961823" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Locria Cyber <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#290961823">(Jul 26 2022 at 22:02)</a>:</h4>
<p>There is no difference in time used. (probably because it's IO bound)</p>



<a name="290961892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/290961892" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Locria Cyber <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#290961892">(Jul 26 2022 at 22:03)</a>:</h4>
<p>I would love to remove the <code>sorry</code> in my code, if anyone want to help.</p>



<a name="290962596"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/290962596" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#290962596">(Jul 26 2022 at 22:10)</a>:</h4>
<p>Can you make a <a href="https://leanprover-community.github.io/mwe.html">#mwe</a>? Those should be proved automatically</p>



<a name="291019361"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/291019361" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Locria Cyber <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#291019361">(Jul 27 2022 at 11:15)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">Free</span> <span class="o">:</span> <span class="o">(</span><span class="n">_monadish</span><span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span> <span class="bp">-&gt;</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">)</span> <span class="bp">-&gt;</span> <span class="o">(</span><span class="n">_ret</span><span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="bp">-&gt;</span> <span class="kt">Type</span> <span class="n">_</span> <span class="n">where</span>
<span class="bp">|</span> <span class="n">pure</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">-&gt;</span> <span class="n">Free</span> <span class="n">ε</span> <span class="n">α</span>
<span class="bp">|</span> <span class="n">bind</span> <span class="o">:</span> <span class="n">ε</span> <span class="n">α</span> <span class="bp">-&gt;</span> <span class="o">(</span><span class="n">α</span> <span class="bp">-&gt;</span> <span class="n">Free</span> <span class="n">ε</span> <span class="n">β</span><span class="o">)</span> <span class="bp">-&gt;</span> <span class="n">Free</span> <span class="n">ε</span> <span class="n">β</span>

<span class="sd">/-- Proof that a list has an element -/</span>
<span class="kd">class</span> <span class="kd">inductive</span> <span class="n">Elem</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">-&gt;</span> <span class="n">List</span> <span class="n">α</span> <span class="bp">-&gt;</span> <span class="kt">Type</span> <span class="n">_</span> <span class="n">where</span>
<span class="bp">|</span> <span class="n">zero</span> <span class="o">:</span> <span class="n">Elem</span> <span class="n">x</span> <span class="o">(</span><span class="n">x</span><span class="o">::</span><span class="n">xs</span><span class="o">)</span>
<span class="bp">|</span> <span class="n">succ</span> <span class="o">:</span> <span class="n">Elem</span> <span class="n">x</span> <span class="n">xs</span> <span class="bp">-&gt;</span> <span class="n">Elem</span> <span class="n">x</span> <span class="o">(</span><span class="n">y</span><span class="o">::</span><span class="n">xs</span><span class="o">)</span>

<span class="kn">namespace</span> <span class="n">Elem</span>
  <span class="kd">instance</span> <span class="o">:</span> <span class="n">Elem</span> <span class="n">a</span> <span class="o">(</span><span class="n">a</span> <span class="o">::</span> <span class="n">xs</span><span class="o">)</span> <span class="o">:=</span> <span class="n">Elem.zero</span>
  <span class="kd">instance</span> <span class="o">[</span><span class="n">prev</span><span class="o">:</span> <span class="n">Elem</span> <span class="n">a</span> <span class="n">xs</span><span class="o">]</span> <span class="o">:</span> <span class="n">Elem</span> <span class="n">a</span> <span class="o">(</span><span class="n">x</span><span class="o">::</span><span class="n">xs</span><span class="o">)</span> <span class="o">:=</span> <span class="n">Elem.succ</span> <span class="n">prev</span>
<span class="kd">end</span> <span class="n">Elem</span>

<span class="kd">inductive</span> <span class="n">Union</span> <span class="o">:</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="bp">-&gt;</span> <span class="n">List</span> <span class="o">(</span><span class="n">α</span> <span class="bp">-&gt;</span> <span class="kt">Sort</span> <span class="n">v</span><span class="o">)</span> <span class="bp">-&gt;</span> <span class="n">α</span> <span class="bp">-&gt;</span> <span class="kt">Sort</span> <span class="n">_</span> <span class="n">where</span>
<span class="bp">|</span> <span class="n">mk</span> <span class="o">[</span><span class="n">prf</span><span class="o">:</span> <span class="n">Elem</span> <span class="n">ε</span> <span class="n">εs</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">ε</span> <span class="n">α</span><span class="o">)</span> <span class="bp">-&gt;</span> <span class="n">Union</span> <span class="n">εs</span> <span class="n">α</span>

<span class="kn">namespace</span> <span class="n">Union</span>
  <span class="kd">example</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">Union</span> <span class="o">[</span><span class="n">IO</span><span class="o">]</span> <span class="n">Unit</span>

  <span class="kd">def</span> <span class="n">simplify</span> <span class="o">:</span> <span class="n">Union</span> <span class="o">[</span><span class="n">ε</span><span class="o">]</span> <span class="n">α</span> <span class="bp">-&gt;</span> <span class="n">ε</span> <span class="n">α</span>
  <span class="bp">|</span> <span class="n">Union.mk</span> <span class="o">(</span><span class="n">prf</span> <span class="o">:=</span> <span class="n">Elem.zero</span><span class="o">)</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">x</span>
<span class="kd">end</span> <span class="n">Union</span>

<span class="kd">@[reducible]</span>
<span class="kd">def</span> <span class="n">Eff</span> <span class="n">es</span> <span class="o">:=</span> <span class="n">Free</span> <span class="o">(</span><span class="n">Union</span> <span class="n">es</span><span class="o">)</span>

<span class="kn">namespace</span> <span class="n">Eff</span>
  <span class="kd">def</span> <span class="n">run1</span> <span class="o">[</span><span class="n">Pure</span> <span class="n">ε</span><span class="o">]</span> <span class="o">[</span><span class="n">Bind</span> <span class="n">ε</span><span class="o">]</span> <span class="o">:</span> <span class="o">(</span><span class="n">stacked</span><span class="o">:</span> <span class="n">Eff</span> <span class="o">[</span><span class="n">ε</span><span class="o">]</span> <span class="n">α</span><span class="o">)</span> <span class="bp">-&gt;</span> <span class="n">ε</span> <span class="n">α</span>
  <span class="bp">|</span> <span class="n">Free.pure</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="n">pure</span> <span class="n">x</span>
  <span class="bp">|</span> <span class="n">Free.bind</span> <span class="n">val</span> <span class="n">cont</span> <span class="bp">=&gt;</span> <span class="n">Bind.bind</span> <span class="o">(</span><span class="n">m</span><span class="o">:=</span><span class="n">ε</span><span class="o">)</span> <span class="o">(</span><span class="n">Union.simplify</span> <span class="n">val</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">run1</span> <span class="o">(</span><span class="n">cont</span> <span class="n">a</span><span class="o">))</span>
  <span class="n">decreasing_by</span> <span class="gr">sorry</span>
<span class="kd">end</span> <span class="n">Eff</span>
</code></pre></div>



<a name="291019389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/291019389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Locria Cyber <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#291019389">(Jul 27 2022 at 11:15)</a>:</h4>
<p>I can't prove <code>Eff.run1</code>  terminate.</p>



<a name="291020128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/291020128" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Locria Cyber <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#291020128">(Jul 27 2022 at 11:23)</a>:</h4>
<p>Lean doesn't let me do this</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">mutual</span>
  <span class="kd">def</span> <span class="n">bbb</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">Free</span> <span class="n">Option</span> <span class="n">Nat</span> <span class="o">:=</span> <span class="n">Free.bind</span> <span class="o">(</span><span class="n">Option.some</span> <span class="mi">1</span><span class="o">)</span> <span class="n">aaa</span>
  <span class="kd">def</span> <span class="n">aaa</span> <span class="o">(</span><span class="n">_</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:</span> <span class="n">Free</span> <span class="n">Option</span> <span class="n">Nat</span> <span class="o">:=</span> <span class="n">Free.bind</span> <span class="o">(</span><span class="n">Option.some</span> <span class="mi">1</span><span class="o">)</span> <span class="n">bbb</span>
<span class="kd">end</span>
</code></pre></div>
<p>So it's safe, right?</p>



<a name="291035415"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/291035415" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> François G. Dorais <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#291035415">(Jul 27 2022 at 13:44)</a>:</h4>
<p>If you replace <code>sorry</code> by <code>{ simp_wf; done }</code> you will see the issue: there is no reasonable way to assign a meaningful <code>sizeOf</code> value to <code>cont</code>.  With <code>bind : ε α -&gt; (α -&gt; Free ε β) -&gt; Free ε β</code> you want the size of <code>bind val cont</code> to be larger than that of <code>cont x</code> for every <code>x : α</code>.  This doesn't make sense, for example, when <code>α</code> is <code>Nat</code> and <code>sizeOf (cont n) &gt; n</code> for every <code>n : Nat</code>.</p>
<p>Bottom line, the  <code>Free</code> monad is too big for a measure into <code>Nat</code>. You will need to use a more general form well-founded recursion to make this work.</p>



<a name="320924227"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/algebraic%20effects%20and%20handlers%3F/near/320924227" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Andrés Goens <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F.html#320924227">(Jan 12 2023 at 12:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515610">Locria Cyber</span> <a href="#narrow/stream/270676-lean4/topic/algebraic.20effects.20and.20handlers.3F/near/290961535">said</a>:</p>
<blockquote>
<p>I made a library for this. <a href="https://github.com/locriacyber/lean-eff">https://github.com/locriacyber/lean-eff</a></p>
</blockquote>
<p><span class="user-mention" data-user-id="515610">@Locria Cyber</span> did you migrate this repository somewhere else (i.e. is it still public somewhere)?</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>