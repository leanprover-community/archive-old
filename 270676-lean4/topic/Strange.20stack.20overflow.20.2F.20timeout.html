---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html">Strange stack overflow / timeout</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="246118411"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246118411" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ramon Fernandez Mir <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246118411">(Jul 15 2021 at 16:19)</a>:</h4>
<p>I've been playing with Lean 4, trying to prove some basic facts about matrices and writing a few tactics. I encountered an issue that I can't quite explain and I'm not sure how to debug. Essentially, what I want is to get cases for every index and then prove inequalities between ground terms whose values come from matrices.  I've seen different errors depending on the example I was working with anywhere from stack overflows, cores dumped, or simply timing out. Here's a <a href="https://leanprover-community.github.io/mwe.html">#mwe</a> that I believe illustrates my issue:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">m</span> <span class="o">:</span> <span class="o">(</span><span class="n">Fin</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">Fin</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">→</span> <span class="n">Int</span> <span class="o">:=</span>
<span class="k">fun</span> <span class="n">i</span> <span class="n">j</span> <span class="bp">=&gt;</span> <span class="bp">#</span><span class="o">[</span><span class="bp">#</span><span class="o">[</span><span class="mi">52532234335</span><span class="o">,</span> <span class="bp">-</span><span class="mi">234231224</span><span class="o">],</span> <span class="bp">#</span><span class="o">[</span><span class="bp">-</span><span class="mi">122223</span><span class="o">,</span> <span class="mi">29338123232</span><span class="o">]][</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span>

<span class="kd">lemma</span> <span class="n">works</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">2</span><span class="o">),</span> <span class="n">Int.natAbs</span> <span class="o">(</span><span class="n">m</span> <span class="n">x</span> <span class="n">x</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">10</span> <span class="bp">^</span> <span class="mi">80</span> <span class="o">:=</span> <span class="kd">by</span> <span class="o">{</span>
  <span class="n">intros</span> <span class="n">x</span><span class="bp">;</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">∨</span> <span class="n">x</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="gr">sorry</span><span class="bp">;</span>
  <span class="n">cases</span> <span class="n">h</span><span class="bp">;</span>
  <span class="n">allGoals</span> <span class="o">(</span><span class="n">subst</span> <span class="n">x</span><span class="bp">;</span> <span class="n">dec_trivial</span><span class="o">)</span>
<span class="o">}</span>

<span class="kd">lemma</span> <span class="n">doesnot</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">2</span><span class="o">),</span> <span class="n">Int.natAbs</span> <span class="o">(</span><span class="n">m</span> <span class="n">x</span> <span class="n">x</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">10</span> <span class="bp">^</span> <span class="mi">80</span> <span class="o">:=</span> <span class="kd">by</span> <span class="o">{</span>
  <span class="n">intros</span> <span class="n">x</span><span class="bp">;</span>
  <span class="n">obtain</span> <span class="o">⟨</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">⟩</span> <span class="k">from</span> <span class="n">x</span><span class="bp">;</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">∨</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="gr">sorry</span><span class="bp">;</span>
  <span class="n">cases</span> <span class="n">h</span><span class="bp">;</span>
  <span class="n">allGoals</span> <span class="o">(</span><span class="n">subst</span> <span class="n">a</span><span class="bp">;</span> <span class="gr">sorry</span><span class="o">)</span>
  <span class="c1">-- allGoals (subst x; dec_trivial) -- stack overflow / timeout</span>
<span class="o">}</span>
</code></pre></div>
<p>I translated <code>dec_trivial</code> from what we had in Lean 3 and <code>obtain</code> I copied from an example somewhere in the docs:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">as_true</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">[</span><span class="n">Decidable</span> <span class="n">c</span><span class="o">]</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span>
<span class="k">if</span> <span class="n">c</span> <span class="k">then</span> <span class="n">True</span> <span class="k">else</span> <span class="n">False</span>

<span class="kd">lemma</span> <span class="n">of_as_true</span> <span class="o">{</span><span class="n">c</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">[</span><span class="n">h₁</span> <span class="o">:</span> <span class="n">Decidable</span> <span class="n">c</span><span class="o">]</span> <span class="o">(</span><span class="n">h₂</span> <span class="o">:</span> <span class="n">as_true</span> <span class="n">c</span><span class="o">)</span> <span class="o">:</span> <span class="n">c</span> <span class="o">:=</span>
<span class="k">match</span> <span class="n">h₁</span><span class="o">,</span> <span class="n">h₂</span> <span class="k">with</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">isTrue</span> <span class="n">h_c</span><span class="o">),</span>  <span class="n">h₂</span> <span class="bp">=&gt;</span> <span class="n">h_c</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">isFalse</span> <span class="n">h_c</span><span class="o">),</span> <span class="n">h₂</span> <span class="bp">=&gt;</span> <span class="n">False.elim</span> <span class="n">h₂</span>

<span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">Parser.Tactic.triv</span><span class="o">)</span> <span class="s2">"triv"</span> <span class="o">:</span> <span class="n">tactic</span>

<span class="kd">@[tactic triv]</span> <span class="kd">def</span> <span class="n">triv</span> <span class="o">:</span> <span class="n">Tactic</span> <span class="o">:=</span> <span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">closeMainGoal</span> <span class="o">(</span><span class="n">mkConst</span> <span class="bp">`</span><span class="n">trivial</span><span class="o">)</span>

<span class="n">macro</span> <span class="s2">"dec_trivial"</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span><span class="n">exact</span> <span class="o">(</span><span class="n">of_as_true</span> <span class="o">(</span><span class="kd">by</span> <span class="n">triv</span><span class="o">)))</span>

<span class="n">macro</span> <span class="s2">"obtain "</span> <span class="n">p</span><span class="o">:</span><span class="n">term</span> <span class="s2">" from "</span> <span class="n">d</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span>
<span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="k">match</span> <span class="bp">$</span><span class="n">d</span><span class="o">:</span><span class="n">term</span> <span class="k">with</span> <span class="bp">|</span> <span class="bp">$</span><span class="n">p</span><span class="o">:</span><span class="n">term</span> <span class="bp">=&gt;</span> <span class="bp">?</span><span class="n">_</span><span class="o">)</span>
</code></pre></div>
<p>So somehow, <code>obtain</code> seems to be breaking everything. But then if I make the numbers in the matrix small, everything is fine. Even just removing <code>Int.natAbs</code> in the <code>doesnot</code> lemma, the proof goes through... What am I missing??</p>



<a name="246120175"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246120175" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246120175">(Jul 15 2021 at 16:31)</a>:</h4>
<p>dec_trivial is a kernel computation, so it evaluates using unary arithmetic, which will blow up with huge numbers. You want a norm_num there instead</p>



<a name="246120339"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246120339" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246120339">(Jul 15 2021 at 16:32)</a>:</h4>
<blockquote>
<p>kernel computation, so it evaluates using unary arithmetic</p>
</blockquote>
<p>This was in Lean 3.  In Lean 4, the kernel evaluation should use GMP as well.</p>



<a name="246122326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246122326" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Yakov Pechersky <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246122326">(Jul 15 2021 at 16:46)</a>:</h4>
<p>Wonderful! Sorry for the FUD</p>



<a name="246128744"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246128744" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246128744">(Jul 15 2021 at 17:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="132858">Ramon Fernandez Mir</span> Sorry, but I am having trouble reproducing this error. Here is the full code I am using:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>
<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Elab</span> <span class="n">Tactic</span>

<span class="kd">def</span> <span class="n">as_true</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">[</span><span class="n">Decidable</span> <span class="n">c</span><span class="o">]</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span>
  <span class="k">if</span> <span class="n">c</span> <span class="k">then</span> <span class="n">True</span> <span class="k">else</span> <span class="n">False</span>

<span class="kd">theorem</span> <span class="n">of_as_true</span> <span class="o">{</span><span class="n">c</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">[</span><span class="n">h₁</span> <span class="o">:</span> <span class="n">Decidable</span> <span class="n">c</span><span class="o">]</span> <span class="o">(</span><span class="n">h₂</span> <span class="o">:</span> <span class="n">as_true</span> <span class="n">c</span><span class="o">)</span> <span class="o">:</span> <span class="n">c</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">h₁</span><span class="o">,</span> <span class="n">h₂</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">isTrue</span> <span class="n">h_c</span><span class="o">),</span>  <span class="n">h₂</span> <span class="bp">=&gt;</span> <span class="n">h_c</span>
  <span class="bp">|</span> <span class="o">(</span><span class="n">isFalse</span> <span class="n">h_c</span><span class="o">),</span> <span class="n">h₂</span> <span class="bp">=&gt;</span> <span class="n">False.elim</span> <span class="n">h₂</span>

<span class="n">syntax</span> <span class="o">(</span><span class="n">name</span> <span class="o">:=</span> <span class="n">Parser.Tactic.triv</span><span class="o">)</span> <span class="s2">"triv"</span> <span class="o">:</span> <span class="n">tactic</span>

<span class="kd">@[tactic Parser.Tactic.triv]</span> <span class="kd">def</span> <span class="n">triv</span> <span class="o">:</span> <span class="n">Tactic</span> <span class="o">:=</span>
  <span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">closeMainGoal</span> <span class="o">(</span><span class="n">mkConst</span> <span class="bp">`</span><span class="n">trivial</span><span class="o">)</span>

<span class="n">macro</span> <span class="s2">"dec_trivial"</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span><span class="n">exact</span> <span class="o">(</span><span class="n">of_as_true</span> <span class="o">(</span><span class="kd">by</span> <span class="n">triv</span><span class="o">)))</span>

<span class="n">macro</span> <span class="s2">"obtain "</span> <span class="n">p</span><span class="o">:</span><span class="n">term</span> <span class="s2">" from "</span> <span class="n">d</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="n">tactic</span> <span class="bp">=&gt;</span>
<span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="k">match</span> <span class="bp">$</span><span class="n">d</span><span class="o">:</span><span class="n">term</span> <span class="k">with</span> <span class="bp">|</span> <span class="bp">$</span><span class="n">p</span><span class="o">:</span><span class="n">term</span> <span class="bp">=&gt;</span> <span class="bp">?</span><span class="n">_</span><span class="o">)</span>

<span class="kd">def</span> <span class="n">m</span> <span class="o">:</span> <span class="o">(</span><span class="n">Fin</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">Fin</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">→</span> <span class="n">Int</span> <span class="o">:=</span>
<span class="k">fun</span> <span class="n">i</span> <span class="n">j</span> <span class="bp">=&gt;</span> <span class="bp">#</span><span class="o">[</span><span class="bp">#</span><span class="o">[</span><span class="mi">52532234335</span><span class="o">,</span> <span class="bp">-</span><span class="mi">234231224</span><span class="o">],</span> <span class="bp">#</span><span class="o">[</span><span class="bp">-</span><span class="mi">122223</span><span class="o">,</span> <span class="mi">29338123232</span><span class="o">]][</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span>

<span class="kd">theorem</span> <span class="n">works</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">2</span><span class="o">),</span> <span class="n">Int.natAbs</span> <span class="o">(</span><span class="n">m</span> <span class="n">x</span> <span class="n">x</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">10</span> <span class="bp">^</span> <span class="mi">80</span> <span class="o">:=</span> <span class="kd">by</span> <span class="o">{</span>
  <span class="n">intros</span> <span class="n">x</span><span class="bp">;</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">:</span> <span class="n">x</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">∨</span> <span class="n">x</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="gr">sorry</span><span class="bp">;</span>
  <span class="n">cases</span> <span class="n">h</span><span class="bp">;</span>
  <span class="n">allGoals</span> <span class="o">(</span><span class="n">subst</span> <span class="n">x</span><span class="bp">;</span> <span class="n">dec_trivial</span><span class="o">)</span>
<span class="o">}</span>

<span class="kd">theorem</span> <span class="n">doesnot</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Fin</span> <span class="mi">2</span><span class="o">),</span> <span class="n">Int.natAbs</span> <span class="o">(</span><span class="n">m</span> <span class="n">x</span> <span class="n">x</span><span class="o">)</span> <span class="bp">≤</span> <span class="mi">10</span> <span class="bp">^</span> <span class="mi">80</span> <span class="o">:=</span> <span class="kd">by</span> <span class="o">{</span>
  <span class="n">intros</span> <span class="n">x</span><span class="bp">;</span>
  <span class="n">obtain</span> <span class="o">⟨</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">⟩</span> <span class="k">from</span> <span class="n">x</span><span class="bp">;</span>
  <span class="k">have</span> <span class="n">h</span> <span class="o">:</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span> <span class="bp">∨</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">1</span> <span class="o">:=</span> <span class="gr">sorry</span><span class="bp">;</span>
  <span class="n">cases</span> <span class="n">h</span><span class="bp">;</span>
  <span class="n">allGoals</span> <span class="o">(</span><span class="n">subst</span> <span class="n">a</span><span class="bp">;</span> <span class="gr">admit</span><span class="o">)</span>
  <span class="n">allGoals</span> <span class="o">(</span><span class="n">subst</span> <span class="n">x</span><span class="bp">;</span> <span class="n">dec_trivial</span><span class="o">)</span> <span class="c1">-- stack overflow / timeout</span>
<span class="o">}</span>
</code></pre></div>
<p>It works for me (the last line completes successfully and nothing breaks).</p>



<a name="246129142"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246129142" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246129142">(Jul 15 2021 at 17:35)</a>:</h4>
<p>One a somewhat unrelated note, I do not understand why the definition of <code>of_as_true</code> was written to match on both <code>h₁</code> and <code>h₂</code> when it only really matches against is <code>h₁</code>. Also, the parentheses in the match seem unnecessary (but that could easily be an artifact from translating this from Lean 3).</p>



<a name="246129544"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246129544" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246129544">(Jul 15 2021 at 17:38)</a>:</h4>
<p>Ah, now that I think about it. <strong>What version of Lean 4 are you using?</strong></p>



<a name="246129656"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246129656" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246129656">(Jul 15 2021 at 17:38)</a>:</h4>
<p>Have you tried testing this on the latest nightly?</p>



<a name="246132902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246132902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246132902">(Jul 15 2021 at 18:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout/near/246129142">said</a>:</p>
<blockquote>
<p>One a somewhat unrelated note, I do not understand why the definition of <code>of_as_true</code> was written to match on both <code>h₁</code> and <code>h₂</code> when it only really matches against is <code>h₁</code>. Also, the parentheses in the match seem unnecessary (but that could easily be an artifact from translating this from Lean 3).</p>
</blockquote>
<p>I think this is to ensure that the case split on <code>h1</code> gets propagated into the type of <code>h2</code>. Lean 4 has <code>match (generalizing := true)</code> for this afair.</p>



<a name="246140987"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246140987" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246140987">(Jul 15 2021 at 19:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256311">Jannis Limperg</span> <a href="#narrow/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout/near/246132902">said</a>:</p>
<blockquote>
<p>I think this is to ensure that the case split on <code>h1</code> gets propagated into the type of <code>h2</code>. Lean 4 has <code>match (generalizing := true)</code> for this afair.</p>
</blockquote>
<p>Ah. And, of I am not mistaken, <code>generalizing := true</code> is the default for <code>Prop</code>.</p>



<a name="246141213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246141213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246141213">(Jul 15 2021 at 19:09)</a>:</h4>
<p>Regardless, in Lean 4, this definition does work:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">theorem</span> <span class="n">of_as_true</span> <span class="o">{</span><span class="n">c</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">[</span><span class="n">h₁</span> <span class="o">:</span> <span class="n">Decidable</span> <span class="n">c</span><span class="o">]</span> <span class="o">(</span><span class="n">h₂</span> <span class="o">:</span> <span class="n">as_true</span> <span class="n">c</span><span class="o">)</span> <span class="o">:</span> <span class="n">c</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">h₁</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">isTrue</span> <span class="n">h_c</span>  <span class="bp">=&gt;</span> <span class="n">h_c</span>
  <span class="bp">|</span> <span class="n">isFalse</span> <span class="n">h_c</span> <span class="bp">=&gt;</span> <span class="n">False.elim</span> <span class="n">h₂</span>
</code></pre></div>



<a name="246206311"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246206311" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ramon Fernandez Mir <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246206311">(Jul 16 2021 at 10:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout/near/246129656">said</a>:</p>
<blockquote>
<p>Have you tried testing this on the latest nightly?</p>
</blockquote>
<p>Yes and still can't solve it...</p>



<a name="246206394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246206394" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ramon Fernandez Mir <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246206394">(Jul 16 2021 at 10:22)</a>:</h4>
<p>In general though, how can I debug an issue like this one? How can I get some sort of execution trace?</p>



<a name="246206578"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246206578" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246206578">(Jul 16 2021 at 10:24)</a>:</h4>
<p>One thing that helps is to minimize the example. Remove everything that doesn't contribute to the bug. If it has to do with kernel computation then you can probably get it down to <code>example : ... := by dec_trivial</code></p>



<a name="246237585"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246237585" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246237585">(Jul 16 2021 at 15:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="132858">Ramon Fernandez Mir</span> <a href="#narrow/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout/near/246206311">said</a>:</p>
<blockquote>
<p>Yes and still can't solve it...</p>
</blockquote>
<p>Ah. Sorry that I can't help more since I can't reproduce it. One thing I would try is all positive or all negative numbers (especially since it might have something to do with <code>Int.natAbs</code>).</p>



<a name="246252202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246252202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ramon Fernandez Mir <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246252202">(Jul 16 2021 at 17:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout/near/246206578">said</a>:</p>
<blockquote>
<p>One thing that helps is to minimize the example. Remove everything that doesn't contribute to the bug. If it has to do with kernel computation then you can probably get it down to <code>example : ... := by dec_trivial</code></p>
</blockquote>
<p>So I managed to find an even simpler example that hangs:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">m</span> <span class="o">:</span> <span class="o">(</span><span class="n">Fin</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">Fin</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">→</span> <span class="n">Int</span> <span class="o">:=</span>
<span class="k">fun</span> <span class="n">i</span> <span class="n">j</span> <span class="bp">=&gt;</span> <span class="bp">#</span><span class="o">[</span><span class="bp">#</span><span class="o">[</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">],</span> <span class="bp">#</span><span class="o">[</span><span class="mi">0</span><span class="o">,</span> <span class="mi">100000000</span><span class="o">]][</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span>

<span class="kd">theorem</span> <span class="n">simpler</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:</span> <span class="n">Int.natAbs</span> <span class="o">(</span><span class="n">m</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span> <span class="n">h</span><span class="o">⟩</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span> <span class="n">h</span><span class="o">⟩)</span> <span class="bp">≤</span> <span class="mi">100000000</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">dec_trivial</span>
</code></pre></div>
<p>This is on a fresh project running on lean 4.0.0-nightly-2021-07-14. Also, if you make the numbers small, it works. If you replace the <code>⟨1, h⟩</code> by simply <code>1</code>, it works. And removing <code>Int.natAbs</code> also makes it work. So quite mysterious altogether.</p>



<a name="246254813"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246254813" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246254813">(Jul 16 2021 at 17:36)</a>:</h4>
<p>Yay, that worked. I can finally reproduce this! :)</p>



<a name="246257831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246257831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246257831">(Jul 16 2021 at 17:58)</a>:</h4>
<p>I was able to get the stack overflow with this cut-down example as well:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">as_true</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">[</span><span class="n">Decidable</span> <span class="n">c</span><span class="o">]</span> <span class="o">:</span> <span class="kt">Prop</span> <span class="o">:=</span>
  <span class="k">if</span> <span class="n">c</span> <span class="k">then</span> <span class="n">True</span> <span class="k">else</span> <span class="n">False</span>

<span class="kd">theorem</span> <span class="n">of_as_true</span> <span class="o">{</span><span class="n">c</span> <span class="o">:</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">[</span><span class="n">h₁</span> <span class="o">:</span> <span class="n">Decidable</span> <span class="n">c</span><span class="o">]</span> <span class="o">(</span><span class="n">h₂</span> <span class="o">:</span> <span class="n">as_true</span> <span class="n">c</span><span class="o">)</span> <span class="o">:</span> <span class="n">c</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">h₁</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">isTrue</span> <span class="n">h_c</span>  <span class="bp">=&gt;</span> <span class="n">h_c</span>
  <span class="bp">|</span> <span class="n">isFalse</span> <span class="n">h_c</span> <span class="bp">=&gt;</span> <span class="n">False.elim</span> <span class="n">h₂</span>

<span class="kd">def</span> <span class="n">n</span> <span class="o">:=</span> <span class="mi">100000000</span>

<span class="kd">def</span> <span class="n">m</span> <span class="o">:</span> <span class="o">(</span><span class="n">Fin</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">Fin</span> <span class="mi">2</span><span class="o">)</span> <span class="bp">→</span> <span class="n">Int</span> <span class="o">:=</span>
<span class="k">fun</span> <span class="n">i</span> <span class="n">j</span> <span class="bp">=&gt;</span> <span class="bp">#</span><span class="o">[</span><span class="bp">#</span><span class="o">[</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">],</span> <span class="bp">#</span><span class="o">[</span><span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">]][</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span>

<span class="kd">theorem</span> <span class="n">simpler</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:</span> <span class="n">Int.natAbs</span> <span class="o">(</span><span class="n">m</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="n">h</span><span class="o">⟩)</span> <span class="bp">≤</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">of_as_true</span> <span class="n">trivial</span> <span class="c1">-- stack overflow</span>
</code></pre></div>



<a name="246258341"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246258341" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246258341">(Jul 16 2021 at 18:02)</a>:</h4>
<p>The processing time increases as the order of magnitude of <code>n</code> increases. Thus, <span class="user-mention" data-user-id="308899">@Yakov Pechersky</span> appears to be right, the kernel is for some reason doing unary arithmetic, causing the stack blow-up.</p>



<a name="246258861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246258861" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246258861">(Jul 16 2021 at 18:06)</a>:</h4>
<p>Given that this doesn't occur when <code>Int.natAbs</code> is absent or  the  <code>⟨1,h⟩</code> is replaced with <code>1</code>, I would assume this has to do with the kernel not realizing that <code>Int.natAbs (m ⟨1,h⟩ ⟨1,h⟩)</code> is a computable <code>Nat</code> (and, more generally, that the less than is decidable through computation) and is thus relying on its logical representation (rather than its computable one).</p>



<a name="246260280"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246260280" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246260280">(Jul 16 2021 at 18:18)</a>:</h4>
<p>Note that <code>decide</code> fails in with <code>⟨1,h⟩</code> but not with <code>1</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">theorem</span> <span class="n">decide1</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:</span> <span class="n">Int.natAbs</span> <span class="o">(</span><span class="n">m</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="n">h</span><span class="o">⟩)</span> <span class="bp">≤</span> <span class="n">n</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">decide</span>
<span class="sd">/--</span>
<span class="sd">expected type must not contain free or meta variables</span>
<span class="sd">  Int.natAbs (m { val := 1, isLt := h } { val := 1, isLt := h }) ≤ n</span>
<span class="sd">-/</span>

<span class="c1">-- the `h` parameter is irrelevant</span>
<span class="kd">theorem</span> <span class="n">decide2</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:</span> <span class="n">Int.natAbs</span> <span class="o">(</span><span class="n">m</span> <span class="mi">1</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">≤</span> <span class="n">n</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">decide</span> <span class="c1">-- works</span>
</code></pre></div>



<a name="246260688"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246260688" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246260688">(Jul 16 2021 at 18:22)</a>:</h4>
<p>However, <code>decide</code> still fails without <code>Int.natAbs</code> while the <code>of_as_true trivial</code> does not:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">theorem</span> <span class="n">decide3</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:</span> <span class="n">m</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="bp">≤</span> <span class="n">n</span> <span class="o">:=</span>
<span class="kd">by</span> <span class="n">decide</span>
<span class="sd">/--</span>
<span class="sd">expected type must not contain free or meta variables</span>
<span class="sd">  m { val := 1, isLt := h } { val := 1, isLt := h } ≤ Int.ofNat n</span>
<span class="sd">-/</span>

<span class="kd">theorem</span> <span class="n">simpler3</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="mi">1</span> <span class="bp">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">:</span> <span class="n">m</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="o">⟨</span><span class="mi">1</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span> <span class="bp">≤</span> <span class="n">n</span> <span class="o">:=</span>
<span class="n">of_as_true</span> <span class="n">trivial</span> <span class="c1">-- works</span>
</code></pre></div>
<p>So it is clear that <code>decide</code> is getting caught up on the <code>h</code>.</p>



<a name="246262462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246262462" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246262462">(Jul 16 2021 at 18:39)</a>:</h4>
<p>My biggest confusion is thus why <code>m ⟨1,h⟩ ⟨1,h⟩ ≤ n</code> works (with <code>of_as_true trivial</code>). Based on the behavior with <code>decide</code>, I would expect it to break as well.</p>



<a name="246272139"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246272139" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246272139">(Jul 16 2021 at 20:07)</a>:</h4>
<p>The kernel representation can compute this though, so I would expect it to work</p>



<a name="246272228"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246272228" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246272228">(Jul 16 2021 at 20:08)</a>:</h4>
<p>That is, lean 3 <code>#reduce</code> would work on this even without any fancy kernel nats</p>



<a name="246273901"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246273901" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246273901">(Jul 16 2021 at 20:25)</a>:</h4>
<p>Here it is minimized some more:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">n</span> <span class="o">:=</span> <span class="mi">30000</span>
<span class="kd">theorem</span> <span class="n">simpler</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">True</span><span class="o">)</span> <span class="o">:</span> <span class="n">Nat.ble</span> <span class="o">((</span><span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">n</span><span class="o">)</span> <span class="n">h</span><span class="o">)</span> <span class="n">n</span> <span class="bp">=</span> <span class="n">true</span> <span class="o">:=</span> <span class="n">rfl</span>
</code></pre></div>
<p>(The number has been reduced so that it is long enough to be noticeable without bricking your machine)</p>



<a name="246274066"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246274066" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246274066">(Jul 16 2021 at 20:26)</a>:</h4>
<p>My guess is that at this point, lean's defeq heuristics say to unfold <code>Nat.ble</code> instead of the beta redex, after which point it loses the ability to take advantage of the kernel computation</p>



<a name="246276595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246276595" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246276595">(Jul 16 2021 at 20:48)</a>:</h4>
<p>(deleted)</p>



<a name="246277248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246277248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246277248">(Jul 16 2021 at 20:54)</a>:</h4>
<p>The check to not reduce open terms is correct here by the way; even if it's a prop, it can be a false assumption, in which case the compiled code could go off the rails</p>



<a name="246277329"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246277329" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246277329">(Jul 16 2021 at 20:55)</a>:</h4>
<p>well, even closed terms can have that issue in the presence of axioms</p>



<a name="246295926"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246295926" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246295926">(Jul 17 2021 at 01:04)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> This commit fixes the performance issue: <a href="https://github.com/dselsam/lean4/commit/6ced516e6acb8cf038b2e9a1d2c87a1a6497bef8">https://github.com/dselsam/lean4/commit/6ced516e6acb8cf038b2e9a1d2c87a1a6497bef8</a> I may be missing something obvious but I don't see why it would be unsound -- <code>reduce_nat</code> only does built-in operations on terms that actually reduce to nat literals.</p>



<a name="246296215"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246296215" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246296215">(Jul 17 2021 at 01:12)</a>:</h4>
<p>I think you are right</p>



<a name="246296277"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246296277" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246296277">(Jul 17 2021 at 01:14)</a>:</h4>
<p>although that check in reduce_nat is probably a perfomance optimization since it's a lot easier to check the <code>has_fvar</code> bit on an expression than see whether it is <code>nat.succ</code>, <code>nat.add</code> etc</p>



<a name="246296498"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246296498" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246296498">(Jul 17 2021 at 01:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="230999">Daniel Selsam</span> <a href="#narrow/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout/near/246295926">said</a>:</p>
<blockquote>
<p><code>reduce_nat</code> only does built-in operations on terms that actually reduce to nat literals.</p>
</blockquote>
<p>But couldn't that still be a problem? For example:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">axiom</span> <span class="n">h</span> <span class="o">:</span> <span class="mi">300</span> <span class="bp">&lt;</span> <span class="mi">256</span>
<span class="kd">def</span> <span class="n">n</span> <span class="o">:</span> <span class="n">UInt8</span> <span class="o">:=</span> <span class="o">⟨</span><span class="mi">300</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span>
<span class="k">#eval</span> <span class="n">n</span> <span class="c1">-- 44</span>
</code></pre></div>
<p><code>n</code> is still a nat literal -- it just happens to be the <em>wrong</em> nat literal. I imagine this could cause unsoundness in a more sophisticated example.</p>



<a name="246297111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246297111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246297111">(Jul 17 2021 at 01:37)</a>:</h4>
<p><code>n</code> doesn't reduce to <code>44</code> though</p>



<a name="246297122"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246297122" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246297122">(Jul 17 2021 at 01:38)</a>:</h4>
<p>It's also not a nat literal</p>



<a name="246297239"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246297239" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246297239">(Jul 17 2021 at 01:40)</a>:</h4>
<p><code>n.1</code> has type <code>Nat</code>, and it whnf-reduces to a nat literal, namely <code>300</code>, and it is provably equal to <code>44</code> but I don't think you can make it reduce to <code>44</code></p>



<a name="246297727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246297727" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246297727">(Jul 17 2021 at 01:54)</a>:</h4>
<p>Well, this crashes with max recursion:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">axiom</span> <span class="n">h</span> <span class="o">:</span> <span class="mi">300</span> <span class="bp">&lt;</span> <span class="mi">256</span>
<span class="kd">def</span> <span class="n">n</span> <span class="o">:</span> <span class="n">UInt8</span> <span class="o">:=</span> <span class="o">⟨</span><span class="mi">300</span><span class="o">,</span><span class="n">h</span><span class="o">⟩</span>
<span class="kd">def</span> <span class="n">n'</span> <span class="o">:=</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">1</span>
<span class="k">#reduce</span> <span class="n">n'</span>
<span class="c">/-</span><span class="cm"></span>
<span class="cm">maximum recursion depth has been reached</span>
<span class="cm">(use `set_option maxRecDepth &lt;num&gt;` to increase limit)</span>
<span class="cm">-/</span>
</code></pre></div>
<p>Is that expected?</p>



<a name="246297925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246297925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246297925">(Jul 17 2021 at 01:58)</a>:</h4>
<p>Oh, apparently that just always happens:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">n</span> <span class="o">:</span> <span class="n">UInt8</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="kd">def</span> <span class="n">n'</span> <span class="o">:=</span> <span class="n">n</span> <span class="bp">+</span> <span class="mi">0</span>
<span class="k">#reduce</span> <span class="n">n'</span> <span class="c1">-- same error</span>
</code></pre></div>
<p><em>Is</em> this expected?</p>



<a name="246298386"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246298386" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246298386">(Jul 17 2021 at 02:08)</a>:</h4>
<p>It does not seem surprising -- calling <code>reduce</code> on a proof isn't usually a good idea. Note that there is a TODO in the code to allow <code>#reduce</code> to take additional arguments e.g. to avoid reducing proofs <a href="https://github.com/leanprover/lean4/blob/master/src/Lean/Elab/BuiltinCommand.lean#L222-L224">https://github.com/leanprover/lean4/blob/master/src/Lean/Elab/BuiltinCommand.lean#L222-L224</a></p>



<a name="246298460"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Strange%20stack%20overflow%20/%20timeout/near/246298460" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Strange.20stack.20overflow.20.2F.20timeout.html#246298460">(Jul 17 2021 at 02:11)</a>:</h4>
<p>Ah so it is trying to reduce the <code>isLt</code> proof of <code>UInt8</code> and that is causing the crash. Makes sense.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>