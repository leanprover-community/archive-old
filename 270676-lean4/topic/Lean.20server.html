---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Lean.20server.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html">Lean server</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="258382104"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258382104" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258382104">(Oct 20 2021 at 14:53)</a>:</h4>
<p>Hm, is there an example of a valid request that can be queried to the lean4 server? I'm struggling to get a valid response</p>



<a name="258382194"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258382194" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258382194">(Oct 20 2021 at 14:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> has marked this topic as unresolved.</p>



<a name="258382313"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258382313" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258382313">(Oct 20 2021 at 14:55)</a>:</h4>
<p>It keeps saying <code>Watchdog error: Cannot read LSP request: Invalid header field: ...</code></p>



<a name="258382383"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258382383" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258382383">(Oct 20 2021 at 14:55)</a>:</h4>
<p>I think the easiest way to get some valid communication is to snoop on vscode; there is a setting you can enable to make any LSP extension print all traffic</p>



<a name="258383054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258383054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258383054">(Oct 20 2021 at 14:59)</a>:</h4>
<p>Another way to snoop is to make vscode call <code>my_lean</code> which is a shell script like <code>tee in.txt | lean --server | tee out.txt</code></p>



<a name="258383991"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258383991" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258383991">(Oct 20 2021 at 15:04)</a>:</h4>
<p>Thanks! I wanna see how far I can go with this. I had never heard of LSP before so it's a learning experience :D</p>



<a name="258388638"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258388638" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258388638">(Oct 20 2021 at 15:31)</a>:</h4>
<p>Which extension should I use? Seems like the <code>lean</code> one isn't compatible with Lean 4. Is it the case?</p>



<a name="258389179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258389179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258389179">(Oct 20 2021 at 15:34)</a>:</h4>
<p><a href="/user_uploads/3121/iGrgG3tYH-x56-TH0eACKMpd/image.png">image.png</a> I'm getting similar errors. The plugin seems to be trying to send requests to the lean3 server</p>
<div class="message_inline_image"><a href="/user_uploads/3121/iGrgG3tYH-x56-TH0eACKMpd/image.png" title="image.png"><img src="/user_uploads/3121/iGrgG3tYH-x56-TH0eACKMpd/image.png"></a></div>



<a name="258389291"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258389291" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258389291">(Oct 20 2021 at 15:35)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> you should be using the <code>lean4</code> extension for Lean 4. The <code>lean</code> extension is for Lean 3.</p>



<a name="258395051"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258395051" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258395051">(Oct 20 2021 at 16:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Lean.20server/near/258382383">said</a>:</p>
<blockquote>
<p>I think the easiest way to get some valid communication is to snoop on vscode; there is a setting you can enable to make any LSP extension print all traffic</p>
</blockquote>
<p>Searched a lot but couldn't find such setting. does the lean4 plugin have it available?</p>



<a name="258396256"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258396256" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258396256">(Oct 20 2021 at 16:13)</a>:</h4>
<p>Nevermind, I think I found it</p>



<a name="258397810"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258397810" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258397810">(Oct 20 2021 at 16:22)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> in the VSCode settings, these are the <code>Server Logging</code> settings from the Lean 4 extension.</p>



<a name="258400933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258400933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258400933">(Oct 20 2021 at 16:42)</a>:</h4>
<p>Alright I was able to extract a request from the log:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">{</span><span class="s2">"jsonrpc"</span><span class="o">:</span><span class="s2">"2.0"</span><span class="o">,</span><span class="s2">"method"</span><span class="o">:</span><span class="s2">"textDocument/didOpen"</span><span class="o">,</span><span class="s2">"params"</span><span class="o">:{</span><span class="s2">"textDocument"</span><span class="o">:{</span><span class="s2">"uri"</span><span class="o">:</span><span class="s2">"file:///home/arthur/ex.lean"</span><span class="o">,</span><span class="s2">"languageId"</span><span class="o">:</span><span class="s2">"lean4"</span><span class="o">,</span><span class="s2">"version"</span><span class="o">:</span><span class="mi">1</span><span class="o">,</span><span class="s2">"text"</span><span class="o">:</span><span class="s2">"variable (p q: Prop)</span><span class="se">\n\n</span><span class="s2">example : p ↔ p := by</span><span class="se">\n</span><span class="s2">  apply Iff.intro</span><span class="se">\n</span><span class="s2">  {intro h; apply h}</span><span class="se">\n</span><span class="s2">  {intro h; apply h}"</span><span class="o">}}}</span>
</code></pre></div>
<p>But then I call <code>lean --server &lt; in.json</code> and it responds</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Watchdog</span> <span class="n">error</span><span class="o">:</span> <span class="n">Cannot</span> <span class="n">read</span> <span class="n">LSP</span> <span class="n">request</span><span class="o">:</span> <span class="n">Invalid</span> <span class="n">header</span> <span class="n">field</span><span class="o">:</span> <span class="o">{</span><span class="s2">"jsonrpc"</span><span class="o">:</span><span class="s2">"2.0"</span><span class="o">,</span><span class="s2">"method"</span><span class="o">:</span><span class="s2">"textDocument/didOpen"</span><span class="o">,</span><span class="s2">"params"</span><span class="o">:{</span><span class="s2">"textDocument"</span><span class="o">:{</span><span class="s2">"uri"</span><span class="o">:</span><span class="s2">"file:///home/arthur/ex.lean"</span><span class="o">,</span><span class="s2">"languageId"</span><span class="o">:</span><span class="s2">"lean4"</span><span class="o">,</span><span class="s2">"version"</span><span class="o">:</span><span class="mi">1</span><span class="o">,</span><span class="s2">"text"</span><span class="o">:</span><span class="s2">"variable (p q: Prop)</span><span class="se">\n\n</span><span class="s2">example : p ↔ p := by</span><span class="se">\n</span><span class="s2">  apply Iff.intro</span><span class="se">\n</span><span class="s2">  {intro h; apply h}</span><span class="se">\n</span><span class="s2">  {intro h; apply h}"</span><span class="o">}}}</span>
</code></pre></div>



<a name="258401594"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258401594" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258401594">(Oct 20 2021 at 16:46)</a>:</h4>
<p>I suspect I am doing something fundamentally wrong</p>



<a name="258401686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258401686" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258401686">(Oct 20 2021 at 16:47)</a>:</h4>
<p>The log does not include the HTTP-like LSP headers, see <a href="https://github.com/leanprover/lean4/blob/master/tests/lean/server/open_content.log">https://github.com/leanprover/lean4/blob/master/tests/lean/server/open_content.log</a> and other <code>.log</code> files in that directory</p>



<a name="258402276"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258402276" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258402276">(Oct 20 2021 at 16:50)</a>:</h4>
<p>It would probably be easier to a) write the whole REPL in Lean or, if you e.g. want to use a readline-like library that has not yet been packaged for Lean, b) use a custom protocol between the main REPL program and a custom Lean program, where "protocol" could be as simple as "a single escaped line per request and response"</p>



<a name="258404049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258404049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258404049">(Oct 20 2021 at 17:00)</a>:</h4>
<p>How would that custom Lean program be? How would it communicate with the main REPL program?</p>



<a name="258404475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258404475" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258404475">(Oct 20 2021 at 17:02)</a>:</h4>
<p>Read from <code>IO.getStdin</code>, write via <code>IO.println</code> :)</p>



<a name="258404906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean%20server/near/258404906" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.20server.html#258404906">(Oct 20 2021 at 17:05)</a>:</h4>
<p>The value read would be a string right? how to execute lean string code inside lean itself?</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>