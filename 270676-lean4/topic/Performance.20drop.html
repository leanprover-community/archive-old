---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Performance.20drop.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html">Performance drop</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="310289352"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310289352" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310289352">(Nov 15 2022 at 20:50)</a>:</h4>
<p>Hi! Was there some change that could impact the performance of the execution compiled binaries?<br>
We have a codebase whose execution performance has dropped by half. On <code>leanprover/lean4:nightly-2022-09-11</code> our CI runs lasted around 7 minutes and then after updating to <code>10-27</code> it went up to 12 minutes and beyond. And in the most recent toolchain it's reaching 15 minutes.</p>
<p>This is the codebase: <a href="https://github.com/yatima-inc/yatima-lang">https://github.com/yatima-inc/yatima-lang</a></p>



<a name="310290144"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310290144" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310290144">(Nov 15 2022 at 20:54)</a>:</h4>
<p>I'm asking in the spirit of providing help if needed <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="310290840"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310290840" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310290840">(Nov 15 2022 at 20:58)</a>:</h4>
<p>Could you run <code>perf</code> on both versions and see whether the hot functions have changed?</p>



<a name="310290945"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310290945" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310290945">(Nov 15 2022 at 20:59)</a>:</h4>
<p>if you can minimize the issue that would be super helpful for the benchmark suite</p>



<a name="310291350"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310291350" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310291350">(Nov 15 2022 at 21:01)</a>:</h4>
<p>Any particular version I should get?</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>λ perf
Comando 'perf' não encontrado, mas poder ser instalado com:
sudo apt install linux-intel-iotg-tools-common  # version 5.15.0-1017.22, or
sudo apt install linux-nvidia-tools-common      # version 5.15.0-1007.7
sudo apt install linux-tools-common             # version 5.15.0-52.58
</code></pre></div>



<a name="310291682"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310291682" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310291682">(Nov 15 2022 at 21:02)</a>:</h4>
<p>I'm not an expert but I think <code>sudo apt install linux-tools-common</code> will work?</p>



<a name="310291808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310291808" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310291808">(Nov 15 2022 at 21:03)</a>:</h4>
<p><a href="http://speedcenter.informatik.kit.edu/velcom/repo-detail/bab50d33-13a1-40c4-85a0-fda5f93f8b22?zoomXStart=1657339200000&amp;zoomXEnd=1661227200000&amp;dimensions=rbmap_10%3Atask-clock%3A%3Arbmap_fbip%3Atask-clock%3A%3Aderiv%3Atask-clock%3A%3Arbmap_library%3Atask-clock%3A%3AworkspaceSymbols%3Atask-clock%3A%3Arbmap_1%3Atask-clock%3A%3Aliasolver%3Atask-clock%3A%3Aqsort%3Atask-clock%3A%3Aunionfind%3Atask-clock%3A%3Aconst_fold%3Atask-clock%3A%3Atests%2Fbench%2F%20interpreted%3Atask-clock%3A%3Anew%20parser%20Core.lean%3Atask-clock%3A%3Arbmap%3Atask-clock%3A%3Astdlib%3Atask-clock%3A%3Abinarytrees%3Atask-clock&amp;dayEquidistant=true">Here's the relevant graph</a> for changes in execution time on a bunch of benchmarks, I don't see any that got much worse on those days</p>



<a name="310292251"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310292251" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310292251">(Nov 15 2022 at 21:06)</a>:</h4>
<p>How do I run <code>perf</code> in a meaningful way for us?</p>



<a name="310293198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310293198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310293198">(Nov 15 2022 at 21:12)</a>:</h4>
<p>I'm hoping someone who knows more will swoop  in here, but <a href="https://www.brendangregg.com/perf.html">this page</a> has some example commands, and I think one that is relevant is:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>perf record --call-graph dwarf my_command
perf report --stdio
</code></pre></div>



<a name="310293512"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310293512" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310293512">(Nov 15 2022 at 21:13)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> this <a href="#narrow/stream/270676-lean4/topic/Stack.20trace.20profiling">thread</a> helped me getting <code>perf</code> to work.</p>



<a name="310293634"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310293634" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310293634">(Nov 15 2022 at 21:14)</a>:</h4>
<p>Also <a href="https://github.com/leanprover/lean4/blob/master/doc/perf.md">https://github.com/leanprover/lean4/blob/master/doc/perf.md</a></p>



<a name="310293680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310293680" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310293680">(Nov 15 2022 at 21:14)</a>:</h4>
<p>And the <a href="https://profiler.firefox.com/">FF Profiler</a> is a great web UI for <code>perf</code> traces</p>



<a name="310298154"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310298154" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310298154">(Nov 15 2022 at 21:42)</a>:</h4>
<p>These are the top lines from <code>perf diff old.data new.data</code>:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code># Baseline  Delta Abs  Shared Object         Symbol
# ........  .........  ....................  ..........................................
#
     0.19%    +66.82%  yatima                [.] 0x00000000035d69a0
               +5.28%  yatima                [.] lean::for_each_fn::apply
               +3.75%  yatima                [.] l_Yatima_Typechecker_printExpr
               +3.34%  yatima                [.] l_List_mapM___at_Yatima_Transpiler_mkIndLiteral___spec__1
     4.57%     -2.44%  [unknown]             [k] 0xffffffffa76063a5
               +2.13%  yatima                [.] l_IO_eprintln___at_compileRun___spec__3
               +1.26%  yatima                [.] lean::add_inductive_fn::mk_rec_infos
               +0.95%  yatima                [.] l_Yatima_Typechecker_toCtorIfLit
     2.13%     -0.84%  libleanshared.so      [.] lean_uint64_mix_hash
     0.92%     -0.80%  libleanshared.so      [.] lean_mark_mt
               +0.66%  yatima                [.] l_Yatima_Typechecker_eval
               +0.57%  yatima                [.] lean::replace
     0.00%     +0.51%  yatima                [.] lean::elim_dead_let_fn::visit_lambda
</code></pre></div>



<a name="310298289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310298289" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310298289">(Nov 15 2022 at 21:43)</a>:</h4>
<p><code>0x00000000035d69a0</code> is clearly guilty. Any other question?</p>



<a name="310298459"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310298459" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310298459">(Nov 15 2022 at 21:44)</a>:</h4>
<p>Is that the output we want from <code>perf</code>?</p>



<a name="310298568"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310298568" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Lacker <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310298568">(Nov 15 2022 at 21:45)</a>:</h4>
<p>i find it easier to look at perf data in a different format, like a flamegraph, for example with this tool: <a href="https://github.com/brendangregg/FlameGraph">https://github.com/brendangregg/FlameGraph</a></p>



<a name="310300351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310300351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310300351">(Nov 15 2022 at 21:56)</a>:</h4>
<p>Try dwarf,60000 that should get us a better suspect.</p>



<a name="310300699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310300699" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310300699">(Nov 15 2022 at 21:58)</a>:</h4>
<p>I downloaded <code>hotspot</code> and it seems to show better data. Anyone up for a quick jitsi call?</p>



<a name="310300730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310300730" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310300730">(Nov 15 2022 at 21:59)</a>:</h4>
<p>I can share my screen</p>



<a name="310301467"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310301467" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310301467">(Nov 15 2022 at 22:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/Performance.20drop/near/310300351">said</a>:</p>
<blockquote>
<p>Try dwarf,60000 that should get us a better suspect.</p>
</blockquote>
<p>Running that</p>



<a name="310302991"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310302991" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310302991">(Nov 15 2022 at 22:14)</a>:</h4>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>    32.30%    -32.07%  yatima                [.] 0x0000000000a183d1
              +22.17%  yatima                [.] lean_dec_ref_cold
               +9.72%  yatima                [.] lean_alloc_small
               +8.14%  yatima                [.] lean_free_small
               +5.16%  yatima                [.] l_Lean_AssocList_foldlM___at_Lean_ConstMap_childrenOfWith___spec__2___rarg
               +4.86%  yatima                [.] lean::alloc
               +3.56%  yatima                [.] lean_byte_array_push
               +3.43%  yatima                [.] l_List_compareAux___at_ByteArray_instOrdByteArray___spec__1
               +3.19%  yatima                [.] lean_array_to_list
               +3.18%  yatima                [.] lean_name_eq
     4.77%     -3.08%  [unknown]             [k] 0xffffffffa76060d0
               +2.65%  yatima                [.] lean_byte_array_copy_slice
               +2.26%  yatima                [.] lean::dealloc
               +2.18%  yatima                [.] l_Array_zipWithAux___at_Keccak_rho___spec__1
               +2.07%  yatima                [.] l_UnsignedVarInt_toVarIntCore
               +1.73%  yatima                [.] l_List_toByteArray_loop
               +1.36%  yatima                [.] lean_byte_array_data
               +1.28%  yatima                [.] l_ByteArray_append
               +1.12%  yatima                [.] l_Multihash_toBytes
               +1.08%  yatima                [.] l_Array_mapIdxM_map___at_Keccak_chi___spec__1
     2.00%     -1.00%  libleanshared.so      [.] lean_uint64_mix_hash
     0.97%     -0.90%  libleanshared.so      [.] lean_mark_mt
               +0.87%  yatima                [.] lean_array_push
     0.00%     +0.80%  yatima                [.] l_Std_RBNode_ins___at_Yatima_Compiler_addToStore___spec__19
               +0.79%  yatima                [.] l_Std_RBNode_find_x3f___at_Yatima_Compiler_getExprIpld___spec__1
               +0.65%  yatima                [.] l_Std_RBNode_insert___at_Yatima_Compiler_getUnivIpld___spec__2___at_Yatima_Compiler_getUnivIpld___spec__6___lambda__1___boxed
               +0.65%  yatima                [.] l_Cid_toBytes
               +0.60%  yatima                [.] l_Array_foldlMUnsafe_fold___at_Keccak_theta___spec__3
               +0.60%  yatima                [.] l_Std_RBNode_ins___at_Yatima_Compiler_addToStore___spec__14
               +0.50%  yatima                [.] l_Array_foldlMUnsafe_fold___at_Lean_ConstMap_childrenOfWith___spec__5___rarg
     0.63%     +0.46%  libc.so.6             [.] __memmove_avx_unaligned_erms
     0.54%     -0.45%  libleanshared.so      [.] lean_name_eq
</code></pre></div>



<a name="310303601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310303601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310303601">(Nov 15 2022 at 22:19)</a>:</h4>
<p><code>lean_dec_ref_cold</code>, <code>lean_alloc_small</code>, <code>lean_free_small</code>, <code>lean::alloc</code> and <code>lean_byte_array_push</code> seem to be the biggest aggressors</p>



<a name="310304732"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310304732" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310304732">(Nov 15 2022 at 22:28)</a>:</h4>
<p>Was there some big change on the logic behind memory allocation after <code>2022-9-11</code>?</p>



<a name="310305072"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310305072" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310305072">(Nov 15 2022 at 22:30)</a>:</h4>
<p>Because another issue I had involved a stack overflow when running a piece of code that worked just fine before</p>



<a name="310307937"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310307937" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310307937">(Nov 15 2022 at 22:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Performance.20drop/near/310303601">said</a>:</p>
<blockquote>
<p><code>lean_dec_ref_cold</code>, <code>lean_alloc_small</code>, <code>lean_free_small</code>, <code>lean::alloc</code> and <code>lean_byte_array_push</code> seem to be the biggest aggressors</p>
</blockquote>
<p>Those are always likely to be the hottest bits of code. The question is more whether something moved to the front after <code>2022-9-11</code></p>



<a name="310307952"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310307952" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310307952">(Nov 15 2022 at 22:51)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> you might or might not be missing some symbol names. What does the first page of <code>perf report | less</code> output look like?</p>



<a name="310308913"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310308913" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310308913">(Nov 15 2022 at 22:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/Performance.20drop/near/310307952">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> you might or might not be missing some symbol names. What does the first page of <code>perf report | less</code> output look like?</p>
</blockquote>
<p>It just shows a black terminal screen to me</p>



<a name="310309288"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310309288" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310309288">(Nov 15 2022 at 23:02)</a>:</h4>
<p>Uh, <code>perf report --stdio</code>?</p>



<a name="310309934"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310309934" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310309934">(Nov 15 2022 at 23:07)</a>:</h4>
<p>The first lines of <code>perf report</code> on a call that results on a stack overflow:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>Samples: 20K of event 'cycles', Event count (approx.): 20390088657
  Children      Self  Command  Shared Object         Symbol
+    9,44%     9,41%  lake     libleanshared.so      [.] lean_uint64_mix_hash                                                                                                                                     ◆
+    7,01%     6,69%  yatima   yatima                [.] lean_byte_array_push                                                                                                                                     ▒
+    6,31%     6,04%  yatima   yatima                [.] lean_dec_ref_cold                                                                                                                                        ▒
+    4,48%     4,38%  yatima   yatima                [.] lean_alloc_small                                                                                                                                         ▒
+    4,30%     4,22%  yatima   yatima                [.] lean_free_small                                                                                                                                          ▒
+    3,97%     0,03%  lake     libleanshared.so      [.] lean_byte_array_copy_slice                                                                                                                               ▒
+    3,94%     0,00%  lake     libc.so.6             [.] __memcpy_avx_unaligned_erms (inlined)                                                                                                                    ▒
+    3,92%     0,00%  lake     [unknown]             [.] 0xffffffffa8400099                                                                                                                                       ▒
+    3,91%     3,32%  lake     libleanshared.so      [.] lean_dec_ref_cold                                                                                                                                        ▒
+    3,67%     0,00%  lake     [unknown]             [.] 0xffffffffa839821c                                                                                                                                       ▒
+    3,47%     3,42%  yatima   yatima                [.] l_List_toByteArray_loop                                                                                                                                  ▒
+    2,78%     0,29%  yatima   yatima                [.] lean_byte_array_copy_slice                                                                                                                               ▒
+    2,75%     0,00%  lake     [unknown]             [.] 0xffffffffa8400b66                                                                                                                                       ▒
+    2,74%     0,00%  yatima   libc.so.6             [.] __GI___libc_free (inlined)                                                                                                                               ▒
+    2,67%     0,00%  lake     [unknown]             [.] 0xffffffffa839c0d7                                                                                                                                       ▒
+    2,53%     0,00%  yatima   libc.so.6             [.] __memcpy_avx_unaligned_erms (inlined)                                                                                                                    ▒
+    2,50%     0,00%  lake     [unknown]             [.] 0xffffffffa769ea69                                                                                                                                       ▒
+    2,42%     0,01%  lake     [unknown]             [.] 0xffffffffa78fbd88                                                                                                                                       ▒
+    2,39%     2,36%  yatima   yatima                [.] l_List_reverseAux___rarg                                                                                                                                 ▒
+    2,37%     0,00%  yatima   [unknown]             [.] 0xffffffffa8400b66                                                                                                                                       ▒
+    2,31%     0,00%  lake     [unknown]             [.] 0xffffffffa78fb977                                                                                                                                       ▒
+    2,25%     0,00%  yatima   [unknown]             [.] 0xffffffffa839c0d7                                                                                                                                       ▒
+    2,11%     2,04%  yatima   yatima                [.] l_ByteArray_toList_loop                                                                                                                                  ▒
+    2,08%     0,00%  yatima   [unknown]             [.] 0xffffffffa769ea69                                                                                                                                       ▒
+    2,03%     0,00%  lake     [unknown]             [.] 0xffffffffa78f9a1a                                                                                                                                       ▒
+    1,98%     0,38%  yatima   yatima                [.] __gmp_default_allocate                                                                                                                                   ▒
+    1,98%     1,95%  lake     lake                  [.] l_Lake_computeFileHash                                                                                                                                   ▒
+    1,96%     0,00%  yatima   [unknown]             [.] 0xffffffffa78fbd88                                                                                                                                       ▒
+    1,90%     0,18%  yatima   yatima                [.] __gmp_default_reallocate                                                                                                                                 ▒
+    1,84%     0,00%  lake     libc.so.6             [.] __GI__IO_file_xsgetn (inlined)                                                                                                                           ▒
+    1,84%     0,00%  yatima   [unknown]             [.] 0xffffffffa78fb977                                                                                                                                       ▒
+    1,81%     0,02%  lake     libleanshared.so      [.] lean_io_prim_handle_read                                                                                                                                 ▒
+    1,80%     0,00%  lake     libc.so.6             [.] __GI__IO_fread (inlined)                                                                                                                                 ▒
+    1,79%     0,00%  yatima   [unknown]             [.] 0xffffffffa78f9a1a                                                                                                                                       ▒
+    1,78%     1,75%  yatima   yatima                [.] lean::alloc                                                                                                                                              ▒
+    1,74%     1,74%  lake     libc.so.6             [.] __memmove_avx_unaligned_erms                                                                                                                             ▒
+    1,74%     0,00%  lake     libc.so.6             [.] _IO_new_file_underflow (inlined)                                                                                                                         ▒
+    1,74%     0,07%  yatima   yatima                [.] lean::mpz::~mpz                                                                                                                                          ▒
+    1,72%     1,69%  yatima   libc.so.6             [.] _int_free                                                                                                                                                ▒
+    1,71%     0,00%  yatima   libc.so.6             [.] __GI___libc_realloc (inlined)                                                                                                                            ▒
+    1,71%     0,00%  lake     libc.so.6             [.] __GI___libc_read (inlined)                                                                                                                               ▒
+    1,58%     0,00%  yatima   libc.so.6             [.] __GI___libc_malloc (inlined)                                                                                                                             ▒
+    1,57%     1,57%  lake     libleanshared.so      [.] lean_alloc_small                                                                                                                                         ▒
+    1,55%     1,55%  yatima   libc.so.6             [.] malloc
</code></pre></div>



<a name="310310552"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310310552" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310310552">(Nov 15 2022 at 23:12)</a>:</h4>
<p>why are there so many things from <code>lake</code> in this list? Is lake calling yatima or vice versa?</p>



<a name="310310672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310310672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310310672">(Nov 15 2022 at 23:13)</a>:</h4>
<p>It's also definitely missing stack traces, so we don't know what function calls what. Did you build the application you are tracing with <code>moreLeancArgs := #["-UNDEBUG", "-Og", "-ggdb", "-g3", "-fno-omit-frame-pointer"]</code>?</p>



<a name="310311422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310311422" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310311422">(Nov 15 2022 at 23:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Performance.20drop/near/310310552">said</a>:</p>
<blockquote>
<p>why are there so many things from <code>lake</code> in this list? Is lake calling yatima or vice versa?</p>
</blockquote>
<p>I run with <code>lake exe yatima ...</code></p>



<a name="310311459"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310311459" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310311459">(Nov 15 2022 at 23:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span> <a href="#narrow/stream/270676-lean4/topic/Performance.20drop/near/310310672">said</a>:</p>
<blockquote>
<p>It's also definitely missing stack traces, so we don't know what function calls what. Did you build the application you are tracing with <code>moreLeancArgs := #["-UNDEBUG", "-Og", "-ggdb", "-g3", "-fno-omit-frame-pointer"]</code>?</p>
</blockquote>
<p>Nope. Let me do that</p>



<a name="310311731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310311731" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310311731">(Nov 15 2022 at 23:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Performance.20drop/near/310311422">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Performance.20drop/near/310310552">said</a>:</p>
<blockquote>
<p>why are there so many things from <code>lake</code> in this list? Is lake calling yatima or vice versa?</p>
</blockquote>
<p>I run with <code>lake exe yatima ...</code></p>
</blockquote>
<p>I think running <code>perf record (...) build/bin/yatima</code> will give you a cleaner perf report.</p>



<a name="310312183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310312183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310312183">(Nov 15 2022 at 23:25)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">+</span>   <span class="mi">13</span><span class="o">,</span><span class="mi">21</span><span class="bp">%</span>    <span class="mi">12</span><span class="o">,</span><span class="mi">91</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_dec_ref_cold</span>
<span class="bp">+</span>   <span class="mi">11</span><span class="o">,</span><span class="mi">42</span><span class="bp">%</span>    <span class="mi">11</span><span class="o">,</span><span class="mi">14</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_byte_array_push</span>
<span class="bp">+</span>    <span class="mi">8</span><span class="o">,</span><span class="mi">79</span><span class="bp">%</span>     <span class="mi">8</span><span class="o">,</span><span class="mi">78</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_alloc_small</span>
<span class="bp">+</span>    <span class="mi">7</span><span class="o">,</span><span class="mi">91</span><span class="bp">%</span>     <span class="mi">7</span><span class="o">,</span><span class="mi">87</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_free_small</span>
<span class="bp">+</span>    <span class="mi">6</span><span class="o">,</span><span class="mi">92</span><span class="bp">%</span>     <span class="mi">6</span><span class="o">,</span><span class="mi">91</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">l_List_toByteArray_loop</span>
<span class="bp">+</span>    <span class="mi">4</span><span class="o">,</span><span class="mi">72</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">44</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_byte_array_copy_slice</span>
<span class="bp">+</span>    <span class="mi">4</span><span class="o">,</span><span class="mi">68</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__GI___libc_free</span> <span class="o">(</span><span class="n">inlined</span><span class="o">)</span>
<span class="bp">+</span>    <span class="mi">4</span><span class="o">,</span><span class="mi">35</span><span class="bp">%</span>     <span class="mi">4</span><span class="o">,</span><span class="mi">34</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">l_List_reverseAux___rarg</span>
<span class="bp">+</span>    <span class="mi">4</span><span class="o">,</span><span class="mi">34</span><span class="bp">%</span>     <span class="mi">4</span><span class="o">,</span><span class="mi">32</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">l_ByteArray_toList_loop</span>
<span class="bp">+</span>    <span class="mi">4</span><span class="o">,</span><span class="mi">31</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__memcpy_avx_unaligned_erms</span> <span class="o">(</span><span class="n">inlined</span><span class="o">)</span>
<span class="bp">+</span>    <span class="mi">3</span><span class="o">,</span><span class="mi">88</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa8400b66</span>
<span class="bp">+</span>    <span class="mi">3</span><span class="o">,</span><span class="mi">75</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa839c0d7</span>
<span class="bp">+</span>    <span class="mi">3</span><span class="o">,</span><span class="mi">57</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">73</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__gmp_default_allocate</span>
<span class="bp">+</span>    <span class="mi">3</span><span class="o">,</span><span class="mi">52</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa769ea69</span>
<span class="bp">+</span>    <span class="mi">3</span><span class="o">,</span><span class="mi">45</span><span class="bp">%</span>     <span class="mi">3</span><span class="o">,</span><span class="mi">43</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean</span><span class="o">::</span><span class="n">alloc</span>
<span class="bp">+</span>    <span class="mi">3</span><span class="o">,</span><span class="mi">39</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">27</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean</span><span class="o">::</span><span class="n">mpz</span><span class="o">::</span><span class="bp">~</span><span class="n">mpz</span>
<span class="bp">+</span>    <span class="mi">3</span><span class="o">,</span><span class="mi">30</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa78fbd88</span>
<span class="bp">+</span>    <span class="mi">3</span><span class="o">,</span><span class="mi">11</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa78fb977</span>
<span class="bp">+</span>    <span class="mi">3</span><span class="o">,</span><span class="mi">04</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa8400099</span>
<span class="bp">+</span>    <span class="mi">3</span><span class="o">,</span><span class="mi">04</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">32</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__gmp_default_reallocate</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">98</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa78f9a1a</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">86</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__GI___libc_malloc</span> <span class="o">(</span><span class="n">inlined</span><span class="o">)</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">84</span><span class="bp">%</span>     <span class="mi">2</span><span class="o">,</span><span class="mi">84</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">malloc</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">73</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__GI___libc_realloc</span> <span class="o">(</span><span class="n">inlined</span><span class="o">)</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">55</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__GI__IO_file_xsgetn</span> <span class="o">(</span><span class="n">inlined</span><span class="o">)</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">53</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa839821c</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">51</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">_IO_new_file_underflow</span> <span class="o">(</span><span class="n">inlined</span><span class="o">)</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">49</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">02</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean_io_prim_handle_read</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">48</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__GI___libc_read</span> <span class="o">(</span><span class="n">inlined</span><span class="o">)</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">48</span><span class="bp">%</span>     <span class="mi">2</span><span class="o">,</span><span class="mi">45</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">_int_free</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">47</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__GI__IO_fread</span> <span class="o">(</span><span class="n">inlined</span><span class="o">)</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">33</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa791f27e</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">23</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa798d439</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">22</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa798d397</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">11</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa78f5632</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">06</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa798a913</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">03</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa7989f60</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">01</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa7a732cb</span>
<span class="bp">+</span>    <span class="mi">2</span><span class="o">,</span><span class="mi">01</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa78b3575</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">99</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa7940fad</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">96</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">00</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="mi">0xffffffffa791e02d</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">95</span><span class="bp">%</span>     <span class="mi">1</span><span class="o">,</span><span class="mi">95</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="o">[</span><span class="n">unknown</span><span class="o">]</span>         <span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="mi">0xffffffffa7c9e5a7</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">89</span><span class="bp">%</span>     <span class="mi">1</span><span class="o">,</span><span class="mi">89</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">cfree</span><span class="bp">@</span><span class="n">GLIBC_2.2.5</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">78</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">51</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean</span><span class="o">::</span><span class="n">mpz</span><span class="o">::</span><span class="n">mpz</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">74</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">08</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__memset_avx2_unaligned_erms</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">73</span><span class="bp">%</span>     <span class="mi">1</span><span class="o">,</span><span class="mi">73</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">l_UnsignedVarInt_fromVarIntCore</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">70</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">08</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">lean</span><span class="o">::</span><span class="n">lean_alloc_small_cold</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">52</span><span class="bp">%</span>     <span class="mi">0</span><span class="o">,</span><span class="mi">78</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">yatima</span>            <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">l_DagCbor_repeatFor___rarg</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">50</span><span class="bp">%</span>     <span class="mi">1</span><span class="o">,</span><span class="mi">50</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">realloc</span>
<span class="bp">+</span>    <span class="mi">1</span><span class="o">,</span><span class="mi">42</span><span class="bp">%</span>     <span class="mi">1</span><span class="o">,</span><span class="mi">42</span><span class="bp">%</span>  <span class="n">yatima</span>   <span class="n">libc.so.6</span>         <span class="o">[</span><span class="bp">.</span><span class="o">]</span> <span class="n">__memmove_avx_unaligned_erms</span>
</code></pre></div>



<a name="310312658"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310312658" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310312658">(Nov 15 2022 at 23:29)</a>:</h4>
<p>Hm that still doesn't look right. I can give it a go, is it just the version that's in the repo? What command are you benchmarking?</p>



<a name="310312986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310312986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310312986">(Nov 15 2022 at 23:31)</a>:</h4>
<p>All these ByteArray&lt;-&gt;List conversions look super fishy.</p>



<a name="310312999"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310312999" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310312999">(Nov 15 2022 at 23:31)</a>:</h4>
<p><a href="https://github.com/yatima-inc/Ipld.lean/blob/fceb5347c88f122961902e38764bc4010aafd3c1/Ipld/UnsignedVarInt.lean">https://github.com/yatima-inc/Ipld.lean/blob/fceb5347c88f122961902e38764bc4010aafd3c1/Ipld/UnsignedVarInt.lean</a></p>



<a name="310313073"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310313073" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310313073">(Nov 15 2022 at 23:32)</a>:</h4>
<p>This should construct a <code>ByteArray</code> directly.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">fromVarIntCore</span> <span class="o">:</span> <span class="n">Nat</span> <span class="bp">→</span> <span class="n">Nat</span> <span class="bp">→</span> <span class="n">List</span> <span class="n">UInt8</span> <span class="bp">→</span> <span class="n">Nat</span> <span class="bp">→</span> <span class="n">Option</span> <span class="o">(</span><span class="n">Nat</span> <span class="bp">×</span> <span class="n">List</span> <span class="n">UInt8</span><span class="o">)</span>
</code></pre></div>



<a name="310313448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310313448" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310313448">(Nov 15 2022 at 23:35)</a>:</h4>
<p>I'm kind of surprised that we don't have a <code>DecidableEq ByteArray</code> instance yet.  This one allocates two new arrays, which are 8x as large as the byte arrays btw:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">instance</span> <span class="o">:</span> <span class="n">BEq</span> <span class="n">ByteArray</span> <span class="n">where</span>
  <span class="n">beq</span> <span class="n">a</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">a.data</span> <span class="bp">==</span> <span class="n">b.data</span>
</code></pre></div>



<a name="310313674"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310313674" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hanting Zhang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310313674">(Nov 15 2022 at 23:37)</a>:</h4>
<p>Yes, this instance looks fishy to me as well -- shouldn't this be exported to some C function?</p>



<a name="310313760"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310313760" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310313760">(Nov 15 2022 at 23:38)</a>:</h4>
<p>yeah, this looks like a good place to drop in <code>memcmp</code></p>



<a name="310314372"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310314372" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310314372">(Nov 15 2022 at 23:43)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> here is roughly what a perf recording with correct symbol information should look like:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">l_typecheckRun</span>
<span class="bp">|</span>
<span class="bp">|</span><span class="c1">--32.44%--l_Yatima_Typechecker_typecheck</span>
<span class="bp">|</span>          <span class="n">l_Yatima_Converter_extractPureStore</span>
<span class="bp">|</span>          <span class="n">l_Yatima_Converter_ConvertM_run___rarg</span>
<span class="bp">|</span>          <span class="n">lean_apply_2</span>
<span class="bp">|</span>          <span class="n">lean_apply_3</span>
<span class="bp">|</span>          <span class="n">l_Yatima_Converter_convertStore___lambda__1</span>
<span class="bp">|</span>          <span class="bp">|</span>
<span class="bp">|</span>           <span class="c1">--31.92%--l_Std_RBNode_forM___at_Yatima_Converter_convertStore___spec__10</span>
<span class="bp">|</span>                     <span class="bp">|</span>
<span class="bp">|</span>                     <span class="bp">|</span><span class="c1">--31.30%--l_Std_RBNode_forM___at_Yatima_Converter_convertStore___spec__10</span>
<span class="bp">|</span>                     <span class="bp">|</span>          <span class="bp">|</span>
<span class="bp">|</span>                     <span class="bp">|</span>          <span class="bp">|</span><span class="c1">--26.74%--l_Std_RBNode_forM___at_Yatima_Converter_convertStore___spec__10</span>
<span class="bp">|</span>                     <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>
<span class="bp">|</span>                     <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span><span class="c1">--18.33%--l_Std_RBNode_forM___at_Yatima_Converter_convertStore___spec__10</span>
<span class="bp">|</span>                     <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>
<span class="bp">|</span>                     <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span><span class="c1">--13.97%--l_Std_RBNode_forM___at_Yatima_Converter_convertStore___spec__10</span>
<span class="bp">|</span>                     <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>
<span class="bp">|</span>                     <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span>          <span class="bp">|</span><span class="c1">--7.57%--l_Std_RBNode_forM___at_Yatima_Converter_convertStore___spec__10</span>
</code></pre></div>
<p>I got this with</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="n">moreLeancArgs</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="s2">"-UNDEBUG"</span><span class="o">,</span> <span class="s2">"-Og"</span><span class="o">,</span> <span class="s2">"-ggdb"</span><span class="o">,</span> <span class="s2">"-g3"</span><span class="o">,</span> <span class="s2">"-fno-omit-frame-pointer"</span><span class="o">]</span>
  <span class="n">moreLinkArgs</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span>
    <span class="s2">"-fuse-ld=ld"</span><span class="o">,</span>
    <span class="s2">"-L/home/$THEUSER/.elan/toolchains/leanprover--lean4---nightly-2022-10-27/lib"</span>
  <span class="o">]</span>
</code></pre></div>
<p>(some of these flags are likely unnecessary but I don't remember which, so I just include all :) )</p>



<a name="310314495"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310314495" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hanting Zhang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310314495">(Nov 15 2022 at 23:44)</a>:</h4>
<p>(arthur has to go so I'll be looking at this now. but also I'm on WSL2 so <code>perf</code> doesn't really work)</p>



<a name="310315060"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310315060" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hanting Zhang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310315060">(Nov 15 2022 at 23:49)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="128280">@Wojciech Nawrocki</span>, how should I read this output? It looks like we're spending a lot of time in <code>l_Std_RBNode_forM___at_Yatima_Converter_convertStore___spec__10</code>?</p>



<a name="310315413"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310315413" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310315413">(Nov 15 2022 at 23:53)</a>:</h4>
<blockquote>
<p>but also I'm on WSL2 so perf doesn't really work</p>
</blockquote>
<p><code>perf</code> should work well enough on WSL2 (only the performance counters are broken).  You just need to install the tools for the wrong linux version:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">linux</span><span class="bp">-</span><span class="n">tools</span><span class="bp">-</span><span class="mi">5</span><span class="bp">.</span><span class="mi">15</span><span class="bp">.</span><span class="mi">0</span><span class="bp">-</span><span class="mi">53</span><span class="bp">-</span><span class="n">generic</span>
<span class="bp">/</span><span class="n">usr</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">linux</span><span class="bp">-</span><span class="n">tools</span><span class="bp">/</span><span class="mi">5</span><span class="bp">.</span><span class="mi">15</span><span class="bp">.</span><span class="mi">0</span><span class="bp">-</span><span class="mi">53</span><span class="bp">-</span><span class="n">generic</span><span class="bp">/</span><span class="n">perf</span> <span class="bp">...</span>
</code></pre></div>



<a name="310318168"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310318168" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310318168">(Nov 16 2022 at 00:19)</a>:</h4>
<p>There are some clear improvements we can make on our side, but I still don't understand the performance drop.<br>
<span class="user-mention" data-user-id="128280">@Wojciech Nawrocki</span> to reproduce the issue, you can <code>lake exe yatima compile Fixtures/Transpilation/Demo.lean</code> (but you need to open it on VSCode first so it generates the olean file). This command will generate an <code>output.ir</code>. This call, alone, used to take 20s on my machine and now it takes 50s.</p>
<p>To reproduce the overflow (which might not happen on your machine if you have too much memory available), do <code>lake exe yatima typecheck output.ir</code></p>



<a name="310318529"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310318529" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hanting Zhang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310318529">(Nov 16 2022 at 00:23)</a>:</h4>
<p>(deleted)</p>



<a name="310319132"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310319132" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310319132">(Nov 16 2022 at 00:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="355764">Hanting Zhang</span> <a href="#narrow/stream/270676-lean4/topic/Performance.20drop/near/310315060">said</a>:</p>
<blockquote>
<p>Hi <span class="user-mention silent" data-user-id="128280">Wojciech Nawrocki</span>, how should I read this output? It looks like we're spending a lot of time in <code>l_Std_RBNode_forM___at_Yatima_Converter_convertStore___spec__10</code>?</p>
</blockquote>
<p>I didn't make it very clear, sorry. The only point of including that example output was to demonstrate that it has indents where <code>typecheck</code> calls <code>convertStore</code> calls .. , whereas the output Arthur seems to have been getting was entirely flat. If you get the flatness, it usually means the recording is missing symbol information so you don't know which function in your code is calling <code>lean_dec_ref_cold</code> a lot and (perhaps!) resulting in the slowdown.</p>



<a name="310353216"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310353216" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310353216">(Nov 16 2022 at 07:42)</a>:</h4>
<p>Thanks everyone for the pointers!<br>
Apparently the root cause for the slowdown was the expansion for the RBMap API, which contains less partial functions and whose compilation will trigger the compilation of many other constants.</p>
<p>I will work on other improvements mentioned above <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span>🏼</p>



<a name="310355691"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310355691" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310355691">(Nov 16 2022 at 08:03)</a>:</h4>
<p>I'm unclear on the issue here. Is it a regression in the Std RBMap API relative to before / to lean?</p>



<a name="310355780"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310355780" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310355780">(Nov 16 2022 at 08:04)</a>:</h4>
<p>I don't see why fewer <code>partial</code> functions would affect anything other than compile time</p>



<a name="310356895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310356895" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hanting Zhang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310356895">(Nov 16 2022 at 08:13)</a>:</h4>
<p>We are compiling the lean environment into a Yatima one, so since RBMap depended on more constants our process was expectedly slower</p>



<a name="310357648"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310357648" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310357648">(Nov 16 2022 at 08:18)</a>:</h4>
<p>oh I see, it's like the lean self-test benchmark where compile time <em>is</em> the test</p>



<a name="310359364"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Performance%20drop/near/310359364" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Performance.20drop.html#310359364">(Nov 16 2022 at 08:31)</a>:</h4>
<p>Sorry, I wasn't clear enough when I said "compile"</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>