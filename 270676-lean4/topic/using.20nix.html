---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/using.20nix.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html">using nix</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="221657305"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221657305" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Edward Ayers <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221657305">(Jan 05 2021 at 15:14)</a>:</h4>
<p>Hi I just wanted to report my experience using nix.<br>
I followed this link <a href="https://leanprover.github.io/lean4/doc/setup.html#nix-setup">https://leanprover.github.io/lean4/doc/setup.html#nix-setup</a></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>curl -L https://nixos.org/nix/install <span class="p">|</span> sh
nix-shell https://github.com/leanprover/lean4/archive/master.tar.gz -A nix
nix flake new my-first-lean4-package -t github:leanprover/lean4
<span class="nb">cd</span> my-first-lean4-package
nix build
</code></pre></div>
<p>It took about 30 mins to build.<br>
The build procedure seems to be building a load of CXX code.<br>
I got loads of warnings, I am not sure if I should be concerned.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">warning</span><span class="o">:</span> <span class="c1">--- Invalid path signature ------------------------------------------------------------------ nix</span>
<span class="n">substituter</span> <span class="bp">'</span><span class="n">https</span><span class="o">:</span><span class="bp">//</span><span class="n">lean4.cachix.org'</span> <span class="n">does</span> <span class="n">not</span> <span class="k">have</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">signature</span> <span class="n">for</span> <span class="n">path</span> <span class="bp">'/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">bjnk91prlnvzhsvbk2sbsp5f1484bkbh</span><span class="bp">-</span><span class="n">Lean.ReducibilityAttrs'</span>
</code></pre></div>



<a name="221658141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221658141" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Edward Ayers <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221658141">(Jan 05 2021 at 15:20)</a>:</h4>
<p>This fails for me: what am I missing?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">nix</span><span class="bp">-</span><span class="n">shell</span><span class="o">:</span><span class="bp">~/</span><span class="n">mylean4pkg</span><span class="o">]</span><span class="bp">$</span> <span class="n">nix</span> <span class="n">build</span> <span class="bp">.#</span><span class="n">executable</span>
<span class="n">error</span><span class="o">:</span> <span class="c1">--- Error --------------------- nix</span>
<span class="n">flake</span> <span class="n">output</span> <span class="kn">attribute</span> <span class="bp">'</span><span class="n">packages.x86_64</span><span class="bp">-</span><span class="n">linux.executable'</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">derivation</span>
</code></pre></div>



<a name="221658369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221658369" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221658369">(Jan 05 2021 at 15:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="121918">Edward Ayers</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/221657305">said</a>:</p>
<blockquote>
<p>I got loads of warnings, I am not sure if I should be concerned.</p>
</blockquote>
<p>This is definitely the reason it built from source. Did you also do the <code>/etc/nix/nix.conf</code> steps? (Perhaps "recommended" is not strong enough there)</p>



<a name="221658601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221658601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221658601">(Jan 05 2021 at 15:24)</a>:</h4>
<p>It's probably the biggest weakness in the current setup. It looks like Nix will soon allow setting these options per project ("flake"), but that hasn't landed on master yet. And it will probably require using an unstable Nix <em>daemon</em> (and not just a client like opening that <code>nix-shell</code> does), so not exactly easier to set up either...</p>



<a name="221659091"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221659091" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221659091">(Jan 05 2021 at 15:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="121918">Edward Ayers</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/221658141">said</a>:</p>
<blockquote>
<p>This fails for me: what am I missing?</p>
<p><div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">nix</span><span class="bp">-</span><span class="n">shell</span><span class="o">:</span><span class="bp">~/</span><span class="n">mylean4pkg</span><span class="o">]</span><span class="bp">$</span> <span class="n">nix</span> <span class="n">build</span> <span class="bp">.#</span><span class="n">executable</span>
<span class="n">error</span><span class="o">:</span> <span class="c1">--- Error --------------------- nix</span>
<span class="n">flake</span> <span class="n">output</span> <span class="kn">attribute</span> <span class="bp">'</span><span class="n">packages.x86_64</span><span class="bp">-</span><span class="n">linux.executable'</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">derivation</span>
</code></pre></div><br>
</p>
</blockquote>
<p>Oh, I guess I didn't actually test that step... <code>executable</code> actually is a function right now that takes the filename to produce since I wanted the <code>Leanpkg</code> package to produce a <code>leanpkg</code> executable. Looks like there is in fact a <code>lib.toLower</code> function, so maybe I should just use that one (as a default).</p>



<a name="221659827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221659827" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Edward Ayers <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221659827">(Jan 05 2021 at 15:34)</a>:</h4>
<p>Nice I added the config and it's downloading woop</p>



<a name="221660436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221660436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221660436">(Jan 05 2021 at 15:39)</a>:</h4>
<p>Changed <code>executable</code>, thanks for giving it a try!</p>



<a name="221661672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221661672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221661672">(Jan 05 2021 at 15:48)</a>:</h4>
<p>And now it seems to actually work</p>



<a name="221669892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221669892" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221669892">(Jan 05 2021 at 16:46)</a>:</h4>
<p>When I try to execute the resulting binary I get the <code>--help</code> output of Lean:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">nix</span><span class="bp">-</span><span class="n">shell</span><span class="o">:</span><span class="bp">~/</span><span class="n">my</span><span class="bp">-</span><span class="n">first</span><span class="bp">-</span><span class="n">lean4</span><span class="bp">-</span><span class="n">package</span><span class="bp">/</span><span class="n">result</span><span class="bp">/</span><span class="n">bin</span><span class="o">]</span><span class="bp">$</span> <span class="bp">./</span><span class="n">mypackage</span>
<span class="n">Expected</span> <span class="n">exactly</span> <span class="n">one</span> <span class="n">file</span> <span class="n">name</span>
<span class="n">Lean</span> <span class="o">(</span><span class="n">version</span> <span class="mi">4</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">0</span><span class="o">,</span> <span class="n">Release</span><span class="o">)</span>
<span class="n">Miscellaneous</span><span class="o">:</span>
  <span class="c1">--help -h          display this message</span>
  <span class="c1">--version -v       display version number</span>
  <span class="c1">--githash          display the git commit hash number used to build this binary</span>
  <span class="c1">--run              executes the 'main' definition</span>
  <span class="c1">--o=oname -o        create olean file</span>
  <span class="c1">--c=fname -c       name of the C output file</span>
  <span class="c1">--stdin            take input from stdin</span>
  <span class="c1">--root=dir         set package root directory from which the module name of the input file is calculated</span>
                     <span class="o">(</span><span class="n">default</span><span class="o">:</span> <span class="n">current</span> <span class="n">working</span> <span class="n">directory</span><span class="o">)</span>
  <span class="c1">--trust=num -t     trust level (default: max) 0 means do not trust any macro,</span>
                     <span class="n">and</span> <span class="n">type</span> <span class="n">check</span> <span class="n">all</span> <span class="n">imported</span> <span class="n">modules</span>
  <span class="c1">--quiet -q         do not print verbose messages</span>
  <span class="c1">--memory=num -M    maximum amount of memory that should be used by Lean</span>
                     <span class="o">(</span><span class="k">in</span> <span class="n">megabytes</span><span class="o">)</span>
  <span class="c1">--timeout=num -T   maximum number of memory allocations per task</span>
                     <span class="n">this</span> <span class="n">is</span> <span class="n">a</span> <span class="n">deterministic</span> <span class="n">way</span> <span class="n">of</span> <span class="n">interrupting</span> <span class="n">long</span> <span class="n">running</span> <span class="n">tasks</span>
  <span class="c1">--threads=num -j   number of threads used to process lean files</span>
  <span class="c1">--tstack=num -s    thread stack size in Kb</span>
  <span class="c1">--plugin=file      load and initialize shared library for registering linters etc.</span>
  <span class="c1">--deps             just print dependencies of a Lean input</span>
  <span class="c1">--json             print JSON-formatted structured error messages</span>
  <span class="c1">--server           start lean in server mode</span>
  <span class="c1">--worker           start lean in server-worker mode</span>
  <span class="c1">--profile          display elaboration/type checking time for each definition/theorem</span>
  <span class="c1">--stats            display environment statistics</span>
  <span class="bp">-</span><span class="n">D</span> <span class="n">name</span><span class="bp">=</span><span class="n">value</span>      <span class="n">set</span> <span class="n">a</span> <span class="n">configuration</span> <span class="n">option</span> <span class="o">(</span><span class="n">see</span> <span class="kd">set_option</span> <span class="n">command</span><span class="o">)</span>
</code></pre></div>



<a name="221670024"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221670024" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221670024">(Jan 05 2021 at 16:47)</a>:</h4>
<p>that's what <code>lean</code> does!</p>



<a name="221670064"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221670064" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221670064">(Jan 05 2021 at 16:47)</a>:</h4>
<p>unlike lean 3</p>



<a name="221670104"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221670104" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221670104">(Jan 05 2021 at 16:47)</a>:</h4>
<p>But I compile a <code>.lean</code> file that does <code>#eval "hello world"</code></p>



<a name="221670207"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221670207" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221670207">(Jan 05 2021 at 16:48)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">nix</span><span class="bp">-</span><span class="n">shell</span><span class="o">:</span><span class="bp">~/</span><span class="n">my</span><span class="bp">-</span><span class="n">first</span><span class="bp">-</span><span class="n">lean4</span><span class="bp">-</span><span class="n">package</span><span class="o">]</span><span class="bp">$</span> <span class="n">cat</span> <span class="n">MyPackage.lean</span>
<span class="k">#eval</span> <span class="s2">"Hello, world!"</span>
</code></pre></div>



<a name="221670209"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221670209" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221670209">(Jan 05 2021 at 16:48)</a>:</h4>
<p>oh I see, I don't know anything about Nix, but it looks like you managed to produce a Lean executable instead</p>



<a name="221670252"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221670252" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221670252">(Jan 05 2021 at 16:48)</a>:</h4>
<p>You're missing a <code>main</code> function</p>



<a name="221670420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221670420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221670420">(Jan 05 2021 at 16:50)</a>:</h4>
<p>You're right that fixes it</p>



<a name="221670493"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221670493" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221670493">(Jan 05 2021 at 16:50)</a>:</h4>
<p>I don't understand what the behavior of the compiler is supposed to be when it tries to produce a binary but doesn't find a <code>main</code> function</p>



<a name="221671591"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221671591" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221671591">(Jan 05 2021 at 16:58)</a>:</h4>
<p>Well, there's another <code>main</code> function in <code>leancpp.so</code> :) . This is just a hack in the Nix setup so I don't have to "switch" between C++ and Lean multiple times.</p>



<a name="221671811"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221671811" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221671811">(Jan 05 2021 at 17:00)</a>:</h4>
<p>Oh! Does the binary always have the whole Lean prover compiled in with the rest of its functions?</p>



<a name="221672546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221672546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221672546">(Jan 05 2021 at 17:05)</a>:</h4>
<p>Hopefully your binary is not in fact as big as <code>lean</code> after adding a <code>main</code> function</p>



<a name="221811402"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221811402" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221811402">(Jan 06 2021 at 19:31)</a>:</h4>
<p>Hi,<br>
does the nix configuration currently support linking lean packages against static library dependencies? E.g. if I have a package</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "test_impl"]</span>
<span class="kd">def</span> <span class="n">test</span> <span class="o">(</span><span class="n">n</span><span class="o">:</span> <span class="n">UInt32</span><span class="o">)</span> <span class="o">:</span> <span class="n">UInt32</span> <span class="o">:=</span> <span class="n">n</span>
</code></pre></div>
<p>and a static library exporting a symbol <code>test_impl</code>, can I just pass it as a dep to <code>leanPkgs.buildLeanPackage</code>?</p>



<a name="221811857"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221811857" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221811857">(Jan 06 2021 at 19:35)</a>:</h4>
<p>Not yet because no-one has tried that even without Nix so far! We should probably add an argument injected here: <a href="https://github.com/leanprover/lean4/blob/master/nix/buildLeanPackage.nix#L136">https://github.com/leanprover/lean4/blob/master/nix/buildLeanPackage.nix#L136</a></p>



<a name="221812247"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221812247" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221812247">(Jan 06 2021 at 19:37)</a>:</h4>
<p>I'm not sure what the proper Nix way here is though. For example, if a Lean library declares an external dependency, any executable depending on the library should inherit the dependency.</p>



<a name="221812426"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221812426" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221812426">(Jan 06 2021 at 19:39)</a>:</h4>
<p>thanks, I’ll take a look later tonight. I also tried to write a custom deriver by reverse-engineering what the compiler does, and also got stuck in the linking stage, probably because of the same issue</p>



<a name="221812502"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221812502" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221812502">(Jan 06 2021 at 19:40)</a>:</h4>
<p>It doesn't help that there is no real Nix infrastructure for C, probably because they assume you're already using some other build system like CMake that will take care of assembling the linker flags etc.</p>



<a name="221813872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221813872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221813872">(Jan 06 2021 at 19:52)</a>:</h4>
<p>Are you guys open to PRs in infrastructure code like this, or should I just post stuff here if I find something I believe is useful?</p>



<a name="221814183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221814183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221814183">(Jan 06 2021 at 19:54)</a>:</h4>
<p>(btw, here's one small patch I'm using to make the <code>lean</code> binary available when in the nix shell:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">diff</span> <span class="c1">--git a/shell.nix b/shell.nix</span>
<span class="n">index</span> <span class="n">a0ecd9eeae..18cd9ea056</span> <span class="mi">100644</span>
<span class="c1">--- a/shell.nix</span>
<span class="bp">+++</span> <span class="n">b</span><span class="bp">/</span><span class="n">shell.nix</span>
<span class="bp">@@</span> <span class="bp">-</span><span class="mi">16</span><span class="o">,</span><span class="mi">6</span> <span class="bp">+</span><span class="mi">16</span><span class="o">,</span><span class="mi">6</span> <span class="bp">@@</span> <span class="k">in</span> <span class="o">{</span> <span class="n">pkgs</span> <span class="bp">?</span> <span class="n">flakePkgs.nixpkgs</span><span class="o">,</span> <span class="n">llvmPackages</span> <span class="bp">?</span> <span class="n">null</span> <span class="o">}:</span>
     <span class="n">CTEST_OUTPUT_ON_FAILURE</span> <span class="bp">=</span> <span class="mi">1</span><span class="bp">;</span>
   <span class="o">}</span><span class="bp">;</span>
   <span class="n">nix</span> <span class="bp">=</span> <span class="n">pkgs.mkShell</span> <span class="o">{</span>
<span class="bp">-</span>    <span class="n">buildInputs</span> <span class="bp">=</span> <span class="o">[</span> <span class="n">flakePkgs.nix</span> <span class="o">]</span><span class="bp">;</span>
<span class="bp">+</span>    <span class="n">buildInputs</span> <span class="bp">=</span> <span class="o">[</span> <span class="n">flakePkgs.nix</span> <span class="n">flakePkgs.lean</span> <span class="o">]</span><span class="bp">;</span>
   <span class="o">}</span><span class="bp">;</span>
 <span class="o">}</span>
</code></pre></div>
<p>this, together with <a href="https://marketplace.visualstudio.com/items?itemName=arrterian.nix-env-selector">https://marketplace.visualstudio.com/items?itemName=arrterian.nix-env-selector</a> , makes it easier to run my own version of vscode with a modified lean4 extension)</p>



<a name="221814379"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221814379" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221814379">(Jan 06 2021 at 19:56)</a>:</h4>
<p><span class="user-mention" data-user-id="130439">@Zygimantas Straznickas</span> Can you elaborate on what this does? If I wanted to use it with emacs, can I use the same thing?</p>



<a name="221815779"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221815779" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221815779">(Jan 06 2021 at 20:05)</a>:</h4>
<p>IIUC it does some magic symlinking to , effectively, add <code>/nix/store/randomchanginghash-lean/bin</code> to PATH within the nix shell so <code>lean</code> can be used from the terminal as <code>lean</code>.  I assume this will also work with emacs if you start it from a nix shell or use something like <code>https://github.com/nix-community/nix-direnv</code>.</p>
<p>(this addresses the problem of having a way to refer to the <code>lean</code> binary. I'm not sure how the emacs mode works, this might not even be a problem in the first place :) )</p>
<p>Though I'm still stuck at making VSCode+ext+lean_server to recognize custom lean package dependencies defined through nix: e.g., in <code>MyPackage2</code> it succeeds at <code>import Lean.&lt;...&gt;</code>, but errors out on <code>import MyPackage1</code>, even though <code>nix build</code> successfully builds MyPackage2</p>



<a name="221816308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221816308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221816308">(Jan 06 2021 at 20:09)</a>:</h4>
<p>Thanks for the pointer! That's actually the issue I'm trying to solve now. I'm going to do some reading and play around a bit with this.</p>



<a name="221816385"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221816385" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221816385">(Jan 06 2021 at 20:10)</a>:</h4>
<p>I hope your project works out. It sounds like the kind of stuff I'd like to use</p>



<a name="221816675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221816675" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221816675">(Jan 06 2021 at 20:12)</a>:</h4>
<p>Right, for the editor you'll want to have <code>.#lean-dev</code> (output of a flake using the template) in the path, which is a <code>lean</code> wrapper that does the automatic compilation and importing of package-local depdencencies</p>



<a name="221816734"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221816734" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221816734">(Jan 06 2021 at 20:12)</a>:</h4>
<p>The bare <code>lean</code>, as you've observed, only knows its stdlib</p>



<a name="221816769"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221816769" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221816769">(Jan 06 2021 at 20:13)</a>:</h4>
<p>So <code>flakePkgs.lean-dev</code> should work, I think</p>



<a name="221816807"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221816807" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221816807">(Jan 06 2021 at 20:13)</a>:</h4>
<p>Thanks for pointing it out. How do I find out what the path of <code>.#lean-dev</code> is?</p>



<a name="221816850"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221816850" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221816850">(Jan 06 2021 at 20:13)</a>:</h4>
<p>In the Nix store?</p>



<a name="221816904"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221816904" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221816904">(Jan 06 2021 at 20:13)</a>:</h4>
<p>I'm not familiar enough with Nix to know what that means</p>



<a name="221817222"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221817222" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221817222">(Jan 06 2021 at 20:16)</a>:</h4>
<p>Then I don't know what your question is :) . If you do not want to go the nix-env-selector way, you can create a link to the executable using <code>nix build .#lean-dev -o ./lean-dev</code>. But that way you'll have to remember updating that link when the package's Lean version has changed yourself.</p>



<a name="221817786"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221817786" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221817786">(Jan 06 2021 at 20:20)</a>:</h4>
<p>Basically, at the point where I am with setting up emacs, I need to set up the <code>PATH</code> environment variables and the <code>lean4-rootdir</code> Emacs variable so that <code>lean4</code> (the binary) and its libraries can be found by the language server</p>



<a name="221817983"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221817983" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221817983">(Jan 06 2021 at 20:22)</a>:</h4>
<p>Yes, that should get you there. With the mentioned caveat.</p>



<a name="221818354"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221818354" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221818354">(Jan 06 2021 at 20:25)</a>:</h4>
<p>Thanks!</p>



<a name="221818407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221818407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221818407">(Jan 06 2021 at 20:25)</a>:</h4>
<p>Where can I find out how <code>nix-env-selector</code> works?</p>



<a name="221818416"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221818416" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221818416">(Jan 06 2021 at 20:25)</a>:</h4>
<p>(Note that the <code>lean-dev</code> setup might change soon)</p>



<a name="221820310"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221820310" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221820310">(Jan 06 2021 at 20:40)</a>:</h4>
<p>aha, <code>lean-dev</code> works, thanks! IDE setup complete <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span></p>



<a name="221820550"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221820550" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221820550">(Jan 06 2021 at 20:42)</a>:</h4>
<p>I can't help reading <code>.#foo</code> as an emacs backup file and I want to delete it <span aria-label="trash can" class="emoji emoji-1f5d1" role="img" title="trash can">:trash_can:</span></p>



<a name="221820789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221820789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221820789">(Jan 06 2021 at 20:44)</a>:</h4>
<p><span class="user-mention" data-user-id="130439">@Zygimantas Straznickas</span> Super! Would you mind walking me through what you did? In particular, how do you install the version of Lean where you patched <code>shell.nix</code>?</p>



<a name="221821136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221821136" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221821136">(Jan 06 2021 at 20:47)</a>:</h4>
<p><span class="user-mention" data-user-id="110032">@Reid Barton</span>  I had to specifically patch the <code>sh</code> highlighter used in the docs to not interpret <code>#</code> without leading whitespace as a comment... <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="221823690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221823690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221823690">(Jan 06 2021 at 21:06)</a>:</h4>
<p><span class="user-mention" data-user-id="110026">@Simon Hudon</span> </p>
<p>Sure, so,<br>
1) since you want to patch <code>shell.nix</code>, you'll probably want to clone the lean4 code somewhere on your machine<br>
2) update <code>shell.nix</code> to expose <code>lean-dev</code>: in line 19, add  <code>flakePkgs.lean-dev</code> to the array<br>
3) enter the nix shell: <code>nix-shell &lt;lean4_dir&gt; -A nix</code><br>
4) type <code>lean</code> into the shell and confirm that you get lean's help output<br>
5) type <code>which lean</code> into the shell and confirm the first line starts with <code>/nix/store/</code></p>
<p>(I don't fully understand how nix and flakes interplay, so sometimes I get a problem with nix complaining about mismatching dependency hashes, and fix it by a dumb sledgehammer approach of deleting all of my <code>flake.lock</code> files and rebuilding everything. I should really learn more about what that problem actually means :) )</p>
<p>6) Now we're in emacs territory so I haven't tested that but my guess would be to either <br>
6.1) Just start your global emacs from the nix shell command line and see if lean support works out of the box, without specifying a custom lean4-executable-name or lean4-rootdir <br>
6.2) If that doesn't work, emacs doesn't inherit PATH and does something smarter, and I don't know anything about that :) The same applies if you want to start emacs from a desktop shortcut, or if you run an emacs daemon.</p>



<a name="221823912"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221823912" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221823912">(Jan 06 2021 at 21:09)</a>:</h4>
<p>btw, for context, one reason I'm going through all this trouble for VSCode is that I'm using WSL, and I can't use the nix-built vscode version because that would try to open a graphical app in WSL and fail. Instead, Microsoft has this convenient bridge that connects my Windows VSCode with a backend running in WSL.</p>



<a name="221824366"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221824366" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Simon Hudon <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221824366">(Jan 06 2021 at 21:13)</a>:</h4>
<p>Thank you so much for the detailed instructions! I need to run but I'll test them later tonight</p>



<a name="221955895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/221955895" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#221955895">(Jan 07 2021 at 15:33)</a>:</h4>
<p>FYI, I just looked up the closures sizes of Lean itself/+ Emacs/+ VS Code using Nix, meaning the cumulative size of all dependencies down to glibc. In other words, what you would have to download if those exact versions are not already in your Nix store.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ nix path-info -Sh .#lean
/nix/store/s1cmjry080s7ilv3h8axj9rl4jra7jl8-lean       <span class="m">1</span>.5G
$ nix path-info -Sh .#emacs-package
/nix/store/bj514l0pag981zbs75xflc11i2c797q2-emacs-package      <span class="m">2</span>.6G
$ nix path-info -Sh .#vscode-package
/nix/store/cknca6rnm2z2p6j4q593p3fdk80dgf0m-vscode-package     <span class="m">2</span>.2G
</code></pre></div>
<p>A full <code>1.0GB</code> of that is <code>clang</code>, which ideally we would only download when someone actually wants to compile a Lean package into a binary. /cc <span class="user-mention" data-user-id="375364">@Makarius Wenzel</span></p>



<a name="222028868"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/222028868" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#222028868">(Jan 08 2021 at 02:48)</a>:</h4>
<p>Alright, I now have static libraries linking successfully. My next goal: set up nix  so that <code>initialize test_symbol : IO.Ref (String) ← IO.mkRef "Asdf"</code>defined in external package A would be visible in external package B.</p>



<a name="222081856"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/222081856" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#222081856">(Jan 08 2021 at 15:01)</a>:</h4>
<p>I'm trying to set up nix on my machine. For the <code>/etc/nix/nix.conf</code> step that <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> mentioned above, is it necessary to put the config file in <code>/etc</code> or can I use a non-privileged folder (e.g. some file in <code>$HOME/.nix-profile/</code>)?</p>



<a name="222082224"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/222082224" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#222082224">(Jan 08 2021 at 15:04)</a>:</h4>
<p>Actually it seems that <code>$HOME/.config/nix/nix.conf</code> might work?</p>



<a name="222086659"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/222086659" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#222086659">(Jan 08 2021 at 15:41)</a>:</h4>
<p>There's another silly issue that I came across, just in case someone else has this issue: I had a problem where the backspace key in the nix-shell would create a space instead of deleting the character. Has anyone else come across this? </p>
<p>This seems like a terminal specific issue, since setting <code>$TERM</code>to be e.g. <code>xterm</code> before running <code>nix-shell</code> fixes the problem (whereas my default <code>$TERM</code> is <code>rxvt-unicode-256color</code>).</p>



<a name="222091068"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/222091068" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#222091068">(Jan 08 2021 at 16:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="243562">Adam Topaz</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/222081856">said</a>:</p>
<blockquote>
<p>I'm trying to set up nix on my machine. For the <code>/etc/nix/nix.conf</code> step that <span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> mentioned above, is it necessary to put the config file in <code>/etc</code> or can I use a non-privileged folder (e.g. some file in <code>$HOME/.nix-profile/</code>)?</p>
</blockquote>
<p>If you're using a multi-user installation of Nix (the default), your Nix daemon will run as <code>root</code> and as such accept privileged options like <code>trusted-substituters</code> only from privileged locations</p>



<a name="222091659"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/222091659" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#222091659">(Jan 08 2021 at 16:17)</a>:</h4>
<p>I see. Thanks.</p>



<a name="222192198"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/222192198" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#222192198">(Jan 09 2021 at 22:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/221955895">said</a>:</p>
<blockquote>
<p>A full <code>1.0GB</code> of that is <code>clang</code>, which ideally we would only download when someone actually wants to compile a Lean package into a binary. /cc <span class="user-mention silent" data-user-id="375364">Makarius Wenzel</span></p>
</blockquote>
<p>This is now the case with <a href="https://github.com/leanprover/lean4/pull/256">https://github.com/leanprover/lean4/pull/256</a>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="n">nix</span> <span class="n">path</span><span class="bp">-</span><span class="n">info</span> <span class="bp">-</span><span class="n">Sh</span> <span class="bp">.</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">zyzyfm2c8n1rj7mh8f8x2kn32668q389</span><span class="bp">-</span><span class="n">lean</span>     <span class="mi">362</span><span class="bp">.</span><span class="mi">6</span><span class="n">M</span>
</code></pre></div>



<a name="222232829"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/222232829" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#222232829">(Jan 10 2021 at 17:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/221671591">said</a>:</p>
<blockquote>
<p>Well, there's another <code>main</code> function in <code>leancpp.so</code> :) . This is just a hack in the Nix setup so I don't have to "switch" between C++ and Lean multiple times.</p>
</blockquote>
<p>fixed</p>



<a name="224061586"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/224061586" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Cyril Cohen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#224061586">(Jan 26 2021 at 16:09)</a>:</h4>
<p>I had to deactivate flakes this week cf <a href="https://discourse.nixos.org/t/nix-shell-assertion-request-expectedetag-res-etag-failed/11119/9">https://discourse.nixos.org/t/nix-shell-assertion-request-expectedetag-res-etag-failed/11119/9</a> <br>
Is it  still possible for me to run  lean4 on nix?</p>



<a name="224062678"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/224062678" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#224062678">(Jan 26 2021 at 16:15)</a>:</h4>
<p>I didn't encounter this issue inside the Lean-Nix shell yet (only outside with my system Nix that is on another version), but now that a fixed version of Nix should be on Hydra, I can update the shell. Assuming that this issue is client-side, not daemon-side.</p>



<a name="224065349"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/224065349" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#224065349">(Jan 26 2021 at 16:33)</a>:</h4>
<p><span class="user-mention" data-user-id="110193">@Cyril Cohen</span> Re-reading your question, <em>are</em> you using a Lean shell as in <a href="https://leanprover.github.io/lean4/doc/setup.html#nix-setup">https://leanprover.github.io/lean4/doc/setup.html#nix-setup</a>? You do not have to enable flakes system-wide to use the Lean Nix setup.</p>



<a name="224066751"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/224066751" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Cyril Cohen <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#224066751">(Jan 26 2021 at 16:42)</a>:</h4>
<p>Oh thanks, since I had flakes until yesterday, I did not even notice you had a compatibiliy layer with legacy shells. Thanks</p>



<a name="224069598"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/224069598" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#224069598">(Jan 26 2021 at 17:02)</a>:</h4>
<p>I updated our pinned Nix version just to be safe</p>



<a name="224069857"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/224069857" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#224069857">(Jan 26 2021 at 17:03)</a>:</h4>
<p>The good news is that I hope to simplify the setup on Linux soon :) <a href="https://twitter.com/derKha/status/1354013281812410369">https://twitter.com/derKha/status/1354013281812410369</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/derKha/status/1354013281812410369"><img class="twitter-avatar" src="https://pbs.twimg.com/profile_images/1291333830113206273/Owxrf3il_normal.jpg"></a><p>Looks like we could drastically simplify the Lean 4 Nix setup now <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span> <a href="https://t.co/9qWMDudA9z">https://twitter.com/derKha/status/1354013281812410369/photo/1</a></p><span>- Sebastian Ullrich (@derKha)</span><div class="twitter-image"><a href="https://t.co/9qWMDudA9z"><img src="https://pbs.twimg.com/media/EsprvHNWMAEerFD.png:small"></a></div></div></div>



<a name="228029211"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/228029211" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#228029211">(Feb 27 2021 at 03:30)</a>:</h4>
<p>Alright, I finally implemented building static libraries/plugins on Nix (in my fork of Lean4). Not sure if the change is PR-ready, it's not the most elegant -- but at least it works :)</p>
<p>The change: <a href="https://github.com/zygi/lean4/commit/9fb8aad8f5d38b3383c0698c1b857f744e8f1465">https://github.com/zygi/lean4/commit/9fb8aad8f5d38b3383c0698c1b857f744e8f1465</a><br>
Example of the ergonomics it provides: <br>
<a href="https://github.com/zygi/leannixstatic1">https://github.com/zygi/leannixstatic1</a><br>
<a href="https://github.com/zygi/leannixstatic2">https://github.com/zygi/leannixstatic2</a></p>



<a name="228029214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/228029214" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#228029214">(Feb 27 2021 at 03:30)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span></p>



<a name="228032490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/228032490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#228032490">(Feb 27 2021 at 04:37)</a>:</h4>
<p>nvm, this somehow broke go-to-definition</p>



<a name="228032494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/228032494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#228032494">(Feb 27 2021 at 04:37)</a>:</h4>
<p>or did go-to-definition ever work with nix?</p>



<a name="228035698"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/228035698" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#228035698">(Feb 27 2021 at 05:42)</a>:</h4>
<p>It should work, yes, with the caveats that for go-to-def into Lean sources <code>LEAN_SRC_PATH</code> needs to be set (but I think <code>emacs/vscode-dev</code> both set it). And for go-to-def into imported packages <code>leanpkg print-paths</code> needs to report sensible paths which for <code>leanpkg.toml</code> it should. I'm not sure what the story is with <code>flake.nix</code>.</p>



<a name="228036164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/228036164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#228036164">(Feb 27 2021 at 05:52)</a>:</h4>
<p>Thanks! It works within the same file so it must be the leanpkg thing</p>



<a name="228056038"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/228056038" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#228056038">(Feb 27 2021 at 12:39)</a>:</h4>
<p>Looks good to me at first glance!</p>



<a name="228056691"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/228056691" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#228056691">(Feb 27 2021 at 12:54)</a>:</h4>
<p>Would be interesting to check if -fpic actually has a performance impact using clang <a href="https://stackoverflow.com/a/51611087/161659">https://stackoverflow.com/a/51611087/161659</a></p>



<a name="228072467"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/228072467" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#228072467">(Feb 27 2021 at 17:48)</a>:</h4>
<p>sg, will try to beautify it a little bit and do a PR</p>



<a name="228072586"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/228072586" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Zygimantas Straznickas <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#228072586">(Feb 27 2021 at 17:50)</a>:</h4>
<p>also, added support for Nix go-to-definition. Instead of <code>leanpkg print-paths</code>, Nix will build a combined-dependency-source-dir and pass it in <code>LEAN_SRC_PATH</code>.</p>



<a name="235491385"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/235491385" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#235491385">(Apr 21 2021 at 11:11)</a>:</h4>
<p>I have to say I'm very much satisfied with Nix local and remote caching when working on Lean. Both no-op rebuilds after switching branches and automatically fetching the latest CI build after a pull just feel great. However, I acknowledge that for <em>users</em> of Lean 4 there are a few issues with this approach:</p>
<ul>
<li>Fetching Lean from the binary cache should be much faster (~2min) than building it from scratch, but that's still awfully slow compared to downloading a single ~100MB nightly build archive. This is both because the "build plan" has to be computed first by parsing the header of every .lean file (via import-from-derivation, which is not exactly fast) and then all ~400 .olean files are downloaded individually.</li>
<li>Even with the very generously sized free Cachix cache, commits are cached only for about a month, while there is no time limit with our binary releases on GitHub. Per-commit caching is very useful for developers, but less so for users, for which nightly releases should usually be sufficient.</li>
<li>There is no direct way to map <code>leanpkg.toml</code> <code>lean_version</code> specifiers such as <code>"leanprover/lean4:nightly-2021-04-20"</code> to cache entries.</li>
<li>The cache has to be configured as a trusted substituter.</li>
</ul>
<p>Thus, if we want the Nix setup to be at least as fast and convenient as, and potentially also more compatible with, the <code>elan</code> setup, it seems like for <em>users</em> of Lean it should fetch it from the GitHub releases, not from Cachix. Downloading and Nix-patching binary releases is nothing unheard of in nixpkgs, so I feel we would be in good company.</p>
<p>Specifically, what I'm imagining is that we have CI generate and commit a new configuration file, say <code>releases.json</code> on a branch <code>releases</code> in <code>leanprover/lean4-nightly</code> with the following content:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span>
  <span class="nt">"releases"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"nightly-2021-04-21"</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">"x86_64-linux"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"url"</span><span class="p">:</span> <span class="s2">"https://github.com/leanprover/lean4-nightly/releases/download/nightly-2021-04-21/lean-4.0.0-nightly-2021-04-21-linux.tar.gz"</span><span class="p">,</span>
        <span class="nt">"sha256"</span><span class="p">:</span> <span class="s2">"..."</span>
      <span class="p">},</span> <span class="err">...</span>
    <span class="p">},</span> <span class="err">...</span>
  <span class="p">},</span>
  <span class="nt">"latest"</span><span class="p">:</span> <span class="s2">"nightly-2021-04-21"</span>
<span class="p">}</span>
</code></pre></div>
<p>With this and a corresponding (static) <code>flake.nix</code> that implements the downloading and patching, we could add that branch as an input to any flake and either access a version directly with something like <code>releases.${system}.latest</code>, or parse a leanpkg.toml and use the version from there. The only limitation in the latter case is that the locked flake input must be at least as recent as the <code>lean_version</code> in <code>leanpkg.toml</code>, so Nix users might sometimes need to do an extra <code>nix flake update</code> when someone else has updated the Lean version.</p>
<p>It's not quite clear to me yet where our custom Nix functions such as <code>buildLeanPackage</code> should come from in this setup, but if we want to keep them version-specific, we should probably include them in the binary releases (negligible storage overhead) and import-from-derivation them from in there, i.e. it would look something like <code>releases.${system}.latest.buildLeanPackage</code>.</p>
<p>Ok, that's all I can think of so far. Thoughts?</p>



<a name="235491492"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/235491492" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#235491492">(Apr 21 2021 at 11:12)</a>:</h4>
<p>Note that the same configuration file could be used by <code>elan</code> so it can stop having to parse the GitHub release page's HTML <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="235491643"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/235491643" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#235491643">(Apr 21 2021 at 11:14)</a>:</h4>
<p>presumably you could build a binary using <code>nix</code> too for users?</p>



<a name="235497988"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/235497988" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#235497988">(Apr 21 2021 at 12:06)</a>:</h4>
<p>Yes, you could have Nix build a big tarball as well and put it in the binary cache if you meant that. But the build plan would still have to be computed in order to compute the hash of the tarball, so this would not solve any of the above issues.</p>



<a name="235498916"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/235498916" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#235498916">(Apr 21 2021 at 12:14)</a>:</h4>
<p>Ideally it should be possible to work on a leanpkg.toml-based package using the Nix setup without any <code>flake.nix</code> being present. This could either be done using a temporary flake (Eelco Dolstra has some experiments in that direction I think) or perhaps using an old-style <code>nix-build -E ...</code>.</p>



<a name="235516537"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/235516537" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#235516537">(Apr 21 2021 at 14:10)</a>:</h4>
<p>I mean more like a <code>nix</code> way of creating the nightly builds. But maybe that's already a solved problem anyway.</p>



<a name="235525170"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/235525170" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#235525170">(Apr 21 2021 at 15:01)</a>:</h4>
<p>Putting a Nix build result directly in a tarball and publishing it usually doesn't make sense because it will contain many broken references to the libc and other dependencies elsewhere in the Nix store. In fact the nightlies are already built inside a <code>nix-shell</code> (but using cmake) and we patch the build results in the end to work on generic Linux/macOS machines. So I think the only two ways of distribution are 1) using a "proper" binary cache that automatically fetches dependencies, as we do right now, and 2) downloading a generic-Linux/macOS binary and patching it on the fly for Nix, as proposed above.</p>



<a name="235537007"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/235537007" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#235537007">(Apr 21 2021 at 16:03)</a>:</h4>
<p>did you consider the FHS wrapper to make it more generic? (Though I have to admit, I don't know if it's used in this way). At least you might not have to patch in the end.</p>



<a name="235543639"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/235543639" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#235543639">(Apr 21 2021 at 16:46)</a>:</h4>
<p>Binary patching is very much established in the Nix ecosystem, it's definitely cleaner than the FHS wrapper :)</p>



<a name="235543902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/235543902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#235543902">(Apr 21 2021 at 16:48)</a>:</h4>
<p>It's just a bit funny that we will un-Nix-patch the release before uploading it and then re-patch it on the (Nix) user's machine, but the first part is basically an implementation detail of how the releases are created</p>



<a name="238645005"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/238645005" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#238645005">(May 13 2021 at 16:27)</a>:</h4>
<p>After mulling over the above issues for a while, let's consider if we could <em>possibly</em> solve them using Nix alone:</p>
<ul>
<li>
<p>I'm not aware of any currently available way to skip/significantly optimize the "build plan" evaluation, but in theory it is very much possible: Nix already uses an evaluation cache locally that skips this step if the flake contents are unchanged. Doing the same remotely is listed under "Future Improvements" in <a href="https://www.tweag.io/blog/2020-06-25-eval-cache/">https://www.tweag.io/blog/2020-06-25-eval-cache/</a>, though I'm not aware of any work or even a GitHub issue on this feature. With it, Nix would download a Lean release's commit (over HTTP, not clone the whole repo), hash its contents, and then immediately skip to downloading binaries from the cache.<br>
Regarding downloading 400 .olean files, this could trivially be optimized today by adding a new derivation that copies all .olean files of a package into a single directory tree and pushing that to the cache. The biggest downside of doing that is that every commit would take up much more cache space. However, here the Nix setup could also easily <em>improve</em> on the standard setup: using Nix's laziness, there is no need to even download the whole <code>Lean</code> package, or its compiled static library, until users actually import it. These two alone make up 60% of a release's size! The only reason this isn't already the case today is that we try to emulate the standard setup's directory layout, which contains all these dependencies in <code>lib/</code>, so that we can run Lean's test suite with minimal changes. But there is no reason to use this "all-inclusive" derivation in the pure-Nix <code>buildLeanPackage</code> as well.</p>
</li>
<li>
<p>There is no magic bullet for fitting more commits in the binary cache, but perhaps there are workarounds. For example, we could use a separate cache for nightly and/or stable builds. That would still not give us unbounded cached releases like GitHub graciously does, but probably a sufficient number. If you really need an old release, maybe building it from source is tolerable since with Nix we can at least guarantee it will be painless and eventually succeed.</p>
</li>
<li>If we auto-generate a <code>flake.nix</code> from a <code>leanpkg.toml</code>, we can certainly map <code>lean_version = "leanprover/lean4:nightly-2021-04-20"</code> to <code>inputs.lean = github:leanprover/lean4-nightly/2021-04-20;</code>. If a project has both files, we could have a tool for keeping them in sync.</li>
<li>Speaking of tools, I'm now committed to building a custom wrapper around a statically built Nix for Lean, which will resolve the global installation and configuration issues... on Linux (because using a local Nix store depends on mount namespaces)</li>
</ul>
<p>In summary, while the Nix setup is unlikely to beat the standard setup on <em>time</em> for downloading a Lean release in the near future, we could reasonably already do so on <em>download size</em> for most use cases (which on a slow connection could of course translate into less time as well).</p>
<p>Here's hoping someone interested will actually read this :) .</p>



<a name="238654866"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/238654866" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#238654866">(May 13 2021 at 17:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/238645005">said</a>:</p>
<blockquote>
<p>After mulling over the above issues for a while, let's consider if we could <em>possibly</em> solve them using Nix alone:</p>
<ul>
<li>
<p>I'm not aware of any currently available way to skip/significantly optimize the "build plan" evaluation, but in theory it is very much possible: Nix already uses an evaluation cache locally that skips this step if the flake contents are unchanged. Doing the same remotely is listed under "Future Improvements" in <a href="https://www.tweag.io/blog/2020-06-25-eval-cache/">https://www.tweag.io/blog/2020-06-25-eval-cache/</a>, though I'm not aware of any work or even a GitHub issue on this feature. With it, Nix would download a Lean release's commit (over HTTP, not clone the whole repo), hash its contents, and then immediately skip to downloading binaries from the cache.<br>
Regarding downloading 400 .olean files, this could trivially be optimized today by adding a new derivation that copies all .olean files of a package into a single directory tree and pushing that to the cache. The biggest downside of doing that is that every commit would take up much more cache space. However, here the Nix setup could also easily <em>improve</em> on the standard setup: using Nix's laziness, there is no need to even download the whole <code>Lean</code> package, or its compiled static library, until users actually import it. These two alone make up 60% of a release's size! The only reason this isn't already the case today is that we try to emulate the standard setup's directory layout, which contains all these dependencies in <code>lib/</code>, so that we can run Lean's test suite with minimal changes. But there is no reason to use this "all-inclusive" derivation in the pure-Nix <code>buildLeanPackage</code> as well.</p>
</li>
<li>
<p>There is no magic bullet for fitting more commits in the binary cache, but perhaps there are workarounds. For example, we could use a separate cache for nightly and/or stable builds. That would still not give us unbounded cached releases like GitHub graciously does, but probably a sufficient number. If you really need an old release, maybe building it from source is tolerable since with Nix we can at least guarantee it will be painless and eventually succeed.</p>
</li>
<li>If we auto-generate a <code>flake.nix</code> from a <code>leanpkg.toml</code>, we can certainly map <code>lean_version = "leanprover/lean4:nightly-2021-04-20"</code> to <code>inputs.lean = github:leanprover/lean4-nightly/2021-04-20;</code>. If a project has both files, we could have a tool for keeping them in sync.</li>
<li>Speaking of tools, I'm now committed to building a custom wrapper around a statically built Nix for Lean, which will resolve the global installation and configuration issues... on Linux (because using a local Nix store depends on mount namespaces)</li>
</ul>
<p>In summary, while the Nix setup is unlikely to beat the standard setup on <em>time</em> for downloading a Lean release in the near future, we could reasonably already do so on <em>download size</em> for most use cases (which on a slow connection could of course translate into less time as well).</p>
<p>Here's hoping someone interested will actually read this :) .</p>
</blockquote>
<blockquote>
<p>If we auto-generate a flake.nix from a leanpkg.toml, we can certainly map lean_version = "leanprover/lean4:nightly-2021-04-20" to inputs.lean = github:leanprover/lean4-nightly/2021-04-20;. If a project has both files, we could have a tool for keeping them in sync.</p>
</blockquote>
<p>Actually, <code>leanpkg.toml</code> can work with a <code>Nix</code> setup and read the data directly from the Flakes file, lockfile, etc. Right?</p>



<a name="238654981"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/238654981" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Ryan Lahfa <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#238654981">(May 13 2021 at 17:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/238645005">said</a>:</p>
<blockquote>
<ul>
<li>Speaking of tools, I'm now committed to building a custom wrapper around a statically built Nix for Lean, which will resolve the global installation and configuration issues... on Linux (because using a local Nix store depends on mount namespaces)</li>
</ul>
</blockquote>
<p>FWIW, there is <a href="https://github.com/DavHau/nix-portable">https://github.com/DavHau/nix-portable</a></p>



<a name="238658371"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/238658371" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sam Stites <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#238658371">(May 13 2021 at 18:10)</a>:</h4>
<p>(deleted)</p>



<a name="238658856"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/238658856" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sam Stites <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#238658856">(May 13 2021 at 18:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="262143">Ryan Lahfa</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/238654981">said</a>:</p>
<blockquote>
<p>FWIW, there is <a href="https://github.com/DavHau/nix-portable">https://github.com/DavHau/nix-portable</a></p>
</blockquote>
<p>DavHau's mach-nix is also worth checking out as a flake-compatible build tool for python (with a command line wrapper as well): <a href="https://github.com/DavHau/mach-nix">https://github.com/DavHau/mach-nix</a></p>



<a name="238659622"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/238659622" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#238659622">(May 13 2021 at 18:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="262143">Ryan Lahfa</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/238654866">said</a>:</p>
<blockquote>
<p>Actually, <code>leanpkg.toml</code> can work with a <code>Nix</code> setup and read the data directly from the Flakes file, lockfile, etc. Right?</p>
</blockquote>
<p>You can't really make sense of a <code>flake.nix</code> without a Nix interpreter, so using the restricted <code>leanpkg.toml</code> format as the common ground is way easier. At one point I considered separate flake.nix and leanpkg.toml files with a common lock file, but I really don't want to teach <code>leanpkg</code> how to calculate <code>narHash</code>es...</p>



<a name="238659655"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/238659655" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#238659655">(May 13 2021 at 18:20)</a>:</h4>
<p>You don't have to quote my entire message btw :)</p>



<a name="238660250"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/238660250" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#238660250">(May 13 2021 at 18:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="262143">Ryan Lahfa</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/238654981">said</a>:</p>
<blockquote>
<p>FWIW, there is <a href="https://github.com/DavHau/nix-portable">https://github.com/DavHau/nix-portable</a></p>
</blockquote>
<p>I know about the project, but it's not clear to me if there are relevant systems for Lean where this would work but not mount namespaces. In particular, even Debian has activated namespaces for non-root users by now afaik. And the big missing platform, macOS, is not supported by nix-portable either.</p>



<a name="239747389"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/239747389" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#239747389">(May 21 2021 at 13:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/using.20nix/near/238645005">said</a>:</p>
<blockquote>
<p>However, here the Nix setup could also easily <em>improve</em> on the standard setup: using Nix's laziness, there is no need to even download the whole <code>Lean</code> package, or its compiled static library, until users actually import it. These two alone make up 60% of a release's size! The only reason this isn't already the case today is that we try to emulate the standard setup's directory layout, which contains all these dependencies in <code>lib/</code>, so that we can run Lean's test suite with minimal changes. But there is no reason to use this "all-inclusive" derivation in the pure-Nix <code>buildLeanPackage</code> as well.</p>
</blockquote>
<p>This is now implemented: the (uncompressed) closure size of the <code>lean</code> derivation shrunk from 806 derivations totaling 434MB to just 6 derivations totaling 89MB (a good chunk of which is glibc, which you might already have from a different Lean revision).</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ nix path-info -Sh .#lean-all
/nix/store/9s2bcmdr8035dkfx9vgfh5jxcibqnxaw-lean     <span class="m">434</span>.1M
$ nix path-info -rsSh .#lean
/nix/store/1yvpgm763b3hvg8q4fzpzmflr5674x4j-glibc-2.32-10         <span class="m">29</span>.7M   <span class="m">31</span>.4M
/nix/store/c13jjm75vr23fv15wr1gqvlkkf6s1m7g-libidn2-2.3.0        <span class="m">217</span>.5K    <span class="m">1</span>.8M
/nix/store/gk72n6pafkh603q9syxgj0i3pwp4fqf4-gmp-6.2.1            <span class="m">734</span>.3K   <span class="m">38</span>.1M
/nix/store/isy60my0ijjzh49rscgdb1i2457nf7lp-gcc-9.3.0-lib          <span class="m">6</span>.0M   <span class="m">37</span>.4M
/nix/store/ngc68ngmymx2vmbj6gih07n7z2024ffj-libunistring-0.9.10    <span class="m">1</span>.6M    <span class="m">1</span>.6M
/nix/store/p64iq0dhanyzzf2l0g0bkiw252l40z6c-lean                  <span class="m">51</span>.5M   <span class="m">89</span>.7M
</code></pre></div>
<p>When building a Lean package using Nix, this executable will be used to parse all import paths, which will then be fetched lazily. In other words, if you use <code>prelude</code>, not even the <code>Init</code> .oleans will be downloaded onto your PC.</p>



<a name="239749929"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/239749929" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#239749929">(May 21 2021 at 13:28)</a>:</h4>
<p>I really need to check out this nix integration more.  Is it a full leanmake replacement, i.e. does the server use it as well?  Can you use your own editor?  How hard is it e.g. to add nix support to mathlib4?</p>



<a name="239752851"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/using%20nix/near/239752851" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/using.20nix.html#239752851">(May 21 2021 at 13:47)</a>:</h4>
<p>I was hoping you would eventually find time to check it out <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span> . Well, the problem right now is that I don't have to work on it either, except for this super low-hanging fruit.</p>
<blockquote>
<p>Is it a full leanmake replacement, i.e. does the server use it as well?</p>
</blockquote>
<p>Yes, the server is pointed at a fake <code>leanpkg</code> that on <code>print-paths</code> builds and returns the .olean store paths on the fly. It even works for stage 0, where the "proper" <code>leanpkg</code> doesn't exist yet. The editor can't tell the difference between the two setups.</p>
<blockquote>
<p>How hard is it e.g. to add nix support to mathlib4?</p>
</blockquote>
<p>Until we can consume <code>leanpkg.toml</code>s directly, it looks like this: <a href="https://github.com/Kha/testpkg2/blob/master/flake.nix">https://github.com/Kha/testpkg2/blob/master/flake.nix</a>. The only onerous part is keeping the two Lean versions in leanpkg.toml and flake.lock in sync.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>