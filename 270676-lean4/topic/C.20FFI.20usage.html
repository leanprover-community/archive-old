---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/C.20FFI.20usage.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html">C FFI usage</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="256393196"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256393196" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256393196">(Oct 06 2021 at 11:10)</a>:</h4>
<p>I'm trying to link the BLAKE3 library in C to Lean FFI with extern. My attempt so far is:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// private fields</span>
<span class="p">}</span><span class="w"> </span><span class="n">blake3_hasher</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>which I tried in Lean to represent as an opaque type :</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "blake3_hasher"]</span>
<span class="kd">constant</span> <span class="n">Blake3Hasher</span> <span class="o">:</span> <span class="kt">Type</span>
</code></pre></div>
<p>Which seems to work.<br>
And the initialization function:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">blake3_hasher_init</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">blake3_hasher</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>in Lean I tried this</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "blake3_hasher_init"]</span>
<span class="kd">constant</span> <span class="n">initHasher</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Blake3Hasher</span>
</code></pre></div>
<p>But when I try to write this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "blake3_version"]</span>
<span class="kd">constant</span> <span class="n">version</span> <span class="o">:</span> <span class="n">String</span>
</code></pre></div>
<p>For this c header:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">blake3_version</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>I get this error:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>/nix/store/9abmq17hg5gia3r2h748ps8dm8m3r884-LeanPlay.LeanVersion-c/LeanPlay/LeanVersion.c:820:21: error: called object type 'lean_object *' is not a function or function pointer
x_1 = blake3_version();
      ~~~~~~~~~~~~~~^
1 error generated.
</code></pre></div>
<p>How do I link this correctly?</p>



<a name="256393847"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256393847" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256393847">(Oct 06 2021 at 11:17)</a>:</h4>
<p>There is no automatic conversion between <code>char *</code> and <code>String</code>, so you will need to implement a wrapper function <code>lean_object * lean_blake3_version(lean_object * unit)</code>/<code>constant version : Unit -&gt; String</code> anyway</p>



<a name="256394481"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256394481" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256394481">(Oct 06 2021 at 11:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="433842">Anders Christiansen Sørby</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/256393196">said</a>:</p>
<blockquote>
<p>which I tried in Lean to represent as an opaque type :</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "blake3_hasher"]</span>
<span class="kd">constant</span> <span class="n">Blake3Hasher</span> <span class="o">:</span> <span class="kt">Type</span>
</code></pre></div>
<p>Which seems to work.</p>
</blockquote>
<p>This will break when the runtime tries to increment or decrement the RC of such an object. See <code>lean_external_object</code>, incl. some prior discussions in this stream, for wrapping external resources in Lean objects.</p>



<a name="256397486"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256397486" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xubai Wang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256397486">(Oct 06 2021 at 11:50)</a>:</h4>
<p>FYI: two steps of using <code>lean_external_object</code></p>
<ol>
<li>Initialization</li>
</ol>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">lean_external_class</span><span class="w"> </span><span class="o">*</span><span class="n">g_blake3_hasher_external_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">blake3_hasher_finalizer</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// cleanup code such as</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">inline</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">blake3_hasher_foreach</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">b_lean_obj_arg</span><span class="w"> </span><span class="n">fn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// used for `for in`</span>
<span class="p">}</span><span class="w"></span>

<span class="n">lean_obj_res</span><span class="w"> </span><span class="nf">blake3_initialize</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// must be called beforehand</span>
<span class="w">    </span><span class="c1">// Often I wrap this in an external function and call it with `builtin_initialize` from Lean.</span>
<span class="w">    </span><span class="c1">// There is another way of calling this each time in `lean4-papyrus`.</span>
<span class="w">    </span><span class="n">g_blake3_hasher_external_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_register_external_class</span><span class="p">(</span><span class="n">blake3_hasher_finalizer</span><span class="p">,</span><span class="w"> </span><span class="n">blake3_hasher_foreach</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lean_io_result_mk_ok</span><span class="p">(</span><span class="n">lean_box</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "blake3_initialize"]</span> <span class="kd">constant</span> <span class="n">blake3Init</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">Unit</span>

<span class="n">builtin_initialize</span> <span class="n">blake3Init</span>
</code></pre></div>
<ol start="2">
<li>Creation and Usage (usually wrapped into some <code>box</code> and <code>unbox</code> convenience function)</li>
</ol>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="nf">blake3_hasher_box</span><span class="p">(</span><span class="n">blake3_hasher</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lean_alloc_external</span><span class="p">(</span><span class="n">g_blake3_hasher_external_class</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">blake3_hasher</span><span class="w"> </span><span class="o">*</span><span class="nf">blake3_hasher_unbox</span><span class="p">(</span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">blake3_hasher</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">lean_get_external_data</span><span class="p">(</span><span class="n">o</span><span class="p">));</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And note that <code>blake3_hasher_box</code> should be used on heap allocated <code>blake3_hasher *</code>.</p>



<a name="256398107"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256398107" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xubai Wang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256398107">(Oct 06 2021 at 11:56)</a>:</h4>
<p>You can also refer to the <code>IO.FS.Handle</code> example in Lean source code <a href="https://github.com/leanprover/lean4/blob/08c2c31fcd74f53d4b1d81bee92a16a369738d91/src/Init/System/IO.lean#L147-L223">here</a>.</p>



<a name="256401010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256401010" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xubai Wang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256401010">(Oct 06 2021 at 12:19)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Creating an external class for each C struct is annoying when there're a lot of them. Although <code>[unbox]</code> is noop now, will it be possible in the future that  we can directly unbox a Lean <code>structure</code> into C <code>struct</code> by marking it with <code>attribute [unbox]</code>?</p>



<a name="256402036"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256402036" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256402036">(Oct 06 2021 at 12:28)</a>:</h4>
<p>Perhaps, but how to then pass it as a pointer is also unclear</p>



<a name="256403022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256403022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xubai Wang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256403022">(Oct 06 2021 at 12:36)</a>:</h4>
<p>I have considered several ways of using external <code>struct</code>.</p>
<ol>
<li>The first is to simply use the <code>lean_external_class</code> and <code>constant</code>. This is easy to use but it makes the <code>struct</code> completely opaque. We cannot have some proof on it. And since constant cannot be <code>Inhabited</code>, every thing returned have to be <code>IO</code> or <code>Option</code> or something else even if we just want to access the struct field.</li>
<li>The second one is to use a plain Lean inductive. We can use <code>@[extern] def</code> to access the struct field, but this creates a big overhead when we need to pass the struct back and forth (e.g. epoll or IOCP).</li>
<li>The third way is to define our own lean_objects, like the standard <code>lean_sarray_object</code>, <code>lean_string_object</code>. But this seems impossible because each of them use a different tag.</li>
</ol>
<p>None of them is satisfactory enough, and the most elegant and least overhead approach I can come up with is to directly use <code>struct</code> internally on FFI <code>structure</code>s.</p>



<a name="256403583"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256403583" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256403583">(Oct 06 2021 at 12:40)</a>:</h4>
<p>Can the overhead in 2. be eliminated via LTO?</p>



<a name="256403768"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256403768" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256403768">(Oct 06 2021 at 12:42)</a>:</h4>
<p>Runtime representation and Lean representation (<code>constant</code>/<code>inductive</code>) should be mostly orthogonal design decision</p>



<a name="256406371"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256406371" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xubai Wang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256406371">(Oct 06 2021 at 13:00)</a>:</h4>
<p>I think the overhead is mostly in "translating" . Can LTO optimize this away?</p>
<p>Take <code>poll</code> (or <code>WSAPoll</code>) as example.</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">poll</span><span class="p">(</span><span class="k">struct</span> <span class="nc">pollfd</span><span class="w"> </span><span class="n">fds</span><span class="p">[],</span><span class="w"> </span><span class="kt">nfds_t</span><span class="w"> </span><span class="n">nfds</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">pollfd</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kt">int</span><span class="w">    </span><span class="n">fd</span><span class="p">;</span><span class="w">       </span><span class="cm">/* file descriptor */</span><span class="w"></span>
<span class="w">     </span><span class="kt">short</span><span class="w">  </span><span class="n">events</span><span class="p">;</span><span class="w">   </span><span class="cm">/* events to look for */</span><span class="w"></span>
<span class="w">     </span><span class="kt">short</span><span class="w">  </span><span class="n">revents</span><span class="p">;</span><span class="w">  </span><span class="cm">/* events returned */</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>The Lean side can be:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">PollFd</span> <span class="n">where</span>
  <span class="n">fd</span> <span class="o">:</span> <span class="n">FileDesc</span>
  <span class="n">events</span> <span class="o">:</span> <span class="n">Array</span> <span class="n">PollEvent</span>  <span class="c1">-- where PollEvent is a enum inductive</span>
  <span class="n">revents</span> <span class="o">:</span> <span class="n">Array</span> <span class="n">PollEvent</span>

<span class="kd">@[extern "lean_poll"]</span> <span class="kd">constant</span> <span class="n">poll</span> <span class="o">:</span> <span class="o">(</span><span class="bp">@&amp;</span> <span class="o">(</span><span class="n">IO.Ref</span> <span class="n">PollFd</span><span class="o">))</span> <span class="bp">-&gt;</span> <span class="bp">@&amp;</span> <span class="n">USize</span> <span class="bp">-&gt;</span> <span class="bp">@&amp;</span> <span class="n">USize</span> <span class="bp">-&gt;</span> <span class="n">IO</span> <span class="n">Unit</span>
</code></pre></div>
<p>The <code>lean_poll</code> function has to convert <code>PollFd</code> to <code>pollfd</code> to feed and then convert it back to return (overhead: the creation of <code>pollfd</code> and modifying the <code>Array</code>). Also, each events and revents has to be <code>and</code>ed out to turn them into array of PollEvents instead of checking bit needed only.</p>



<a name="256433852"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256433852" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256433852">(Oct 06 2021 at 15:47)</a>:</h4>
<p>Ah, I assumed you meant to make the constructor and all field accessors <code>@[extern]</code>, like we e.g. do with <code>String</code>. Then the Lean type doesn't really exist at runtime. But the C type still has to be wrapped in a <code>lean_object</code> or somehow be transferred unboxed.</p>



<a name="256434220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256434220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256434220">(Oct 06 2021 at 15:49)</a>:</h4>
<p>I think for structs behind pointers or arrays the most realistic solution for now is to write a metaprogram that translates a C structure declaration to raw accesses of a <code>ByteArray</code></p>



<a name="256434395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256434395" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256434395">(Oct 06 2021 at 15:50)</a>:</h4>
<p>and/or an of an <code>unsafe</code> <code>Pointer</code> type, which we do not have yet</p>



<a name="256449440"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256449440" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Christian Pehle <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256449440">(Oct 06 2021 at 17:22)</a>:</h4>
<p>I considered whether </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">SomeClassRef</span> <span class="n">where</span>
        <span class="n">addr</span> <span class="o">:</span> <span class="n">UInt64</span>

<span class="kd">@[extern "lean_create_class_ref"]</span>
<span class="kd">constant</span> <span class="n">SomeClassRef.create</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">SomeClassRef</span>
</code></pre></div>
<p>could work, then each function could just cast the address to a struct pointer and operate on this (as this is already unboxed by the compiler). But it would require to track the lifetime manually and in say IO, which isn't very elegant. I like the approach in lean-papyrus by <span class="user-mention" data-user-id="315577">@Mac</span> , which distinguishes between OwnerPtr and WeakPtr properly, but such an implementation can be only done in a sufficiently powerful language like C++ / Rust and not in a C.</p>



<a name="256587057"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256587057" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256587057">(Oct 07 2021 at 14:30)</a>:</h4>
<p>Using a call to buildLeanPackage:</p>
<div class="codehilite" data-code-language="Nix"><pre><span></span><code>      <span class="ss">blake3Mod =</span> leanPkgs<span class="o">.</span>buildLeanPackage <span class="p">{</span>
        <span class="ss">name =</span> <span class="s2">"Blake3"</span><span class="p">;</span>
        <span class="ss">src =</span> <span class="o">.</span><span class="l">/src</span><span class="p">;</span>
        <span class="ss">debug =</span> <span class="no">true</span><span class="p">;</span>
        <span class="ss">linkFlags =</span> <span class="p">[</span> <span class="s2">"-v -l</span><span class="si">${</span>blake3-c<span class="si">}</span><span class="s2">"</span> <span class="p">];</span>
        <span class="ss">staticLibDeps =</span> <span class="p">[</span> blake3-c <span class="p">];</span>
      <span class="p">};</span>
</code></pre></div>
<p>The first few lines of the generated C code looks like this:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="c1">// Lean compiler output</span>
<span class="c1">// Module: Blake3</span>
<span class="c1">// Imports: Init</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;lean/lean.h&gt;</span><span class="cp"></span>
<span class="cp">#if defined(__clang__)</span>
<span class="cp">#pragma clang diagnostic ignored "-Wunused-parameter"</span>
<span class="cp">#pragma clang diagnostic ignored "-Wunused-label"</span>
<span class="cp">#elif defined(__GNUC__) &amp;&amp; !defined(__CLANG__)</span>
<span class="cp">#pragma GCC diagnostic ignored "-Wunused-parameter"</span>
<span class="cp">#pragma GCC diagnostic ignored "-Wunused-label"</span>
<span class="cp">#pragma GCC diagnostic ignored "-Wunused-but-set-variable"</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef __cplusplus</span>
<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_hasherFinalize___boxed</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_hasherUpdate___boxed</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_version</span><span class="p">;</span><span class="w"></span>
<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="nf">blake3_hasher_init_derive_key</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_initHasher___boxed</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="nf">blake3_version</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">l_Blake3_BLAKE3__BLOCK__LEN</span><span class="p">;</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_initHasherDeriveKey___boxed</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_hasherFinalizeSeek___boxed</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_initHasherKeyed___boxed</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="nf">blake3_hasher_update</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="nf">blake3_hasher_finalize_seek</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">l_Blake3_BLAKE3__MAX__DEPTH</span><span class="p">;</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">l_Blake3_BLAKE3__KEY__LEN</span><span class="p">;</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">l_Blake3_BLAKE3__OUT__LEN</span><span class="p">;</span><span class="w"></span>
<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="nf">blake3_hasher_init</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_version___closed__1</span><span class="p">;</span><span class="w"></span>
<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="nf">blake3_hasher_finalize</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_internalVersion___boxed</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="nf">blake3_hasher_init_derive_key_raw</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="nf">blake3_hasher_init_keyed</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_initHasherDeriveKeyRaw___boxed</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">l_Blake3_BLAKE3__CHUNK__LEN</span><span class="p">;</span><span class="w"></span>
<span class="c1">// ....</span>
<span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">l_Blake3_internalVersion___boxed</span><span class="p">(</span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">x_1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">_start</span><span class="p">:</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">x_2</span><span class="p">;</span><span class="w"></span>
<span class="n">x_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blake3_version</span><span class="p">(</span><span class="n">x_1</span><span class="p">);</span><span class="w"></span>
<span class="k">return</span><span class="w"> </span><span class="n">x_2</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Full example code here: <a href="https://github.com/Anderssorby/LeanPlay">https://github.com/Anderssorby/LeanPlay</a><br>
But this causes the errors:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>/nix/store/hy3lz2vfv9qq2v5jz9nzlx6mmiaq79rj-binutils-2.35.1/bin/ld: /nix/store/nh3mbs8n9iarlbjx32fmd2b771bqx5v4-Blake3-cc/Blake3.o: in function `l_Blake3_internalVersion___boxed':
/nix/store/dckyffc4s94gg47nb7xrr69xn4l441fc-Blake3-c/Blake3.c:83: undefined reference to `blake3_version'
/nix/store/hy3lz2vfv9qq2v5jz9nzlx6mmiaq79rj-binutils-2.35.1/bin/ld: /nix/store/nh3mbs8n9iarlbjx32fmd2b771bqx5v4-Blake3-cc/Blake3.o: in function `l_Blake3_initHasher___boxed':
/nix/store/dckyffc4s94gg47nb7xrr69xn4l441fc-Blake3-c/Blake3.c:108: undefined reference to `blake3_hasher_init'
/nix/store/hy3lz2vfv9qq2v5jz9nzlx6mmiaq79rj-binutils-2.35.1/bin/ld: /nix/store/nh3mbs8n9iarlbjx32fmd2b771bqx5v4-Blake3-cc/Blake3.o: in function `l_Blake3_initHasherKeyed___boxed':
/nix/store/dckyffc4s94gg47nb7xrr69xn4l441fc-Blake3-c/Blake3.c:116: undefined reference to `blake3_hasher_init_keyed'
/nix/store/hy3lz2vfv9qq2v5jz9nzlx6mmiaq79rj-binutils-2.35.1/bin/ld: /nix/store/nh3mbs8n9iarlbjx32fmd2b771bqx5v4-Blake3-cc/Blake3.o: in function `l_Blake3_initHasherDeriveKey___boxed':
/nix/store/dckyffc4s94gg47nb7xrr69xn4l441fc-Blake3-c/Blake3.c:124: undefined reference to `blake3_hasher_init_derive_key'
/nix/store/hy3lz2vfv9qq2v5jz9nzlx6mmiaq79rj-binutils-2.35.1/bin/ld: /nix/store/nh3mbs8n9iarlbjx32fmd2b771bqx5v4-Blake3-cc/Blake3.o: in function `l_Blake3_initHasherDeriveKeyRaw___boxed':
/nix/store/dckyffc4s94gg47nb7xrr69xn4l441fc-Blake3-c/Blake3.c:134: undefined reference to `blake3_hasher_init_derive_key_raw'
/nix/store/hy3lz2vfv9qq2v5jz9nzlx6mmiaq79rj-binutils-2.35.1/bin/ld: /nix/store/nh3mbs8n9iarlbjx32fmd2b771bqx5v4-Blake3-cc/Blake3.o: in function `l_Blake3_hasherUpdate___boxed':
/nix/store/dckyffc4s94gg47nb7xrr69xn4l441fc-Blake3-c/Blake3.c:144: undefined reference to `blake3_hasher_update'
/nix/store/hy3lz2vfv9qq2v5jz9nzlx6mmiaq79rj-binutils-2.35.1/bin/ld: /nix/store/nh3mbs8n9iarlbjx32fmd2b771bqx5v4-Blake3-cc/Blake3.o: in function `l_Blake3_hasherFinalize___boxed':
/nix/store/dckyffc4s94gg47nb7xrr69xn4l441fc-Blake3-c/Blake3.c:154: undefined reference to `blake3_hasher_finalize'
/nix/store/hy3lz2vfv9qq2v5jz9nzlx6mmiaq79rj-binutils-2.35.1/bin/ld: /nix/store/nh3mbs8n9iarlbjx32fmd2b771bqx5v4-Blake3-cc/Blake3.o: in function `l_Blake3_hasherFinalizeSeek___boxed':
/nix/store/dckyffc4s94gg47nb7xrr69xn4l441fc-Blake3-c/Blake3.c:166: undefined reference to `blake3_hasher_finalize_seek'
/nix/store/hy3lz2vfv9qq2v5jz9nzlx6mmiaq79rj-binutils-2.35.1/bin/ld: /nix/store/nh3mbs8n9iarlbjx32fmd2b771bqx5v4-Blake3-cc/Blake3.o: in function `_init_l_Blake3_version___closed__1':
/nix/store/dckyffc4s94gg47nb7xrr69xn4l441fc-Blake3-c/Blake3.c:92: undefined reference to `blake3_version'
</code></pre></div>
<p>What am I missing? Should there be a header file inclusion at the  top of this file somehow?</p>



<a name="256587906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256587906" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256587906">(Oct 07 2021 at 14:36)</a>:</h4>
<p>That's from the linker, so it's not header files. Can you post the linker cmdline? Should it be <code>linkFlags = [ "-v" "-l..." ];</code>?</p>



<a name="256588457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256588457" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256588457">(Oct 07 2021 at 14:39)</a>:</h4>
<p>I forgot about <code>staticLibDeps</code> btw. If <code>blake3-c</code> directly contains a <code>.a</code> file, you shouldn't need the <code>-l</code> argument.</p>



<a name="256669290"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256669290" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256669290">(Oct 08 2021 at 00:07)</a>:</h4>
<p>Linker cmdline:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code> <span class="s2">"/nix/store/ri0cphpgg739axdzgiwl3grawj6nlykg-ccache-links-wrapper-/bin/ld"</span> --eh-frame-hdr -m elf_x86_64 -o /nix/store/d7q4n09gwnmyan3b1hxjjzswqkg4sn69-leanplay/bin/leanplay /nix/store/cvr0kjg2q7z2wwhjblx6c73rv422k8cm-glibc-2.33-47/lib/crt1.o /nix/store/cvr0kjg2q7z2wwhjblx6c73rv422k8cm-glibc-2.33-47/lib/crti.o /nix/store/cj8kp411lblbdm4qj94s14h99dx1pv4b-gcc-10.3.0/lib/gcc/x86_64-unknown-linux-gnu/10.3.0/crtbegin.o -L/nix/store/fx58y0jdzd2xggdy0pqag2ffj72l7w33-gmp-6.2.1/lib -L/nix/store/12j5q4qa7f1h5qcxy47hycl18m6ych4f-Init-lib -L/nix/store/v7a28x16z8afha1nyrx5wi28v8mynccd-Std-lib -L/nix/store/60fckhkp33hnb35da605spn3m28h1vd3-Lean-lib -L/nix/store/fmam7m6307bwyjqx351y13j6js204xgq-leancpp/lib/lean -L/nix/store/hbqyp5xq6yi4sw5lm22i22sqyffvzi0n-leanshared -L/nix/store/1nzq03jahnla4gibxc8jmhbqi5j808ib-leanc/lib -L/nix/store/1nzq03jahnla4gibxc8jmhbqi5j808ib-leanc/lib/lean -L/nix/store/cvr0kjg2q7z2wwhjblx6c73rv422k8cm-glibc-2.33-47/lib -L/nix/store/cj8kp411lblbdm4qj94s14h99dx1pv4b-gcc-10.3.0/lib/gcc/x86_64-unknown-linux-gnu/10.3.0 -L/nix/store/lg104nh0szci8slz5z6494m457jm5y3p-gcc-10.3.0-lib/x86_64-unknown-linux-gnu/lib -L/nix/store/d3r0hhgljsp0nk5n4ra2k2ykvjyah96z-clang-12.0.1-lib/lib -L/nix/store/cvr0kjg2q7z2wwhjblx6c73rv422k8cm-glibc-2.33-47/lib -L/nix/store/cj8kp411lblbdm4qj94s14h99dx1pv4b-gcc-10.3.0/lib/gcc/x86_64-unknown-linux-gnu/10.3.0 -L/nix/store/lg104nh0szci8slz5z6494m457jm5y3p-gcc-10.3.0-lib/x86_64-unknown-linux-gnu/lib -L/nix/store/d3r0hhgljsp0nk5n4ra2k2ykvjyah96z-clang-12.0.1-lib/lib -L/nix/store/cj8kp411lblbdm4qj94s14h99dx1pv4b-gcc-10.3.0/lib64/gcc/x86_64-unknown-linux-gnu/10.3.0 -L/nix/store/cj8kp411lblbdm4qj94s14h99dx1pv4b-gcc-10.3.0/lib64/gcc/x86_64-unknown-linux-gnu/10.3.0/../../../../lib64 -L/nix/store/cj8kp411lblbdm4qj94s14h99dx1pv4b-gcc-10.3.0/lib64/gcc/x86_64-unknown-linux-gnu/10.3.0/../../.. -dynamic-linker<span class="o">=</span>/nix/store/cvr0kjg2q7z2wwhjblx6c73rv422k8cm-glibc-2.33-47/lib/ld-linux-x86-64.so.2 -dynamic-linker<span class="o">=</span>/nix/store/cvr0kjg2q7z2wwhjblx6c73rv422k8cm-glibc-2.33-47/lib/ld-linux-x86-64.so.2 /nix/store/2cwkzhb0k8k1mn206kzh91kcsqc3rcgz-LeanPlay-lib/libLeanPlay.a /nix/store/1b3sx4l56s2sw5clwzca2ab9z69xfhnj-Blake3-lib/libBlake3.a /nix/store/12j5q4qa7f1h5qcxy47hycl18m6ych4f-Init-lib/libInit.a /nix/store/50waard4c0nfjrrmiwwv0nd2l0xpcm29-Lake-lib/libLake.a /nix/store/60fckhkp33hnb35da605spn3m28h1vd3-Lean-lib/libLean.a /nix/store/yz4r96wavknfijbbnif9kc0zq85zfxp8-Leanpkg-lib/libLeanpkg.a /nix/store/v7a28x16z8afha1nyrx5wi28v8mynccd-Std-lib/libStd.a --start-group -lleancpp -lLean --end-group --start-group -lInit -lStd -lleanrt --end-group -lstdc++ -lm -lgmp -ldl -lgcc --as-needed -lgcc_s --no-as-needed -lpthread -lc -lgcc --as-needed -lgcc_s --no-as-needed /nix/store/cj8kp411lblbdm4qj94s14h99dx1pv4b-gcc-10.3.0/lib/gcc/x86_64-unknown-linux-gnu/10.3.0/crtend.o /nix/store/cvr0kjg2q7z2wwhjblx6c73rv422k8cm-glibc-2.33-47/lib/crtn.o
</code></pre></div>



<a name="256669453"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256669453" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256669453">(Oct 08 2021 at 00:09)</a>:</h4>
<p>The blake3-c is a .so file I think. I had troubles compiling to a .a static file.</p>



<a name="256745241"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256745241" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256745241">(Oct 08 2021 at 14:10)</a>:</h4>
<p>I only see a <code>/nix/store/1b3sx4l56s2sw5clwzca2ab9z69xfhnj-Blake3-lib/libBlake3.a</code> in that cmdline. Does <code>nm</code> says that that file contains <code>blake3_version</code>?</p>



<a name="256766128"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256766128" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256766128">(Oct 08 2021 at 16:29)</a>:</h4>
<p><code>linkFlags = [ blake3-c ];</code> works. I have to say though that putting a .so, or really any file, directly into Nix' <code>$out</code> instead of making that a folder is highly unconventional :) .</p>



<a name="256766387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/256766387" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#256766387">(Oct 08 2021 at 16:30)</a>:</h4>
<p>Now if only all bug reports were as easily reproducible as <code>nix build .#executable</code> <span aria-label="cry" class="emoji emoji-1f622" role="img" title="cry">:cry:</span> ...</p>



<a name="257690160"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257690160" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257690160">(Oct 15 2021 at 12:34)</a>:</h4>
<p>I'm getting a segmentation fault when running <code>nix build .#tests</code> for my blake3 bindings.<br>
<a href="https://github.com/yatima-inc/lean-blake3">https://github.com/yatima-inc/lean-blake3</a><br>
Full output:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">nix</span> <span class="n">build</span> <span class="bp">.#</span><span class="n">tests</span> <span class="bp">-</span><span class="n">vL</span>
<span class="n">building</span> <span class="bp">'/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">p6prlan0h9mlhkb9wbsg5cx8gmfxpda8</span><span class="bp">-</span><span class="n">Tests.HashString.drv'...</span>
<span class="n">Tests.HashString</span><span class="bp">&gt;</span> <span class="n">bash</span><span class="o">:</span> <span class="n">line</span> <span class="mi">7</span><span class="o">:</span>     <span class="mi">7</span> <span class="n">Segmentation</span> <span class="n">fault</span>      <span class="o">(</span><span class="n">core</span> <span class="n">dumped</span><span class="o">)</span> <span class="n">lean</span> <span class="bp">-</span><span class="n">o</span> <span class="bp">$</span><span class="n">out</span><span class="bp">/$</span><span class="n">oleanPath</span> <span class="bp">-</span><span class="n">c</span> <span class="bp">$</span><span class="n">c</span><span class="bp">/$</span><span class="n">cPath</span> <span class="bp">$</span><span class="n">leanPath</span> <span class="bp">$</span><span class="n">leanFlags</span> <span class="bp">$</span><span class="n">leanPluginFlags</span>
<span class="n">error</span><span class="o">:</span> <span class="n">builder</span> <span class="n">for</span> <span class="bp">'/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">p6prlan0h9mlhkb9wbsg5cx8gmfxpda8</span><span class="bp">-</span><span class="n">Tests.HashString.drv'</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">139</span><span class="bp">;</span>
       <span class="n">last</span> <span class="mi">1</span> <span class="n">log</span> <span class="n">lines</span><span class="o">:</span>
       <span class="bp">&gt;</span> <span class="n">bash</span><span class="o">:</span> <span class="n">line</span> <span class="mi">7</span><span class="o">:</span>     <span class="mi">7</span> <span class="n">Segmentation</span> <span class="n">fault</span>      <span class="o">(</span><span class="n">core</span> <span class="n">dumped</span><span class="o">)</span> <span class="n">lean</span> <span class="bp">-</span><span class="n">o</span> <span class="bp">$</span><span class="n">out</span><span class="bp">/$</span><span class="n">oleanPath</span> <span class="bp">-</span><span class="n">c</span> <span class="bp">$</span><span class="n">c</span><span class="bp">/$</span><span class="n">cPath</span> <span class="bp">$</span><span class="n">leanPath</span> <span class="bp">$</span><span class="n">leanFlags</span> <span class="bp">$</span><span class="n">leanPluginFlags</span>
       <span class="n">For</span> <span class="n">full</span> <span class="n">logs</span><span class="o">,</span> <span class="n">run</span> <span class="bp">'</span><span class="n">nix</span> <span class="n">log</span> <span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">p6prlan0h9mlhkb9wbsg5cx8gmfxpda8</span><span class="bp">-</span><span class="n">Tests.HashString.drv'.</span>
<span class="n">error</span><span class="o">:</span> <span class="mi">1</span> <span class="n">dependencies</span> <span class="n">of</span> <span class="n">derivation</span> <span class="bp">'/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">waq526gdyni9bim6cqgzgj5j78dq6v25</span><span class="bp">-</span><span class="n">Tests</span><span class="bp">-</span><span class="n">depRoot.drv'</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">build</span>
<span class="n">error</span><span class="o">:</span> <span class="mi">1</span> <span class="n">dependencies</span> <span class="n">of</span> <span class="n">derivation</span> <span class="bp">'/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">rxwqmvssr2di81i17bvk5f2nn7c2wk5c</span><span class="bp">-</span><span class="n">Tests</span><span class="bp">-</span><span class="n">depRoot.drv'</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">build</span>
</code></pre></div>



<a name="257690585"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257690585" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257690585">(Oct 15 2021 at 12:38)</a>:</h4>
<p>The type of the function doesn't seem to match the C function:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "blake3_hasher_update"]</span>
<span class="kd">constant</span> <span class="n">hasherUpdate</span> <span class="o">:</span> <span class="o">(</span><span class="n">hasher</span> <span class="o">:</span> <span class="n">Hasher</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="n">ByteArray</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">length</span> <span class="o">:</span> <span class="n">USize</span><span class="o">)</span> <span class="bp">→</span> <span class="n">Hasher</span>
</code></pre></div>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">blake3_hasher_update</span><span class="p">(</span><span class="n">blake3_hasher</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="kt">size_t</span><span class="w"> </span><span class="n">input_len</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>I'm not surprised that you get a segfault when converting <code>void</code> to <code>blake3_hasher *</code>.</p>



<a name="257691053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691053">(Oct 15 2021 at 12:42)</a>:</h4>
<p>True, but how do I correctly translate this mutable function?</p>



<a name="257691243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691243">(Oct 15 2021 at 12:43)</a>:</h4>
<p>I was hoping lean would give me a warning or somehow figure out how to link this signature correctly. How can I manage the c code generation to behave as I want?</p>



<a name="257691407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691407">(Oct 15 2021 at 12:44)</a>:</h4>
<p>It would be great if there was a lean-bindgen</p>



<a name="257691427"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691427" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691427">(Oct 15 2021 at 12:44)</a>:</h4>
<p>I would do the usual <code>implementedBy</code> </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">constant</span> <span class="n">HasherPointed</span> <span class="o">:</span> <span class="n">PointedType</span>
<span class="kd">def</span> <span class="n">Hasher</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="n">HasherPointed.type</span>
<span class="kd">instance</span> <span class="o">:</span> <span class="n">Inhabited</span> <span class="n">Hasher</span> <span class="o">:=</span> <span class="o">⟨</span><span class="n">HasherPointed.val</span><span class="o">⟩</span>

<span class="kd">@[extern "blake3_hasher_update"]</span>
<span class="kd">constant</span> <span class="n">hasherUpdateExtern</span> <span class="o">:</span> <span class="o">(</span><span class="n">hasher</span> <span class="o">:</span> <span class="n">Hasher</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="n">ByteArray</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">length</span> <span class="o">:</span> <span class="n">USize</span><span class="o">)</span> <span class="bp">→</span> <span class="n">IO</span> <span class="n">Unit</span>

<span class="n">unsafe</span> <span class="kd">def</span> <span class="n">unsafeIO'</span> <span class="o">[</span><span class="n">Inhabited</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">k</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="o">:=</span>
  <span class="k">match</span> <span class="n">unsafeIO</span> <span class="n">k</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">Except.ok</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">a</span>
  <span class="bp">|</span> <span class="n">Except.error</span> <span class="n">e</span> <span class="bp">=&gt;</span> <span class="n">panic</span> <span class="n">e.toString</span>

<span class="n">unsafe</span> <span class="kd">def</span> <span class="n">hasherUpdateImpl</span> <span class="o">(</span><span class="n">hasher</span> <span class="o">:</span> <span class="n">Hasher</span><span class="o">)</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="n">ByteArray</span><span class="o">)</span> <span class="o">(</span><span class="n">length</span> <span class="o">:</span> <span class="n">USize</span><span class="o">)</span> <span class="o">:</span> <span class="n">Hasher</span> <span class="o">:=</span>
  <span class="n">unsafeIO'</span> <span class="k">do</span>
    <span class="n">hasherUpdateExtern</span> <span class="n">hasher</span> <span class="n">input</span> <span class="n">length</span>
    <span class="n">hasher</span>

<span class="kd">@[implementedBy hasherUpdateImpl]</span>
<span class="kd">constant</span> <span class="n">hasherUpdate</span> <span class="o">(</span><span class="n">hasher</span> <span class="o">:</span> <span class="n">Hasher</span><span class="o">)</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="n">ByteArray</span><span class="o">)</span> <span class="o">(</span><span class="n">length</span> <span class="o">:</span> <span class="n">USize</span><span class="o">)</span> <span class="o">:</span> <span class="n">Hasher</span>
</code></pre></div>



<a name="257691466"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691466" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691466">(Oct 15 2021 at 12:45)</a>:</h4>
<p>There is probably an easier way to launder <code>IO</code> functions, but I can't remember it right now.</p>



<a name="257691468"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691468" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691468">(Oct 15 2021 at 12:45)</a>:</h4>
<p>it shouldn't be hard to write something to read the lean type and produce a plausible looking C header</p>



<a name="257691544"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691544" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691544">(Oct 15 2021 at 12:45)</a>:</h4>
<p>If we're already generating C code, then we could just do inline-c.lean</p>



<a name="257691612"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691612" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691612">(Oct 15 2021 at 12:46)</a>:</h4>
<p><a href="https://hackage.haskell.org/package/inline-c">https://hackage.haskell.org/package/inline-c</a></p>



<a name="257691652"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691652" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691652">(Oct 15 2021 at 12:46)</a>:</h4>
<p>An <code>unsafe</code> term-mode macro would also be convenient.</p>



<a name="257691714"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691714" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691714">(Oct 15 2021 at 12:46)</a>:</h4>
<p>Is there a way to write entire C functions in lean? I recall seeing some way to do this with little snippets like <code>(float)(x + y)</code> but I would rather not do a whole function like that</p>



<a name="257691814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257691814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257691814">(Oct 15 2021 at 12:47)</a>:</h4>
<p>but it would be nice to be able to write the shim from lean ABI to a normal looking C function in a bit of lean code</p>



<a name="257692800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257692800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257692800">(Oct 15 2021 at 12:55)</a>:</h4>
<blockquote>
<p>recall seeing some way to do this with little snippets like (float)(x + y) but I would rather not do a whole function like that</p>
</blockquote>
<p>There's no law that requires you to write that string manually. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>  If you're willing to use gcc, then you can even define functions in that string:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="p">({</span><span class="w"></span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="nf">my_function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">my_function</span><span class="p">();</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
<p>And then we could make Lean macros that expand into that attribute:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">frob</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Float</span><span class="o">)</span> <span class="o">:</span> <span class="n">Float</span> <span class="o">:=</span>
  <span class="n">inlineC</span>
    <span class="n">float</span> <span class="n">x</span> <span class="bp">=</span> <span class="bp">$</span><span class="n">x</span><span class="bp">;</span>
    <span class="n">for</span> <span class="o">(</span><span class="n">int</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span><span class="bp">;</span> <span class="n">i</span> <span class="bp">&lt;</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">x</span> <span class="bp">=</span> <span class="n">cosf</span><span class="o">(</span><span class="n">x</span><span class="o">)</span><span class="bp">;</span>
    <span class="o">}</span>
    <span class="n">return</span> <span class="n">x</span><span class="bp">;</span>
</code></pre></div>
<p>Other options include generating a C source file as a side effect, or adding support to lean for extra C source code output.</p>



<a name="257693239"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257693239" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257693239">(Oct 15 2021 at 12:58)</a>:</h4>
<p>Yeah, I thought about using <code>({ ... })</code> here, but it would be nice to have something more "official" from the compiler</p>



<a name="257693433"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257693433" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257693433">(Oct 15 2021 at 13:00)</a>:</h4>
<p>Generating a C source file sounds like it would be hell for <code>lake</code></p>



<a name="257693621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257693621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257693621">(Oct 15 2021 at 13:01)</a>:</h4>
<p>The other interesting question is how to add <code>#include &lt;...&gt;</code>, I'm not sure if that's possible atm.</p>



<a name="257693882"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257693882" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257693882">(Oct 15 2021 at 13:02)</a>:</h4>
<p>I think the ideal low level interface would just be something like <code>Compiler.addIncludeFile "windows.h"</code> or <code>Compiler.addCFunction "float foo() { return 42; }"</code> which just gets added to the list of functions to emit for the current file</p>



<a name="257693969"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257693969" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257693969">(Oct 15 2021 at 13:03)</a>:</h4>
<p>This also depends  heavily on which direction one wants Lean to go. PR <a href="https://github.com/leanprover/lean4/pull/694">#694</a> is all about removing inline C code from Lean (so it can support other backends -- such as LLVM). I think adding an inline C dialect would be moving further in a direction that Lean probably doesn't want to go.</p>



<a name="257694542"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257694542" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257694542">(Oct 15 2021 at 13:07)</a>:</h4>
<p>Tough, if the idea is that such inline C would generate a separate C file that is compiled and linked into the package separately rather than be part of the current C emitter that would probably still be supportable by alternative backends. Thus, such an approach may still be feasible.</p>



<a name="257694619"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257694619" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257694619">(Oct 15 2021 at 13:08)</a>:</h4>
<p>This procedure with an IO binding and an unsafeIO' to convert it into a pure function could be made into a general bind_gen-like macro.</p>



<a name="257694748"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257694748" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257694748">(Oct 15 2021 at 13:09)</a>:</h4>
<p>Well, <code>hasherUpdate</code> in that snippet isn't really <em>safe</em>; it modifies the hasher in-place, so it's not referentially transparent</p>



<a name="257694876"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257694876" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257694876">(Oct 15 2021 at 13:10)</a>:</h4>
<p>A correct implementation should check the refcount and make a copy if it is shared first</p>



<a name="257694944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257694944" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257694944">(Oct 15 2021 at 13:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/257691427">said</a>:</p>
<blockquote>
<p>I would do the usual <code>implementedBy</code> </p>
</blockquote>
<p>I was also under the impression using <code>unsafeIO</code> was heavily discouraged. Is that right, <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> ?</p>



<a name="257695142"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257695142" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257695142">(Oct 15 2021 at 13:12)</a>:</h4>
<p>Ok, so the lean compiler can't detect such problems?</p>



<a name="257695200"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257695200" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257695200">(Oct 15 2021 at 13:12)</a>:</h4>
<p>no</p>



<a name="257695225"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257695225" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257695225">(Oct 15 2021 at 13:13)</a>:</h4>
<p>The lean compiler is barely involved. The shim would normally be the one to handle this</p>



<a name="257695315"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257695315" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257695315">(Oct 15 2021 at 13:13)</a>:</h4>
<p>It is weird to me that your extern function doesn't have more <code>lean_object *</code> in it</p>



<a name="257695936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257695936" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257695936">(Oct 15 2021 at 13:18)</a>:</h4>
<p>Correct me if I'm wrong, but I think the right companion to:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "blake3_hasher_update"]</span>
<span class="kd">constant</span> <span class="n">hasherUpdate</span> <span class="o">:</span> <span class="o">(</span><span class="n">hasher</span> <span class="o">:</span> <span class="n">Hasher</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="bp">@&amp;</span> <span class="n">ByteArray</span><span class="o">)</span> <span class="bp">→</span> <span class="o">(</span><span class="n">length</span> <span class="o">:</span> <span class="n">USize</span><span class="o">)</span> <span class="bp">→</span> <span class="n">Hasher</span>
</code></pre></div>
<p>is</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="n">lean_obj_res</span><span class="w"> </span><span class="nf">blake3_hasher_update</span><span class="p">(</span><span class="n">lean_obj_arg</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">b_lean_obj_arg</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">input_len</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="257696603"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257696603" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257696603">(Oct 15 2021 at 13:23)</a>:</h4>
<p><span class="user-mention" data-user-id="315577">@Mac</span> Thinking about it some more, I don't think we can get away from usage of C in conjunction with lean. The whole lean API is written in C; how are you going to deal with <code>lean_unbox</code>, <code>lean_inc</code> etc otherwise?</p>



<a name="257696755"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257696755" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257696755">(Oct 15 2021 at 13:24)</a>:</h4>
<p>For writing code that works with lean FFI, you either have to write C or something about as complicated that binds to all these functions</p>



<a name="257697888"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257697888" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257697888">(Oct 15 2021 at 13:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/257696603">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> Thinking about it some more, I don't think we can get away from usage of C in conjunction with lean. The whole lean API is written in C; how are you going to deal with <code>lean_unbox</code>, <code>lean_inc</code> etc otherwise?</p>
</blockquote>
<p>But the C API is just linked in. It's source language is irrelevant. Lean can emit whatever it wants without that mattering.</p>



<a name="257697922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257697922" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257697922">(Oct 15 2021 at 13:33)</a>:</h4>
<p>But that is not the signature I have and I don't want to change stuff in the BLAKE3 c implementation.</p>



<a name="257697951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257697951" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257697951">(Oct 15 2021 at 13:33)</a>:</h4>
<p>that's why there is a shim</p>



<a name="257698015"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698015" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698015">(Oct 15 2021 at 13:34)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> you need to write glue code to translate between the two</p>



<a name="257698035"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698035" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698035">(Oct 15 2021 at 13:34)</a>:</h4>
<p>and <span class="user-mention" data-user-id="315577">@Mac</span> what language should the shim be written in?</p>



<a name="257698104"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698104" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698104">(Oct 15 2021 at 13:35)</a>:</h4>
<p>Theoretically it can be anything that understands the C ABI, but I don't think we want to be writing LLVM</p>



<a name="257698119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698119">(Oct 15 2021 at 13:35)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> C is fine.  But so is C++/C#/Rust/whatever. The shim is also linked in, it source language is relevant.</p>



<a name="257698268"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698268" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698268">(Oct 15 2021 at 13:36)</a>:</h4>
<p><span class="user-mention" data-user-id="315577">@Mac</span> Is there no way around? Some functionality in lean for specifying this perhaps?</p>



<a name="257698274"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698274" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698274">(Oct 15 2021 at 13:36)</a>:</h4>
<p>I agree with you, but you have to make a choice somehow, and ideally one that doesn't make building it a nightmare</p>



<a name="257698294"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698294" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698294">(Oct 15 2021 at 13:36)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> It is important that this not just a me issue, there are multiple other people writing alternative backends for Lean. After all, PR <a href="https://github.com/leanprover/lean4/pull/694">#694</a> wasn't mine.</p>



<a name="257698360"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698360" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698360">(Oct 15 2021 at 13:37)</a>:</h4>
<p>Separate linking is a fine technical solution, but the build tool needs to understand what's going on</p>



<a name="257698437"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698437" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698437">(Oct 15 2021 at 13:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="433842">Anders Christiansen Sørby</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/257698268">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> Is there no way around? Some functionality in lean for specifying this perhaps?</p>
</blockquote>
<p>Sadly, at the moment, the answer to this is a big no. Lean unfortunately currently supports very few external types (directly). Just uint8/16/32/64 and double -- that's it.</p>



<a name="257698574"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698574" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698574">(Oct 15 2021 at 13:38)</a>:</h4>
<p>Gabriel's solution with inline C seems plausible for the present</p>



<a name="257698589"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698589" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698589">(Oct 15 2021 at 13:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/257698360">said</a>:</p>
<blockquote>
<p>Separate linking is a fine technical solution, but the build tool needs to understand what's going on</p>
</blockquote>
<p>Yeah, and <code>lake</code> already does.</p>



<a name="257698652"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698652" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698652">(Oct 15 2021 at 13:39)</a>:</h4>
<p>How does lake handle this now?</p>



<a name="257698686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698686" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698686">(Oct 15 2021 at 13:39)</a>:</h4>
<p><a href="https://github.com/leanprover/lake/tree/master/examples/ffi">https://github.com/leanprover/lake/tree/master/examples/ffi</a></p>



<a name="257698969"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257698969" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257698969">(Oct 15 2021 at 13:41)</a>:</h4>
<p>I kind of want to try Lean + Rust FFI now</p>



<a name="257699293"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257699293" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257699293">(Oct 15 2021 at 13:43)</a>:</h4>
<p><span class="user-mention" data-user-id="315577">@Mac</span> So the solution of <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> would not work? I'm wondering how to proceed with this now.</p>



<a name="257700219"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257700219" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257700219">(Oct 15 2021 at 13:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/257698574">said</a>:</p>
<blockquote>
<p>Gabriel's solution with inline C seems plausible for the present</p>
</blockquote>
<p>I think an inline C solution that produced a separate C shim that was compiled and linked separately could be quite desirable . For one, It would keep the C source and Lean bindings tied together in the source. For example:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">extern</span> <span class="n">c</span> <span class="kd">def</span> <span class="n">frob</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Float</span><span class="o">)</span> <span class="o">:</span> <span class="n">Float</span> <span class="o">:=</span>
  <span class="n">for</span> <span class="o">(</span><span class="n">int</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span><span class="bp">;</span> <span class="n">i</span> <span class="bp">&lt;</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">x</span> <span class="bp">=</span> <span class="n">cosf</span><span class="o">(</span><span class="n">x</span><span class="o">)</span><span class="bp">;</span>
  <span class="o">}</span>
  <span class="n">return</span> <span class="n">x</span><span class="bp">;</span>
</code></pre></div>
<p>would compile to </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "frob"]</span>
<span class="kd">def</span> <span class="n">frob</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Float</span><span class="o">)</span> <span class="o">:</span> <span class="n">Float</span>
</code></pre></div>
<p>and</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">double</span><span class="w"> </span><span class="nf">frob</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cosf</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="257700438"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257700438" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257700438">(Oct 15 2021 at 13:50)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> I think Mac's solution is easier to work from since it's a complete worked example and I imagine you will have a decent amount of shim code, not to mention linking with the blake headers</p>



<a name="257700517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257700517" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257700517">(Oct 15 2021 at 13:51)</a>:</h4>
<p>Is this valid source?<br>
I see in the generated C code that it generates <code>lean_object *</code> for all non-trivial types.</p>



<a name="257700672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257700672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257700672">(Oct 15 2021 at 13:52)</a>:</h4>
<p><code>lean_obj_arg</code> is used for all types except "unboxed" scalar types, which means basically <code>USize</code>, <code>UInt64</code>, <code>UInt32</code>, <code>Float</code> and maybe a few others</p>



<a name="257701048"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257701048" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257701048">(Oct 15 2021 at 13:54)</a>:</h4>
<p>and <code>b_lean_obj_arg</code> is used when the object is "borrowed" i.e., defined with <code>(foo : @&amp; Foo)</code> -- which means the caller does not increment the reference counter.</p>



<a name="257701257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257701257" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257701257">(Oct 15 2021 at 13:55)</a>:</h4>
<p>But I don't see entirely how to use this solution. Do I have to create an entire intermediary c-lib that includes lean.h?</p>



<a name="257701521"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257701521" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257701521">(Oct 15 2021 at 13:57)</a>:</h4>
<p>yes</p>



<a name="257701553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257701553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257701553">(Oct 15 2021 at 13:57)</a>:</h4>
<p>well, a file at least</p>



<a name="257701808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257701808" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257701808">(Oct 15 2021 at 13:59)</a>:</h4>
<p>it should probably be compiled at least to a static library as each dependent of your library will also need to link it in.</p>



<a name="257703205"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257703205" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257703205">(Oct 15 2021 at 14:07)</a>:</h4>
<p>Where is <code>lean.h</code> anyway? The one in the source depends on <code>config.h</code> that doesn't exist, and I can't find any file called <code>lean.h</code> in the nightlies</p>



<a name="257703208"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257703208" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257703208">(Oct 15 2021 at 14:07)</a>:</h4>
<blockquote>
<p>[whole discussion about "could we have API interfaces without C?"]</p>
</blockquote>
<p>I don't think that we be a big problem as long as we have enough "intrinsics", i.e., IO functions that operate on pointers, that can access refcounts, etc.  And also a way to link to libraries and call exported functions.  <a href="https://docs.python.org/3/library/ctypes.html">ctypes</a> works quite well in python.</p>



<a name="257703808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257703808" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257703808">(Oct 15 2021 at 14:10)</a>:</h4>
<p><a href="https://github.com/leanprover/lean4/blob/master/src/include/lean/lean.h">https://github.com/leanprover/lean4/blob/master/src/include/lean/lean.h</a></p>



<a name="257703886"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257703886" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257703886">(Oct 15 2021 at 14:11)</a>:</h4>
<p>I know about that, I'm asking how to make a C compiler approved <code>lean.h</code></p>



<a name="257703980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257703980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257703980">(Oct 15 2021 at 14:12)</a>:</h4>
<p><code>lean.h</code> contains <code>#include &lt;lean/config.h&gt;</code> and there is no file called <code>config.h</code> in the distribution</p>



<a name="257704111"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257704111" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257704111">(Oct 15 2021 at 14:12)</a>:</h4>
<p>there is a <code>config.h.in</code> that is apparently built into <code>config.h</code> but I don't want to build lean from source</p>



<a name="257704164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257704164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257704164">(Oct 15 2021 at 14:13)</a>:</h4>
<p>Looks fine to me</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="n">ls</span> <span class="n">lean</span><span class="bp">-</span><span class="mi">4</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">0</span><span class="bp">-</span><span class="n">nightly</span><span class="bp">-</span><span class="mi">2021</span><span class="bp">-</span><span class="mi">10</span><span class="bp">-</span><span class="mi">13</span><span class="bp">-</span><span class="n">linux</span><span class="bp">/</span><span class="kn">include</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span>
<span class="n">config.h</span>  <span class="n">lean.h</span>  <span class="n">lean_gmp.h</span>  <span class="n">version.h</span>
</code></pre></div>



<a name="257704381"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257704381" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257704381">(Oct 15 2021 at 14:14)</a>:</h4>
<p>that's odd:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="n">ls</span> <span class="bp">-</span><span class="n">al</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly/lib/lean/src/include/lean/</span>
<span class="n">total</span> <span class="mi">8</span>
<span class="n">drwxr</span><span class="bp">-</span><span class="n">xr</span><span class="bp">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">mario</span> <span class="n">mario</span> <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">29</span> <span class="mi">01</span><span class="o">:</span><span class="mi">47</span> <span class="bp">./</span>
<span class="n">drwxr</span><span class="bp">-</span><span class="n">xr</span><span class="bp">-</span><span class="n">x</span> <span class="mi">3</span> <span class="n">mario</span> <span class="n">mario</span> <span class="mi">4096</span> <span class="n">Sep</span> <span class="mi">29</span> <span class="mi">01</span><span class="o">:</span><span class="mi">47</span> <span class="bp">../</span>
</code></pre></div>



<a name="257704472"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257704472" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257704472">(Oct 15 2021 at 14:15)</a>:</h4>
<p>Latest as well?</p>



<a name="257704540"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257704540" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257704540">(Oct 15 2021 at 14:15)</a>:</h4>
<p>yes</p>



<a name="257704774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257704774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257704774">(Oct 15 2021 at 14:17)</a>:</h4>
<p>Do I have to fill in the <code>lean_object*</code> struct by hand? Or is there an easier way of doing this?</p>



<a name="257705019"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257705019" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257705019">(Oct 15 2021 at 14:18)</a>:</h4>
<p>use <code>lean_alloc_external</code> to create one, and <code>lean_is_exclusive</code> to do the copy on write stuff</p>



<a name="257705087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257705087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257705087">(Oct 15 2021 at 14:18)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> no, you use one of the API methods to create objects of <code>lean_object*</code> -- which you use depends on what object you are trying to construct.</p>



<a name="257705213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257705213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257705213">(Oct 15 2021 at 14:19)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Not sure what to say...</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>  <span class="n">leanprover</span><span class="bp">/</span><span class="n">lean4</span><span class="o">:</span><span class="n">nightly</span> <span class="n">unchanged</span> <span class="bp">-</span> <span class="n">Lean</span> <span class="o">(</span><span class="n">version</span> <span class="mi">4</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">0</span><span class="bp">-</span><span class="n">nightly</span><span class="bp">-</span><span class="mi">2021</span><span class="bp">-</span><span class="mi">10</span><span class="bp">-</span><span class="mi">13</span><span class="o">,</span> <span class="n">commit</span> <span class="mi">66</span><span class="n">fcfcce3716</span><span class="o">,</span> <span class="n">Release</span><span class="o">)</span>

<span class="bp">$</span> <span class="n">ls</span> <span class="bp">-</span><span class="n">l</span> <span class="bp">.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly/include/lean/</span>
<span class="bp">.</span><span class="n">rw</span><span class="bp">-</span><span class="n">r</span><span class="c1">--r-- 259 sebastian  1 Jan  1970 config.h</span>
<span class="bp">.</span><span class="n">rw</span><span class="bp">-</span><span class="n">r</span><span class="c1">--r-- 73k sebastian  1 Jan  1970 lean.h</span>
<span class="bp">.</span><span class="n">rw</span><span class="bp">-</span><span class="n">r</span><span class="c1">--r-- 551 sebastian  1 Jan  1970 lean_gmp.h</span>
<span class="bp">.</span><span class="n">rw</span><span class="bp">-</span><span class="n">r</span><span class="c1">--r-- 405 sebastian  1 Jan  1970 version.h</span>
</code></pre></div>



<a name="257705513"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257705513" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257705513">(Oct 15 2021 at 14:21)</a>:</h4>
<p>Oh, that's not the same folder</p>



<a name="257705549"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257705549" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257705549">(Oct 15 2021 at 14:21)</a>:</h4>
<p>I was in <code>lib/lean/src/include/lean/</code></p>



<a name="257705576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257705576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257705576">(Oct 15 2021 at 14:21)</a>:</h4>
<p>Oh :)</p>



<a name="257706949"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257706949" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257706949">(Oct 15 2021 at 14:30)</a>:</h4>
<p>I've tried this, but how do i go from <code>char *</code> to <code>lean_object *</code>? </p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="n">LEAN_SHARED</span><span class="w"> </span><span class="n">lean_obj_res</span><span class="w"> </span><span class="n">lean_string_mk</span><span class="p">(</span><span class="n">lean_obj_arg</span><span class="w"> </span><span class="n">cs</span><span class="p">);</span><span class="w"></span>

<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="nf">l_blake3_version</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blake3_version</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">lean_obj_res</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_string_mk</span><span class="p">(</span><span class="n">v</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I can't find any api function for doing this conversion.</p>



<a name="257707324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257707324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257707324">(Oct 15 2021 at 14:32)</a>:</h4>
<p>I think this is what the shim should look like:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;lean/lean.h&gt;</span><span class="cp"></span>

<span class="c1">// replace with #include &lt;blake3.h&gt;</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="nc">blake3_hasher</span><span class="w"> </span><span class="n">blake3_hasher</span><span class="p">;</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">blake3_hasher</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">blake3_hasher_copy</span><span class="p">(</span><span class="n">blake3_hasher</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">);</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">blake3_hasher_update</span><span class="p">(</span><span class="n">blake3_hasher</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">input_len</span><span class="p">);</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">blake3_hasher_free</span><span class="p">(</span><span class="n">blake3_hasher</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">);</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="n">lean_external_class</span><span class="w"> </span><span class="o">*</span><span class="n">g_blake3_hasher_external_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">blake3_hasher_finalizer</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">blake3_hasher_free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">inline</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">blake3_hasher_foreach</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">b_lean_obj_arg</span><span class="w"> </span><span class="n">fn</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="n">lean_obj_res</span><span class="w"> </span><span class="nf">blake3_initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">g_blake3_hasher_external_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_register_external_class</span><span class="p">(</span><span class="n">blake3_hasher_finalizer</span><span class="p">,</span><span class="w"> </span><span class="n">blake3_hasher_foreach</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">lean_io_result_mk_ok</span><span class="p">(</span><span class="n">lean_box</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">lean_obj_res</span><span class="w"> </span><span class="nf">lean_ensure_exclusive_blake3_hasher</span><span class="p">(</span><span class="n">lean_obj_arg</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lean_is_exclusive</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lean_alloc_external</span><span class="p">(</span><span class="n">g_blake3_hasher_external_class</span><span class="p">,</span><span class="w"> </span><span class="n">blake3_hasher_copy</span><span class="p">(</span><span class="n">a</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">lean_obj_res</span><span class="w"> </span><span class="nf">lean_blake3_hasher_update</span><span class="p">(</span><span class="n">lean_obj_arg</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">b_lean_obj_arg</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">input_len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_ensure_exclusive_blake3_hasher</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">blake3_hasher_update</span><span class="p">(</span><span class="n">lean_get_external_data</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="n">lean_sarray_cptr</span><span class="p">(</span><span class="n">input</span><span class="p">),</span><span class="w"> </span><span class="n">input_len</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="257707741"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257707741" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257707741">(Oct 15 2021 at 14:35)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> You should use <code>lean_mk_string</code> not <code>lean_string_mk</code></p>



<a name="257707930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257707930" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257707930">(Oct 15 2021 at 14:36)</a>:</h4>
<p>There are some lean examples that just inline it:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="sd">/-- Additional version description like "nightly-2018-03-11" -/</span>
<span class="kd">@[extern c inline "lean_mk_string(LEAN_SPECIAL_VERSION_DESC)"]</span>
<span class="kd">constant</span> <span class="n">version.getSpecialDesc</span> <span class="o">(</span><span class="n">u</span> <span class="o">:</span> <span class="n">Unit</span><span class="o">)</span> <span class="o">:</span> <span class="n">String</span>
</code></pre></div>



<a name="257723163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257723163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xubai Wang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257723163">(Oct 15 2021 at 16:10)</a>:</h4>
<p>(deleted)</p>



<a name="257821705"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257821705" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257821705">(Oct 16 2021 at 10:43)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Where do I find the header files in the nix build?</p>



<a name="257823494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257823494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257823494">(Oct 16 2021 at 11:13)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> <code>lean-bin-tools-unwrapped</code>, <a href="https://github.com/leanprover/lean4/blob/8d10197164830e3e8cbc6ed321e5fe920299c162/nix/bootstrap.nix#L108">https://github.com/leanprover/lean4/blob/8d10197164830e3e8cbc6ed321e5fe920299c162/nix/bootstrap.nix#L108</a></p>



<a name="257823603"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/257823603" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#257823603">(Oct 16 2021 at 11:15)</a>:</h4>
<p>There's also <code>lean-all</code> that is mostly equivalent to the release tarballs, but that is intended more for interactive use than as a build dependency</p>



<a name="258232087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258232087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258232087">(Oct 19 2021 at 16:59)</a>:</h4>
<p>I still have some issues with building. Why doesn't the extern detect the declaration in the c-shim?<br>
The full example can be found at <br>
<a href="https://github.com/yatima-inc/lean-blake3">https://github.com/yatima-inc/lean-blake3</a><br>
and by running <code>nix build .#tests -L</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Tests.HashString</span><span class="bp">&gt;</span> <span class="n">could</span> <span class="n">not</span> <span class="n">find</span> <span class="n">native</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">external</span> <span class="n">declaration</span> <span class="bp">'</span><span class="n">Blake3.internalVersion'</span> <span class="o">(</span><span class="n">symbols</span> <span class="bp">'</span><span class="n">l_Blake3_internalVersion___boxed'</span> <span class="n">or</span> <span class="bp">'</span><span class="n">l_Blake3_internalVersion'</span><span class="o">)</span>
</code></pre></div>
<p>Do I need to do some additional linking? Why is there no warning that the linking failed when building just the module?</p>



<a name="258233608"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258233608" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xubai Wang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258233608">(Oct 19 2021 at 17:04)</a>:</h4>
<p>Maybe it's that <code>l_blake3_version</code> declared with <code>static</code>? Static functions are not visible to other files.</p>



<a name="258238046"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258238046" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258238046">(Oct 19 2021 at 17:28)</a>:</h4>
<p>Didn't work now either.</p>



<a name="258238883"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258238883" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258238883">(Oct 19 2021 at 17:33)</a>:</h4>
<p><code>nix build .#modRoot</code> does work though</p>



<a name="258239632"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258239632" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258239632">(Oct 19 2021 at 17:37)</a>:</h4>
<p>But this doesn't require any linking apparently, because it runs without including the static library.</p>



<a name="258245576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258245576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258245576">(Oct 19 2021 at 18:11)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> what is the <code>lean</code> command being used to run these tests?</p>



<a name="258245766"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258245766" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258245766">(Oct 19 2021 at 18:12)</a>:</h4>
<p>It is essentially leanc and lean using the <code>buildLeanPackage</code> nix function</p>



<a name="258245993"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258245993" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258245993">(Oct 19 2021 at 18:13)</a>:</h4>
<p>is there any way to get the exact <code>lean</code> inovaction?</p>



<a name="258246408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258246408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258246408">(Oct 19 2021 at 18:16)</a>:</h4>
<p>if you want to use C bindings in at interpretation time you need to pass the package (i.e., <code>Blake3</code>) as a shared library built with <code>leanc -shared</code> to <code>lean</code> as a <code>--plugin</code></p>



<a name="258257020"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258257020" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258257020">(Oct 19 2021 at 19:25)</a>:</h4>
<p>Thanks that lead me on the right track. I need to use the <code>pluginDeps</code> option to get libraries passed to <code>--plugin</code>. I was using <code>staticLibDeps</code>. This could use a lot more docs.</p>



<a name="258358784"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258358784" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258358784">(Oct 20 2021 at 12:37)</a>:</h4>
<p>I've added freeing and copy functions to <code>blake3_hasher*</code> even though this is not supported in the original API. How do I wrap this inside a <code>lean_object*</code> so that it can be used within the language?</p>



<a name="258358968"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258358968" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258358968">(Oct 20 2021 at 12:38)</a>:</h4>
<p>I think it would look like my long post above</p>



<a name="258359603"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258359603" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258359603">(Oct 20 2021 at 12:42)</a>:</h4>
<p>Yes, that was very helpful, but how do I extract the data from the <code>lean_external_object*</code> so that I can do a copy or free data?</p>



<a name="258359681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258359681" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258359681">(Oct 20 2021 at 12:42)</a>:</h4>
<p>Note that both <code>copy</code> and <code>free</code> are called in the code there</p>



<a name="258359813"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258359813" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258359813">(Oct 20 2021 at 12:44)</a>:</h4>
<p>the free function is called in the finalizer that gets passed to <code>lean_register_external_class</code>, and the copy function is called by <code>lean_ensure_exclusive_blake3_hasher</code> which is used in any mutating function</p>



<a name="258360599"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258360599" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258360599">(Oct 20 2021 at 12:49)</a>:</h4>
<p>Yes, but those functions needs to be implemented and they are also working on the wrong type. I need to access the external data wrapped inside the <code>lean_object*</code> created by the <code>lean_alloc_external</code>. Is is safe to just do <code>l-&gt;data</code>?</p>



<a name="258360732"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258360732" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258360732">(Oct 20 2021 at 12:50)</a>:</h4>
<p>I see there is a function for that.</p>



<a name="258361110"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258361110" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258361110">(Oct 20 2021 at 12:52)</a>:</h4>
<p>I don't follow. Both <code>blake3_hasher_copy</code> and <code>blake3_hasher_free</code> should have natural types there, those are the functions you are supposed to implement</p>



<a name="258361205"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258361205" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258361205">(Oct 20 2021 at 12:53)</a>:</h4>
<p>Is it necessary to assert the type of the <code>lean_object*</code> btw?</p>



<a name="258361282"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258361282" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258361282">(Oct 20 2021 at 12:54)</a>:</h4>
<p>dunno, are you ok with UB if it's not true?</p>



<a name="258361394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258361394" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258361394">(Oct 20 2021 at 12:54)</a>:</h4>
<p>In your snippet you used <code>blake3_hasher*</code> but their types are <code>lean_object*</code> I just need to transform form that</p>



<a name="258361489"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258361489" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258361489">(Oct 20 2021 at 12:55)</a>:</h4>
<p>Could you show your code or a snippet thereof? The code I posted is type correct and passes a C compiler</p>



<a name="258362476"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258362476" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258362476">(Oct 20 2021 at 13:01)</a>:</h4>
<p>I got a lot of warnings when running that.<br>
My attempt so far:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * Copy the contents of the hasher to a new memory location.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">blake3_hasher_copy</span><span class="p">(</span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">blake3_hasher</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">blake3_hasher</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">lean_get_external_data</span><span class="p">(</span><span class="n">self</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">blake3_hasher</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">blake3_hasher</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="n">copy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">lean_alloc_external</span><span class="p">(</span><span class="n">g_blake3_hasher_external_class</span><span class="p">,</span><span class="w"> </span><span class="n">copy</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm"> * Free the memory for this hasher. This makes all other references to this address invalid.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">blake3_hasher_free</span><span class="p">(</span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">blake3_hasher</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">blake3_hasher</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">lean_get_external_data</span><span class="p">(</span><span class="n">self</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Mark memory as available</span>
<span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258362814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258362814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258362814">(Oct 20 2021 at 13:03)</a>:</h4>
<p>I guess I could add this assert at the start of those functions, but is it really necessary?</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="n">assert</span><span class="p">(</span><span class="n">lean_get_external_class</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">g_blake3_hasher_external_class</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="258364903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258364903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258364903">(Oct 20 2021 at 13:16)</a>:</h4>
<p>Now it compiles without warning, but I wonder how to use the lean command correctly (from nix). When building the package I get:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Blake3</span><span class="bp">&gt;</span> <span class="n">terminate</span> <span class="n">called</span> <span class="n">after</span> <span class="n">throwing</span> <span class="n">an</span> <span class="kd">instance</span> <span class="n">of</span> <span class="bp">'</span><span class="n">lean</span><span class="o">::</span><span class="n">exception'</span>
<span class="n">Blake3</span><span class="bp">&gt;</span>   <span class="n">what</span><span class="o">():</span>  <span class="n">error</span> <span class="n">loading</span> <span class="n">plugin</span><span class="o">,</span> <span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">p7pjngnra1z3vr59rxnqgh4kfa3nfbf7</span><span class="bp">-</span><span class="n">libblake3.so</span><span class="bp">/</span><span class="n">libblake3.so</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">blake3_version</span>
<span class="n">Blake3</span><span class="bp">&gt;</span> <span class="n">bash</span><span class="o">:</span> <span class="n">line</span> <span class="mi">7</span><span class="o">:</span>     <span class="mi">7</span> <span class="n">Aborted</span>                 <span class="o">(</span><span class="n">core</span> <span class="n">dumped</span><span class="o">)</span> <span class="n">lean</span> <span class="bp">-</span><span class="n">o</span> <span class="bp">$</span><span class="n">out</span><span class="bp">/$</span><span class="n">oleanPath</span> <span class="bp">-</span><span class="n">c</span> <span class="bp">$</span><span class="n">c</span><span class="bp">/$</span><span class="n">cPath</span> <span class="bp">$</span><span class="n">leanPath</span> <span class="bp">$</span><span class="n">leanFlags</span> <span class="bp">$</span><span class="n">leanPluginFlags</span>
</code></pre></div>
<p>What sort of <code>--plugin</code> arguments are necessary to link this correctly?</p>



<a name="258381833"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258381833" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258381833">(Oct 20 2021 at 14:52)</a>:</h4>
<p>Who is calling those functions? Are these functions exposed directly to lean?</p>



<a name="258381991"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258381991" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258381991">(Oct 20 2021 at 14:53)</a>:</h4>
<p><code>blake3_hasher_free</code> definitely looks like a not safe thing to do</p>



<a name="258387185"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258387185" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258387185">(Oct 20 2021 at 15:22)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> </p>
<p>Some notes:</p>
<ol>
<li>It would be wiser to use a function like the following to access the external class:</li>
</ol>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">lean_external_class</span><span class="o">*</span><span class="w"> </span><span class="nf">get_blake3_hasher_class</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Use static to make this thread safe by static initialization rules.</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">lean_external_class</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">lean_register_external_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blake3_hasher_finalizer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">blake3_hasher_foreach</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This ensure the class is always properly initialized before use.</p>
<ol start="2">
<li>Looking at your code in <a href="https://github.com/yatima-inc/lean-blake3/blob/fad8c8e6263c7abb3f0e18f725fa0974e45960b6/c/blake3-shim.c#L41-L43"><code>blake3-shim.c</code></a>, <code>blake3_hasher_finalizer</code> calls <code>blake3_hashe_free</code> which is just wrong. The finalizer is past the external pointer (i.e., the <code>blake3_hasher</code>) not the <code>lean_object*</code>.</li>
</ol>



<a name="258431291"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258431291" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258431291">(Oct 20 2021 at 19:42)</a>:</h4>
<p><span class="user-mention" data-user-id="315577">@Mac</span> I don't understand. Is the finalizer not supposed to free the memory? I noticed there was a type error there which I have fixed.</p>



<a name="258431881"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258431881" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258431881">(Oct 20 2021 at 19:46)</a>:</h4>
<p>This doesn't solve my other problem of getting lean to correctly link the plugin.</p>



<a name="258432629"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258432629" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258432629">(Oct 20 2021 at 19:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="433842">Anders Christiansen Sørby</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/258431291">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> I don't understand. Is the finalizer not supposed to free the memory? I noticed there was a type error there which I have fixed.</p>
</blockquote>
<p>No, the finalizer is suppose to free memory. My point was simply that the pointer it receives is a the <code>blake3_hasher</code> directly and not its the <code>lean_object</code> that wraps it.</p>



<a name="258432772"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258432772" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258432772">(Oct 20 2021 at 19:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="433842">Anders Christiansen Sørby</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/258431881">said</a>:</p>
<blockquote>
<p>This doesn't solve my other problem of getting lean to correctly link the plugin.</p>
</blockquote>
<p>The problem here is that the plugin you are passing is a shared library compiled from the shim itself rather than from the entire Lean module linked with the shim. That is, the plugin is suppose to be the entire <code>Blake3</code> Lean package not just the shim (and thus the package itself doesn't need the plugin).</p>



<a name="258433961"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258433961" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258433961">(Oct 20 2021 at 19:59)</a>:</h4>
<p>Ok, that is what I suspected. But how do I compile the Blake3 module together with the shim?</p>



<a name="258442944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258442944" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258442944">(Oct 20 2021 at 20:57)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> just compile the shim into a static library and pass it an additional static library o the lean package build.</p>



<a name="258507635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258507635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258507635">(Oct 21 2021 at 08:36)</a>:</h4>
<p>That is what I was doing before and it didn't work. Including the staticLib as a dependency to the build command. I'll experiement some more. Where can I find docs and code for the <code>lean</code> command?</p>
<p>Using <code>get_blake3_hasher_class</code> leads to the error: <code>initializer element is not constant</code>. Is there another way to do this?</p>



<a name="258510418"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258510418" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258510418">(Oct 21 2021 at 08:59)</a>:</h4>
<p>This is not how the lean source does it. It uses Mario's solution. Is this some new C/C++ feature?</p>



<a name="258510783"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258510783" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258510783">(Oct 21 2021 at 09:02)</a>:</h4>
<p>It's C++, but I suspect it won't work anyway because the Lean data structures are not yet initialized at that point. It's a classic case of the static initialization order fiasco (except that Lean doesn't use static initialization for this very reason).</p>



<a name="258556457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258556457" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258556457">(Oct 21 2021 at 14:34)</a>:</h4>
<p>This is more of a nix question. How do I get this to build correctly?</p>
<div class="codehilite" data-code-language="Nix"><pre><span></span><code>        <span class="ss">blake3-shim =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/c/default.nix</span> <span class="p">{</span>
          <span class="k">inherit</span> system pkgs blake3-c lean<span class="p">;</span>
        <span class="p">};</span>
        <span class="ss">project =</span> leanPkgs<span class="o">.</span>buildLeanPackage <span class="p">{</span>
          <span class="k">inherit</span> name<span class="p">;</span>
          <span class="ss">src =</span> <span class="o">.</span><span class="l">/src</span><span class="p">;</span>
          <span class="ss">debug =</span> <span class="no">true</span><span class="p">;</span>
          <span class="c1"># linkFlags = [ blake3-shim.staticLib ];</span>
          <span class="c1"># staticLibDeps = [ blake3-shim.staticLib ];</span>
          <span class="c1"># pluginDeps = [ blake3-shim.dynamicLib ];</span>
        <span class="p">};</span>
        <span class="ss">tests =</span> leanPkgs<span class="o">.</span>buildLeanPackage <span class="p">{</span>
          <span class="ss">name =</span> <span class="s2">"Tests"</span><span class="p">;</span>
          <span class="ss">src =</span> <span class="o">.</span><span class="l">/tests</span><span class="p">;</span>
          <span class="ss">debug =</span> <span class="no">true</span><span class="p">;</span>
          <span class="ss">deps =</span> <span class="p">[</span> project <span class="p">];</span>
          <span class="ss">pluginDeps =</span> <span class="p">[</span> project<span class="o">.</span>sharedLib <span class="p">];</span>
          <span class="ss">staticLibDeps =</span> <span class="p">[</span> blake3-shim project<span class="o">.</span>staticLib <span class="p">];</span>
        <span class="p">};</span>
</code></pre></div>
<p>The blake3-shim build works fine, but building <code>project.executable</code>gives:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">xn1f3mbdnfymy1cw109axj1jnm85fksy</span><span class="bp">-</span><span class="n">Blake3</span><span class="bp">-</span><span class="n">c</span><span class="bp">/</span><span class="n">Blake3.c</span><span class="o">:</span><span class="mi">156</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">called</span> <span class="n">object</span> <span class="n">type</span> <span class="bp">'</span><span class="n">lean_object</span> <span class="bp">*'</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">function</span> <span class="n">or</span> <span class="n">function</span> <span class="n">pointer</span>
<span class="n">x_1</span> <span class="bp">=</span> <span class="n">blake3_hasher</span><span class="o">()</span><span class="bp">;</span>
      <span class="bp">~~~~~~~~~~~~~^</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">xn1f3mbdnfymy1cw109axj1jnm85fksy</span><span class="bp">-</span><span class="n">Blake3</span><span class="bp">-</span><span class="n">c</span><span class="bp">/</span><span class="n">Blake3.c</span><span class="o">:</span><span class="mi">261</span><span class="o">:</span><span class="mi">29</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">called</span> <span class="n">object</span> <span class="n">type</span> <span class="bp">'</span><span class="n">lean_object</span> <span class="bp">*'</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">function</span> <span class="n">or</span> <span class="n">function</span> <span class="n">pointer</span>
<span class="n">x_1</span> <span class="bp">=</span> <span class="n">lean_blake3_initialize</span><span class="o">()</span><span class="bp">;</span>
      <span class="bp">~~~~~~~~~~~~~~~~~~~~~~^</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">xn1f3mbdnfymy1cw109axj1jnm85fksy</span><span class="bp">-</span><span class="n">Blake3</span><span class="bp">-</span><span class="n">c</span><span class="bp">/</span><span class="n">Blake3.c</span><span class="o">:</span><span class="mi">342</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">use</span> <span class="n">of</span> <span class="n">undeclared</span> <span class="n">identifier</span> <span class="bp">'</span><span class="n">l_Blake3_HasherPointed'</span>
<span class="n">l_Blake3_HasherPointed</span> <span class="bp">=</span> <span class="n">_init_l_Blake3_HasherPointed</span><span class="o">()</span><span class="bp">;</span>
<span class="bp">^</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">xn1f3mbdnfymy1cw109axj1jnm85fksy</span><span class="bp">-</span><span class="n">Blake3</span><span class="bp">-</span><span class="n">c</span><span class="bp">/</span><span class="n">Blake3.c</span><span class="o">:</span><span class="mi">342</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">implicit</span> <span class="n">declaration</span> <span class="n">of</span> <span class="n">function</span> <span class="bp">'</span><span class="n">_init_l_Blake3_HasherPointed'</span> <span class="n">is</span> <span class="n">invalid</span> <span class="k">in</span> <span class="n">C99</span> <span class="o">[</span><span class="bp">-</span><span class="n">Wimplicit</span><span class="bp">-</span><span class="n">function</span><span class="bp">-</span><span class="n">declaration</span><span class="o">]</span>
<span class="n">l_Blake3_HasherPointed</span> <span class="bp">=</span> <span class="n">_init_l_Blake3_HasherPointed</span><span class="o">()</span><span class="bp">;</span>
                         <span class="bp">^</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">xn1f3mbdnfymy1cw109axj1jnm85fksy</span><span class="bp">-</span><span class="n">Blake3</span><span class="bp">-</span><span class="n">c</span><span class="bp">/</span><span class="n">Blake3.c</span><span class="o">:</span><span class="mi">343</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">use</span> <span class="n">of</span> <span class="n">undeclared</span> <span class="n">identifier</span> <span class="bp">'</span><span class="n">l_Blake3_HasherPointed'</span><span class="bp">;</span> <span class="n">did</span> <span class="n">you</span> <span class="n">mean</span> <span class="bp">'</span><span class="n">_init_l_Blake3_HasherPointed'</span><span class="bp">?</span>
<span class="n">lean_mark_persistent</span><span class="o">(</span><span class="n">l_Blake3_HasherPointed</span><span class="o">)</span><span class="bp">;</span>
                     <span class="bp">^~~~~~~~~~~~~~~~~~~~~~</span>
                     <span class="n">_init_l_Blake3_HasherPointed</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">xn1f3mbdnfymy1cw109axj1jnm85fksy</span><span class="bp">-</span><span class="n">Blake3</span><span class="bp">-</span><span class="n">c</span><span class="bp">/</span><span class="n">Blake3.c</span><span class="o">:</span><span class="mi">342</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span> <span class="n">note</span><span class="o">:</span> <span class="bp">'</span><span class="n">_init_l_Blake3_HasherPointed'</span> <span class="n">declared</span> <span class="n">here</span>
<span class="n">l_Blake3_HasherPointed</span> <span class="bp">=</span> <span class="n">_init_l_Blake3_HasherPointed</span><span class="o">()</span><span class="bp">;</span>
                         <span class="bp">^</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">xn1f3mbdnfymy1cw109axj1jnm85fksy</span><span class="bp">-</span><span class="n">Blake3</span><span class="bp">-</span><span class="n">c</span><span class="bp">/</span><span class="n">Blake3.c</span><span class="o">:</span><span class="mi">352</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">use</span> <span class="n">of</span> <span class="n">undeclared</span> <span class="n">identifier</span> <span class="bp">'</span><span class="n">l_Blake3_initHasher'</span>
<span class="n">l_Blake3_initHasher</span> <span class="bp">=</span> <span class="n">_init_l_Blake3_initHasher</span><span class="o">()</span><span class="bp">;</span>
<span class="bp">^</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">xn1f3mbdnfymy1cw109axj1jnm85fksy</span><span class="bp">-</span><span class="n">Blake3</span><span class="bp">-</span><span class="n">c</span><span class="bp">/</span><span class="n">Blake3.c</span><span class="o">:</span><span class="mi">352</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span> <span class="n">warning</span><span class="o">:</span> <span class="n">implicit</span> <span class="n">declaration</span> <span class="n">of</span> <span class="n">function</span> <span class="bp">'</span><span class="n">_init_l_Blake3_initHasher'</span> <span class="n">is</span> <span class="n">invalid</span> <span class="k">in</span> <span class="n">C99</span> <span class="o">[</span><span class="bp">-</span><span class="n">Wimplicit</span><span class="bp">-</span><span class="n">function</span><span class="bp">-</span><span class="n">declaration</span><span class="o">]</span>
<span class="n">l_Blake3_initHasher</span> <span class="bp">=</span> <span class="n">_init_l_Blake3_initHasher</span><span class="o">()</span><span class="bp">;</span>
                      <span class="bp">^</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">xn1f3mbdnfymy1cw109axj1jnm85fksy</span><span class="bp">-</span><span class="n">Blake3</span><span class="bp">-</span><span class="n">c</span><span class="bp">/</span><span class="n">Blake3.c</span><span class="o">:</span><span class="mi">353</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">use</span> <span class="n">of</span> <span class="n">undeclared</span> <span class="n">identifier</span> <span class="bp">'</span><span class="n">l_Blake3_initHasher'</span><span class="bp">;</span> <span class="n">did</span> <span class="n">you</span> <span class="n">mean</span> <span class="bp">'</span><span class="n">_init_l_Blake3_initHasher'</span><span class="bp">?</span>
<span class="n">lean_mark_persistent</span><span class="o">(</span><span class="n">l_Blake3_initHasher</span><span class="o">)</span><span class="bp">;</span>
                     <span class="bp">^~~~~~~~~~~~~~~~~~~</span>
                     <span class="n">_init_l_Blake3_initHasher</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">xn1f3mbdnfymy1cw109axj1jnm85fksy</span><span class="bp">-</span><span class="n">Blake3</span><span class="bp">-</span><span class="n">c</span><span class="bp">/</span><span class="n">Blake3.c</span><span class="o">:</span><span class="mi">352</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span> <span class="n">note</span><span class="o">:</span> <span class="bp">'</span><span class="n">_init_l_Blake3_initHasher'</span> <span class="n">declared</span> <span class="n">here</span>
<span class="n">l_Blake3_initHasher</span> <span class="bp">=</span> <span class="n">_init_l_Blake3_initHasher</span><span class="o">()</span><span class="bp">;</span>
</code></pre></div>
<p>It seems like <code>PointedType</code> assumes that the extern value is a function?</p>



<a name="258557139"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258557139" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258557139">(Oct 21 2021 at 14:38)</a>:</h4>
<p>In the generated code:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">blake3_hasher</span><span class="p">;</span><span class="w"></span>
<span class="c1">// ....</span>
<span class="k">static</span><span class="w"> </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="nf">_init_l_Blake3_instInhabitedHasher___closed__1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="nl">_start</span><span class="p">:</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">x_1</span><span class="p">;</span><span class="w"></span>
<span class="n">x_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blake3_hasher</span><span class="p">();</span><span class="w"></span>
<span class="k">return</span><span class="w"> </span><span class="n">x_1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258557628"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258557628" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258557628">(Oct 21 2021 at 14:40)</a>:</h4>
<p>I must probably implement a lean_object in the c-shim to solve this. Any tips on a reference impl? <code>io.cpp</code> perhaps? But that is so big and complicated.</p>



<a name="258557944"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258557944" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258557944">(Oct 21 2021 at 14:42)</a>:</h4>
<p>It looks like it wants to call a function to initialize a new hasher. Why not just write one?</p>



<a name="258559054"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258559054" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258559054">(Oct 21 2021 at 14:48)</a>:</h4>
<p>You declared the hasher like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "blake3_hasher"]</span>
<span class="kd">constant</span> <span class="n">HasherPointed</span> <span class="o">:</span> <span class="n">PointedType</span>
<span class="kd">def</span> <span class="n">Hasher</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">:=</span> <span class="n">HasherPointed.type</span>
<span class="kd">instance</span> <span class="o">:</span> <span class="n">Inhabited</span> <span class="n">Hasher</span> <span class="o">:=</span> <span class="o">⟨</span><span class="n">HasherPointed.val</span><span class="o">⟩</span>
</code></pre></div>
<p>I can't find any precedent in the lean 4 code base for putting an <code>@[extern]</code> on the pointed type itself. My interpretation of the error is that you should be putting the name of the initialization function in this extern declaration, because it will be called as a function. Given your shim code, I think this should be <code>lean_blake3_initialize</code></p>



<a name="258559690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258559690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258559690">(Oct 21 2021 at 14:51)</a>:</h4>
<p>I don't think lean cares at all what the name of the C type is (<code>blake3_hasher</code> in this case). It only ever deals with <code>lean_object*</code> values wrapping a <code>void*</code></p>



<a name="258559802"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258559802" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258559802">(Oct 21 2021 at 14:52)</a>:</h4>
<p>Yeah, as <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> said, you should not be putting <code>@[extern\</code> attributes on types.</p>



<a name="258560149"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258560149" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258560149">(Oct 21 2021 at 14:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="433842">Anders Christiansen Sørby</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/258510418">said</a>:</p>
<blockquote>
<p>This is not how the lean source does it. It uses Mario's solution. Is this some new C/C++ feature?</p>
</blockquote>
<p>The difference is that the Lean source has an initializer function that is called by the Lean runtime at startup that sets the global variable. Shims generally don't.</p>



<a name="258563515"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258563515" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258563515">(Oct 21 2021 at 15:11)</a>:</h4>
<p>Ok, I removed the extern and it helped. I also changed the signature of the constructor to </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "lean_blake3_initialize"]</span>
<span class="kd">constant</span> <span class="n">initHasher</span> <span class="o">:</span> <span class="n">Unit</span> <span class="bp">→</span> <span class="n">Hasher</span>
</code></pre></div>
<p>Which led it to be interpreted as a no argument function not a constant, but now I get this error:<br>
For building the <code>#executable</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">blake3</span><span class="bp">&gt;</span> <span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">fp2h123793bxln4cjxy0mz08sf4nx2m3</span><span class="bp">-</span><span class="n">binutils</span><span class="bp">-</span><span class="mi">2</span><span class="bp">.</span><span class="mi">35</span><span class="bp">.</span><span class="mi">1</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">ld</span><span class="o">:</span> <span class="n">read</span> <span class="k">in</span> <span class="n">flex</span> <span class="n">scanner</span> <span class="n">failed</span>
<span class="n">blake3</span><span class="bp">&gt;</span> <span class="n">clang</span><span class="bp">-</span><span class="mi">13</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">linker</span> <span class="n">command</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">1</span> <span class="o">(</span><span class="n">use</span> <span class="bp">-</span><span class="n">v</span> <span class="n">to</span> <span class="n">see</span> <span class="n">invocation</span><span class="o">)</span>
</code></pre></div>
<p>and for building the <code>#tests</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Tests.HashString</span><span class="bp">&gt;</span> <span class="n">lean</span><span class="o">:</span> <span class="n">symbol</span> <span class="n">lookup</span> <span class="n">error</span><span class="o">:</span> <span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">asz64i34j9hx9sj9ihgmqjy3qzxbf99r</span><span class="bp">-</span><span class="n">Blake3.so</span><span class="bp">/</span><span class="n">Blake3.so</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">lean_blake3_version</span>
</code></pre></div>
<p>but</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ nm -D /nix/store/asz64i34j9hx9sj9ihgmqjy3qzxbf99r-Blake3.so/Blake3.so <span class="p">|</span> grep blake3
                 U l_blake3_hasher_finalize
                 U l_blake3_hasher_update
                 U lean_blake3_initialize
                 U lean_blake3_version
</code></pre></div>
<p>So what is going on?</p>



<a name="258564164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258564164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258564164">(Oct 21 2021 at 15:14)</a>:</h4>
<p><code>U</code> means "undefined"</p>



<a name="258564351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258564351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258564351">(Oct 21 2021 at 15:15)</a>:</h4>
<p>I've never seen the first error before; I would guess that one of the inputs is not a valid object file/archive/...</p>



<a name="258572624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258572624" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258572624">(Oct 21 2021 at 16:05)</a>:</h4>
<p>I had put the wrong input as a staticLib. <br>
Now I get</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">&gt;</span> <span class="n">could</span> <span class="n">not</span> <span class="n">find</span> <span class="n">native</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">external</span> <span class="n">declaration</span> <span class="bp">'</span><span class="n">Blake3.internalVersion'</span> <span class="o">(</span><span class="n">symbols</span> <span class="bp">'</span><span class="n">l_Blake3_internalVersion___boxed'</span> <span class="n">or</span> <span class="bp">'</span><span class="n">l_Blake3_internalVersion'</span><span class="o">)</span>
</code></pre></div>
<p>for</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "lean_blake3_version"]</span>
<span class="kd">constant</span> <span class="n">internalVersion</span> <span class="o">:</span> <span class="n">Unit</span> <span class="bp">→</span> <span class="n">String</span>
</code></pre></div>
<p>This function symbol is defined in <code>Blake3.so</code> but the symbol from the BLAKE3 <code>blake3_version</code> is not.<br>
What am I missing?</p>



<a name="258572833"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258572833" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258572833">(Oct 21 2021 at 16:07)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> looking at your <a href="https://github.com/yatima-inc/lean-blake3/blob/8909d33386423742fa9c62fda3c7ab6b52aa0e5f/flake.nix"><code>flakes.nix</code></a>, your <code>project</code> and <code>tests</code> setup seems suspect. I would expect them to look more like this:</p>
<div class="codehilite" data-code-language="Nix"><pre><span></span><code><span class="ss">project =</span> leanPkgs<span class="o">.</span>buildLeanPackage <span class="p">{</span>
  <span class="k">inherit</span> name<span class="p">;</span>
  <span class="ss">src =</span> <span class="o">.</span><span class="l">/src</span><span class="p">;</span>
  <span class="ss">debug =</span> <span class="no">true</span><span class="p">;</span>
  <span class="ss">staticLibDeps =</span> <span class="p">[</span> blake3-shim<span class="p">,</span> blake3-c <span class="p">];</span>
<span class="p">};</span>
<span class="ss">tests =</span> leanPkgs<span class="o">.</span>buildLeanPackage <span class="p">{</span>
  <span class="ss">name =</span> <span class="s2">"Tests"</span><span class="p">;</span>
  <span class="ss">src =</span> <span class="o">.</span><span class="l">/tests</span><span class="p">;</span>
  <span class="ss">debug =</span> <span class="no">true</span><span class="p">;</span>
  <span class="ss">deps =</span> <span class="p">[</span> project <span class="p">];</span>
  <span class="ss">pluginDeps =</span> <span class="p">[</span> project <span class="p">];</span>
<span class="p">};</span>
</code></pre></div>



<a name="258573018"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258573018" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258573018">(Oct 21 2021 at 16:08)</a>:</h4>
<p>What is blake3 in this context?</p>



<a name="258573169"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258573169" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258573169">(Oct 21 2021 at 16:09)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> good point, fixed (it would be <code>project</code>)</p>



<a name="258574662"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258574662" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258574662">(Oct 21 2021 at 16:18)</a>:</h4>
<p>It didn't help. I've tried various variations of this:</p>
<div class="codehilite" data-code-language="Nix"><pre><span></span><code>        <span class="ss">tests =</span> leanPkgs<span class="o">.</span>buildLeanPackage <span class="p">{</span>
          <span class="ss">name =</span> <span class="s2">"Tests"</span><span class="p">;</span>
          <span class="ss">src =</span> <span class="o">.</span><span class="l">/tests</span><span class="p">;</span>
          <span class="ss">debug =</span> <span class="no">true</span><span class="p">;</span>
          <span class="ss">deps =</span> <span class="p">[</span> project <span class="p">];</span>
          <span class="ss">pluginDeps =</span> <span class="p">[</span> project<span class="o">.</span>sharedLib <span class="p">];</span>
          <span class="ss">staticLibDeps =</span> <span class="p">[</span> blake3-c<span class="o">.</span>staticLib blake3-shim<span class="o">.</span>staticLib project<span class="o">.</span>staticLib <span class="p">];</span>
        <span class="p">};</span>
</code></pre></div>



<a name="258575061"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258575061" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258575061">(Oct 21 2021 at 16:20)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> what errors are you getting?</p>



<a name="258575135"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258575135" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258575135">(Oct 21 2021 at 16:20)</a>:</h4>
<p>The same as above</p>



<a name="258575168"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258575168" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258575168">(Oct 21 2021 at 16:21)</a>:</h4>
<p>Personally, I would have suggested building manually and getting that to work before translating it to Nix.</p>



<a name="258575237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258575237" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258575237">(Oct 21 2021 at 16:21)</a>:</h4>
<p>so that you have a better understanding of what is suppose to be happening</p>



<a name="258581268"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258581268" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258581268">(Oct 21 2021 at 17:00)</a>:</h4>
<p>A manual invocation like this:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nv">LEAN_PATH</span><span class="o">=</span>/nix/store/4wrg252zqyr33ayx7f2j2sdy793zh5hx-Tests.HashString-depRoot lean --plugin<span class="o">=</span>/nix/store/s4la9xg9da5yixcxlhdnbflqzygkripl-Blake3.so/Blake3.so tests/Tests/HashString.lean
</code></pre></div>
<p>Produces the same error.</p>



<a name="258582171"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258582171" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258582171">(Oct 21 2021 at 17:05)</a>:</h4>
<p>And <code>nm -g</code> on the .so shows that symbol? Could you post the output?</p>



<a name="258583572"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258583572" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258583572">(Oct 21 2021 at 17:15)</a>:</h4>
<p>I guess not:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>                 <span class="n">U</span> <span class="n">blake3_hasher_update</span>
                 <span class="n">U</span> <span class="n">blake3_version</span>
<span class="mi">00000000000602</span><span class="n">e0</span> <span class="n">T</span> <span class="n">initialize_Blake3</span>
<span class="mi">0000000000210648</span> <span class="n">B</span> <span class="n">l_Blake3_BLAKE3__BLOCK__LEN</span>
<span class="mi">0000000000210650</span> <span class="n">B</span> <span class="n">l_Blake3_BLAKE3__CHUNK__LEN</span>
<span class="mi">0000000000210640</span> <span class="n">B</span> <span class="n">l_Blake3_BLAKE3__KEY__LEN</span>
<span class="mi">0000000000210658</span> <span class="n">B</span> <span class="n">l_Blake3_BLAKE3__MAX__DEPTH</span>
<span class="mi">0000000000210628</span> <span class="n">B</span> <span class="n">l_Blake3_BLAKE3__OUT__LEN</span>
<span class="mi">00000000000601</span><span class="n">f0</span> <span class="n">T</span> <span class="n">l_Blake3_hash</span>
                 <span class="n">U</span> <span class="n">l_blake3_hasher_finalize</span>
<span class="mi">0000000000060160</span> <span class="n">T</span> <span class="n">l_Blake3_hasherFinalize___boxed</span>
<span class="mi">0000000000210688</span> <span class="n">B</span> <span class="n">l_Blake3_HasherPointed</span>
                 <span class="n">U</span> <span class="n">l_blake3_hasher_update</span>
<span class="mi">00000000000600</span><span class="n">f0</span> <span class="n">T</span> <span class="n">l_Blake3_hasherUpdate___boxed</span>
<span class="mi">00000000000600</span><span class="n">c0</span> <span class="n">T</span> <span class="n">l_Blake3_initHasher___boxed</span>
<span class="mi">0000000000210670</span> <span class="n">B</span> <span class="n">l_Blake3_instBlake3HashToString</span>
<span class="mi">0000000000210610</span> <span class="n">B</span> <span class="n">l_Blake3_instInhabitedBlake3Hash</span>
<span class="mi">0000000000210690</span> <span class="n">B</span> <span class="n">l_Blake3_instInhabitedHasher</span>
<span class="mi">0000000000060090</span> <span class="n">T</span> <span class="n">l_Blake3_internalVersion___boxed</span>
<span class="mi">000000000005</span><span class="n">ff90</span> <span class="n">T</span> <span class="n">l_Blake3_unsafeIO_x27</span>
<span class="mi">000000000005</span><span class="n">fd80</span> <span class="n">T</span> <span class="n">l_Blake3_unsafeIO_x27___rarg</span>
<span class="mi">00000000002106</span><span class="n">a0</span> <span class="n">B</span> <span class="n">l_Blake3_version</span>
<span class="mi">00000000000613</span><span class="n">a0</span> <span class="n">T</span> <span class="n">lean_blake3_hasher_update</span>
<span class="mi">0000000000061360</span> <span class="n">T</span> <span class="n">lean_blake3_initialize</span>
<span class="mi">0000000000061340</span> <span class="n">T</span> <span class="n">lean_blake3_version</span>
<span class="mi">00000000000601</span><span class="n">b0</span> <span class="n">T</span> <span class="n">l_panic___at_Blake3_hash___spec__1</span>
</code></pre></div>



<a name="258586468"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258586468" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258586468">(Oct 21 2021 at 17:33)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> I just managed to manually build and test your package. However, I need to be afk for an hour or less, so I can can't give the full details. A quick note though:</p>
<ul>
<li><code>initHasher</code>/<code>hasherFinalize</code> shoudl be externing <code>lean_hasher_initialize</code> and <code>lean_hasher_finalize</code>. And those need to be properly implemented.</li>
</ul>



<a name="258588045"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258588045" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258588045">(Oct 21 2021 at 17:44)</a>:</h4>
<p>Hm. I need more details to do replicate that. Can you post your entire command and changes?</p>



<a name="258595683"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258595683" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258595683">(Oct 21 2021 at 18:33)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span>  my code is now available here: <a href="https://github.com/tydeu/lean-blake3">https://github.com/tydeu/lean-blake3</a></p>



<a name="258637886"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258637886" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258637886">(Oct 22 2021 at 00:15)</a>:</h4>
<p>Thanks for the help, but I still can't see what is missing in my nix build compared to your Makefile. Can you see it?</p>



<a name="258950471"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258950471" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258950471">(Oct 25 2021 at 12:19)</a>:</h4>
<p>I've included all the C code as static libs to the <code>lean</code> command where the Blake3 module is compiled and linked.<br>
This leads to no errors, but the essential functions like <code>blake3_version</code> is not included (undefined) in either the shared or static lib. In the nix setup I see that this is included as a <code>-Wl,--no-whole-archive</code> option which is fine I guess, but I would want to be able to include this in the lib.</p>
<p>When I then try to compile the whole library as an executable and include the static libs as an input to the lean command I get this error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>       <span class="bp">&gt;</span> <span class="n">lean</span><span class="o">:</span> <span class="n">symbol</span> <span class="n">lookup</span> <span class="n">error</span><span class="o">:</span> <span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">bbfzi1v8nb14q1kax5ig6h50wnkpsvx5</span><span class="bp">-</span><span class="n">Blake3.so</span><span class="bp">/</span><span class="n">Blake3.so</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">blake3_version</span>
</code></pre></div>
<p>Why doesn't it look for the symbol in the provided static libs (<code>libblake3.a</code>)?<br>
The symbols from the shim are included however so why not <code>libblake3.a</code>?<br>
How is this not a bug?</p>



<a name="258954508"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258954508" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258954508">(Oct 25 2021 at 12:57)</a>:</h4>
<p>I can't make sense of your description. <code>lean</code> doesn't even take static libraries as input, do you mean <code>leanc</code>? Do you have a flake target to reproduce?</p>



<a name="258958703"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258958703" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258958703">(Oct 25 2021 at 13:29)</a>:</h4>
<p>As for making native code available to the interpreter, <code>--plugin</code> is not the correct way to do that: <a href="#narrow/stream/270676-lean4/topic/mwe.3A.20plugin.3F/near/252821607">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mwe.3A.20plugin.3F/near/252821607</a></p>



<a name="258959174"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258959174" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258959174">(Oct 25 2021 at 13:33)</a>:</h4>
<p>Yes, sorry, I mean <code>leanc</code> to generate an executable.It might be that I'm missing something obvious, but I haven't found it so far.<br>
Build <code>.#tests</code> on <a href="https://github.com/yatima-inc/lean-blake3">https://github.com/yatima-inc/lean-blake3</a> to see the error.</p>



<a name="258966391"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258966391" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258966391">(Oct 25 2021 at 14:26)</a>:</h4>
<p>So I can fix this by adding the library to <code>LD_PRELOAD</code>? I guess I need to change the nix source a bit to do this.</p>



<a name="258968928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258968928" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258968928">(Oct 25 2021 at 14:44)</a>:</h4>
<p>Yes, it doesn't have any support for that yet. But I was only able to reproduce the "could not find native implementation" error using <code>nix build .#tests</code> fwiw.</p>



<a name="258988818"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/258988818" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#258988818">(Oct 25 2021 at 17:01)</a>:</h4>
<p>Strange. Are you on the newest version? <br>
Adding <code>LD_PRELOAD</code> doesn't seem to fix the issue so far.</p>



<a name="262274742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262274742" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262274742">(Nov 22 2021 at 02:49)</a>:</h4>
<p>Is there a FFI documentation?</p>



<a name="262278034"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262278034" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262278034">(Nov 22 2021 at 04:17)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> sadly, no, not really.</p>



<a name="262282767"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262282767" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Xubai Wang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262282767">(Nov 22 2021 at 06:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262274742">said</a>:</p>
<blockquote>
<p>Is there a FFI documentation?</p>
</blockquote>
<p>There is a simple one in the lean4 repo &lt;<a href="https://github.com/leanprover/lean4/blob/master/doc/dev/ffi.md">https://github.com/leanprover/lean4/blob/master/doc/dev/ffi.md</a>&gt;</p>



<a name="262309153"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262309153" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262309153">(Nov 22 2021 at 11:56)</a>:</h4>
<p>Thanks! I've been using your socket package as a reference but it is a bit more time consuming trying to reverse engineer and deduct what's going on</p>



<a name="262384116"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262384116" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262384116">(Nov 22 2021 at 22:06)</a>:</h4>
<p><span class="user-mention" data-user-id="414345">@Xubai Wang</span> Why do you add the <code>lean_obj_arg w</code> parameter in your functions headers even though you never use <code>w</code>?<br>
Example: <a href="https://github.com/xubaiw/lean4-socket/blob/4b95d1c912852db7e39c6d0f7715927fff6dfa0c/native/native.c#L288">https://github.com/xubaiw/lean4-socket/blob/4b95d1c912852db7e39c6d0f7715927fff6dfa0c/native/native.c#L288</a></p>



<a name="262388515"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262388515" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262388515">(Nov 22 2021 at 22:47)</a>:</h4>
<p>The IO monad implicitly passes a so called world parameter into the function so the computation is technically speaking pure since an IO function takes a world and produces a new one where its side effect has happened so lean will pass this world argument to the C function as well. However the C function can essentially fully ignore it since it's ...well C and not a pure functional programming language.</p>



<a name="262388566"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262388566" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262388566">(Nov 22 2021 at 22:48)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span></p>



<a name="262406209"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262406209" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262406209">(Nov 23 2021 at 02:43)</a>:</h4>
<p>It should also be noted that now that <code>BaseIO</code> exists, you should use it instead of <code>IO</code> in the Lean signature of your FFI binding if the native function  does not produce IO errors.</p>



<a name="262407364"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262407364" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262407364">(Nov 23 2021 at 03:03)</a>:</h4>
<p>Do I need to update lake?</p>



<a name="262413412"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262413412" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262413412">(Nov 23 2021 at 05:01)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> for what?</p>



<a name="262449048"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262449048" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262449048">(Nov 23 2021 at 12:33)</a>:</h4>
<p>To use BaseIO</p>



<a name="262449548"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262449548" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262449548">(Nov 23 2021 at 12:38)</a>:</h4>
<p>I tried using Lean 4 nightly 2021-11-23 and it gave me access to <code>BaseIO</code>. But I could no longer compile my code because it couldn't link to MySQL lib with <code>-lmysqlclient</code>. Maybe it's a bug?</p>



<a name="262450745"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262450745" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262450745">(Nov 23 2021 at 12:51)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> what version of Lean were you using before?</p>



<a name="262451635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262451635" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262451635">(Nov 23 2021 at 13:00)</a>:</h4>
<p>nightly 2021-10-20</p>



<a name="262451932"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262451932" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262451932">(Nov 23 2021 at 13:02)</a>:</h4>
<p>Now that the linker is bundled with Lean, it will not automatically search arbitrary system paths for libraries anymore. You can add them explicitly instead, e.g. <code>-L /usr/lib/x86_64-linux-gnu/</code></p>



<a name="262453579"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262453579" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262453579">(Nov 23 2021 at 13:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262451932">said</a>:</p>
<blockquote>
<p>Now that the linker is bundled with Lean, it will not automatically search arbitrary system paths for libraries anymore. You can add them explicitly instead, e.g. <code>-L /usr/lib/x86_64-linux-gnu/</code></p>
</blockquote>
<p>Is this what you mean?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">mySQLLinkArg</span> <span class="o">:=</span> <span class="s2">"-L /usr/lib/x86_64-linux-gnu/"</span>

<span class="n">package</span> <span class="n">LeanMySQL</span> <span class="o">(</span><span class="n">pkgDir</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">srcDir</span> <span class="o">:=</span> <span class="n">leanSoureDir</span>
  <span class="n">libRoots</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="bp">`</span><span class="n">Ffi</span><span class="o">]</span>
  <span class="n">moreLibTargets</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="n">cLibTarget</span> <span class="n">pkgDir</span><span class="o">]</span>
  <span class="n">moreLinkArgs</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="n">mySQLLinkArg</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div>
<p>This approach still doesn't work</p>



<a name="262453764"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262453764" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262453764">(Nov 23 2021 at 13:19)</a>:</h4>
<p>Where's your <code>-lmysqlclient</code>?</p>



<a name="262453808"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262453808" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262453808">(Nov 23 2021 at 13:19)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ find /usr/ -name <span class="s1">'libmysqlclient.a'</span>
/usr/lib/x86_64-linux-gnu/libmysqlclient.a
</code></pre></div>



<a name="262454032"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262454032" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262454032">(Nov 23 2021 at 13:21)</a>:</h4>
<p>With nightly 2021-10-20 I was setting <code>def mySQLLinkArg := "-lmysqlclient"</code></p>



<a name="262454119"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262454119" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262454119">(Nov 23 2021 at 13:22)</a>:</h4>
<p>You need both <code>-l</code> and <code>-L</code></p>



<a name="262454476"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262454476" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262454476">(Nov 23 2021 at 13:24)</a>:</h4>
<p>Do you mean</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">package</span> <span class="n">LeanMySQL</span> <span class="o">(</span><span class="n">pkgDir</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">srcDir</span> <span class="o">:=</span> <span class="n">leanSoureDir</span>
  <span class="n">libRoots</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="bp">`</span><span class="n">Ffi</span><span class="o">]</span>
  <span class="n">moreLibTargets</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="n">cLibTarget</span> <span class="n">pkgDir</span><span class="o">]</span>
  <span class="n">moreLinkArgs</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="s2">"-L /usr/lib/x86_64-linux-gnu/"</span><span class="o">,</span> <span class="s2">"-lmysqlclient"</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div>
<p>?</p>



<a name="262454549"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262454549" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262454549">(Nov 23 2021 at 13:25)</a>:</h4>
<p>It says</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">error</span><span class="o">:</span> <span class="n">ld.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">library</span> <span class="bp">-</span><span class="n">lmysqlclient</span>
<span class="n">clang</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">linker</span> <span class="n">command</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">1</span> <span class="o">(</span><span class="n">use</span> <span class="bp">-</span><span class="n">v</span> <span class="n">to</span> <span class="n">see</span> <span class="n">invocation</span><span class="o">)</span>
</code></pre></div>



<a name="262454639"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262454639" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262454639">(Nov 23 2021 at 13:26)</a>:</h4>
<p>Does it work without the space after <code>-L</code>? If not, what's the output with <code>"-v"</code> added to that list?</p>



<a name="262456245"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262456245" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262456245">(Nov 23 2021 at 13:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262454639">said</a>:</p>
<blockquote>
<p>Does it work without the space after <code>-L</code>? If not, what's the output with <code>"-v"</code> added to that list?</p>
</blockquote>
<p>It worked. It also worked like this: <code>moreLinkArgs := #["-L", "/usr/lib/x86_64-linux-gnu/", "-lmysqlclient"]</code></p>



<a name="262456425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262456425" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262456425">(Nov 23 2021 at 13:40)</a>:</h4>
<p>Thanks!</p>



<a name="262456650"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262456650" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262456650">(Nov 23 2021 at 13:42)</a>:</h4>
<p>Great! I probably don't have to mention that we still need to find out and decide on the best practices in these regards :) . Explicitly specifying the search path might look like a chore, but it is also an explicit reminder that you now depend on something outside of Lean's/Lake's control, so it might not be all bad.</p>



<a name="262457398"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262457398" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262457398">(Nov 23 2021 at 13:48)</a>:</h4>
<blockquote>
<p>so it might not be all bad.</p>
</blockquote>
<p>Putting <code>-L /usr/lib/x86_64-linux-gnu/</code> into the linker arguments seems like the most non-portable solution though.  It literally won't work on anything except ubuntu on amd64?  AFAICT none of fedora/archlinux/nixos have that directory.  Not to speak of windows or mac.</p>
<p>I've said it before, but I think we should use the system linker, at least when we're linking to system libraries.</p>



<a name="262458156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262458156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262458156">(Nov 23 2021 at 13:54)</a>:</h4>
<p>Idea:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">package</span> <span class="n">LeanMySQL</span> <span class="o">(</span><span class="n">pkgDir</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">srcDir</span> <span class="o">:=</span> <span class="n">leanSoureDir</span>
  <span class="n">libRoots</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="bp">`</span><span class="n">Ffi</span><span class="o">]</span>
  <span class="n">moreLibTargets</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="n">cLibTarget</span> <span class="n">pkgDir</span><span class="o">]</span>
  <span class="n">moreLinkLibs</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="s2">"/usr/lib/x86_64-linux-gnu/libmysqlclient.a"</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div>



<a name="262458429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262458429" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262458429">(Nov 23 2021 at 13:56)</a>:</h4>
<p>It requires me to be precise and explicit about the libs I'm using. Then the linking can be done according to the system I'm using, but this would be abstracted (invisible) to me</p>



<a name="262460121"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262460121" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262460121">(Nov 23 2021 at 14:10)</a>:</h4>
<p>On Linux the proper way to figure out include and linking flags is to use pkg-config.  This is what pkg-config prints on two different systems (ubuntu and nixos):</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>$ pkg-config --libs --cflags mysqlclient
-I/usr/include/mysql -lmysqlclient
$ pkg-config --libs --cflags mysqlclient
-I/nix/store/3mzvn84d0wq5bvrq0rp4jxwlmprpqkbx-mariadb-connector-c-3.2.3-dev/include/mariadb/ -L/nix/store/3ca2s5k41m9w6mmk8h68ba0g2b2h1mzl-mariadb-connector-c-3.2.3/lib/mariadb/ -lmariadb
</code></pre></div>
<p>Note that it doesn't contain enough information to figure out the directory <code>/usr/lib/x86_64-linux-gnu</code> on ubuntu.  I don't know if there's a portable way to do that.  (And none of that would be an issue if we just used the system linker.)</p>



<a name="262464645"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262464645" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262464645">(Nov 23 2021 at 14:43)</a>:</h4>
<p>Hah, I did hope <code>pkg-config</code> would print out the full path. If we use the system linker, should we completely ignore <code>$LEAN_SYSROOT/lib</code> and take all dependencies from the system?</p>



<a name="262465098"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262465098" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262465098">(Nov 23 2021 at 14:46)</a>:</h4>
<p>I think that's the best option.  All libraries there should be available on every system (certainly once we've switched away from gmp).  We still need to link from $LEAN_SYSROOT/lib/lean though.</p>



<a name="262465208"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262465208" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262465208">(Nov 23 2021 at 14:47)</a>:</h4>
<p>Except for libc++ probably <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="262465244"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262465244" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262465244">(Nov 23 2021 at 14:48)</a>:</h4>
<p>Oh!</p>



<a name="262465326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262465326" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262465326">(Nov 23 2021 at 14:48)</a>:</h4>
<p>I guess that's an argument for removing the C++ dependency. <em>ducks</em></p>



<a name="262465406"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262465406" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262465406">(Nov 23 2021 at 14:48)</a>:</h4>
<p>Would make some things easier for sure</p>



<a name="262465853"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262465853" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262465853">(Nov 23 2021 at 14:52)</a>:</h4>
<p>Note that it's not an issue when linking dynamically, libc++ is completely hidden inside <a href="http://libleanshared.so">libleanshared.so</a> in that case. Now if there was a convenient way to merge static archives...</p>



<a name="262466682"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262466682" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262466682">(Nov 23 2021 at 14:58)</a>:</h4>
<p>Alternatively, since this libc++.a <em>is</em> special-purposed for Lean, we put it in lib/lean and call it a day...</p>



<a name="262487057"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262487057" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262487057">(Nov 23 2021 at 17:29)</a>:</h4>
<p>I have to disagree with <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span>, I do not think that using the system linking is the best idea here. The primary reason for this is that Lake <em>wants</em> to know the exact path of the library. The proper way of adding a native library to a package is (using <span class="user-mention" data-user-id="451983">@Arthur Paulino</span>'s package as an example) :</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">package</span> <span class="n">LeanMySQL</span> <span class="o">(</span><span class="n">pkgDir</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">srcDir</span> <span class="o">:=</span> <span class="n">leanSoureDir</span>
  <span class="n">libRoots</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="bp">`</span><span class="n">Ffi</span><span class="o">]</span>
  <span class="n">moreLibTargets</span> <span class="o">:=</span> <span class="bp">#</span><span class="o">[</span><span class="n">cLibTarget</span> <span class="n">pkgDir</span><span class="o">,</span> <span class="n">inputFileTarget</span> <span class="s2">"path/to/libmysqlclient.a"</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div>
<p>This way Lake generates a trace for the library, allowing it to rebuilding the project if the version of the library (e.g., MySQL) changes and supporting the result being used in content-addressed cloud builds.</p>



<a name="262487496"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262487496" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262487496">(Nov 23 2021 at 17:32)</a>:</h4>
<p>That makes sense if lake builds the library, but if you link against system libraries (like mysqlclient) then you typically 1) only have shared libraries, 2) you don't know the path the library, and 3) there's also the headers which need to be tracked as well.</p>



<a name="262488831"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262488831" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262488831">(Nov 23 2021 at 17:41)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> It should also be true if Lake did not build the library (and in many cases, ideally, lake <em>would</em> be building the library if possible). Lake, like Nix, is designed (and expects) for its traces to properly represent the change of dependencies (all dependencies).  To your specific points: </p>
<ol>
<li>So? You can trace shared libraries as well.</li>
<li>Hence my point for avoiding system libraries. Use a library you know the path to. Or use tools to figure it out -- like <code>llvm-config</code> for LLVM or more general (but OS specific tools) like <code>brew</code>.</li>
<li>Yes, include directories should also be traced. I am planning on expanding the current <code>oFileTarget</code> to also take an <code>includeDirs</code> argument that uses targets for include directories. However, in some cases (like with Lean) there may be a better proxy for this trace than just the hash of the whole include directory (e.g., Lean's githash).</li>
</ol>



<a name="262490283"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262490283" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262490283">(Nov 23 2021 at 17:50)</a>:</h4>
<p>There's also the fact that if <code>lake</code> requires specific paths (to headers and to their respective libs), at least it's completely predictable and clear. It also gives the developer more freedom (with the cost of having to know where things are).</p>



<a name="262491286"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262491286" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262491286">(Nov 23 2021 at 17:57)</a>:</h4>
<p>Hm, one problem with this approach of not relying on default system parameters is that the package config would end up being specific to my machine. One wouldn't always be able to clone my repo and just compile it out of the box without making sure that every path is correct in the configuration file. I suppose this is a big con?</p>



<a name="262491412"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262491412" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262491412">(Nov 23 2021 at 17:58)</a>:</h4>
<blockquote>
<p>One wouldn't always be able to clone my repo and just compile it out of the box without making sure that every path is correct in the configuration file. I suppose this is a big con?</p>
</blockquote>
<p>Yes, this is why I'm arguing against hardcoding the /usr/lib/x86_64-linux-gnu path and in favor of using pkg-config.</p>



<a name="262492465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262492465" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262492465">(Nov 23 2021 at 18:06)</a>:</h4>
<p>How do other build systems solve this problem? If it were like how you build software on Linux, there could be a "<code>./configure</code>" that creates a module containing variables with system-specific paths that the Lakefile then makes use of.  That configure script could use <code>pkg-config</code> if it wants.</p>



<a name="262492706"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262492706" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262492706">(Nov 23 2021 at 18:08)</a>:</h4>
<blockquote>
<p>in many cases, ideally, lake would be building the library if possible</p>
</blockquote>
<p>Emphasis on <em>many</em>.  Some stuff like libzstd e.g. can reasonably be built by lake.  Other libraries must absolutely never be vendored, like e.g. fontconfig (the rust ecosystem gets this horribly wrong, resulting in silently broken builds if the vendored fontconfig is used: <a href="https://github.com/servo/libfontconfig/issues/58">https://github.com/servo/libfontconfig/issues/58</a>).</p>



<a name="262493179"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262493179" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262493179">(Nov 23 2021 at 18:12)</a>:</h4>
<blockquote>
<p>How do other build systems solve this problem?</p>
</blockquote>
<p>Typically by just calling <code>pkg-config</code> during build on linux on mac (I think), and hoping for the best on windows.  You can (and probably should) do the same in your lakefile.  The issue we have here in Lean is that since two days ago, Lean uses a bundled linker which doesn't find system libraries.</p>



<a name="262493545"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262493545" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262493545">(Nov 23 2021 at 18:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262488831">said</a>:</p>
<blockquote>
<p>You can trace shared libraries as well.</p>
</blockquote>
<p>To reliably trace shared libraries, you would have to call, or implement the equivalent of, <code>ldd</code> to find transitive dependencies, which I hope we're not planning to do. That together with the path setup problem, which does not seem to have a sane solution on Linux except for Nix, strongly suggests to me that we should not worry about tracing system files.</p>



<a name="262493563"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262493563" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kyle Miller <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262493563">(Nov 23 2021 at 18:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262493179">said</a>:</p>
<blockquote>
<blockquote>
<p>How do other build systems solve this problem?</p>
</blockquote>
<p>Typically by just calling <code>pkg-config</code> during build on linux on mac (I think)</p>
</blockquote>
<p>If you're using autoconf, I think traditionally <code>pkg-config</code> is used in the <code>./configure</code> script, which generates the Makefile loaded with the system-specific paths.  Lean packages could rely on something similar, where you have to run a script to create either the Lakefile or some file that the Lakefile includes (if that's possible).</p>



<a name="262493621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262493621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262493621">(Nov 23 2021 at 18:16)</a>:</h4>
<p>Btw, it should be possible to "unbundle" the bundled linker using <code>-Wl,--sysroot=/</code> (untested)</p>



<a name="262493641"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262493641" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262493641">(Nov 23 2021 at 18:16)</a>:</h4>
<blockquote>
<p>You can trace shared libraries as well. [..] include directories should also be traced.</p>
</blockquote>
<p>This seems like a reasonable idea.  My complaint was about passing the filename to the linker, not rebuilding when dependencies change.  Even more important than changes in the system library headers are imho changes in headers in the project itself.  It might make sense to call <code>cc -M</code> to figure these out.</p>



<a name="262494871"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262494871" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262494871">(Nov 23 2021 at 18:26)</a>:</h4>
<p>As a point of reference, bazel doesn't track system libraries either: <a href="https://github.com/bazelbuild/bazel/issues/4558">https://github.com/bazelbuild/bazel/issues/4558</a>  (I don't know what the rationale was.)</p>



<a name="262496222"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262496222" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262496222">(Nov 23 2021 at 18:38)</a>:</h4>
<blockquote>
<p>supporting the result being used in content-addressed cloud builds.</p>
</blockquote>
<p>The following is a bit biased, and I am putting my mathlib hat on.  It's perfectly okay if using system libraries disables cloud caches (for those targets).  Other systems are going to have different builds of these libraries, and so the cache probably misses anyhow.</p>
<p>(Note that most ffi stuff will probably depend on libc headers, which are system-specific as well.)</p>
<p>On the other hand it is absolutely crucial that we can be impure and use caches that are built on a different architecture.  That is, cache oleans and c files built on Linux/amd64 and use them on Darwin/amd64, Windows/amd64, Linux/aarch64, etc. (and maybe even Unknown/wasm)</p>
<p>If this doesn't work with lake, we can continue to use the current leanproject approach of "upload a tarball with the oleans for every revision".  But it would be cool to have more fine-grained caching.</p>



<a name="262499702"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262499702" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262499702">(Nov 23 2021 at 19:07)</a>:</h4>
<p>What was the motivation for bundling a linker?</p>



<a name="262502165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262502165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262502165">(Nov 23 2021 at 19:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262496222">said</a>:</p>
<blockquote>
<blockquote>
<p>supporting the result being used in content-addressed cloud builds.</p>
</blockquote>
<p>The following is a bit biased, and I am putting my mathlib hat on.  It's perfectly okay if using system libraries disables cloud caches (for those targets).  Other systems are going to have different builds of these libraries, and so the cache probably misses anyhow.</p>
<p>(Note that most ffi stuff will probably depend on libc headers, which are system-specific as well.)</p>
</blockquote>
<p>My point here is that, by tracing the system libraries, the resulting trace would be different for each system configuration so the cloud store can be used -- different system would end up pulling the cached artifact that depends on their system-specific files. Without such components in trace,  the trace for a given dependent would appear the same across platforms resulting in invalid cache fetches. This makes cloud storage infeasible for such builds.</p>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262496222">said</a>:</p>
<blockquote>
<p>On the other hand it is absolutely crucial that we can be impure and use caches that are built on a different architecture.  That is, cache oleans and c files built on Linux/amd64 and use them on Darwin/amd64, Windows/amd64, Linux/aarch64, etc. (and maybe even Unknown/wasm)</p>
<p>If this doesn't work with lake, we can continue to use the current leanproject approach of "upload a tarball with the oleans for every revision".  But it would be cool to have more fine-grained caching.</p>
</blockquote>
<p>This is already posisble with Lake  because olean traces are just based on the Lean version and the hash of the Lean input files.</p>



<a name="262544055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262544055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262544055">(Nov 24 2021 at 03:57)</a>:</h4>
<p>Another issue with Lean 4 nightly 2021-11-23: I'm not able to use the <code>string</code> lib.</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span><span class="w"></span>
<span class="n">string</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"qqq"</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Causes <code>error: ld.lld: error: undefined symbol: std::allocator&lt;char&gt;::allocator()</code></p>
<p>PS: It works on nightly 2021-10-20</p>



<a name="262544799"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262544799" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262544799">(Nov 24 2021 at 04:12)</a>:</h4>
<p>Probably another lib I need to link against, but I don't know which one</p>



<a name="262573786"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262573786" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262573786">(Nov 24 2021 at 11:05)</a>:</h4>
<p>C++ code should always be linked using the C++ compiler, i.e. not <code>leanc</code>. You should also link to Lean dynamically in this case (<a href="https://github.com/leanprover/lean4/blob/f7decd2d464ab679cb73212fb9674aeb92bfe184/tests/compiler/foreign/Makefile#L14-L15">https://github.com/leanprover/lean4/blob/f7decd2d464ab679cb73212fb9674aeb92bfe184/tests/compiler/foreign/Makefile#L14-L15</a>).</p>



<a name="262574085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262574085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262574085">(Nov 24 2021 at 11:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110032">Reid Barton</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262499702">said</a>:</p>
<blockquote>
<p>What was the motivation for bundling a linker?</p>
</blockquote>
<p>See <a href="https://github.com/leanprover/lean4/pull/733#issuecomment-948426757">https://github.com/leanprover/lean4/pull/733#issuecomment-948426757</a></p>



<a name="262585447"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262585447" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262585447">(Nov 24 2021 at 13:06)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> Sorry I didn't get it. What should I change in the <code>lakefile.lean</code> file?</p>



<a name="262589717"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262589717" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262589717">(Nov 24 2021 at 13:44)</a>:</h4>
<p>I will be using the <code>2021-10-20</code> version in the meantime</p>



<a name="262591462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262591462" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262591462">(Nov 24 2021 at 13:58)</a>:</h4>
<p>Yeah, this thread is about <em>figuring out</em> what Lake should be doing with foreign dependencies :) . That <code>leanc</code> used to be able to correctly compile &amp; link C++ code should be regarded as an unplanned coincidence.</p>



<a name="262594547"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262594547" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262594547">(Nov 24 2021 at 14:21)</a>:</h4>
<p>Is there an example of a lakefile that successfully compiles and links C++ code?</p>



<a name="262603911"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262603911" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262603911">(Nov 24 2021 at 15:36)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> Lake has an <a href="https://github.com/leanprover/lake/tree/1bcbc327f678b117ccbfed6f804ad62524a3cfe4/examples/ffi">FFI example</a> in its repository that does exactly that. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="262606737"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262606737" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262606737">(Nov 24 2021 at 15:59)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span>  You could also try to use nix for building and distributing your software. I find this the most universal and plug and play solution for building anything although unorthodox. This is especially true for FFI and needing to compile several languages or ensure build stability.<br>
As an example you can use this <a href="https://github.com/yatima-inc/lean-blake3">https://github.com/yatima-inc/lean-blake3</a> which currently points to a PR fork of lean4, but which hopefully will be merged soon.</p>



<a name="262609801"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262609801" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262609801">(Nov 24 2021 at 16:22)</a>:</h4>
<p><span class="user-mention" data-user-id="315577">@Mac</span> I'm using that as a reference but it doesn't work. Here's the lakefile: <a href="https://github.com/arthurpaulino/LeanMySQL/blob/master/lakefile.lean">https://github.com/arthurpaulino/LeanMySQL/blob/master/lakefile.lean</a></p>



<a name="262609999"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262609999" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262609999">(Nov 24 2021 at 16:23)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> can you elaborate as to the error you are encountering?</p>



<a name="262610484"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262610484" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262610484">(Nov 24 2021 at 16:27)</a>:</h4>
<p>In short, everything was working fine until I started to make use of <code>string</code> in my C++ code. Now <code>lake build</code> reports a lot of errors like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">error</span><span class="o">:</span> <span class="n">ld.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">__cxx11</span><span class="o">::</span><span class="n">basic_string</span><span class="bp">&lt;</span><span class="n">char</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span> <span class="bp">&gt;</span><span class="o">::</span><span class="n">data</span><span class="o">()</span> <span class="n">const</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">referenced</span> <span class="kd">by</span> <span class="n">ffi.cpp</span>
<span class="bp">&gt;&gt;&gt;</span>               <span class="n">ffi.o</span><span class="o">:(</span><span class="n">query_all</span><span class="o">(</span><span class="n">mysql</span><span class="bp">*</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">__cxx11</span><span class="o">::</span><span class="n">basic_string</span><span class="bp">&lt;</span><span class="n">char</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span> <span class="bp">&gt;</span><span class="o">))</span> <span class="k">in</span> <span class="n">archive</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">cpp</span><span class="bp">/</span><span class="n">libffi.a</span>

<span class="n">ld.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span><span class="o">::</span><span class="n">allocator</span><span class="o">()</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">referenced</span> <span class="kd">by</span> <span class="n">ffi.cpp</span>
<span class="bp">&gt;&gt;&gt;</span>               <span class="n">ffi.o</span><span class="o">:(</span><span class="n">lean_mysql_manage_db</span><span class="o">(</span><span class="n">lean_object</span><span class="bp">*</span><span class="o">,</span> <span class="n">lean_object</span><span class="bp">*</span><span class="o">,</span> <span class="n">char</span> <span class="n">const</span><span class="bp">*</span><span class="o">))</span> <span class="k">in</span> <span class="n">archive</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">cpp</span><span class="bp">/</span><span class="n">libffi.a</span>

<span class="n">ld.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">__cxx11</span><span class="o">::</span><span class="n">basic_string</span><span class="bp">&lt;</span><span class="n">char</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span> <span class="bp">&gt;</span><span class="o">::</span><span class="n">basic_string</span><span class="o">(</span><span class="n">char</span> <span class="n">const</span><span class="bp">*</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span> <span class="n">const</span><span class="bp">&amp;</span><span class="o">)</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">referenced</span> <span class="kd">by</span> <span class="n">ffi.cpp</span>
<span class="bp">&gt;&gt;&gt;</span>               <span class="n">ffi.o</span><span class="o">:(</span><span class="n">lean_mysql_manage_db</span><span class="o">(</span><span class="n">lean_object</span><span class="bp">*</span><span class="o">,</span> <span class="n">lean_object</span><span class="bp">*</span><span class="o">,</span> <span class="n">char</span> <span class="n">const</span><span class="bp">*</span><span class="o">))</span> <span class="k">in</span> <span class="n">archive</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">cpp</span><span class="bp">/</span><span class="n">libffi.a</span>
</code></pre></div>



<a name="262610924"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262610924" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262610924">(Nov 24 2021 at 16:30)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> my guess would be that you need to also link your executable to the C++ standard library then (e.g., via <code>-lstdc++</code> or something like that I believe).</p>



<a name="262618825"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262618825" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262618825">(Nov 24 2021 at 17:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262610924">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> my guess would be that you need to also link your executable to the C++ standard library then (e.g., via <code>-lstdc++</code> or something like that I believe).</p>
</blockquote>
<p>Do you mean include <code>"-lstdc++"</code> in the <code>moreLinkArgs</code> array? I tried it but it still doesn't work</p>



<a name="262632393"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262632393" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262632393">(Nov 24 2021 at 19:39)</a>:</h4>
<p>Nevermind, I dropped the C++ code snippets</p>



<a name="262868754"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262868754" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262868754">(Nov 27 2021 at 11:37)</a>:</h4>
<p>So, to consolidate the discussion up to this point, the primary issues with the new <code>leanc</code> seem to be:</p>
<ul>
<li>system include paths. If <code>oFileTarget</code> is supposed to be used for FFI wrapper C code, it should use the system compiler (as it already does) but also add the Lean include path (or <code>getCFlags</code>, the only additional flag there is <code>-fPIC</code>)</li>
<li>system library paths. We could switch to the system linker (via <code>cc</code>) either implicitly when <code>moreLinkArgs</code> is specified or explicitly via some new flags like <code>useSystemLibraries := true</code>. For consistency I'd prefer using <code>leanc</code> with <code>-Wl,--sysroot=/</code> though, if that works. Unclear what that should look like on Windows, but that is also true for the "system linker".</li>
</ul>
<p>Does that sound about right?</p>



<a name="262868906"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262868906" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262868906">(Nov 27 2021 at 11:40)</a>:</h4>
<ul>
<li>C++ is complicated in general and should probably just be avoided for simple FFI wrapper code</li>
</ul>



<a name="262878151"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262878151" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262878151">(Nov 27 2021 at 15:17)</a>:</h4>
<p>I agree although I think making C++ more accessible in the future can attract more devs</p>



<a name="262878494"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262878494" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262878494">(Nov 27 2021 at 15:25)</a>:</h4>
<p>I'm trying to parse a string (?) that was returned from my C code:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">private</span> <span class="kd">constant</span> <span class="n">parse</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">IO</span> <span class="n">String</span><span class="o">)</span> <span class="o">:</span> <span class="n">Table</span> <span class="o">:=</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">ss</span> <span class="o">:</span> <span class="n">String</span> <span class="o">:=</span> <span class="n">s</span>
  <span class="o">⟨[],[]⟩</span>
</code></pre></div>
<p>But I'm getting the error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">type</span> <span class="n">mismatch</span>
  <span class="n">s</span>
<span class="n">has</span> <span class="n">type</span>
  <span class="n">IO</span> <span class="n">String</span> <span class="o">:</span> <span class="kt">Type</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="n">String</span> <span class="o">:</span> <span class="kt">Type</span>
</code></pre></div>
<p>Which makes sense. But how can I get the string itself from <code>s</code>?</p>



<a name="262879334"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879334" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879334">(Nov 27 2021 at 15:47)</a>:</h4>
<p>Does <code>let ss : String &lt;- s</code> work?</p>



<a name="262879390"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879390" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879390">(Nov 27 2021 at 15:48)</a>:</h4>
<p>No, it says</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">`←`</span> <span class="n">and</span> <span class="bp">`&lt;-`</span> <span class="n">are</span> <span class="n">not</span> <span class="n">allowed</span> <span class="k">in</span> <span class="n">pure</span> <span class="bp">`</span><span class="k">do</span><span class="bp">`</span> <span class="n">blocks</span><span class="o">,</span> <span class="n">i.e.</span><span class="o">,</span> <span class="n">blocks</span> <span class="n">where</span> <span class="n">Lean</span> <span class="n">implicitly</span> <span class="n">used</span> <span class="n">the</span> <span class="bp">`</span><span class="n">Id</span><span class="bp">`</span> <span class="n">monad</span>
</code></pre></div>



<a name="262879472"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879472" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879472">(Nov 27 2021 at 15:50)</a>:</h4>
<p>Ohh I missed that the return type is not <code>IO Table</code>. I don't think you can extract the value then.</p>



<a name="262879503"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879503" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879503">(Nov 27 2021 at 15:51)</a>:</h4>
<p>I tried making the return <code>IO Table</code> but it says</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">application</span> <span class="n">type</span> <span class="n">mismatch</span>
  <span class="n">IO</span> <span class="n">Table</span>
<span class="n">argument</span>
  <span class="n">Table</span>
<span class="n">has</span> <span class="n">type</span>
  <span class="kt">Type</span> <span class="mi">1</span> <span class="o">:</span> <span class="kt">Type</span> <span class="mi">2</span>
<span class="n">but</span> <span class="n">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="k">have</span> <span class="n">type</span>
  <span class="kt">Type</span> <span class="o">:</span> <span class="kt">Type</span> <span class="mi">1</span>
</code></pre></div>



<a name="262879661"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879661" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879661">(Nov 27 2021 at 15:55)</a>:</h4>
<p>Hmm interested that <code>IO</code> is restricted to <code>Type</code> and is not defined for <code>Type u</code>. I have very little understanding of universes, so I'm can't help here.</p>



<a name="262879710"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879710" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879710">(Nov 27 2021 at 15:56)</a>:</h4>
<p>Is <code>Table</code> a type you have defined? Can't you make it <code>Type</code> instead of <code>Type 1</code>?</p>



<a name="262879720"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879720" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879720">(Nov 27 2021 at 15:57)</a>:</h4>
<p>This is <code>Table</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">Table</span> <span class="n">where</span>
  <span class="n">types</span> <span class="o">:</span> <span class="n">List</span> <span class="kt">Type</span>
  <span class="n">rows</span> <span class="o">:</span> <span class="n">List</span> <span class="n">Row</span>
  <span class="n">deriving</span> <span class="n">Inhabited</span>
</code></pre></div>



<a name="262879788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879788">(Nov 27 2021 at 15:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="346070">Tomas Skrivan</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262879710">said</a>:</p>
<blockquote>
<p>Is <code>Table</code> a type you have defined? Can't you make it <code>Type</code> instead of <code>Type 1</code>?</p>
</blockquote>
<p>How can I do that?</p>



<a name="262879902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879902">(Nov 27 2021 at 16:00)</a>:</h4>
<p>You cannot in this case, your Table contains a List of <code>Type</code> so it has to be one universe higher.</p>



<a name="262879938"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879938" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879938">(Nov 27 2021 at 16:01)</a>:</h4>
<p>What about?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">Table</span> <span class="o">(</span><span class="n">types</span> <span class="o">:</span> <span class="n">List</span> <span class="kt">Type</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">rows</span> <span class="o">:</span> <span class="n">List</span> <span class="n">Row</span>
  <span class="n">deriving</span> <span class="n">Inhabited</span>
</code></pre></div>
<p>But that might make all manipulations very difficult.</p>



<a name="262879963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262879963" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262879963">(Nov 27 2021 at 16:01)</a>:</h4>
<p>That would work yes.</p>



<a name="262880146"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262880146" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262880146">(Nov 27 2021 at 16:04)</a>:</h4>
<p>Or fetching types on the fly with typeclasses </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">Table</span> <span class="n">where</span>
  <span class="n">rows</span> <span class="o">:</span> <span class="n">List</span> <span class="n">Row</span>
  <span class="n">deriving</span> <span class="n">Inhabited</span>

<span class="kd">class</span> <span class="n">TableTypes</span> <span class="o">(</span><span class="n">t</span> <span class="o">:</span> <span class="n">Table</span><span class="o">)</span> <span class="n">where</span>
   <span class="n">types</span> <span class="o">:</span> <span class="n">List</span> <span class="kt">Type</span>
</code></pre></div>
<p>I have no clue how are you using <code>Table</code> so both options might not be feasible/useful.</p>



<a name="262880167"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262880167" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Reid Barton <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262880167">(Nov 27 2021 at 16:05)</a>:</h4>
<p>Or if <code>Table</code> is encoding some external database, then you probably want <code>types</code> to encode the external "types" of its fields, which are not Lean types anyways</p>



<a name="262880221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262880221" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262880221">(Nov 27 2021 at 16:06)</a>:</h4>
<p>Very good point! You probably do not have a database filled with arbitrary lean types.</p>



<a name="262880415"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262880415" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Tomas Skrivan <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262880415">(Nov 27 2021 at 16:10)</a>:</h4>
<p>So something like </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">inductive</span> <span class="n">DatabaseType</span> <span class="n">where</span>
 <span class="bp">|</span> <span class="n">tagged</span> <span class="o">:</span> <span class="n">String</span> <span class="bp">-&gt;</span> <span class="n">DatabaseType</span>
 <span class="bp">|</span> <span class="n">indexed</span> <span class="o">:</span> <span class="n">Nat</span> <span class="bp">-&gt;</span> <span class="n">DatabaseType</span>
 <span class="bp">|</span> <span class="bp">...</span>

<span class="c1">-- To get Lean Type equivalent</span>
<span class="kd">def</span> <span class="n">DatabaseType.toType</span> <span class="o">:</span> <span class="n">DatabaseType</span> <span class="bp">-&gt;</span> <span class="kt">Type</span> <span class="o">:=</span>
 <span class="bp">|</span> <span class="n">tagged</span> <span class="n">str</span> <span class="bp">=&gt;</span> <span class="bp">...</span>
 <span class="bp">|</span> <span class="n">indexed</span> <span class="n">id</span> <span class="bp">=&gt;</span> <span class="bp">...</span>
 <span class="bp">|</span> <span class="bp">...</span>

<span class="kd">structure</span> <span class="n">Table</span> <span class="n">where</span>
  <span class="n">types</span> <span class="o">:</span> <span class="n">List</span> <span class="n">DatabaseType</span>
  <span class="n">rows</span> <span class="o">:</span> <span class="n">List</span> <span class="n">Row</span>
  <span class="n">deriving</span> <span class="n">Inhabited</span>
</code></pre></div>



<a name="262880630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/262880630" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#262880630">(Nov 27 2021 at 16:14)</a>:</h4>
<p>Also regarding this parsing function, you:</p>
<ul>
<li>Probably don't need it to be a constant, a def should be fine</li>
<li>Should probably not take an <code>IO String</code> but instead just a string and then have a function that fetches the string via C and applies the parser to it, this way you don't have to bother with all the IO monad stuff in the parser function</li>
<li>If the parser might fail probably want to use the <code>Except</code> type as a return value.</li>
</ul>



<a name="264059597"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264059597" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264059597">(Dec 07 2021 at 19:37)</a>:</h4>
<p>I'm trying to build this function that returns an <code>Array Float</code> to Lean. In C, I have this <code>arr-&gt;data</code>, which is an array of <code>double</code>. The following code already returns an empty array, but how can I add data to it?<br>
P.S.: more precisely, data from <code>arr-&gt;data</code>?</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="nc">nl_array</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">nl_array</span><span class="p">;</span><span class="w"></span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="n">LEAN_EXPORT</span><span class="w"> </span><span class="n">lean_obj_res</span><span class="w"> </span><span class="n">lean_nl_array_to_lean_array</span><span class="p">(</span><span class="n">b_lean_obj_arg</span><span class="w"> </span><span class="n">arr_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">nl_array</span><span class="o">*</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nl_array</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">nl_array_unbox</span><span class="p">(</span><span class="n">arr_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">lean_obj_res</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_alloc_sarray</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="264060517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264060517" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264060517">(Dec 07 2021 at 19:43)</a>:</h4>
<p>Maybe you could do a memcpy from your data pointer to the return value of <code>lean_sarray_cptr</code>? Although it returns a <code>uint8_t*</code> so maybe it is intended to be used another way...</p>



<a name="264060970"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264060970" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264060970">(Dec 07 2021 at 19:46)</a>:</h4>
<p>Right, I've been looking at these, trying to figure out how to use them:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="n">LEAN_SHARED</span><span class="w"> </span><span class="n">lean_obj_res</span><span class="w"> </span><span class="n">lean_float_array_push</span><span class="p">(</span><span class="n">lean_obj_arg</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">);</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">lean_obj_res</span><span class="w"> </span><span class="nf">lean_float_array_uset</span><span class="p">(</span><span class="n">lean_obj_arg</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">lean_obj_res</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lean_is_exclusive</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_copy_float_array</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_float_array_cptr</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">lean_obj_res</span><span class="w"> </span><span class="nf">lean_float_array_fset</span><span class="p">(</span><span class="n">lean_obj_arg</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b_lean_obj_arg</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lean_float_array_uset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">lean_unbox</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">d</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">lean_obj_res</span><span class="w"> </span><span class="nf">lean_float_array_set</span><span class="p">(</span><span class="n">lean_obj_arg</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b_lean_obj_arg</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lean_is_scalar</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_unbox</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">lean_sarray_size</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">lean_float_array_uset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>But all tricks I've tried have failed so far</p>



<a name="264061835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264061835" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264061835">(Dec 07 2021 at 19:52)</a>:</h4>
<p>I've tried, for instance, <code>return lean_float_array_push(ret, 1.0);</code>, but it's causing a segmentation fault error (I was expecting a <code>#[1.0]</code> in Lean)</p>



<a name="264067520"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264067520" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264067520">(Dec 07 2021 at 20:33)</a>:</h4>
<p>In the worst case scenario I could return a string and parse it in Lean, but I really want to avoid this approach this time <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="264067778"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264067778" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264067778">(Dec 07 2021 at 20:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395550">Henrik Böving</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/264060517">said</a>:</p>
<blockquote>
<p>Maybe you could do a memcpy from your data pointer to the return value of <code>lean_sarray_cptr</code>? Although it returns a <code>uint8_t*</code> so maybe it is intended to be used another way...</p>
</blockquote>
<p>There's <code>lean_float_array_cptr</code>, as shown in the snippet below</p>



<a name="264090870"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264090870" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264090870">(Dec 07 2021 at 23:42)</a>:</h4>
<p>Still causing a segmentation fault</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#define external extern "C" LEAN_EXPORT</span>
<span class="cp">#define l_arg b_lean_obj_arg</span>
<span class="cp">#define l_res lean_obj_res</span>
<span class="cp">#define l_obj lean_object</span>

<span class="n">external</span><span class="w"> </span><span class="n">l_res</span><span class="w"> </span><span class="n">lean_nl_array_to_lean_array</span><span class="p">(</span><span class="n">l_arg</span><span class="w"> </span><span class="n">arr_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">nl_array</span><span class="o">*</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nl_array</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">nl_array_unbox</span><span class="p">(</span><span class="n">arr_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">l_res</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_alloc_sarray</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="w"> </span><span class="n">arr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_float_array_cptr</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="o">-&gt;</span><span class="n">length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Can someone spot what I'm doing wrong?</p>



<a name="264126619"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264126619" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264126619">(Dec 08 2021 at 08:50)</a>:</h4>
<p>That part looks good at a first glance. With gdb on a executable with debug symbols, it's usually not too hard to pin-point the source of a segfault (at the very least, the stack trace).</p>



<a name="264141350"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264141350" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264141350">(Dec 08 2021 at 11:19)</a>:</h4>
<p>I've changed my approach but I've encountered a similar issue and the problem was that I had to encapsulate my return with <code>lean_io_result_mk_ok</code> because of the expected return on the Lean side</p>



<a name="264195916"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264195916" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264195916">(Dec 08 2021 at 18:09)</a>:</h4>
<p>Ah, I tried it again and it didn't work. But I'm noticing something strange:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/* Scalar arrays */</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">lean_object</span><span class="w">   </span><span class="n">m_header</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w">        </span><span class="n">m_size</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w">        </span><span class="n">m_capacity</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w">       </span><span class="n">m_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">lean_sarray_object</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p><code>m_data</code> is a pointer to a 8 bytes memory cell. This function indeed returns such a pointer:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="nf">lean_sarray_cptr</span><span class="p">(</span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lean_to_sarray</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">m_data</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>But this is the puzzling part: it's casting a <code>uint8_t*</code> into a <code>double*</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">static</span> <span class="n">inline</span> <span class="n">double</span> <span class="bp">*</span> <span class="n">lean_float_array_cptr</span><span class="o">(</span><span class="n">b_lean_obj_arg</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">return</span> <span class="o">(</span><span class="n">double</span><span class="bp">*</span><span class="o">)(</span><span class="n">lean_sarray_cptr</span><span class="o">(</span><span class="n">a</span><span class="o">))</span><span class="bp">;</span> <span class="bp">//</span> <span class="n">NOLINT</span>
<span class="o">}</span>
</code></pre></div>
<p>Maybe it can cause some trouble?</p>



<a name="264199020"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/264199020" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#264199020">(Dec 08 2021 at 18:29)</a>:</h4>
<p>I think the <code>memcpy</code> from <code>double*</code> to (actually) <code>uint8_t*</code> is trampling those bytes with nonsense</p>



<a name="268918827"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/268918827" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#268918827">(Jan 21 2022 at 23:40)</a>:</h4>
<p>I did a hack to be able to return a tuple of values from FFI. Maybe this is useful to more people:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">SDL.pollEvent : IO $ Prod Bool SDL_Event</span>
<span class="cm">*/</span><span class="w"></span>
<span class="n">lean_obj_res</span><span class="w"> </span><span class="nf">lean_sdl_poll_event</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">SDL_Event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SDL_PollEvent</span><span class="p">(</span><span class="n">event</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_alloc_external</span><span class="p">(</span><span class="n">get_sdl_event_class</span><span class="p">(),</span><span class="w"> </span><span class="n">event</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Constructs a (Bool, SDL_Event) tuple</span>
<span class="w">  </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_alloc_ctor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">lean_ctor_set</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lean_box</span><span class="p">(</span><span class="n">b</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="n">lean_ctor_set</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">lean_io_result_mk_ok</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I guess you could use <code>lean_alloc_ctor</code> to create arbitrary (type erased and unsafe) inductive values given that you know how the underlying structure and order of the constructors of the type you wish to return.</p>



<a name="268920096"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/268920096" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Wojciech Nawrocki <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#268920096">(Jan 21 2022 at 23:55)</a>:</h4>
<p>This is how the runtime does things also, so I would say this is "the right way" rather than a "hack" in the sense of a workaround.</p>



<a name="268920496"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/268920496" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#268920496">(Jan 22 2022 at 00:00)</a>:</h4>
<p>Wojciech is correct, using <code>lean_alloc_ctor</code>/<code>lean_ctor_set</code> is exactly how you are suppose to create values of (boxed, non-primitive) inductive types using the Lean C API.</p>



<a name="269755922"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/269755922" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#269755922">(Jan 28 2022 at 15:46)</a>:</h4>
<p>I've started making several utility C functions for manipulating and creating erased/primitive lean_objects*. Is there any interest in adding these to the lean4 repo?</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;lean/lean.h&gt;</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * Unwrap an Option of a lean_object* as data for some</span>
<span class="cm"> * or NULL (0) for none. Unsafe.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="nf">lean_option_unwrap</span><span class="p">(</span><span class="n">b_lean_obj_arg</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lean_is_scalar</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="n">some_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_ctor_get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">some_val</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">inline</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">foreach_noop</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">b_lean_obj_arg</span><span class="w"> </span><span class="n">fn</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * Option.some a</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">lean_mk_option_some</span><span class="p">(</span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_alloc_ctor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">lean_ctor_set</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tuple</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * Option.none.</span>
<span class="cm"> * Note that this is the same value for Unit and other constant constructors of inductives.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">lean_mk_option_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">lean_box</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">lean_mk_tuple2</span><span class="p">(</span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">lean_object</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">lean_object</span><span class="o">*</span><span class="w"> </span><span class="n">tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lean_alloc_ctor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">lean_ctor_set</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">lean_ctor_set</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tuple</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="283199000"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/283199000" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> z battleman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#283199000">(May 21 2022 at 23:43)</a>:</h4>
<p>Does anyone know how I can point Clang in the direction of <code>lean/lean.h</code> so I can use it as a language server?</p>



<a name="283199486"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/283199486" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#283199486">(May 21 2022 at 23:57)</a>:</h4>
<p>When working with lean C code you usually want to work with the <code>leanc</code> wrapper around <code>clang</code> that does all of this for you, you can use <code>leanc --print-cflags</code> for it to tell you the flags it uses which does include the include paths for what you're looking for.In my case:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">λ</span> <span class="n">leanc</span> <span class="c1">--print-cflags</span>
<span class="bp">-</span><span class="n">I</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">nix</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly/include -fPIC -fvisibility=hidden</span>
</code></pre></div>



<a name="283199942"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/283199942" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> z battleman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#283199942">(May 22 2022 at 00:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395550">Henrik Böving</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/283199486">said</a>:</p>
<blockquote>
<p>When working with lean C code you usually want to work with the <code>leanc</code> wrapper around <code>clang</code> that does all of this for you, you can use <code>leanc --print-cflags</code> for it to tell you the flags it uses which does include the include paths for what you're looking for.In my case:</p>
<p><div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">λ</span> <span class="n">leanc</span> <span class="c1">--print-cflags</span>
<span class="bp">-</span><span class="n">I</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">nix</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly/include -fPIC -fvisibility=hidden</span>
</code></pre></div><br>
</p>
</blockquote>
<p>Ah thanks so much!</p>



<a name="283237541"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/283237541" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> z battleman <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#283237541">(May 22 2022 at 15:31)</a>:</h4>
<p>in general is there any documentation? All these functions  and structs and I'm struggling to figure out how it all fits together <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="283251451"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/283251451" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#283251451">(May 22 2022 at 20:55)</a>:</h4>
<p><span class="user-mention" data-user-id="483794">@z battleman</span> not yet, I believe. The current focus is on porting mathlib to Lean 4. In the meantime, we use each other's ideas and projects as references. If we put together what everyone has already been able to learn and achieve so far, we have a decent library of shared knowledge. So asking things on Zulip is still the best way to figure things out about FFI for now.</p>



<a name="283271066"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/283271066" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#283271066">(May 23 2022 at 04:49)</a>:</h4>
<p>Should someone PR an update to the manual, just adding more detail about the ABI?  I'd be happy to do it this week if nobody else can</p>



<a name="283271195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/283271195" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#283271195">(May 23 2022 at 04:51)</a>:</h4>
<p>(And I was working with <span class="user-mention" data-user-id="483794">@z battleman</span> earlier, so I can maybe pull from that conversation plus the threads on here to figure out what information to include)</p>



<a name="299840998"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299840998" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299840998">(Sep 20 2022 at 20:15)</a>:</h4>
<p>Is there some up to date repo that uses a somewhat recent toolchain (less than 1 month old) and has the setup to compile C code and use the FFI? Please share <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="299841145"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299841145" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299841145">(Sep 20 2022 at 20:16)</a>:</h4>
<p><a href="https://github.com/JamesGallicchio/LeanColls">LeanColls</a> is pretty up to date :)</p>



<a name="299841319"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299841319" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299841319">(Sep 20 2022 at 20:17)</a>:</h4>
<p>I think doc-gen4 doesn't work on newer versions of Lean because Lake is more than a month out of date, but everything else is working okay</p>



<a name="299848185"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299848185" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299848185">(Sep 20 2022 at 21:05)</a>:</h4>
<p>Its broken for 2 reasons, a) I'm focusing more attention on fixing the code generator right now and b) And after checking it out briefly just now indeed that the lake in leanprover/lake seems to be out of date? I see that the leanprover/lean4 repo has some commits that seem to address this? But I don't see where those are stored? According to github: "This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository." So unless someone could happen to point me at a working Lake that I don't have to swap out again in a few days/weeks because we switched back to the main repo yet again I guess doc-gen will remain broken for now :(</p>



<a name="299849061"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299849061" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299849061">(Sep 20 2022 at 21:13)</a>:</h4>
<p>Yeah, I was looking into what it would take to update doc-gen4 and realized Lake was blocking it</p>



<a name="299849143"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299849143" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299849143">(Sep 20 2022 at 21:14)</a>:</h4>
<p>There's a PR that fixes what is needed to update lake</p>



<a name="299849184"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299849184" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299849184">(Sep 20 2022 at 21:14)</a>:</h4>
<p><a href="https://github.com/leanprover/lake/pull/123">https://github.com/leanprover/lake/pull/123</a> this one</p>



<a name="299849210"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299849210" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299849210">(Sep 20 2022 at 21:15)</a>:</h4>
<p>anyways, this probably should be in a different thread :p</p>



<a name="299849408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299849408" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299849408">(Sep 20 2022 at 21:16)</a>:</h4>
<p>It's blocked on some style bikeshedding in <a href="https://github.com/leanprover/lake/pull/122">https://github.com/leanprover/lake/pull/122</a></p>



<a name="299859447"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299859447" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299859447">(Sep 20 2022 at 22:51)</a>:</h4>
<p>The maintenance PRs have been merged. In general, if something in Lake is causing a road block. @ mention or PM me about it and I will prioritize getting it fixed.  I am currently deep in work on my PhD thesis, so I don't read the Zulip as much as I used to, but I do check my email (which notifies me of @ mentions or PMs) and can usually find the time fix things relatively quickly when necessary.</p>



<a name="299859920"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299859920" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299859920">(Sep 20 2022 at 22:56)</a>:</h4>
<p>Will do!</p>



<a name="299865961"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299865961" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299865961">(Sep 21 2022 at 00:08)</a>:</h4>
<p>Hi! I'm trying to make <code>lake build</code> succeed on this branch: <a href="https://github.com/yatima-inc/OpenSSL.lean/tree/ap/update-toolchain">https://github.com/yatima-inc/OpenSSL.lean/tree/ap/update-toolchain</a></p>
<p>I'm getting the following error:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>~/dev/lean/OpenSSL.lean λ lake build
Linking libffi.so
error: &gt; /home/arthur/.elan/toolchains/leanprover--lean4---nightly-2022-09-11/bin/leanc -shared -o ./build/lib/libffi.so -Wl,--whole-archive ./build/lib/libffi.a -Wl,--no-whole-archive -L -lssl -fPIC
error: stderr:
ld.lld: error: relocation R_X86_64_PC32 cannot be used against symbol 'stderr'; recompile with -fPIC
&gt;&gt;&gt; defined in /home/arthur/.elan/toolchains/leanprover--lean4---nightly-2022-09-11/lib/glibc/libc.so
&gt;&gt;&gt; referenced by native.c
&gt;&gt;&gt;               ffi.o:(handle_error) in archive ./build/lib/libffi.a

ld.lld: error: relocation R_X86_64_PC32 cannot be used against symbol 'stderr'; recompile with -fPIC
&gt;&gt;&gt; defined in /home/arthur/.elan/toolchains/leanprover--lean4---nightly-2022-09-11/lib/glibc/libc.so
&gt;&gt;&gt; referenced by native.c
&gt;&gt;&gt;               ffi.o:(handle_error) in archive ./build/lib/libffi.a
clang: error: linker command failed with exit code 1 (use -v to see invocation)
error: external command `/home/arthur/.elan/toolchains/leanprover--lean4---nightly-2022-09-11/bin/leanc` exited with code 1
</code></pre></div>
<p>Help is appeciated!</p>



<a name="299866433"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299866433" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299866433">(Sep 21 2022 at 00:14)</a>:</h4>
<p>I think you're passing <code>-fPIC</code> to the linker instead of passing it to the compiler</p>



<a name="299866703"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299866703" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299866703">(Sep 21 2022 at 00:18)</a>:</h4>
<p>How can I pass it to the compiler?</p>



<a name="299866792"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299866792" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mauricio Collares <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299866792">(Sep 21 2022 at 00:19)</a>:</h4>
<p>There's a <code>moreLeancArgs</code> option, but I haven't tested it</p>



<a name="299866837"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299866837" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299866837">(Sep 21 2022 at 00:19)</a>:</h4>
<p>I've already tried <code>moreLeancArgs := #["-fPIC"]</code> and it gets to the same error <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="299869797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299869797" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299869797">(Sep 21 2022 at 00:58)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> you need to add <code>"-fPIC"</code> to the <code>flags</code> of your <code>ffi.o</code> target.</p>



<a name="299869966"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299869966" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299869966">(Sep 21 2022 at 01:00)</a>:</h4>
<p>Oh wow, I had tried that but it didn't work because I hadn't called <code>lake clean</code> first. Doing <code>lake clean</code> and then <code>lake build</code> worked</p>



<a name="299906289"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299906289" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299906289">(Sep 21 2022 at 08:27)</a>:</h4>
<p>Please file an issue on that!</p>



<a name="299930372"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299930372" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299930372">(Sep 21 2022 at 11:08)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> do you mean an issue in the Lake repo?</p>



<a name="299930665"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299930665" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299930665">(Sep 21 2022 at 11:10)</a>:</h4>
<p>Yes. This is not desirable behavior, is it?</p>



<a name="299930729"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299930729" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299930729">(Sep 21 2022 at 11:10)</a>:</h4>
<p>Not rebuilding the library on flag changes, that is</p>



<a name="299949788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/299949788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#299949788">(Sep 21 2022 at 13:01)</a>:</h4>
<p><a href="https://github.com/leanprover/lake/issues/126">https://github.com/leanprover/lake/issues/126</a> <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="307471978"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307471978" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307471978">(Nov 02 2022 at 08:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/262610484">said</a>:</p>
<blockquote>
<p>In short, everything was working fine until I started to make use of <code>string</code> in my C++ code. Now <code>lake build</code> reports a lot of errors like this:</p>
<p><div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">error</span><span class="o">:</span> <span class="n">ld.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">__cxx11</span><span class="o">::</span><span class="n">basic_string</span><span class="bp">&lt;</span><span class="n">char</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span> <span class="bp">&gt;</span><span class="o">::</span><span class="n">data</span><span class="o">()</span> <span class="n">const</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">referenced</span> <span class="kd">by</span> <span class="n">ffi.cpp</span>
<span class="bp">&gt;&gt;&gt;</span>               <span class="n">ffi.o</span><span class="o">:(</span><span class="n">query_all</span><span class="o">(</span><span class="n">mysql</span><span class="bp">*</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">__cxx11</span><span class="o">::</span><span class="n">basic_string</span><span class="bp">&lt;</span><span class="n">char</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span> <span class="bp">&gt;</span><span class="o">))</span> <span class="k">in</span> <span class="n">archive</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">cpp</span><span class="bp">/</span><span class="n">libffi.a</span>

<span class="n">ld.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span><span class="o">::</span><span class="n">allocator</span><span class="o">()</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">referenced</span> <span class="kd">by</span> <span class="n">ffi.cpp</span>
<span class="bp">&gt;&gt;&gt;</span>               <span class="n">ffi.o</span><span class="o">:(</span><span class="n">lean_mysql_manage_db</span><span class="o">(</span><span class="n">lean_object</span><span class="bp">*</span><span class="o">,</span> <span class="n">lean_object</span><span class="bp">*</span><span class="o">,</span> <span class="n">char</span> <span class="n">const</span><span class="bp">*</span><span class="o">))</span> <span class="k">in</span> <span class="n">archive</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">cpp</span><span class="bp">/</span><span class="n">libffi.a</span>

<span class="n">ld.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">__cxx11</span><span class="o">::</span><span class="n">basic_string</span><span class="bp">&lt;</span><span class="n">char</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span> <span class="bp">&gt;</span><span class="o">::</span><span class="n">basic_string</span><span class="o">(</span><span class="n">char</span> <span class="n">const</span><span class="bp">*</span><span class="o">,</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="bp">&lt;</span><span class="n">char</span><span class="bp">&gt;</span> <span class="n">const</span><span class="bp">&amp;</span><span class="o">)</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">referenced</span> <span class="kd">by</span> <span class="n">ffi.cpp</span>
<span class="bp">&gt;&gt;&gt;</span>               <span class="n">ffi.o</span><span class="o">:(</span><span class="n">lean_mysql_manage_db</span><span class="o">(</span><span class="n">lean_object</span><span class="bp">*</span><span class="o">,</span> <span class="n">lean_object</span><span class="bp">*</span><span class="o">,</span> <span class="n">char</span> <span class="n">const</span><span class="bp">*</span><span class="o">))</span> <span class="k">in</span> <span class="n">archive</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">cpp</span><span class="bp">/</span><span class="n">libffi.a</span>
</code></pre></div><br>
</p>
</blockquote>
<p>was a resolution to this ever found? i'm currently trying to link against <a href="https://github.com/arminbiere/cadical">CaDiCaL</a>, which is written in c++, but am getting a bunch of linking errors that look like they're from libstdc++ :(</p>



<a name="307473621"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307473621" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307473621">(Nov 02 2022 at 08:37)</a>:</h4>
<p>actually, okay, switching the compiler to <code>g++</code> and including an explicit <code>-lstdc++</code> linker flag pushes the errors down to linker complaints about <code>-fPIC</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">[</span><span class="n">james</span><span class="o">]</span> <span class="n">eternity2</span> <span class="bp">$</span> <span class="n">lake</span> <span class="n">build</span> <span class="c1">--verbose</span>
<span class="n">info</span><span class="o">:</span> <span class="n">Found</span> <span class="n">dependency</span> <span class="bp">`</span><span class="n">std</span><span class="bp">`</span>
<span class="n">Using</span> <span class="bp">`</span><span class="n">iterators</span><span class="bp">`</span> <span class="n">at</span> <span class="bp">`</span><span class="mi">43</span><span class="n">bbbd68a617a0689d4576b8c26f64209f59cc95</span><span class="bp">`</span>
<span class="n">Compiling</span> <span class="n">cadical_ffi.c</span>
<span class="bp">&gt;</span> <span class="n">g</span><span class="bp">++</span> <span class="bp">-</span><span class="n">c</span> <span class="bp">-</span><span class="n">o</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">c</span><span class="bp">/</span><span class="n">leancadical.o</span> <span class="bp">./</span><span class="n">ffi</span><span class="bp">/</span><span class="n">cadical_ffi.c</span> <span class="bp">-</span><span class="n">I</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/include -I /home/james/Projects/cadical/src -O3 -fPIC</span>
<span class="n">Creating</span> <span class="n">libleancadical.a</span>
<span class="bp">&gt;</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/bin/llvm-ar rcs ./build/lib/libleancadical.a ./build/c/leancadical.o</span>
<span class="n">Linking</span> <span class="n">libleancadical.so</span>
<span class="n">error</span><span class="o">:</span> <span class="bp">&gt;</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/bin/leanc -shared -o ./build/lib/libleancadical.so -Wl,--whole-archive ./build/lib/libleancadical.a -Wl,--no-whole-archive -L /home/james/Projects/cadical/build -l cadical -l stdc++</span>
<span class="n">error</span><span class="o">:</span> <span class="n">stderr</span><span class="o">:</span>
<span class="n">ld.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">relocation</span> <span class="n">R_X86_64_PC32</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">used</span> <span class="n">against</span> <span class="n">symbol</span> <span class="bp">'</span><span class="n">stderr'</span><span class="bp">;</span> <span class="n">recompile</span> <span class="k">with</span> <span class="bp">-</span><span class="n">fPIC</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">defined</span> <span class="k">in</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/lib/glibc/libc.so</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">referenced</span> <span class="kd">by</span> <span class="n">solver.cpp</span>
<span class="bp">&gt;&gt;&gt;</span>               <span class="n">solver.o</span><span class="o">:(</span><span class="n">CaDiCaL</span><span class="o">::</span><span class="n">Solver</span><span class="o">::</span><span class="bp">~</span><span class="n">Solver</span><span class="o">())</span> <span class="k">in</span> <span class="n">archive</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/</span><span class="n">Projects</span><span class="bp">/</span><span class="n">cadical</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">libcadical.a</span>
<span class="bp">...</span>
</code></pre></div>



<a name="307474588"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307474588" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307474588">(Nov 02 2022 at 08:43)</a>:</h4>
<p>lakefile: <a href="https://github.com/JamesGallicchio/eternity2/blob/cadical-ffi/lakefile.lean">https://github.com/JamesGallicchio/eternity2/blob/cadical-ffi/lakefile.lean</a></p>



<a name="307474639"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307474639" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307474639">(Nov 02 2022 at 08:43)</a>:</h4>
<p>if anyone has suggestions for potential fixes, let me know!</p>



<a name="307475322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307475322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307475322">(Nov 02 2022 at 08:48)</a>:</h4>
<p>Oh I just realized Arthur was posting about the same issue</p>



<a name="307477084"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307477084" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307477084">(Nov 02 2022 at 09:00)</a>:</h4>
<p>I now understand that the issue was compiling cadical without <code>-fPIC</code> <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span> seems to work now</p>



<a name="307480083"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307480083" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307480083">(Nov 02 2022 at 09:20)</a>:</h4>
<p>Okay, now I'm confused again... For some reason my lean file with the extern'd functions is not linking against the shared library <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="307573351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307573351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307573351">(Nov 02 2022 at 17:02)</a>:</h4>
<p>Okay, having slept, it seems like the shim file's function names are being mangled by g++. I'm not sure why it's mangling the names at all, given that the file is a <code>.c</code> file, but... <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> investigating</p>



<a name="307619774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307619774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307619774">(Nov 02 2022 at 21:16)</a>:</h4>
<p>After playing around with more combinations of settings I have somehow gotten stuck in an even more cryptic linking error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">info</span><span class="o">:</span> <span class="n">Found</span> <span class="n">dependency</span> <span class="bp">`</span><span class="n">std</span><span class="bp">`</span>
<span class="n">Using</span> <span class="bp">`</span><span class="n">iterators</span><span class="bp">`</span> <span class="n">at</span> <span class="bp">`</span><span class="mi">43</span><span class="n">bbbd68a617a0689d4576b8c26f64209f59cc95</span><span class="bp">`</span>
<span class="n">Compiling</span> <span class="n">cadical_ffi.c</span>
<span class="bp">&gt;</span> <span class="n">cc</span> <span class="bp">-</span><span class="n">c</span> <span class="bp">-</span><span class="n">o</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">c</span><span class="bp">/</span><span class="n">leancadical.o</span> <span class="bp">./</span><span class="n">ffi</span><span class="bp">/</span><span class="n">cadical_ffi.c</span> <span class="bp">-</span><span class="n">I</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/include -I /home/james/Projects/cadical/src -O3 -fPIC</span>
<span class="n">Creating</span> <span class="n">libleancadical.a</span>
<span class="bp">&gt;</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/bin/llvm-ar rcs ./build/lib/libleancadical.a ./build/c/leancadical.o</span>
<span class="n">Linking</span> <span class="n">libleancadical.so</span>
<span class="bp">&gt;</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/bin/leanc -shared -o ./build/lib/libleancadical.so -Wl,--whole-archive ./build/lib/libleancadical.a -Wl,--no-whole-archive -L /home/james/Projects/cadical/build -l cadical</span>
<span class="n">Building</span> <span class="n">Eternity2.AuxDefs</span>
<span class="n">error</span><span class="o">:</span> <span class="bp">&gt;</span> <span class="n">LEAN_PATH</span><span class="bp">=./</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="o">:</span><span class="bp">./</span><span class="n">lean_packages</span><span class="bp">/</span><span class="n">std</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span> <span class="n">LD_LIBRARY_PATH</span><span class="bp">=/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/lib:./build/lib:./build/lib /home/james/.elan/toolchains/leanprover--lean4---nightly-2022-10-27/bin/lean ./././Eternity2/AuxDefs.lean -R ././. -o ./build/lib/Eternity2/AuxDefs.olean -i ./build/lib/Eternity2/AuxDefs.ilean -c ./build/ir/Eternity2/AuxDefs.c --load-dynlib=libleancadical.so</span>
<span class="n">error</span><span class="o">:</span> <span class="n">stderr</span><span class="o">:</span>
<span class="n">libc</span><span class="bp">++</span><span class="n">abi</span><span class="o">:</span> <span class="n">terminating</span> <span class="n">due</span> <span class="n">to</span> <span class="n">uncaught</span> <span class="n">exception</span> <span class="n">of</span> <span class="n">type</span> <span class="n">lean</span><span class="o">::</span><span class="n">exception</span><span class="o">:</span> <span class="n">error</span> <span class="n">loading</span> <span class="n">library</span><span class="o">,</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">libleancadical.so</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">__gxx_personality_v0</span>
<span class="n">error</span><span class="o">:</span> <span class="n">external</span> <span class="n">command</span> <span class="bp">`/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/bin/lean` exited with code 134</span>
</code></pre></div>
<p>Has anyone seen this error before? It's being raised by Lean itself D:</p>



<a name="307621701"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307621701" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307621701">(Nov 02 2022 at 21:30)</a>:</h4>
<p>You could try linking the dynamic library using <code>-Wl,--no-undefined</code>, which might give a better error message if the symbol is already undefined at that stage</p>



<a name="307655578"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307655578" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307655578">(Nov 03 2022 at 04:24)</a>:</h4>
<p>That was very helpful, actually! I got cadical building with <code>clang</code>, which is a step in the right direction, and now the linker error seems to be just to do with Lean stuff</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Compiling</span> <span class="n">cadical_ffi.c</span>
<span class="bp">&gt;</span> <span class="n">clang</span> <span class="bp">-</span><span class="n">c</span> <span class="bp">-</span><span class="n">o</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">c</span><span class="bp">/</span><span class="n">leancadical.o</span> <span class="bp">./</span><span class="n">ffi</span><span class="bp">/</span><span class="n">cadical_ffi.c</span> <span class="bp">-</span><span class="n">I</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/include -I /home/james/Projects/cadical/src -O3 -fPIC</span>
<span class="n">Creating</span> <span class="n">libleancadical.a</span>
<span class="bp">&gt;</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/bin/llvm-ar rcs ./build/lib/libleancadical.a ./build/c/leancadical.o</span>
<span class="n">Linking</span> <span class="n">libleancadical.so</span>
<span class="n">error</span><span class="o">:</span> <span class="bp">&gt;</span> <span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">james</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="c1">--lean4---nightly-2022-10-27/bin/leanc -shared -o ./build/lib/libleancadical.so -Wl,--whole-archive ./build/lib/libleancadical.a -Wl,--no-whole-archive -L/home/james/Projects/cadical/build -lcadical --no-undefined</span>
<span class="n">error</span><span class="o">:</span> <span class="n">stderr</span><span class="o">:</span>
<span class="n">ld.lld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">undefined</span> <span class="n">symbol</span><span class="o">:</span> <span class="n">lean_register_external_class</span>
<span class="bp">&gt;&gt;&gt;</span> <span class="n">referenced</span> <span class="kd">by</span> <span class="n">cadical_ffi.c</span>
<span class="bp">&gt;&gt;&gt;</span>               <span class="n">leancadical.o</span><span class="o">:(</span><span class="n">leancadical_initialize</span><span class="o">)</span> <span class="k">in</span> <span class="n">archive</span> <span class="bp">./</span><span class="n">build</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">libleancadical.a</span>
</code></pre></div>
<p>I'm assuming <code>leanc</code>adds the proper search paths to the clang call to find the lean objects, no?</p>



<a name="307685172"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307685172" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307685172">(Nov 03 2022 at 09:24)</a>:</h4>
<p>Ah, right. If that is the only remaining error, you can drop the <code>--no-undefined</code> again. <a href="https://github.com/leanprover/lean4/blob/5249611d75c18e449c19cb8eaa071d00c3347e44/src/CMakeLists.txt#L330-L332">https://github.com/leanprover/lean4/blob/5249611d75c18e449c19cb8eaa071d00c3347e44/src/CMakeLists.txt#L330-L332</a></p>



<a name="307796125"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307796125" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307796125">(Nov 03 2022 at 17:11)</a>:</h4>
<p>Hrm, it actually was not the only remaining error... D: my lack of C++ experience is unfortunate here. what flags does the <code>leanc</code> wrapper pass to clang automatically? (if any)</p>



<a name="307796738"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307796738" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307796738">(Nov 03 2022 at 17:15)</a>:</h4>
<p>I'm gonna see if I can write a makefile to compile the lean generated c files with the shim/dependency, and then I'll work backwards to figure out what the right  setup is in a lakefile</p>



<a name="307796862"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/307796862" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#307796862">(Nov 03 2022 at 17:15)</a>:</h4>
<p>You can use <code>leanc -v ...</code> to see the flags</p>



<a name="308165685"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/308165685" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#308165685">(Nov 05 2022 at 16:47)</a>:</h4>
<p>I think after a week of trying to get this to compile, my friends and I have thrown in the towel <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> just gonna use an equivalent library written in C</p>
<p>We're still not entirely sure why we can't get the program to link successfully, but I committed the closest attempt we had here:<br>
<a href="https://github.com/JamesGallicchio/eternity2/tree/cadical-ffi-test">https://github.com/JamesGallicchio/eternity2/tree/cadical-ffi-test</a><br>
<code>lake run setup</code> clones the required c++ dependency, and <code>lake build</code> leads to linker error <span aria-label="pensive" class="emoji emoji-1f614" role="img" title="pensive">:pensive:</span> maybe someone will find the info there useful in the future</p>



<a name="308216213"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/308216213" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#308216213">(Nov 06 2022 at 05:13)</a>:</h4>
<p><span class="user-mention" data-user-id="497571">@Parth Shastri</span> is amazing and figured out how to get it running (still not entirely sure why, but it <em>is</em> working)</p>



<a name="308235298"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/308235298" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#308235298">(Nov 06 2022 at 10:13)</a>:</h4>
<p>It would be nice to contribute everything you figured out in some kind of documentation.</p>



<a name="315945175"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/315945175" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Matej Penciak <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#315945175">(Dec 15 2022 at 01:26)</a>:</h4>
<p>We're attempting a Rust &lt;-&gt; C++ &lt;-&gt; Lean FFI setup, and as expected with such a complicated setup, we're running into some tricky compiler issues we were hoping someone may have more knowledge about.</p>
<p>An example of our attempt can be found here: <a href="https://github.com/yatima-inc/FFI.lean">https://github.com/yatima-inc/FFI.lean</a></p>
<p>To summarize the attempt, we're trying to bridge Rust &lt;-&gt; C++ by using the CXX crate to generate some <code>.cc</code> files. Those, together with a <code>.cpp</code> "shim", are pointed to in the <code>lakefile</code> as external libraries to link to a very simple function: <a href="https://github.com/yatima-inc/FFI.lean/blob/d657ecc025c44bb835a9eecafd40e97ab9accaf3/lean/FFI.lean#L1">https://github.com/yatima-inc/FFI.lean/blob/d657ecc025c44bb835a9eecafd40e97ab9accaf3/lean/FFI.lean#L1</a></p>
<p>The strange thing is that this fragile setup actually works for one of the teammates <span class="user-mention" data-user-id="441012">@Sam Burnham</span> ! For others, we're all generally running into the same linker error:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>error: stderr:
libc++abi: terminating due to uncaught exception of type lean::exception: error loading library, ./build/src/libffi.so: undefined symbol: _ZNSt8ios_base4InitD1Ev
error: external command `/home/matej/.elan/toolchains/leanprover--lean4---nightly-2022-12-08/bin/lean` exited with code 134
</code></pre></div>
<p>The only discernible difference between our environments is that if I call <code>leanc -v</code> I get some stuff about <code>clang</code>, whereas when Sam runs the same command he sees the same message with <code>clang</code> replaced by <code>gcc</code>. It's just a shot in the dark, but could this difference in compilers be causing the issue?</p>
<p>If so, is there a way to force <code>leanc</code> to point to a particular C compiler?</p>



<a name="315987082"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/315987082" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#315987082">(Dec 15 2022 at 09:05)</a>:</h4>
<p>Yeah, looks like a C++ stdlib conflict similar to what was reported above, so hopefully something like this should work for you as well: <a href="https://github.com/JamesGallicchio/eternity2/blob/cadical-ffi-test/lakefile.lean#L13">https://github.com/JamesGallicchio/eternity2/blob/cadical-ffi-test/lakefile.lean#L13</a></p>



<a name="316040847"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316040847" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316040847">(Dec 15 2022 at 13:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/315987082">said</a>:</p>
<blockquote>
<p>Yeah, looks like a C++ stdlib conflict similar to what was reported above, so hopefully something like this should work for you as well: <a href="https://github.com/JamesGallicchio/eternity2/blob/cadical-ffi-test/lakefile.lean#L13">https://github.com/JamesGallicchio/eternity2/blob/cadical-ffi-test/lakefile.lean#L13</a></p>
</blockquote>
<p>That works for Sam, but for some reason it doesn't seem to make a difference for me and Matej</p>



<a name="316046011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316046011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316046011">(Dec 15 2022 at 13:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/307621701">said</a>:</p>
<blockquote>
<p>You could try linking the dynamic library using <code>-Wl,--no-undefined</code>, which might give a better error message if the symbol is already undefined at that stage</p>
</blockquote>



<a name="316068152"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316068152" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316068152">(Dec 15 2022 at 15:26)</a>:</h4>
<p>Oh, that shows a lot more info:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>Linking libffi.so
error: &gt; /home/arthur/.elan/toolchains/leanprover--lean4---nightly-2022-12-08/bin/leanc -shared -o ./build/src/libffi.so -Wl,--whole-archive ./build/src/libffi.a -Wl,--no-whole-archive -Wl --no-undefined -L ./target/debug -l ffi -lstdc++
error: stderr:
ld.lld: error: undefined symbol: std::allocator&lt;char&gt;::allocator()
&gt;&gt;&gt; referenced by cxx.cc:9 (src/cxx.cc:9)
&gt;&gt;&gt;               cxx.o:(cxxbridge1$cxx_string$init) in archive ./target/debug/libffi.a
&gt;&gt;&gt; referenced by cxx.cc:204 (src/cxx.cc:204)
&gt;&gt;&gt;               cxx.o:(_ZNK4rust10cxxbridge16StringcvNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEEv) in archive ./target/debug/libffi.a
&gt;&gt;&gt; referenced by cxx.cc:317 (src/cxx.cc:317)
&gt;&gt;&gt;               cxx.o:(_ZNK4rust10cxxbridge13StrcvNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEEv) in archive ./target/debug/libffi.a
</code></pre></div>
<p>There are a lot more errors like this</p>



<a name="316069077"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316069077" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316069077">(Dec 15 2022 at 15:29)</a>:</h4>
<p>But now this is looking like an error that I had in the past that I couldn't figure out: linking C++ code</p>



<a name="316070694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316070694" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316070694">(Dec 15 2022 at 15:36)</a>:</h4>
<p>If you can first link the C++ code into a shared library and then link that with the Lean code, that should be a much easier and robust approach</p>



<a name="316138688"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316138688" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316138688">(Dec 15 2022 at 20:56)</a>:</h4>
<p>Sorry, is there some working example of a Lean 4 program that uses C++ code and that's compiled with Lake?</p>



<a name="316710530"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316710530" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316710530">(Dec 19 2022 at 10:41)</a>:</h4>
<p>Yes-- let me get the link......</p>



<a name="316710616"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316710616" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316710616">(Dec 19 2022 at 10:42)</a>:</h4>
<p>I meant to document this at some point but the end of the semester stepped on those plans <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="316710845"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316710845" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316710845">(Dec 19 2022 at 10:43)</a>:</h4>
<p><a href="https://github.com/JamesGallicchio/eternity2/blob/main/lean/lakefile.lean">https://github.com/JamesGallicchio/eternity2/blob/main/lean/lakefile.lean</a></p>
<p>^ there are lake scripts here that download/build the c++ source for cadical, along with a custom C FFI shim, and patch everything together</p>



<a name="316712266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316712266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316712266">(Dec 19 2022 at 10:51)</a>:</h4>
<p>Some notes:</p>
<ul>
<li>I'm not entirely sure why, but <code>libstdc++.so.6</code> needs to be on the linker path for non-mac users, not the generic <code>-lstdc++</code> argument. I'm not sure if this will work for libraries that aren't CaDiCaL</li>
<li>Using <code>gcc</code> <em>did not</em> work for us, which is why we are compiling cadical+our C shim explicitly with clang. I have tested this on clang 14, but nothing newer/older</li>
<li>The c++ library's compiled <code>.a</code> <em>needs to be</em> in the <code>build/lib</code> folder when compiling the FFI shim.  you can't add it to the path elsewhere. This is a lake restriction (unless Mac has changed <code>buildStaticLib</code> in the last month)</li>
<li><code>precompileModules := true</code> seems to break the build process for some systems? I did not investigate this much but if you run into weird issues that might be the culprit</li>
</ul>



<a name="316712624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/316712624" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#316712624">(Dec 19 2022 at 10:53)</a>:</h4>
<p>Also, this build stack is incredibly fragile and I am scared to change any of it. <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="319503302"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319503302" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319503302">(Jan 05 2023 at 01:46)</a>:</h4>
<p>Hi all, how can I access a structure attribute in C?<br>
I have this Lean structure:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">ByteVector</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">data</span>  <span class="o">:</span> <span class="n">ByteArray</span>
  <span class="n">valid</span> <span class="o">:</span> <span class="n">data.size</span> <span class="bp">=</span> <span class="n">n</span>
</code></pre></div>
<p>And this function:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">@[extern "lean_byte_vector_to_uint16"]</span>
<span class="n">opaque</span> <span class="n">toUInt16</span> <span class="o">:</span> <span class="bp">@&amp;</span> <span class="n">ByteVector</span> <span class="mi">2</span> <span class="bp">→</span> <span class="n">UInt16</span>
</code></pre></div>
<p>If my input were a simple <code>ByteArray</code>, I would do this:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="n">l_res</span><span class="w"> </span><span class="nf">lean_byte_vector_to_uint16</span><span class="p">(</span><span class="n">l_arg</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="p">((</span><span class="kt">uint16_t</span><span class="o">*</span><span class="p">)</span><span class="n">lean_to_sarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">m_data</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>But this will obviously fail for <code>ByteVector</code>s</p>



<a name="319503771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319503771" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319503771">(Jan 05 2023 at 01:54)</a>:</h4>
<p>You're lucky: <code>ByteVector n</code> has the same runtime representation as <code>ByteArray</code>.</p>



<a name="319503858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319503858" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319503858">(Jan 05 2023 at 01:55)</a>:</h4>
<p>How come?</p>



<a name="319503869"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319503869" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hanting Zhang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319503869">(Jan 05 2023 at 01:55)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> To explain more: Lean's runtime will analyze structure fields.</p>



<a name="319503895"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319503895" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hanting Zhang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319503895">(Jan 05 2023 at 01:55)</a>:</h4>
<p>In particular, if a structure is "trivial" in the sense that it only has <em>one</em> computationally relevant field, then the runtime of that structure will be unboxed to the relevant field</p>



<a name="319503942"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319503942" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319503942">(Jan 05 2023 at 01:56)</a>:</h4>
<p>Does this mean that my C code will just work?</p>



<a name="319503958"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319503958" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hanting Zhang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319503958">(Jan 05 2023 at 01:56)</a>:</h4>
<p>Here, <code>valid</code> has no computational value so the runtime replaces all <code>ByteVector</code>s with <code>ByteArray</code></p>



<a name="319503971"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319503971" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319503971">(Jan 05 2023 at 01:56)</a>:</h4>
<p>I see, that makes sense</p>



<a name="319503972"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319503972" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hanting Zhang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319503972">(Jan 05 2023 at 01:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/319503942">said</a>:</p>
<blockquote>
<p>Does this mean that my C code will just work?</p>
</blockquote>
<p>Yes (btw this is also why Chars are <code>UInt32</code>s in Lean's runtime)</p>



<a name="319504085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319504085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Hanting Zhang <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319504085">(Jan 05 2023 at 01:58)</a>:</h4>
<p>This is also why in core you'll see a lot of stuff like </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">structure</span> <span class="n">FVarId</span> <span class="n">where</span>
  <span class="n">fvarId</span> <span class="o">:</span> <span class="n">Nat</span>
</code></pre></div>
<p>where it seemingly unnecessarily wraps <code>Nat</code>. But in fact there's no overhead since <code>FVarId</code> is trivial and will unwrap to <code>Nat</code></p>



<a name="319504243"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319504243" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319504243">(Jan 05 2023 at 02:00)</a>:</h4>
<p>If it weren't unwrapped (ie. the struct had multiple fields), you'd use the <a href="https://github.com/leanprover/lean4/blob/master/src/include/lean/lean.h#L548"><code>lean_ctor_get</code></a> function :)</p>



<a name="319504380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319504380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319504380">(Jan 05 2023 at 02:02)</a>:</h4>
<p>(BTW, if I wanted to flesh out the FFI API documentation in the manual, what would the process be for that?)</p>



<a name="319790465"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319790465" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319790465">(Jan 06 2023 at 14:21)</a>:</h4>
<p>How can I use <code>lean_nat_to_size_t</code> from <code>runtime/object.cpp</code> on a C function I am implementing?</p>



<a name="319791165"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319791165" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319791165">(Jan 06 2023 at 14:25)</a>:</h4>
<p>Since it is not exposed via C FFI I would say you can't in a nice way. I guess you could just pray that the linker finds the symbol during compilation but in general it does not seem to be made for external use as of now.</p>



<a name="319791475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319791475" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319791475">(Jan 06 2023 at 14:26)</a>:</h4>
<p>Hmm, so handling <code>Nat</code>s is impractical, right?</p>



<a name="319795471"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319795471" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319795471">(Jan 06 2023 at 14:46)</a>:</h4>
<p>This will do for now</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">size_t</span><span class="w"> </span><span class="nf">nat_to_size_t</span><span class="p">(</span><span class="n">lean_obj_arg</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lean_is_scalar</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">lean_unbox</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="n">lean_internal_panic_out_of_memory</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I'm not interested in arbitrarily large values</p>



<a name="319815351"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319815351" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319815351">(Jan 06 2023 at 16:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/C.20FFI.20usage/near/319791475">said</a>:</p>
<blockquote>
<p>Hmm, so handling <code>Nat</code>s is impractical, right?</p>
</blockquote>
<p>Handling unbounded Nats in C generally is hard <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<a name="319818778"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319818778" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319818778">(Jan 06 2023 at 16:48)</a>:</h4>
<p>Yeah, but I meant in terms of reusing the infra that's already set</p>



<a name="319819589"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319819589" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> James Gallicchio <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319819589">(Jan 06 2023 at 16:52)</a>:</h4>
<p>Yeah, we might need a repo for common utility functions and stuff... Out of curiosity, what code are you building an interface to right now?</p>



<a name="319820353"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319820353" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319820353">(Jan 06 2023 at 16:56)</a>:</h4>
<p>For now:</p>
<ul>
<li><a href="https://github.com/yatima-inc/YatimaStdLib.lean/blob/main/YatimaStdLib/ByteArray.lean"><code>ByteArray</code></a></li>
<li><a href="https://github.com/yatima-inc/YatimaStdLib.lean/blob/main/YatimaStdLib/UInt.lean"><code>UInt</code></a></li>
<li><a href="https://github.com/yatima-inc/YatimaStdLib.lean/blob/main/YatimaStdLib/ByteVector.lean"><code>ByteVector</code></a></li>
</ul>



<a name="319820973"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319820973" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319820973">(Jan 06 2023 at 17:00)</a>:</h4>
<p>The duplicated interfaces are temporary. That's because we haven't migrated our test suites to <code>lspecIO</code> yet. So we are doing tests with the <code>#lspec</code> command for now</p>



<a name="319821751"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/C%20FFI%20usage/near/319821751" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/C.20FFI.20usage.html#319821751">(Jan 06 2023 at 17:04)</a>:</h4>
<p>Ultimately we want to interface with <a href="https://docs.rs/neptune/latest/neptune/">https://docs.rs/neptune/latest/neptune/</a></p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>