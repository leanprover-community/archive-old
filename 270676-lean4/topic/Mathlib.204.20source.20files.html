---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Mathlib.204.20source.20files.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html">Mathlib 4 source files</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="238283727"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238283727" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Aurélien Saue <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238283727">(May 11 2021 at 10:25)</a>:</h4>
<p>Hi everyone,<br>
So I have been working on creating Lean4 source files for Mathlib from the tlean files. For now, <code>sorry</code> is used everywhere, but apart from that the results are getting decent.<br>
What I have worked on is mainly:</p>
<ul>
<li>detecting autogenerated definitions</li>
<li>prettyprinting classes, structures, inductive types, instances and notations</li>
<li>moving a reasonable amount of arguments before the colon in definitions and theorems</li>
<li>parsing the namespace structure and comments of the Lean3 source files</li>
</ul>
<p>There are still a handful of problems, some of the most frequent being:</p>
<ul>
<li>prettyprinted expressions that do not compile because of missing type annotations or implicit arguments that cannot be synthesized, </li>
<li>class/structure extensions not handled</li>
</ul>
<p>Here is for instance the result I get on algebra/add_torsor: <a href="https://gist.github.com/AurelienSaue/4d9e54100bb231a1196c881dfcb63454">https://gist.github.com/AurelienSaue/4d9e54100bb231a1196c881dfcb63454</a><br>
What do you think of the approach?</p>



<a name="238286967"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238286967" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238286967">(May 11 2021 at 10:55)</a>:</h4>
<p>Just glancing through that file, it looks marvellous!</p>



<a name="238287063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238287063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238287063">(May 11 2021 at 10:56)</a>:</h4>
<p>About the <code>sorry</code>d proofs: do you have plans to also auto-port those later on?</p>



<a name="238287296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238287296" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Aurélien Saue <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238287296">(May 11 2021 at 10:59)</a>:</h4>
<p>Yes that would of course be great  but the main problem for now is that a lot of them are referencing autogenerated definitions (<code>._main</code>, <code>._proof_1</code>, ...) which are eliminated</p>



<a name="238288860"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238288860" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238288860">(May 11 2021 at 11:11)</a>:</h4>
<p>Seeing progress on this is wonderful! Do you think you could do anything to hide of these universe variables? I guess the original file has <code>Type*</code> everywhere and not a single explicit <code>max</code> or universes.</p>



<a name="238288946"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238288946" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238288946">(May 11 2021 at 11:12)</a>:</h4>
<p>Something very easy to fix would be to remove those empty lines between docstrings and declarations.</p>



<a name="238289220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238289220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Aurélien Saue <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238289220">(May 11 2021 at 11:14)</a>:</h4>
<p>Yes sure I will try, that should not be too hard</p>



<a name="238354326"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238354326" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238354326">(May 11 2021 at 17:50)</a>:</h4>
<p>Just checking, but the <code>[(i : I) → add_group (fg i)]</code> (in <code>add_torsor</code>) is not valid Lean 4, right? Functions can't be classes?</p>



<a name="238354422"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238354422" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238354422">(May 11 2021 at 17:50)</a>:</h4>
<p>I think it's valid.</p>



<a name="238354425"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238354425" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238354425">(May 11 2021 at 17:50)</a>:</h4>
<p>It's valid in lean 3</p>



<a name="238354514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238354514" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238354514">(May 11 2021 at 17:51)</a>:</h4>
<p>lean will just do typeclass search in the extended context</p>



<a name="238354555"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238354555" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238354555">(May 11 2021 at 17:51)</a>:</h4>
<p>the requirement is only that it be a pi type ending in a class</p>



<a name="238355363"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238355363" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238355363">(May 11 2021 at 17:57)</a>:</h4>
<p>interesting! I learn something new about Lean every day :)</p>



<a name="238810908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238810908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238810908">(May 14 2021 at 18:37)</a>:</h4>
<p>FYI there has been some off-channel discussion of an alternative approach to porting that avoids the <code>.tlean</code>s and tries to port syntax directly. Specifically, this would entail:</p>
<ul>
<li>writing a complete lean3/mathlib parser in lean4 (without elaboration)</li>
<li>writing syntax transformers to convert the parsed syntax to lean4 syntax (e.g. <code>fun _, _</code> -&gt; <code>fun _ =&gt; _</code>)</li>
<li>improving the formatter (not the delaborator) so the generated lean4 files are (mostly) aesthetic</li>
<li>dealing with the gillion squiggly lines this will produce (e.g. from missing or modified tactics, elaborator changes, etc)<ul>
<li>possibly by implementing missing tactics</li>
<li>possibly by updating syntax transformers </li>
<li>possibly by running bulk automation (e.g. a "squeezing" tree-search tactic)</li>
<li>probably largely by hand</li>
</ul>
</li>
</ul>



<a name="238811238"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238811238" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238811238">(May 14 2021 at 18:40)</a>:</h4>
<blockquote>
<p>writing a complete lean3/mathlib parser in lean4 (without elaboration)</p>
</blockquote>
<p>I want to add that an alternative to this is to modify lean 3 to produce AST export data, kind of like tlean but focused on the input syntax, and then parsing that export data in lean 4</p>



<a name="238811966"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/238811966" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#238811966">(May 14 2021 at 18:46)</a>:</h4>
<p>I believe <span class="user-mention" data-user-id="399706">@Aurélien Saue</span>'s tool is also parsing the Lean 3 source file to extract comments, etc. (in addition to the mathported olean file).  <a href="#narrow/stream/270676-lean4/topic/Mathlib.204.20source.20files/near/238283727">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib.204.20source.20files/near/238283727</a></p>



<a name="239051407"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239051407" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Aurélien Saue <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239051407">(May 17 2021 at 08:30)</a>:</h4>
<p>Sorry for seeing this so late.<br>
This seems like a very good idea to me since all the issues I face currently are due to delaboration. <br>
Has anyone started this process yet?</p>



<a name="239530403"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239530403" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239530403">(May 20 2021 at 03:53)</a>:</h4>
<p>I just quickly scraped together a scaffold: <a href="https://github.com/dselsam/synport">https://github.com/dselsam/synport</a></p>



<a name="239530490"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239530490" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239530490">(May 20 2021 at 03:54)</a>:</h4>
<p>this is for the "complete lean3/mathlib parser in lean4" plan, right?</p>



<a name="239530533"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239530533" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239530533">(May 20 2021 at 03:55)</a>:</h4>
<ul>
<li><code>synport.py</code>: takes a lean3 file and prints the lean4 file to stdout</li>
<li>it does this by prepending <code>import SynPort; #lean3</code> to the file and calling lean4 on the resulting file</li>
<li>the lean4 elaboration of the <code>#lean3</code> command will do the rest</li>
<li>there is almost no syntax/transformers there yet, but enough to see the pattern</li>
</ul>



<a name="239530536"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239530536" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239530536">(May 20 2021 at 03:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204.20source.20files/near/239530490">said</a>:</p>
<blockquote>
<p>this is for the "complete lean3/mathlib parser in lean4" plan, right?</p>
</blockquote>
<p>Yes.</p>



<a name="239530576"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239530576" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239530576">(May 20 2021 at 03:56)</a>:</h4>
<p>I'm not sure that a fully faithful lean 3 parser can be written in the lean 4 parser infrastructure. In particular lean 3 parsers can do IO and access the tactic state</p>



<a name="239530740"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239530740" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239530740">(May 20 2021 at 03:59)</a>:</h4>
<p>What do you think this means for SynPort in practice? How many things will be unparseable? Can you backport a sanity-restriction to prevent this behavior?</p>



<a name="239531131"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239531131" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239531131">(May 20 2021 at 04:04)</a>:</h4>
<p>Not clear. I have long held the belief that lean 3 parsing for anything other than lean 3 is nigh impossible, and I have had very little success in approximating it from the outside. Plus the lean 3 grammar is pretty complicated even assuming the edge cases are somehow dealt with, and portions of the grammar (tactic parsers) are written in lean and it's not clear how to get at that without adding a lean 3 interpreter to the mix</p>



<a name="239531216"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239531216" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239531216">(May 20 2021 at 04:05)</a>:</h4>
<p>My guess is that we can find a way to syn-port the parts that syn-port and skip the edge cases, and that it will work well for a big chunk of the library</p>



<a name="239531270"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239531270" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239531270">(May 20 2021 at 04:06)</a>:</h4>
<p>In my manual porting experiments on top of mathport, so much of the work was just changing lambda/match syntax + friends</p>



<a name="239531385"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239531385" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239531385">(May 20 2021 at 04:08)</a>:</h4>
<p>One way to get something close without too much work is to copy and paste the lean 4 grammar and see if it works on lean 4 files</p>



<a name="239531471"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239531471" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239531471">(May 20 2021 at 04:09)</a>:</h4>
<p>did you mean for those both to be 4s?</p>



<a name="239531480"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239531480" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239531480">(May 20 2021 at 04:09)</a>:</h4>
<p>yes</p>



<a name="239531601"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239531601" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239531601">(May 20 2021 at 04:10)</a>:</h4>
<p>lean 4 already has its own grammar written using lean 4 notations, so if you use that as a base for modification you can get a rough lean 3 parser easier than if you wrote one from scratch</p>



<a name="239531642"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239531642" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239531642">(May 20 2021 at 04:11)</a>:</h4>
<p>That I definitely agree with. I was assuming we would effectively copy-paste.</p>



<a name="239531743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239531743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239531743">(May 20 2021 at 04:12)</a>:</h4>
<p>Note: I tried just adding new Lean4 syntax for the lean3 fun and match, and it seemed to work well also. So we could even try reusing Lean4's <code>term</code> category, but it seems like it could cause problems downstream</p>



<a name="239531947"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239531947" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239531947">(May 20 2021 at 04:16)</a>:</h4>
<p>No we want <code>term3</code> because we are going to reflect on tactic proofs</p>



<a name="239546055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239546055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239546055">(May 20 2021 at 07:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204.20source.20files/near/239531947">said</a>:</p>
<blockquote>
<p>No we want <code>term3</code> because we are going to reflect on tactic proofs</p>
</blockquote>
<p>What exactly does that mean?</p>



<a name="239549012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239549012" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239549012">(May 20 2021 at 07:47)</a>:</h4>
<p>We want to be able to transform the lean 3 tactic AST into equivalent lean 4 tactic structures. It's not clear that this can be done if we just directly produce lean 4 exprs because when they get elaborated we lose the tactics. But I might just be confused about lean 4 macro expansion</p>



<a name="239549417"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239549417" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239549417">(May 20 2021 at 07:50)</a>:</h4>
<p>Ah no, I don't think the plan is to expand <em>all</em> macros in order to move from Lean 3 to Lean 4 syntax, if that is what you were referring to. Instead we would selectively expand macros from <code>SynPort</code> only.</p>



<a name="239549681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239549681" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239549681">(May 20 2021 at 07:52)</a>:</h4>
<p>I.e. if there is a mathlib3 tactic that we want to map to an existing/different Lean 4 syntax, we would describe it as a macro and expand away, but no further.</p>



<a name="239549816"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239549816" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239549816">(May 20 2021 at 07:54)</a>:</h4>
<p>right, I don't really know how macro expansion is controlled like that</p>



<a name="239549907"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239549907" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239549907">(May 20 2021 at 07:55)</a>:</h4>
<p>What about type-aware expansion? For example we might want to select a lean 4 tactic based on what actually works on the given goal</p>



<a name="239550412"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239550412" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239550412">(May 20 2021 at 08:00)</a>:</h4>
<p>Hah, alright, that would be the next difficulty level. We could possibly retrieve that information from the <code>InfoTree</code>, which is the data structure used to transfer infromation from the elaborator to the server.</p>



<a name="239550595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239550595" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239550595">(May 20 2021 at 08:01)</a>:</h4>
<p>Currently the info tree only holds macro expansion steps, not elaboration steps, but we will likely need to change that anyway if we want to implement "go to macro/elaborator" on arbitrary syntax.</p>



<a name="239550714"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239550714" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239550714">(May 20 2021 at 08:02)</a>:</h4>
<p>I was thinking we could parse the whole file into some <code>command3</code> syntax object, then write an elaborator that uses the syntax object as instructions to construct a lean 4 syntax and simultaneously elaborate it to inform the construction</p>



<a name="239550882"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239550882" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239550882">(May 20 2021 at 08:04)</a>:</h4>
<p>So you basically want to reimplement (an extended version of) the Lean 3 elaborator in Lean 4? I would have hoped we could avoid that.</p>



<a name="239550918"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239550918" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239550918">(May 20 2021 at 08:04)</a>:</h4>
<p>Not really, it is the lean 4 elaborator which is informing the construction</p>



<a name="239550986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239550986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239550986">(May 20 2021 at 08:05)</a>:</h4>
<p>Okay, I'm not completely sure how you will coerce/extend the Lean 4 elaborator into constructing a new syntax tree on the side</p>



<a name="239551031"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239551031" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239551031">(May 20 2021 at 08:06)</a>:</h4>
<p>But also we should evaluate how often we actually think that will happen and if it is worthwhile to automate it away, or if it makes sense to offload it to the manual porting steps that will need to happen anyway. Same with Lean 3 parsing using I/O, how often does that happen?</p>



<a name="239551150"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239551150" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239551150">(May 20 2021 at 08:07)</a>:</h4>
<p>True, there is an obvious fallback if this doesn't work or isn't useful enough. I figure that given the size of mathlib it's worth investing in anything we can do to improve the success rate</p>



<a name="239551387"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239551387" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239551387">(May 20 2021 at 08:09)</a>:</h4>
<p>I agree. The <code>InfoTree</code> would be my best bet for doing that so far.</p>



<a name="239551699"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239551699" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239551699">(May 20 2021 at 08:12)</a>:</h4>
<p>To give an example of what I mean, suppose there is a lean 3 tactic <code>foo</code> that lean 4 writes as <code>bar</code> on goals of the form <code>|- bar</code> and <code>foo</code> otherwise. So we parse <code>foo : tactic3</code>, and then we have a program with type <code>Syntax -&gt; Option Expr -&gt; TermElabM Syntax</code> which does:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="k">fun</span> <span class="bp">`</span><span class="o">(</span><span class="n">foo</span><span class="o">:</span><span class="n">tactic3</span><span class="o">)</span> <span class="n">expectedType</span><span class="bp">?</span> <span class="bp">=&gt;</span>
  <span class="k">if</span> <span class="n">expectedType</span><span class="bp">?</span> <span class="bp">=</span> <span class="n">some</span> <span class="bp">`</span><span class="o">(</span><span class="n">bar</span><span class="o">)</span> <span class="k">then</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="n">bar</span><span class="o">)</span> <span class="k">else</span> <span class="bp">`</span><span class="o">(</span><span class="n">tactic</span><span class="bp">|</span> <span class="n">foo</span><span class="o">)</span>
</code></pre></div>



<a name="239551822"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239551822" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239551822">(May 20 2021 at 08:13)</a>:</h4>
<p>in general, it would go through the motions of actually running said lean 4 tactic, in addition to constructing the syntax for the tactic</p>



<a name="239551902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239551902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239551902">(May 20 2021 at 08:14)</a>:</h4>
<p>If you use <a href="https://github.com/leanprover/lean4/blob/cd5dbc66ce2fd6bf1d38e40599a279df8c01a9ce/src/Lean/Elab/Term.lean#L1167-L1169"><code>adaptExpander</code></a>, this will actually log the transformation in the info tree today.</p>



<a name="239552022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239552022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239552022">(May 20 2021 at 08:15)</a>:</h4>
<p>(tactic version: <a href="https://github.com/leanprover/lean4/blob/cd5dbc66ce2fd6bf1d38e40599a279df8c01a9ce/src/Lean/Elab/Tactic/Basic.lean#L258-L260">https://github.com/leanprover/lean4/blob/cd5dbc66ce2fd6bf1d38e40599a279df8c01a9ce/src/Lean/Elab/Tactic/Basic.lean#L258-L260</a>)</p>



<a name="239552598"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239552598" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239552598">(May 20 2021 at 08:21)</a>:</h4>
<p>This would still not be perfect since it doesn't know lean 3's opinion about how it is supposed to elaborate, which is often more important than lean 4's reconstruction. That could be addressed by augmenting the lean 3 AST dump with type information about the goal state after each tactic or at each application. I think that the highest fidelity version would be if lean 3 elaborated everything into an AST dump and lean 4 parsed that instead of trying to parse lean 3 directly. That way lean 4 would have access both to the lean 3 type information and the lean 4 type information and could fill in motives and repair gaps.</p>



<a name="239595887"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239595887" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239595887">(May 20 2021 at 14:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204.20source.20files/near/239549417">said</a>:</p>
<blockquote>
<p>Ah no, I don't think the plan is to expand <em>all</em> macros in order to move from Lean 3 to Lean 4 syntax, if that is what you were referring to. Instead we would selectively expand macros from <code>SynPort</code> only.</p>
</blockquote>
<p>Right -- the current scaffold doesn't even use macros, it is literally a function <code>Syntax -&gt; &lt;some monad&gt; Syntax</code> that we have complete control over.</p>



<a name="239596006"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239596006" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239596006">(May 20 2021 at 14:00)</a>:</h4>
<p>It then calls the formatter on the new syntax and that is it.</p>



<a name="239596789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239596789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239596789">(May 20 2021 at 14:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204.20source.20files/near/239549907">said</a>:</p>
<blockquote>
<p>What about type-aware expansion? For example we might want to select a lean 4 tactic based on what actually works on the given goal</p>
</blockquote>
<p>This could be a second pass -- i.e. read the new lean4 files and for each squiggly in a proof, try running proof search and if it works, replace what is there with the new proof.</p>



<a name="239597937"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239597937" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239597937">(May 20 2021 at 14:11)</a>:</h4>
<p>^ I wouldn't even want to try this right away, not until manually inspecting a bunch of the squigglies to see if they are caused by important issues/bugs</p>



<a name="239680298"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204%20source%20files/near/239680298" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.20source.20files.html#239680298">(May 21 2021 at 00:38)</a>:</h4>
<p>(deleted, posted in the wrong thread!)</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>