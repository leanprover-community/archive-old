---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html">wasm nix emscripten build</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="267660653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/267660653" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#267660653">(Jan 11 2022 at 23:14)</a>:</h4>
<p>I've started looking into working on the wasm emscripten build support (using nix).<br>
It seems like it is currently broken as it is descirbed in emscripten.md</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>mkdir -p build/emscripten
<span class="nb">cd</span> build/emscripten
emccmake cmake ../../src -DCMAKE_BUILD_TYPE<span class="o">=</span>Emscripten
make
</code></pre></div>



<a name="267692050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/267692050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#267692050">(Jan 12 2022 at 08:05)</a>:</h4>
<p>That could very well be the case since it's not tested by CI right now</p>



<a name="267692474"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/267692474" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#267692474">(Jan 12 2022 at 08:11)</a>:</h4>
<p>Also fair warning, the last time I tried this, the wasm libc++ cached by Nixpkgs was missing exception support, and trying to add it lead to some inscrutable error message afair <a href="https://github.com/Kha/nixpkgs/commit/6c586acad642bf57f65a531d765f08af18da3fe6">https://github.com/Kha/nixpkgs/commit/6c586acad642bf57f65a531d765f08af18da3fe6</a></p>



<a name="267708537"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/267708537" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#267708537">(Jan 12 2022 at 10:56)</a>:</h4>
<p>Ok. Thanks for the heads up. I think I'm just going to try setting <code>LEAN_CC</code> to <code>emcc</code> and use <code>buildLeanPackage</code></p>



<a name="267775716"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/267775716" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#267775716">(Jan 12 2022 at 19:42)</a>:</h4>
<p>Is it strictly necessary to link with gmp? I'm getting this error:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">wasm</span><span class="bp">-</span><span class="n">ld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">unknown</span> <span class="n">file</span> <span class="n">type</span><span class="o">:</span> <span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">lqd2xr20f8qmmvss3nrbph22kln8a0p5</span><span class="bp">-</span><span class="n">gmp</span><span class="bp">-</span><span class="mi">6</span><span class="bp">.</span><span class="mi">2</span><span class="bp">.</span><span class="mi">1</span><span class="bp">/</span><span class="n">lib</span><span class="bp">/</span><span class="n">libgmp.so</span>
</code></pre></div>



<a name="267778934"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/267778934" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik Böving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#267778934">(Jan 12 2022 at 20:07)</a>:</h4>
<p>As far as I know gmp is used for efficient computation on <code>Nat</code> internally? so I'd say yes it is although there might be a way to get rid off it at the cost of <code>Nat</code> efficiency.</p>



<a name="267781164"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/267781164" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#267781164">(Jan 12 2022 at 20:26)</a>:</h4>
<p>See cmake option <code>USE_GMP</code> and <a href="https://github.com/leanprover/lean4/issues/827">https://github.com/leanprover/lean4/issues/827</a>. For your use case it should be fine to require it.</p>



<a name="268316112"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268316112" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268316112">(Jan 17 2022 at 21:18)</a>:</h4>
<p>So I'm trying to use <code>emcc</code> directly inside <code>buildLeanPackage</code> and it has been surprisingly successful (After setting <code>LEANC_GMP=" "</code>), but wasm only has experimental multithreading support currently so I wanted to disable it by passing </p>
<div class="codehilite" data-code-language="Nix"><pre><span></span><code>  <span class="ss">leancpp-single-thread =</span> leancpp<span class="o">.</span>overrideAttrs <span class="p">(</span>old<span class="p">:</span> <span class="p">{</span>
    <span class="ss">cmakeFlags =</span> old<span class="o">.</span>cmakeFlags <span class="o">++</span> <span class="p">[</span> <span class="s2">"-ULEAN_MULTI_THREAD"</span> <span class="s2">"-UMULTI_THREAD"</span> <span class="s2">"-UUSE_GMP"</span> <span class="p">];</span>
  <span class="p">});</span>
</code></pre></div>
<p>Although this does not change the C macros inside the build. Do you know why?</p>



<a name="268317020"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268317020" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268317020">(Jan 17 2022 at 21:32)</a>:</h4>
<p>I don't think you want to use <code>-U</code>. Use <code>-DUSE_GMP=OFF</code> etc.</p>



<a name="268724575"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268724575" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268724575">(Jan 20 2022 at 17:07)</a>:</h4>
<p>I've managed to build most of lean with emscripten, but I still need to compile the kernel and runtime to statically link.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">wasm</span><span class="bp">-</span><span class="n">ld</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">unknown</span> <span class="n">file</span> <span class="n">type</span><span class="o">:</span> <span class="n">object.cpp.o</span>
</code></pre></div>
<p>I'm running into this error when compiling Lean with <code>emcc</code> and I suspect this is because object.cpp.o was not compiled with emscripten. So I'm trying to compile leancpp with emscripten.</p>
<div class="codehilite" data-code-language="Nix"><pre><span></span><code>  <span class="ss">leancpp-emscripten =</span> leancpp-single-thread<span class="o">.</span>overrideAttrs <span class="p">(</span>old<span class="p">:</span> <span class="p">{</span>
    <span class="ss">name =</span> <span class="s2">"leancpp-emscripten"</span><span class="p">;</span>
    <span class="ss">nativeBuildInputs =</span> <span class="p">[</span> cmake emscripten <span class="p">];</span>
    <span class="ss">cmakeFlags =</span> old<span class="o">.</span>cmakeFlags <span class="o">++</span> <span class="p">[</span> <span class="s2">"-DCMAKE_BUILD_TYPE=Emscripten"</span> <span class="p">];</span>
    <span class="ss">preConfigure =</span> <span class="s1">''</span>
<span class="s1">      # ignore absence of submodule</span>
<span class="s1">      sed -i </span><span class="err">'</span><span class="s1">s!lake/Lake.lean!!</span><span class="err">'</span><span class="s1"> CMakeLists.txt</span>
<span class="s1">    ''</span><span class="p">;</span>
    <span class="ss">configurePhase =</span> <span class="s1">''</span>
<span class="s1">      sh -c "$preConfigure"</span>
<span class="s1">      mkdir build</span>
<span class="s1">      cd build</span>
<span class="s1">      emcmake cmake .. $cmakeFlags</span>
<span class="s1">      patchShebangs .</span>
<span class="s1">    ''</span><span class="p">;</span>
  <span class="p">});</span>
</code></pre></div>
<p>gives this error</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">unpacking</span> <span class="n">sources</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">unpacking</span> <span class="n">source</span> <span class="n">archive</span> <span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">zzbyl3jkby9dgdkc25idhl76pb937064</span><span class="bp">-</span><span class="n">source</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">source</span> <span class="n">root</span> <span class="n">is</span> <span class="n">source</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">patching</span> <span class="n">sources</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">configuring</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">configure</span><span class="o">:</span> <span class="n">cmake</span> <span class="bp">..</span> <span class="bp">-</span><span class="n">DSTAGE</span><span class="bp">=</span><span class="mi">1</span> <span class="bp">-</span><span class="n">DPREV_STAGE</span><span class="bp">=./</span><span class="n">faux</span><span class="bp">-</span><span class="n">prev</span><span class="bp">-</span><span class="n">stage</span> <span class="bp">-</span><span class="n">DUSE_GITHASH</span><span class="bp">=</span><span class="n">OFF</span> <span class="bp">-</span><span class="n">DMULTI_THREAD</span><span class="bp">=</span><span class="n">OFF</span> <span class="bp">-</span><span class="n">DUSE_GMP</span><span class="bp">=</span><span class="n">OFF</span> <span class="bp">-</span><span class="n">DCMAKE_BUILD_TYPE</span><span class="bp">=</span><span class="n">Emscripten</span> <span class="bp">-</span><span class="n">DCMAKE_TOOLCHAIN_FILE</span><span class="bp">=/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">jrjpc9b1b3kjvj46ylx748awn0i20gp8</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">-</span><span class="mi">2</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">27</span><span class="bp">/</span><span class="n">share</span><span class="bp">/</span><span class="n">emscripten</span><span class="bp">/</span><span class="n">cmake</span><span class="bp">/</span><span class="n">Modules</span><span class="bp">/</span><span class="n">Platform</span><span class="bp">/</span><span class="n">Emscripten.cmake</span> <span class="bp">-</span><span class="n">DCMAKE_CROSSCOMPILING_EMULATOR</span><span class="bp">=/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">p27ckm6j4i1g4v5k16rqc0xhp167ympw</span><span class="bp">-</span><span class="n">nodejs</span><span class="bp">-</span><span class="mi">14</span><span class="bp">.</span><span class="mi">18</span><span class="bp">.</span><span class="mi">1</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">node</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="c1">-- 32-bit machine detected</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="c1">-- Enabled multi-thread support</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">CMake</span> <span class="n">Warning</span> <span class="n">at</span> <span class="n">CMakeLists.txt</span><span class="o">:</span><span class="mi">253</span> <span class="o">(</span><span class="n">message</span><span class="o">):</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span>   <span class="n">Failed</span> <span class="n">to</span> <span class="n">find</span> <span class="n">ccache</span><span class="o">,</span> <span class="n">prepare</span> <span class="n">for</span> <span class="n">longer</span> <span class="n">and</span> <span class="n">redundant</span> <span class="n">builds...</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="c1">-- Could NOT find PythonInterp (missing: PYTHON_EXECUTABLE)</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="c1">-- Configuring done</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="c1">-- Generating done</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="c1">-- Build files have been written to: /build/source/build</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">building</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">build</span> <span class="n">flags</span><span class="o">:</span> <span class="n">SHELL</span><span class="bp">=/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">l0wlqpbsvh1pgvhcdhw7qkka3d31si7k</span><span class="bp">-</span><span class="n">bash</span><span class="bp">-</span><span class="mi">5</span><span class="bp">.</span><span class="mi">1</span><span class="bp">-</span><span class="n">p8</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/</span><span class="n">bash</span> <span class="n">leancpp</span> <span class="n">leanrt</span> <span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec</span> <span class="n">shell</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="o">[</span>  <span class="mi">1</span><span class="bp">%</span><span class="o">]</span> <span class="n">Building</span> <span class="n">CXX</span> <span class="n">object</span> <span class="n">initialize</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">initialize.dir</span><span class="bp">/</span><span class="n">init.cpp.o</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">python</span> <span class="k">in</span> <span class="bp">$</span><span class="n">PATH</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">make</span><span class="o">[</span><span class="mi">3</span><span class="o">]:</span> <span class="bp">***</span> <span class="o">[</span><span class="n">initialize</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">initialize.dir</span><span class="bp">/</span><span class="n">build.make</span><span class="o">:</span><span class="mi">77</span><span class="o">:</span> <span class="n">initialize</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">initialize.dir</span><span class="bp">/</span><span class="n">init.cpp.o</span><span class="o">]</span> <span class="n">Error</span> <span class="mi">1</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">make</span><span class="o">[</span><span class="mi">2</span><span class="o">]:</span> <span class="bp">***</span> <span class="o">[</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">Makefile2</span><span class="o">:</span><span class="mi">1394</span><span class="o">:</span> <span class="n">initialize</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">initialize.dir</span><span class="bp">/</span><span class="n">all</span><span class="o">]</span> <span class="n">Error</span> <span class="mi">2</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">make</span><span class="o">[</span><span class="mi">1</span><span class="o">]:</span> <span class="bp">***</span> <span class="o">[</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">Makefile2</span><span class="o">:</span><span class="mi">1193</span><span class="o">:</span> <span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leancpp.dir</span><span class="bp">/</span><span class="n">rule</span><span class="o">]</span> <span class="n">Error</span> <span class="mi">2</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">make</span><span class="o">:</span> <span class="bp">***</span> <span class="o">[</span><span class="n">Makefile</span><span class="o">:</span><span class="mi">654</span><span class="o">:</span> <span class="n">leancpp</span><span class="o">]</span> <span class="n">Error</span> <span class="mi">2</span>
</code></pre></div>
<p>What can be causing this error?</p>



<a name="268732890"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268732890" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268732890">(Jan 20 2022 at 18:03)</a>:</h4>
<p>It fails here</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="w">    </span><span class="cp">#if defined(LEAN_EMSCRIPTEN)</span>
<span class="w">        </span><span class="c1">// `Crypto.getRandomValues` documents `dest` should be at most 65536 bytes.</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">read_sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">remain</span><span class="p">,</span><span class="w"> </span><span class="mi">65536</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="cp">#else</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">read_sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remain</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#endif</span>
</code></pre></div>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">anderscs</span><span class="bp">/</span><span class="n">src</span><span class="bp">/</span><span class="n">lean4</span><span class="bp">/</span><span class="n">src</span><span class="bp">/</span><span class="n">runtime</span><span class="bp">/</span><span class="n">io.cpp</span><span class="o">:</span><span class="mi">402</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span> <span class="n">error</span><span class="o">:</span> <span class="n">no</span> <span class="n">matching</span> <span class="n">function</span> <span class="n">for</span> <span class="n">call</span> <span class="n">to</span> <span class="bp">'</span><span class="n">min'</span>
        <span class="n">size_t</span> <span class="n">read_sz</span> <span class="bp">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="o">(</span><span class="n">remain</span><span class="o">,</span> <span class="mi">65536</span><span class="o">)</span><span class="bp">;</span>
                         <span class="bp">^~~~~~~~</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">jrjpc9b1b3kjvj46ylx748awn0i20gp8</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">-</span><span class="mi">2</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">27</span><span class="bp">/</span><span class="n">share</span><span class="bp">/</span><span class="n">emscripten</span><span class="bp">/</span><span class="n">cache</span><span class="bp">/</span><span class="n">sysroot</span><span class="bp">/</span><span class="kn">include</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">algorithm</span><span class="o">:</span><span class="mi">2594</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span> <span class="n">note</span><span class="o">:</span> <span class="n">candidate</span> <span class="n">template</span> <span class="n">ignored</span><span class="o">:</span> <span class="n">deduced</span> <span class="n">conflicting</span> <span class="n">types</span> <span class="n">for</span> <span class="kd">parameter</span> <span class="bp">'</span><span class="n">_Tp'</span> <span class="o">(</span><span class="bp">'</span><span class="n">unsigned</span> <span class="n">long'</span> <span class="n">vs.</span> <span class="bp">'</span><span class="n">int'</span><span class="o">)</span>
<span class="n">min</span><span class="o">(</span><span class="n">const</span> <span class="n">_Tp</span><span class="bp">&amp;</span> <span class="n">__a</span><span class="o">,</span> <span class="n">const</span> <span class="n">_Tp</span><span class="bp">&amp;</span> <span class="n">__b</span><span class="o">)</span>
<span class="bp">^</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">jrjpc9b1b3kjvj46ylx748awn0i20gp8</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">-</span><span class="mi">2</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">27</span><span class="bp">/</span><span class="n">share</span><span class="bp">/</span><span class="n">emscripten</span><span class="bp">/</span><span class="n">cache</span><span class="bp">/</span><span class="n">sysroot</span><span class="bp">/</span><span class="kn">include</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">algorithm</span><span class="o">:</span><span class="mi">2605</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span> <span class="n">note</span><span class="o">:</span> <span class="n">candidate</span> <span class="n">template</span> <span class="n">ignored</span><span class="o">:</span> <span class="n">could</span> <span class="n">not</span> <span class="k">match</span> <span class="bp">'</span><span class="n">initializer_list</span><span class="bp">&lt;</span><span class="n">type</span><span class="bp">-</span><span class="kd">parameter</span><span class="bp">-</span><span class="mi">0</span><span class="bp">-</span><span class="mi">0</span><span class="bp">&gt;'</span> <span class="n">against</span> <span class="bp">'</span><span class="n">unsigned</span> <span class="n">long'</span>
<span class="n">min</span><span class="o">(</span><span class="n">initializer_list</span><span class="bp">&lt;</span><span class="n">_Tp</span><span class="bp">&gt;</span> <span class="n">__t</span><span class="o">,</span> <span class="n">_Compare</span> <span class="n">__comp</span><span class="o">)</span>
<span class="bp">^</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">jrjpc9b1b3kjvj46ylx748awn0i20gp8</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">-</span><span class="mi">2</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">27</span><span class="bp">/</span><span class="n">share</span><span class="bp">/</span><span class="n">emscripten</span><span class="bp">/</span><span class="n">cache</span><span class="bp">/</span><span class="n">sysroot</span><span class="bp">/</span><span class="kn">include</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">algorithm</span><span class="o">:</span><span class="mi">2614</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span> <span class="n">note</span><span class="o">:</span> <span class="n">candidate</span> <span class="n">function</span> <span class="n">template</span> <span class="n">not</span> <span class="n">viable</span><span class="o">:</span> <span class="n">requires</span> <span class="n">single</span> <span class="n">argument</span> <span class="bp">'</span><span class="n">__t'</span><span class="o">,</span> <span class="n">but</span> <span class="mi">2</span> <span class="n">arguments</span> <span class="n">were</span> <span class="n">provided</span>
<span class="n">min</span><span class="o">(</span><span class="n">initializer_list</span><span class="bp">&lt;</span><span class="n">_Tp</span><span class="bp">&gt;</span> <span class="n">__t</span><span class="o">)</span>
<span class="bp">^</span>
<span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">jrjpc9b1b3kjvj46ylx748awn0i20gp8</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">-</span><span class="mi">2</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">27</span><span class="bp">/</span><span class="n">share</span><span class="bp">/</span><span class="n">emscripten</span><span class="bp">/</span><span class="n">cache</span><span class="bp">/</span><span class="n">sysroot</span><span class="bp">/</span><span class="kn">include</span><span class="bp">/</span><span class="n">c</span><span class="bp">++/</span><span class="n">v1</span><span class="bp">/</span><span class="n">algorithm</span><span class="o">:</span><span class="mi">2585</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span> <span class="n">note</span><span class="o">:</span> <span class="n">candidate</span> <span class="n">function</span> <span class="n">template</span> <span class="n">not</span> <span class="n">viable</span><span class="o">:</span> <span class="n">requires</span> <span class="mi">3</span> <span class="n">arguments</span><span class="o">,</span> <span class="n">but</span> <span class="mi">2</span> <span class="n">were</span> <span class="n">provided</span>
<span class="n">min</span><span class="o">(</span><span class="n">const</span> <span class="n">_Tp</span><span class="bp">&amp;</span> <span class="n">__a</span><span class="o">,</span> <span class="n">const</span> <span class="n">_Tp</span><span class="bp">&amp;</span> <span class="n">__b</span><span class="o">,</span> <span class="n">_Compare</span> <span class="n">__comp</span><span class="o">)</span>
<span class="bp">^</span>
</code></pre></div>
<p>Did they change the api?</p>



<a name="268733606"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268733606" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268733606">(Jan 20 2022 at 18:08)</a>:</h4>
<p>Try <code>65536ul</code></p>



<a name="268737163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268737163" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268737163">(Jan 20 2022 at 18:33)</a>:</h4>
<p><code>(size_t) 65536</code> seems to work</p>



<a name="268742779"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268742779" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268742779">(Jan 20 2022 at 19:13)</a>:</h4>
<p>Any Idea why it fails here?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Putting</span> <span class="n">child</span> <span class="mi">0x461420</span> <span class="o">(</span><span class="n">runtime</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">debug.cpp.o</span><span class="o">)</span> <span class="n">PID</span> <span class="mi">45</span> <span class="n">on</span> <span class="n">the</span> <span class="n">chain.</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">Live</span> <span class="n">child</span> <span class="mi">0x461420</span> <span class="o">(</span><span class="n">runtime</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">debug.cpp.o</span><span class="o">)</span> <span class="n">PID</span> <span class="mi">45</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="o">[</span>  <span class="mi">1</span><span class="bp">%</span><span class="o">]</span> <span class="n">Building</span> <span class="n">CXX</span> <span class="n">object</span> <span class="n">runtime</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">debug.cpp.o</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">Reaping</span> <span class="n">winning</span> <span class="n">child</span> <span class="mi">0x461420</span> <span class="n">PID</span> <span class="mi">45</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">cd</span> <span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">source</span><span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">runtime</span> <span class="bp">&amp;&amp;</span> <span class="bp">/</span><span class="n">nix</span><span class="bp">/</span><span class="n">store</span><span class="bp">/</span><span class="n">jrjpc9b1b3kjvj46ylx748awn0i20gp8</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">-</span><span class="mi">2</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">27</span><span class="bp">/</span><span class="n">share</span><span class="bp">/</span><span class="n">emscripten</span><span class="bp">/</span><span class="n">em</span><span class="bp">++</span>  <span class="bp">@</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">includes_CXX.rsp</span> <span class="bp">-</span><span class="n">Wall</span> <span class="bp">-</span><span class="n">Wextra</span> <span class="bp">-</span><span class="n">std</span><span class="bp">=</span><span class="n">c</span><span class="bp">++</span><span class="mi">14</span>  <span class="bp">-</span><span class="n">D</span> <span class="n">LEAN_EMSCRIPTEN</span> <span class="bp">-</span><span class="n">s</span> <span class="n">ALLOW_MEMORY_GROWTH</span><span class="bp">=</span><span class="mi">1</span> <span class="bp">-</span><span class="n">s</span> <span class="n">DISABLE_EXCEPTION_CATCHING</span><span class="bp">=</span><span class="mi">0</span> <span class="bp">-</span><span class="n">s</span> <span class="n">MAIN_MODULE</span><span class="bp">=</span><span class="mi">1</span> <span class="bp">-</span><span class="n">fexceptions</span> <span class="bp">-</span><span class="n">DLEAN_BUILD_TYPE</span><span class="bp">=</span><span class="s2">"Emscripten"</span> <span class="bp">-</span><span class="n">DLEAN_EXPORTING</span> <span class="bp">-</span><span class="n">D__CLANG__</span> <span class="bp">-</span><span class="n">fvisibility</span><span class="bp">=</span><span class="n">hidden</span> <span class="bp">-</span><span class="n">fvisibility</span><span class="bp">-</span><span class="n">inlines</span><span class="bp">-</span><span class="n">hidden</span> <span class="bp">-</span><span class="n">MD</span> <span class="bp">-</span><span class="n">MT</span> <span class="n">runtime</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">debug.cpp.o</span> <span class="bp">-</span><span class="n">MF</span> <span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">debug.cpp.o.d</span> <span class="bp">-</span><span class="n">o</span> <span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">debug.cpp.o</span> <span class="bp">-</span><span class="n">c</span> <span class="bp">/</span><span class="n">build</span><span class="bp">/</span><span class="n">source</span><span class="bp">/</span><span class="n">runtime</span><span class="bp">/</span><span class="n">debug.cpp</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">Live</span> <span class="n">child</span> <span class="mi">0x461420</span> <span class="o">(</span><span class="n">runtime</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">debug.cpp.o</span><span class="o">)</span> <span class="n">PID</span> <span class="mi">46</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">python</span> <span class="k">in</span> <span class="bp">$</span><span class="n">PATH</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">Reaping</span> <span class="n">losing</span> <span class="n">child</span> <span class="mi">0x461420</span> <span class="n">PID</span> <span class="mi">46</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">make</span><span class="o">[</span><span class="mi">2</span><span class="o">]:</span> <span class="bp">***</span> <span class="o">[</span><span class="n">runtime</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">build.make</span><span class="o">:</span><span class="mi">77</span><span class="o">:</span> <span class="n">runtime</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">debug.cpp.o</span><span class="o">]</span> <span class="n">Error</span> <span class="mi">1</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">Removing</span> <span class="n">child</span> <span class="mi">0x461420</span> <span class="n">PID</span> <span class="mi">46</span> <span class="k">from</span> <span class="n">chain.</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">make</span><span class="o">[</span><span class="mi">2</span><span class="o">]:</span> <span class="n">Leaving</span> <span class="n">directory</span> <span class="bp">'/</span><span class="n">build</span><span class="bp">/</span><span class="n">source</span><span class="bp">/</span><span class="n">build'</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">Reaping</span> <span class="n">losing</span> <span class="n">child</span> <span class="mi">0x47ab80</span> <span class="n">PID</span> <span class="mi">44</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">make</span><span class="o">[</span><span class="mi">1</span><span class="o">]:</span> <span class="bp">***</span> <span class="o">[</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">Makefile2</span><span class="o">:</span><span class="mi">1238</span><span class="o">:</span> <span class="n">runtime</span><span class="bp">/</span><span class="n">CMakeFiles</span><span class="bp">/</span><span class="n">leanrt_initial</span><span class="bp">-</span><span class="n">exec.dir</span><span class="bp">/</span><span class="n">all</span><span class="o">]</span> <span class="n">Error</span> <span class="mi">2</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">Removing</span> <span class="n">child</span> <span class="mi">0x47ab80</span> <span class="n">PID</span> <span class="mi">44</span> <span class="k">from</span> <span class="n">chain.</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">make</span><span class="o">[</span><span class="mi">1</span><span class="o">]:</span> <span class="n">Leaving</span> <span class="n">directory</span> <span class="bp">'/</span><span class="n">build</span><span class="bp">/</span><span class="n">source</span><span class="bp">/</span><span class="n">build'</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">Reaping</span> <span class="n">losing</span> <span class="n">child</span> <span class="mi">0x4756f0</span> <span class="n">PID</span> <span class="mi">41</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">make</span><span class="o">:</span> <span class="bp">***</span> <span class="o">[</span><span class="n">Makefile</span><span class="o">:</span><span class="mi">166</span><span class="o">:</span> <span class="n">all</span><span class="o">]</span> <span class="n">Error</span> <span class="mi">2</span>
<span class="n">leancpp</span><span class="bp">-</span><span class="n">emscripten</span><span class="bp">&gt;</span> <span class="n">Removing</span> <span class="n">child</span> <span class="mi">0x4756f0</span> <span class="n">PID</span> <span class="mi">41</span> <span class="k">from</span> <span class="n">chain.</span>
</code></pre></div>
<p>Is this because of the python error?</p>



<a name="268743333"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268743333" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268743333">(Jan 20 2022 at 19:17)</a>:</h4>
<p>It wouldn't fail at a specific C++ file then</p>



<a name="268743357"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268743357" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268743357">(Jan 20 2022 at 19:17)</a>:</h4>
<p>It's weird that there is no compiler error, how did you find it before?</p>



<a name="268743375"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268743375" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268743375">(Jan 20 2022 at 19:17)</a>:</h4>
<p>I've made a draft PR of this here <a href="https://github.com/leanprover/lean4/pull/966">https://github.com/leanprover/lean4/pull/966</a></p>



<a name="268743471"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268743471" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268743471">(Jan 20 2022 at 19:18)</a>:</h4>
<p>I ran nix develop before. I don't know why the error is not showing</p>



<a name="268743602"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268743602" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268743602">(Jan 20 2022 at 19:19)</a>:</h4>
<p>Fixing it in nix develop first is definitely a good idea given how big the derivation is</p>



<a name="268744278"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/268744278" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#268744278">(Jan 20 2022 at 19:24)</a>:</h4>
<p>What's ironic is that in nix develop the build actually works for some reason</p>



<a name="270554986"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/270554986" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#270554986">(Feb 03 2022 at 14:14)</a>:</h4>
<p><span class="user-mention" data-user-id="315577">@Mac</span> Do you think it would be easier to build to wasm with lake? I've gotten stuck on compiling leancpp with emcmake and I generally don't like working with cmake. I guess I could replace the cmake in the nix build and just use lake to build? This would be ideal.</p>



<a name="270585219"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/270585219" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#270585219">(Feb 03 2022 at 17:21)</a>:</h4>
<p><span class="user-mention" data-user-id="433842">@Anders Christiansen Sørby</span> do you mean WASM for the Lean core or WASM for Lean libraries? Lake can probably soon be used to build the later, the former seems much more unlikely (at least until Lake supports arbitrary build targets).</p>



<a name="270587604"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/270587604" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#270587604">(Feb 03 2022 at 17:34)</a>:</h4>
<p>I mean the lean core c++ code, runtime, kernel, utils etc. This is currently compiled with CMake.</p>



<a name="270598573"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/270598573" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#270598573">(Feb 03 2022 at 18:51)</a>:</h4>
<p>In that case, I don't see that being easily replaceable by Lake anytime soon.</p>



<a name="270613397"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/270613397" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#270613397">(Feb 03 2022 at 20:33)</a>:</h4>
<p>By the way, I took a look at the original PR today and we <a href="https://github.com/leanprover/lean4/pull/505#issuecomment-855400618">did</a> have a working CI config, it just wasn't really feasible to turn it on. Adding cross-architecture .olean compilation would be one way to fix that.</p>



<a name="270616437"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/270616437" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#270616437">(Feb 03 2022 at 20:57)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> maybe it would be possible to run the CI build as scheduled workflow (maybe as part of the nightly release) instead of part of the regular on  push workflow? That would make the 2h build time less of a concern.</p>



<a name="270616855"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/270616855" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#270616855">(Feb 03 2022 at 21:01)</a>:</h4>
<p>Also, since the nightly release adds the artifacts as they are built (if they succeed), the long WASM build would not delay or prevent the release of the other artifacts.</p>



<a name="270677454"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/270677454" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#270677454">(Feb 04 2022 at 07:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> <a href="#narrow/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build/near/270616855">said</a>:</p>
<blockquote>
<p>Also, since the nightly release adds the artifacts as they are built (if they succeed), the long WASM build would not delay or prevent the release of the other artifacts.</p>
</blockquote>
<p>Which in itself is not ideal, and I started to fix that on some branch that I just have to find again... but we could always make an exception for the Emscripten build if necessary</p>



<a name="271113368"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271113368" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271113368">(Feb 08 2022 at 11:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build/near/270613397">said</a>:</p>
<blockquote>
<p>Adding cross-architecture .olean compilation would be one way to fix that.</p>
</blockquote>
<p>Doing this in the current compact.cpp implementation would be quite a challenge since it is based on the platform-specific declarations and functions in lean.h. It should be much simpler to make <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span>'s <code>oleanparser</code> platform-generic, just abstract over the (all?) <code>read64LE</code> calls. We would have to fix the <code>TODO</code>s first and write a corresponding serializer, but seem quite desirable anyway. /cc <span class="user-mention" data-user-id="112857">@Leonardo de Moura</span></p>



<a name="271113446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271113446" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271113446">(Feb 08 2022 at 11:29)</a>:</h4>
<p>Not trivial either, but that you cannot easily add a conditional platform to a GitHub Actions job is reason enough for me to solve the Emscripten build that way instead...</p>



<a name="271113947"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271113947" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271113947">(Feb 08 2022 at 11:33)</a>:</h4>
<blockquote>
<p>It should be much simpler to make @Gabriel Ebner's oleanparser platform-generic, just abstract over the (all?) read64LE calls.</p>
</blockquote>
<p>That seems like a good plan.  We'd also need to abstract over alignment, object headers, and bignum representation.</p>



<a name="271114162"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271114162" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271114162">(Feb 08 2022 at 11:35)</a>:</h4>
<p>We should also add flags for these variants in the olean file so that we can pick the right parser.</p>



<a name="271119780"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271119780" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271119780">(Feb 08 2022 at 12:30)</a>:</h4>
<p>Yes, we probably should if we want to avoid user reports about weird segfaults (...which may happen at any point thanks to mmap :) ). The <em>object layout</em> should also be sufficiently stable that we can add a version number for it, even if that still doesn't guarantee that <em>Lean</em> can load .oleans of the same version because the declarations of the serialized Lean types may have changed.</p>



<a name="271159076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271159076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271159076">(Feb 08 2022 at 17:09)</a>:</h4>
<p>Maybe you should use content addressed versioning for the olean format?</p>



<a name="271162622"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271162622" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271162622">(Feb 08 2022 at 17:32)</a>:</h4>
<p>What does that mean?</p>



<a name="271167726"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271167726" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271167726">(Feb 08 2022 at 18:08)</a>:</h4>
<p>I was thinking to ensure that the format is versioned stably you can include a hash of the serialized Lean types in the version string.</p>



<a name="271167820"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271167820" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271167820">(Feb 08 2022 at 18:09)</a>:</h4>
<p>Also I made this <a href="https://github.com/gebner/oleanparser/pull/3">https://github.com/gebner/oleanparser/pull/3</a></p>



<a name="271196010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271196010" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271196010">(Feb 08 2022 at 21:48)</a>:</h4>
<p><span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> What are the TODOs on the oleanparser?</p>



<a name="271252273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271252273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271252273">(Feb 09 2022 at 09:53)</a>:</h4>
<p>Most of the TODOs are additional assertions that I wanted to write.  The olean format in Lean 4 is highly redundant (because it is identical to the memory representation).  For example, arrays have two size fields (which should be equal), thunks have a 64-bit closure field (which is always zero), etc.</p>



<a name="271252672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271252672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271252672">(Feb 09 2022 at 09:56)</a>:</h4>
<p>Another TODO is checking that strings are valid UTF-8, but I don't know if the runtime even requires that.  (There's certainly lots of places where fromUTF8Unchecked is called on input that could be invalid UTF-8.)</p>



<a name="271252862"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271252862" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271252862">(Feb 09 2022 at 09:58)</a>:</h4>
<p>And then there's this one, where I don't remember what the TODO was for:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code>    <span class="k">let</span> <span class="o">(</span><span class="n">size</span><span class="o">,</span> <span class="n">sign</span><span class="o">)</span> <span class="o">:=</span> <span class="c1">-- TODO: implement Int32</span>
</code></pre></div>
<p>(AFAICT, Int32 is represented as scalar values and there's no way to distinguish it from regular scalar values.)</p>



<a name="271254233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271254233" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271254233">(Feb 09 2022 at 10:08)</a>:</h4>
<p>In case you were asking about the general roadmap: basically what Sebastian said.  Serialization, different layouts (32-bit mainly).  I'd also like to make the output type generic; right now there's this <code>Obj</code> data structure but I'd like to add a <code>FromObj α</code> type class (with <code>scalar : Nat → α</code> etc. members) so that the parser could directly create the Lean VM objects (with a different instance).</p>



<a name="271257330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/wasm%20nix%20emscripten%20build/near/271257330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Anders Christiansen Sørby <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/wasm.20nix.20emscripten.20build.html#271257330">(Feb 09 2022 at 10:36)</a>:</h4>
<p>Using dependent types as a form of safe (to be proven) runtime loading, "zero" cost serializations, could be really cool.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>