---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Mathlib.204.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html">Mathlib 4</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="237986680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/237986680" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#237986680">(May 08 2021 at 21:43)</a>:</h4>
<p>I'd like to start the repo for mathlib 4. The idea is that for the present it will serve a role similar to <code>library_dev</code> from the old days: it will collect some basic theorems about nat, list and a few other things that I think everyone who is using lean 4 is rediscovering. The intent will be to later replace this with the ported version when the mathlib porting effort is ready, but in the meanwhile there are still a lot of things that can be done with only a basic library, where the cost of duplicated work is worth having these lemmas available for the current small experiments.</p>
<p>Additionally, as I've mentioned before, there is a second mathlib spinoff project, that I'm calling the mathlib prelude. This will collect all the tactics used by mathlib proper such as <code>ring</code>, <code>linarith</code> and the myriad small tactics. Due to lean 4's architecture, it is necessary for these tactics to exist in a separate compilation unit so that they can be available in their compiled form in mathlib. (You can use a tactic immediately after its definition but this uses the interpreter and so doesn't benefit from the tremendous work done on the lean 4 compiler.)</p>
<p>Which brings me to the issue: should these two be separate repositories or not? I think that having all of mathlib in one monorepo reduces the maintenance cost of adding features to lean significantly, and I think most would agree that making even a comparatively simple change in lean core today is higher friction than adding to mathlib, since at the very least a new version of lean containing the modification has to be released and mathlib updated for the new version, both things that mathlib changes don't have to worry about.</p>
<p>A natural solution would be to have mathlib and the prelude in two folders of one repo. But I don't know if lean 4 (or more accurately leanpkg) can currently handle packages that exist in subfolders of a repo.</p>
<p>What do people think about the plan and/or the timing? I don't think there is any reason to delay further, once the logistical issues are resolved.</p>



<a name="237987342"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/237987342" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Guilherme Silva <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#237987342">(May 08 2021 at 21:56)</a>:</h4>
<p>I think that it is a good idea to have a mathlib. If you create it, I will use it.</p>



<a name="237988067"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/237988067" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#237988067">(May 08 2021 at 22:10)</a>:</h4>
<p>Why can't you just have a directory <code>prelude</code> in a mathlib 4 repo? I don't understand your question about <code>leanpkg</code>. Why does <code>prelude</code> have to be a package? If it becomes constant later you could split it off maybe?</p>
<p>I have been porting parts of mathlib to Lean 4. It's fun. My main worry is that lean 3 keeps moving. I started on some famous file (maybe <code>data.list.basic</code>?) yesterday and discovered that it was last edited about a week ago.</p>



<a name="237988275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/237988275" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#237988275">(May 08 2021 at 22:14)</a>:</h4>
<blockquote>
<p>Why can't you just have a directory prelude in a mathlib 4 repo?</p>
</blockquote>
<p>That's also a theoretical possibility, although I'm quite sure that lean 4 doesn't currently support a project setup like this. But we can quite possibly make it work if we use a custom build process, since lean itself can be driven at the per-file level and we just need to call the compiler at the right time and import it when compiling other mathlib files. In the end we'll surely need our own build process so this isn't totally outlandish.</p>



<a name="237988368"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/237988368" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#237988368">(May 08 2021 at 22:16)</a>:</h4>
<blockquote>
<p>I have been porting parts of mathlib to Lean 4. It's fun. My main worry is that lean 3 keeps moving. I started on some famous file (maybe data.list.basic?) yesterday and discovered that it was last edited about a week ago.</p>
</blockquote>
<p>I have no intention of being completionist or trying to keep it up to date with mathlib. That will wait until the port is ready, at which point we can just make sure that any divergence between the mathlib 3 and mathlib 4 libraries in those files is merged.</p>



<a name="237988457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/237988457" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#237988457">(May 08 2021 at 22:18)</a>:</h4>
<p>The main goal at this point is to have the things that lean 4 users need, not feature parity with mathlib 3</p>



<a name="237993571"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/237993571" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> David Renshaw <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#237993571">(May 08 2021 at 23:57)</a>:</h4>
<blockquote>
<p>A natural solution would be to have mathlib and the prelude in two folders of one repo. But I don't know if lean 4 (or more accurately leanpkg) can currently handle packages that exist in subfolders of a repo.</p>
</blockquote>
<p>Keeping things in a single repository makes sense to me. In my understanding, <code>leanpkg</code> is at least somewhat modeled after Rust's <code>cargo</code>, and <code>cargo</code> supports that kind of pattern very nicely (with <a href="https://doc.rust-lang.org/cargo/reference/workspaces.html">cargo workspaces</a> and some other features).</p>



<a name="238015462"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238015462" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238015462">(May 09 2021 at 07:10)</a>:</h4>
<p>This is a great idea, and the timing is good.  We've been waiting for this to happen.</p>
<p>I'd definitely prefer a monorepo (in particular if we need to move stuff from mathlib to prelude and back to satisfy the staging requirements of Lean 4).  I fully expect some issues to arise with this setup, but I believe the whole point of mathlib4 is to find and iron out these bugs.</p>



<a name="238015823"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238015823" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238015823">(May 09 2021 at 07:16)</a>:</h4>
<p>What <code>leanpkg</code> can do:</p>
<ul>
<li>depend on a package in a subdir using <code>{ path = "prelude" }</code></li>
</ul>
<p>What <code>leanpkg</code> cannot do yet:</p>
<ul>
<li>automatically compile a dependency into a shared library and pass it in <code>--plugin</code></li>
<li>share a common lock file between related packages, cargo workspaces-like<ul>
<li>We don't even have lock files yet. We should.</li>
</ul>
</li>
<li>depend on packages in a subdirectory of a <em>different</em> repository (apparently cargo simply searches the whole repo for a <code>Cargo.toml</code>...?)<ul>
<li>only relevant if someone wants to depend on mathlib prelude without mathlib</li>
</ul>
</li>
</ul>
<p>In summary, leanpkg is in need of some serious love in general (contributions welcome), but it has (almost) equal support for both repo approaches</p>



<a name="238016694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238016694" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238016694">(May 09 2021 at 07:32)</a>:</h4>
<p>Ah, this works much better than I'd expected: <a href="https://github.com/gebner/lean4-split-leanpkg">https://github.com/gebner/lean4-split-leanpkg</a>   At least, <code>leanpkg build</code> works in every subdirectory.  And you can also use it as a dependency.</p>



<a name="238016749"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238016749" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238016749">(May 09 2021 at 07:33)</a>:</h4>
<blockquote>
<p>We don't even have lock files yet. We should.</p>
</blockquote>
<p>leanpkg has <em>only</em> lock files (the revisions of the dependencies are fixed after all)</p>



<a name="238016949"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238016949" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238016949">(May 09 2021 at 07:37)</a>:</h4>
<p>Ah, I didn't remember whether <code>rev</code> was optional. An actual reproducibility issue is <code>lean_version = "leanprover/lean4:nightly"</code> though.</p>



<a name="238016964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238016964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238016964">(May 09 2021 at 07:37)</a>:</h4>
<p>Right, elan should just reject that.</p>



<a name="238017194"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238017194" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238017194">(May 09 2021 at 07:42)</a>:</h4>
<p>What heuristic would elan use? Reject "nightly" specifically? Reject all branches?</p>



<a name="238017210"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238017210" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238017210">(May 09 2021 at 07:43)</a>:</h4>
<p>Even tags are a reproducibility issue, as they can in principle be moved</p>



<a name="238017742"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238017742" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238017742">(May 09 2021 at 07:54)</a>:</h4>
<p>Okay, I've created <a href="https://github.com/leanprover-community/mathlib4">https://github.com/leanprover-community/mathlib4</a> . I tried to set something up like <span class="user-mention" data-user-id="110043">@Gabriel Ebner</span> 's demo but I'm not sure what to do about the "main" files, since mathlib is a library, not an application</p>



<a name="238017761"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238017761" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238017761">(May 09 2021 at 07:54)</a>:</h4>
<p><span class="user-mention" data-user-id="310045">@Eric Wieser</span>  I think nightly is even more special, since it isn't a tag or branch.  Instead it refers to the latest tag in the nightlies repository.</p>



<a name="238017834"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238017834" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238017834">(May 09 2021 at 07:56)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I think <code>prelude/leanpkg.toml</code> is missing.</p>



<a name="238017877"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238017877" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238017877">(May 09 2021 at 07:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238017742">said</a>:</p>
<blockquote>
<p>I'm not sure what to do about the "main" files, since mathlib is a library, not an application</p>
</blockquote>
<p>I think the main file needs to import all of the other ones, otherwise they won't be compiled.</p>



<a name="238017930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238017930" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238017930">(May 09 2021 at 07:58)</a>:</h4>
<p>Why can't they just be compiled separately e.g. via make</p>



<a name="238018298"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238018298" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238018298">(May 09 2021 at 08:05)</a>:</h4>
<p>Right now the hierarchy looks like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">prelude</span><span class="bp">/</span>
  <span class="n">Tactic</span><span class="bp">/</span>
    <span class="n">Basic.lean</span>
  <span class="n">Main.lean</span>
  <span class="n">leanpkg.toml</span>
<span class="n">src</span><span class="bp">/</span>
  <span class="n">Algebra</span><span class="bp">/</span>
    <span class="n">etc.</span>
<span class="n">leanpkg.toml</span>
</code></pre></div>
<p>Inside <code>prelude/Main.lean</code> I tried to <code>import Tactic.Basic</code> but it doesn't like it. (unknown package 'Tactic') There are no path settings in <code>prelude/leanpkg.toml</code></p>



<a name="238019009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019009">(May 09 2021 at 08:20)</a>:</h4>
<p>I've just pushed a fix.  You're not going to like it.</p>



<a name="238019045"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019045" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019045">(May 09 2021 at 08:20)</a>:</h4>
<p>Apparently, Lean 4 doesn't like the <code>src</code> directory.  It wants a <code>Mathlib</code> directory and a <code>Mathlib.lean</code> file (you could also use <code>OMGPleaseNo/</code> and <code>OMGPleaseNo.lean</code>).</p>



<a name="238019071"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019071" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019071">(May 09 2021 at 08:21)</a>:</h4>
<p>Lean's standard library has a makefile that does this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">stdlib</span><span class="o">:</span>
<span class="bp">#</span> <span class="n">Use</span> <span class="bp">`+`</span> <span class="n">to</span> <span class="n">use</span> <span class="n">the</span> <span class="n">Make</span> <span class="n">jobserver</span> <span class="k">with</span> <span class="bp">`</span><span class="n">leanmake</span><span class="bp">`</span> <span class="n">for</span> <span class="n">parallelized</span> <span class="n">builds</span>
    <span class="bp">+</span><span class="s2">"${LEAN_BIN}/leanmake"</span> <span class="n">lib</span> <span class="n">PKG</span><span class="bp">=</span><span class="n">Init</span> <span class="bp">$</span><span class="o">(</span><span class="n">LEANMAKE_OPTS</span><span class="o">)</span>
    <span class="bp">+</span><span class="s2">"${LEAN_BIN}/leanmake"</span> <span class="n">lib</span> <span class="n">PKG</span><span class="bp">=</span><span class="n">Std</span> <span class="bp">$</span><span class="o">(</span><span class="n">LEANMAKE_OPTS</span><span class="o">)</span>
    <span class="bp">+</span><span class="s2">"${LEAN_BIN}/leanmake"</span> <span class="n">lib</span> <span class="n">PKG</span><span class="bp">=</span><span class="n">Lean</span> <span class="bp">$</span><span class="o">(</span><span class="n">LEANMAKE_OPTS</span><span class="o">)</span>
    <span class="bp">+</span><span class="s2">"${LEAN_BIN}/leanmake"</span> <span class="n">bin</span> <span class="n">PKG</span><span class="bp">=</span><span class="n">Leanpkg</span> <span class="n">BIN_NAME</span><span class="bp">=</span><span class="n">leanpkg</span> <span class="bp">$</span><span class="o">(</span><span class="n">LEANMAKE_OPTS</span><span class="o">)</span> <span class="n">LINK_OPTS</span><span class="bp">=</span><span class="s2">"${CMAKE_EXE_LINKER_FLAGS}"</span>
</code></pre></div>
<p>The corresponding directory structure is</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">src</span><span class="bp">/</span>
  <span class="n">Init</span><span class="bp">/</span>
    <span class="n">stuff...</span>
  <span class="n">Std</span><span class="bp">/</span>
    <span class="n">stuff...</span>
  <span class="n">Init.lean</span>
  <span class="n">Std.lean</span>
</code></pre></div>
<p>and you can refer to things as <code>Init.*</code> and <code>Std.*</code>, with no extra prefix. Can we make that work?</p>



<a name="238019144"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019144" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019144">(May 09 2021 at 08:22)</a>:</h4>
<p>It is not clear to me whether <code>Init</code> is used compiled when building <code>Std</code>... probably it's just using stage 0</p>



<a name="238019322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019322">(May 09 2021 at 08:26)</a>:</h4>
<p>your fix isn't working for me</p>



<a name="238019335"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019335" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019335">(May 09 2021 at 08:26)</a>:</h4>
<p>I still get "unknown package 'Tactic'" when running <code>leanmake</code> in the <code>prelude</code> directory</p>



<a name="238019361"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019361" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019361">(May 09 2021 at 08:27)</a>:</h4>
<p>It worked for me.  But that was probably due to old olean files. :-/</p>



<a name="238019457"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019457" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019457">(May 09 2021 at 08:29)</a>:</h4>
<p>It works if I use <code>MathlibPrelude.Tactic.Basic</code> inside <code>MathlibPrelude.lean</code></p>



<a name="238019537"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019537" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019537">(May 09 2021 at 08:30)</a>:</h4>
<p>that also works inside the editor for <code>Logic/Basic.lean</code> but <code>leanmake</code> at the root fails with <code>build/temp/Mathlib/Logic/Basic.depend: No such file or directory</code></p>



<a name="238019561"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019561" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019561">(May 09 2021 at 08:31)</a>:</h4>
<p>Can you try <code>git clean -fdx</code>?  It works for me, now.</p>



<a name="238019652"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019652" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019652">(May 09 2021 at 08:33)</a>:</h4>
<p>The <code>src/</code> directory in the Lean repo is just a historical artifact</p>



<a name="238019872"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019872" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019872">(May 09 2021 at 08:37)</a>:</h4>
<p>I pulled the latest and used <code>git clean -fdx</code>, and <code>leanmake</code> works inside <code>prelude</code> but not at <code>/</code></p>



<a name="238019951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019951" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019951">(May 09 2021 at 08:38)</a>:</h4>
<p>Ok, this is weird.  I can't reproduce this at all.</p>



<a name="238019965"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238019965" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238019965">(May 09 2021 at 08:39)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="n">leanmake</span>
<span class="n">unknown</span> <span class="n">package</span> <span class="bp">'</span><span class="n">MathlibPrelude'</span>
<span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="bp">-</span><span class="n">lean4</span><span class="bp">-</span><span class="n">nightly</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/../</span><span class="n">share</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">lean.mk</span><span class="o">:</span><span class="mi">98</span><span class="o">:</span> <span class="n">build</span><span class="bp">/</span><span class="n">temp</span><span class="bp">/</span><span class="n">Mathlib</span><span class="bp">/</span><span class="n">Logic</span><span class="bp">/</span><span class="n">Basic.depend</span><span class="o">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span>
<span class="n">make</span><span class="o">:</span> <span class="bp">***</span> <span class="o">[</span><span class="bp">/</span><span class="n">home</span><span class="bp">/</span><span class="n">mario</span><span class="bp">/.</span><span class="n">elan</span><span class="bp">/</span><span class="n">toolchains</span><span class="bp">/</span><span class="n">leanprover</span><span class="bp">-</span><span class="n">lean4</span><span class="bp">-</span><span class="n">nightly</span><span class="bp">/</span><span class="n">bin</span><span class="bp">/../</span><span class="n">share</span><span class="bp">/</span><span class="n">lean</span><span class="bp">/</span><span class="n">lean.mk</span><span class="o">:</span><span class="mi">50</span><span class="o">:</span> <span class="n">build</span><span class="bp">/</span><span class="n">temp</span><span class="bp">/</span><span class="n">Mathlib</span><span class="bp">/</span><span class="n">Logic</span><span class="bp">/</span><span class="n">Basic.depend</span><span class="o">]</span> <span class="n">Error</span> <span class="mi">1</span>
</code></pre></div>



<a name="238020055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020055" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020055">(May 09 2021 at 08:40)</a>:</h4>
<p><code>leanmake</code> doesn't know about dependencies, that's <code>leanpkg</code>'s job. There usually is no reason to ever use <code>leanmake</code> directly.</p>



<a name="238020069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020069">(May 09 2021 at 08:40)</a>:</h4>
<p>and what's the mumbo jumbo</p>



<a name="238020091"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020091" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020091">(May 09 2021 at 08:41)</a>:</h4>
<p><code>leanpkg build</code> looks like it worked</p>



<a name="238020138"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020138" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020138">(May 09 2021 at 08:42)</a>:</h4>
<p>and it doesn't require going into prelude first either</p>



<a name="238020248"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020248" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020248">(May 09 2021 at 08:44)</a>:</h4>
<p>okay, so since leanpkg is... opinionated about the names of files and folders, is there a way to make this work?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Mathlib</span><span class="bp">/</span>
  <span class="n">Logic</span><span class="bp">/</span>
    <span class="n">Basic.lean</span>
<span class="n">Mathlib.lean</span>
<span class="n">Prelude</span><span class="bp">/</span>
  <span class="n">Tactic</span><span class="bp">/</span>
    <span class="n">Basic.lean</span>
<span class="n">Prelude.lean</span>
<span class="n">leanpkg.toml</span>
</code></pre></div>



<a name="238020345"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020345" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020345">(May 09 2021 at 08:46)</a>:</h4>
<p>Maybe you're taking from the wrong end. Sebastian and <a href="https://github.com/leanprover/lean4/issues/397">https://github.com/leanprover/lean4/issues/397</a> clearly state that help on <code>leanpkg</code> is very much welcome.</p>



<a name="238020436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020436">(May 09 2021 at 08:48)</a>:</h4>
<p>Okay, if this behavior is up for modification then I can certainly try to make the appropriate code changes, if someone doesn't get there first. In that case we can just plan the layout we want and make leanpkg work with it</p>



<a name="238020461"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020461" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020461">(May 09 2021 at 08:49)</a>:</h4>
<p>I'll let <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> confirm of course, but that's my understanding.</p>



<a name="238020478"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020478" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020478">(May 09 2021 at 08:49)</a>:</h4>
<p>But my impression, at least partially, is that this behavior is deliberate and viewed as better than the alternatives. Personally I liked the flexibility of the lean 3 <code>leanpkg.path</code> file: just point to the project roots and imports are relative to that</p>



<a name="238020560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020560">(May 09 2021 at 08:51)</a>:</h4>
<p>Tooling is really important and non-trivial, but it makes sense that Leo and Sebastian have no time to work on that. It would be really to have something flexible enough so that it could also do everything <code>leanproject</code> does, maybe through a <code>leanpkg</code> plugin or something.</p>



<a name="238020565"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020565" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020565">(May 09 2021 at 08:51)</a>:</h4>
<p>Sure, at this point I'm just trying to solicit design criteria</p>



<a name="238020640"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020640" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020640">(May 09 2021 at 08:53)</a>:</h4>
<p>The existence of <code>leanproject</code> in some ways indicates that <code>leanpkg</code> was not fulfilling its goal, or at least that it was abandoned and the new crowd didn't want to work with the old code base</p>



<a name="238020752"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020752" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020752">(May 09 2021 at 08:55)</a>:</h4>
<p>Are we going to reinvent <code>leanproject</code> for mathlib 4? I don't think it's necessarily a bad idea - mathlib has to handle several things beyond what leanpkg itself is even aware of, like downloading built oleans, plus things like docgen might end up in it as well (I don't actually know if this is currently the case).</p>



<a name="238020755"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020755" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020755">(May 09 2021 at 08:55)</a>:</h4>
<p>I think Lean 3 was not very convenient for this kind of programming, but this may very well be incompetence from me.</p>



<a name="238020809"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020809" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020809">(May 09 2021 at 08:56)</a>:</h4>
<p>Since we know that users will have a copy of lean, it's quite possible that the best scripting language to use for build tooling is lean 4</p>



<a name="238020817"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020817" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020817">(May 09 2021 at 08:56)</a>:</h4>
<p>I also wrote it under the misconceptions that everybody on earth could easily get a sane python environment. At least once per month we see on Zulip how wrong I was.</p>



<a name="238020935"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020935" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020935">(May 09 2021 at 08:58)</a>:</h4>
<p>About doing it in Lean 4, I guess the main roadblock is available libraries. <code>leanproject</code> talks to git (not from simply executing the command line git client), downloads files, decompresses files. How far are we from doing that in a Lean 4 project (without implementing the zip compression and decompression  algorithm)?</p>



<a name="238020962"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020962" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020962">(May 09 2021 at 08:59)</a>:</h4>
<p>Is it already possible to simply link Lean code and a C library and call C functions from Lean?</p>



<a name="238020964"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020964" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020964">(May 09 2021 at 08:59)</a>:</h4>
<p>you can get by with the equivalent of shell scripting for a lot of that</p>



<a name="238020977"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020977" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020977">(May 09 2021 at 08:59)</a>:</h4>
<p>oh that's a good point</p>



<a name="238020980"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238020980" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238020980">(May 09 2021 at 08:59)</a>:</h4>
<p>Isn't this assuming the existence of a sane shell/POSIX environment?</p>



<a name="238021041"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021041" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021041">(May 09 2021 at 09:00)</a>:</h4>
<p>However I think that a program that needs to link with a C library is at risk of environment issues</p>



<a name="238021068"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021068" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021068">(May 09 2021 at 09:00)</a>:</h4>
<p>a shell script is too</p>



<a name="238021087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021087">(May 09 2021 at 09:00)</a>:</h4>
<p>Can't we statically link to make sure everything is in the executable?</p>



<a name="238021105"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021105" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021105">(May 09 2021 at 09:01)</a>:</h4>
<p>I never knew much about C compilation and forgot most of it.</p>



<a name="238021113"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021113" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021113">(May 09 2021 at 09:01)</a>:</h4>
<p>Yes, if we statically link and distribute the binary that's probably the most reliable method</p>



<a name="238021141"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021141" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021141">(May 09 2021 at 09:01)</a>:</h4>
<p>I would hope that embarking git and a compression/decompression lib wouldn't be too huge.</p>



<a name="238021230"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021230" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021230">(May 09 2021 at 09:02)</a>:</h4>
<p>That doesn't answer my question: is this currently possible in Lean 4 (from user land)?</p>



<a name="238021287"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021287" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021287">(May 09 2021 at 09:03)</a>:</h4>
<p>I'm not sure. I think so, we just need a good demo of it</p>



<a name="238021391"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021391" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021391">(May 09 2021 at 09:04)</a>:</h4>
<p>You can use <code>@[extern]</code> to inline bits of C code, that can call an external function; then during the compilation stage you just link in the libraries you need to supply the function</p>



<a name="238021602"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021602" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021602">(May 09 2021 at 09:07)</a>:</h4>
<p>Yeah, with the help of some inline C code you should be able to fill out most FFI holes (strings, structures as long as they are behind a pointer, ...)</p>



<a name="238021769"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021769" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021769">(May 09 2021 at 09:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238020248">said</a>:</p>
<blockquote>
<p>okay, so since leanpkg is... opinionated about the names of files and folders, is there a way to make this work?</p>
<p><div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Mathlib</span><span class="bp">/</span>
  <span class="n">Logic</span><span class="bp">/</span>
    <span class="n">Basic.lean</span>
<span class="n">Mathlib.lean</span>
<span class="n">Prelude</span><span class="bp">/</span>
  <span class="n">Tactic</span><span class="bp">/</span>
    <span class="n">Basic.lean</span>
<span class="n">Prelude.lean</span>
<span class="n">leanpkg.toml</span>
</code></pre></div><br>
</p>
</blockquote>
<p>How do you declare what parts should be compiled and loaded as plugins for the other files? Our assumption was that packages are the most intuitive boundary for that (like with Rust's procedural macros, with the important difference that in Lean you <em>can</em> just interpret macros inside the same package), and I believe that each package should have its own <code>leanpkg.toml</code> (like in Rust).</p>



<a name="238021896"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238021896" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238021896">(May 09 2021 at 09:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238021287">said</a>:</p>
<blockquote>
<p>we [just] need a good demo of it</p>
</blockquote>
<p>This sounds very true to me.</p>



<a name="238023278"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023278" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023278">(May 09 2021 at 09:39)</a>:</h4>
<p>If this were rust, the hierarchy would look more like this:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">src</span><span class="bp">/</span>
  <span class="n">Logic</span><span class="bp">/</span>
    <span class="n">Basic.lean</span>
  <span class="n">Lib.lean</span>
  <span class="n">leanpkg.toml</span>
<span class="n">prelude</span><span class="bp">/</span>
  <span class="n">Tactic</span><span class="bp">/</span>
    <span class="n">Basic.lean</span>
  <span class="n">Lib.lean</span>
  <span class="n">leanpkg.toml</span>
</code></pre></div>
<p>Here I'm imagining that leanpkg is either defaulting to a file named <code>Lib.lean</code>, or (preferably) this can be set inside the toml file. Similarly, the mathlib toml file uses a path dependency like <code>../prelude</code> to point to the other file.</p>



<a name="238023300"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023300" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023300">(May 09 2021 at 09:39)</a>:</h4>
<p>In particular, the names <code>src/</code> and <code>prelude/</code> don't have to be anything in particular</p>



<a name="238023380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023380">(May 09 2021 at 09:41)</a>:</h4>
<p><a href="https://github.com/leanprover-community/mathlib4/issues/1">mathlib4#1</a></p>



<a name="238023482"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023482" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023482">(May 09 2021 at 09:42)</a>:</h4>
<p>Actually it should also be a possibility to put the mathlib toml file at the root, where the file has a <code>src = "./src"</code> key to find the actual root for the sources</p>



<a name="238023485"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023485" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023485">(May 09 2021 at 09:43)</a>:</h4>
<p>That PR does a bit of Makefile hackery to get rid of the separate project requirement for plugins.</p>



<a name="238023512"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023512" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023512">(May 09 2021 at 09:43)</a>:</h4>
<p>I see a reference to stage0, does this mean that mathlib can be it's own prelude? :D</p>



<a name="238023517"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023517" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023517">(May 09 2021 at 09:43)</a>:</h4>
<p>Yes!</p>



<a name="238023664"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023664" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023664">(May 09 2021 at 09:46)</a>:</h4>
<p>It is a bit wasteful since it compiles that plugin's dependencies twice.  In principle that's solvable, but it requires copy&amp;pasting the makefile.</p>



<a name="238023671"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023671" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023671">(May 09 2021 at 09:46)</a>:</h4>
<p>how does that work exactly? Do we still need to keep the files separate</p>



<a name="238023672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023672" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023672">(May 09 2021 at 09:46)</a>:</h4>
<p>At that point it might be easier/faster to just rewrite leanmake in lean.</p>



<a name="238023696"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023696" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023696">(May 09 2021 at 09:47)</a>:</h4>
<p>No need to keep the files separate.  It operates in two stages:</p>
<ol>
<li>stage0 compiles Mathlib/Plugin.lean (and its dependencies) and links it into <code>Mathlib_Plugin.so</code></li>
<li>Then all of mathlib is compiled with the <code>--plugin=Mathlib_Plugin.so</code> argument.</li>
</ol>



<a name="238023736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023736">(May 09 2021 at 09:47)</a>:</h4>
<p>So the only rule is that any dependency of <code>Plugin.lean</code> can't use tactics from the plugin</p>



<a name="238023782"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023782" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023782">(May 09 2021 at 09:48)</a>:</h4>
<p>I think you can still use the tactics, they'll just be interpreted, right?</p>



<a name="238023783"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023783" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023783">(May 09 2021 at 09:48)</a>:</h4>
<p>or maybe they still can, but interpreted?</p>



<a name="238023813"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023813" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023813">(May 09 2021 at 09:49)</a>:</h4>
<p>certainly you can't use a tactic before it's defined though, unlike lean</p>



<a name="238023841"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023841" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023841">(May 09 2021 at 09:49)</a>:</h4>
<p>(we would need to keep a copy of the source tree if we wanted that, which sounds like way too much effort)</p>



<a name="238023893"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023893" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023893">(May 09 2021 at 09:50)</a>:</h4>
<p>The intended layout was</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">prelude</span><span class="bp">/</span>
  <span class="n">MathlibPrelude.lean</span>
  <span class="n">MathlibPrelude</span><span class="bp">/</span>
  <span class="n">leanpkg.toml</span>
<span class="n">Mathlib.lean</span>
<span class="n">Mathlib</span><span class="bp">/</span>
<span class="n">leanpkg.toml</span>
</code></pre></div>



<a name="238023896"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023896" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023896">(May 09 2021 at 09:50)</a>:</h4>
<p>Tactics in proofs would be fine (stage0 could set a -Dskip_all_proofs=true flag or something).</p>



<a name="238023931"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238023931" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238023931">(May 09 2021 at 09:51)</a>:</h4>
<p>But I believe plugins can also add other features (like linters) that can take effect before they are defined.</p>



<a name="238024009"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024009" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024009">(May 09 2021 at 09:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238023893">said</a>:</p>
<blockquote>
<p>The intended layout was</p>
<p><div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">prelude</span><span class="bp">/</span>
  <span class="n">MathlibPrelude</span><span class="bp">/</span>
</code></pre></div><br>
</p>
</blockquote>
<p>This is pretty cumbersome, since you need to write <code>import MathlibPrelude.Tactic.Core</code> instead of <code>import Mathlib.Tactic.Core</code> (which is already too long).  You also need to remember where it happened to be defined.</p>



<a name="238024011"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024011" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024011">(May 09 2021 at 09:52)</a>:</h4>
<p>Didn't Leo told us we don't want to go to <code>stage0</code> hell?</p>



<a name="238024034"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024034" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024034">(May 09 2021 at 09:53)</a>:</h4>
<p>Also <code>MathlibPrelude</code> / <code>Mathlib</code> is the name of the project, it's silly to have all sources in a file with the name of the project because you are already presumably in such a folder</p>



<a name="238024093"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024093" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024093">(May 09 2021 at 09:54)</a>:</h4>
<p><span class="user-mention" data-user-id="110031">@Patrick Massot</span>  The stage0 thing in core is something different: they include the compiled C files in the git repository.  We'd just be compiling (a small part of) mathlib twice.</p>



<a name="238024125"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024125" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024125">(May 09 2021 at 09:55)</a>:</h4>
<p>I would prefer if the folder hierarchy just skips that top level, and then <code>src/Foo/Bar.lean</code> exists at <code>ProjectName.Foo.Bar</code>, where <code>ProjectName</code> is in the toml file</p>



<a name="238024139"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024139" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024139">(May 09 2021 at 09:55)</a>:</h4>
<p>or you can set the source folder to <code>.</code> and just put it at <code>Foo/Bar.lean</code></p>



<a name="238024286"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024286" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024286">(May 09 2021 at 09:58)</a>:</h4>
<p>Looking at the lean source layout, I wonder whether we can also do something similar, where the mathlib project actually consists of multiple lean "packages" along some kind of topical lines. Perhaps even the current top level folders. As long as these projects can reference each other that would seem to be a way to get rid of that top level qualifier</p>



<a name="238024314"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024314" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024314">(May 09 2021 at 09:59)</a>:</h4>
<p>(referring to the fact that there are four top level lean packages defined in the lean source tree - <code>Init</code>, <code>Lean</code>, <code>Src</code>, <code>Leanpkg</code>)</p>



<a name="238024468"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024468" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024468">(May 09 2021 at 10:01)</a>:</h4>
<p>Gabriel, I remember a discussion during LT2021 when someone suggested we could have something like stage0 to handle precisely this issue in mathlib, and Leo laughed and told us we definitely don't want to go in this direction. But I don't remember any more detail.</p>



<a name="238024759"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024759" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024759">(May 09 2021 at 10:06)</a>:</h4>
<p>I'm pretty sure that he referred to using macros before they're defined.  E.g. we might want to implement a <code>derive EquivFunctor</code> handler (for Scott's transfer tactic).  Since it is so useful, we might want to use <code>derive EquivFunctor</code> when implementing it.  One crazy proposal to make that work is to commit "expanded" Lean files to the mathlib repository, where all occurrences of <code>derive EquivFunctor</code> have been (automatically) expanded.  I believe this is what Leo was laughing at.</p>



<a name="238024793"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238024793" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238024793">(May 09 2021 at 10:07)</a>:</h4>
<p>I think I should just remove the stage0 name.</p>



<a name="238025101"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238025101" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238025101">(May 09 2021 at 10:13)</a>:</h4>
<p>We don't really need to compile anything twice here, right? We can just avoid compiling any file that is a dependency of <code>Plugin.lean</code> during the second pass</p>



<a name="238025112"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238025112" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238025112">(May 09 2021 at 10:13)</a>:</h4>
<p>which should happen automatically since the build files already exist</p>



<a name="238025195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238025195" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238025195">(May 09 2021 at 10:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238024793">said</a>:</p>
<blockquote>
<p>I think I should just remove the stage0 name.</p>
</blockquote>
<p>It's more of a stage 1</p>



<a name="238025303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238025303" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238025303">(May 09 2021 at 10:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238025101">said</a>:</p>
<blockquote>
<p>We don't really need to compile anything twice here, right? We can just avoid compiling any file that is a dependency of <code>Plugin.lean</code> during the second pass</p>
</blockquote>
<p>This is unfortunately hard, we'd need to add the <code>Mathlib_Plugin.so</code>dependency to those files only.  This is hard to do in make.</p>



<a name="238025965"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238025965" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238025965">(May 09 2021 at 10:29)</a>:</h4>
<p>By the way, feel free to merge the PR yourself when you think it is ready. I'm not planning for us to have any review standards in the mathlib4 repo higher than your average wiki during this experimentation phase, at least until we start putting CI credentials or something in it</p>



<a name="238026104"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238026104" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238026104">(May 09 2021 at 10:30)</a>:</h4>
<p>Done. It's so nice to work on a project where CI takes only 16s.</p>



<a name="238027227"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238027227" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238027227">(May 09 2021 at 10:50)</a>:</h4>
<p>I would have hoped that we could come up with a less hackish approach when we have the chance to reimagine Lean package management <span aria-label="frowning" class="emoji emoji-1f626" role="img" title="frowning">:frowning:</span> . Something principled that we can put in leanpkg, eventually without depending on <code>make</code>, so that other projects can use the same approach.</p>



<a name="238027396"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238027396" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238027396">(May 09 2021 at 10:52)</a>:</h4>
<p>To be fair, that Makefile hack is more of a proof of concept showing that:</p>
<ol>
<li>We only need one <code>Mathlib</code> directory.</li>
<li>We don't need to manually split mathlib into stages.</li>
<li>This doesn't require large changes to Lean.</li>
</ol>



<a name="238027507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238027507" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238027507">(May 09 2021 at 10:54)</a>:</h4>
<blockquote>
<p>eventually without depending on <code>make</code></p>
</blockquote>
<p>Indeed, my next step would be to rewrite the Makefile into a <code>build.lean</code> file.  (No need to spawn a subprocess for <code>lean --deps</code> anymore!)  If that works out well, we can move it into Lean/leanpkg.</p>



<a name="238028053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238028053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238028053">(May 09 2021 at 11:03)</a>:</h4>
<p>I still think that separate (sub)packages are the most natural solution to compiling different parts of a project in different modes. How these packages are laid out on disk is a related but separate question. Also consider third parties that want to use mathlib tactics without mathlib.</p>



<a name="238028970"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238028970" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238028970">(May 09 2021 at 11:18)</a>:</h4>
<blockquote>
<p>How these packages are laid out on disk is a related but separate question.</p>
</blockquote>
<p>Ultimately, I don't think anybody on the mathlib side cares about the packaging.  The core issue <em>is</em> the disk layout:</p>
<ol>
<li>Simple directory structure (no <code>mathlib/prelude/MathlibPrelude</code>).</li>
<li>Uniform imports (no figuring out whether its <code>MathlibPrelude.LinearAlgebra.Basic</code> or <code>Mathlib.LinearAlgebra.Basic</code> or <code>LinearAlgebra.Basic</code>).</li>
<li>All <code>LinearAlgebra</code> files (e.g.) should be in the same subdirectory.</li>
</ol>



<a name="238031700"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238031700" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238031700">(May 09 2021 at 12:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238028053">said</a>:</p>
<blockquote>
<p>Also consider third parties that want to use mathlib tactics without mathlib.</p>
</blockquote>
<p>Then you can just import mathlib; all the interesting tactics in mathlib depend on types and lemmas from mathlib anyhow.  I have seen one good argument why you wouldn't want to do that in Lean 3: Joe Hendrix said that the <code>nat.cast</code> coercion introduced a performance footgun in a bitvector library.  Note that 1) this will most likely no longer be an issue in Lean 4, and 2) such an instance would already be in the prelude, so you don't gain anything from the split.</p>



<a name="238032624"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238032624" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238032624">(May 09 2021 at 12:25)</a>:</h4>
<p>Do you have a feeling for how big the prelude will be? I get the point that it will probably be too big to put in a separate package. But I still wonder about whether the double compilation will (ever) be an issue, whether people will unknowingly increase the prelude, what the ramifications for separate compilation, if that can be applied at all to mathlib, are, etc...</p>



<a name="238032712"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238032712" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238032712">(May 09 2021 at 12:26)</a>:</h4>
<p>I'm also assuming that even disregarding the prelude, there are too many (cyclic) interconnections between topics to e.g. put (most of) <code>LinearAlgebra</code> in a separate package.</p>



<a name="238032946"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238032946" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238032946">(May 09 2021 at 12:31)</a>:</h4>
<blockquote>
<p>But I still wonder about whether the double compilation will (ever) be an issue</p>
</blockquote>
<p>I think I was not clear enough about this.  The double compilation is a hack because anything more clever is too hard to do with a Makefile.  After rewriting the Makefile in Lean, it should be easy enough to compile the plugin+dependencies only once, and the rest with <code>--plugin=...</code>.  Or maybe the double compilation is actually useful (so that we can use automation in Mathlib.Logic.Base, I don't know yet).</p>



<a name="238033085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238033085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238033085">(May 09 2021 at 12:33)</a>:</h4>
<p>So it would be something like "compile these modules and their dependencies into a shared library, then compile all remaining modules using the library"?</p>



<a name="238033220"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238033220" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238033220">(May 09 2021 at 12:35)</a>:</h4>
<p>Yes. AFAICT, there are two possible reasons why we want plugins:</p>
<ul>
<li><code>linarith</code>, etc. should be as fast as possible.</li>
<li>It would be cool if <code>#lint</code> worked everywhere.</li>
</ul>



<a name="238033467"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238033467" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238033467">(May 09 2021 at 12:40)</a>:</h4>
<blockquote>
<p>there are too many (cyclic) interconnections between topics to e.g. put (most of) LinearAlgebra in a separate package.</p>
</blockquote>
<p>Pretty much.  The mathlib import graph is a big hairy ball.</p>



<a name="238033509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238033509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238033509">(May 09 2021 at 12:41)</a>:</h4>
<p>(Luckily it can still be combed because mathlib has holes.)</p>



<a name="238033519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238033519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238033519">(May 09 2021 at 12:41)</a>:</h4>
<p>are some  / most of the issues solved or become non-issue in the presence of a nix-based per-file build or in case we had per-file JIT and therefore would only rely on interpretation within a file but not across files?</p>



<a name="238033610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238033610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238033610">(May 09 2021 at 12:43)</a>:</h4>
<p>I don't see how nix per-file builds would change anything.  JIT compilation would probably make a difference (no idea about the warm-up costs).  Another very brutal solution would be to produce one shared object per lean file, and then pass all of them as <code>--plugin</code> arguments.</p>



<a name="238033717"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238033717" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238033717">(May 09 2021 at 12:45)</a>:</h4>
<p>well, the way how the lean compiler itself is built using nix works such, that the main module and its transitive dependencies are built and become available as imports for downstream dependencies.</p>



<a name="238033774"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238033774" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238033774">(May 09 2021 at 12:46)</a>:</h4>
<p>That's pretty much the same a JIT, no? At least insofar, as the thing you're importing is an already-built binary IIUC</p>



<a name="238034139"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238034139" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238034139">(May 09 2021 at 12:53)</a>:</h4>
<blockquote>
<p>the way how the lean compiler itself is built using nix works such, that the main module and its transitive dependencies are built and become available as imports for downstream dependencies.</p>
</blockquote>
<p>It's not how the compiler is built itself (this is a different mechanism).  The nix build files included with Lean do support plugins though, but you can only compile a single package into a plugin.</p>
<p>You can also use nix to execute the two-staged approach that is now (temporarily) used in mathlib4.  Unfortunately the nix cache can't help you here.</p>



<a name="238034334"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238034334" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238034334">(May 09 2021 at 12:56)</a>:</h4>
<blockquote>
<p>That's pretty much the same a JIT, no? At least insofar, as the thing you're importing is an already-built binary IIUC</p>
</blockquote>
<p>As the name implies, just-in-time compilation refers to compilation while the program is running.  If you're loading the binaries from disk, then it's ahead-of-time compilation.</p>



<a name="238035142"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238035142" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238035142">(May 09 2021 at 13:08)</a>:</h4>
<p>what I was referring to was the question when a tactic defined is turned into compiled code and when is it interpreted. IIUC, inside of a file, the tactic would always be interpreted (it is available in the line straight after being defined), whereas when it's imported, then it ideally is already compiled. </p>
<p>So that subsequent files compile potentially much faster. This is important for something like mathlib that is its own consumer. And my understanding was, that the nix build AOT compiles as port of the <code>import</code>, effectively.</p>
<p>It is in that sense, that JIT would have a similar benefit. Depending of course, when exactly you JIT... One proposal was to JIT as part of the <code>import</code> as opposed to after each definition.</p>



<a name="238035400"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238035400" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238035400">(May 09 2021 at 13:12)</a>:</h4>
<p>No, there is no per-file native compilation in the Nix build either</p>



<a name="238035413"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238035413" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238035413">(May 09 2021 at 13:13)</a>:</h4>
<p>thanks for the clarification.</p>



<a name="238035439"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238035439" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238035439">(May 09 2021 at 13:13)</a>:</h4>
<p>so then, JIT would potentially really be a good thing.</p>



<a name="238041751"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238041751" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238041751">(May 09 2021 at 15:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238031700">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238028053">said</a>:</p>
<blockquote>
<p>Also consider third parties that want to use mathlib tactics without mathlib.</p>
</blockquote>
<p>Then you can just import mathlib; all the interesting tactics in mathlib depend on types and lemmas from mathlib anyhow.  I have seen one good argument why you wouldn't want to do that in Lean 3: Joe Hendrix said that the <code>nat.cast</code> coercion introduced a performance footgun in a bitvector library.  Note that 1) this will most likely no longer be an issue in Lean 4, and 2) such an instance would already be in the prelude, so you don't gain anything from the split.</p>
</blockquote>
<p>Personally, I find "Then you can just import mathlib" to be a horrible solution. That introduces an absolutely massive dependency which severely pollutes the global namespace. This is one of the main reasons I heavily avoided mathlib in my own projects in Lean 3. If I want to toy around with proofs in some aspect of mathematics or build a formalization for some subsection that is different then mathlib's then I have to deal with mathlib having eaten all the reasonable names for concepts in the global namespace. This would be less of a problem if mathlib stuck its content inside its own namespace or if Lean did not use transitive flat imports, but neither of those things seem likely to change this iteration, so I still consider this to be a major problem with mathlib.</p>



<a name="238042091"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238042091" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238042091">(May 09 2021 at 15:14)</a>:</h4>
<p>Mac, why do you use mathlib at all? Is it only because it gives you the opportunity to be rude?</p>



<a name="238043303"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238043303" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238043303">(May 09 2021 at 15:37)</a>:</h4>
<p>I had no intentions of being rude, and I apologize if my comment came off that way.  I was simply giving my thoughts on the matter and pointing out a potential concern with the solution of "Then just import mathlib" for a monolithic mathlib. It seemed to fit well with the discussion, seeing as there was a lot of back-and-forth about what package/repo split there should be (if any). </p>
<p>I used descriptions like "horrible" to emphasize the strength of my feelings/opinions on the matter. I believe this to be appropriate, though I guess I can see how it could appear rude.</p>



<a name="238044292"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238044292" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238044292">(May 09 2021 at 15:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238028970">said</a>:</p>
<blockquote>
<blockquote>
<p>How these packages are laid out on disk is a related but separate question.</p>
</blockquote>
<p>Ultimately, I don't think anybody on the mathlib side cares about the packaging.  The core issue <em>is</em> the disk layout:</p>
<ol>
<li>Simple directory structure (no <code>mathlib/prelude/MathlibPrelude</code>).</li>
<li>Uniform imports (no figuring out whether its <code>MathlibPrelude.LinearAlgebra.Basic</code> or <code>Mathlib.LinearAlgebra.Basic</code> or <code>LinearAlgebra.Basic</code>).</li>
<li>All <code>LinearAlgebra</code> files (e.g.) should be in the same subdirectory.</li>
</ol>
</blockquote>
<p>To resolve the <code>MathlibPrelude</code>/<code>Mathlib</code> problem, you could have dummy files like <code>Mathlib.LinearAlgebra.Basic</code> that simply import <code>MathlibPrelude.LinearAlgebra.Basic</code>, thus making the imports appear uniform to consumers.</p>
<p>Alternatively, could this work as a potential directory structure:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">Mathlib.lean</span>
<span class="n">Mathlib</span><span class="bp">/</span>
  <span class="n">Prelude</span><span class="bp">/</span>
  <span class="n">Prelude.lean</span>
  <span class="n">leanpkg.toml</span>
<span class="n">leanpkg.toml</span>
</code></pre></div>
<p>That is, is it possible to get <code>leanpkg</code> to work with subpackages within the current package's directory structure? This may be a good question for <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> ,</p>



<a name="238063308"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238063308" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Eric Wieser <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238063308">(May 09 2021 at 21:30)</a>:</h4>
<p>The fact that mathlib takes all the names in the global namespace shouldn't be a problem as long as your code doesn't operate in the global namespace, right? Or are there still pain points there? Expecting mathlib to stay out of the global namespace so that you can use it instead seems somewhat hypocritical, although admittedly mathlib's use of it is easy to construe as selfish.</p>



<a name="238064600"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238064600" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238064600">(May 09 2021 at 21:54)</a>:</h4>
<p>Looking at the results of <code>leanpkg build</code> on mathlib4 right now, I notice that it has to call <code>leanc</code> on every file. This is likely to be wasted work for a large fraction of mathlib files, which have no computable definitions, or at least nothing that we care to have compiled. Maybe there should be a way for lean files to signal that they are in "mathematician mode" and want to opt out of compilation</p>



<a name="238064805"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238064805" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238064805">(May 09 2021 at 21:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310045">Eric Wieser</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238063308">said</a>:</p>
<blockquote>
<p>The fact that mathlib takes all the names in the global namespace shouldn't be a problem as long as your code doesn't operate in the global namespace, right?</p>
</blockquote>
<p>Unfortunately, that is not how Lean works. Local and scoped notation that clashes with global notation is considered ambiguous and global names clash with namespace names if the namespace has been <code>open</code>'d. See the example here: <a href="#narrow/stream/270676-lean4/topic/Lean.20Hide.20Root.20Names.2FMacros/near/234738423">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.20Hide.20Root.20Names.2FMacros/near/234738423</a> (that thread in general was about my issues with global name clashes).</p>



<a name="238066438"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238066438" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238066438">(May 09 2021 at 22:28)</a>:</h4>
<p>Note that mathlib is generally very conservative about global notation for exactly this reason, and uses local and scoped ("localized") notations since those don't have ambiguity issues</p>



<a name="238066448"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238066448" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238066448">(May 09 2021 at 22:29)</a>:</h4>
<p>It is possible that lean 4 has a different resolution mechanism that means that this strategy doesn't work anymore</p>



<a name="238075261"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238075261" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238075261">(May 10 2021 at 01:14)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> Not quite sure if this is hijacking the thread, so please do tell so, if you think my discussion should be a separate topic.</p>
<p>How do you plan to structure mathlib 4? Specifically, how can we go about structuring it into packages that limit the dependency you need to take on? E.g. you want to build some crypto verification. In this case you most likely mostly care about some fairly basic algebra, but not analysis. Chances are you'd not even need the reals, etc.</p>



<a name="238075507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238075507" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238075507">(May 10 2021 at 01:18)</a>:</h4>
<p>Well, mathlib has historically been reasonably good at importing only the things that are needed, so you can depend on a file and only the dependencies of that particular file need to be compiled. In the last year or so I think I haven't been exerting enough pressure to make sure that it stays this way so I think it might be more of a tangled web now, but in theory if someone needed to curate a particular subset for some purpose they could split up more files and decrease transitive dependencies to ensure that there isn't too much baggage getting pulled in</p>



<a name="238075562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238075562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238075562">(May 10 2021 at 01:19)</a>:</h4>
<p>For low level things like <code>nat</code>, <code>list</code>, and even <code>rat</code> and <code>real</code> to some extent, you should be able to get the basic stuff without pulling in half of the library</p>



<a name="238075630"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238075630" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238075630">(May 10 2021 at 01:20)</a>:</h4>
<p>However, I don't think that this can be accomplished with package level splits. That's way too coarse for mathlib</p>



<a name="238075859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238075859" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238075859">(May 10 2021 at 01:24)</a>:</h4>
<p>so the proposed strategy is to rely on mathlib as a package and then depend on specific modules?</p>



<a name="238076205"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238076205" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238076205">(May 10 2021 at 01:31)</a>:</h4>
<p>yes</p>



<a name="238076861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238076861" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238076861">(May 10 2021 at 01:45)</a>:</h4>
<p>should we have 10-20 for the lack of a better word "interface files" for mathlib, then? I.e. main entry points like algebra or analysis and compile each one into a package? These would still sit in the monorepo but would allow for us to distribute them more easily and wouldn't require a full mathlib dependency if you work in a limited domain?</p>



<a name="238077124"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238077124" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238077124">(May 10 2021 at 01:50)</a>:</h4>
<p>The problem with "main entry points" is that those files tend to be the source of a lot of spurious dependencies, so we try to avoid using them inside mathlib itself, and from outside mathlib it all comes down to your individual requirements. It is possible to import entire folders but that's generally not a good idea if you want to have a small dependency footprint</p>



<a name="238086750"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238086750" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238086750">(May 10 2021 at 04:47)</a>:</h4>
<p>I think stripping down imports and making parts of mathlib more orthogonal is a great discussion to have about mathlib3, but should not be considered as part of porting mathlib to Lean 4.</p>



<a name="238102653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238102653" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238102653">(May 10 2021 at 08:14)</a>:</h4>
<p>Fair enough, I'll open the discussion there, then</p>



<a name="238105157"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238105157" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238105157">(May 10 2021 at 08:33)</a>:</h4>
<p>I just ported <code>init.data.nat.lemmas</code> in the mathlib4 repo. <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> However, I left an easter egg in it:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">protected</span> <span class="kd">lemma</span> <span class="n">min_le_left</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n"></span><span class="o">)</span> <span class="o">:</span> <span class="n">Nat.min</span> <span class="n">a</span> <span class="n">b</span> <span class="bp"></span> <span class="n">a</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">simp</span> <span class="o">[</span><span class="n">Nat.min</span><span class="o">]</span><span class="bp">;</span> <span class="n">by_cases</span> <span class="n">a</span> <span class="bp"></span> <span class="n">b</span> <span class="bp">&lt;;&gt;</span> <span class="n">simp</span> <span class="o">[</span><span class="n">h</span><span class="o">]</span>
  <span class="n">case</span> <span class="n">pos</span> <span class="bp">=&gt;</span> <span class="n">exact</span> <span class="n">Nat.le_refl</span> <span class="n">_</span>
  <span class="n">case</span> <span class="n">neg</span> <span class="bp">=&gt;</span> <span class="n">exact</span> <span class="n">_</span> <span class="c1">-- &lt;- is this a bug? I'm not getting an error here</span>
</code></pre></div>
<p>There are no errors thrown up when processing this definition, and in fact the full build completes successfully. If you don't put a tactic there it clearly shows there is a remaining goal, and if you put <code>sorry</code> then it will say the proof uses sorry, so it seems that the hole is actually a part of the proof. I don't think <code>simp</code> is finishing the goal because you need an application of <code>Nat.le_of_not_le</code> to complete the proof and that's not a simp lemma. I'm not sure how to do the trust zero dance in lean 4 though.</p>



<a name="238108089"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238108089" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238108089">(May 10 2021 at 09:01)</a>:</h4>
<p>print the term?</p>



<a name="238108195"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238108195" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238108195">(May 10 2021 at 09:02)</a>:</h4>
<p>the kernel doesn't eat meta variables, so it must have done <em>something</em></p>



<a name="238110546"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238110546" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238110546">(May 10 2021 at 09:23)</a>:</h4>
<p>The term puts all the interesting stuff in private lemmas that I can't even <code>#print</code></p>



<a name="238110682"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238110682" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238110682">(May 10 2021 at 09:24)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">protected</span> <span class="kd">theorem</span> <span class="n">Nat.min_le_left</span> <span class="o">:</span> <span class="bp"></span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n"></span><span class="o">),</span> <span class="n">Nat.min</span> <span class="n">a</span> <span class="n">b</span> <span class="bp"></span> <span class="n">a</span> <span class="o">:=</span>
<span class="k">fun</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n"></span><span class="o">)</span> <span class="bp">=&gt;</span>
  <span class="n">Or.casesOn</span> <span class="o">(</span><span class="n">Decidable.em</span> <span class="o">(</span><span class="n">a</span> <span class="bp"></span> <span class="n">b</span><span class="o">))</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">a</span> <span class="bp"></span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="n">h_1</span> <span class="o">:</span> <span class="n">Decidable.em</span> <span class="o">(</span><span class="n">a</span> <span class="bp"></span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">Or.inl</span> <span class="n">h</span><span class="o">)</span> <span class="bp">=&gt;</span>
      <span class="n">Eq.ndrec</span>
        <span class="o">(</span><span class="n">Eq.mpr</span>
          <span class="o">(</span><span class="n">congrFun</span>
            <span class="o">(</span><span class="n">congrArg</span> <span class="n">LE.le</span>
              <span class="o">(</span><span class="n">Eq.trans</span> <span class="o">(</span><span class="n">iteCongr</span> <span class="o">(</span><span class="n">eqTrue</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">a_1</span> <span class="o">:</span> <span class="n">True</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">Eq.refl</span> <span class="n">a</span><span class="o">)</span> <span class="k">fun</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="bp"></span><span class="n">True</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">Eq.refl</span> <span class="n">b</span><span class="o">)</span>
                <span class="o">(</span><span class="n">if_pos</span> <span class="o">(</span><span class="n">ofEqTrue</span> <span class="o">(</span><span class="n">Eq.refl</span> <span class="n">True</span><span class="o">)))))</span>
            <span class="n">a</span><span class="o">)</span>
          <span class="o">(</span><span class="n">Nat.le_refl</span> <span class="n">a</span><span class="o">))</span>
        <span class="o">(</span><span class="n">Eq.symm</span> <span class="n">h_1</span><span class="o">))</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="bp"></span><span class="n">a</span> <span class="bp"></span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="n">h_1</span> <span class="o">:</span> <span class="n">Decidable.em</span> <span class="o">(</span><span class="n">a</span> <span class="bp"></span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">Or.inr</span> <span class="n">h</span><span class="o">)</span> <span class="bp">=&gt;</span>
      <span class="n">Eq.ndrec</span>
        <span class="o">(</span><span class="n">Eq.mpr</span>
          <span class="o">(</span><span class="n">congrFun</span>
            <span class="o">(</span><span class="n">congrArg</span> <span class="n">LE.le</span>
              <span class="o">(</span><span class="n">Eq.trans</span> <span class="o">(</span><span class="n">iteCongr</span> <span class="o">(</span><span class="n">eqFalse</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">a_1</span> <span class="o">:</span> <span class="n">False</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">Eq.refl</span> <span class="n">a</span><span class="o">)</span> <span class="k">fun</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="bp"></span><span class="n">False</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="n">Eq.refl</span> <span class="n">b</span><span class="o">)</span>
                <span class="o">(</span><span class="n">if_neg</span> <span class="o">(</span><span class="n">ofEqTrue</span> <span class="o">(</span><span class="n">eqTrueOfDecide</span> <span class="o">(</span><span class="n">Eq.refl</span> <span class="n">true</span><span class="o">))))))</span>
            <span class="n">a</span><span class="o">)</span>
          <span class="gr">sorry</span><span class="o">)</span>
        <span class="o">(</span><span class="n">Eq.symm</span> <span class="n">h_1</span><span class="o">))</span>
    <span class="o">(</span><span class="n">Eq.refl</span> <span class="o">(</span><span class="n">Decidable.em</span> <span class="o">(</span><span class="n">a</span> <span class="bp"></span> <span class="n">b</span><span class="o">)))</span>
</code></pre></div>



<a name="238110717"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238110717" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238110717">(May 10 2021 at 09:25)</a>:</h4>
<p>Oh no I guess not, there is a <code>sorry</code> right there</p>



<a name="238110771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238110771" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238110771">(May 10 2021 at 09:25)</a>:</h4>
<p>still it's surprising that this made it past the kernel without a peep</p>



<a name="238111262"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238111262" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238111262">(May 10 2021 at 09:29)</a>:</h4>
<p>the kernel eats <code>sorry</code> quite happily, I know that.</p>



<a name="238111321"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238111321" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238111321">(May 10 2021 at 09:30)</a>:</h4>
<p>but you should really see it in axioms for this one... don't you?</p>



<a name="238111394"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238111394" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238111394">(May 10 2021 at 09:30)</a>:</h4>
<p>yes</p>



<a name="238111461"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238111461" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238111461">(May 10 2021 at 09:31)</a>:</h4>
<p>It's not really a soundness issue, but the usual "theorem uses 'sorry'" message is missing</p>



<a name="238111743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238111743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238111743">(May 10 2021 at 09:33)</a>:</h4>
<p>still not great... please open a github issue for this.</p>



<a name="238111758"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238111758" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238111758">(May 10 2021 at 09:33)</a>:</h4>
<p>that feels like a fairly clear bug to me</p>



<a name="238111999"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238111999" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238111999">(May 10 2021 at 09:35)</a>:</h4>
<p>I've also run into this but couldn't minimize it.  It's a pretty frustrating bug because 1) you don't know you messed up and 2) you don't know how to fix it (because you can't see the goal state).</p>



<a name="238113049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238113049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238113049">(May 10 2021 at 09:44)</a>:</h4>
<p>minimized:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">theorem</span> <span class="n">test</span> <span class="o">(</span><span class="n">o</span> <span class="o">:</span> <span class="n">x</span> <span class="bp"></span> <span class="n">y</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">x</span> <span class="bp"></span> <span class="n">y</span><span class="o">)</span> <span class="o">:</span> <span class="n">y</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">cases</span> <span class="n">o</span> <span class="k">with</span>
  <span class="bp">|</span> <span class="n">inl</span> <span class="n">h</span> <span class="bp">=&gt;</span> <span class="n">exact</span> <span class="n">f</span> <span class="n">h</span>
  <span class="bp">|</span> <span class="n">inr</span> <span class="n">h</span> <span class="bp">=&gt;</span> <span class="n">exact</span> <span class="n">_</span>
</code></pre></div>



<a name="238113177"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238113177" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238113177">(May 10 2021 at 09:45)</a>:</h4>
<p>it does the same thing with <code>induction</code> and <code>match</code> tactics, but not term mode match</p>



<a name="238114082"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238114082" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238114082">(May 10 2021 at 09:53)</a>:</h4>
<p>Oh so you have finished bikeshedding about directory structure? Do you want submissions? Do you want any of <a href="https://github.com/kbuzzard/mathlib4_experiments">https://github.com/kbuzzard/mathlib4_experiments</a> ?</p>



<a name="238114203"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238114203" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238114203">(May 10 2021 at 09:54)</a>:</h4>
<p>It doesn't compile right now because I was in the middle of <code>nodup</code> when I got called for dinner...</p>



<a name="238114240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238114240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238114240">(May 10 2021 at 09:54)</a>:</h4>
<p>All your experiments are belong to us</p>



<a name="238114405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238114405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238114405">(May 10 2021 at 09:55)</a>:</h4>
<p>I nearly have a definition of <code>finset</code></p>



<a name="238114859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238114859" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238114859">(May 10 2021 at 09:59)</a>:</h4>
<p>Stuff in CoreExt is stuff which is in core Lean 3 but which I (or SReichelt) couldn't find in core Lean 4. I work on this stuff on Thursdays on the discord, just to teach myself Lean 4. If there are any particular mathlib files which you want ported then let me know. Right now my goal was to port direct sums (as a random high-up point in the algebra heirarchy) to see if the elaboration issues which Eric was having could be reproduced in Lean 4, but this was just a random goal.</p>



<a name="238186856"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238186856" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Adam Topaz <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238186856">(May 10 2021 at 18:09)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> Just a quick reminder about this thread:<br>
<a href="#narrow/stream/113488-general/topic/finiteness/near/206179081">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/finiteness/near/206179081</a></p>



<a name="238187187"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238187187" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238187187">(May 10 2021 at 18:11)</a>:</h4>
<p>Johannes Hoelzl strongly advocated against doing any refactoring at the same time as porting.</p>



<a name="238187364"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238187364" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238187364">(May 10 2021 at 18:12)</a>:</h4>
<p>How much money do we need to buy him back from Apple? <span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span></p>



<a name="238188431"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238188431" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238188431">(May 10 2021 at 18:18)</a>:</h4>
<p><code></code></p>



<a name="238202984"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238202984" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238202984">(May 10 2021 at 20:03)</a>:</h4>
<p>I implemented the block structuring tactic we talked about a few weeks ago:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">&lt;</span> <span class="mi">1</span> <span class="bp"></span> <span class="mi">2</span> <span class="bp">&lt;</span> <span class="mi">3</span><span class="o">)</span> <span class="bp"></span> <span class="mi">3</span> <span class="bp">&lt;</span> <span class="mi">4</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">split</span>
  <span class="bp">-</span> <span class="n">split</span>
    <span class="bp">-</span> <span class="n">decide</span>
    <span class="bp">-</span> <span class="n">decide</span>
  <span class="bp">-</span> <span class="n">decide</span>
</code></pre></div>
<p>It's even better than lean 3 blocks because the blocks can be processed independently, so if one branch is incomplete you can also work on the other branch</p>



<a name="238203336"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238203336" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238203336">(May 10 2021 at 20:05)</a>:</h4>
<p>Well I implemented <code>split</code> ;-)</p>



<a name="238203504"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238203504" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238203504">(May 10 2021 at 20:06)</a>:</h4>
<p>actually this isn't too much harder than <code>split</code>. It's just a small variant on <code>focus</code> with a shorter name</p>



<a name="238205445"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238205445" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238205445">(May 10 2021 at 20:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238202984">said</a>:</p>
<blockquote>
<p>I implemented the block structuring tactic we talked about a few weeks ago:</p>
</blockquote>
<p>Nice work! Permission to upstream it?</p>



<a name="238205766"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238205766" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238205766">(May 10 2021 at 20:23)</a>:</h4>
<p>Absolutely</p>



<a name="238206085"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238206085" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238206085">(May 10 2021 at 20:25)</a>:</h4>
<p>What about not recompiling a finished block when working on later blocks? (dreaming is still allowed, right?)</p>



<a name="238206246"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238206246" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238206246">(May 10 2021 at 20:26)</a>:</h4>
<p>The lean 4 strategy is to make everything fast enough that this won't bother you <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="238206266"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238206266" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238206266">(May 10 2021 at 20:26)</a>:</h4>
<p>Sounds pretty good!</p>



<a name="238206325"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238206325" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238206325">(May 10 2021 at 20:27)</a>:</h4>
<p>It's seriously impressive to see how fast it can get through <code>Data.Nat.Basic</code></p>



<a name="238206925"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238206925" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238206925">(May 10 2021 at 20:31)</a>:</h4>
<p>Actually I'm not sure where caching is handled. It might need to be in the C++?</p>



<a name="238207087"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238207087" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Patrick Massot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238207087">(May 10 2021 at 20:32)</a>:</h4>
<p>Whatever the speed, we'll always manage to come up with slow tactics. We'll simply become more ambitious and brutal.</p>



<a name="238207132"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238207132" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238207132">(May 10 2021 at 20:32)</a>:</h4>
<p>Yes, that's a law of nature</p>



<a name="238209272"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238209272" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jannis Limperg <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238209272">(May 10 2021 at 20:47)</a>:</h4>
<p>I'm working on really slow automation already. :)</p>



<a name="238209273"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238209273" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238209273">(May 10 2021 at 20:47)</a>:</h4>
<p>Chris Hughes for his MSc thesis implemented a tactic which in the worst case scenario performs worse than any finite tower of exponentials</p>



<a name="238210896"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238210896" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238210896">(May 10 2021 at 20:58)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> do you know how that compares to ackermann? IIRC ackermann is also worse than that.</p>



<a name="238215240"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238215240" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238215240">(May 10 2021 at 21:29)</a>:</h4>
<p>Ackermann is faster growing. power tower is something like <code>A(n, 4)</code> compared to <code>A(n, n)</code> which is the ackermann function</p>



<a name="238215363"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238215363" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238215363">(May 10 2021 at 21:30)</a>:</h4>
<p>I don't know any algorithm that needs ackermann running time though</p>



<a name="238216788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238216788" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238216788">(May 10 2021 at 21:43)</a>:</h4>
<p><span class="user-mention" data-user-id="110044">@Chris Hughes</span> do you know the actual worst case running time of that word problem algorithm?</p>



<a name="238217367"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238217367" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238217367">(May 10 2021 at 21:48)</a>:</h4>
<p>I think it is just power tower and it never gets worse than that. I don't recall where I read that though.</p>



<a name="238217562"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238217562" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238217562">(May 10 2021 at 21:50)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span>  neither do I ;-). But I did come across the inverse ackermann as a complexity once. Which was quite funny. Also they casually mentioned that it's quite fair to consider it constant time, because for any input that fits into the universe you'd be limited to 4</p>



<a name="238218226"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238218226" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238218226">(May 10 2021 at 21:57)</a>:</h4>
<p>Right -- my son has certainly shown me algorithms with inverse Ackermann running time -- I thought these were normal in your world.</p>



<a name="238219857"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238219857" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joe Hendrix <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238219857">(May 10 2021 at 22:11)</a>:</h4>
<p><span class="user-mention" data-user-id="110049">@Mario Carneiro</span> I've only skimmed it myself, but found <a href="https://arxiv.org/pdf/1312.5686.pdf">this paper</a> interesting.  It provides a survey of different complexity classes and problems more complex than elementary.  It looks like Petri-nets and vector addition containment problems naturally give rise to problems with an Ackermann running time.</p>



<a name="238220049"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238220049" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Marc Huisinga <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238220049">(May 10 2021 at 22:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110038">Kevin Buzzard</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238218226">said</a>:</p>
<blockquote>
<p>Right -- my son has certainly shown me algorithms with inverse Ackermann running time -- I thought these were normal in your world.</p>
</blockquote>
<p>Union-find is fairly common</p>



<a name="238228221"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238228221" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238228221">(May 10 2021 at 23:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238202984">said</a>:</p>
<blockquote>
<p>I implemented the block structuring tactic we talked about a few weeks ago:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">&lt;</span> <span class="mi">1</span> <span class="bp"></span> <span class="mi">2</span> <span class="bp">&lt;</span> <span class="mi">3</span><span class="o">)</span> <span class="bp"></span> <span class="mi">3</span> <span class="bp">&lt;</span> <span class="mi">4</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">split</span>
  <span class="bp">-</span> <span class="n">split</span>
    <span class="bp">-</span> <span class="n">decide</span>
    <span class="bp">-</span> <span class="n">decide</span>
  <span class="bp">-</span> <span class="n">decide</span>
</code></pre></div>
<p>It's even better than lean 3 blocks because the blocks can be processed independently, so if one branch is incomplete you can also work on the other branch</p>
</blockquote>
<p>Any way to perform both splits at once? For example, the following:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="o">(</span><span class="mi">0</span> <span class="bp">&lt;</span> <span class="mi">1</span> <span class="bp"></span> <span class="mi">2</span> <span class="bp">&lt;</span> <span class="mi">3</span><span class="o">)</span> <span class="bp"></span> <span class="mi">3</span> <span class="bp">&lt;</span> <span class="mi">4</span> <span class="o">:=</span> <span class="kd">by</span>
  <span class="n">split</span> <span class="mi">3</span>
  <span class="bp">-</span> <span class="n">decide</span>
  <span class="bp">-</span> <span class="n">decide</span>
  <span class="bp">-</span> <span class="n">decide</span>
</code></pre></div>



<a name="238248677"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238248677" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238248677">(May 11 2021 at 04:04)</a>:</h4>
<p><span class="user-mention" data-user-id="315577">@Mac</span> What should <code>split 3</code> do with <code>a  b  c  d </code>?</p>



<a name="238249436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238249436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238249436">(May 11 2021 at 04:16)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span>, <span class="user-mention" data-user-id="221921">@Marc Huisinga</span> I was talking of union find, yes. You get the inverse ackermann by path compression or path halving, otherwise it's log. But that's also the only one I'm aware of. So I wouldn't say it's exactly common ;-).</p>



<a name="238251463"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238251463" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238251463">(May 11 2021 at 04:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238248677">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="315577">Mac</span> What should <code>split 3</code> do with <code>a  b  c  d </code>?</p>
</blockquote>
<p>The idea was that <code>split n</code> would preform <code>n-1</code> splits, creating <code>n</code> goals. So <code>split 3</code> on <code>a  b  c  d</code> would produce goals for<code>a</code>, <code>b</code>, and <code>c  d</code> (as <code></code> is right-associative).</p>



<a name="238251618"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238251618" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238251618">(May 11 2021 at 04:49)</a>:</h4>
<p><code>split 4</code> on <code>a  b  c  d </code>would produce 4 goals (<code>a</code>, <code>b</code>, <code>c</code>, and <code>d</code>).</p>



<a name="238251769"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238251769" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238251769">(May 11 2021 at 04:51)</a>:</h4>
<p>I think <code>rcases</code> is better for such things, because you can give it the exact pattern along which you want to split.</p>



<a name="238251903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238251903" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238251903">(May 11 2021 at 04:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> I mean, by that logic, is there really a need for <code>split</code> at all then? I think the idea here is to avoid the need to provide such patterns.</p>



<a name="238254369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238254369" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238254369">(May 11 2021 at 05:33)</a>:</h4>
<p>What does <code>split 4</code> do to <code>(a  b  c)  (d  (e  f)  g)</code>?</p>



<a name="238254417"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238254417" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238254417">(May 11 2021 at 05:34)</a>:</h4>
<p>But I guess <code>simp only [and_assoc]</code> and then <code>split n</code> would give useful behaviour.</p>



<a name="238254435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238254435" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Johan Commelin <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238254435">(May 11 2021 at 05:34)</a>:</h4>
<p>But if the parens are all over the place, I think <code>rcases</code> is a lot easier to wrap my head around. (At least for me.)</p>



<a name="238266427"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238266427" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mac <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238266427">(May 11 2021 at 07:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="112680">Johan Commelin</span> <a href="#narrow/stream/270676-lean4/topic/Mathlib.204/near/238254435">said</a>:</p>
<blockquote>
<p>But if the parens are all over the place, I think <code>rcases</code> is a lot easier to wrap my head around. (At least for me.)</p>
</blockquote>
<p>That's fair. However, for the normal form (where parens are not all over the place), I certainly think <code>split n</code> would be a useful tool.</p>



<a name="238292814"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238292814" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Franois G. Dorais <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238292814">(May 11 2021 at 11:46)</a>:</h4>
<p>I think it's time for a Mathlib 4 topic stream? (<span class="user-mention" data-user-id="110049">@Mario Carneiro</span> ?) This thread is getting confusing.</p>



<a name="238293002"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238293002" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Franois G. Dorais <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238293002">(May 11 2021 at 11:47)</a>:</h4>
<p><span class="user-mention" data-user-id="112680">@Johan Commelin</span> The <code>split</code> tactic applies to any inductive with one constructor. <code>And</code> is one of those but the others aren't associative, in general.</p>



<a name="238297013"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238297013" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Chris Hughes <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238297013">(May 11 2021 at 12:22)</a>:</h4>
<p>Maybe <code>split_and</code> is a better tactic, so you don't have to count how many <code>and</code>s you have and you don't split other inductives.</p>



<a name="238302888"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238302888" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238302888">(May 11 2021 at 13:04)</a>:</h4>
<p>I have just created a separate stream titled "mathlib4". Please subscribe yourselves if interested!</p>



<a name="238303519"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238303519" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238303519">(May 11 2021 at 13:08)</a>:</h4>
<p>I propose not moving any historical topics from this stream to that, but that we try to have future discussions about porting efforts over there.</p>



<a name="238327143"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238327143" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238327143">(May 11 2021 at 15:28)</a>:</h4>
<p>Eh, why is it a non-default stream? That will make it almost private for folks who missed the notification</p>



<a name="238342446"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238342446" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238342446">(May 11 2021 at 16:57)</a>:</h4>
<p>oh I wondered why it hadn't shown up. Why not kill it and create it again?</p>



<a name="238346743"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238346743" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238346743">(May 11 2021 at 17:00)</a>:</h4>
<p>I don't think zulip lets you do that. I've signed up everyone from the lean 4 stream, hopefully I didn't just ping everyone</p>



<a name="238350161"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238350161" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238350161">(May 11 2021 at 17:22)</a>:</h4>
<p>I'm afraid you did, including all of our course students <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="238392927"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Mathlib%204/near/238392927" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Mathlib.204.html#238392927">(May 11 2021 at 22:46)</a>:</h4>
<p>It's now a default stream for new users.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>