---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/mathlib.3Adelab.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html">mathlib:delab</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="234607673"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234607673" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234607673">(Apr 15 2021 at 02:40)</a>:</h4>
<p>There is still a lot of uncertainty about how to structure the textual port, but one high-level strategy that has been floated is to push heuristic delaboration as far as possible before manually touching files. I just wrote a toy demo of how this might work to start the discussion: <a href="https://gist.github.com/dselsam/bed905f85021dc4b41b971ad2c95a8c2">https://gist.github.com/dselsam/bed905f85021dc4b41b971ad2c95a8c2</a> Here is a tentative proposal:</p>
<ol>
<li>
<p>We implement delaborator round-tripping <a href="https://github.com/leanprover/lean4/issues/368">https://github.com/leanprover/lean4/issues/368</a> . At this point, we should be able to (in principle) delaborate mathlib into large and unreadable files.</p>
</li>
<li>
<p>We iterate the following:</p>
<ul>
<li>find an ostensibly-tactic-compressible part of a delaborated proof (e.g. by simp, ring, etc.)</li>
<li>implement a heuristic delaboration rule for it (implementing the tactics as needed)</li>
<li>rerun the delaborator</li>
</ul>
</li>
<li>
<p>Baseless speculation is that we can produce reasonable <code>.lean</code> files for the entire library this way with (say) a few hundred auto-placed <code>sorry</code>s for large proof-terms that can't be compressed, before we reach diminishing returns.</p>
</li>
<li>
<p>We fill in the <code>sorry</code>s manually, looking at the old lean3 tactic scripts for guidance.</p>
</li>
<li>
<p>Once the textual port is complete, we do a manual pass to use lean4 constructions instead of auto-ported lean3 constructions. For example, lean3 definitions that use the equation compiler will translate as definitions in terms of <code>foo._main</code>, which will be defined by <code>brec_on</code>, and there will be a ton of explicit equation lemmas. These will all start out in the delaborated <code>.lean</code> files. So we delete all this cruft, and write the definition using the equation compiler, consulting the lean3 definitions as necessary. I don't expect this kind of change to propagate very far, since most things will be def-eq.</p>
</li>
</ol>
<p>Thoughts?</p>



<a name="234608123"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608123" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608123">(Apr 15 2021 at 02:47)</a>:</h4>
<p>The example for 5 doesn't sound like it needs to be a manual pass</p>



<a name="234608219"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608219" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608219">(Apr 15 2021 at 02:48)</a>:</h4>
<p>We have visibility into the fact that the lean 3 definition was done with the equation compiler so we can use it</p>



<a name="234608405"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608405" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608405">(Apr 15 2021 at 02:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234608219">said</a>:</p>
<blockquote>
<p>We have visibility into the fact that the lean 3 definition was done with the equation compiler so we can use it</p>
</blockquote>
<p>True, we could separately export from lean3 the fully elaborated equations, and then have a special equations-delaborator on the lean4 side</p>



<a name="234608514"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608514" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608514">(Apr 15 2021 at 02:53)</a>:</h4>
<p>But I am not sure if there are enough uses to merit this though.</p>



<a name="234608525"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608525" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608525">(Apr 15 2021 at 02:53)</a>:</h4>
<p>There's another variation on this plan, where we put in enough work to extract a lean 3 AST and then map it to reasonable substitutes in lean 4. It will look good but most likely will be slightly broken all over the place; but it seems like a better starting point for manual editing</p>



<a name="234608682"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608682" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608682">(Apr 15 2021 at 02:55)</a>:</h4>
<p>Yes, a different and somewhat compatible high-level strategy is to export parsed lean3 tactic scripts, automate some of the work of making it lean4 syntax (e.g. lambda <code>,</code> -&gt; <code>=&gt;</code>), and then manually tweaking to make it type-check. As you said it will be slightly broken everywhere though. With the delab approach the <code>sorry</code> damage will be controlled and localized.</p>



<a name="234608760"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608760" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608760">(Apr 15 2021 at 02:56)</a>:</h4>
<p>We can definitely do this for the <code>sorry</code> stage, but I am hoping there will be few enough sorries that it is easier to just copy-paste and manually tweak the syntax.</p>



<a name="234608818"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608818" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608818">(Apr 15 2021 at 02:57)</a>:</h4>
<p>I'm not as positive about the outlook of step 2</p>



<a name="234608830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608830">(Apr 15 2021 at 02:58)</a>:</h4>
<p>it will be difficult to get the tactics to actually reproduce the proof terms we want to compress</p>



<a name="234608908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608908" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608908">(Apr 15 2021 at 02:58)</a>:</h4>
<p>A lower bar is producing reasonably short proof terms that type-check, even if they are slightly weird and not how a human would have written it.</p>



<a name="234608917"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608917" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608917">(Apr 15 2021 at 02:59)</a>:</h4>
<p>I am not so worried about <code>simp</code> and <code>ring</code> so much as the structural tactics. The elaborator differences are going to be a huge pain</p>



<a name="234608946"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234608946" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234608946">(Apr 15 2021 at 02:59)</a>:</h4>
<p>What do you mean by a structural tactic?</p>



<a name="234609010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609010" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609010">(Apr 15 2021 at 03:00)</a>:</h4>
<p><code>change</code>, <code>cases</code>, <code>induction</code>, <code>refine</code>, <code>apply</code></p>



<a name="234609027"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609027" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609027">(Apr 15 2021 at 03:00)</a>:</h4>
<p>These are tactics that already exist but don't do exactly the same thing</p>



<a name="234609075"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609075" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609075">(Apr 15 2021 at 03:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234608818">said</a>:</p>
<blockquote>
<p>I'm not as positive about the outlook of step 2</p>
</blockquote>
<p>Also, if I were positive, I wouldn't even bother posting :) I am not at all positive, and I am hoping people share their concerns about potential roadblocks.</p>



<a name="234609138"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609138" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609138">(Apr 15 2021 at 03:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234609027">said</a>:</p>
<blockquote>
<p>These are tactics that already exist but don't do exactly the same thing</p>
</blockquote>
<p>This is why heuristic delaboration is likely to be more reliable than heuristic translation -- it doesn't matter what the lean3 tactics did.</p>



<a name="234609142"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609142" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609142">(Apr 15 2021 at 03:01)</a>:</h4>
<p>specifically, "a few hundred <code>sorry</code>s" sounds like an extremely high bar</p>



<a name="234609155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609155" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609155">(Apr 15 2021 at 03:01)</a>:</h4>
<p>I'm expecting more like ten thousand sorrys</p>



<a name="234609314"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609314" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609314">(Apr 15 2021 at 03:03)</a>:</h4>
<p>At what granularity are you expecting? I mean, will we be able to stick <code>sorry</code>s deep inside otherwise OK proof terms, or will we effectively need to <code>sorry</code> out entire proofs?</p>



<a name="234609322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609322">(Apr 15 2021 at 03:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="230999">Daniel Selsam</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234609138">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234609027">said</a>:</p>
<blockquote>
<p>These are tactics that already exist but don't do exactly the same thing</p>
</blockquote>
<p>This is why heuristic delaboration is likely to be more reliable than heuristic translation -- it doesn't matter what the lean3 tactics did.</p>
</blockquote>
<p>Yes, but the issue with delaboration is that it's mostly a one way street - you can't easily reconstruct the original proof and will have to consult the lean 3 proof heavily anyway. I doubt the term will even help that much beyond being able to act as a kind of long winded version of <code>sorry</code></p>



<a name="234609420"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609420" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609420">(Apr 15 2021 at 03:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="230999">Daniel Selsam</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234609314">said</a>:</p>
<blockquote>
<p>At what granularity are you expecting? I mean, will we be able to stick <code>sorry</code>s deep inside otherwise OK proof terms, or will we effectively need to <code>sorry</code> out entire proofs?</p>
</blockquote>
<p>If the bar is "terms that are too big even after iterating step 2 to fixpoint" I would guess there will be one in almost every proof</p>



<a name="234609466"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609466" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609466">(Apr 15 2021 at 03:05)</a>:</h4>
<p>AST translation is much more likely to be helpful to human editors</p>



<a name="234609550"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609550" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609550">(Apr 15 2021 at 03:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234609322">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="230999">Daniel Selsam</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234609138">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234609027">said</a>:</p>
<blockquote>
<p>These are tactics that already exist but don't do exactly the same thing</p>
</blockquote>
<p>This is why heuristic delaboration is likely to be more reliable than heuristic translation -- it doesn't matter what the lean3 tactics did.</p>
</blockquote>
<p>Yes, but the issue with delaboration is that it's mostly a one way street - you can't easily reconstruct the original proof and will have to consult the lean 3 proof heavily anyway. I doubt the term will even help that much beyond being able to act as a kind of long winded version of <code>sorry</code></p>
</blockquote>
<p>I agree that this is a risk. Specifically, that even if it delaborates to something short enough, that when it comes time to refactor, the proof is still so unconventional that people just look to the old lean3 version anyway.</p>



<a name="234609561"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609561" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609561">(Apr 15 2021 at 03:06)</a>:</h4>
<p>I would probably do an AST translation and then splitscreen with the lean 3 proof to see intermediate states so I can repair the broken bits</p>



<a name="234609566"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609566" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609566">(Apr 15 2021 at 03:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234609466">said</a>:</p>
<blockquote>
<p>AST translation is much more likely to be helpful to human editors</p>
</blockquote>
<p>I agree.</p>



<a name="234609683"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609683" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609683">(Apr 15 2021 at 03:08)</a>:</h4>
<p>So it really seems to hinge on how dense the <code>sorry</code>s will be after iterating (2), and how easy it will be for a human to align a <code>sorry</code> within a delaborated proof with the corresponding part of the corresponding lean3 tactic script.</p>



<a name="234609729"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609729" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609729">(Apr 15 2021 at 03:09)</a>:</h4>
<p>We can certainly do tests for that</p>



<a name="234609820"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609820" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609820">(Apr 15 2021 at 03:10)</a>:</h4>
<p>This can't really start until we have most mathlib tactics first though</p>



<a name="234609843"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609843" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609843">(Apr 15 2021 at 03:10)</a>:</h4>
<p>It will take a while to develop the delaborator to test these hypotheses though. I am not even sure how long the initial (1) step will take -- probably easy for Sebastian but I'll need to get up to speed on a good chunk of the frontend first.</p>



<a name="234609902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609902">(Apr 15 2021 at 03:11)</a>:</h4>
<p>step 1 sounds a bit like an open research question <span aria-label="oops" class="emoji emoji-1f643" role="img" title="oops">:oops:</span></p>



<a name="234609912"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234609912" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234609912">(Apr 15 2021 at 03:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234609820">said</a>:</p>
<blockquote>
<p>This can't really start until we have most mathlib tactics first though</p>
</blockquote>
<p>We don't need all the tactics to do the experiment. We already have analogues of simp, cases, and induction, and we can easily detect goals that could be proven by a future norm_num, ring, or linarith (without needing them to be implemented yet)</p>



<a name="234610050"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610050" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610050">(Apr 15 2021 at 03:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234609902">said</a>:</p>
<blockquote>
<p>step 1 sounds a bit like an open research question <span aria-label="oops" class="emoji emoji-1f643" role="img" title="oops">:oops:</span></p>
</blockquote>
<p>Maybe a research question to prove it works, but we may be able to get very far just iterating some form of:</p>
<p>- try delab<br>
  - detect error message<br>
  - add more detail to the subterm with the message</p>



<a name="234610053"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610053" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610053">(Apr 15 2021 at 03:13)</a>:</h4>
<p>There are a lot of tactics other than those though. I'm thinking of the other 90% of tactics that do silly little things like <code>contradiction</code>, <code>existsi</code>, <code>constructor</code>, <code>choose</code></p>



<a name="234610155"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610155" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610155">(Apr 15 2021 at 03:14)</a>:</h4>
<p>If you look in logic.basic, nat.basic, and list.basic you won't find much <code>linarith</code> but quite a bit of <code>simp</code>, lots of <code>induction</code> and a bit of <code>cases</code> and <code>rcases</code></p>



<a name="234610156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610156">(Apr 15 2021 at 03:14)</a>:</h4>
<p>Even without those tactics implemented, the proofs will <code>delab</code> to simple and concise things. But that kind of little tactic shouldn't be hard to implement.</p>



<a name="234610214"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610214" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610214">(Apr 15 2021 at 03:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234610155">said</a>:</p>
<blockquote>
<p>If you look in logic.basic, nat.basic, and list.basic you won't find much <code>linarith</code> but quite a bit of <code>simp</code>, lots of <code>induction</code> and a bit of <code>cases</code> and <code>rcases</code></p>
</blockquote>
<p>This is a good starting point to experiment with. We could even start experimenting with (2) before doing (1), since this kind of basic thing will probably work with <code>pp.default</code>.</p>



<a name="234610259"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610259" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610259">(Apr 15 2021 at 03:16)</a>:</h4>
<p>I'll try those three files tomorrow.</p>



<a name="234610328"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610328" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610328">(Apr 15 2021 at 03:17)</a>:</h4>
<p>plus the lemmas in nat.basic (or at least init.data.nat.lemmas) are actually kind of important, I seem to run across a half dozen of them when I try to prove anything at all (see findLeast thread)</p>



<a name="234610354"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610354" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610354">(Apr 15 2021 at 03:17)</a>:</h4>
<p>so some of them will need to end up in the mathlib prelude most likely</p>



<a name="234610428"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610428" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610428">(Apr 15 2021 at 03:18)</a>:</h4>
<p>Will the mathlib prelude be a stand-alone lean4 repo with no mathport dependency?</p>



<a name="234610444"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610444" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610444">(Apr 15 2021 at 03:18)</a>:</h4>
<p>that's the plan</p>



<a name="234610506"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610506" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610506">(Apr 15 2021 at 03:19)</a>:</h4>
<p>And the goal is mainly to replicate <code>src/tactic</code> right? As opposed to starting a separate bottom-up porting process.</p>



<a name="234610509"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610509" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610509">(Apr 15 2021 at 03:19)</a>:</h4>
<p>I need to understand better how compilation and dependencies work in lean 4 but I think we need tactics to be in a separate project for them to be compiled for use in mathlib</p>



<a name="234610603"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610603" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610603">(Apr 15 2021 at 03:20)</a>:</h4>
<p>yes, it's only for tactic stuff and supporting lemmas, like lean 3 core (which is a bit bigger than lean 4 core is right now) + mathlib <code>tactic/</code></p>



<a name="234610615"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234610615" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234610615">(Apr 15 2021 at 03:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234610509">said</a>:</p>
<blockquote>
<p>I need to understand better how compilation and dependencies work in lean 4 but I think we need tactics to be in a separate project for them to be compiled for use in mathlib</p>
</blockquote>
<p>I believe this is currently the case, yes.</p>



<a name="234617370"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234617370" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234617370">(Apr 15 2021 at 04:58)</a>:</h4>
<p>Is that planned to change?</p>



<a name="234629902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234629902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234629902">(Apr 15 2021 at 07:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="230999">Daniel Selsam</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234607673">said</a>:</p>
<blockquote>
<p>[...] definitions in terms of <code>foo._main</code>, which will be defined by <code>brec_on</code> [...]</p>
</blockquote>
<p>Delaborating proofs is one challenge, and it's good it's being worked on.  But I believe that these auxiliary definitions pose a much bigger issue in automatic porting because they are used extensively in mathlib.  As you've already noticed, there are auxiliary definitions created by Lean, such as <code>_proof_*</code> or <code>_match_*</code>, etc.  But there's also lots of automatically generated code from mathlib:</p>
<ul>
<li><code>@[to_additive]</code> duplicates every definition it is tagged with</li>
<li><code>@[ext]</code>, <code>@[mk_iff]</code>, <code>@[simps]</code>, etc., generate auxiliary lemmas</li>
<li><code>@[derive]</code> also exists in Lean 3</li>
</ul>
<p>And these are just the common ones.  If the automatically ported file contains the expanded versions of these, then the task is not "fill in a few sorrys", but rather "delete it and port the Lean 3 version manually".</p>



<a name="234630147"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234630147" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234630147">(Apr 15 2021 at 07:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234617370">said</a>:</p>
<blockquote>
<p>Is that planned to change?</p>
</blockquote>
<p>No, because a package seems like a sensible code unit to generate a shared library from. But maybe people are confused about what the implications of "separate packages" are - there is absolutely no reason that you couldn't put multiple packages into the same repo. It's just that leanpkg hasn't been extended in such a way yet.</p>



<a name="234630343"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234630343" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234630343">(Apr 15 2021 at 07:32)</a>:</h4>
<p>Well, separate packages might not be necessary if we could JIT compile Lean programs, but those are dreams of the future. Shared libraries we can produce right now.</p>



<a name="234630374"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234630374" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234630374">(Apr 15 2021 at 07:32)</a>:</h4>
<p>Now, I don't think that that is necessarily a bad strategy.  Let's say we can port all of mathlib to Lean 4 automatically, even if every proof is sorry and all <code>to_additive</code> are expanded, etc.  Then at least we can parallelize the manual porting process afterwards.  Because it becomes possible to replace an ugly automatically-ported Lean 4 file by a manually ported version, and have CI check that that everything still builds.</p>



<a name="234630460"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234630460" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234630460">(Apr 15 2021 at 07:33)</a>:</h4>
<p>Also pinging <span class="user-mention" data-user-id="399706">@Aurélien Saue</span>, who has been experimenting with a similar automatic porting tool.</p>



<a name="234630864"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234630864" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234630864">(Apr 15 2021 at 07:37)</a>:</h4>
<blockquote>
<p>I don't expect this kind of change to propagate very far, since most things will be def-eq.</p>
</blockquote>
<p>If you write <code>def foo := foo._main</code> manually instead of <code>def foo := 42</code>, this changes several things, even though they are definitionally equal:</p>
<ul>
<li><code>rw foo</code> produces a different result (and also <code>simp</code>, <code>delta</code>, etc.).  This is because the equational lemmas are different.</li>
<li>Unification behaves differently, exposing <code>brec_on</code>.  If you use pattern matching, Lean will use smart unfolding instead.</li>
</ul>



<a name="234643443"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234643443" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234643443">(Apr 15 2021 at 09:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234630147">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234617370">said</a>:</p>
<blockquote>
<p>Is that planned to change?</p>
</blockquote>
<p>No, because a package seems like a sensible code unit to generate a shared library from. But maybe people are confused about what the implications of "separate packages" are - there is absolutely no reason that you couldn't put multiple packages into the same repo. It's just that leanpkg hasn't been extended in such a way yet.</p>
</blockquote>
<p>But what about our tactics that, e.g. rely on part of the category theory library before you can even write them, and then get used in later parts of the category theory library? e.g. the recent <code>elementwise</code> I wrote needs to know about particular lemmas.</p>



<a name="234643933"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234643933" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234643933">(Apr 15 2021 at 09:28)</a>:</h4>
<p>I believe we can still use tactics immediately in the same file.  It's just they will be interpreted (as slow as in Lean 3).  They only need to be in a different project if we want them to be compiled.</p>



<a name="234644378"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234644378" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234644378">(Apr 15 2021 at 09:31)</a>:</h4>
<p>I see. I guess we'll actually adapt to that pretty easily. If you look at the current import graph for mathlib there is a very obvious horizontal line, before which there is no interesting maths, and after which there are no substantial tactics. We can just split mathlib on that line.</p>



<a name="234644524"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234644524" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234644524">(Apr 15 2021 at 09:32)</a>:</h4>
<p>The Lean 4 interpreter is actually quite a bit faster than in Lean 3 IIRC. Also, compilation only matters for tactics that do significant work themselves. If most time is spent in a nested <code>simp</code>, it will use the native code for that anyway.</p>



<a name="234647098"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234647098" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Aurélien Saue <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234647098">(Apr 15 2021 at 09:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234630374">said</a>:</p>
<blockquote>
<p>Now, I don't think that that is necessarily a bad strategy.  Let's say we can port all of mathlib to Lean 4 automatically, even if every proof is sorry and all <code>to_additive</code> are expanded, etc.  Then at least we can parallelize the manual porting process afterwards.  Because it becomes possible to replace an ugly automatically-ported Lean 4 file by a manually ported version, and have CI check that that everything still builds.</p>
</blockquote>
<p>So that has been the approach I have been trying to explore, and I think it would be a good first step. After time, these sorries would be replaced by proper proofs but at least we have a buildable first version. For it to be comfortable to use for users we could also include all the Lean3 proofs as comments after the <code>sorry</code> for them not to have to look up the Lean3 files all the time.</p>



<a name="234647567"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234647567" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Aurélien Saue <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234647567">(Apr 15 2021 at 09:57)</a>:</h4>
<p>For step one, is the idea to delaborate from the mathport generated <code>olean</code> files?</p>



<a name="234651850"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234651850" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Morrison <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234651850">(Apr 15 2021 at 10:33)</a>:</h4>
<p>Regarding delaborating from mathport oleans: is it plausible for us to modify lean3 tactics so that they insert "wrappers" into the proof terms, which essentially serve as instructions for a mathport specific delaboration step?</p>



<a name="234653204"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234653204" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234653204">(Apr 15 2021 at 10:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234630374">said</a>:</p>
<blockquote>
<p>Now, I don't think that that is necessarily a bad strategy.  Let's say we can port all of mathlib to Lean 4 automatically, even if every proof is sorry and all <code>to_additive</code> are expanded, etc.  Then at least we can parallelize the manual porting process afterwards.  Because it becomes possible to replace an ugly automatically-ported Lean 4 file by a manually ported version, and have CI check that that everything still builds.</p>
</blockquote>
<p>So you would effectively use the delaborator not for its source output to iterate upon but to move from Lean 4-compatible Lean 3 .olean files to equivalent ones that conform to the output of native Lean 4 declarations, e.g. regarding equations, is that right?</p>



<a name="234658070"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234658070" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234658070">(Apr 15 2021 at 11:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234653204">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234630374">said</a>:<br>
So you would effectively use the delaborator not for its source output to iterate upon [...]</p>
</blockquote>
<p>Yes.  It would still produce source output, but the output is only/mostly there to make mathlib4 build while we port files individually.  The advantage of using Lean 4 source files instead of converted olean files is that 1) they are producing the native equation lemmas, etc., and 2) that we can modify them during porting.<br>
For example the category theory library extensively uses automation that is integrated into the definitions.  There is lots of auto_params with custom tactics.  Say we begin by changing these auto_param tactics to Lean 4 equivalents.  This will certainly break downstream files.  But you can't start with the downstream files either, because doing category theory without automation is pointless.</p>



<a name="234658363"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234658363" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234658363">(Apr 15 2021 at 11:32)</a>:</h4>
<p>There are other parts of mathlib that are much easier to port.  For example, I fully expect the delaboration-based porting tool to produce a usable version of <code>logic.basic</code>.</p>



<a name="234661235"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234661235" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234661235">(Apr 15 2021 at 11:55)</a>:</h4>
<p>I see, makes sense to me. But that also means that the delaborator output wouldn't have to be "great", i.e. using the current state with "try the default options; if it doesn't round-trip, use <code>pp.all</code>" could be sufficient (assuming there are no pp.all bugs). It could still be improved in parallel to manual porting if you do want to reuse its output for such files.</p>



<a name="234667202"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234667202" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Aurélien Saue <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234667202">(Apr 15 2021 at 12:39)</a>:</h4>
<p>I just want to tell you all that I am still a newbie but if during this process you encounter some task that does not require too much of an in-depth knowledge and that you would like to delegate, I would be happy to give it my best try :)</p>



<a name="234699978"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234699978" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234699978">(Apr 15 2021 at 15:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234630864">said</a>:</p>
<blockquote>
<p>If you write <code>def foo := foo._main</code> manually instead of <code>def foo := 42</code>, this changes several things, even though they are definitionally equal:</p>
<ul>
<li><code>rw foo</code> produces a different result (and also <code>simp</code>, <code>delta</code>, etc.).  This is because the equational lemmas are different.</li>
</ul>
</blockquote>
<p>Yes but this one is at the tactic level, which wouldn't matter if the downstream proofs are generated by the delaborator.</p>
<blockquote>
<ul>
<li>Unification behaves differently, exposing <code>brec_on</code>.  If you use pattern matching, Lean will use smart unfolding instead.</li>
</ul>
</blockquote>
<p>Actually, when importing mathlib binaries we still get smart unfolding, because <code>foo._sunfold</code> is generated and ported as well and Lean4 just checks for the name. The smart unfolding behavior is a little different between lean3 and lean4 (in particular, there is no smart unfolding anymore for non-recursive definitions), but I think most recursive smart unfolds will be the same.</p>



<a name="234700746"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234700746" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234700746">(Apr 15 2021 at 15:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110087">Scott Morrison</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234651850">said</a>:</p>
<blockquote>
<p>Regarding delaborating from mathport oleans: is it plausible for us to modify lean3 tactics so that they insert "wrappers" into the proof terms, which essentially serve as instructions for a mathport specific delaboration step?</p>
</blockquote>
<p>Yes. We could create an inductive type <code>MyExtraInfoForLean4</code> and define a tagging function:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">axiom</span> <span class="n">MyExtraInfoForLean4</span> <span class="o">:</span> <span class="kt">Type</span>
<span class="kd">def</span> <span class="n">id_tag4</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span> <span class="o">(</span><span class="n">tag</span> <span class="o">:</span> <span class="n">MyExtraInfoForLean4</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="o">:=</span> <span class="n">x</span>
</code></pre></div>
<p>Even if <code>MyExtraLean4Info</code> uses strings and names and other types that don't align perfectly, mathport can still decode concrete values into the corresponding Lean4 values. It already does this for <code>auto_param</code> names.</p>



<a name="234701075"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234701075" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234701075">(Apr 15 2021 at 15:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="230999">Daniel Selsam</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234699978">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="110043">Gabriel Ebner</span> <a href="#narrow/stream/270676-lean4/topic/mathlib.3Adelab/near/234630864">said</a>:</p>
<blockquote>
<p>If you write <code>def foo := foo._main</code> manually instead of <code>def foo := 42</code>, this changes several things, even though they are definitionally equal:</p>
<ul>
<li><code>rw foo</code> produces a different result (and also <code>simp</code>, <code>delta</code>, etc.).  This is because the equational lemmas are different.</li>
</ul>
</blockquote>
<p>Yes but this one is at the tactic level, which wouldn't matter if the downstream proofs are generated by the delaborator.</p>
</blockquote>
<p>In that case the delaborated files can't be used as is and still need to be cleaned up in an API-changing way.  Which breaks all the nicely delaborated proofs afterwards.</p>



<a name="234702012"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/mathlib%3Adelab/near/234702012" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Selsam <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/mathlib.3Adelab.html#234702012">(Apr 15 2021 at 15:48)</a>:</h4>
<p>We can also get rid of the <code>foo._main</code>s during mathport, and fuse them with <code>foo</code>.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>