---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/type.20class.20inference.20looping.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html">type class inference looping</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="319109335"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319109335" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319109335">(Jan 03 2023 at 00:18)</a>:</h4>
<p><span class="user-mention" data-user-id="260507">@Heather Macbeth</span> ran into an issue in the mathlib port with typeclass inference looping. I minimised it, and it's quite surprising: if you don't tell Lean <code>alpha</code> explicitly, by the time it's figured out you mean <code>alpha</code> it seems to have forgotten that <code>alpha</code> is a MonoidWithZero.</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">universe</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span>

<span class="kd">class</span> <span class="n">Zero</span> <span class="o">(</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">zero</span> <span class="o">:</span> <span class="n">Œ±</span>

<span class="kd">instance</span> <span class="n">Zero.toOfNat0</span> <span class="o">{</span><span class="n">Œ±</span><span class="o">}</span> <span class="o">[</span><span class="n">Zero</span> <span class="n">Œ±</span><span class="o">]</span> <span class="o">:</span> <span class="n">OfNat</span> <span class="n">Œ±</span> <span class="o">(</span><span class="n">nat_lit</span> <span class="mi">0</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">ofNat</span> <span class="o">:=</span> <span class="o">‚Äπ</span><span class="n">Zero</span> <span class="n">Œ±</span><span class="o">‚Ä∫</span><span class="bp">.</span><span class="mi">1</span>

<span class="kd">instance</span> <span class="n">Zero.ofOfNat0</span> <span class="o">{</span><span class="n">Œ±</span><span class="o">}</span> <span class="o">[</span><span class="n">OfNat</span> <span class="n">Œ±</span> <span class="o">(</span><span class="n">nat_lit</span> <span class="mi">0</span><span class="o">)]</span> <span class="o">:</span> <span class="n">Zero</span> <span class="n">Œ±</span> <span class="n">where</span>
  <span class="n">zero</span> <span class="o">:=</span> <span class="mi">0</span>

<span class="kd">class</span> <span class="n">One</span> <span class="o">(</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">one</span> <span class="o">:</span> <span class="n">Œ±</span>

<span class="kd">instance</span> <span class="n">One.toOfNat1</span> <span class="o">{</span><span class="n">Œ±</span><span class="o">}</span> <span class="o">[</span><span class="n">One</span> <span class="n">Œ±</span><span class="o">]</span> <span class="o">:</span> <span class="n">OfNat</span> <span class="n">Œ±</span> <span class="o">(</span><span class="n">nat_lit</span> <span class="mi">1</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">ofNat</span> <span class="o">:=</span> <span class="o">‚Äπ</span><span class="n">One</span> <span class="n">Œ±</span><span class="o">‚Ä∫</span><span class="bp">.</span><span class="mi">1</span>

<span class="kd">instance</span> <span class="n">One.ofOfNat1</span> <span class="o">{</span><span class="n">Œ±</span><span class="o">}</span> <span class="o">[</span><span class="n">OfNat</span> <span class="n">Œ±</span> <span class="o">(</span><span class="n">nat_lit</span> <span class="mi">1</span><span class="o">)]</span> <span class="o">:</span> <span class="n">One</span> <span class="n">Œ±</span> <span class="n">where</span>
  <span class="n">one</span> <span class="o">:=</span> <span class="mi">1</span>

<span class="kd">class</span> <span class="n">MulZeroClass</span> <span class="o">(</span><span class="n">M‚ÇÄ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">Mul</span> <span class="n">M‚ÇÄ</span><span class="o">,</span> <span class="n">Zero</span> <span class="n">M‚ÇÄ</span> <span class="n">where</span>
  <span class="n">zero_mul</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">a</span> <span class="o">:</span> <span class="n">M‚ÇÄ</span><span class="o">,</span> <span class="mi">0</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">=</span> <span class="mi">0</span>
  <span class="n">mul_zero</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">a</span> <span class="o">:</span> <span class="n">M‚ÇÄ</span><span class="o">,</span> <span class="n">a</span> <span class="bp">*</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span>

<span class="kd">class</span> <span class="n">Semigroup</span> <span class="o">(</span><span class="n">G</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">Mul</span> <span class="n">G</span> <span class="n">where</span>
  <span class="n">mul_assoc</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">G</span><span class="o">,</span> <span class="n">a</span> <span class="bp">*</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">c</span> <span class="bp">=</span> <span class="n">a</span> <span class="bp">*</span> <span class="o">(</span><span class="n">b</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span>

<span class="kd">class</span> <span class="n">SemigroupWithZero</span> <span class="o">(</span><span class="n">S‚ÇÄ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">Semigroup</span> <span class="n">S‚ÇÄ</span><span class="o">,</span> <span class="n">MulZeroClass</span> <span class="n">S‚ÇÄ</span>

<span class="kd">class</span> <span class="n">MulOneClass</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">One</span> <span class="n">M</span><span class="o">,</span> <span class="n">Mul</span> <span class="n">M</span> <span class="n">where</span>
  <span class="n">one_mul</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">a</span> <span class="o">:</span> <span class="n">M</span><span class="o">,</span> <span class="mi">1</span> <span class="bp">*</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a</span>
  <span class="n">mul_one</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">a</span> <span class="o">:</span> <span class="n">M</span><span class="o">,</span> <span class="n">a</span> <span class="bp">*</span> <span class="mi">1</span> <span class="bp">=</span> <span class="n">a</span>

<span class="kd">class</span> <span class="n">MulZeroOneClass</span> <span class="o">(</span><span class="n">M‚ÇÄ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">MulOneClass</span> <span class="n">M‚ÇÄ</span><span class="o">,</span> <span class="n">MulZeroClass</span> <span class="n">M‚ÇÄ</span>

<span class="kd">class</span> <span class="n">Monoid</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">Semigroup</span> <span class="n">M</span><span class="o">,</span> <span class="n">MulOneClass</span> <span class="n">M</span> <span class="n">where</span>

<span class="kd">class</span> <span class="n">MonoidWithZero</span> <span class="o">(</span><span class="n">M‚ÇÄ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">Monoid</span> <span class="n">M‚ÇÄ</span><span class="o">,</span> <span class="n">MulZeroOneClass</span> <span class="n">M‚ÇÄ</span><span class="o">,</span> <span class="n">SemigroupWithZero</span> <span class="n">M‚ÇÄ</span>

<span class="kd">class</span> <span class="n">SMul</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">)</span> <span class="o">(</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">smul</span> <span class="o">:</span> <span class="n">M</span> <span class="bp">‚Üí</span> <span class="n">Œ±</span> <span class="bp">‚Üí</span> <span class="n">Œ±</span>

<span class="kd">class</span> <span class="n">HSMul</span> <span class="o">(</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">(</span><span class="n">Œ≤</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">)</span> <span class="o">(</span><span class="n">Œ≥</span> <span class="o">:</span> <span class="n">outParam</span> <span class="o">(</span><span class="kt">Type</span> <span class="n">w</span><span class="o">))</span> <span class="n">where</span>
  <span class="n">hSMul</span> <span class="o">:</span> <span class="n">Œ±</span> <span class="bp">‚Üí</span> <span class="n">Œ≤</span> <span class="bp">‚Üí</span> <span class="n">Œ≥</span>

<span class="kd">instance</span> <span class="n">instHSMul</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">)</span> <span class="o">(</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">)</span> <span class="o">[</span><span class="n">SMul</span> <span class="n">M</span> <span class="n">Œ±</span><span class="o">]</span> <span class="o">:</span> <span class="n">HSMul</span> <span class="n">M</span> <span class="n">Œ±</span> <span class="n">Œ±</span> <span class="n">where</span>
  <span class="n">hSMul</span> <span class="o">:=</span> <span class="n">SMul.smul</span>

<span class="kd">infixr</span><span class="o">:</span><span class="mi">73</span> <span class="s2">" ‚Ä¢ "</span> <span class="bp">=&gt;</span> <span class="n">HSMul.hSMul</span>

<span class="kd">class</span> <span class="n">MulAction</span> <span class="o">(</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">)</span> <span class="o">(</span><span class="n">Œ≤</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">)</span> <span class="o">[</span><span class="n">Monoid</span> <span class="n">Œ±</span><span class="o">]</span> <span class="kd">extends</span> <span class="n">SMul</span> <span class="n">Œ±</span> <span class="n">Œ≤</span> <span class="n">where</span>
  <span class="kn">protected</span> <span class="n">one_smul</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Œ≤</span><span class="o">,</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="n">Œ±</span><span class="o">)</span> <span class="bp">‚Ä¢</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">b</span>
  <span class="n">mul_smul</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="o">(</span><span class="n">x</span> <span class="n">y</span> <span class="o">:</span> <span class="n">Œ±</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">Œ≤</span><span class="o">),</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">)</span> <span class="bp">‚Ä¢</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">x</span> <span class="bp">‚Ä¢</span> <span class="n">y</span> <span class="bp">‚Ä¢</span> <span class="n">b</span>

<span class="kd">variable</span> <span class="o">(</span><span class="n">R</span> <span class="n">M</span><span class="o">)</span>

<span class="kd">class</span> <span class="n">MulActionWithZero</span> <span class="o">[</span><span class="n">MonoidWithZero</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">Zero</span> <span class="n">M</span><span class="o">]</span> <span class="kd">extends</span> <span class="n">MulAction</span> <span class="n">R</span> <span class="n">M</span> <span class="n">where</span>
  <span class="n">smul_zero</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">r</span> <span class="o">:</span> <span class="n">R</span><span class="o">,</span> <span class="n">r</span> <span class="bp">‚Ä¢</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">M</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span>
  <span class="n">zero_smul</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">m</span> <span class="o">:</span> <span class="n">M</span><span class="o">,</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="bp">‚Ä¢</span> <span class="n">m</span> <span class="bp">=</span> <span class="mi">0</span>

<span class="kd">class</span> <span class="n">SMulZeroClass</span> <span class="o">(</span><span class="n">M</span> <span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">_</span><span class="o">)</span> <span class="o">[</span><span class="n">Zero</span> <span class="n">A</span><span class="o">]</span> <span class="kd">extends</span> <span class="n">SMul</span> <span class="n">M</span> <span class="n">A</span> <span class="n">where</span>
  <span class="n">smul_zero</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">a</span> <span class="o">:</span> <span class="n">M</span><span class="o">,</span> <span class="n">a</span> <span class="bp">‚Ä¢</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span>

<span class="kd">class</span> <span class="n">SMulWithZero</span> <span class="o">[</span><span class="n">Zero</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">Zero</span> <span class="n">M</span><span class="o">]</span> <span class="kd">extends</span> <span class="n">SMulZeroClass</span> <span class="n">R</span> <span class="n">M</span> <span class="n">where</span>
  <span class="n">zero_smul</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">m</span> <span class="o">:</span> <span class="n">M</span><span class="o">,</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="bp">‚Ä¢</span> <span class="n">m</span> <span class="bp">=</span> <span class="mi">0</span>

<span class="kd">instance</span> <span class="o">(</span><span class="n">priority</span> <span class="o">:=</span> <span class="mi">100</span><span class="o">)</span> <span class="n">MulActionWithZero.toSMulWithZero</span> <span class="o">[</span><span class="n">MonoidWithZero</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">Zero</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">m</span> <span class="o">:</span> <span class="n">MulActionWithZero</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span> <span class="o">:</span>
    <span class="n">SMulWithZero</span> <span class="n">R</span> <span class="n">M</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="n">m</span> <span class="k">with</span> <span class="o">}</span>

<span class="kd">variable</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span>

<span class="kd">variable</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">‚Üí</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span>

<span class="kn">namespace</span> <span class="k">Pi</span>

<span class="kd">instance</span> <span class="n">instZero</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">Zero</span> <span class="bp">&lt;|</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">Zero</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">‚ü®</span><span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="mi">0</span><span class="o">‚ü©</span>

<span class="kd">variable</span> <span class="o">{</span><span class="n">M</span><span class="o">}</span>

<span class="kd">instance</span> <span class="n">instSMul</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">SMul</span> <span class="n">M</span> <span class="bp">&lt;|</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span> <span class="n">SMul</span> <span class="n">M</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">‚ü®</span><span class="k">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="k">fun</span> <span class="n">i</span> <span class="bp">=&gt;</span> <span class="n">s</span> <span class="bp">‚Ä¢</span> <span class="n">x</span> <span class="n">i</span><span class="o">‚ü©</span>

<span class="kd">instance</span> <span class="n">smulWithZero</span> <span class="o">[</span><span class="n">Zero</span> <span class="n">Œ±</span><span class="o">]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">Zero</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">SMulWithZero</span> <span class="n">Œ±</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span>
    <span class="n">SMulWithZero</span> <span class="n">Œ±</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="k">Pi</span><span class="bp">.</span><span class="n">instSMul</span> <span class="k">with</span>
    <span class="c1">-- already this is odd:</span>
    <span class="c1">-- smul_zero := fun a =&gt; funext fun i =&gt; SMulZeroClass.smul_zero a -- "failed to synthesize instance `SMulZeroClass Œ± (f i)`"</span>
    <span class="n">smul_zero</span> <span class="o">:=</span> <span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">funext</span> <span class="k">fun</span> <span class="n">i</span> <span class="bp">=&gt;</span> <span class="bp">@</span><span class="n">SMulZeroClass.smul_zero</span>  <span class="n">_</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="n">_</span> <span class="n">_</span> <span class="n">a</span> <span class="c1">-- needs the @</span>
    <span class="n">zero_smul</span> <span class="o">:=</span> <span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">funext</span> <span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">SMulWithZero.zero_smul</span> <span class="n">_</span> <span class="o">}</span>

<span class="kd">instance</span> <span class="n">mulAction</span> <span class="o">(</span><span class="n">Œ±</span><span class="o">)</span> <span class="o">{</span><span class="n">m</span> <span class="o">:</span> <span class="n">Monoid</span> <span class="n">Œ±</span><span class="o">}</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">MulAction</span> <span class="n">Œ±</span> <span class="bp">&lt;|</span> <span class="n">f</span> <span class="n">i</span><span class="o">]</span> <span class="o">:</span>
    <span class="bp">@</span><span class="n">MulAction</span> <span class="n">Œ±</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="n">m</span> <span class="n">where</span>
  <span class="n">smul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">¬∑</span> <span class="bp">‚Ä¢</span> <span class="bp">¬∑</span><span class="o">)</span>
  <span class="n">mul_smul</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">funext</span> <span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">MulAction.mul_smul</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span>
  <span class="n">one_smul</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">funext</span> <span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">MulAction.one_smul</span> <span class="n">_</span>

<span class="kd">set_option</span> <span class="n">trace.Meta.synthInstance</span> <span class="n">true</span>

<span class="kd">set_option</span> <span class="n">maxHeartbeats</span> <span class="mi">10000</span> <span class="c1">-- consider turning trace.Meta.synthInstance to false if you</span>
<span class="c1">-- make this number much bigger</span>

<span class="c1">-- works fine</span>
<span class="kd">instance</span> <span class="n">mulActionWithZero</span> <span class="o">(</span><span class="n">Œ±</span><span class="o">)</span> <span class="o">[</span><span class="n">MonoidWithZero</span> <span class="n">Œ±</span><span class="o">]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">Zero</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span>
    <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">MulActionWithZero</span> <span class="n">Œ±</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span> <span class="n">MulActionWithZero</span> <span class="n">Œ±</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="k">Pi</span><span class="bp">.</span><span class="n">mulAction</span> <span class="n">Œ±</span> <span class="k">with</span>
    <span class="n">smul_zero</span> <span class="o">:=</span> <span class="k">Pi</span><span class="bp">.</span><span class="n">smulWithZero.smul_zero</span>
    <span class="n">zero_smul</span> <span class="o">:=</span> <span class="k">Pi</span><span class="bp">.</span><span class="n">smulWithZero.zero_smul</span> <span class="o">}</span>

<span class="c1">-- also works</span>
<span class="kd">instance</span> <span class="n">mulActionWithZero'</span> <span class="o">(</span><span class="n">Œ±</span><span class="o">)</span> <span class="o">[</span><span class="n">MonoidWithZero</span> <span class="n">Œ±</span><span class="o">]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">Zero</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span>
    <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">MulActionWithZero</span> <span class="n">Œ±</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span> <span class="n">MulActionWithZero</span> <span class="n">Œ±</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="k">Pi</span><span class="bp">.</span><span class="n">mulAction</span> <span class="n">Œ±</span><span class="o">,</span> <span class="bp">@</span><span class="k">Pi</span><span class="bp">.</span><span class="n">smulWithZero</span> <span class="n">_</span> <span class="n">_</span> <span class="n">Œ±</span> <span class="n">_</span> <span class="n">_</span> <span class="n">_</span> <span class="k">with</span> <span class="o">}</span>

<span class="c1">-- but this seems to be looping</span>
<span class="kd">instance</span> <span class="n">mulActionWithZero'</span> <span class="o">(</span><span class="n">Œ±</span><span class="o">)</span> <span class="o">[</span><span class="n">MonoidWithZero</span> <span class="n">Œ±</span><span class="o">]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">Zero</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span>
    <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">MulActionWithZero</span> <span class="n">Œ±</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span> <span class="n">MulActionWithZero</span> <span class="n">Œ±</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="k">Pi</span><span class="bp">.</span><span class="n">mulAction</span> <span class="n">Œ±</span><span class="o">,</span> <span class="k">Pi</span><span class="bp">.</span><span class="n">smulWithZero</span> <span class="k">with</span> <span class="o">}</span>


<span class="c">/-</span><span class="cm"></span>
<span class="cm">Lean claims to not be able to find `MonoidWithZero Œ±` even though it's explicitly given as an instance.</span>

<span class="cm">[Meta.synthInstance] üí• (i : I) ‚Üí SMulWithZero Œ± (f i) ‚ñº</span>
<span class="cm">  [] new goal (i : I) ‚Üí SMulWithZero Œ± (f i) ‚ñ∂</span>
<span class="cm">  [] üí• apply MulActionWithZero.toSMulWithZero to (i : I) ‚Üí SMulWithZero Œ± (f i) ‚ñº</span>
<span class="cm">    [tryResolve] üí• SMulWithZero Œ± (f i) ‚âü SMulWithZero (?m.15131 i) (?m.15132 i) ‚ñº</span>
<span class="cm">      [] ‚ùå Zero Œ± ‚ñº</span>
<span class="cm">        [] new goal Zero Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @MonoidWithZero.toZero to Zero Œ± ‚ñº</span>
<span class="cm">          [tryResolve] ‚úÖ Zero Œ± ‚âü Zero Œ±</span>
<span class="cm">          [] no instances for MonoidWithZero Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @AddMonoid.toZero to Zero Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @MulZeroOneClass.toZero to Zero Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @MonoidWithZero.toMulZeroOneClass to MulZeroOneClass Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @AddZeroClass.toZero to Zero Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @AddMonoid.toAddZeroClass to AddZeroClass Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @SemigroupWithZero.toZero to Zero Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @MonoidWithZero.toSemigroupWithZero to SemigroupWithZero Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @MulZeroClass.toZero to Zero Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @MulZeroOneClass.toMulZeroClass to MulZeroClass Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @SemigroupWithZero.toMulZeroClass to MulZeroClass Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @Zero.ofOfNat0 to Zero Œ± ‚ñ∂</span>
<span class="cm">        [] ‚úÖ apply @Zero.toOfNat0 to OfNat Œ± 0 ‚ñ∂</span>
<span class="cm">      [] ‚úÖ I ‚Üí MonoidWithZero Œ± ‚ñ∂</span>
<span class="cm">-/</span>
</code></pre></div>



<a name="319109651"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319109651" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319109651">(Jan 03 2023 at 00:22)</a>:</h4>
<p>Thanks for bringing this to <a class="stream" data-stream-id="270676" href="/#narrow/stream/270676-lean4">#lean4</a> Kevin.  I think I've minimized it a bit more actually:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">variable</span> <span class="o">{</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span>
<span class="kd">variable</span> <span class="o">{</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span>

<span class="kd">class</span> <span class="n">Zip</span> <span class="o">(</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="c1">-- represents `Zero`</span>

<span class="kd">class</span> <span class="n">SMul</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">smul</span> <span class="o">:</span> <span class="n">R</span> <span class="bp">‚Üí</span> <span class="n">Œ±</span> <span class="bp">‚Üí</span> <span class="n">Œ±</span>

<span class="kd">infixr</span><span class="o">:</span><span class="mi">73</span> <span class="s2">" ‚Ä¢ "</span> <span class="bp">=&gt;</span> <span class="n">SMul.smul</span>

<span class="kd">class</span> <span class="n">MulAction</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">Œ≤</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">SMul</span> <span class="n">R</span> <span class="n">Œ≤</span>

<span class="kd">class</span> <span class="n">SMulZeroClass</span> <span class="o">(</span><span class="n">R</span> <span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">SMul</span> <span class="n">R</span> <span class="n">Œ±</span> <span class="n">where</span>
  <span class="n">smul_zero</span> <span class="o">:</span> <span class="bp">‚àÄ</span> <span class="n">r</span> <span class="o">:</span> <span class="n">R</span><span class="o">,</span> <span class="bp">‚àÄ</span> <span class="n">a</span> <span class="o">:</span> <span class="n">Œ±</span><span class="o">,</span> <span class="n">r</span> <span class="bp">‚Ä¢</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">a</span>

<span class="kd">class</span> <span class="n">MulActionWithZero</span> <span class="o">(</span><span class="n">R</span> <span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="kd">extends</span> <span class="n">MulAction</span> <span class="n">R</span> <span class="n">Œ±</span><span class="o">,</span> <span class="n">SMulZeroClass</span> <span class="n">R</span> <span class="n">Œ±</span>

<span class="kd">class</span> <span class="n">SMulWithZero</span> <span class="o">(</span><span class="n">R</span> <span class="n">Œ±</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">[</span><span class="n">Zip</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">Zip</span> <span class="n">Œ±</span><span class="o">]</span> <span class="kd">extends</span> <span class="n">SMulZeroClass</span> <span class="n">R</span> <span class="n">Œ±</span>

<span class="kd">instance</span> <span class="n">MulActionWithZero.toSMulWithZero</span> <span class="o">(</span><span class="n">R</span> <span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span>
    <span class="o">[</span><span class="n">Zip</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">Zip</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">m</span> <span class="o">:</span> <span class="n">MulActionWithZero</span> <span class="n">R</span> <span class="n">M</span><span class="o">]</span> <span class="o">:</span>
    <span class="n">SMulWithZero</span> <span class="n">R</span> <span class="n">M</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="n">m</span> <span class="k">with</span> <span class="o">}</span>


<span class="kn">namespace</span> <span class="n">pi</span>
<span class="kd">variable</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">}</span>
<span class="kd">variable</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">‚Üí</span> <span class="kt">Type</span><span class="o">}</span>

<span class="kd">instance</span> <span class="n">instZero</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">Zip</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span> <span class="n">Zip</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span> <span class="o">‚ü®‚ü©</span>

<span class="kd">instance</span> <span class="n">instSMul</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">SMul</span> <span class="n">R</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span> <span class="n">SMul</span> <span class="n">R</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">‚ü®</span><span class="k">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="bp">=&gt;</span> <span class="k">fun</span> <span class="n">i</span> <span class="bp">=&gt;</span> <span class="n">s</span> <span class="bp">‚Ä¢</span> <span class="n">x</span> <span class="n">i</span><span class="o">‚ü©</span>

<span class="kd">instance</span> <span class="n">smulWithZero</span> <span class="o">(</span><span class="n">R</span><span class="o">)</span> <span class="o">[</span><span class="n">Zip</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">Zip</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">SMulWithZero</span> <span class="n">R</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span>
    <span class="n">SMulWithZero</span> <span class="n">R</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="n">pi.instSMul</span> <span class="k">with</span>
    <span class="n">smul_zero</span> <span class="o">:=</span> <span class="gr">sorry</span> <span class="o">}</span>

<span class="kd">instance</span> <span class="n">mulAction</span> <span class="o">(</span><span class="n">R</span><span class="o">)</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">MulAction</span> <span class="n">R</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span> <span class="n">MulAction</span> <span class="n">R</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span> <span class="o">:</span> <span class="n">I</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="n">where</span>
  <span class="n">smul</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">¬∑</span> <span class="bp">‚Ä¢</span> <span class="bp">¬∑</span><span class="o">)</span>

<span class="kd">set_option</span> <span class="n">trace.Meta.synthInstance</span> <span class="n">true</span>

<span class="kd">set_option</span> <span class="n">maxHeartbeats</span> <span class="mi">10000</span> <span class="c1">-- consider turning trace off if you make this much bigger</span>

<span class="c1">-- seems to be looping</span>
<span class="kd">instance</span> <span class="n">mulActionWithZero</span> <span class="o">(</span><span class="n">R</span><span class="o">)</span> <span class="o">[</span><span class="n">Zip</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">Zip</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">MulActionWithZero</span> <span class="n">R</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span>
    <span class="n">MulActionWithZero</span> <span class="n">R</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
 <span class="o">{</span> <span class="n">pi.mulAction</span> <span class="n">_</span><span class="o">,</span> <span class="n">pi.smulWithZero</span> <span class="n">_</span> <span class="k">with</span> <span class="o">}</span>

<span class="kd">end</span> <span class="n">pi</span>
</code></pre></div>



<a name="319109700"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319109700" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319109700">(Jan 03 2023 at 00:23)</a>:</h4>
<p>And I checked that the error doesn't appear for the corresponding code in Lean 3.</p>



<a name="319109762"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319109762" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319109762">(Jan 03 2023 at 00:23)</a>:</h4>
<p>But i'm not sure how to read the typeclass inference trace.</p>



<a name="319192063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319192063" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Moritz Firsching <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319192063">(Jan 03 2023 at 13:14)</a>:</h4>
<p>I'm not entirely sure, but I think I have observed the same behavior when porting Mathlib/Data/Set/Intervals/Instances.lean<br>
<a href="https://github.com/leanprover-community/mathlib4/blob/6c3e0a06af2816f8d6e046fc860c32e1185f9d0f/Mathlib/Data/Set/Intervals/Instances.lean#L342-L344">Data/Set/Intervals/Instances.lean#L342-L344</a><br>
Here one also gets an deterministic time out and the structure of the instance is very similar</p>



<a name="319247845"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319247845" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319247845">(Jan 03 2023 at 17:49)</a>:</h4>
<p>After taking a quick look, this slightly confusing behavior is due to nested TC resolution.  If you enable the <code>trace.Meta.isDefEq</code> option, then you'll see that the failing type class inference happens during unification.  The thing is, we only allow a single layer of nesting (so tc-&gt;defeq-&gt;tc is fine, but defeq-&gt;tc-&gt;defeq-&gt;tc is not).  So if you have a type class instance that requires nested TC resolution during TC synthesis (like the one here), then it won't be found during unification (i.e., when trying to fill in the underscore here).</p>



<a name="319264840"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319264840" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Heather Macbeth <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319264840">(Jan 03 2023 at 19:25)</a>:</h4>
<p>Thanks for the information Gabriel.  Do you know why this feature was supported in Lean 3 but not in Lean 4?</p>



<a name="319267352"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319267352" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319267352">(Jan 03 2023 at 19:41)</a>:</h4>
<p>What I said is correct, but after some investigation it's not the issue here (although it might bite us in the future).  From what I can tell, all we're missing here is a <code>!</code>.  <a href="https://github.com/leanprover/lean4/commit/70a6c06eef060d8e14869e2848749287e5364742">https://github.com/leanprover/lean4/commit/70a6c06eef060d8e14869e2848749287e5364742</a></p>



<a name="319273978"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319273978" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319273978">(Jan 03 2023 at 20:24)</a>:</h4>
<p>Does this change have any effect on the examples at <a href="https://github.com/leanprover/lean4/pull/1986">lean4#1986</a>?</p>



<a name="319274738"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319274738" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319274738">(Jan 03 2023 at 20:29)</a>:</h4>
<p>Not as far as I can tell.</p>



<a name="319276435"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319276435" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319276435">(Jan 03 2023 at 20:40)</a>:</h4>
<p><a href="https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Pi.mulAction#doc">docs4#Pi.mulAction</a> has <code>{m : Monoid Œ±}</code> a typeclass variable being inferred by unification. Presumably this is intentional? Is this related?</p>



<a name="319276740"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319276740" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319276740">(Jan 03 2023 at 20:43)</a>:</h4>
<p>And does it change this?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Mathlib.Algebra.SMulWithZero</span>

<span class="kd">universe</span> <span class="n">u</span> <span class="n">v</span>

<span class="kd">variable</span> <span class="o">{</span><span class="n">I</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span>

<span class="kd">variable</span> <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="n">I</span> <span class="bp">‚Üí</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span>

<span class="kd">set_option</span> <span class="n">trace.Meta.synthInstance</span> <span class="n">true</span>

<span class="kd">instance</span> <span class="k">Pi</span><span class="bp">.</span><span class="n">smulWithZero</span> <span class="o">(</span><span class="n">Œ±</span><span class="o">)</span> <span class="o">[</span><span class="n">Zero</span> <span class="n">Œ±</span><span class="o">]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">Zero</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">[</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">SMulWithZero</span> <span class="n">Œ±</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)]</span> <span class="o">:</span>
    <span class="n">SMulWithZero</span> <span class="n">Œ±</span> <span class="o">(</span><span class="bp">‚àÄ</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span> <span class="n">i</span><span class="o">)</span> <span class="o">:=</span>
  <span class="o">{</span> <span class="k">Pi</span><span class="bp">.</span><span class="n">instSMul</span> <span class="k">with</span>
    <span class="n">smul_zero</span> <span class="o">:=</span> <span class="k">fun</span> <span class="n">a</span> <span class="bp">=&gt;</span> <span class="n">funext</span> <span class="k">fun</span> <span class="n">i</span> <span class="bp">=&gt;</span> <span class="n">SMulZeroClass.smul_zero</span> <span class="n">a</span> <span class="c1">-- fails with error</span>
    <span class="c">/-</span><span class="cm"></span>
<span class="cm">    failed to synthesize instance</span>
<span class="cm">    SMulZeroClass Œ± (f i)</span>
<span class="cm">    -/</span>
    <span class="n">zero_smul</span> <span class="o">:=</span> <span class="gr">sorry</span> <span class="o">}</span>
</code></pre></div>



<a name="319277228"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319277228" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319277228">(Jan 03 2023 at 20:46)</a>:</h4>
<p><code>    smul_zero := fun a =&gt; funext fun i =&gt; @SMulZeroClass.smul_zero Œ± (f i) _ _ a -- works fine</code></p>



<a name="319280154"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319280154" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319280154">(Jan 03 2023 at 21:06)</a>:</h4>
<p>I see this in the traces of Heather's example:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>[Meta.isDefEq] üí• ‚àÄ (r : R) (a : (i : I) ‚Üí f i), r ‚Ä¢ a = a =?= ‚àÄ (r : R) (a : (i : I) ‚Üí f i), r ‚Ä¢ a = a
</code></pre></div>
<p>Is this surprising?</p>



<a name="319286505"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319286505" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Gabriel Ebner <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319286505">(Jan 03 2023 at 21:57)</a>:</h4>
<p>The bomb in synthInstance usually means that TC synthesis aborted because it saw a metavariable.  For example, you need to find an instance of <code>Group (?G, ?H)</code>. Then we abort and try again later when <code>?G</code> is filled in.</p>



<a name="319304399"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319304399" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Kevin Buzzard <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319304399">(Jan 04 2023 at 00:32)</a>:</h4>
<p>But the bomb in the above had no metavariables I think</p>



<a name="319348789"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319348789" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319348789">(Jan 04 2023 at 09:18)</a>:</h4>
<p>This is the example with the heartbeat timeout, right? As soon as the limit is reached, any further isDefEq/whnf/... will bomb out in 0 steps. synthInstance is the only subsystem with a per-invocation limit.</p>



<a name="319348864"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319348864" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319348864">(Jan 04 2023 at 09:18)</a>:</h4>
<p>But also, <a href="/user_uploads/3121/bSUvZexDAJH9E36AHaECWw15/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/bSUvZexDAJH9E36AHaECWw15/image.png" title="image.png"><img src="/user_uploads/3121/bSUvZexDAJH9E36AHaECWw15/image.png"></a></div>



<a name="319349694"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319349694" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik B√∂ving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319349694">(Jan 04 2023 at 09:24)</a>:</h4>
<p>How are you getting these type hovers in emacs in the info view? <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span></p>



<a name="319350172"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319350172" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319350172">(Jan 04 2023 at 09:28)</a>:</h4>
<p>By using VS Code :)</p>



<a name="319350257"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319350257" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik B√∂ving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319350257">(Jan 04 2023 at 09:29)</a>:</h4>
<p>/o\</p>



<a name="319350285"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319350285" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Henrik B√∂ving <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319350285">(Jan 04 2023 at 09:29)</a>:</h4>
<p>So I am the last one left on emacs now huh.</p>



<a name="319350723"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/type%20class%20inference%20looping/near/319350723" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/type.20class.20inference.20looping.html#319350723">(Jan 04 2023 at 09:32)</a>:</h4>
<p>It's basically the only time I use VS Code. But I'm not holding my breath for widget support in Emacs either. I guess using an external web browser window as suggested before is the most realistic solution.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>