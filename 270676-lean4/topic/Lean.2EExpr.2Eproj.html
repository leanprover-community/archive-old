---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html">Lean.Expr.proj</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="284367708"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284367708" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284367708">(May 30 2022 at 13:31)</a>:</h4>
<p>In the metaprogramming book, <span class="user-mention" data-user-id="121918">@Edward Ayers</span> described this constructor as:</p>
<blockquote>
<p><code>proj</code> is for projection. Suppose you have a structure such as <code>p : α × β</code>,<br>
  rather than storing the projection <code>π₁ p</code> as <code>app π₁ p</code>, it is expressed as<br>
<code>proj Prod 0 p</code>. This is for efficiency reasons</p>
</blockquote>
<p>Is this documented somewhere? Where can I learn more about it? Thanks in advance!</p>



<a name="284368856"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284368856" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284368856">(May 30 2022 at 13:41)</a>:</h4>
<p>well, you are talking about the very book that would be the documentation, so not really</p>



<a name="284368873"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284368873" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284368873">(May 30 2022 at 13:41)</a>:</h4>
<p>is there something in particular you want to know about it?</p>



<a name="284368940"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284368940" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284368940">(May 30 2022 at 13:42)</a>:</h4>
<p>They are called "primitive projections" and they correspond to the fields of a structure</p>



<a name="284369105"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284369105" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284369105">(May 30 2022 at 13:43)</a>:</h4>
<p>Hm, is there anything we lose (but efficiency) if we face them as regular applications? Like some expressiveness power</p>



<a name="284370951"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284370951" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284370951">(May 30 2022 at 13:59)</a>:</h4>
<p>no, it's just for efficiency</p>



<a name="284371076"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284371076" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284371076">(May 30 2022 at 14:00)</a>:</h4>
<p>they are not supposed to be an extension to the logic, they just abbreviate applications of the recursor</p>



<a name="284371124"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284371124" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284371124">(May 30 2022 at 14:00)</a>:</h4>
<p>nat and string literals are the same way</p>



<a name="284371930"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284371930" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284371930">(May 30 2022 at 14:06)</a>:</h4>
<p>Alright, thanks!</p>



<a name="284566103"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284566103" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284566103">(Jun 01 2022 at 04:35)</a>:</h4>
<p>How can I make it print <code>proj</code>?</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>

<span class="kn">open</span> <span class="n">Lean</span> <span class="n">Elab</span> <span class="n">Command</span> <span class="n">Term</span> <span class="k">in</span>
<span class="n">elab</span> <span class="s2">"#inspect"</span> <span class="n">t</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="n">liftTermElabM</span> <span class="bp">`</span><span class="n">inspect</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">t</span> <span class="bp">←</span> <span class="n">elabTerm</span> <span class="n">t</span> <span class="n">none</span>
    <span class="n">synthesizeSyntheticMVarsNoPostponing</span>
    <span class="n">dbg_trace</span> <span class="n">t.ctorName</span>

<span class="kd">structure</span> <span class="n">Foo</span> <span class="n">where</span>
  <span class="n">aa</span> <span class="o">:</span> <span class="n">Nat</span>
  <span class="n">bb</span> <span class="o">:</span> <span class="n">String</span>

<span class="bp">#</span><span class="n">inspect</span> <span class="o">(</span><span class="n">Foo.mk</span> <span class="mi">1</span> <span class="s2">"hi"</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span>  <span class="c1">-- app</span>
<span class="bp">#</span><span class="n">inspect</span> <span class="o">(</span><span class="n">Foo.mk</span> <span class="mi">1</span> <span class="s2">"hi"</span><span class="o">)</span><span class="bp">.</span><span class="n">aa</span> <span class="c1">-- app</span>
<span class="bp">#</span><span class="n">inspect</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="mi">1</span>           <span class="c1">-- app</span>
<span class="bp">#</span><span class="n">inspect</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span><span class="bp">.</span><span class="n">fst</span>         <span class="c1">-- app</span>
</code></pre></div>



<a name="284567846"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284567846" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284567846">(Jun 01 2022 at 05:12)</a>:</h4>
<p>Not easily. <code>proj</code> is generally not supposed to show up in normal terms. But you can look at the implementation of the projections to find occurrences of <code>proj</code>:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">import</span> <span class="n">Lean</span>

<span class="n">elab</span> <span class="s2">"#inspect"</span> <span class="n">t</span><span class="o">:</span><span class="n">ident</span> <span class="o">:</span> <span class="n">command</span> <span class="bp">=&gt;</span> <span class="k">do</span>
  <span class="k">if</span> <span class="k">let</span> <span class="n">some</span> <span class="n">ci</span> <span class="o">:=</span> <span class="o">(</span><span class="bp">←</span> <span class="n">Lean.getEnv</span><span class="o">)</span><span class="bp">.</span><span class="n">find</span><span class="bp">?</span> <span class="n">t.getId</span> <span class="k">then</span>
    <span class="n">dbg_trace</span> <span class="n">repr</span> <span class="n">ci.value</span><span class="bp">!</span>

<span class="kd">structure</span> <span class="n">Foo</span> <span class="n">where</span>
  <span class="n">aa</span> <span class="o">:</span> <span class="n">Nat</span>
  <span class="n">bb</span> <span class="o">:</span> <span class="n">String</span>

<span class="bp">#</span><span class="n">inspect</span> <span class="n">Foo.aa</span>
<span class="c1">-- Lean.Expr.lam</span>
<span class="c1">--   `self</span>
<span class="c1">--   (Lean.Expr.const `Foo [] (Expr.mkData 1485976967 (bi := Lean.BinderInfo.default)))</span>
<span class="c1">--   (Lean.Expr.proj</span>
<span class="c1">--     `Foo</span>
<span class="c1">--     0</span>
<span class="c1">--     (Lean.Expr.bvar 0 (Expr.mkData 4279369707 (looseBVarRange := 1) (bi := Lean.BinderInfo.default)))</span>
<span class="c1">--     (Expr.mkData 1237988559 (looseBVarRange := 1) (approxDepth := 1) (bi := Lean.BinderInfo.default)))</span>
<span class="c1">--   (Expr.mkData 3385561612 (approxDepth := 2) (bi := Lean.BinderInfo.default))</span>
</code></pre></div>



<a name="284577137"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284577137" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284577137">(Jun 01 2022 at 07:41)</a>:</h4>
<p>Is there any way to reduce an <code>Expr</code> in a way that minimizes the constructors used? I.e. reducing away not only <code>let</code>s but also <code>proj</code>s and literals?</p>



<a name="284577558"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284577558" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284577558">(Jun 01 2022 at 07:47)</a>:</h4>
<p>No built-in way I think, since Lean of course <em>wants</em> to preserve these</p>



<a name="284577714"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284577714" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284577714">(Jun 01 2022 at 07:49)</a>:</h4>
<p>Note that lean <em>does</em> know that a projection can unfold:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">example</span> <span class="o">:</span> <span class="n">Foo.aa</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">Foo.rec</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">x</span> <span class="n">y</span> <span class="bp">=&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span>
</code></pre></div>



<a name="284577731"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284577731" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284577731">(Jun 01 2022 at 07:49)</a>:</h4>
<p>(on second thought, this might be eta for structures kicking in instead)</p>



<a name="284578156"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284578156" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Jakob von Raumer <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284578156">(Jun 01 2022 at 07:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110024">Sebastian Ullrich</span> <a href="#narrow/stream/270676-lean4/topic/Lean.2EExpr.2Eproj/near/284577558">said</a>:</p>
<blockquote>
<p>No built-in way I think, since Lean of course <em>wants</em> to preserve these</p>
</blockquote>
<p>For all kinds of transformations it is a bit weird to work on those doublets though, since making the transformation consistent already determines them uniquely</p>



<a name="284579797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Lean.Expr.proj/near/284579797" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Lean.2EExpr.2Eproj.html#284579797">(Jun 01 2022 at 08:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="110049">Mario Carneiro</span> <a href="#narrow/stream/270676-lean4/topic/Lean.2EExpr.2Eproj/near/284577731">said</a>:</p>
<blockquote>
<p>(on second thought, this might be eta for structures kicking in instead)</p>
</blockquote>
<p>It's actually older than that, see <code>isDefEqProj</code>. And <code>isDefEqNat/isDefEqStringLit</code> for literals.</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>