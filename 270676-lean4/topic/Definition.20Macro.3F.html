---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Definition.20Macro.3F.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html">Definition Macro?</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="282975293"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/282975293" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph O <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#282975293">(May 19 2022 at 18:52)</a>:</h4>
<p>How could I make a macro in Lean such that </p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">(</span><span class="n">define</span> <span class="o">(</span><span class="n">add</span> <span class="o">[</span><span class="n">x</span> <span class="n">Nat</span><span class="o">]</span> <span class="o">[</span><span class="n">y</span> <span class="n">Nat</span><span class="o">])</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">))</span>
</code></pre></div>
<p>expands into</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">add</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span> <span class="o">:=</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">y</span>
</code></pre></div>



<a name="282985507"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/282985507" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#282985507">(May 19 2022 at 20:10)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="n">binder</span> <span class="o">:=</span> <span class="s2">"["</span> <span class="n">ident</span> <span class="n">term</span> <span class="s2">"]"</span>
<span class="n">syntax</span> <span class="s2">"("</span> <span class="s2">"define"</span> <span class="s2">"("</span> <span class="n">ident</span> <span class="n">binder</span><span class="bp">*</span> <span class="s2">")"</span> <span class="n">term</span> <span class="s2">" : "</span> <span class="n">term</span> <span class="s2">")"</span> <span class="o">:</span> <span class="n">command</span>

<span class="n">macro_rules</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">((</span><span class="n">define</span> <span class="o">(</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="o">[</span><span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span><span class="o">])</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">))</span> <span class="bp">=&gt;</span>
    <span class="bp">`</span><span class="o">(</span><span class="kd">def</span> <span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="o">:</span> <span class="bp">$</span><span class="n">ty</span> <span class="bp">→</span> <span class="bp">$</span><span class="n">ty'</span> <span class="o">:=</span> <span class="k">fun</span> <span class="bp">$</span><span class="n">nm</span> <span class="bp">=&gt;</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">)</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">((</span><span class="n">define</span> <span class="o">(</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="o">[</span><span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder</span><span class="bp">*</span><span class="o">)</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">))</span> <span class="bp">=&gt;</span>
    <span class="bp">`</span><span class="o">((</span><span class="n">define</span> <span class="o">(</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder</span><span class="bp">*</span><span class="o">)</span> <span class="k">fun</span> <span class="bp">$</span><span class="n">nm</span> <span class="bp">=&gt;</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span> <span class="o">:</span> <span class="bp">$</span><span class="n">ty</span> <span class="bp">→</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">))</span>

<span class="o">(</span><span class="n">define</span> <span class="o">(</span><span class="n">add</span> <span class="o">[</span><span class="n">x</span> <span class="n">Nat</span><span class="o">]</span> <span class="o">[</span><span class="n">y</span> <span class="n">Nat</span><span class="o">])</span> <span class="n">x</span> <span class="o">:</span> <span class="n">Nat</span><span class="o">)</span>

<span class="k">#eval</span> <span class="n">add</span> <span class="mi">3</span> <span class="mi">5</span> <span class="c1">-- 5</span>
</code></pre></div>



<a name="282985928"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/282985928" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#282985928">(May 19 2022 at 20:14)</a>:</h4>
<p>Here's a fun idea:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="n">binder</span> <span class="o">:=</span> <span class="s2">"["</span> <span class="n">ident</span> <span class="n">term</span> <span class="s2">"]"</span>
<span class="n">syntax</span> <span class="s2">"("</span> <span class="s2">"define"</span> <span class="s2">"("</span> <span class="s2">"["</span> <span class="n">ident</span> <span class="n">term</span> <span class="s2">"]"</span> <span class="n">binder</span><span class="bp">*</span> <span class="s2">")"</span> <span class="n">term</span> <span class="s2">")"</span> <span class="o">:</span> <span class="n">command</span>

<span class="n">macro_rules</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">((</span><span class="n">define</span> <span class="o">([</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="o">[</span><span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span><span class="o">])</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">))</span> <span class="bp">=&gt;</span>
    <span class="bp">`</span><span class="o">(</span><span class="kd">def</span> <span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="o">:</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span> <span class="bp">→</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span> <span class="o">:=</span> <span class="k">fun</span> <span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">=&gt;</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">)</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">((</span><span class="n">define</span> <span class="o">([</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="o">[</span><span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder</span><span class="bp">*</span><span class="o">)</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">))</span> <span class="bp">=&gt;</span>
    <span class="bp">`</span><span class="o">((</span><span class="n">define</span> <span class="o">([</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span> <span class="bp">→</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder</span><span class="bp">*</span><span class="o">)</span> <span class="k">fun</span> <span class="bp">$</span><span class="n">nm</span> <span class="bp">=&gt;</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">))</span>

<span class="o">(</span><span class="n">define</span> <span class="o">([</span><span class="n">add</span> <span class="n">Nat</span><span class="o">]</span> <span class="o">[</span><span class="n">x</span> <span class="n">Nat</span><span class="o">]</span> <span class="o">[</span><span class="n">y</span> <span class="n">Nat</span><span class="o">])</span> <span class="n">x</span><span class="o">)</span>

<span class="k">#eval</span> <span class="n">add</span> <span class="mi">3</span> <span class="mi">5</span> <span class="c1">-- 5</span>
</code></pre></div>



<a name="282988007"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/282988007" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph O <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#282988007">(May 19 2022 at 20:30)</a>:</h4>
<p>Thanks!</p>



<a name="282988136"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/282988136" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#282988136">(May 19 2022 at 20:31)</a>:</h4>
<p>There's something wrong with my code tho</p>



<a name="282988560"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/282988560" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#282988560">(May 19 2022 at 20:34)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="o">(</span><span class="n">define</span> <span class="o">([</span><span class="n">add</span> <span class="n">Nat</span><span class="o">]</span> <span class="o">[</span><span class="n">x</span> <span class="n">Nat</span><span class="o">]</span> <span class="o">[</span><span class="n">bla</span> <span class="n">Int</span><span class="o">])</span> <span class="n">x</span><span class="o">)</span>

<span class="k">#eval</span> <span class="n">add</span> <span class="mi">3</span> <span class="mi">5</span> <span class="c1">-- 5</span>
</code></pre></div>
<p>I would expect that to eval to <code>3</code>, but it's being evaluated to <code>5</code>. Maybe someone else might be able to help you</p>



<a name="282991324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/282991324" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph O <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#282991324">(May 19 2022 at 20:57)</a>:</h4>
<p><span class="user-mention" data-user-id="451983">@Arthur Paulino</span> I think its because the arguments are reversed</p>



<a name="283066749"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283066749" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Notification Bot <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283066749">(May 20 2022 at 13:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="467926">Joseph O</span> has marked this topic as unresolved.</p>



<a name="283066800"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283066800" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph O <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283066800">(May 20 2022 at 13:10)</a>:</h4>
<p>Hm can someone explain this weird behavior?<br>
<a href="/user_uploads/3121/gsoDTwnvvwOyVsyUUq_bRhc0/image.png">image.png</a> <br>
<a href="/user_uploads/3121/sscpr5FgCNQwdVtinZ3vBsTu/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/3121/gsoDTwnvvwOyVsyUUq_bRhc0/image.png" title="image.png"><img src="/user_uploads/3121/gsoDTwnvvwOyVsyUUq_bRhc0/image.png"></a></div><div class="message_inline_image"><a href="/user_uploads/3121/sscpr5FgCNQwdVtinZ3vBsTu/image.png" title="image.png"><img src="/user_uploads/3121/sscpr5FgCNQwdVtinZ3vBsTu/image.png"></a></div>



<a name="283066935"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283066935" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283066935">(May 20 2022 at 13:11)</a>:</h4>
<p>I can't understand what's wrong with those screenshots</p>



<a name="283067048"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283067048" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph O <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283067048">(May 20 2022 at 13:12)</a>:</h4>
<p>For more context, here is <code>test3</code></p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">test3</span> <span class="o">:</span> <span class="n">List</span> <span class="n">Nat</span> <span class="o">:=</span>
  <span class="k">let</span> <span class="n">x</span> <span class="o">:=</span> <span class="o">[</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">],</span> <span class="n">y</span> <span class="o">:=</span> <span class="o">[</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">]</span> <span class="k">in</span> <span class="n">x</span> <span class="bp">++</span> <span class="n">y</span>
</code></pre></div>



<a name="283067120"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283067120" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283067120">(May 20 2022 at 13:13)</a>:</h4>
<p>I believe you posted on the wrong thread</p>



<a name="283067297"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283067297" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph O <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283067297">(May 20 2022 at 13:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Definition.20Macro.3F/near/283067120">said</a>:</p>
<blockquote>
<p>I believe you posted on the wrong thread</p>
</blockquote>
<p>I don't think so, because this has something to do with the definition macro</p>



<a name="283067330"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283067330" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph O <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283067330">(May 20 2022 at 13:15)</a>:</h4>
<p>As when it is uncommented (the <code>add</code> function), it breaks <code>test3</code></p>



<a name="283067369"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283067369" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283067369">(May 20 2022 at 13:15)</a>:</h4>
<p><a href="https://leanprover-community.github.io/mwe.html">#mwe</a> please</p>



<a name="283070062"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283070062" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph O <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283070062">(May 20 2022 at 13:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Definition.20Macro.3F/near/283067369">said</a>:</p>
<blockquote>
<p><a href="https://leanprover-community.github.io/mwe.html">#mwe</a> please</p>
</blockquote>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="n">binder</span> <span class="o">:=</span> <span class="n">ident</span> <span class="s2">" := "</span> <span class="n">term</span>
<span class="n">syntax</span> <span class="s2">"let"</span> <span class="n">binder</span><span class="o">,</span><span class="bp">+</span> <span class="s2">" in "</span> <span class="n">term</span> <span class="o">:</span> <span class="n">term</span>

<span class="n">macro_rules</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="k">let</span> <span class="bp">$</span><span class="n">name</span><span class="o">:</span><span class="n">ident</span> <span class="o">:=</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span> <span class="k">in</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span><span class="k">let</span> <span class="bp">$</span><span class="n">name</span> <span class="o">:=</span> <span class="bp">$</span><span class="n">v</span><span class="bp">;</span> <span class="bp">$</span><span class="n">t</span><span class="o">)</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="k">let</span> <span class="bp">$</span><span class="n">name</span><span class="o">:</span><span class="n">ident</span> <span class="o">:=</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">,</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder</span><span class="o">,</span><span class="bp">*</span> <span class="k">in</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">)</span> <span class="bp">=&gt;</span>
    <span class="bp">`</span><span class="o">(</span><span class="k">let</span> <span class="bp">$</span><span class="n">name</span> <span class="o">:=</span> <span class="bp">$</span><span class="n">v</span><span class="bp">;</span> <span class="k">let</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder</span><span class="o">,</span><span class="bp">*</span> <span class="k">in</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">)</span>

<span class="n">syntax</span> <span class="n">binder</span> <span class="o">:=</span> <span class="s2">"["</span> <span class="n">ident</span> <span class="n">term</span> <span class="s2">"]"</span>
<span class="n">syntax</span> <span class="s2">"("</span> <span class="s2">"define"</span> <span class="s2">"("</span> <span class="n">binder</span><span class="bp">+</span> <span class="s2">")"</span> <span class="n">term</span> <span class="s2">")"</span> <span class="o">:</span> <span class="n">command</span>

<span class="n">macro_rules</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">((</span><span class="n">define</span> <span class="o">([</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="o">[</span><span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span><span class="o">])</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">))</span> <span class="bp">=&gt;</span>
    <span class="bp">`</span><span class="o">(</span><span class="kd">def</span> <span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="o">:</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span> <span class="bp">→</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span> <span class="o">:=</span> <span class="k">fun</span> <span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">=&gt;</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">)</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">((</span><span class="n">define</span> <span class="o">([</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="o">[</span><span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder</span><span class="bp">*</span><span class="o">)</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">))</span> <span class="bp">=&gt;</span>
    <span class="bp">`</span><span class="o">((</span><span class="n">define</span> <span class="o">([</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span> <span class="bp">→</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder</span><span class="bp">*</span><span class="o">)</span> <span class="k">fun</span> <span class="bp">$</span><span class="n">nm</span> <span class="bp">=&gt;</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">))</span>

<span class="kd">def</span> <span class="n">test3</span> <span class="o">:</span> <span class="n">List</span> <span class="n">Nat</span> <span class="o">:=</span>
  <span class="k">let</span> <span class="n">x</span> <span class="o">:=</span> <span class="o">[</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">],</span> <span class="n">y</span> <span class="o">:=</span> <span class="o">[</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">]</span> <span class="k">in</span> <span class="n">x</span> <span class="bp">++</span> <span class="n">y</span>

<span class="k">#eval</span> <span class="n">test3</span> <span class="c1">-- [1, 2, 3, 4]</span>

<span class="c1">-- try commenting and uncommenting this line, and see what happens to the eval</span>
<span class="o">(</span><span class="n">define</span> <span class="o">([</span><span class="n">add</span> <span class="n">Nat</span><span class="o">]</span> <span class="o">[</span><span class="n">x</span> <span class="n">Nat</span><span class="o">]</span> <span class="o">[</span><span class="n">y</span> <span class="n">Nat</span><span class="o">])</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span>
</code></pre></div>



<a name="283070599"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283070599" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283070599">(May 20 2022 at 13:38)</a>:</h4>
<p>There's a conflict with the declaration of <code>binder</code></p>



<a name="283070638"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283070638" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph O <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283070638">(May 20 2022 at 13:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451983">Arthur Paulino</span> <a href="#narrow/stream/270676-lean4/topic/Definition.20Macro.3F/near/283070599">said</a>:</p>
<blockquote>
<p>There's a conflict with the declaration of <code>binder</code></p>
</blockquote>
<p>Oh I see</p>



<a name="283070953"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283070953" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Joseph O <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283070953">(May 20 2022 at 13:40)</a>:</h4>
<p>I renamed them and I still get the same error</p>



<a name="283071945"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283071945" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Raghuram <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283071945">(May 20 2022 at 13:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="467926">Joseph O</span> <a href="#narrow/stream/270676-lean4/topic/Definition.20Macro.3F/near/283066800">said</a>:</p>
<blockquote>
<p>Hm can someone explain this weird behavior?<br>
<a href="/user_uploads/3121/gsoDTwnvvwOyVsyUUq_bRhc0/image.png">image.png</a> <br>
<a href="/user_uploads/3121/sscpr5FgCNQwdVtinZ3vBsTu/image.png">image.png</a></p>
</blockquote>
<p>I got similar errors.  I think Lean is interpreting <code>(define ...)</code> as a term to which test3 is applied.  See if the error goes away if you put <code>section end</code> between the <code>#eval</code> and <code>(define ...)</code>.<br>
As for how to make <code>(define ...)</code> recognised as a separate command, I don't know.</p>



<a name="283072207"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283072207" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Raghuram <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283072207">(May 20 2022 at 13:48)</a>:</h4>
<p>Wait; are you not getting any errors on the <code>(define ...)</code> line when it's uncommented?  That's different from what I got.</p>



<a name="283072610"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Definition%20Macro%3F/near/283072610" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Arthur Paulino <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Definition.20Macro.3F.html#283072610">(May 20 2022 at 13:51)</a>:</h4>
<p>Apparently the parens from <code>(define ⋯</code> is causing the confusion. This works:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="n">syntax</span> <span class="n">binder</span> <span class="o">:=</span> <span class="n">ident</span> <span class="s2">" := "</span> <span class="n">term</span>
<span class="n">syntax</span> <span class="s2">"let "</span> <span class="n">binder</span><span class="o">,</span><span class="bp">+</span> <span class="s2">" in "</span> <span class="n">term</span> <span class="o">:</span> <span class="n">term</span>

<span class="n">macro_rules</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="k">let</span> <span class="bp">$</span><span class="n">name</span><span class="o">:</span><span class="n">ident</span> <span class="o">:=</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span> <span class="k">in</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">)</span> <span class="bp">=&gt;</span> <span class="bp">`</span><span class="o">(</span><span class="k">let</span> <span class="bp">$</span><span class="n">name</span> <span class="o">:=</span> <span class="bp">$</span><span class="n">v</span><span class="bp">;</span> <span class="bp">$</span><span class="n">t</span><span class="o">)</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(</span><span class="k">let</span> <span class="bp">$</span><span class="n">name</span><span class="o">:</span><span class="n">ident</span> <span class="o">:=</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">,</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder</span><span class="o">,</span><span class="bp">*</span> <span class="k">in</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">)</span> <span class="bp">=&gt;</span>
    <span class="bp">`</span><span class="o">(</span><span class="k">let</span> <span class="bp">$</span><span class="n">name</span> <span class="o">:=</span> <span class="bp">$</span><span class="n">v</span><span class="bp">;</span> <span class="k">let</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder</span><span class="o">,</span><span class="bp">*</span> <span class="k">in</span> <span class="bp">$</span><span class="n">t</span><span class="o">:</span><span class="n">term</span><span class="o">)</span>

<span class="n">syntax</span> <span class="n">binder'</span> <span class="o">:=</span> <span class="s2">"["</span> <span class="n">ident</span> <span class="n">term</span> <span class="s2">"]"</span>
<span class="n">syntax</span> <span class="s2">"⦃"</span> <span class="s2">"define"</span> <span class="s2">"("</span> <span class="n">binder'</span><span class="bp">+</span> <span class="s2">")"</span> <span class="n">term</span> <span class="s2">"⦄"</span> <span class="o">:</span> <span class="n">command</span>

<span class="n">macro_rules</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(⦃</span><span class="n">define</span> <span class="o">([</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="o">[</span><span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span><span class="o">])</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">⦄)</span> <span class="bp">=&gt;</span>
    <span class="bp">`</span><span class="o">(</span><span class="kd">def</span> <span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="o">:</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span> <span class="bp">→</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span> <span class="o">:=</span> <span class="k">fun</span> <span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">=&gt;</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">)</span>
  <span class="bp">|</span> <span class="bp">`</span><span class="o">(⦃</span><span class="n">define</span> <span class="o">([</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="o">[</span><span class="bp">$</span><span class="n">nm</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder'</span><span class="bp">*</span><span class="o">)</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">⦄)</span> <span class="bp">=&gt;</span>
    <span class="bp">`</span><span class="o">(⦃</span><span class="n">define</span> <span class="o">([</span><span class="bp">$</span><span class="n">f</span><span class="o">:</span><span class="n">ident</span> <span class="bp">$</span><span class="n">ty</span><span class="o">:</span><span class="n">term</span> <span class="bp">→</span> <span class="bp">$</span><span class="n">ty'</span><span class="o">:</span><span class="n">term</span><span class="o">]</span> <span class="bp">$</span><span class="n">bs</span><span class="o">:</span><span class="n">binder'</span><span class="bp">*</span><span class="o">)</span> <span class="k">fun</span> <span class="bp">$</span><span class="n">nm</span> <span class="bp">=&gt;</span> <span class="bp">$</span><span class="n">v</span><span class="o">:</span><span class="n">term</span><span class="o">⦄)</span>

<span class="kd">def</span> <span class="n">test3</span> <span class="o">:</span> <span class="n">List</span> <span class="n">Nat</span> <span class="o">:=</span>
  <span class="k">let</span> <span class="n">x</span> <span class="o">:=</span> <span class="o">[</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">],</span> <span class="n">y</span> <span class="o">:=</span> <span class="o">[</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">]</span> <span class="k">in</span> <span class="n">x</span> <span class="bp">++</span> <span class="n">y</span>

<span class="k">#eval</span> <span class="n">test3</span> <span class="c1">-- [1, 2, 3, 4] works</span>

<span class="o">⦃</span><span class="n">define</span> <span class="o">([</span><span class="n">add</span> <span class="n">Nat</span><span class="o">]</span> <span class="o">[</span><span class="n">x</span> <span class="n">Nat</span><span class="o">]</span> <span class="o">[</span><span class="n">y</span> <span class="n">Nat</span><span class="o">])</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">⦄</span> <span class="c1">-- works</span>
</code></pre></div>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>