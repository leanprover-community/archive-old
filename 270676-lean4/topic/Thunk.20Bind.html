---
layout: archive
title: Zulip Chat Archive
permalink: /stream/270676-lean4/topic/Thunk.20Bind.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/index.html">lean4</a></h2>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html">Thunk Bind</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com/">

<head><link href="/style.css" rel="stylesheet"></head>

{% raw %}

<a name="235677103"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235677103" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235677103">(Apr 22 2021 at 13:30)</a>:</h4>
<p>Am I misunderstanding Thunk?<br>
When I write</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kd">def</span> <span class="n">h</span> <span class="o">:=</span> <span class="n">Thunk.pure</span> <span class="s2">"hi"</span>
<span class="k">#eval</span> <span class="o">(</span><span class="n">Thunk.bind</span> <span class="n">h</span> <span class="n">Thunk.pure</span><span class="o">)</span><span class="bp">.</span><span class="n">get</span>
</code></pre></div>
<p>I am expecting to see "hi", since bind should extract "hi" from h, apply Thunk.pure to it, and get should get the contents.</p>



<a name="235677436"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235677436" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235677436">(Apr 22 2021 at 13:32)</a>:</h4>
<p>what do you get?</p>



<a name="235677471"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235677471" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235677471">(Apr 22 2021 at 13:32)</a>:</h4>
<p>processing...</p>



<a name="235677504"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235677504" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235677504">(Apr 22 2021 at 13:32)</a>:</h4>
<p>does it work from the console</p>



<a name="235677686"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235677686" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235677686">(Apr 22 2021 at 13:34)</a>:</h4>
<p>segfault</p>



<a name="235677815"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235677815" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235677815">(Apr 22 2021 at 13:34)</a>:</h4>
<p>let me isolate it for a more rigorous test</p>



<a name="235677952"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235677952" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235677952">(Apr 22 2021 at 13:35)</a>:</h4>
<p>segfault</p>



<a name="235677983"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235677983" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235677983">(Apr 22 2021 at 13:35)</a>:</h4>
<p>FYI, there was an update around yesterday to the vscode extension that fixed what looked like infinite loops for me. Please make sure you have 0.0.24</p>



<a name="235678029"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235678029" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235678029">(Apr 22 2021 at 13:36)</a>:</h4>
<p>In emacs</p>



<a name="235678078"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235678078" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235678078">(Apr 22 2021 at 13:36)</a>:</h4>
<p>k</p>



<a name="235678097"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235678097" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235678097">(Apr 22 2021 at 13:36)</a>:</h4>
<p>But also, running from the console does not fix</p>



<a name="235678191"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235678191" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235678191">(Apr 22 2021 at 13:36)</a>:</h4>
<p>Lean (version 4.0.0-nightly-2021-03-14, commit c54a7c8ccc75, Release)</p>



<a name="235678275"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235678275" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235678275">(Apr 22 2021 at 13:37)</a>:</h4>
<p>that's pretty old, try updating your nightly</p>



<a name="235678447"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235678447" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235678447">(Apr 22 2021 at 13:38)</a>:</h4>
<p>Lean (version 4.0.0-nightly-2021-04-06, commit e863376be155, Release)<br>
Same issue</p>



<a name="235678506"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235678506" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235678506">(Apr 22 2021 at 13:38)</a>:</h4>
<p>it's 2021-04-22 today</p>



<a name="235678616"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235678616" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235678616">(Apr 22 2021 at 13:39)</a>:</h4>
<p>right, just pasted what elan updated me to when I asked for nightly -- I'll switch to 4/22 explicitly</p>



<a name="235678957"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235678957" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235678957">(Apr 22 2021 at 13:41)</a>:</h4>
<p>updated just now, this is what I got:</p>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="bp">$</span> <span class="n">elan</span> <span class="n">update</span> <span class="n">leanprover</span><span class="bp">/</span><span class="n">lean4</span><span class="o">:</span><span class="n">nightly</span>
<span class="n">info</span><span class="o">:</span> <span class="n">syncing</span> <span class="n">channel</span> <span class="n">updates</span> <span class="n">for</span> <span class="bp">'</span><span class="n">nightly'</span>
<span class="n">info</span><span class="o">:</span> <span class="n">latest</span> <span class="n">update</span> <span class="n">on</span> <span class="n">nightly</span><span class="o">,</span> <span class="n">lean</span> <span class="n">version</span> <span class="n">nightly</span><span class="bp">-</span><span class="mi">2021</span><span class="bp">-</span><span class="mi">04</span><span class="bp">-</span><span class="mi">22</span>
<span class="n">info</span><span class="o">:</span> <span class="n">downloading</span> <span class="n">component</span> <span class="bp">'</span><span class="n">lean'</span>
<span class="mi">103</span><span class="bp">.</span><span class="mi">9</span> <span class="n">MiB</span> <span class="bp">/</span> <span class="mi">103</span><span class="bp">.</span><span class="mi">9</span> <span class="n">MiB</span> <span class="o">(</span><span class="mi">100</span> <span class="bp">%</span><span class="o">)</span>   <span class="mi">9</span><span class="bp">.</span><span class="mi">8</span> <span class="n">MiB</span><span class="bp">/</span><span class="n">s</span> <span class="n">ETA</span><span class="o">:</span>   <span class="mi">0</span> <span class="n">s</span>
<span class="n">info</span><span class="o">:</span> <span class="n">installing</span> <span class="n">component</span> <span class="bp">'</span><span class="n">lean'</span>

  <span class="n">leanprover</span><span class="bp">-</span><span class="n">lean4</span><span class="bp">-</span><span class="n">nightly</span> <span class="n">updated</span> <span class="bp">-</span> <span class="n">Lean</span> <span class="o">(</span><span class="n">version</span> <span class="mi">4</span><span class="bp">.</span><span class="mi">0</span><span class="bp">.</span><span class="mi">0</span><span class="bp">-</span><span class="n">nightly</span><span class="bp">-</span><span class="mi">2021</span><span class="bp">-</span><span class="mi">04</span><span class="bp">-</span><span class="mi">22</span><span class="o">,</span> <span class="n">commit</span> <span class="mi">20</span><span class="n">cbb4389a4c</span><span class="o">,</span> <span class="n">Release</span><span class="o">)</span>
</code></pre></div>



<a name="235678997"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235678997" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235678997">(Apr 22 2021 at 13:41)</a>:</h4>
<p>right just did this</p>



<a name="235679039"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235679039" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235679039">(Apr 22 2021 at 13:41)</a>:</h4>
<p>Lean (version 4.0.0-nightly-2021-04-22, commit 20cbb4389a4c, Release)<br>
~/LocalSoftware/signatures/lean4/Cdclt $ lean hi.lean<br>
segmentation fault (core dumped)</p>



<a name="235679129"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235679129" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235679129">(Apr 22 2021 at 13:42)</a>:</h4>
<p>but I am also getting the segfault</p>



<a name="235679797"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235679797" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235679797">(Apr 22 2021 at 13:46)</a>:</h4>
<p><code> #eval (Thunk.pure h.get).get </code><br>
produces "hi" as expected</p>



<a name="235680516"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235680516" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235680516">(Apr 22 2021 at 13:50)</a>:</h4>
<p>It's a bit suspicious that <a href="https://github.com/leanprover/lean4/blob/master/src/runtime/object.cpp#L338-L344"><code>thunk_bind_fn_closure</code></a> is basically the same as <code>thunk_map_fn_closure</code>. I think there should be a <code>lean_thunk_get(r)</code> in there</p>



<a name="235680685"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235680685" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235680685">(Apr 22 2021 at 13:51)</a>:</h4>
<p>and <code>#eval (Thunk.bind h (λ a:String =&gt; (⟨λ x:Unit =&gt; a⟩ : Thunk String))).get</code> returns processing...</p>



<a name="235681553"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235681553" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235681553">(Apr 22 2021 at 13:56)</a>:</h4>
<p>I find the ref counting suspicious.</p>



<a name="235681584"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235681584" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235681584">(Apr 22 2021 at 13:56)</a>:</h4>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="k">static</span> <span class="n">obj_res</span> <span class="n">thunk_map_fn_closure</span><span class="p">(</span><span class="n">obj_arg</span> <span class="n">f</span><span class="p">,</span> <span class="n">obj_arg</span> <span class="n">t</span><span class="p">,</span> <span class="n">obj_arg</span> <span class="cm">/* u */</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">b_obj_res</span> <span class="n">v</span> <span class="o">=</span> <span class="n">lean_thunk_get</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="n">lean_inc</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="n">obj_res</span> <span class="n">r</span> <span class="o">=</span> <span class="n">lean_apply_1</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
    <span class="n">lean_dec</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



<a name="235681628"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235681628" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235681628">(Apr 22 2021 at 13:56)</a>:</h4>
<p>By the way, if you use <code>2</code> instead of <code>"hi"</code> it's a little safer, you won't get a segfault but <code>0</code> is not the right answer</p>



<a name="235681633"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235681633" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235681633">(Apr 22 2021 at 13:56)</a>:</h4>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="k">static</span> <span class="n">obj_res</span> <span class="n">thunk_bind_fn_closure</span><span class="p">(</span><span class="n">obj_arg</span> <span class="n">x</span><span class="p">,</span> <span class="n">obj_arg</span> <span class="n">f</span><span class="p">,</span> <span class="n">obj_arg</span> <span class="cm">/* u */</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">b_obj_res</span> <span class="n">v</span> <span class="o">=</span> <span class="n">lean_thunk_get</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="n">lean_inc</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="n">obj_res</span> <span class="n">r</span> <span class="o">=</span> <span class="n">lean_apply_1</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
    <span class="n">lean_dec</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



<a name="235681722"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235681722" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235681722">(Apr 22 2021 at 13:57)</a>:</h4>
<p>The refcounting is a bit of black art to me</p>



<a name="235681751"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235681751" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235681751">(Apr 22 2021 at 13:57)</a>:</h4>
<p>I'm not sure what the rules are</p>



<a name="235681861"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235681861" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235681861">(Apr 22 2021 at 13:57)</a>:</h4>
<p>yeah, I bet. I don't quite get what's going on. But what I do notice, is that in the upper example you incr and decr the same var.</p>



<a name="235681887"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235681887" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235681887">(Apr 22 2021 at 13:58)</a>:</h4>
<p>and in the 2nd you incr and decr different vars</p>



<a name="235682322"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235682322" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235682322">(Apr 22 2021 at 14:00)</a>:</h4>
<p>But even ignoring the refcounts (which could indeed cause a segfault if not arranged properly), we aren't calling <code>get</code> twice inside <code>bind</code>. My guess is that it's interpreting the thunk <code>r</code> as a string and the segfault results because they have different data layout</p>



<a name="235682690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235682690" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235682690">(Apr 22 2021 at 14:01)</a>:</h4>
<p>as in we should be <code>get</code>ting the <code>r</code> before <code>return</code>ing it?</p>



<a name="235682736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235682736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235682736">(Apr 22 2021 at 14:01)</a>:</h4>
<p>given that the whole code is wrapped in a thunk again?</p>



<a name="235682902"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235682902" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Daniel Fabian <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235682902">(Apr 22 2021 at 14:02)</a>:</h4>
<div class="codehilite" data-code-language="Lean"><pre><span></span><code><span class="kn">protected</span> <span class="kd">def</span> <span class="n">Thunk.bind</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">Thunk</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">Thunk</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">Thunk</span> <span class="n">β</span> <span class="o">:=</span>
  <span class="o">⟨</span><span class="k">fun</span> <span class="n">_</span> <span class="bp">=&gt;</span> <span class="o">(</span><span class="n">f</span> <span class="n">x.get</span><span class="o">)</span><span class="bp">.</span><span class="n">get</span><span class="o">⟩</span>
</code></pre></div>



<a name="235683736"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235683736" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235683736">(Apr 22 2021 at 14:06)</a>:</h4>
<p>right, this code is the content of the inner function <code>fun _ =&gt; (f x.get).get</code></p>



<a name="235683783"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235683783" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235683783">(Apr 22 2021 at 14:07)</a>:</h4>
<p>and the model calls <code>get</code> twice, as you can see</p>



<a name="235683830"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235683830" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235683830">(Apr 22 2021 at 14:07)</a>:</h4>
<p>the implementation is actually doing <code>fun _ =&gt; f x.get</code></p>



<a name="235683940"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235683940" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235683940">(Apr 22 2021 at 14:07)</a>:</h4>
<p>and then why does this cause the segfault</p>



<a name="235684022"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684022" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684022">(Apr 22 2021 at 14:08)</a>:</h4>
<p>because it is violating the type system</p>



<a name="235684069"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684069" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684069">(Apr 22 2021 at 14:08)</a>:</h4>
<p>it returns a thunk and lean thinks it's a string</p>



<a name="235684130"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684130" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684130">(Apr 22 2021 at 14:08)</a>:</h4>
<p>should it not be caught by the lean_assert</p>



<a name="235684183"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684183" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684183">(Apr 22 2021 at 14:08)</a>:</h4>
<p>so when it calls the string-print function on a thunk value, boom</p>



<a name="235684222"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684222" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684222">(Apr 22 2021 at 14:09)</a>:</h4>
<p>I don't think the asserts are air tight</p>



<a name="235684263"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684263" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684263">(Apr 22 2021 at 14:09)</a>:</h4>
<p>Oh I see, the asserts are only called on f and t anyway</p>



<a name="235684316"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684316" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684316">(Apr 22 2021 at 14:09)</a>:</h4>
<p>Also <code>bind</code> doesn't have any asserts on entry, <code>map</code> does</p>



<a name="235684416"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684416" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684416">(Apr 22 2021 at 14:10)</a>:</h4>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="k">extern</span> <span class="s">"C"</span> <span class="n">obj_res</span> <span class="n">lean_thunk_map</span><span class="p">(</span><span class="n">obj_arg</span> <span class="n">f</span><span class="p">,</span> <span class="n">obj_arg</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">lean_assert</span><span class="p">(</span><span class="n">lean_is_closure</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
    <span class="n">lean_assert</span><span class="p">(</span><span class="n">lean_is_thunk</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
    <span class="k">return</span> <span class="nf">mk_thunk_3_2</span><span class="p">(</span><span class="n">thunk_map_fn_closure</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="n">obj_res</span> <span class="n">lean_thunk_bind</span><span class="p">(</span><span class="n">obj_arg</span> <span class="n">x</span><span class="p">,</span> <span class="n">obj_arg</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">mk_thunk_3_2</span><span class="p">(</span><span class="n">thunk_bind_fn_closure</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



<a name="235684452"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684452" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684452">(Apr 22 2021 at 14:10)</a>:</h4>
<p>true</p>



<a name="235684482"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684482" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Mario Carneiro <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684482">(Apr 22 2021 at 14:10)</a>:</h4>
<p>not that that would help here</p>



<a name="235684483"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684483" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684483">(Apr 22 2021 at 14:10)</a>:</h4>
<p>It does assert in debug mode when trying to access the string</p>



<a name="235684540"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684540" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684540">(Apr 22 2021 at 14:10)</a>:</h4>
<p>ok, makes sense</p>



<a name="235684609"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684609" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684609">(Apr 22 2021 at 14:11)</a>:</h4>
<p>Is there a way to disable the c++ implementation in lean in the meantime</p>



<a name="235684680"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684680" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684680">(Apr 22 2021 at 14:11)</a>:</h4>
<p>It wouldn't be a thunk anymore then!</p>



<a name="235684916"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684916" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684916">(Apr 22 2021 at 14:12)</a>:</h4>
<p>my only understanding of a thunk is that it is fun () =&gt; whatever</p>



<a name="235684955"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684955" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684955">(Apr 22 2021 at 14:13)</a>:</h4>
<p>does the def also include something about lazy eval?</p>



<a name="235684981"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235684981" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Sebastian Ullrich <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235684981">(Apr 22 2021 at 14:13)</a>:</h4>
<p>Yes. A thunk is evaluated at most once.</p>



<a name="235685132"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235685132" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235685132">(Apr 22 2021 at 14:14)</a>:</h4>
<p>I see</p>



<a name="235685380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235685380" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235685380">(Apr 22 2021 at 14:15)</a>:</h4>
<p>That is acceptable for me until until a later version of lean -- I'll just remove the externs for now</p>



<a name="235686201"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235686201" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235686201">(Apr 22 2021 at 14:20)</a>:</h4>
<p>"compiler failed to infer low level type" when I just remove attributes and &amp; from core.lean Thunks</p>



<a name="235686785"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Thunk%20Bind/near/235686785" class="zl"><img src="https://leanprover-community.github.io/archive/assets/img/zulip2.png" alt="view this post on Zulip"></a> Scott Viteri <a href="https://leanprover-community.github.io/archive/stream/270676-lean4/topic/Thunk.20Bind.html#235686785">(Apr 22 2021 at 14:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="228135">Scott Viteri</span> <a href="#narrow/stream/270676-lean4/topic/Thunk.20Bind/near/235686201">said</a>:</p>
<blockquote>
<p>"compiler failed to infer low level type" when I just remove attributes and &amp; from core.lean Thunks</p>
</blockquote>
<p>nevermind, I'll just make a separate fake thunk type</p>



{% endraw %}

<hr><p>Last updated: Jan 25 2023 at 00:06 UTC</p>